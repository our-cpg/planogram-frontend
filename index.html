<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Planogram Profit Tracker - v3 Complete</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK - Updated to include Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase Configuration -->
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

// Custom Icons
const Icons = {
  Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
  Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
  Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
  Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
  Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
  Package: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
  BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
  DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
  Maximize2: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
  Grid3x3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
  Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>,
  Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
  AlignVertical: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="16" width="14" height="6" rx="2"></rect><rect x="7" y="2" width="10" height="6" rx="2"></rect><path d="M2 12h20"></path></svg>,
  Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
  Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
  Flame: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>,
  RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
  X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
  Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>,
  Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
};

const FIXTURE_TYPES = {
  GRID_WALL: {
    id: 'grid_wall',
    name: 'Grid Wall',
    icon: 'Grid3x3',
    color: '#64748b',
    defaultWidth: 120,
    defaultHeight: 200
  },
  JEWELRY_CASE: {
    id: 'jewelry_case',
    name: 'Jewelry Case',
    icon: 'Box',
    color: '#8b5cf6',
    defaultWidth: 100,
    defaultHeight: 80
  },
  GONDOLA: {
    id: 'gondola',
    name: 'Gondola',
    icon: 'Layers',
    color: '#ef4444',
    defaultWidth: 180,
    defaultHeight: 120
  },
  SLAT_WALL: {
    id: 'slat_wall',
    name: 'Slat Wall',
    icon: 'AlignVertical',
    color: '#f59e0b',
    defaultWidth: 150,
    defaultHeight: 180
  },
  END_CAP: {
    id: 'end_cap',
    name: 'End Cap',
    icon: 'Package',
    color: '#10b981',
    defaultWidth: 80,
    defaultHeight: 120
  },
  JEWELRY_DISPLAY: {
    id: 'jewelry_display',
    name: 'Jewelry Display',
    icon: 'Box',
    color: '#fbbf24',
    defaultWidth: 90,
    defaultHeight: 90
  },
  MAKEUP_WALL: {
    id: 'makeup_wall',
    name: 'Makeup Wall',
    icon: 'Grid3x3',
    color: '#ff1493',
    defaultWidth: 200,
    defaultHeight: 220
  }
};

const getCursor = (position) => {
  const cursors = {
    'nw': 'nwse-resize', 'ne': 'nesw-resize', 'se': 'nwse-resize', 'sw': 'nesw-resize',
    'n': 'ns-resize', 's': 'ns-resize', 'e': 'ew-resize', 'w': 'ew-resize'
  };
  return cursors[position];
};

const getHandlePosition = (position) => {
  const positions = {
    'nw': { top: -6, left: -6, width: '12px', height: '12px' },
    'n': { top: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'ne': { top: -6, right: -6, width: '12px', height: '12px' },
    'e': { right: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' },
    'se': { bottom: -6, right: -6, width: '12px', height: '12px' },
    's': { bottom: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'sw': { bottom: -6, left: -6, width: '12px', height: '12px' },
    'w': { left: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' }
  };
  return positions[position];
};

const PlanogramProfitTracker = () => {
  const [currentPage, setCurrentPage] = useState('planner');
  const [layoutName, setLayoutName] = useState('My Store Layout');
  const [fixtures, setFixtures] = useState([]);
  const [sections, setSections] = useState([]);
  const [selectedFixture, setSelectedFixture] = useState(null);
  const [selectedSection, setSelectedSection] = useState(null);
  const [resizingFixture, setResizingFixture] = useState(null);
  const [resizingSection, setResizingSection] = useState(null);
  const [resizeHandle, setResizeHandle] = useState(null);
  const [products, setProducts] = useState([]);
  const [fixtureDrawerOpen, setFixtureDrawerOpen] = useState(false);
  const [visualMode, setVisualMode] = useState('profit');
  const [showBackgroundImage, setShowBackgroundImage] = useState(true);
  const [backgroundImage, setBackgroundImage] = useState(null);
  const [storeSquareFeet, setStoreSquareFeet] = useState(500);
  const [timePeriod, setTimePeriod] = useState('month');
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);
  const [shopifyConfig, setShopifyConfig] = useState({
    storeName: '',
    accessToken: '',
    connected: false
  });

  // Firebase state
  const [firebaseReady, setFirebaseReady] = useState(false);
  const [savingToCloud, setSavingToCloud] = useState(false);
  const [lastSaved, setLastSaved] = useState(null);

  // Initialize Firebase on component mount
  useEffect(() => {
    const initFirebase = async () => {
      try {
        if (window.firebaseService) {
          await window.firebaseService.initialize();
          await window.firebaseService.signInAnonymously();
          setFirebaseReady(true);
          console.log('‚úÖ Firebase ready for cloud saves!');
          
          // Enable auto-save every 2 minutes
          window.firebaseService.startAutoSave(async () => {
            await saveToCloud(false); // Silent auto-save
          }, 2);
        }
      } catch (error) {
        console.error('Firebase initialization failed:', error);
      }
    };

    initFirebase();

    // Cleanup on unmount
    return () => {
      if (window.firebaseService) {
        window.firebaseService.stopAutoSave();
      }
    };
  }, []);

  // Save to Firebase Cloud
  const saveToCloud = async (showNotification = true) => {
    if (!firebaseReady || !window.firebaseService) {
      alert('Firebase not ready. Please wait...');
      return;
    }

    setSavingToCloud(true);

    try {
      const planogramData = {
        name: layoutName,
        fixtures: fixtures,
        sections: sections,
        products: products,
        storeSquareFeet: storeSquareFeet,
        shopifyConfig: {
          storeName: shopifyConfig.storeName,
          connected: shopifyConfig.connected
        },
        backgroundImage: backgroundImage,
        lastModified: new Date().toISOString()
      };

      const planogramId = await window.firebaseService.savePlanogram(planogramData);

      if (planogramId) {
        setLastSaved(new Date());
        if (showNotification) {
          alert('‚úÖ Layout saved to cloud!');
        }
        console.log('Saved planogram:', planogramId);
      }
    } catch (error) {
      console.error('Failed to save to cloud:', error);
      if (showNotification) {
        alert('‚ùå Failed to save to cloud. Check console for details.');
      }
    } finally {
      setSavingToCloud(false);
    }
  };

  // Load from Firebase Cloud
  const loadFromCloud = async () => {
    if (!firebaseReady || !window.firebaseService) {
      alert('Firebase not ready. Please wait...');
      return;
    }

    try {
      const planograms = await window.firebaseService.listPlanograms();
      
      if (planograms.length === 0) {
        alert('No saved layouts found in cloud.');
        return;
      }

      // Show simple selection (you can make this a modal later)
      const planogramNames = planograms.map((p, idx) => 
        `${idx + 1}. ${p.name} (${new Date(p.lastModified).toLocaleString()})`
      ).join('\n');
      
      const selection = prompt(`Choose a layout to load:\n\n${planogramNames}\n\nEnter number (1-${planograms.length}):`);
      
      if (selection) {
        const index = parseInt(selection) - 1;
        if (index >= 0 && index < planograms.length) {
          const selectedPlanogram = planograms[index];
          const data = await window.firebaseService.loadPlanogram(selectedPlanogram.id);
          
          if (data) {
            setLayoutName(data.name);
            setFixtures(data.fixtures || []);
            setSections(data.sections || []);
            setProducts(data.products || []);
            setStoreSquareFeet(data.storeSquareFeet || 500);
            if (data.shopifyConfig) {
              setShopifyConfig(prev => ({
                ...prev,
                storeName: data.shopifyConfig.storeName,
                connected: data.shopifyConfig.connected
              }));
            }
            setBackgroundImage(data.backgroundImage || null);
            alert('‚úÖ Layout loaded from cloud!');
          }
        }
      }
    } catch (error) {
      console.error('Failed to load from cloud:', error);
      alert('‚ùå Failed to load from cloud. Check console for details.');
    }
  };

  const testShopifyConnection = async () => {
    if (!shopifyConfig.storeName || !shopifyConfig.accessToken) {
      alert('Please enter both store name and access token');
      return;
    }

    try {
      const response = await fetch(
        `https://${shopifyConfig.storeName}/admin/api/2024-01/products.json?limit=1`,
        {
          headers: {
            'X-Shopify-Access-Token': shopifyConfig.accessToken
          }
        }
      );

      if (response.ok) {
        setShopifyConfig({...shopifyConfig, connected: true});
        alert('‚úÖ Connection successful!');
      } else {
        alert('‚ùå Connection failed. Check your credentials.');
      }
    } catch (error) {
      console.error('Connection test failed:', error);
      alert('‚ùå Connection error: ' + error.message);
    }
  };

  const fetchShopifyProducts = async () => {
    if (!shopifyConfig.connected) {
      alert('Please connect to Shopify first');
      return;
    }

    try {
      let allProducts = [];
      let nextPageUrl = `https://${shopifyConfig.storeName}/admin/api/2024-01/products.json?limit=250`;

      while (nextPageUrl && allProducts.length < 4000) {
        const response = await fetch(nextPageUrl, {
          headers: {
            'X-Shopify-Access-Token': shopifyConfig.accessToken
          }
        });

        if (!response.ok) throw new Error('Failed to fetch products');

        const data = await response.json();
        allProducts = [...allProducts, ...data.products];

        const linkHeader = response.headers.get('link');
        nextPageUrl = null;
        
        if (linkHeader) {
          const nextMatch = linkHeader.match(/<([^>]+)>; rel="next"/);
          if (nextMatch) {
            nextPageUrl = nextMatch[1];
          }
        }

        if (!nextPageUrl || data.products.length < 250) break;
      }

      const processedProducts = allProducts.map(product => {
        const variant = product.variants[0];
        return {
          id: product.id,
          name: product.title,
          sku: variant.sku || '',
          upc: variant.barcode || '',
          price: parseFloat(variant.price) || 0,
          cost: parseFloat(variant.compare_at_price) || 0,
          vendor: product.vendor || '',
          inventoryQuantity: variant.inventory_quantity || 0,
          monthlySales: 0,
          image: product.image?.src || ''
        };
      });

      setProducts(processedProducts);
      alert(`‚úÖ Loaded ${processedProducts.length} products from Shopify!`);
    } catch (error) {
      console.error('Error fetching products:', error);
      alert('‚ùå Failed to fetch products: ' + error.message);
    }
  };

  const addFixture = (type) => {
    const fixtureType = FIXTURE_TYPES[type];
    const newFixture = {
      id: Date.now(),
      type: type,
      name: fixtureType.name,
      x: 100,
      y: 100,
      width: fixtureType.defaultWidth,
      height: fixtureType.defaultHeight,
      color: fixtureType.color,
      rotation: 0,
      products: []
    };
    setFixtures([...fixtures, newFixture]);
    setSelectedFixture(newFixture.id);
    setFixtureDrawerOpen(false);
  };

  const deleteSelectedFixture = () => {
    if (selectedFixture) {
      setFixtures(fixtures.filter(f => f.id !== selectedFixture));
      setSelectedFixture(null);
    }
  };

  const addSection = () => {
    const newSection = {
      id: Date.now(),
      name: `Section ${sections.length + 1}`,
      x: 50,
      y: 50,
      width: 200,
      height: 150,
      color: '#FF6B6B',
      profitPerSqFt: 0
    };
    setSections([...sections, newSection]);
    setSelectedSection(newSection.id);
  };

  const deleteSelectedSection = () => {
    if (selectedSection) {
      setSections(sections.filter(s => s.id !== selectedSection));
      setSelectedSection(null);
    }
  };

  const updateSection = (id, updates) => {
    setSections(sections.map(s => s.id === id ? {...s, ...updates} : s));
  };

  const handleFixtureMouseDown = (e, fixture) => {
    if (e.button !== 0) return;
    e.stopPropagation();
    setSelectedFixture(fixture.id);
    setSelectedSection(null);
  };

  const handleSectionMouseDown = (e, section) => {
    if (e.button !== 0) return;
    e.stopPropagation();
    setSelectedSection(section.id);
    setSelectedFixture(null);
  };

  const handleResizeStart = (e, fixture, handle, isSection = false) => {
    e.stopPropagation();
    if (isSection) {
      setResizingSection(fixture);
    } else {
      setResizingFixture(fixture);
    }
    setResizeHandle(handle);
  };

  const handleMouseMove = (e) => {
    if (!canvasRef.current) return;
    
    const rect = canvasRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (resizingFixture && resizeHandle) {
      const updated = {...resizingFixture};
      const minSize = 40;

      switch(resizeHandle) {
        case 'nw':
          const nwDeltaX = updated.x - x;
          const nwDeltaY = updated.y - y;
          if (updated.width + nwDeltaX >= minSize) {
            updated.x = x;
            updated.width += nwDeltaX;
          }
          if (updated.height + nwDeltaY >= minSize) {
            updated.y = y;
            updated.height += nwDeltaY;
          }
          break;
        case 'ne':
          const neDeltaY = updated.y - y;
          updated.width = Math.max(minSize, x - updated.x);
          if (updated.height + neDeltaY >= minSize) {
            updated.y = y;
            updated.height += neDeltaY;
          }
          break;
        case 'se':
          updated.width = Math.max(minSize, x - updated.x);
          updated.height = Math.max(minSize, y - updated.y);
          break;
        case 'sw':
          const swDeltaX = updated.x - x;
          if (updated.width + swDeltaX >= minSize) {
            updated.x = x;
            updated.width += swDeltaX;
          }
          updated.height = Math.max(minSize, y - updated.y);
          break;
        case 'n':
          const nDeltaY = updated.y - y;
          if (updated.height + nDeltaY >= minSize) {
            updated.y = y;
            updated.height += nDeltaY;
          }
          break;
        case 's':
          updated.height = Math.max(minSize, y - updated.y);
          break;
        case 'e':
          updated.width = Math.max(minSize, x - updated.x);
          break;
        case 'w':
          const wDeltaX = updated.x - x;
          if (updated.width + wDeltaX >= minSize) {
            updated.x = x;
            updated.width += wDeltaX;
          }
          break;
      }

      setFixtures(fixtures.map(f => f.id === updated.id ? updated : f));
      setResizingFixture(updated);
    }

    if (resizingSection && resizeHandle) {
      const updated = {...resizingSection};
      const minSize = 50;

      switch(resizeHandle) {
        case 'nw':
          const nwDeltaX = updated.x - x;
          const nwDeltaY = updated.y - y;
          if (updated.width + nwDeltaX >= minSize) {
            updated.x = x;
            updated.width += nwDeltaX;
          }
          if (updated.height + nwDeltaY >= minSize) {
            updated.y = y;
            updated.height += nwDeltaY;
          }
          break;
        case 'ne':
          const neDeltaY = updated.y - y;
          updated.width = Math.max(minSize, x - updated.x);
          if (updated.height + neDeltaY >= minSize) {
            updated.y = y;
            updated.height += neDeltaY;
          }
          break;
        case 'se':
          updated.width = Math.max(minSize, x - updated.x);
          updated.height = Math.max(minSize, y - updated.y);
          break;
        case 'sw':
          const swDeltaX = updated.x - x;
          if (updated.width + swDeltaX >= minSize) {
            updated.x = x;
            updated.width += swDeltaX;
          }
          updated.height = Math.max(minSize, y - updated.y);
          break;
        case 'n':
          const nDeltaY = updated.y - y;
          if (updated.height + nDeltaY >= minSize) {
            updated.y = y;
            updated.height += nDeltaY;
          }
          break;
        case 's':
          updated.height = Math.max(minSize, y - updated.y);
          break;
        case 'e':
          updated.width = Math.max(minSize, x - updated.x);
          break;
        case 'w':
          const wDeltaX = updated.x - x;
          if (updated.width + wDeltaX >= minSize) {
            updated.x = x;
            updated.width += wDeltaX;
          }
          break;
      }

      setSections(sections.map(s => s.id === updated.id ? updated : s));
      setResizingSection(updated);
    }
  };

  const handleMouseUp = () => {
    setResizingFixture(null);
    setResizingSection(null);
    setResizeHandle(null);
  };

  useEffect(() => {
    if (resizingFixture || resizingSection) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [resizingFixture, resizingSection, resizeHandle, fixtures, sections]);

  const updateFixture = (id, updates) => {
    setFixtures(fixtures.map(f => f.id === id ? {...f, ...updates} : f));
  };

  const exportData = () => {
    const data = {
      layoutName,
      fixtures,
      sections,
      products,
      storeSquareFeet,
      exportDate: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `planogram-${layoutName.replace(/\s+/g, '-')}.json`;
    a.click();
  };

  const importData = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          setLayoutName(data.layoutName || 'Imported Layout');
          setFixtures(data.fixtures || []);
          setSections(data.sections || []);
          setProducts(data.products || []);
          setStoreSquareFeet(data.storeSquareFeet || 500);
          alert('Layout imported successfully!');
        } catch (error) {
          alert('Error importing file: ' + error.message);
        }
      };
      reader.readAsText(file);
    }
  };

  const handleBackgroundUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setBackgroundImage(event.target.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const captureCanvas = () => {
    if (canvasRef.current) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const rect = canvasRef.current.getBoundingClientRect();
      
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const canvasElement = canvasRef.current;
      ctx.drawImage(canvasElement, 0, 0);
      
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `planogram-${layoutName.replace(/\s+/g, '-')}.png`;
        a.click();
      });
    }
  };

  const calculateTotals = () => {
    let totalProfit = 0;
    let totalSales = 0;

    fixtures.forEach(fixture => {
      if (fixture.products && fixture.products.length > 0) {
        fixture.products.forEach(productId => {
          const product = products.find(p => p.id === productId);
          if (product) {
            const profit = (product.price - product.cost) * (product.monthlySales || 0);
            totalProfit += profit;
            totalSales += product.monthlySales || 0;
          }
        });
      }
    });

    const totalSquareFeet = sections.reduce((sum, section) => {
      const sqFt = (section.width * section.height) / 144;
      return sum + sqFt;
    }, 0);

    const profitPerSqFt = totalSquareFeet > 0 ? totalProfit / totalSquareFeet : 0;

    return {
      totalProfit,
      totalSales,
      totalSquareFeet,
      profitPerSqFt
    };
  };

  const totals = calculateTotals();

  return (
    <div className="h-screen flex flex-col bg-gradient-to-br from-blue-50 to-indigo-100">
      {/* Top Navigation */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 shadow-lg">
        <div className="flex items-center justify-between px-6 py-3">
          <div className="flex items-center gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/891/891462.png" alt="Logo" className="w-10 h-10" />
            <h1 className="text-2xl font-bold text-white">Ceries</h1>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={() => setCurrentPage('planner')}
              className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'planner'
                  ? 'bg-white text-indigo-600 shadow-lg'
                  : 'bg-indigo-500 text-white hover:bg-indigo-400'
              }`}
            >
              üè™ Store Planner
            </button>
            <button
              onClick={() => setCurrentPage('dashboard')}
              className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'dashboard'
                  ? 'bg-white text-indigo-600 shadow-lg'
                  : 'bg-indigo-500 text-white hover:bg-indigo-400'
              }`}
            >
              üìä Dashboard
            </button>
            <button
              onClick={() => setCurrentPage('forecasting')}
              className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'forecasting'
                  ? 'bg-white text-indigo-600 shadow-lg'
                  : 'bg-indigo-500 text-white hover:bg-indigo-400'
              }`}
            >
              üìà Forecasting
            </button>
            <button
              onClick={() => setCurrentPage('analytics')}
              className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'analytics'
                  ? 'bg-white text-indigo-600 shadow-lg'
                  : 'bg-indigo-500 text-white hover:bg-indigo-400'
              }`}
            >
              üìä Row Analytics
            </button>
            <button
              onClick={() => setCurrentPage('settings')}
              className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'settings'
                  ? 'bg-white text-indigo-600 shadow-lg'
                  : 'bg-indigo-500 text-white hover:bg-indigo-400'
              }`}
            >
              ‚öôÔ∏è Settings
            </button>
          </div>
        </div>
      </div>

      {/* Store Planner Page */}
      {currentPage === 'planner' && (
        <div className="flex flex-1 overflow-hidden">
          {/* Left Sidebar - Fixture Library */}
          <div className={`${fixtureDrawerOpen ? 'w-80' : 'w-16'} bg-white border-r border-gray-200 transition-all duration-300 flex flex-col shadow-lg`}>
            <button
              onClick={() => setFixtureDrawerOpen(!fixtureDrawerOpen)}
              className="p-4 hover:bg-gray-100 border-b flex items-center justify-center"
            >
              <Package />
              {fixtureDrawerOpen && <span className="ml-2 font-semibold">Fixture Library</span>}
              {fixtureDrawerOpen && <X className="ml-auto" />}
            </button>

            {fixtureDrawerOpen && (
              <div className="flex-1 overflow-y-auto p-4">
                <div className="space-y-3">
                  {Object.values(FIXTURE_TYPES).map((type) => {
                    const IconComponent = Icons[type.icon];
                    return (
                      <button
                        key={type.id}
                        onClick={() => addFixture(type.id.toUpperCase())}
                        className="w-full p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border-2 border-gray-200 hover:border-indigo-400 transition-all flex items-center gap-3"
                        style={{ borderLeftColor: type.color, borderLeftWidth: '4px' }}
                      >
                        <div style={{ color: type.color }}>
                          <IconComponent />
                        </div>
                        <span className="font-medium text-gray-700">{type.name}</span>
                      </button>
                    );
                  })}
                </div>

                <div className="mt-6 pt-6 border-t">
                  <h3 className="font-semibold mb-3 text-gray-700">Active Fixtures</h3>
                  <div className="space-y-2">
                    {fixtures.map((fixture) => (
                      <div
                        key={fixture.id}
                        className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${
                          selectedFixture === fixture.id
                            ? 'bg-indigo-50 border-indigo-400'
                            : 'bg-gray-50 border-gray-200 hover:border-gray-300'
                        }`}
                        onClick={() => setSelectedFixture(fixture.id)}
                      >
                        <div className="flex items-center justify-between">
                          <span className="font-medium text-sm">{fixture.name}</span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setFixtures(fixtures.filter(f => f.id !== fixture.id));
                              if (selectedFixture === fixture.id) setSelectedFixture(null);
                            }}
                            className="text-red-500 hover:text-red-700"
                          >
                            <Trash2 />
                          </button>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          {Math.round(fixture.width)}√ó{Math.round(fixture.height)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Main Canvas Area */}
          <div className="flex-1 flex flex-col overflow-hidden">
            {/* Canvas Toolbar */}
            <div className="bg-white border-b border-gray-200 p-4 shadow-sm">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <input
                    type="text"
                    value={layoutName}
                    onChange={(e) => setLayoutName(e.target.value)}
                    className="px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold text-lg focus:outline-none focus:border-indigo-500"
                    placeholder="Layout Name"
                  />
                  
                  {/* Firebase Status Indicator */}
                  {firebaseReady && (
                    <div className="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                      <Icons.Cloud />
                      <span>Cloud Ready</span>
                      {lastSaved && (
                        <span className="text-xs opacity-75">
                          (Saved {new Date(lastSaved).toLocaleTimeString()})
                        </span>
                      )}
                    </div>
                  )}
                </div>

                <div className="flex gap-2">
                  {/* Heatmap Toggle */}
                  <div className="flex gap-1 bg-gray-100 rounded-lg p-1">
                    <button
                      onClick={() => setVisualMode('profit')}
                      className={`px-4 py-2 rounded font-medium transition-all ${
                        visualMode === 'profit'
                          ? 'bg-white shadow text-indigo-600'
                          : 'text-gray-600 hover:text-gray-900'
                      }`}
                    >
                      üî• Profit Density
                    </button>
                    <button
                      onClick={() => setVisualMode('sales')}
                      className={`px-4 py-2 rounded font-medium transition-all ${
                        visualMode === 'sales'
                          ? 'bg-white shadow text-indigo-600'
                          : 'text-gray-600 hover:text-gray-900'
                      }`}
                    >
                      üî¢ Sales
                    </button>
                    <button
                      onClick={() => setVisualMode('full')}
                      className={`px-4 py-2 rounded font-medium transition-all ${
                        visualMode === 'full'
                          ? 'bg-white shadow text-indigo-600'
                          : 'text-gray-600 hover:text-gray-900'
                      }`}
                    >
                      üîµ Full
                    </button>
                    <button
                      onClick={() => setVisualMode('orders')}
                      className={`px-4 py-2 rounded font-medium transition-all ${
                        visualMode === 'orders'
                          ? 'bg-white shadow text-indigo-600'
                          : 'text-gray-600 hover:text-gray-900'
                      }`}
                    >
                      üõí Orders
                    </button>
                  </div>

                  {/* Time Period Selector */}
                  <select
                    value={timePeriod}
                    onChange={(e) => setTimePeriod(e.target.value)}
                    className="px-4 py-2 border-2 border-gray-300 rounded-lg font-medium focus:outline-none focus:border-indigo-500"
                  >
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                  </select>

                  {/* Action Buttons */}
                  <button
                    onClick={addSection}
                    className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold flex items-center gap-2"
                  >
                    <Plus />
                    Add Section
                  </button>

                  {/* Cloud Save/Load Buttons */}
                  <button
                    onClick={() => saveToCloud(true)}
                    disabled={!firebaseReady || savingToCloud}
                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    <Icons.Cloud />
                    {savingToCloud ? 'Saving...' : 'Save to Cloud'}
                  </button>

                  <button
                    onClick={loadFromCloud}
                    disabled={!firebaseReady}
                    className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-semibold flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    <Download />
                    Load from Cloud
                  </button>

                  {/* Original Export/Import */}
                  <button
                    onClick={exportData}
                    className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold flex items-center gap-2"
                  >
                    <Download />
                    Export
                  </button>

                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-semibold flex items-center gap-2"
                  >
                    <Upload />
                    Import
                  </button>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".json"
                    onChange={importData}
                    className="hidden"
                  />

                  <button
                    onClick={captureCanvas}
                    className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 font-semibold flex items-center gap-2"
                  >
                    <Camera />
                    BG
                  </button>

                  <button
                    onClick={() => setShowBackgroundImage(!showBackgroundImage)}
                    className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${
                      showBackgroundImage
                        ? 'bg-yellow-500 text-white hover:bg-yellow-600'
                        : 'bg-gray-300 text-gray-700 hover:bg-gray-400'
                    }`}
                  >
                    <Eye />
                    Visual
                  </button>
                </div>
              </div>

              {/* Profit Summary Bar */}
              <div className="mt-4 grid grid-cols-4 gap-4">
                <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-3 text-white shadow">
                  <div className="text-sm font-medium opacity-90">Total Profit</div>
                  <div className="text-2xl font-bold">${totals.totalProfit.toFixed(2)}</div>
                </div>
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-3 text-white shadow">
                  <div className="text-sm font-medium opacity-90">Profit/Sq Ft</div>
                  <div className="text-2xl font-bold">${totals.profitPerSqFt.toFixed(2)}</div>
                </div>
                <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-3 text-white shadow">
                  <div className="text-sm font-medium opacity-90">Total Sales</div>
                  <div className="text-2xl font-bold">{totals.totalSales}</div>
                </div>
                <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-3 text-white shadow">
                  <div className="text-sm font-medium opacity-90">Total Sq Ft</div>
                  <div className="text-2xl font-bold">{totals.totalSquareFeet.toFixed(1)}</div>
                </div>
              </div>
            </div>

            {/* Canvas */}
            <div 
              ref={canvasRef}
              className="flex-1 bg-gray-50 overflow-auto relative"
              style={{
                backgroundImage: showBackgroundImage && backgroundImage ? `url(${backgroundImage})` : 'none',
                backgroundSize: 'cover',
                backgroundPosition: 'center'
              }}
              onMouseDown={() => {
                setSelectedFixture(null);
                setSelectedSection(null);
              }}
            >
              {/* Sections Layer */}
              {sections.map((section) => {
                const sqFt = (section.width * section.height) / 144;
                const isSelected = selectedSection === section.id;

                return (
                  <div
                    key={section.id}
                    style={{
                      position: 'absolute',
                      left: section.x,
                      top: section.y,
                      width: section.width,
                      height: section.height,
                      backgroundColor: section.color + (visualMode === 'profit' ? '40' : '20'),
                      border: `3px ${isSelected ? 'solid' : 'dashed'} ${section.color}`,
                      borderRadius: '8px',
                      cursor: 'move'
                    }}
                    onMouseDown={(e) => handleSectionMouseDown(e, section)}
                  >
                    <div className="absolute top-2 left-2 bg-white px-2 py-1 rounded shadow text-sm font-semibold">
                      {section.name}
                    </div>
                    <div className="absolute bottom-2 right-2 bg-white px-2 py-1 rounded shadow text-xs">
                      ${section.profitPerSqFt.toFixed(2)}/sqft
                    </div>

                    {isSelected && (
                      <>
                        {['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'].map((handle) => (
                          <div
                            key={handle}
                            style={{
                              position: 'absolute',
                              backgroundColor: section.color,
                              cursor: getCursor(handle),
                              zIndex: 10,
                              borderRadius: '2px',
                              ...getHandlePosition(handle)
                            }}
                            onMouseDown={(e) => handleResizeStart(e, section, handle, true)}
                          />
                        ))}
                      </>
                    )}
                  </div>
                );
              })}

              {/* Fixtures Layer */}
              {fixtures.map((fixture) => {
                const fixtureType = Object.values(FIXTURE_TYPES).find(t => t.id === fixture.type.toLowerCase());
                const IconComponent = fixtureType ? Icons[fixtureType.icon] : Icons.Box;
                const isSelected = selectedFixture === fixture.id;

                return (
                  <div
                    key={fixture.id}
                    style={{
                      position: 'absolute',
                      left: fixture.x,
                      top: fixture.y,
                      width: fixture.width,
                      height: fixture.height,
                      backgroundColor: fixture.color + (visualMode === 'full' ? 'CC' : '40'),
                      border: `3px solid ${isSelected ? '#4f46e5' : fixture.color}`,
                      borderRadius: '8px',
                      cursor: 'move',
                      boxShadow: isSelected ? '0 0 20px rgba(79, 70, 229, 0.5)' : '0 2px 8px rgba(0,0,0,0.1)'
                    }}
                    onMouseDown={(e) => handleFixtureMouseDown(e, fixture)}
                  >
                    <div className="absolute top-2 left-2 flex items-center gap-2 bg-white px-2 py-1 rounded shadow">
                      <div style={{ color: fixture.color }}>
                        <IconComponent />
                      </div>
                      <span className="text-sm font-semibold">{fixture.name}</span>
                    </div>

                    {isSelected && (
                      <>
                        {['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'].map((handle) => (
                          <div
                            key={handle}
                            style={{
                              position: 'absolute',
                              backgroundColor: '#4f46e5',
                              cursor: getCursor(handle),
                              zIndex: 10,
                              borderRadius: '2px',
                              ...getHandlePosition(handle)
                            }}
                            onMouseDown={(e) => handleResizeStart(e, fixture, handle)}
                          />
                        ))}
                      </>
                    )}
                  </div>
                );
              })}
            </div>
          </div>

          {/* Right Sidebar - Properties */}
          {(selectedFixture || selectedSection) && (
            <div className="w-80 bg-white border-l border-gray-200 p-4 overflow-y-auto shadow-lg">
              {selectedFixture && (
                <>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-gray-800">Fixture Properties</h3>
                    <button
                      onClick={deleteSelectedFixture}
                      className="text-red-500 hover:text-red-700"
                    >
                      <Trash2 />
                    </button>
                  </div>

                  {fixtures.find(f => f.id === selectedFixture) && (() => {
                    const fixture = fixtures.find(f => f.id === selectedFixture);
                    return (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Name</label>
                          <input
                            type="text"
                            value={fixture.name}
                            onChange={(e) => updateFixture(fixture.id, { name: e.target.value })}
                            className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          />
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-sm font-medium mb-1">Width</label>
                            <input
                              type="number"
                              value={Math.round(fixture.width)}
                              onChange={(e) => updateFixture(fixture.id, { width: parseInt(e.target.value) })}
                              className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Height</label>
                            <input
                              type="number"
                              value={Math.round(fixture.height)}
                              onChange={(e) => updateFixture(fixture.id, { height: parseInt(e.target.value) })}
                              className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-1">Color</label>
                          <input
                            type="color"
                            value={fixture.color}
                            onChange={(e) => updateFixture(fixture.id, { color: e.target.value })}
                            className="w-full h-10 border rounded cursor-pointer"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-1">Assigned Products</label>
                          <div className="text-sm text-gray-600">
                            {fixture.products?.length || 0} products assigned
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </>
              )}

              {selectedSection && (
                <>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-gray-800">Section Properties</h3>
                    <button
                      onClick={deleteSelectedSection}
                      className="text-red-500 hover:text-red-700"
                    >
                      <Trash2 />
                    </button>
                  </div>

                  {sections.find(s => s.id === selectedSection) && (() => {
                    const section = sections.find(s => s.id === selectedSection);
                    return (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Section Name</label>
                          <input
                            type="text"
                            value={section.name}
                            onChange={(e) => updateSection(section.id, { name: e.target.value })}
                            className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          />
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-sm font-medium mb-1">Width</label>
                            <input
                              type="number"
                              value={Math.round(section.width)}
                              onChange={(e) => updateSection(section.id, { width: parseInt(e.target.value) })}
                              className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Height</label>
                            <input
                              type="number"
                              value={Math.round(section.height)}
                              onChange={(e) => updateSection(section.id, { height: parseInt(e.target.value) })}
                              className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-1">Color</label>
                          <input
                            type="color"
                            value={section.color}
                            onChange={(e) => updateSection(section.id, { color: e.target.value })}
                            className="w-full h-10 border rounded cursor-pointer"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-1">Profit per Sq Ft</label>
                          <input
                            type="number"
                            value={section.profitPerSqFt}
                            onChange={(e) => updateSection(section.id, { profitPerSqFt: parseFloat(e.target.value) || 0 })}
                            className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          />
                        </div>

                        <div className="pt-4 border-t">
                          <div className="text-sm text-gray-600">
                            <div>Area: {((section.width * section.height) / 144).toFixed(1)} sq ft</div>
                            <div className="mt-1">Total Profit: ${(section.profitPerSqFt * (section.width * section.height) / 144).toFixed(2)}</div>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </>
              )}
            </div>
          )}
        </div>
      )}

      {/* Dashboard Page */}
      {currentPage === 'dashboard' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">üìä Dashboard</h1>
          
          {/* Shopify Connection Card */}
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold">üõçÔ∏è Shopify Products</h2>
              <button
                onClick={fetchShopifyProducts}
                disabled={!shopifyConfig.connected}
                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold flex items-center gap-2"
              >
                <RefreshCw />
                {shopifyConfig.connected ? 'Fetch Products' : 'Connect Shopify First'}
              </button>
            </div>

            <div className="grid grid-cols-4 gap-4 mb-4">
              <div className="bg-blue-50 rounded-lg p-4">
                <div className="text-sm text-gray-600 mb-1">Total Products</div>
                <div className="text-2xl font-bold text-blue-600">{products.length}</div>
              </div>
              <div className="bg-green-50 rounded-lg p-4">
                <div className="text-sm text-gray-600 mb-1">Avg Price</div>
                <div className="text-2xl font-bold text-green-600">
                  ${products.length > 0 ? (products.reduce((sum, p) => sum + p.price, 0) / products.length).toFixed(2) : '0.00'}
                </div>
              </div>
              <div className="bg-purple-50 rounded-lg p-4">
                <div className="text-sm text-gray-600 mb-1">Total Value</div>
                <div className="text-2xl font-bold text-purple-600">
                  ${products.reduce((sum, p) => sum + (p.price * (p.inventoryQuantity || 0)), 0).toFixed(2)}
                </div>
              </div>
              <div className="bg-orange-50 rounded-lg p-4">
                <div className="text-sm text-gray-600 mb-1">Low Stock Items</div>
                <div className="text-2xl font-bold text-orange-600">
                  {products.filter(p => (p.inventoryQuantity || 0) < 10).length}
                </div>
              </div>
            </div>

            {products.length > 0 && (
              <div className="max-h-96 overflow-y-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 sticky top-0">
                    <tr>
                      <th className="px-4 py-2 text-left text-sm font-semibold">Product</th>
                      <th className="px-4 py-2 text-left text-sm font-semibold">Vendor</th>
                      <th className="px-4 py-2 text-left text-sm font-semibold">SKU</th>
                      <th className="px-4 py-2 text-left text-sm font-semibold">Price</th>
                      <th className="px-4 py-2 text-left text-sm font-semibold">Stock</th>
                    </tr>
                  </thead>
                  <tbody>
                    {products.slice(0, 50).map((product, idx) => (
                      <tr key={idx} className="border-t hover:bg-gray-50">
                        <td className="px-4 py-2 text-sm">{product.name}</td>
                        <td className="px-4 py-2 text-sm">{product.vendor}</td>
                        <td className="px-4 py-2 text-sm font-mono text-xs">{product.sku}</td>
                        <td className="px-4 py-2 text-sm font-semibold">${product.price.toFixed(2)}</td>
                        <td className="px-4 py-2 text-sm">
                          <span className={product.inventoryQuantity < 10 ? 'text-red-600 font-bold' : ''}>
                            {product.inventoryQuantity}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {products.length > 50 && (
                  <div className="text-center py-4 text-gray-500 text-sm">
                    Showing 50 of {products.length} products
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      )}

      {currentPage === 'forecasting' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">üìà Forecasting</h1>
          <div className="bg-white rounded-lg shadow-lg p-6">
            <p className="text-gray-600">Forecasting features coming soon...</p>
          </div>
        </div>
      )}

      {currentPage === 'analytics' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">üìä Row Analytics</h1>
          
          {fixtures.length === 0 ? (
            <div className="bg-white rounded-lg shadow-lg p-8 text-center">
              <p className="text-gray-600 mb-4">No fixtures created yet. Go to Store Planner to add fixtures.</p>
              <button
                onClick={() => setCurrentPage('planner')}
                className="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 font-semibold"
              >
                Go to Store Planner
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              {fixtures.map((fixture) => {
                const fixtureProducts = fixture.products?.map(pid => 
                  products.find(p => p.id === pid)
                ).filter(Boolean) || [];

                const totalRevenue = fixtureProducts.reduce((sum, p) => sum + (p.price * (p.monthlySales || 0)), 0);
                const totalProfit = fixtureProducts.reduce((sum, p) => sum + ((p.price - p.cost) * (p.monthlySales || 0)), 0);
                const totalSales = fixtureProducts.reduce((sum, p) => sum + (p.monthlySales || 0), 0);
                const totalStock = fixtureProducts.reduce((sum, p) => sum + (p.inventoryQuantity || 0), 0);
                const lowStockCount = fixtureProducts.filter(p => (p.inventoryQuantity || 0) < 10).length;

                return (
                  <div key={fixture.id} className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4">{fixture.name}</h2>
                    
                    <div className="grid grid-cols-4 gap-4 mb-6">
                      <div className="bg-white rounded-lg p-3 shadow">
                        <div className="text-sm text-gray-600 mb-1">Revenue</div>
                        <div className="text-2xl font-bold text-green-600">${totalRevenue.toFixed(2)}</div>
                      </div>
                      
                      <div className="bg-white rounded-lg p-3 shadow">
                        <div className="text-sm text-gray-600 mb-1">Profit</div>
                        <div className="text-2xl font-bold text-blue-600">${totalProfit.toFixed(2)}</div>
                      </div>
                      
                      <div className="bg-white rounded-lg p-3 shadow">
                        <div className="text-sm text-gray-600 mb-1">Units Sold</div>
                        <div className="text-2xl font-bold">{totalSales}</div>
                      </div>
                      
                      <div className="bg-white rounded-lg p-3 shadow">
                        <div className="text-sm text-gray-600 mb-1">Total Stock</div>
                        <div className="text-2xl font-bold">{totalStock} {lowStockCount > 0 && <span className="text-red-500">‚ö†Ô∏è{lowStockCount}</span>}</div>
                      </div>
                    </div>
                    
                    {/* Top 5 Products in Row */}
                    {fixtureProducts.length > 0 && (
                      <div>
                        <h4 className="font-semibold mb-2 text-gray-700">Top 5 Products by Sales:</h4>
                        <div className="space-y-2">
                          {fixtureProducts
                            .sort((a, b) => (b.monthlySales || 0) - (a.monthlySales || 0))
                            .slice(0, 5)
                            .map((product, idx) => {
                              const profit = (product.price || 0) - (product.cost || 0);
                              const monthlyProfit = profit * (product.monthlySales || 0);
                              
                              return (
                                <div key={idx} className="bg-white rounded p-3 shadow-sm flex items-center justify-between">
                                  <div className="flex-1">
                                    <div className="font-semibold text-sm">{product.name}</div>
                                    <div className="text-xs text-gray-500">
                                      {product.vendor || 'Unknown Brand'} ‚Ä¢ SKU: {product.sku || product.upc}
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-4 text-sm">
                                    <div className="text-center">
                                      <div className="text-xs text-gray-500">Sales</div>
                                      <div className="font-bold text-green-600">{product.monthlySales || 0}</div>
                                    </div>
                                    <div className="text-center">
                                      <div className="text-xs text-gray-500">Profit</div>
                                      <div className="font-bold text-blue-600">${monthlyProfit.toFixed(2)}</div>
                                    </div>
                                    <div className="text-center">
                                      <div className="text-xs text-gray-500">Stock</div>
                                      <div className={`font-bold ${(product.inventoryQuantity || 0) < 10 ? 'text-red-500' : 'text-gray-700'}`}>
                                        {product.inventoryQuantity || 0}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {currentPage === 'settings' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">‚öôÔ∏è Settings</h1>
          
          <div className="max-w-2xl space-y-6">
            {/* Shopify Connection */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">üõçÔ∏è Shopify Connection</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Store Name</label>
                  <input
                    type="text"
                    value={shopifyConfig.storeName}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, storeName: e.target.value})}
                    placeholder="your-store.myshopify.com"
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Admin API Access Token</label>
                  <input
                    type="password"
                    value={shopifyConfig.accessToken}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, accessToken: e.target.value})}
                    placeholder="shpat_..."
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <button
                  onClick={testShopifyConnection}
                  className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-semibold"
                >
                  Test Connection
                </button>
                
                {shopifyConfig.connected && (
                  <div className="p-3 bg-green-100 text-green-800 rounded">
                    ‚úÖ Connected
                  </div>
                )}
              </div>
            </div>
            
            {/* Additional Settings Placeholder */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">üé® Display Settings</h2>
              <p className="text-gray-600">More settings coming soon...</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

    createRoot(document.getElementById('root')).render(<PlanogramProfitTracker />);
  </script>
</body>
</html>
