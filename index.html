<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Planogram Profit Tracker - v3 Complete</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase Configuration -->
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

// Custom Icons
const Icons = {
  Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
  Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
  Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
  Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
  Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
  Package: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
  BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
  DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
  Maximize2: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
  Grid3x3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
  Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>,
  Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
  AlignVertical: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="16" width="14" height="6" rx="2"></rect><rect x="7" y="2" width="10" height="6" rx="2"></rect><path d="M2 12h20"></path></svg>,
  Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
  Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
  Flame: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>,
  RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
  X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
  Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>,
  AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
};

const FIXTURE_TYPES = {
  GRID_WALL: {
    id: 'grid_wall',
    name: 'Grid Wall',
    icon: 'Grid3x3',
    color: '#64748b',
    defaultWidth: 120,
    defaultHeight: 200
  },
  JEWELRY_CASE: {
    id: 'jewelry_case',
    name: 'Jewelry Case',
    icon: 'Box',
    color: '#8b5cf6',
    defaultWidth: 100,
    defaultHeight: 80
  },
  GONDOLA: {
    id: 'gondola',
    name: 'Gondola',
    icon: 'Layers',
    color: '#ef4444',
    defaultWidth: 180,
    defaultHeight: 120
  },
  SLAT_WALL: {
    id: 'slat_wall',
    name: 'Slat Wall',
    icon: 'AlignVertical',
    color: '#f59e0b',
    defaultWidth: 150,
    defaultHeight: 180
  },
  END_CAP: {
    id: 'end_cap',
    name: 'End Cap',
    icon: 'Package',
    color: '#10b981',
    defaultWidth: 80,
    defaultHeight: 120
  },
  JEWELRY_DISPLAY: {
    id: 'jewelry_display',
    name: 'Jewelry Display',
    icon: 'Box',
    color: '#fbbf24',
    defaultWidth: 90,
    defaultHeight: 90
  },
  MAKEUP_WALL: {
    id: 'makeup_wall',
    name: 'Makeup Wall',
    icon: 'Grid3x3',
    color: '#ff1493',
    defaultWidth: 200,
    defaultHeight: 220
  }
};

const getCursor = (position) => {
  const cursors = {
    'nw': 'nwse-resize', 'ne': 'nesw-resize', 'se': 'nwse-resize', 'sw': 'nesw-resize',
    'n': 'ns-resize', 's': 'ns-resize', 'e': 'ew-resize', 'w': 'ew-resize'
  };
  return cursors[position];
};

const getHandlePosition = (position) => {
  const positions = {
    'nw': { top: -6, left: -6, width: '12px', height: '12px' },
    'n': { top: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'ne': { top: -6, right: -6, width: '12px', height: '12px' },
    'e': { right: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' },
    'se': { bottom: -6, right: -6, width: '12px', height: '12px' },
    's': { bottom: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'sw': { bottom: -6, left: -6, width: '12px', height: '12px' },
    'w': { left: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' }
  };
  return positions[position];
};

const ResizeHandle = ({ position, onMouseDown }) => {
  const style = getHandlePosition(position);
  return (
    <div
      onMouseDown={(e) => onMouseDown(e, position)}
      style={{
        position: 'absolute',
        ...style,
        backgroundColor: 'white',
        border: '2px solid #3b82f6',
        borderRadius: position.length === 1 ? '0' : '50%',
        cursor: getCursor(position),
        zIndex: 10
      }}
    />
  );
};

const FixtureItem = ({ fixture, isSelected, onClick, onMouseDown, onResize, onDelete, scale = 1 }) => {
  const fixtureType = Object.values(FIXTURE_TYPES).find(t => t.id === fixture.type) || FIXTURE_TYPES.GRID_WALL;
  const Icon = Icons[fixtureType.icon];

  return (
    <div
      onClick={onClick}
      onMouseDown={onMouseDown}
      style={{
        position: 'absolute',
        left: `${fixture.x}px`,
        top: `${fixture.y}px`,
        width: `${fixture.width}px`,
        height: `${fixture.height}px`,
        backgroundColor: isSelected ? `${fixtureType.color}20` : 'white',
        border: isSelected ? `3px solid ${fixtureType.color}` : `2px solid ${fixtureType.color}`,
        borderRadius: '8px',
        cursor: 'move',
        boxShadow: isSelected ? '0 8px 16px rgba(0,0,0,0.2)' : '0 2px 8px rgba(0,0,0,0.1)',
        transition: 'box-shadow 0.2s',
        zIndex: isSelected ? 1000 : 1
      }}
      className="group"
    >
      {isSelected && (
        <>
          {['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'].map(position => (
            <ResizeHandle
              key={position}
              position={position}
              onMouseDown={(e) => onResize(e, position)}
            />
          ))}
        </>
      )}
      
      <div className="h-full flex flex-col items-center justify-center p-2">
        <div style={{ color: fixtureType.color, transform: `scale(${Math.min(1, fixture.width / 100)})` }}>
          <Icon />
        </div>
        <div style={{ 
          fontSize: `${Math.max(10, Math.min(14, fixture.width / 10))}px`,
          color: fixtureType.color,
          fontWeight: 'bold',
          marginTop: '4px',
          textAlign: 'center'
        }}>
          {fixture.name}
        </div>
        <div style={{ 
          fontSize: `${Math.max(8, Math.min(10, fixture.width / 12))}px`,
          color: '#666',
          marginTop: '2px'
        }}>
          {fixture.width}" × {fixture.height}"
        </div>
      </div>

      {isSelected && (
        <button
          onClick={onDelete}
          className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
          style={{ zIndex: 1001 }}
        >
          <Icons.X />
        </button>
      )}
    </div>
  );
};

const PlanogramProfitTracker = () => {
  const [currentPage, setCurrentPage] = useState('planner');
  const [sections, setSections] = useState([]);
  const [selectedSection, setSelectedSection] = useState(null);
  const [selectedRowId, setSelectedRowId] = useState(null);
  const [selectedRowState, setSelectedRowState] = useState(null);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [scannedUPC, setScannedUPC] = useState('');
  const [productCache, setProductCache] = useState([]);
  const [isScanning, setIsScanning] = useState(false);
  const [fixtures, setFixtures] = useState([]);
  const [selectedFixture, setSelectedFixture] = useState(null);
  const [isDraggingFixture, setIsDraggingFixture] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const [isResizing, setIsResizing] = useState(false);
  const [resizeHandle, setResizeHandle] = useState(null);
  const [storeScale, setStoreScale] = useState(1);
  const [storeWidth, setStoreWidth] = useState(1200);
  const [storeHeight, setStoreHeight] = useState(800);
  const [lastSaveTime, setLastSaveTime] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [loadMessage, setLoadMessage] = useState('');
  const [unknownProducts, setUnknownProducts] = useState([]);
  const [showUnknownProducts, setShowUnknownProducts] = useState(true);
  
  const upcInputRef = useRef(null);
  const canvasRef = useRef(null);

  const [shopifyConfig, setShopifyConfig] = useState({
    storeName: '',
    accessToken: '',
    connected: false
  });

  // Load Shopify config from localStorage on mount
  useEffect(() => {
    const savedConfig = localStorage.getItem('shopifyConfig');
    if (savedConfig) {
      const config = JSON.parse(savedConfig);
      setShopifyConfig(config);
      if (config.connected && config.storeName && config.accessToken) {
        fetchAllProducts(config.storeName, config.accessToken);
      }
    }

    // Load from Firebase on mount
    if (window.firebaseService) {
      loadFromFirebase();
    }
  }, []);

  // Save Shopify config to localStorage whenever it changes
  useEffect(() => {
    if (shopifyConfig.storeName || shopifyConfig.accessToken) {
      localStorage.setItem('shopifyConfig', JSON.stringify(shopifyConfig));
    }
  }, [shopifyConfig]);

  // Auto-focus UPC input when row is selected and page is planner
  useEffect(() => {
    if (selectedRowId && currentPage === 'planner' && upcInputRef.current) {
      upcInputRef.current.focus();
    }
  }, [selectedRowId, currentPage]);

  // Keyboard shortcuts for row navigation
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (currentPage !== 'planner' || !selectedSection || !selectedRowId) return;
      
      const section = sections.find(s => s.id === selectedSection);
      if (!section) return;

      const currentRowIndex = section.rows.findIndex(r => r.id === selectedRowId);
      
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'ArrowUp' && currentRowIndex > 0) {
          e.preventDefault();
          const newRowId = section.rows[currentRowIndex - 1].id;
          setSelectedRowId(newRowId);
          setSelectedRowState(section.rows[currentRowIndex - 1]);
        } else if (e.key === 'ArrowDown' && currentRowIndex < section.rows.length - 1) {
          e.preventDefault();
          const newRowId = section.rows[currentRowIndex + 1].id;
          setSelectedRowId(newRowId);
          setSelectedRowState(section.rows[currentRowIndex + 1]);
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentPage, selectedSection, selectedRowId, sections]);

  const testShopifyConnection = async () => {
    if (!shopifyConfig.storeName || !shopifyConfig.accessToken) {
      alert('Please enter both store name and access token');
      return;
    }

    try {
      const response = await fetch(`https://${shopifyConfig.storeName}/admin/api/2024-01/products.json?limit=1`, {
        headers: {
          'X-Shopify-Access-Token': shopifyConfig.accessToken,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        setShopifyConfig(prev => ({ ...prev, connected: true }));
        alert('✅ Connection successful! Loading products...');
        await fetchAllProducts(shopifyConfig.storeName, shopifyConfig.accessToken);
      } else {
        const error = await response.json();
        alert(`❌ Connection failed: ${error.errors || 'Unknown error'}`);
        setShopifyConfig(prev => ({ ...prev, connected: false }));
      }
    } catch (error) {
      alert(`❌ Connection error: ${error.message}`);
      setShopifyConfig(prev => ({ ...prev, connected: false }));
    }
  };

  const fetchAllProducts = async (storeName, accessToken) => {
    let allProducts = [];
    let hasNextPage = true;
    let pageInfo = null;

    try {
      while (hasNextPage) {
        const url = pageInfo 
          ? `https://${storeName}/admin/api/2024-01/products.json?limit=250&page_info=${pageInfo}`
          : `https://${storeName}/admin/api/2024-01/products.json?limit=250`;

        const response = await fetch(url, {
          headers: {
            'X-Shopify-Access-Token': accessToken,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) throw new Error('Failed to fetch products');

        const data = await response.json();
        
        data.products.forEach(product => {
          product.variants.forEach(variant => {
            if (variant.barcode) {
              allProducts.push({
                upc: variant.barcode,
                sku: variant.sku || product.id,
                name: product.title + (variant.title !== 'Default Title' ? ` - ${variant.title}` : ''),
                price: parseFloat(variant.price),
                cost: parseFloat(variant.cost || 0),
                vendor: product.vendor,
                productType: product.product_type,
                inventoryQuantity: variant.inventory_quantity || 0,
                weight: variant.weight || 0,
                image: product.images?.[0]?.src || ''
              });
            }
          });
        });

        const linkHeader = response.headers.get('Link');
        hasNextPage = linkHeader && linkHeader.includes('rel="next"');
        
        if (hasNextPage) {
          const nextMatch = linkHeader.match(/<[^>]*page_info=([^>&]*)>; rel="next"/);
          pageInfo = nextMatch ? nextMatch[1] : null;
          hasNextPage = !!pageInfo;
        }
      }

      setProductCache(allProducts);
      console.log(`✅ Loaded ${allProducts.length} products from Shopify`);
      
      // Check if any unknown products can now be resolved
      checkUnknownProducts(allProducts);
      
    } catch (error) {
      console.error('Error fetching products:', error);
      alert(`Failed to load products: ${error.message}`);
    }
  };

  const checkUnknownProducts = (products) => {
    setUnknownProducts(prev => {
      return prev.map(unknown => {
        const matchedProduct = products.find(p => p.upc === unknown.upc);
        if (matchedProduct && !unknown.resolved) {
          return {
            ...unknown,
            resolved: true,
            matchedProduct: matchedProduct,
            resolvedAt: new Date().toISOString()
          };
        }
        return unknown;
      });
    });
  };

  const addSection = () => {
    const newSection = {
      id: Date.now(),
      name: `Section ${sections.length + 1}`,
      rows: []
    };
    setSections([...sections, newSection]);
    setSelectedSection(newSection.id);
  };

  const deleteSection = (sectionId) => {
    if (window.confirm('Delete this section and all its rows?')) {
      setSections(sections.filter(s => s.id !== sectionId));
      if (selectedSection === sectionId) {
        setSelectedSection(null);
        setSelectedRowId(null);
      }
    }
  };

  const renameSection = (sectionId) => {
    const section = sections.find(s => s.id === sectionId);
    const newName = prompt('Enter new section name:', section.name);
    if (newName && newName.trim()) {
      setSections(sections.map(s => 
        s.id === sectionId ? { ...s, name: newName.trim() } : s
      ));
    }
  };

  const addRow = () => {
    if (!selectedSection) {
      alert('Please select a section first');
      return;
    }

    const section = sections.find(s => s.id === selectedSection);
    const newRow = {
      id: Date.now(),
      name: `Row ${section.rows.length + 1}`,
      width: 48,
      height: 72,
      depth: 12,
      products: []
    };

    setSections(sections.map(s => 
      s.id === selectedSection 
        ? { ...s, rows: [...s.rows, newRow] }
        : s
    ));
    
    setSelectedRowId(newRow.id);
    setSelectedRowState(newRow);
  };

  const deleteRow = (rowId) => {
    if (window.confirm('Delete this row and all its products?')) {
      setSections(sections.map(s => ({
        ...s,
        rows: s.rows.filter(r => r.id !== rowId)
      })));
      
      if (selectedRowId === rowId) {
        setSelectedRowId(null);
        setSelectedRowState(null);
      }
    }
  };

  const renameRow = (sectionId, rowId) => {
    const section = sections.find(s => s.id === sectionId);
    const row = section.rows.find(r => r.id === rowId);
    const newName = prompt('Enter new row name:', row.name);
    if (newName && newName.trim()) {
      setSections(sections.map(s => 
        s.id === sectionId 
          ? {
              ...s,
              rows: s.rows.map(r => 
                r.id === rowId ? { ...r, name: newName.trim() } : r
              )
            }
          : s
      ));
    }
  };

  const updateRowDimensions = (rowId, dimension, value) => {
    const numValue = parseFloat(value) || 0;
    setSections(sections.map(s => ({
      ...s,
      rows: s.rows.map(r => 
        r.id === rowId ? { ...r, [dimension]: numValue } : r
      )
    })));

    if (selectedRowId === rowId) {
      setSelectedRowState(prev => ({ ...prev, [dimension]: numValue }));
    }
  };

  const handleUPCScan = async (e) => {
    if (e.key === 'Enter' && scannedUPC.trim()) {
      if (!selectedRowId) {
        alert('Please select a row first');
        setScannedUPC('');
        return;
      }

      setIsScanning(true);
      
      const product = productCache.find(p => p.upc === scannedUPC.trim());
      
      if (product) {
        addProductToRow(product);
      } else {
        // UPC not found - add to unknown products
        const existingUnknown = unknownProducts.find(u => u.upc === scannedUPC.trim());
        if (!existingUnknown) {
          const newUnknown = {
            id: Date.now(),
            upc: scannedUPC.trim(),
            note: '',
            addedAt: new Date().toISOString(),
            resolved: false
          };
          setUnknownProducts(prev => [...prev, newUnknown]);
        }
        alert(`⚠️ UPC ${scannedUPC.trim()} not found in Shopify. Added to Unknown Products list.`);
      }
      
      setScannedUPC('');
      setTimeout(() => setIsScanning(false), 500);
    }
  };

  const addProductToRow = (product) => {
    setSections(sections.map(s => ({
      ...s,
      rows: s.rows.map(r => {
        if (r.id === selectedRowId) {
          const existingProduct = r.products.find(p => p.upc === product.upc);
          if (existingProduct) {
            return {
              ...r,
              products: r.products.map(p => 
                p.upc === product.upc 
                  ? { ...p, quantity: p.quantity + 1 }
                  : p
              )
            };
          } else {
            return {
              ...r,
              products: [...r.products, { ...product, quantity: 1, monthlySales: 0 }]
            };
          }
        }
        return r;
      })
    })));

    if (selectedRowState && selectedRowState.id === selectedRowId) {
      const existingProduct = selectedRowState.products.find(p => p.upc === product.upc);
      if (existingProduct) {
        setSelectedRowState({
          ...selectedRowState,
          products: selectedRowState.products.map(p => 
            p.upc === product.upc 
              ? { ...p, quantity: p.quantity + 1 }
              : p
          )
        });
      } else {
        setSelectedRowState({
          ...selectedRowState,
          products: [...selectedRowState.products, { ...product, quantity: 1, monthlySales: 0 }]
        });
      }
    }
  };

  const updateProductQuantity = (productUpc, change) => {
    setSections(sections.map(s => ({
      ...s,
      rows: s.rows.map(r => {
        if (r.id === selectedRowId) {
          return {
            ...r,
            products: r.products.map(p => {
              if (p.upc === productUpc) {
                const newQuantity = Math.max(0, p.quantity + change);
                return { ...p, quantity: newQuantity };
              }
              return p;
            }).filter(p => p.quantity > 0)
          };
        }
        return r;
      })
    })));

    if (selectedRowState) {
      setSelectedRowState({
        ...selectedRowState,
        products: selectedRowState.products.map(p => {
          if (p.upc === productUpc) {
            const newQuantity = Math.max(0, p.quantity + change);
            return { ...p, quantity: newQuantity };
          }
          return p;
        }).filter(p => p.quantity > 0)
      });
    }
  };

  const updateProductSales = (productUpc, sales) => {
    const numSales = parseInt(sales) || 0;
    
    setSections(sections.map(s => ({
      ...s,
      rows: s.rows.map(r => {
        if (r.id === selectedRowId) {
          return {
            ...r,
            products: r.products.map(p => 
              p.upc === productUpc ? { ...p, monthlySales: numSales } : p
            )
          };
        }
        return r;
      })
    })));

    if (selectedRowState) {
      setSelectedRowState({
        ...selectedRowState,
        products: selectedRowState.products.map(p => 
          p.upc === productUpc ? { ...p, monthlySales: numSales } : p
        )
      });
    }
  };

  const removeProduct = (productUpc) => {
    setSections(sections.map(s => ({
      ...s,
      rows: s.rows.map(r => {
        if (r.id === selectedRowId) {
          return {
            ...r,
            products: r.products.filter(p => p.upc !== productUpc)
          };
        }
        return r;
      })
    })));

    if (selectedRowState) {
      setSelectedRowState({
        ...selectedRowState,
        products: selectedRowState.products.filter(p => p.upc !== productUpc)
      });
    }
  };

  const addFixture = (fixtureType) => {
    const type = FIXTURE_TYPES[fixtureType];
    const newFixture = {
      id: Date.now(),
      type: type.id,
      name: type.name,
      x: 100,
      y: 100,
      width: type.defaultWidth,
      height: type.defaultHeight
    };
    setFixtures([...fixtures, newFixture]);
    setSelectedFixture(newFixture.id);
  };

  const deleteFixture = (e, fixtureId) => {
    e.stopPropagation();
    setFixtures(fixtures.filter(f => f.id !== fixtureId));
    if (selectedFixture === fixtureId) {
      setSelectedFixture(null);
    }
  };

  const handleFixtureMouseDown = (e, fixtureId) => {
    e.stopPropagation();
    setSelectedFixture(fixtureId);
    setIsDraggingFixture(true);
    
    const fixture = fixtures.find(f => f.id === fixtureId);
    const rect = e.currentTarget.getBoundingClientRect();
    const canvas = canvasRef.current.getBoundingClientRect();
    
    setDragOffset({
      x: (e.clientX - canvas.left) / storeScale - fixture.x,
      y: (e.clientY - canvas.top) / storeScale - fixture.y
    });
  };

  const handleFixtureResize = (e, position) => {
    e.stopPropagation();
    setIsResizing(true);
    setResizeHandle(position);
  };

  const handleCanvasMouseMove = (e) => {
    if (!selectedFixture) return;

    const canvas = canvasRef.current.getBoundingClientRect();
    const x = (e.clientX - canvas.left) / storeScale;
    const y = (e.clientY - canvas.top) / storeScale;

    if (isDraggingFixture) {
      setFixtures(fixtures.map(f => 
        f.id === selectedFixture
          ? { 
              ...f, 
              x: Math.max(0, Math.min(storeWidth - f.width, x - dragOffset.x)),
              y: Math.max(0, Math.min(storeHeight - f.height, y - dragOffset.y))
            }
          : f
      ));
    } else if (isResizing && resizeHandle) {
      const fixture = fixtures.find(f => f.id === selectedFixture);
      if (!fixture) return;

      let newX = fixture.x;
      let newY = fixture.y;
      let newWidth = fixture.width;
      let newHeight = fixture.height;

      if (resizeHandle.includes('e')) {
        newWidth = Math.max(50, x - fixture.x);
      }
      if (resizeHandle.includes('w')) {
        const diff = fixture.x - x;
        if (fixture.width + diff >= 50) {
          newX = x;
          newWidth = fixture.width + diff;
        }
      }
      if (resizeHandle.includes('s')) {
        newHeight = Math.max(50, y - fixture.y);
      }
      if (resizeHandle.includes('n')) {
        const diff = fixture.y - y;
        if (fixture.height + diff >= 50) {
          newY = y;
          newHeight = fixture.height + diff;
        }
      }

      setFixtures(fixtures.map(f => 
        f.id === selectedFixture
          ? { ...f, x: newX, y: newY, width: newWidth, height: newHeight }
          : f
      ));
    }
  };

  const handleCanvasMouseUp = () => {
    setIsDraggingFixture(false);
    setIsResizing(false);
    setResizeHandle(null);
  };

  const handleCanvasClick = (e) => {
    if (e.target === e.currentTarget) {
      setSelectedFixture(null);
    }
  };

  const saveToFirebase = async () => {
    if (!window.firebaseService) {
      alert('Firebase not initialized');
      return;
    }

    setIsSaving(true);
    try {
      const data = {
        sections,
        fixtures,
        storeWidth,
        storeHeight,
        unknownProducts,
        timestamp: new Date().toISOString()
      };

      await window.firebaseService.savePlanogram(data);
      setLastSaveTime(new Date());
      console.log('✅ Saved to Firebase');
    } catch (error) {
      console.error('Error saving to Firebase:', error);
      alert('Failed to save to Firebase: ' + error.message);
    } finally {
      setIsSaving(false);
    }
  };

  const loadFromFirebase = async () => {
    if (!window.firebaseService) {
      setLoadMessage('Firebase not initialized');
      return;
    }

    try {
      const data = await window.firebaseService.loadPlanogram();
      if (data) {
        setSections(data.sections || []);
        setFixtures(data.fixtures || []);
        setStoreWidth(data.storeWidth || 1200);
        setStoreHeight(data.storeHeight || 800);
        setUnknownProducts(data.unknownProducts || []);
        setLoadMessage('✅ Loaded from Firebase');
        console.log('✅ Loaded from Firebase', data);
      } else {
        setLoadMessage('No saved data found');
      }
    } catch (error) {
      console.error('Error loading from Firebase:', error);
      setLoadMessage('❌ Failed to load: ' + error.message);
    }
  };

  const updateUnknownProductNote = (id, note) => {
    setUnknownProducts(prev => 
      prev.map(u => u.id === id ? { ...u, note } : u)
    );
  };

  const deleteUnknownProduct = (id) => {
    setUnknownProducts(prev => prev.filter(u => u.id !== id));
  };

  const refreshUnknownProducts = async () => {
    if (productCache.length === 0) {
      alert('Please connect to Shopify first');
      return;
    }
    checkUnknownProducts(productCache);
    alert('✅ Checked unknown products against current Shopify catalog');
  };

  const exportToJSON = () => {
    const data = {
      sections,
      fixtures,
      storeWidth,
      storeHeight,
      unknownProducts,
      exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `planogram-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const importFromJSON = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        setSections(data.sections || []);
        setFixtures(data.fixtures || []);
        setStoreWidth(data.storeWidth || 1200);
        setStoreHeight(data.storeHeight || 800);
        setUnknownProducts(data.unknownProducts || []);
        alert('✅ Data imported successfully!');
      } catch (error) {
        alert('❌ Failed to import: ' + error.message);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const calculateSectionMetrics = () => {
    return sections.map(section => {
      let totalRevenue = 0;
      let totalProfit = 0;
      let totalProducts = 0;
      let totalSpace = 0;

      section.rows.forEach(row => {
        const rowSpace = (row.width * row.height * row.depth) / 1728;
        totalSpace += rowSpace;

        row.products.forEach(product => {
          const revenue = product.price * (product.monthlySales || 0) * product.quantity;
          const profit = (product.price - product.cost) * (product.monthlySales || 0) * product.quantity;
          totalRevenue += revenue;
          totalProfit += profit;
          totalProducts += product.quantity;
        });
      });

      return {
        ...section,
        totalRevenue,
        totalProfit,
        totalProducts,
        totalSpace,
        profitPerSqFt: totalSpace > 0 ? totalProfit / totalSpace : 0
      };
    });
  };

  const metricsData = calculateSectionMetrics();

  return (
    <div className="flex h-screen bg-gray-100">
      {/* Sidebar */}
      <div className="w-64 bg-gray-800 text-white flex flex-col">
        <div className="p-6">
          <h1 className="text-2xl font-bold">Store Planner Pro</h1>
          <p className="text-sm text-gray-400 mt-1">Profit Optimization</p>
        </div>
        
        <nav className="flex-1">
          <button
            onClick={() => setCurrentPage('planner')}
            className={`w-full px-6 py-3 text-left flex items-center gap-3 ${
              currentPage === 'planner' ? 'bg-gray-700' : 'hover:bg-gray-700'
            }`}
          >
            <Icons.Grid3x3 />
            Planner
          </button>
          
          <button
            onClick={() => setCurrentPage('layout')}
            className={`w-full px-6 py-3 text-left flex items-center gap-3 ${
              currentPage === 'layout' ? 'bg-gray-700' : 'hover:bg-gray-700'
            }`}
          >
            <Icons.Maximize2 />
            Store Layout
          </button>
          
          <button
            onClick={() => setCurrentPage('analytics')}
            className={`w-full px-6 py-3 text-left flex items-center gap-3 ${
              currentPage === 'analytics' ? 'bg-gray-700' : 'hover:bg-gray-700'
            }`}
          >
            <Icons.BarChart3 />
            Analytics
          </button>
          
          <button
            onClick={() => setCurrentPage('settings')}
            className={`w-full px-6 py-3 text-left flex items-center gap-3 ${
              currentPage === 'settings' ? 'bg-gray-700' : 'hover:bg-gray-700'
            }`}
          >
            ⚙️ Settings
          </button>
        </nav>

        <div className="p-4 border-t border-gray-700 space-y-2">
          <button
            onClick={saveToFirebase}
            disabled={isSaving}
            className="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded flex items-center justify-center gap-2 disabled:opacity-50"
          >
            <Icons.Save />
            {isSaving ? 'Saving...' : 'Save to Cloud'}
          </button>
          
          {lastSaveTime && (
            <div className="text-xs text-gray-400 text-center">
              Last saved: {lastSaveTime.toLocaleTimeString()}
            </div>
          )}
          
          <button
            onClick={exportToJSON}
            className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded flex items-center justify-center gap-2"
          >
            <Icons.Download />
            Export
          </button>
          
          <label className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded flex items-center justify-center gap-2 cursor-pointer">
            <Icons.Upload />
            Import
            <input
              type="file"
              accept=".json"
              onChange={importFromJSON}
              className="hidden"
            />
          </label>
        </div>
      </div>

      {/* Main Content */}
      {currentPage === 'planner' && (
        <div className="flex-1 flex flex-col overflow-hidden">
          {/* Unknown Products Dashboard */}
          {unknownProducts.length > 0 && (
            <div className="bg-yellow-50 border-b-4 border-yellow-400">
              <div className="p-4">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <Icons.AlertCircle />
                    <h3 className="font-bold text-lg">Unknown Products ({unknownProducts.filter(u => !u.resolved).length} unresolved)</h3>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={refreshUnknownProducts}
                      className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-1 text-sm"
                      title="Check if products are now in Shopify"
                    >
                      <Icons.RefreshCw />
                      Refresh
                    </button>
                    <button
                      onClick={() => setShowUnknownProducts(!showUnknownProducts)}
                      className="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                      {showUnknownProducts ? 'Hide' : 'Show'}
                    </button>
                  </div>
                </div>
                
                {showUnknownProducts && (
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {unknownProducts.map(unknown => (
                      <div
                        key={unknown.id}
                        className={`flex items-center gap-3 p-3 rounded ${
                          unknown.resolved ? 'bg-green-100' : 'bg-white'
                        } border ${unknown.resolved ? 'border-green-300' : 'border-yellow-300'}`}
                      >
                        <div className="flex-shrink-0 w-32">
                          <div className="font-mono text-sm font-bold">{unknown.upc}</div>
                          <div className="text-xs text-gray-500">
                            {new Date(unknown.addedAt).toLocaleDateString()}
                          </div>
                        </div>
                        
                        {unknown.resolved ? (
                          <div className="flex-1 flex items-center gap-3">
                            <div className="flex-1">
                              <div className="font-semibold text-green-700">
                                ✅ Resolved: {unknown.matchedProduct?.name}
                              </div>
                              <div className="text-xs text-gray-600">
                                {unknown.matchedProduct?.vendor} • ${unknown.matchedProduct?.price}
                              </div>
                            </div>
                            <button
                              onClick={() => deleteUnknownProduct(unknown.id)}
                              className="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"
                            >
                              Remove
                            </button>
                          </div>
                        ) : (
                          <>
                            <input
                              type="text"
                              value={unknown.note || ''}
                              onChange={(e) => updateUnknownProductNote(unknown.id, e.target.value)}
                              placeholder="Enter product name or notes..."
                              className="flex-1 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-yellow-500"
                            />
                            <button
                              onClick={() => deleteUnknownProduct(unknown.id)}
                              className="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                              title="Delete"
                            >
                              <Icons.Trash2 />
                            </button>
                          </>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          <div className="flex-1 flex overflow-hidden">
            {/* Sections List */}
            <div className="w-64 bg-white border-r overflow-y-auto">
              <div className="p-4 border-b">
                <button
                  onClick={addSection}
                  className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center justify-center gap-2"
                >
                  <Icons.Plus />
                  Add Section
                </button>
              </div>

              <div className="p-2">
                {sections.map(section => (
                  <div
                    key={section.id}
                    className={`mb-2 p-3 rounded cursor-pointer ${
                      selectedSection === section.id ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100'
                    }`}
                    onClick={() => {
                      setSelectedSection(section.id);
                      setSelectedRowId(null);
                      setSelectedRowState(null);
                    }}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="font-bold">{section.name}</h3>
                      <div className="flex gap-1">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            renameSection(section.id);
                          }}
                          className="text-blue-500 hover:text-blue-700 text-xs"
                        >
                          ✏️
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            deleteSection(section.id);
                          }}
                          className="text-red-500 hover:text-red-700"
                        >
                          <Icons.Trash2 />
                        </button>
                      </div>
                    </div>
                    <div className="text-sm text-gray-600">
                      {section.rows.length} rows
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Rows and Products */}
            <div className="flex-1 flex overflow-hidden">
              {/* Rows List */}
              <div className="w-80 bg-white border-r overflow-y-auto">
                {selectedSection ? (
                  <>
                    <div className="p-4 border-b bg-gray-50">
                      <h2 className="font-bold text-lg mb-3">
                        {sections.find(s => s.id === selectedSection)?.name}
                      </h2>
                      <button
                        onClick={addRow}
                        className="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center justify-center gap-2"
                      >
                        <Icons.Plus />
                        Add Row
                      </button>
                      
                      {selectedRowId && (
                        <div className="mt-3 p-2 bg-blue-50 rounded text-xs text-center">
                          <kbd className="px-2 py-1 bg-white rounded border">Ctrl</kbd> + 
                          <kbd className="px-2 py-1 bg-white rounded border mx-1">↑</kbd>
                          <kbd className="px-2 py-1 bg-white rounded border">↓</kbd>
                          <div className="mt-1 text-gray-600">Switch rows (scanning stays active)</div>
                        </div>
                      )}
                    </div>

                    <div className="p-2">
                      {sections.find(s => s.id === selectedSection)?.rows.map(row => {
                        const totalProducts = row.products.reduce((sum, p) => sum + p.quantity, 0);
                        const totalRevenue = row.products.reduce((sum, p) => 
                          sum + (p.price * (p.monthlySales || 0) * p.quantity), 0
                        );
                        
                        return (
                          <div
                            key={row.id}
                            className={`mb-2 p-3 rounded cursor-pointer ${
                              selectedRowId === row.id ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 hover:bg-gray-100'
                            }`}
                            onClick={() => {
                              setSelectedRowId(row.id);
                              setSelectedRowState(row);
                            }}
                          >
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="font-bold">{row.name}</h4>
                              <div className="flex gap-1">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    renameRow(selectedSection, row.id);
                                  }}
                                  className="text-blue-500 hover:text-blue-700 text-xs"
                                >
                                  ✏️
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    deleteRow(row.id);
                                  }}
                                  className="text-red-500 hover:text-red-700"
                                >
                                  <Icons.Trash2 />
                                </button>
                              </div>
                            </div>
                            
                            <div className="text-xs space-y-1">
                              <div className="flex justify-between">
                                <span className="text-gray-600">Dimensions:</span>
                                <span className="font-mono">{row.width}" × {row.height}" × {row.depth}"</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Products:</span>
                                <span className="font-bold">{totalProducts}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Monthly Revenue:</span>
                                <span className="font-bold text-green-600">${totalRevenue.toFixed(2)}</span>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </>
                ) : (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    Select a section to view rows
                  </div>
                )}
              </div>

              {/* Products Panel */}
              <div className="flex-1 flex flex-col overflow-hidden">
                {selectedRowState ? (
                  <>
                    <div className="p-4 bg-gray-50 border-b">
                      <h3 className="font-bold text-lg mb-3">{selectedRowState.name} - Products</h3>
                      
                      <div className="grid grid-cols-3 gap-3 mb-4">
                        <div>
                          <label className="block text-xs font-medium mb-1">Width (inches)</label>
                          <input
                            type="number"
                            value={selectedRowState.width}
                            onChange={(e) => updateRowDimensions(selectedRowId, 'width', e.target.value)}
                            className="w-full px-2 py-1 border rounded text-sm"
                            min="1"
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-medium mb-1">Height (inches)</label>
                          <input
                            type="number"
                            value={selectedRowState.height}
                            onChange={(e) => updateRowDimensions(selectedRowId, 'height', e.target.value)}
                            className="w-full px-2 py-1 border rounded text-sm"
                            min="1"
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-medium mb-1">Depth (inches)</label>
                          <input
                            type="number"
                            value={selectedRowState.depth}
                            onChange={(e) => updateRowDimensions(selectedRowId, 'depth', e.target.value)}
                            className="w-full px-2 py-1 border rounded text-sm"
                            min="1"
                          />
                        </div>
                      </div>

                      <div className="relative">
                        <input
                          ref={upcInputRef}
                          type="text"
                          value={scannedUPC}
                          onChange={(e) => setScannedUPC(e.target.value)}
                          onKeyPress={handleUPCScan}
                          placeholder="Scan UPC or enter manually..."
                          className={`w-full px-4 py-3 border-2 rounded-lg text-lg ${
                            isScanning ? 'border-green-500 bg-green-50' : 'border-gray-300'
                          }`}
                        />
                        {isScanning && (
                          <div className="absolute right-3 top-3 text-green-500">
                            ✓ Scanned!
                          </div>
                        )}
                      </div>
                      
                      <div className="mt-2 text-xs text-gray-500">
                        {productCache.length} products loaded from Shopify
                      </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4">
                      {selectedRowState.products.length === 0 ? (
                        <div className="text-center text-gray-400 mt-8">
                          <Icons.Package />
                          <p className="mt-2">No products yet. Scan UPCs to add products.</p>
                        </div>
                      ) : (
                        <div className="space-y-3">
                          {selectedRowState.products.map(product => {
                            const profit = (product.price || 0) - (product.cost || 0);
                            const totalProfit = profit * (product.monthlySales || 0) * product.quantity;
                            
                            return (
                              <div key={product.upc} className="bg-white rounded-lg shadow p-4">
                                <div className="flex gap-3">
                                  {product.image && (
                                    <img 
                                      src={product.image} 
                                      alt={product.name}
                                      className="w-20 h-20 object-cover rounded"
                                    />
                                  )}
                                  
                                  <div className="flex-1">
                                    <h4 className="font-bold text-sm mb-1">{product.name}</h4>
                                    <div className="text-xs text-gray-600 space-y-1">
                                      <div>Brand: {product.vendor || 'Unknown'}</div>
                                      <div>UPC: {product.upc}</div>
                                      <div>SKU: {product.sku}</div>
                                      <div className="flex gap-4 mt-2">
                                        <span>Price: ${product.price?.toFixed(2)}</span>
                                        <span>Cost: ${product.cost?.toFixed(2)}</span>
                                        <span className="font-bold text-green-600">
                                          Profit: ${profit.toFixed(2)}
                                        </span>
                                      </div>
                                    </div>
                                  </div>

                                  <div className="flex flex-col gap-2">
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={() => updateProductQuantity(product.upc, -1)}
                                        className="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                                      >
                                        -
                                      </button>
                                      <span className="font-bold w-12 text-center">{product.quantity}</span>
                                      <button
                                        onClick={() => updateProductQuantity(product.upc, 1)}
                                        className="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600"
                                      >
                                        +
                                      </button>
                                    </div>

                                    <div>
                                      <label className="text-xs text-gray-600">Monthly Sales:</label>
                                      <input
                                        type="number"
                                        value={product.monthlySales || 0}
                                        onChange={(e) => updateProductSales(product.upc, e.target.value)}
                                        className="w-full px-2 py-1 border rounded text-sm"
                                        min="0"
                                      />
                                    </div>

                                    <div className="text-xs">
                                      <div className="font-bold text-blue-600">
                                        Total Monthly Profit:
                                      </div>
                                      <div className="text-lg font-bold text-blue-600">
                                        ${totalProfit.toFixed(2)}
                                      </div>
                                    </div>

                                    <button
                                      onClick={() => removeProduct(product.upc)}
                                      className="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"
                                    >
                                      Remove
                                    </button>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  </>
                ) : (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    Select a row to add products
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {currentPage === 'layout' && (
        <div className="flex-1 flex flex-col overflow-hidden">
          <div className="p-4 bg-gray-50 border-b">
            <h2 className="text-2xl font-bold mb-4">🏪 Store Layout Designer</h2>
            
            <div className="flex items-center gap-4 mb-4">
              <div className="flex items-center gap-2">
                <label className="text-sm font-medium">Store Width:</label>
                <input
                  type="number"
                  value={storeWidth}
                  onChange={(e) => setStoreWidth(Math.max(400, parseInt(e.target.value) || 1200))}
                  className="w-24 px-2 py-1 border rounded"
                  min="400"
                />
                <span className="text-sm text-gray-600">inches</span>
              </div>
              
              <div className="flex items-center gap-2">
                <label className="text-sm font-medium">Store Height:</label>
                <input
                  type="number"
                  value={storeHeight}
                  onChange={(e) => setStoreHeight(Math.max(400, parseInt(e.target.value) || 800))}
                  className="w-24 px-2 py-1 border rounded"
                  min="400"
                />
                <span className="text-sm text-gray-600">inches</span>
              </div>

              <div className="flex items-center gap-2 ml-auto">
                <label className="text-sm font-medium">Zoom:</label>
                <input
                  type="range"
                  min="0.25"
                  max="2"
                  step="0.25"
                  value={storeScale}
                  onChange={(e) => setStoreScale(parseFloat(e.target.value))}
                  className="w-32"
                />
                <span className="text-sm text-gray-600 w-12">{(storeScale * 100).toFixed(0)}%</span>
              </div>
            </div>

            <div className="flex gap-2">
              {Object.entries(FIXTURE_TYPES).map(([key, type]) => {
                const Icon = Icons[type.icon];
                return (
                  <button
                    key={key}
                    onClick={() => addFixture(key)}
                    className="px-4 py-2 rounded flex items-center gap-2 text-white hover:opacity-90"
                    style={{ backgroundColor: type.color }}
                  >
                    <Icon />
                    Add {type.name}
                  </button>
                );
              })}
            </div>
          </div>

          <div className="flex-1 overflow-auto p-8 bg-gray-200">
            <div
              ref={canvasRef}
              onMouseMove={handleCanvasMouseMove}
              onMouseUp={handleCanvasMouseUp}
              onMouseLeave={handleCanvasMouseUp}
              onClick={handleCanvasClick}
              style={{
                width: `${storeWidth * storeScale}px`,
                height: `${storeHeight * storeScale}px`,
                backgroundColor: 'white',
                position: 'relative',
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                margin: '0 auto',
                transform: `scale(${storeScale})`,
                transformOrigin: 'top left'
              }}
            >
              {fixtures.map(fixture => (
                <FixtureItem
                  key={fixture.id}
                  fixture={fixture}
                  isSelected={selectedFixture === fixture.id}
                  onClick={() => setSelectedFixture(fixture.id)}
                  onMouseDown={(e) => handleFixtureMouseDown(e, fixture.id)}
                  onResize={handleFixtureResize}
                  onDelete={(e) => deleteFixture(e, fixture.id)}
                  scale={storeScale}
                />
              ))}
            </div>
          </div>
        </div>
      )}

      {currentPage === 'analytics' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">📊 Profit Analytics</h1>
          
          {metricsData.length === 0 ? (
            <div className="text-center text-gray-400 mt-12">
              <Icons.BarChart3 />
              <p className="mt-4">No data yet. Add sections and products to see analytics.</p>
            </div>
          ) : (
            <div className="space-y-6">
              {metricsData.map(section => {
                return (
                  <div key={section.id} className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4">{section.name}</h2>
                    
                    <div className="grid grid-cols-4 gap-4 mb-6">
                      <div className="bg-blue-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Total Revenue</div>
                        <div className="text-3xl font-bold text-blue-600">
                          ${section.totalRevenue.toFixed(2)}
                        </div>
                      </div>
                      
                      <div className="bg-green-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Total Profit</div>
                        <div className="text-3xl font-bold text-green-600">
                          ${section.totalProfit.toFixed(2)}
                        </div>
                      </div>
                      
                      <div className="bg-purple-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Profit per Sq Ft</div>
                        <div className="text-3xl font-bold text-purple-600">
                          ${section.profitPerSqFt.toFixed(2)}
                        </div>
                      </div>
                      
                      <div className="bg-orange-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Total Products</div>
                        <div className="text-3xl font-bold text-orange-600">
                          {section.totalProducts}
                        </div>
                      </div>
                    </div>

                    <div className="space-y-4">
                      {section.rows.map(row => {
                        const products = row.products || [];
                        const rowRevenue = products.reduce((sum, p) => 
                          sum + (p.price * (p.monthlySales || 0) * p.quantity), 0
                        );
                        const rowProfit = products.reduce((sum, p) => 
                          sum + ((p.price - p.cost) * (p.monthlySales || 0) * p.quantity), 0
                        );
                        const rowSpace = (row.width * row.height * row.depth) / 1728;
                        const profitPerSqFt = rowSpace > 0 ? rowProfit / rowSpace : 0;
                        const totalStock = products.reduce((sum, p) => sum + (p.inventoryQuantity || 0), 0);
                        const lowStockCount = products.filter(p => (p.inventoryQuantity || 0) < 10).length;

                        return (
                          <div key={row.id} className="border rounded-lg p-4">
                            <h3 className="font-bold text-lg mb-3">{row.name}</h3>
                            
                            <div className="grid grid-cols-5 gap-3 mb-4">
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Revenue</div>
                                <div className="text-xl font-bold text-blue-600">${rowRevenue.toFixed(2)}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Profit</div>
                                <div className="text-xl font-bold text-green-600">${rowProfit.toFixed(2)}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Profit/Sq Ft</div>
                                <div className="text-xl font-bold text-purple-600">${profitPerSqFt.toFixed(2)}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Products</div>
                                <div className="text-2xl font-bold">{products.length}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Total Stock</div>
                                <div className="text-2xl font-bold">{totalStock} {lowStockCount > 0 && <span className="text-red-500">⚠️{lowStockCount}</span>}</div>
                              </div>
                            </div>
                            
                            {products.length > 0 && (
                              <div>
                                <h4 className="font-semibold mb-2 text-gray-700">Top 5 Products by Sales:</h4>
                                <div className="space-y-2">
                                  {products
                                    .sort((a, b) => (b.monthlySales || 0) - (a.monthlySales || 0))
                                    .slice(0, 5)
                                    .map((product, idx) => {
                                      const profit = (product.price || 0) - (product.cost || 0);
                                      const monthlyProfit = profit * (product.monthlySales || 0);
                                      
                                      return (
                                        <div key={idx} className="bg-white rounded p-3 shadow-sm flex items-center justify-between">
                                          <div className="flex-1">
                                            <div className="font-semibold text-sm">{product.name}</div>
                                            <div className="text-xs text-gray-500">
                                              {product.vendor || 'Unknown Brand'} • SKU: {product.sku || product.upc}
                                            </div>
                                          </div>
                                          <div className="flex items-center gap-4 text-sm">
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Sales</div>
                                              <div className="font-bold text-green-600">{product.monthlySales || 0}</div>
                                            </div>
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Profit</div>
                                              <div className="font-bold text-blue-600">${monthlyProfit.toFixed(2)}</div>
                                            </div>
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Stock</div>
                                              <div className={`font-bold ${(product.inventoryQuantity || 0) < 10 ? 'text-red-500' : 'text-gray-700'}`}>
                                                {product.inventoryQuantity || 0}
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {currentPage === 'settings' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">⚙️ Settings</h1>
          
          <div className="max-w-2xl space-y-6">
            {/* Shopify Connection */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">🛍️ Shopify Connection</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Store Name</label>
                  <input
                    type="text"
                    value={shopifyConfig.storeName}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, storeName: e.target.value})}
                    placeholder="your-store.myshopify.com"
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Admin API Access Token</label>
                  <input
                    type="password"
                    value={shopifyConfig.accessToken}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, accessToken: e.target.value})}
                    placeholder="shpat_..."
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <button
                  onClick={testShopifyConnection}
                  className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-semibold"
                >
                  Test Connection
                </button>
                
                {shopifyConfig.connected && (
                  <div className="p-3 bg-green-100 text-green-800 rounded">
                    ✅ Connected - {productCache.length} products loaded
                  </div>
                )}
              </div>
            </div>
            
            {/* Additional Settings Placeholder */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">🎨 Display Settings</h2>
              <p className="text-gray-600">More settings coming soon...</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

    createRoot(document.getElementById('root')).render(<PlanogramProfitTracker />);
  </script>
</body>
</html>
