<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Planogram Profit Tracker - v3 Complete</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase Configuration -->
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

// Custom Icons
const Icons = {
  Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
  Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
  Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
  Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
  Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
  Package: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
  BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
  DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
  Maximize2: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
  Grid3x3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
  Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>,
  Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
  AlignVertical: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="16" width="14" height="6" rx="2"></rect><rect x="7" y="2" width="10" height="6" rx="2"></rect><path d="M2 12h20"></path></svg>,
  Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
  Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
  Flame: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>,
  RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
  X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
  Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>,
  AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
};

const FIXTURE_TYPES = {
  GRID_WALL: {
    id: 'grid_wall',
    name: 'Grid Wall',
    icon: 'Grid3x3',
    color: '#64748b',
    defaultWidth: 120,
    defaultHeight: 200
  },
  JEWELRY_CASE: {
    id: 'jewelry_case',
    name: 'Jewelry Case',
    icon: 'Box',
    color: '#8b5cf6',
    defaultWidth: 100,
    defaultHeight: 80
  },
  GONDOLA: {
    id: 'gondola',
    name: 'Gondola',
    icon: 'Layers',
    color: '#ef4444',
    defaultWidth: 180,
    defaultHeight: 120
  },
  SLAT_WALL: {
    id: 'slat_wall',
    name: 'Slat Wall',
    icon: 'AlignVertical',
    color: '#f59e0b',
    defaultWidth: 150,
    defaultHeight: 180
  },
  END_CAP: {
    id: 'end_cap',
    name: 'End Cap',
    icon: 'Package',
    color: '#10b981',
    defaultWidth: 80,
    defaultHeight: 120
  },
  JEWELRY_DISPLAY: {
    id: 'jewelry_display',
    name: 'Jewelry Display',
    icon: 'Box',
    color: '#fbbf24',
    defaultWidth: 90,
    defaultHeight: 90
  },
  MAKEUP_WALL: {
    id: 'makeup_wall',
    name: 'Makeup Wall',
    icon: 'Grid3x3',
    color: '#ff1493',
    defaultWidth: 200,
    defaultHeight: 220
  }
};

const getCursor = (position) => {
  const cursors = {
    'nw': 'nwse-resize', 'ne': 'nesw-resize', 'se': 'nwse-resize', 'sw': 'nesw-resize',
    'n': 'ns-resize', 's': 'ns-resize', 'e': 'ew-resize', 'w': 'ew-resize'
  };
  return cursors[position];
};

const getHandlePosition = (position) => {
  const positions = {
    'nw': { top: -6, left: -6, width: '12px', height: '12px' },
    'n': { top: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'ne': { top: -6, right: -6, width: '12px', height: '12px' },
    'e': { right: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' },
    'se': { bottom: -6, right: -6, width: '12px', height: '12px' },
    's': { bottom: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'sw': { bottom: -6, left: -6, width: '12px', height: '12px' },
    'w': { left: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' }
  };
  return positions[position];
};

const PlanogramProfitTracker = () => {
  const [fixtures, setFixtures] = useState([]);
  const [selectedFixture, setSelectedFixture] = useState(null);
  const [sections, setSections] = useState([]);
  const [selectedSection, setSelectedSection] = useState(null);
  const [selectedRow, setSelectedRow] = useState(null);
  const [scale, setScale] = useState(20);
  const [storeName, setStoreName] = useState('My Store Layout');
  const [newProduct, setNewProduct] = useState({ upc: '', sectionId: '', rowId: '' });
  const [scanning, setScanning] = useState(false);
  const [savedLayouts, setSavedLayouts] = useState([]);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [showLoadModal, setShowLoadModal] = useState(false);
  const [feedback, setFeedback] = useState('');
  const [timeFilter, setTimeFilter] = useState('monthly');
  const [sortBy, setSortBy] = useState('profit');
  const [showSettings, setShowSettings] = useState(false);
  const [shopifyConfig, setShopifyConfig] = useState({
    storeName: '1m3tfh-xt.myshopify.com',
    accessToken: '',
    connected: false
  });
  const [firebaseReady, setFirebaseReady] = useState(false);
  const [stickyRowMode, setStickyRowMode] = useState(true); // NEW: Sticky row scanning mode
  const [unknownProducts, setUnknownProducts] = useState([]);
  const [badStockProducts, setBadStockProducts] = useState([]); // NEW: Separate list for negative stock items
  const [showUnknownProducts, setShowUnknownProducts] = useState(true);

  // Initialize Firebase on mount
  useEffect(() => {
    const initFirebase = async () => {
      try {
        if (window.firebaseService) {
          await window.firebaseService.initialize();
          await window.firebaseService.signInAnonymously();
          setFirebaseReady(true);
          console.log('Firebase ready');
          
          // Auto-load the most recent planogram from cloud
          setTimeout(async () => {
            try {
              const planograms = await window.firebaseService.listPlanograms();
              
              if (planograms.length > 0) {
                // Load the most recent one (first in list)
                const mostRecent = planograms[0];
                const data = await window.firebaseService.loadPlanogram(mostRecent.id);
                
                if (data) {
                  setStoreName(data.name || 'Loaded Layout');
                  setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
                  
                  const safeSections = Array.isArray(data.sections) 
                    ? data.sections.map(section => ({
                        ...section,
                        rows: Array.isArray(section.rows) ? section.rows : [],
                        products: Array.isArray(section.products) ? section.products : []
                      }))
                    : [];
                  setSections(safeSections);
                  
                  if (data.shopifyConfig) {
                    setShopifyConfig(prev => ({
                      ...prev,
                      storeName: data.shopifyConfig.storeName || prev.storeName,
                      connected: data.shopifyConfig.connected || false
                    }));
                  }
                  
                  console.log('✅ Auto-loaded from cloud:', mostRecent.name);
                }
              }
            } catch (error) {
              console.log('Auto-load skipped:', error.message);
            }
          }, 1000); // Wait 1 second for Firebase to fully initialize
        }
      } catch (error) {
        console.error('Firebase init failed:', error);
        setFirebaseReady(false);
      }
    };
    initFirebase();
  }, []);

  // 🔥 KEYBOARD SHORTCUTS for row switching
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Only when sticky mode is on and a section/row is selected
      if (!stickyRowMode || !newProduct.sectionId) return;
      
      // Ctrl+Up: Switch to previous row
      if (e.ctrlKey && e.key === 'ArrowUp') {
        e.preventDefault();
        const section = sections.find(s => s.id === newProduct.sectionId);
        if (!section?.rows) return;
        
        const currentRowIndex = section.rows.findIndex(r => r.id === newProduct.rowId);
        if (currentRowIndex > 0) {
          const prevRow = section.rows[currentRowIndex - 1];
          setNewProduct({ ...newProduct, rowId: prevRow.id });
          setFeedback(`⬆️ Switched to: ${prevRow.name}`);
          setTimeout(() => setFeedback(''), 1500);
        }
      }
      
      // Ctrl+Down: Switch to next row
      if (e.ctrlKey && e.key === 'ArrowDown') {
        e.preventDefault();
        const section = sections.find(s => s.id === newProduct.sectionId);
        if (!section?.rows) return;
        
        const currentRowIndex = section.rows.findIndex(r => r.id === newProduct.rowId);
        if (currentRowIndex < section.rows.length - 1 && currentRowIndex !== -1) {
          const nextRow = section.rows[currentRowIndex + 1];
          setNewProduct({ ...newProduct, rowId: nextRow.id });
          setFeedback(`⬇️ Switched to: ${nextRow.name}`);
          setTimeout(() => setFeedback(''), 1500);
        }
      }
      
      // Ctrl+S: Quick save to cloud
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveToCloud();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [stickyRowMode, newProduct, sections]);

  // Save to Firebase Cloud
  const saveToCloud = async (silent = false) => {
    if (!firebaseReady) {
      if (!silent) alert('Firebase not ready. Please wait a moment and try again.');
      return;
    }

    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      if (!silent) alert('Firebase authentication failed. Please refresh the page.');
      return;
    }

    try {
      setSyncStatus('💾 Saving...');
      
      const planogramData = {
        name: storeName,
        fixtures: fixtures,
        sections: sections,
        unknownProducts: unknownProducts,
        badStockProducts: badStockProducts,
        shopifyConfig: {
          storeName: shopifyConfig.storeName,
          connected: shopifyConfig.connected
        }
      };

      const id = await window.firebaseService.savePlanogram(planogramData);
      if (id) {
        const timestamp = new Date().toLocaleTimeString();
        setSyncStatus(`☁️ Saved at ${timestamp}`);
        setTimeout(() => setSyncStatus(''), 3000);
        console.log(`☁️ ${silent ? 'Auto-saved' : 'Saved'} at ${timestamp}`);
      }
    } catch (error) {
      console.error('Save failed:', error);
      setSyncStatus('❌ Save failed!');
      setTimeout(() => setSyncStatus(''), 3000);
      if (!silent) {
        alert('❌ Failed to save to cloud: ' + error.message);
      }
    }
  };

  // Load from Firebase Cloud
  const loadFromCloud = async () => {
    if (!firebaseReady) {
      alert('Firebase not ready. Please wait a moment and try again.');
      return;
    }

    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase authentication failed. Please refresh the page.');
      return;
    }

    try {
      const planograms = await window.firebaseService.listPlanograms();
      
      if (planograms.length === 0) {
        alert('No saved layouts found in cloud.');
        return;
      }

      // Show list to user
      const planogramNames = planograms.map((p, idx) => 
        `${idx + 1}. ${p.name} (${new Date(p.lastModified).toLocaleString()})`
      ).join('\n');
      
      const selection = prompt(`Choose a layout to load:\n\n${planogramNames}\n\nEnter number (1-${planograms.length}):`);
      
      if (selection) {
        const index = parseInt(selection) - 1;
        if (index >= 0 && index < planograms.length) {
          const selectedPlanogram = planograms[index];
          const data = await window.firebaseService.loadPlanogram(selectedPlanogram.id);
          
          if (data) {
            setStoreName(data.name || 'Loaded Layout');
            
            // Ensure fixtures is always an array
            setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
            
            // Ensure sections is always an array and each section has rows array
            const safeSections = Array.isArray(data.sections) 
              ? data.sections.map(section => ({
                  ...section,
                  rows: Array.isArray(section.rows) ? section.rows : [],
                  products: Array.isArray(section.products) ? section.products : []
                }))
              : [];
            setSections(safeSections);
            
            if (data.shopifyConfig) {
              setShopifyConfig(prev => ({
                ...prev,
                storeName: data.shopifyConfig.storeName || prev.storeName,
                connected: data.shopifyConfig.connected || false
              }));
            }
            alert('✅ Layout loaded from cloud!');
          }
        }
      }
    } catch (error) {
      console.error('Load failed:', error);
      alert('❌ Failed to load from cloud.');
    }
  };
  
  const [showLibrary, setShowLibrary] = useState(false);
  const [heatMapMode, setHeatMapMode] = useState(true); // Heat map ON by default
  const [timePeriod, setTimePeriod] = useState('month'); // day, week, month, quarter, custom
  const [customStartDate, setCustomStartDate] = useState(() => {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  });
  const [customEndDate, setCustomEndDate] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });
  const [customDateRange, setCustomDateRange] = useState({ start: '', end: '' });
  const [backgroundImage, setBackgroundImage] = useState(null);
  const [bgImagePosition, setBgImagePosition] = useState({ x: 0, y: 0 });
  const [isDraggingBg, setIsDraggingBg] = useState(false);
  const [bgDragStart, setBgDragStart] = useState({ x: 0, y: 0 });
  const [showVisualMode, setShowVisualMode] = useState(true);
  const [editingSection, setEditingSection] = useState(null);
  const [editingSectionName, setEditingSectionName] = useState('');
  const [editingSectionArea, setEditingSectionArea] = useState(null);
  const [editingAreaValue, setEditingAreaValue] = useState('');
  const [editingDimensions, setEditingDimensions] = useState({ length: '', depth: '', height: '' });
  const [editingFixture, setEditingFixture] = useState(null);
  const [editingFixtureName, setEditingFixtureName] = useState('');
  const [editingRow, setEditingRow] = useState(null);
  const [lastRefresh, setLastRefresh] = useState(null);
  const [lastProductsRefresh, setLastProductsRefresh] = useState(null);
  const [lastSalesRefresh, setLastSalesRefresh] = useState(null);
  const [lastOrdersRefresh, setLastOrdersRefresh] = useState(null);
  const [orderAnalytics, setOrderAnalytics] = useState(null);
  const [productCorrelations, setProductCorrelations] = useState([]);
  const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(false); // Disabled by default to prevent errors
  const [showRefreshPrompt, setShowRefreshPrompt] = useState(false);
  const [expandedRows, setExpandedRows] = useState(new Set());
  const [collapsedSectionLayouts, setCollapsedSectionLayouts] = useState(new Set(['all'])); // Start with all collapsed
  const [collapsedRowsSections, setCollapsedRowsSections] = useState(new Set(['all'])); // Start with all collapsed
  const [collapsedUnknownProducts, setCollapsedUnknownProducts] = useState(new Set(['all'])); // Start with all collapsed
  const [collapsedSections, setCollapsedSections] = useState(new Set()); // Track which sections are collapsed
  const sectionRefs = useRef({}); // Refs for scrolling to sections
  const [heatMapType, setHeatMapType] = useState('profit'); // profit, velocity, deadStock, margin, stockHealth
  const [showHeatMapGuide, setShowHeatMapGuide] = useState(false);
  const [sidebarWidth, setSidebarWidth] = useState(500); // Default 500px - balanced width
  const [isResizingSidebar, setIsResizingSidebar] = useState(false);
  const [rightSidebarWidth, setRightSidebarWidth] = useState(500);
  const [isResizingRightSidebar, setIsResizingRightSidebar] = useState(false);
  
  // Refresh states
  const [isRefreshing, setIsRefreshing] = useState(false);
  
  // Forecasting filters
  const [forecastGroupBy, setForecastGroupBy] = useState('all'); // all, fixture, brand
  const [forecastSortBy, setForecastSortBy] = useState('stockoutRisk'); // stockoutRisk, velocity, daysUntilOut, reorderQty
  const [forecastFilterFixture, setForecastFilterFixture] = useState('all'); // specific fixture filter
  const [forecastFilterBrand, setForecastFilterBrand] = useState('all'); // specific brand filter
  const [forecastFilterDistributor, setForecastFilterDistributor] = useState('all'); // specific distributor filter
  
  // Row Analytics filters
  const [rowFilterFixture, setRowFilterFixture] = useState('all');
  const [rowFilterBrand, setRowFilterBrand] = useState('all');
  const [rowFilterDistributor, setRowFilterDistributor] = useState('all');
  const [rowSortBy, setRowSortBy] = useState('profit'); // profit, sales, products, stock
  
  // Navigation
  const [currentPage, setCurrentPage] = useState('planner'); // planner, dashboard, forecasting, rowAnalytics, settings
  const [searchUPC, setSearchUPC] = useState(''); // For Find Product page
  const [searchResults, setSearchResults] = useState(null); // Store search results
  
  // Firebase states
  const [firebaseConfig, setFirebaseConfig] = useState({
    apiKey: 'AIzaSyBZ6qLt8KVgV877K6IBy0pwZ5a9y1FqGLY',
    authDomain: 'storeplannerpro.firebaseapp.com',
    databaseURL: 'https://storeplannerpro-default-rtdb.firebaseio.com',
    projectId: 'storeplannerpro',
    storageBucket: 'storeplannerpro.firebasestorage.app',
    messagingSenderId: '339443807903',
    appId: '1:339443807903:web:f24e76cc784f7177b494aa'
  });
  const [firebaseInitialized, setFirebaseInitialized] = useState(false);
  const [cloudSyncEnabled, setCloudSyncEnabled] = useState(true);
  const initialLoadComplete = useRef(false);
  const sectionsRef = useRef([]);
  const fixturesRef = useRef([]);
  const unknownProductsRef = useRef([]);
  const badStockProductsRef = useRef([]);
  const [syncStatus, setSyncStatus] = useState('');
  const [showFirebaseSettings, setShowFirebaseSettings] = useState(false);
  
  const fileInputRef = useRef(null);
  const importInputRef = useRef(null);
  const firebaseRef = useRef(null);
  const dbRef = useRef(null);
  const upcInputRef = useRef(null); // Ref for UPC scanning input
  const [zoom, setZoom] = useState(1);
  const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
  const [mouseDownPos, setMouseDownPos] = useState(null); // Track if this is a click or drag
  const canvasRef = useRef(null);
  
  // Auto-pan to selected section (snap to left of sidebar)
  useEffect(() => {
    if (selectedSection && canvasRef.current) {
      const section = sections.find(s => s.id === selectedSection);
      if (section) {
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const sidebarWidth = 500; // Actual width of the right sidebar
        const targetX = (canvasRect.width - sidebarWidth) / 4; // Position section on left quarter of visible area
        
        // Calculate the pan offset needed to center the section at targetX
        const sectionCenterX = section.x + section.width / 2;
        const newPanX = (targetX - sectionCenterX * zoom) / zoom * zoom;
        const newPanY = panOffset.y; // Keep Y position unchanged
        
        setPanOffset({ x: newPanX, y: newPanY });
      }
    }
  }, [selectedSection, zoom]);
  
  const BACKEND_URL = 'https://planogram-backend-gx85.onrender.com';
  
  const productDatabase = {
    '123456789012': { name: 'Premium Coffee Beans', price: 24.99, cost: 12.50, monthlySales: 145 },
    '234567890123': { name: 'Organic Tea Set', price: 18.99, cost: 9.00, monthlySales: 89 },
    '345678901234': { name: 'Artisan Chocolate', price: 12.99, cost: 6.50, monthlySales: 234 },
    '456789012345': { name: 'Gourmet Cookies', price: 8.99, cost: 4.00, monthlySales: 312 },
    '567890123456': { name: 'Specialty Honey', price: 15.99, cost: 7.50, monthlySales: 67 },
  };

  useEffect(() => {
    try {
      const savedSections = localStorage.getItem('planogram_sections');
      const savedFixtures = localStorage.getItem('planogram_fixtures');
      const savedBg = localStorage.getItem('planogram_background');
      const savedBgPos = localStorage.getItem('planogram_bg_position');
      const savedShopify = localStorage.getItem('planogram_shopify');
      const savedLastRefresh = localStorage.getItem('planogram_last_refresh');
      const savedLastProducts = localStorage.getItem('planogram_last_products_refresh');
      const savedLastSales = localStorage.getItem('planogram_last_sales_refresh');
      const savedLastOrders = localStorage.getItem('planogram_last_orders_refresh');
      const savedUnknownProducts = localStorage.getItem('planogram_unknown_products');
      
      if (savedSections) {
        const parsed = JSON.parse(savedSections);
        setSections(Array.isArray(parsed) ? parsed : []);
      }
      if (savedFixtures) {
        const parsed = JSON.parse(savedFixtures);
        setFixtures(Array.isArray(parsed) ? parsed : []);
      }
      if (savedBg) setBackgroundImage(savedBg);
      if (savedBgPos) setBgImagePosition(JSON.parse(savedBgPos));
      if (savedUnknownProducts) {
        const parsed = JSON.parse(savedUnknownProducts);
        setUnknownProducts(Array.isArray(parsed) ? parsed : []);
      }
      if (savedShopify) {
        const config = JSON.parse(savedShopify);
        setShopifyConfig(config);
      }
      if (savedLastRefresh) {
        setLastRefresh(new Date(savedLastRefresh));
      }
      if (savedLastProducts) {
        setLastProductsRefresh(new Date(savedLastProducts));
      }
      if (savedLastSales) {
        setLastSalesRefresh(new Date(savedLastSales));
      }
      if (savedLastOrders) {
        setLastOrdersRefresh(new Date(savedLastOrders));
      }
      
      const savedAnalytics = localStorage.getItem('planogram_order_analytics');
      if (savedAnalytics) {
        setOrderAnalytics(JSON.parse(savedAnalytics));
      }
      
      // Mark initial load as complete after a brief delay
      setTimeout(() => {
        initialLoadComplete.current = true;
        console.log('✅ Initial load complete - auto-save enabled');
      }, 1000);
    } catch (error) {
      console.error('Error loading saved data:', error);
      initialLoadComplete.current = true; // Enable auto-save even if there's an error
    }
  }, []);

  // Keep refs in sync with state for Firebase saves
  useEffect(() => {
    sectionsRef.current = sections;
  }, [sections]);

  useEffect(() => {
    fixturesRef.current = fixtures;
  }, [fixtures]);

  useEffect(() => {
    unknownProductsRef.current = unknownProducts;
  }, [unknownProducts]);

  useEffect(() => {
    badStockProductsRef.current = badStockProducts;
  }, [badStockProducts]);

  // Load correlations when connected to Shopify
  useEffect(() => {
    if (shopifyConfig.connected) {
      fetchCorrelations();
    }
  }, [shopifyConfig.connected]);

  // Auto-refresh every 5 minutes
  useEffect(() => {
    if (!autoRefreshEnabled || !shopifyConfig.connected) return;

    const interval = setInterval(() => {
      console.log('🔄 Auto-refreshing product data...');
      refreshProductCache(true);
    }, 5 * 60 * 1000); // 5 minutes

    return () => clearInterval(interval);
  }, [autoRefreshEnabled, shopifyConfig.connected]);

  const autoSave = (updatedSections, updatedFixtures = null, message = 'Auto-saved') => {
    try {
      localStorage.setItem('planogram_sections', JSON.stringify(updatedSections));
      localStorage.setItem('planogram_last_save', new Date().toISOString());
      
      // Also save fixtures if provided
      if (updatedFixtures) {
        localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
      }
      
      console.log(`✅ ${message}`);
      
      // Also save to Firebase if enabled
      if (cloudSyncEnabled && dbRef.current) {
        saveToFirebase(updatedSections, updatedFixtures || fixtures, unknownProducts, badStockProducts);
      }
    } catch (error) {
      console.error('❌ Auto-save failed:', error);
    }
  };

  // Firebase Functions
  const initializeFirebase = () => {
    try {
      const config = {
        apiKey: firebaseConfig.apiKey,
        authDomain: firebaseConfig.authDomain,
        databaseURL: firebaseConfig.databaseURL,
        projectId: firebaseConfig.projectId,
        storageBucket: firebaseConfig.storageBucket,
        messagingSenderId: firebaseConfig.messagingSenderId,
        appId: firebaseConfig.appId
      };

      if (!firebase.apps.length) {
        firebaseRef.current = firebase.initializeApp(config);
      } else {
        firebaseRef.current = firebase.app();
      }
      
      // Use Realtime Database instead of Firestore
      dbRef.current = firebase.database();
      setFirebaseInitialized(true);
      setSyncStatus('✅ Firebase connected');
      setTimeout(() => setSyncStatus(''), 3000);
      
      // Save config to localStorage
      localStorage.setItem('planogram_firebase_config', JSON.stringify(firebaseConfig));
      
      console.log('🔥 Firebase initialized with Realtime Database');
      
      return true;
    } catch (error) {
      console.error('Firebase initialization error:', error);
      setSyncStatus(`❌ ${error.message}`);
      setTimeout(() => setSyncStatus(''), 5000);
      return false;
    }
  };

  const saveToFirebase = async (sectionsData, fixturesData = null, unknownData = null, badStockData = null) => {
    if (!dbRef.current || !cloudSyncEnabled) return;

    try {
      const layoutData = {
        storeName,
        fixtures: fixturesData || fixtures,
        sections: sectionsData,
        unknownProducts: unknownData || unknownProducts,
        badStockProducts: badStockData || badStockProducts,
        backgroundImage: backgroundImage ? 'stored_separately' : null,
        bgImagePosition,
        lastUpdated: Date.now(),
        version: 3
      };

      // Use Realtime Database API: ref().set()
      await dbRef.current.ref('planograms/default').set(layoutData);
      console.log('☁️ Saved to Firebase Realtime Database');
    } catch (error) {
      console.error('Firebase save error:', error);
    }
  };

  const loadFromFirebase = async () => {
    if (!dbRef.current) return;

    try {
      setSyncStatus('🔄 Loading from cloud...');
      
      // Use Realtime Database API: ref().once()
      const snapshot = await dbRef.current.ref('planograms/default').once('value');
      
      if (snapshot.exists()) {
        const data = snapshot.val();
        if (data.storeName) setStoreName(data.storeName);
        if (data.fixtures) {
          setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
          localStorage.setItem('planogram_fixtures', JSON.stringify(Array.isArray(data.fixtures) ? data.fixtures : []));
        }
        if (data.sections) {
          setSections(Array.isArray(data.sections) ? data.sections : []);
          localStorage.setItem('planogram_sections', JSON.stringify(Array.isArray(data.sections) ? data.sections : []));
        }
        if (data.unknownProducts) {
          setUnknownProducts(data.unknownProducts);
        }
        if (data.badStockProducts) {
          setBadStockProducts(data.badStockProducts);
        }
        if (data.bgImagePosition) {
          setBgImagePosition(data.bgImagePosition);
          localStorage.setItem('planogram_bg_position', JSON.stringify(data.bgImagePosition));
        }
        
        setSyncStatus('✅ Loaded from cloud');
        setFeedback('✅ Cloud data loaded!');
        setTimeout(() => {
          setSyncStatus('');
          setFeedback('');
        }, 3000);
      } else {
        setSyncStatus('⚠️ No cloud data found');
        setTimeout(() => setSyncStatus(''), 3000);
      }
    } catch (error) {
      console.error('Firebase load error:', error);
      setSyncStatus(`❌ Load failed: ${error.message}`);
      setTimeout(() => setSyncStatus(''), 5000);
    }
  };

  const exportLayout = () => {
    const layoutData = {
      version: 3,
      storeName,
      fixtures,
      sections,
      backgroundImage,
      bgImagePosition,
      shopifyConfig: {
        storeName: shopifyConfig.storeName,
        connected: shopifyConfig.connected
      },
      exportDate: new Date().toISOString()
    };

    const dataStr = JSON.stringify(layoutData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `planogram-${storeName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    
    setFeedback('✅ Layout exported!');
    setTimeout(() => setFeedback(''), 3000);
  };

  const importLayout = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const layoutData = JSON.parse(e.target.result);
        
        if (layoutData.version !== 3) {
          setFeedback('⚠️ Old version file.');
        }
        
        if (layoutData.storeName) setStoreName(layoutData.storeName);
        if (layoutData.fixtures) {
          setFixtures(layoutData.fixtures);
          localStorage.setItem('planogram_fixtures', JSON.stringify(layoutData.fixtures));
        }
        if (layoutData.sections) {
          setSections(layoutData.sections);
          localStorage.setItem('planogram_sections', JSON.stringify(layoutData.sections));
        }
        if (layoutData.backgroundImage) {
          setBackgroundImage(layoutData.backgroundImage);
          localStorage.setItem('planogram_background', layoutData.backgroundImage);
        }
        if (layoutData.bgImagePosition) {
          setBgImagePosition(layoutData.bgImagePosition);
          localStorage.setItem('planogram_bg_position', JSON.stringify(layoutData.bgImagePosition));
        }
        
        setFeedback('✅ Layout imported!');
        setTimeout(() => setFeedback(''), 3000);
        
      } catch (error) {
        console.error('Import error:', error);
        setFeedback('❌ Failed to import. Invalid file.');
        setTimeout(() => setFeedback(''), 5000);
      }
    };
    
    reader.readAsText(file);
    event.target.value = '';
  };

  const handleBgMouseDown = (e) => {
    if (e.target.tagName !== 'IMG') return;
    setIsDraggingBg(true);
    setBgDragStart({
      x: e.clientX - bgImagePosition.x,
      y: e.clientY - bgImagePosition.y
    });
    e.preventDefault();
    e.stopPropagation();
  };

  const handleBgMouseMove = (e) => {
    if (!isDraggingBg) return;
    setBgImagePosition({
      x: e.clientX - bgDragStart.x,
      y: e.clientY - bgDragStart.y
    });
  };

  const handleBgMouseUp = () => {
    if (isDraggingBg) {
      setIsDraggingBg(false);
      try {
        localStorage.setItem('planogram_bg_position', JSON.stringify(bgImagePosition));
      } catch (error) {
        console.error('Failed to save background position:', error);
      }
    }
  };

  const resetBackgroundPosition = () => {
    const resetPos = { x: 0, y: 0 };
    setBgImagePosition(resetPos);
    localStorage.setItem('planogram_bg_position', JSON.stringify(resetPos));
    setFeedback('✅ Background reset');
    setTimeout(() => setFeedback(''), 2000);
  };

  // Canvas pan and zoom
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({ x: 0, y: 0 });

  const handleCanvasWheel = (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    setZoom(prev => Math.max(0.1, Math.min(3, prev * delta)));
  };

  const handleCanvasMouseDown = (e) => {
    // Track where the mouse went down
    setMouseDownPos({ x: e.clientX, y: e.clientY });
    
    // Pan with middle mouse button (button 1) or spacebar + left click
    if (e.button === 1 || (e.button === 0 && e.shiftKey)) {
      e.preventDefault();
      setIsPanning(true);
      setPanStart({ 
        x: e.clientX - panOffset.x, 
        y: e.clientY - panOffset.y 
      });
    }
    // Also allow panning on empty canvas
    else if (e.target === e.currentTarget || e.target.classList.contains('bg-gray-50')) {
      setIsPanning(true);
      setPanStart({ 
        x: e.clientX - panOffset.x, 
        y: e.clientY - panOffset.y 
      });
    }
  };

  const handleCanvasMouseMove = (e) => {
    if (isPanning) {
      setPanOffset({
        x: e.clientX - panStart.x,
        y: e.clientY - panStart.y
      });
    }
  };

  const handleCanvasMouseUp = (e) => {
    setIsPanning(false);
    
    // If we didn't move much (less than 5 pixels), treat it as a click and deselect
    if (mouseDownPos) {
      const dx = Math.abs(e.clientX - mouseDownPos.x);
      const dy = Math.abs(e.clientY - mouseDownPos.y);
      
      if (dx < 5 && dy < 5) {
        // This was a click, not a drag - deselect if not clicking on a fixture
        const clickedElement = document.elementFromPoint(e.clientX, e.clientY);
        const isFixture = clickedElement?.closest('[data-fixture-id]');
        
        if (!isFixture) {
          setSelectedSection(null);
          setSelectedProduct(null);
        }
      }
      
      setMouseDownPos(null);
    }
  };

  const testShopifyConnection = async () => {
    if (!shopifyConfig.storeName || !shopifyConfig.accessToken) {
      setFeedback('⚠️ Enter store name and token');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('🔄 Testing...');

    try {
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'connect'
        })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        const updatedConfig = { ...shopifyConfig, connected: true };
        setShopifyConfig(updatedConfig);
        localStorage.setItem('planogram_shopify', JSON.stringify(updatedConfig));
        setFeedback(`✅ Connected!`);
        setTimeout(() => {
          setFeedback('');
          setShowSettings(false);
        }, 2000);
      } else {
        setFeedback(`❌ ${data.error || 'Failed'}`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } catch (error) {
      console.error('Connection error:', error);
      setFeedback('❌ Connection error');
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  const disconnectShopify = () => {
    const updatedConfig = {
      storeName: shopifyConfig.storeName,
      accessToken: '',
      connected: false
    };
    setShopifyConfig(updatedConfig);
    localStorage.setItem('planogram_shopify', JSON.stringify(updatedConfig));
    setFeedback('✅ Disconnected');
    setTimeout(() => setFeedback(''), 2000);
  };

  const refreshProductCache = async (isAutoRefresh = false) => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      if (!isAutoRefresh) {
        setFeedback('⚠️ Connect to Shopify first');
        setTimeout(() => setFeedback(''), 3000);
      }
      return;
    }

    if (!isAutoRefresh) {
      setIsRefreshing(true);
      setFeedback('🔄 Starting refresh... This may take several minutes for large catalogs.');
    }
    
    try {
      // Use backend proxy to avoid CORS issues
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshProducts'
        })
      });

      if (!response.ok) {
        throw new Error(`Backend returned ${response.status}`);
      }

      const data = await response.json();

      if (data.success) {
        const now = new Date();
        setLastRefresh(now);
        setLastProductsRefresh(now);
        localStorage.setItem('planogram_last_refresh', now.toISOString());
        localStorage.setItem('planogram_last_products_refresh', now.toISOString());
        
        if (!isAutoRefresh) {
          setFeedback(`✅ ${data.message || 'Products refreshed from Shopify'}`);
          setTimeout(() => setFeedback(''), 5000);
        } else {
          console.log('✅ Auto-refresh completed at', now.toLocaleTimeString());
        }
      } else {
        if (!isAutoRefresh) {
          setFeedback(`❌ ${data.error || 'Refresh failed'}`);
          setTimeout(() => setFeedback(''), 5000);
        }
      }
    } catch (error) {
      if (!isAutoRefresh) {
        setFeedback(`❌ Cache refresh failed: ${error.message}. Check Shopify connection.`);
        setTimeout(() => setFeedback(''), 5000);
      }
      console.error('Refresh error:', error);
    } finally {
      if (!isAutoRefresh) {
        setIsRefreshing(false);
      }
    }
  };

  const refreshAllProductData = async () => {
    if (!shopifyConfig.connected) {
      setFeedback('⚠️ Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setIsRefreshing(true);
    setFeedback('🔄 Refreshing all product data... Please wait.');

    try {
      // Gather all unique UPCs from all sections
      const allUPCs = new Set();
      sections.forEach(section => {
        const products = section.rows ? 
          section.rows.flatMap(row => row.products || []) : 
          (section.products || []);
        products.forEach(p => {
          if (p.upc) allUPCs.add(p.upc);
        });
      });

      const upcArray = Array.from(allUPCs);
      console.log(`🔍 Found ${upcArray.length} unique products to refresh`);
      setFeedback(`🔄 Refreshing ${upcArray.length} products...`);

      // Fetch fresh data for each UPC
      const freshProductData = {};
      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < upcArray.length; i++) {
        const upc = upcArray[i];
        try {
          const url = new URL(`${BACKEND_URL}/api/product/${upc}`);
          url.searchParams.append('storeName', shopifyConfig.storeName);
          url.searchParams.append('accessToken', shopifyConfig.accessToken);
          url.searchParams.append('fetchMetafields', 'true');
          
          const response = await fetch(url);
          if (response.ok) {
            const data = await response.json();
            console.log('Product data received:', { 
              name: data.title, 
              vendor: data.vendor, 
              distributor: data.distributor 
            });
            freshProductData[upc] = {
              name: data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title,
              price: data.price,
              compareAtPrice: data.compareAtPrice,
              cost: data.cost,
              dailySales: data.dailySales || 0,
              weeklySales: data.weeklySales || 0,
              monthlySales: data.monthlySales || 0,
              quarterlySales: data.quarterlySales || 0,
              yearlySales: data.yearlySales || 0,
              allTimeSales: data.allTimeSales || 0,
              inventoryQuantity: data.inventoryQuantity || 0,
              sku: data.sku,
              vendor: data.vendor,
              distributor: data.distributor,
              tags: data.tags,
              createdAt: data.createdAt,
              analytics: data.analytics || {}
            };
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          console.error(`Failed to fetch ${upc}:`, error);
          errorCount++;
        }

        // Update feedback every 10 products
        if ((i + 1) % 10 === 0) {
          setFeedback(`🔄 Progress: ${i + 1}/${upcArray.length} products...`);
        }
      }

      console.log(`✅ Fetched fresh data for ${successCount} products (${errorCount} errors)`);
      setFeedback(`🔄 Updating products in planogram...`);

      // Update all products in sections with fresh data
      const updatedSections = sections.map(section => {
        if (section.rows) {
          // Update products in rows
          const updatedRows = section.rows.map(row => ({
            ...row,
            products: (row.products || []).map(product => {
              if (product.upc && freshProductData[product.upc]) {
                return {
                  ...product,
                  ...freshProductData[product.upc],
                  source: 'database'
                };
              }
              return product;
            })
          }));
          return { ...section, rows: updatedRows };
        } else if (section.products) {
          // Update products directly in section
          const updatedProducts = section.products.map(product => {
            if (product.upc && freshProductData[product.upc]) {
              return {
                ...product,
                ...freshProductData[product.upc],
                source: 'database'
              };
            }
            return product;
          });
          return { ...section, products: updatedProducts };
        }
        return section;
      });

      setSections(updatedSections);
      autoSave(updatedSections, 'Refreshed all product data');
      
      setFeedback(`✅ Success! Updated ${successCount} products with fresh data (${errorCount} failed)`);
      setTimeout(() => setFeedback(''), 5000);

    } catch (error) {
      console.error('Error refreshing product data:', error);
      setFeedback('❌ Failed to refresh product data');
      setTimeout(() => setFeedback(''), 5000);
    } finally {
      setIsRefreshing(false);
    }
  };

  const refreshSalesOnly = async () => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      setFeedback('⚠️ Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('📊 Refreshing sales data...');
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshSales'
        })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        const now = new Date();
        setLastRefresh(now);
        setLastSalesRefresh(now);
        localStorage.setItem('planogram_last_refresh', now.toISOString());
        localStorage.setItem('planogram_last_sales_refresh', now.toISOString());
        setFeedback(`✅ ${data.message}`);
        setTimeout(() => setFeedback(''), 5000);
      } else {
        setFeedback(`❌ ${data.error || 'Failed'}`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } catch (error) {
      setFeedback('❌ Sales refresh failed');
      setTimeout(() => setFeedback(''), 5000);
      console.error('Sales refresh error:', error);
    }
  };

  // 🔥 BEAST MODE: Refresh order data
  const refreshOrders = async () => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      setFeedback('⚠️ Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('🔥 BEAST MODE: Importing orders... (this may take a minute)');
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshOrders'
        })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        const now = new Date();
        setLastOrdersRefresh(now);
        localStorage.setItem('planogram_last_orders_refresh', now.toISOString());
        
        // Check if processing in background
        if (data.processing) {
          setFeedback(`🔥 BEAST MODE: Processing 7,314 orders in background... (2-3 minutes)`);
          
          // Poll every 10 seconds to check if done
          const checkStatus = setInterval(async () => {
            try {
              const statusRes = await fetch(`${BACKEND_URL}/api/orders/status`);
              const statusData = await statusRes.json();
              
              if (!statusData.isProcessing && statusData.lastResult) {
                clearInterval(checkStatus);
                
                // Update with results
                if (statusData.lastResult.analytics) {
                  setOrderAnalytics(statusData.lastResult.analytics);
                  localStorage.setItem('planogram_order_analytics', JSON.stringify(statusData.lastResult.analytics));
                }
                
                setLastOrdersRefresh(new Date(statusData.lastCompleted));
                localStorage.setItem('planogram_last_orders_refresh', statusData.lastCompleted);
                
                // Fetch correlations after orders are processed
                fetchCorrelations();
                
                setFeedback(`✅ COMPLETE: ${statusData.lastResult.ordersProcessed} orders, ${statusData.lastResult.itemsProcessed} items analyzed!`);
                setTimeout(() => setFeedback(''), 8000);
              }
            } catch (err) {
              console.error('Status check failed:', err);
            }
          }, 10000); // Check every 10 seconds
          
          // Also set a timeout to stop polling after 5 minutes
          setTimeout(() => {
            clearInterval(checkStatus);
          }, 5 * 60 * 1000);
        } else {
          // Old response format (immediate completion)
          if (data.analytics) {
            setOrderAnalytics(data.analytics);
            localStorage.setItem('planogram_order_analytics', JSON.stringify(data.analytics));
          }
          
          // Fetch correlations after orders are processed
          fetchCorrelations();
          
          setFeedback(`✅ BEAST MODE: ${data.ordersProcessed} orders, ${data.itemsProcessed} items analyzed!`);
          setTimeout(() => setFeedback(''), 8000);
        }
      } else {
        setFeedback(`❌ ${data.error || 'Order import failed'}`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } catch (error) {
      setFeedback('❌ Order import failed');
      setTimeout(() => setFeedback(''), 5000);
      console.error('Order import error:', error);
    }
  };

  const fetchCorrelations = async () => {
    if (!shopifyConfig.connected) return;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/correlations`);
      if (response.ok) {
        const data = await response.json();
        setProductCorrelations(data.correlations || []);
        console.log(`✅ Loaded ${data.correlations?.length || 0} product correlations`);
      }
    } catch (error) {
      console.error('Failed to fetch correlations:', error);
    }
  };


  const addProductToSection = async () => {
    if (!newProduct.upc || !newProduct.sectionId || !newProduct.rowId) {
      setFeedback('⚠️ Enter UPC and select section & row');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setScanning(true);
    const sectionIndex = sections.findIndex(s => s.id === newProduct.sectionId);
    
    if (sectionIndex === -1) {
      setFeedback('⚠️ Section not found');
      setScanning(false);
      return;
    }

    let product = null;
    
    if (shopifyConfig.connected) {
      try {
        const url = new URL(`${BACKEND_URL}/api/product/${newProduct.upc}`);
        url.searchParams.append('storeName', shopifyConfig.storeName);
        url.searchParams.append('accessToken', shopifyConfig.accessToken);
        url.searchParams.append('fetchMetafields', 'true');
        
        const response = await fetch(url);
        const data = await response.json();

        if (response.ok && data.title) {
          // 🔥 Check for negative inventory - add to bad stock list BUT STILL add to row
          if (data.inventoryQuantity < 0) {
            // Add to BAD STOCK list (separate from unknown)
            const existingBadStock = badStockProducts.find(b => b.upc === newProduct.upc);
            if (!existingBadStock) {
              setBadStockProducts(prev => [...prev, {
                id: Date.now(),
                upc: newProduct.upc,
                note: `${data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title} (Stock: ${data.inventoryQuantity})`,
                addedAt: new Date().toISOString(),
                resolved: false,
                inventoryQuantity: data.inventoryQuantity,
                productData: data
              }]);
            }
          }
          
          // ALWAYS create product object regardless of stock level
          product = {
              upc: newProduct.upc,
              name: data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title,
              price: data.price,
              compareAtPrice: data.compareAtPrice,
              cost: data.cost,
              dailySales: data.dailySales || 0,
              weeklySales: data.weeklySales || 0,
              monthlySales: data.monthlySales || 0,
              quarterlySales: data.quarterlySales || 0,
              yearlySales: data.yearlySales || 0,
              allTimeSales: data.allTimeSales || 0,
              inventoryQuantity: data.inventoryQuantity,
              sku: data.sku,
              vendor: data.vendor,
              distributor: data.distributor,
              tags: data.tags,
              createdAt: data.createdAt,
              analytics: data.analytics || {
                timesPurchased: 0,
                averageOrderValue: 0,
                returningCustomerPurchases: 0,
                newCustomerPurchases: 0,
                averageCartPosition: 0,
                boughtTogether: []
              },
              quantity: 1,
              source: 'database',
              visualX: Math.random() * 80 + 10,
              visualY: Math.random() * 80 + 10
            };
            
            // Create feedback based on stock level
            if (data.inventoryQuantity < 0) {
              setFeedback(`⚠️ NEGATIVE STOCK (${data.inventoryQuantity}) - ${product.name} added to row AND Bad Stock list`);
            } else {
              const stockWarning = data.inventoryQuantity === 0 ? ' ⚠️ OUT OF STOCK' : 
                                  data.inventoryQuantity < 10 ? ' ⚠️ LOW STOCK' : '';
              const aovInfo = data.analytics?.averageOrderValue > 0 ? ` | AOV: $${data.analytics.averageOrderValue.toFixed(2)}` : '';
              setFeedback(`✅ Added: ${product.name} (${data.monthlySales || 0} sales, ${data.inventoryQuantity} stock)${stockWarning}${aovInfo}`);
            }
        }
      } catch (error) {
        console.error('Error fetching from database:', error);
      }
    }
    
    if (!product && productDatabase[newProduct.upc]) {
      product = { 
        upc: newProduct.upc, 
        ...productDatabase[newProduct.upc],
        quantity: 1,
        source: 'sample',
        visualX: Math.random() * 80 + 10,
        visualY: Math.random() * 80 + 10
      };
      setFeedback(`✅ Added: ${product.name} (Sample)`);
    }
    
    if (!product) {
      // Add to unknown products list
      const existingUnknown = unknownProducts.find(u => u.upc === newProduct.upc);
      if (!existingUnknown) {
        setUnknownProducts(prev => [...prev, {
          id: Date.now(),
          upc: newProduct.upc,
          note: '',
          addedAt: new Date().toISOString(),
          resolved: false
        }]);
      }
      
      product = {
        upc: newProduct.upc,
        name: `UPC: ${newProduct.upc}`,
        price: 0,
        cost: 0,
        monthlySales: 0,
        quantity: 1,
        source: 'placeholder',
        visualX: Math.random() * 80 + 10,
        visualY: Math.random() * 80 + 10
      };
      setFeedback('⚠️ Not found - added to Unknown Products list');
    }

    // Add product to the specified row
    const updatedSections = [...sections];
    const section = updatedSections[sectionIndex];
    const rowIndex = (section.rows || []).findIndex(r => r.id === newProduct.rowId);
    
    if (rowIndex >= 0) {
      section.rows[rowIndex].products.push(product);
    } else {
      // Fallback: add to section products if row not found
      if (!section.products) section.products = [];
      section.products.push(product);
    }
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding product');

    setScanning(false);
    
    console.log('🔍 Before clearing - UPC:', newProduct.upc, 'Sticky mode:', stickyRowMode);
    
    // 🔥 STICKY ROW MODE: Keep section and row selected, only clear UPC
    if (stickyRowMode) {
      setNewProduct({ 
        upc: '', 
        sectionId: newProduct.sectionId, 
        rowId: newProduct.rowId 
      });
      // Refocus the UPC input for rapid scanning
      setTimeout(() => {
        console.log('🔍 After clearing - UPC should be empty, refocusing input');
        if (upcInputRef.current) {
          upcInputRef.current.focus();
          upcInputRef.current.value = ''; // Force clear the input value
        }
      }, 100);
    } else {
      setNewProduct({ upc: '', sectionId: '', rowId: '' });
    }
    
    setTimeout(() => setFeedback(''), 3000);
  };

  const updateProductQuantity = (sectionId, productIndex, delta) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedProducts = [...section.products];
        updatedProducts[productIndex] = {
          ...updatedProducts[productIndex],
          quantity: Math.max(0, updatedProducts[productIndex].quantity + delta)
        };
        return { ...section, products: updatedProducts };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after quantity update');
  };

  const updateProductPosition = (sectionId, productIndex, newX, newY) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedProducts = [...section.products];
        updatedProducts[productIndex] = {
          ...updatedProducts[productIndex],
          visualX: newX,
          visualY: newY
        };
        return { ...section, products: updatedProducts };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved product position');
  };

  const deleteProduct = (sectionId, productIndex) => {
    if (!confirm('Delete this product?')) return;

    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedProducts = section.products.filter((_, idx) => idx !== productIndex);
        return { ...section, products: updatedProducts };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after deleting product');
    
    setFeedback('✅ Product deleted');
    setTimeout(() => setFeedback(''), 2000);
  };

  const addFixture = (type) => {
    const fixtureType = FIXTURE_TYPES[type];
    const newFixture = {
      id: `fixture-${Date.now()}`,
      type: fixtureType.id,
      name: fixtureType.name,
      x: 100,
      y: 100,
      width: fixtureType.defaultWidth,
      height: fixtureType.defaultHeight,
      color: fixtureType.color,
      sections: []
    };
    
    const updatedFixtures = [...fixtures, newFixture];
    setFixtures(updatedFixtures);
    localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
    setSelectedFixture(newFixture.id);
    autoSave(sections, updatedFixtures, 'Auto-saved after adding fixture');
  };

  const deleteFixture = (fixtureId) => {
    if (!confirm('Delete fixture and all sections?')) return;
    
    const updatedFixtures = fixtures.filter(f => f.id !== fixtureId);
    setFixtures(updatedFixtures);
    localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
    
    const updatedSections = sections.filter(s => s.fixtureId !== fixtureId);
    setSections(updatedSections);
    autoSave(updatedSections, updatedFixtures, 'Auto-saved after deleting fixture');
    
    if (selectedFixture === fixtureId) {
      setSelectedFixture(null);
    }
  };

  const updateFixture = (updatedFixture) => {
    const updatedFixtures = (fixtures || []).map(f => 
      f.id === updatedFixture.id ? updatedFixture : f
    );
    setFixtures(updatedFixtures);
    localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
    autoSave(sections, updatedFixtures, 'Auto-saved after updating fixture');
  };

  const addSection = (fixtureId) => {
    const fixture = fixtures.find(f => f.id === fixtureId);
    if (!fixture) return;

    const existingSections = sections.filter(s => s.fixtureId === fixtureId);

    // Smart default positioning - try to fit new section without overlap
    const numExisting = existingSections.length;
    let defaultX = 0;
    let defaultY = 0;
    let defaultWidth = 100;
    let defaultHeight = 100;

    if (numExisting > 0) {
      // Place new sections in rows
      const sectionsPerRow = 2;
      const row = Math.floor(numExisting / sectionsPerRow);
      const col = numExisting % sectionsPerRow;
      
      defaultWidth = 50;
      defaultHeight = 50;
      defaultX = col * 50;
      defaultY = row * 50;
    }

    const newSection = {
      id: `section-${Date.now()}`,
      fixtureId: fixtureId,
      name: `Section ${existingSections.length + 1}`,
      products: [],
      area: 10,
      length: 48, // default 48 inches
      depth: 30, // default 30 inches
      height: 72, // default 72 inches
      // Position and size within fixture (percentage-based 0-100)
      layoutX: defaultX,
      layoutY: defaultY,
      layoutWidth: defaultWidth,
      layoutHeight: defaultHeight,
      // NEW: Rows for height tracking
      rows: [
        { id: `row-${Date.now()}-1`, name: 'Top', products: [] },
        { id: `row-${Date.now()}-2`, name: 'Middle', products: [] },
        { id: `row-${Date.now()}-3`, name: 'Bottom', products: [] }
      ]
    };

    const updatedSections = [...sections, newSection];
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding section');
  };

  const deleteSection = (sectionId) => {
    if (!confirm('Delete section and all products?')) return;
    
    const updatedSections = sections.filter(s => s.id !== sectionId);
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after deleting section');
    
    if (selectedSection === sectionId) {
      setSelectedSection(null);
    }
  };

  const updateSectionName = (sectionId, newName) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return { ...section, name: newName };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after renaming section');
    setEditingSection(null);
    setFeedback('✅ Section renamed');
    setTimeout(() => setFeedback(''), 2000);
  };

  const updateSectionArea = (sectionId, newArea) => {
    const area = parseFloat(newArea);
    if (isNaN(area) || area <= 0) {
      setFeedback('⚠️ Area must be a positive number');
      setTimeout(() => setFeedback(''), 2000);
      return;
    }

    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return { ...section, area };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after updating area');
    setEditingSectionArea(null);
    setFeedback('✅ Area updated');
    setTimeout(() => setFeedback(''), 2000);
  };

  const updateSection = (updatedSection) => {
    const updatedSections = sections.map(s => 
      s.id === updatedSection.id ? updatedSection : s
    );
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved section layout');
  };

  const updateFixtureName = (fixtureId, newName) => {
    const updatedFixtures = (fixtures || []).map(fixture => {
      if (fixture.id === fixtureId) {
        return { ...fixture, name: newName };
      }
      return fixture;
    });
    
    setFixtures(updatedFixtures);
    setEditingFixture(null);
    setFeedback('✅ Fixture renamed');
    setTimeout(() => setFeedback(''), 2000);
  };

  // NEW: Row management functions
  const addRowToSection = (sectionId) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const rows = section.rows || [];
        const newRow = {
          id: `row-${Date.now()}`,
          name: `Row ${rows.length + 1}`,
          products: []
        };
        return {
          ...section,
          rows: [...rows, newRow]
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding row');
    setFeedback('✅ Row added');
    setTimeout(() => setFeedback(''), 2000);
  };

  const deleteRow = (sectionId, rowId) => {
    if (!confirm('Delete row and all products in it?')) return;
    
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          rows: (section.rows || []).filter(r => r.id !== rowId)
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after deleting row');
    setFeedback('✅ Row deleted');
    setTimeout(() => setFeedback(''), 2000);
  };

  const updateRowName = (sectionId, rowId, newName) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          rows: (section.rows || []).map(row => 
            row.id === rowId ? { ...row, name: newName } : row
          )
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after renaming row');
  };

  const handleBackgroundUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const imageData = event.target.result;
        setBackgroundImage(imageData);
        localStorage.setItem('planogram_background', imageData);
        setFeedback('✅ Background uploaded');
        setTimeout(() => setFeedback(''), 2000);
      };
      reader.readAsDataURL(file);
    }
  };

  const removeBackground = () => {
    setBackgroundImage(null);
    setBgImagePosition({ x: 0, y: 0 });
    localStorage.removeItem('planogram_background');
    localStorage.removeItem('planogram_bg_position');
    setFeedback('✅ Background removed');
    setTimeout(() => setFeedback(''), 2000);
  };

  const calculateMetrics = (section, timePeriodFilter) => {
    const area = section.area || 1;

    // Gather all products from all rows
    const allProducts = section.rows ? 
      section.rows.flatMap(row => row.products || []) : 
      (section.products || []);

    const productMetrics = allProducts.map(p => {
      // Use the appropriate sales field based on time period
      let salesVolume = 0;
      switch(timePeriodFilter) {
        case 'day':
          salesVolume = p.dailySales || 0;
          break;
        case 'week':
          salesVolume = p.weeklySales || 0;
          break;
        case 'month':
          salesVolume = p.monthlySales || 0;
          break;
        case 'quarter':
          salesVolume = p.quarterlySales || 0;
          break;
        case 'year':
          salesVolume = p.yearlySales || 0;
          break;
        case 'all':
          salesVolume = p.allTimeSales || 0;
          break;
        case 'custom':
          // Calculate days in custom range and estimate proportionally
          if (customStartDate && customEndDate) {
            const start = new Date(customStartDate);
            const end = new Date(customEndDate);
            const daysInRange = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const daysInMonth = 30;
            // Estimate based on monthly sales proportionally
            salesVolume = (p.monthlySales || 0) * (daysInRange / daysInMonth);
          } else {
            salesVolume = p.monthlySales || 0;
          }
          break;
        default:
          salesVolume = p.monthlySales || 0;
      }

      const periodRevenue = p.price * salesVolume;
      const periodProfit = (p.cost !== null && p.cost !== undefined) 
        ? (p.price - p.cost) * salesVolume 
        : 0; // If no cost, profit is 0 (unknown)
      const velocity = salesVolume / area;

      return { ...p, periodVolume: salesVolume, periodRevenue, periodProfit, velocity };
    });

    productMetrics.sort((a, b) => {
      switch(sortBy) {
        case 'profit': return b.periodProfit - a.periodProfit;
        case 'revenue': return b.periodRevenue - a.periodRevenue;
        case 'velocity': return b.velocity - a.velocity;
        case 'volume': return b.periodVolume - a.periodVolume;
        case 'name': return a.name.localeCompare(b.name);
        default: return 0;
      }
    });
    
    const totalRevenue = productMetrics.reduce((sum, p) => sum + p.periodRevenue, 0);
    const totalCost = productMetrics.reduce((sum, p) => sum + ((p.cost !== null ? p.cost : 0) * p.periodVolume), 0);
    const totalProfit = productMetrics.reduce((sum, p) => sum + p.periodProfit, 0);
    const totalVolume = productMetrics.reduce((sum, p) => sum + p.periodVolume, 0);
    const totalVelocity = productMetrics.reduce((sum, p) => sum + p.velocity, 0);
    const profitPerSqFt = area > 0 ? totalProfit / area : 0;

    return { area, totalRevenue, totalCost, totalProfit, profitPerSqFt, totalVolume, totalVelocity, productMetrics };
  };

  const getHeatMapColor = (metrics) => {
    // Smooth gradient helper - creates continuous color transitions
    const getGradientColor = (intensity) => {
      // Clamp intensity between 0 and 1
      intensity = Math.max(0, Math.min(1, intensity));
      
      // Create smooth gradient from red (0) -> orange -> yellow -> green (1)
      if (intensity < 0.25) {
        // Red to Orange (0-25%)
        const t = intensity / 0.25;
        const r = 239;
        const g = Math.floor(68 + (115 - 68) * t);
        const b = 68;
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      } else if (intensity < 0.5) {
        // Orange to Yellow (25-50%)
        const t = (intensity - 0.25) / 0.25;
        const r = Math.floor(249 - (249 - 234) * t);
        const g = Math.floor(115 + (179 - 115) * t);
        const b = Math.floor(22 - 14 * t);
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      } else if (intensity < 0.75) {
        // Yellow to Light Green (50-75%)
        const t = (intensity - 0.5) / 0.25;
        const r = Math.floor(234 - (234 - 134) * t);
        const g = Math.floor(179 + (197 - 179) * t);
        const b = Math.floor(8 + (86 * t));
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      } else {
        // Light Green to Dark Green (75-100%)
        const t = (intensity - 0.75) / 0.25;
        const r = Math.floor(134 - (134 - 34) * t);
        const g = 197;
        const b = Math.floor(94 - (94 - 94) * t);
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      }
    };
    
    // Calculate different metrics for different heat map types
    const allMetrics = sections.map(s => calculateMetrics(s, timePeriod));
    
    switch(heatMapType) {
      case 'profit': {
        const maxProfit = Math.max(...allMetrics.map(m => m.profitPerSqFt), 0.01);
        const intensity = maxProfit > 0 ? metrics.profitPerSqFt / maxProfit : 0;
        return getGradientColor(intensity);
      }
      
      case 'velocity': {
        const maxVelocity = Math.max(...allMetrics.map(m => m.totalVelocity), 0.01);
        const intensity = maxVelocity > 0 ? metrics.totalVelocity / maxVelocity : 0;
        return getGradientColor(intensity);
      }
      
      case 'deadStock': {
        // Count dead stock items (inventory > 0 but sales = 0)
        const deadStockValue = metrics.productMetrics
          .filter(p => (p.inventoryQuantity || 0) > 0 && p.periodVolume === 0)
          .reduce((sum, p) => sum + (p.inventoryQuantity || 0) * p.cost, 0);
        
        const maxDeadStock = Math.max(...allMetrics.map(m => 
          m.productMetrics
            .filter(p => (p.inventoryQuantity || 0) > 0 && p.periodVolume === 0)
            .reduce((sum, p) => sum + (p.inventoryQuantity || 0) * p.cost, 0)
        ), 1);
        
        // Invert for dead stock (more dead stock = worse = red)
        const intensity = 1 - (deadStockValue / maxDeadStock);
        return getGradientColor(intensity);
      }
      
      case 'margin': {
        // Average profit margin %
        const avgMargin = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            const margin = p.price > 0 ? ((p.price - p.cost) / p.price) : 0;
            return sum + margin;
          }, 0) / metrics.productMetrics.length : 0;
        
        // Scale margin to 0-1 (assume max 70% margin is best)
        const intensity = Math.min(avgMargin / 0.7, 1);
        return getGradientColor(intensity);
      }
      
      case 'stockHealth': {
        // Combine multiple factors: out of stock, low stock, dead stock
        const products = metrics.productMetrics;
        const outOfStock = products.filter(p => (p.inventoryQuantity || 0) === 0 && p.periodVolume > 0).length;
        const lowStock = products.filter(p => {
          const stock = p.inventoryQuantity || 0;
          const daysRemaining = p.periodVolume > 0 ? stock / (p.periodVolume / 30) : Infinity;
          return stock > 0 && daysRemaining < 7;
        }).length;
        const deadStock = products.filter(p => 
          (p.inventoryQuantity || 0) > 0 && p.periodVolume === 0
        ).length;
        
        const problemScore = outOfStock * 3 + lowStock * 2 + deadStock;
        const maxProblemScore = Math.max(...allMetrics.map(m => {
          const p = m.productMetrics;
          const os = p.filter(pr => (pr.inventoryQuantity || 0) === 0 && pr.periodVolume > 0).length;
          const ls = p.filter(pr => {
            const stock = pr.inventoryQuantity || 0;
            const daysRemaining = pr.periodVolume > 0 ? stock / (pr.periodVolume / 30) : Infinity;
            return stock > 0 && daysRemaining < 7;
          }).length;
          const ds = p.filter(pr => (pr.inventoryQuantity || 0) > 0 && pr.periodVolume === 0).length;
          return os * 3 + ls * 2 + ds;
        }), 1);
        
        // Invert (lower problem score = better = green)
        const intensity = 1 - (problemScore / maxProblemScore);
        return getGradientColor(intensity);
      }
      
      case 'aov': {
        // 🔥 BEAST MODE: Average Order Value heat map
        const avgAOV = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            return sum + (p.analytics?.averageOrderValue || 0);
          }, 0) / metrics.productMetrics.filter(p => p.analytics?.averageOrderValue > 0).length : 0;
        
        const maxAOV = Math.max(...allMetrics.map(m => {
          const aov = m.productMetrics.length > 0 ?
            m.productMetrics.reduce((sum, p) => sum + (p.analytics?.averageOrderValue || 0), 0) / 
            m.productMetrics.filter(p => p.analytics?.averageOrderValue > 0).length : 0;
          return aov || 0;
        }), 1);
        
        const intensity = avgAOV / maxAOV;
        return getGradientColor(intensity);
      }
      
      case 'returningCustomers': {
        // 🔥 BEAST MODE: Returning customer preferences
        const returningCustomerRatio = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            const total = (p.analytics?.returningCustomerPurchases || 0) + (p.analytics?.newCustomerPurchases || 0);
            return sum + (total > 0 ? (p.analytics?.returningCustomerPurchases || 0) / total : 0);
          }, 0) / metrics.productMetrics.filter(p => {
            const total = (p.analytics?.returningCustomerPurchases || 0) + (p.analytics?.newCustomerPurchases || 0);
            return total > 0;
          }).length : 0;
        
        return getGradientColor(returningCustomerRatio);
      }
      
      case 'shoppingPath': {
        // 🔥 BEAST MODE: Cart position (what they grab first vs last)
        const avgCartPosition = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            return sum + (p.analytics?.averageCartPosition || 99);
          }, 0) / metrics.productMetrics.filter(p => p.analytics?.averageCartPosition > 0).length : 0;
        
        const maxCartPosition = Math.max(...allMetrics.map(m => {
          const pos = m.productMetrics.length > 0 ?
            m.productMetrics.reduce((sum, p) => sum + (p.analytics?.averageCartPosition || 99), 0) / 
            m.productMetrics.filter(p => p.analytics?.averageCartPosition > 0).length : 0;
          return pos || 10;
        }), 10);
        
        // Invert - lower cart position (grabbed first) = better = green
        const intensity = 1 - (avgCartPosition / maxCartPosition);
        return getGradientColor(intensity);
      }
      
      default:
        return 'rgba(100, 116, 139, 0.3)'; // Gray - Default
    }
  };

  const ProductBox = ({ product, productIndex, sectionId, fixtureX, fixtureY, fixtureWidth, fixtureHeight }) => {
    const [isDragging, setIsDragging] = useState(false);
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

    const handleMouseDown = (e) => {
      e.stopPropagation();
      setIsDragging(true);
      setDragStart({ x: e.clientX, y: e.clientY });
    };

    useEffect(() => {
      if (!isDragging) return;

      const handleMouseMove = (e) => {
        const deltaX = e.clientX - dragStart.x;
        const deltaY = e.clientY - dragStart.y;
        
        const newX = Math.max(5, Math.min(95, ((product.visualX / 100) * fixtureWidth + deltaX) / fixtureWidth * 100));
        const newY = Math.max(5, Math.min(95, ((product.visualY / 100) * fixtureHeight + deltaY) / fixtureHeight * 100));
        
        updateProductPosition(sectionId, productIndex, newX, newY);
        setDragStart({ x: e.clientX, y: e.clientY });
      };

      const handleMouseUp = () => {
        setIsDragging(false);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }, [isDragging, dragStart]);

    const profit = product.cost !== null && product.cost !== undefined
      ? (product.price - product.cost) * (product.monthlySales || 0)
      : null;
    
    let colorClass = 'bg-gray-400';
    if (profit !== null) {
      if (profit > 100) colorClass = 'bg-green-500';
      else if (profit > 50) colorClass = 'bg-yellow-500';
      else if (profit > 0) colorClass = 'bg-orange-500';
      else if (profit < 0) colorClass = 'bg-red-500';
    }

    const size = Math.min(Math.max(20, 15 + product.quantity * 3), 40);
    
    const profitDisplay = profit !== null ? `$${profit.toFixed(2)}` : 'N/A';

    return (
      <div
        className={`absolute ${colorClass} rounded shadow-lg flex items-center justify-center text-white text-xs font-bold cursor-move hover:opacity-80`}
        style={{
          left: `${product.visualX}%`,
          top: `${product.visualY}%`,
          width: `${size}px`,
          height: `${size}px`,
          transform: 'translate(-50%, -50%)',
          zIndex: isDragging ? 1000 : 50,
          pointerEvents: 'auto'
        }}
        onMouseDown={handleMouseDown}
        title={`${product.name}\n$${product.price}\nQty: ${product.quantity}\nProfit: ${profitDisplay}`}
      >
        {product.quantity}
      </div>
    );
  };

  const DraggableSection = ({ section, fixture, isSelected, onSelect }) => {
    const [isDragging, setIsDragging] = useState(false);
    const [isResizing, setIsResizing] = useState(false);
    
    const metrics = calculateMetrics(section, timePeriod);
    const color = heatMapMode ? getHeatMapColor(metrics) : 'rgba(100, 116, 139, 0.3)';
    
    // Use custom layout properties or default to full fixture
    const layoutX = section.layoutX !== undefined ? section.layoutX : 0;
    const layoutY = section.layoutY !== undefined ? section.layoutY : 0;
    const layoutWidth = section.layoutWidth !== undefined ? section.layoutWidth : 100;
    const layoutHeight = section.layoutHeight !== undefined ? section.layoutHeight : 100;
    
    const handleMouseDown = (e) => {
      if (e.target.classList.contains('section-resize-handle')) {
        e.stopPropagation();
        setIsResizing(true);
        const resizePosition = e.target.dataset.position;
        const startX = e.clientX;
        const startY = e.clientY;
        const startLayoutX = layoutX;
        const startLayoutY = layoutY;
        const startLayoutWidth = layoutWidth;
        const startLayoutHeight = layoutHeight;

        const handleMouseMove = (e) => {
          const deltaX = ((e.clientX - startX) / fixture.width) * 100;
          const deltaY = ((e.clientY - startY) / fixture.height) * 100;

          let newLayoutX = startLayoutX;
          let newLayoutY = startLayoutY;
          let newLayoutWidth = startLayoutWidth;
          let newLayoutHeight = startLayoutHeight;

          if (resizePosition.includes('e')) {
            newLayoutWidth = Math.max(10, Math.min(100 - startLayoutX, startLayoutWidth + deltaX));
          }
          if (resizePosition.includes('w')) {
            const widthChange = Math.max(10, startLayoutWidth - deltaX);
            newLayoutWidth = widthChange;
            newLayoutX = startLayoutX + (startLayoutWidth - widthChange);
          }
          if (resizePosition.includes('s')) {
            newLayoutHeight = Math.max(10, Math.min(100 - startLayoutY, startLayoutHeight + deltaY));
          }
          if (resizePosition.includes('n')) {
            const heightChange = Math.max(10, startLayoutHeight - deltaY);
            newLayoutHeight = heightChange;
            newLayoutY = startLayoutY + (startLayoutHeight - heightChange);
          }

          // No snapping - free resizing
          updateSection({
            ...section,
            layoutX: Math.max(0, Math.min(100 - newLayoutWidth, newLayoutX)),
            layoutY: Math.max(0, Math.min(100 - newLayoutHeight, newLayoutY)),
            layoutWidth: Math.max(5, newLayoutWidth),
            layoutHeight: Math.max(5, newLayoutHeight)
          });
        };

        const handleMouseUp = () => {
          setIsResizing(false);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return;
      }

      // Handle dragging
      e.stopPropagation();
      setIsDragging(true);
      onSelect();
      
      const startX = e.clientX;
      const startY = e.clientY;
      const startLayoutX = layoutX;
      const startLayoutY = layoutY;

      const handleMouseMove = (e) => {
        const deltaX = ((e.clientX - startX) / fixture.width) * 100;
        const deltaY = ((e.clientY - startY) / fixture.height) * 100;
        
        let newX = Math.max(0, Math.min(100 - layoutWidth, startLayoutX + deltaX));
        let newY = Math.max(0, Math.min(100 - layoutHeight, startLayoutY + deltaY));
        
        // No snapping - free positioning
        updateSection({
          ...section,
          layoutX: newX,
          layoutY: newY
        });
      };

      const handleMouseUp = () => {
        setIsDragging(false);
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    };

    // Calculate actual pixel positions
    const left = (layoutX / 100) * fixture.width;
    const top = (layoutY / 100) * fixture.height;
    const width = (layoutWidth / 100) * fixture.width;
    const height = (layoutHeight / 100) * fixture.height;

    return (
      <div
        style={{
          position: 'absolute',
          left: left,
          top: top,
          width: width,
          height: height,
          backgroundColor: color,
          border: isSelected 
            ? '2px solid #3b82f6' 
            : 'none',
          cursor: isDragging ? 'grabbing' : 'grab',
          pointerEvents: 'auto',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: width > 60 && height > 40 ? '11px' : '9px',
          color: 'white',
          fontWeight: 'bold',
          textShadow: '1px 1px 2px rgba(0,0,0,0.8)',
          zIndex: isSelected ? 60 : 40,
          overflow: 'hidden'
        }}
        onMouseDown={handleMouseDown}
      >
        {/* Only show label if section is big enough */}
        {width > 40 && height > 30 && (
          <div className="text-center pointer-events-none" style={{ maxWidth: '90%', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
            <div>{section.name}</div>
            {heatMapMode && width > 60 && <div>${metrics.profitPerSqFt.toFixed(0)}/sqft</div>}
          </div>
        )}

        {/* Resize handles - only show when selected */}
        {isSelected && ['nw', 'ne', 'se', 'sw', 'n', 's', 'e', 'w'].map(position => (
          <div
            key={position}
            className="section-resize-handle"
            data-position={position}
            style={{
              position: 'absolute',
              background: '#3b82f6',
              border: '1px solid white',
              cursor: getCursor(position),
              zIndex: 70,
              pointerEvents: 'auto',
              ...getHandlePosition(position)
            }}
          />
        ))}
      </div>
    );
  };

const Fixture = ({ fixture, onUpdate, onDelete, onSelect, isSelected }) => {
    const [dragging, setDragging] = useState(false);

    const handleMouseDown = (e) => {
      if (e.target.classList.contains('resize-handle')) {
        e.stopPropagation();
        const resizePosition = e.target.dataset.position;
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = fixture.width;
        const startHeight = fixture.height;
        const startLeft = fixture.x;
        const startTop = fixture.y;

        const handleMouseMove = (e) => {
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;

          let newWidth = startWidth;
          let newHeight = startHeight;
          let newX = startLeft;
          let newY = startTop;

          if (resizePosition.includes('e')) newWidth = Math.max(60, startWidth + deltaX);
          if (resizePosition.includes('w')) {
            newWidth = Math.max(60, startWidth - deltaX);
            newX = startLeft + (startWidth - newWidth);
          }
          if (resizePosition.includes('s')) newHeight = Math.max(60, startHeight + deltaY);
          if (resizePosition.includes('n')) {
            newHeight = Math.max(60, startHeight - deltaY);
            newY = startTop + (startHeight - newHeight);
          }

          onUpdate({ ...fixture, width: newWidth, height: newHeight, x: newX, y: newY });
        };

        const handleMouseUp = () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return;
      }

      e.stopPropagation();
      setDragging(true);
      onSelect();
      
      const startX = e.clientX;
      const startY = e.clientY;
      const startLeft = fixture.x;
      const startTop = fixture.y;

      const handleMouseMove = (e) => {
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        onUpdate({ ...fixture, x: startLeft + deltaX, y: startTop + deltaY });
      };

      const handleMouseUp = () => {
        setDragging(false);
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    };

    const fixtureSections = sections.filter(s => s.fixtureId === fixture.id);
    const totalProfit = fixtureSections.reduce((sum, s) => {
      const metrics = calculateMetrics(s, timePeriod);
      return sum + metrics.totalProfit;
    }, 0);

    return (
      <div
        data-fixture-id={fixture.id}
        style={{
          position: 'absolute',
          left: fixture.x,
          top: fixture.y,
          width: fixture.width,
          height: fixture.height,
          backgroundColor: heatMapMode ? '#e5e7eb' : fixture.color, // Gray when heat map active, fixture color otherwise
          border: isSelected ? '3px solid #3b82f6' : '2px solid #cbd5e1',
          borderRadius: '8px',
          cursor: dragging ? 'grabbing' : 'grab',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          opacity: heatMapMode ? 0.95 : 0.9,
          zIndex: isSelected ? 100 : 10,
          overflow: 'hidden'
        }}
        onMouseDown={handleMouseDown}
      >
        {/* Draggable/Resizable Sections - always visible */}
        {fixtureSections.map(section => (
          <DraggableSection
            key={section.id}
            section={section}
            fixture={fixture}
            isSelected={selectedSection === section.id}
            onSelect={() => {
              setSelectedSection(section.id);
              setSelectedFixture(section.fixtureId); // Open the fixture sidebar
              
              // Scroll to section in sidebar
              setTimeout(() => {
                if (sectionRefs.current[section.id]) {
                  sectionRefs.current[section.id].scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                  });
                }
              }, 100);
              
              // Expand all collapsible sections when clicking on map
              const newLayoutCollapsed = new Set(collapsedSectionLayouts);
              newLayoutCollapsed.delete('all');
              newLayoutCollapsed.delete(section.id);
              setCollapsedSectionLayouts(newLayoutCollapsed);
              
              const newRowsCollapsed = new Set(collapsedRowsSections);
              newRowsCollapsed.delete('all');
              newRowsCollapsed.delete(section.id);
              setCollapsedRowsSections(newRowsCollapsed);
              
              const newUnknownCollapsed = new Set(collapsedUnknownProducts);
              newUnknownCollapsed.delete('all');
              newUnknownCollapsed.delete(section.id);
              setCollapsedUnknownProducts(newUnknownCollapsed);
              
              // Scroll to and focus UPC input
              setTimeout(() => {
                if (upcInputRef.current) {
                  upcInputRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  upcInputRef.current.focus();
                }
              }, 100);
            }}
          />
        ))}

        {/* Fixture label - only show when NOT in heat map mode */}
        {!heatMapMode && (
          <div className="text-white text-center p-2 pointer-events-none">
            <div className="font-bold text-sm">{fixture.name}</div>
            <div className="text-xs">{fixtureSections.length} sections</div>
          </div>
        )}

        {showVisualMode && fixtureSections.map(section => 
          section.products.map((product, idx) => (
            <ProductBox
              key={`${section.id}-${idx}`}
              product={product}
              productIndex={idx}
              sectionId={section.id}
              fixtureX={fixture.x}
              fixtureY={fixture.y}
              fixtureWidth={fixture.width}
              fixtureHeight={fixture.height}
            />
          ))
        )}

        {isSelected && (
          <button
            onClick={(e) => {
              e.stopPropagation();
              onDelete(fixture.id);
            }}
            className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600"
            style={{ pointerEvents: 'auto' }}
          >
            <Icons.X />
          </button>
        )}

        {isSelected && ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'].map(position => (
          <div
            key={position}
            className="resize-handle"
            data-position={position}
            style={{
              position: 'absolute',
              background: 'white',
              border: '2px solid #3b82f6',
              cursor: getCursor(position),
              zIndex: 110,
              pointerEvents: 'auto',
              ...getHandlePosition(position)
            }}
          />
        ))}
      </div>
    );
  };

  // Helper function to check if data is stale
  const getRefreshStatus = (lastRefreshTime, thresholdDays) => {
    if (!lastRefreshTime) return { isStale: true, daysAgo: null, message: 'Never refreshed' };
    
    const now = new Date();
    const diffMs = now - lastRefreshTime;
    const diffDays = diffMs / (1000 * 60 * 60 * 24);
    
    const isStale = diffDays > thresholdDays;
    const daysAgo = Math.floor(diffDays);
    const hoursAgo = Math.floor(diffMs / (1000 * 60 * 60));
    
    let message = '';
    if (daysAgo === 0) {
      if (hoursAgo === 0) {
        message = 'Just now';
      } else {
        message = `${hoursAgo}h ago`;
      }
    } else if (daysAgo === 1) {
      message = 'Yesterday';
    } else {
      message = `${daysAgo}d ago`;
    }
    
    return { isStale, daysAgo, message };
  };

  // Check refresh statuses
  const productsStatus = getRefreshStatus(lastProductsRefresh, 30); // 30 days for products
  const salesStatus = getRefreshStatus(lastSalesRefresh, 7); // 7 days for sales
  const ordersStatus = getRefreshStatus(lastOrdersRefresh, 7); // 7 days for orders

  // Unknown Products Management
  const updateUnknownProductNote = (id, note) => {
    const updatedProducts = unknownProducts.map(u => u.id === id ? { ...u, note } : u);
    setUnknownProducts(updatedProducts);
    console.log('Updated unknown products:', updatedProducts);
  };

  // Auto-save unknown products when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      if (unknownProducts.length >= 0) {
        console.log('Auto-saving unknown products...');
        localStorage.setItem('planogram_unknown_products', JSON.stringify(unknownProducts));
        if (firebaseReady) {
          saveToCloud(true); // silent mode
        }
      }
    }, 2000);
    return () => clearTimeout(timeoutId);
  }, [unknownProducts]);

  const deleteUnknownProduct = (id) => {
    setUnknownProducts(prev => prev.filter(u => u.id !== id));
  };

  // Bad Stock Products Management
  const updateBadStockNote = (id, note) => {
    const updatedProducts = badStockProducts.map(b => b.id === id ? { ...b, note } : b);
    setBadStockProducts(updatedProducts);
    console.log('Updated bad stock products:', updatedProducts);
  };

  // Auto-save bad stock products when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      if (badStockProducts.length >= 0) {
        console.log('Auto-saving bad stock products...');
        localStorage.setItem('planogram_bad_stock_products', JSON.stringify(badStockProducts));
        if (firebaseReady) {
          saveToCloud(true); // silent mode
        }
      }
    }, 2000);
    return () => clearTimeout(timeoutId);
  }, [badStockProducts]);

  const deleteBadStockProduct = (id) => {
    setBadStockProducts(prev => prev.filter(b => b.id !== id));
  };

  // Auto-save sections when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      console.log('Auto-saving sections to Firebase...');
      localStorage.setItem('planogram_sections', JSON.stringify(sections));
      if (firebaseReady) {
        saveToCloud(true); // silent mode
      }
    }, 2000); // 2 second delay
    return () => clearTimeout(timeoutId);
  }, [sections]);

  // Auto-save fixtures when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      console.log('Auto-saving fixtures to Firebase...');
      localStorage.setItem('planogram_fixtures', JSON.stringify(fixtures));
      if (firebaseReady) {
        saveToCloud(true); // silent mode
      }
    }, 2000); // 2 second delay
    return () => clearTimeout(timeoutId);
  }, [fixtures]);

  const resolveBadStock = (id) => {
    setBadStockProducts(prev =>
      prev.map(b => b.id === id ? { ...b, resolved: true } : b)
    );
    setFeedback('✅ Marked as resolved');
  };

  const checkUnknownAgainstShopify = async () => {
    if (!shopifyConfig.connected) {
      setFeedback('⚠️ Connect to Shopify first');
      return;
    }
    
    // Check each unknown product against current Shopify data
    for (const unknown of unknownProducts.filter(u => !u.resolved)) {
      try {
        const url = new URL(`${BACKEND_URL}/api/product/${unknown.upc}`);
        url.searchParams.append('storeName', shopifyConfig.storeName);
        url.searchParams.append('accessToken', shopifyConfig.accessToken);
        
        const response = await fetch(url);
        const data = await response.json();

        if (response.ok && data.title) {
          setUnknownProducts(prev =>
            prev.map(u => u.id === unknown.id ? {
              ...u,
              resolved: true,
              matchedProduct: {
                name: data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title,
                vendor: data.vendor,
                price: data.price
              },
              resolvedAt: new Date().toISOString()
            } : u)
          );
        }
      } catch (error) {
        console.error(`Error checking UPC ${unknown.upc}:`, error);
      }
    }
    
    setFeedback('✅ Checked unknown products');
    setTimeout(() => setFeedback(''), 3000);
  };

  return (
    <div className="flex flex-col h-screen bg-gray-100">
      {/* 🔥 NAVIGATION MENU */}
      <div className="bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg">
        <div className="flex items-center justify-between px-6 py-3">
          <div className="flex items-center gap-3">
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={() => setCurrentPage('planner')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'planner'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-blue-500 text-white hover:bg-blue-400'
              }`}
            >
              🗺️ Store Planner
            </button>
            <button
              onClick={() => setCurrentPage('findProduct')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'findProduct'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-green-500 text-white hover:bg-green-400'
              }`}
            >
              🔍 Find Product
            </button>
            <button
              onClick={() => setCurrentPage('dashboard')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'dashboard'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-blue-500 text-white hover:bg-blue-400'
              }`}
            >
              📊 Dashboard
            </button>
            <button
              onClick={() => setCurrentPage('forecasting')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'forecasting'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-blue-500 text-white hover:bg-blue-400'
              }`}
            >
              📈 Forecasting
            </button>
            <button
              onClick={() => setCurrentPage('rowAnalytics')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'rowAnalytics'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-blue-500 text-white hover:bg-blue-400'
              }`}
            >
              📊 Row Analytics
            </button>
            <button
              onClick={() => setCurrentPage('unknownProducts')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all relative ${
                currentPage === 'unknownProducts'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-blue-500 text-white hover:bg-blue-400'
              }`}
            >
              ⚠️ Unknown Products
              {unknownProducts.filter(u => !u.resolved).length > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                  {unknownProducts.filter(u => !u.resolved).length}
                </span>
              )}
            </button>
            <button
              onClick={() => setCurrentPage('badStock')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all relative ${
                currentPage === 'badStock'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-orange-500 text-white hover:bg-orange-400'
              }`}
            >
              📦 Bad Stock
              {badStockProducts.filter(b => !b.resolved).length > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                  {badStockProducts.filter(b => !b.resolved).length}
                </span>
              )}
            </button>
            <button
              onClick={() => setCurrentPage('settings')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                currentPage === 'settings'
                  ? 'bg-white text-blue-600 shadow-lg'
                  : 'bg-blue-500 text-white hover:bg-blue-400'
              }`}
            >
              ⚙️ Settings
            </button>
          </div>
        </div>
      </div>

      {/* PAGE CONTENT */}
      {currentPage === 'planner' && (
        <>
    <div className="flex flex-1 overflow-hidden bg-gray-100">
      {showLibrary && (
        <div 
          className="bg-white shadow-lg p-4 overflow-y-auto relative"
          style={{ width: `${sidebarWidth}px`, minWidth: '250px', maxWidth: '800px' }}
        >
          {/* Resize Handle */}
          <div
            className="absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors z-50"
            onMouseDown={(e) => {
              e.preventDefault();
              setIsResizingSidebar(true);
              const startX = e.clientX;
              const startWidth = sidebarWidth;
              
              const handleMouseMove = (moveEvent) => {
                const delta = moveEvent.clientX - startX;
                const newWidth = Math.max(250, Math.min(800, startWidth + delta));
                setSidebarWidth(newWidth);
              };
              
              const handleMouseUp = () => {
                setIsResizingSidebar(false);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
            style={{ 
              background: isResizingSidebar ? '#3b82f6' : 'transparent',
              width: isResizingSidebar ? '4px' : '4px'
            }}
          >
            <div className="absolute top-1/2 right-0 transform translate-x-1/2 -translate-y-1/2 bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center text-white opacity-0 hover:opacity-100 transition-opacity shadow-lg pointer-events-none">
              ⇄
            </div>
          </div>

          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold flex items-center gap-2">
              <Icons.Package />
              Fixture Library
            </h2>
            <button onClick={() => setShowLibrary(false)} className="p-1 hover:bg-gray-100 rounded">
              <Icons.X />
            </button>
          </div>

          <div className="space-y-2">
            {Object.entries(FIXTURE_TYPES).map(([key, type]) => {
              const IconComponent = Icons[type.icon];
              return (
                <button
                  key={key}
                  onClick={() => addFixture(key)}
                  className="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200"
                >
                  <div className="w-10 h-10 rounded flex items-center justify-center" style={{ backgroundColor: type.color }}>
                    {IconComponent && <IconComponent />}
                  </div>
                  <span className="font-medium">{type.name}</span>
                </button>
              );
            })}
          </div>

          <div className="mt-6 pt-6 border-t">
            <h3 className="font-bold mb-2">Active Fixtures</h3>
            <div className="space-y-1">
              {(fixtures || []).map(fixture => (
                <div
                  key={fixture.id}
                  className={`p-2 rounded cursor-pointer flex items-center justify-between ${
                    selectedFixture === fixture.id ? 'bg-blue-100' : 'hover:bg-gray-100'
                  }`}
                  onClick={() => setSelectedFixture(fixture.id)}
                >
                  {editingFixture === fixture.id ? (
                    <input
                      type="text"
                      value={editingFixtureName}
                      onChange={(e) => setEditingFixtureName(e.target.value)}
                      onBlur={() => {
                        if (editingFixtureName.trim()) {
                          updateFixtureName(fixture.id, editingFixtureName.trim());
                        } else {
                          setEditingFixture(null);
                        }
                      }}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && editingFixtureName.trim()) {
                          updateFixtureName(fixture.id, editingFixtureName.trim());
                        }
                        if (e.key === 'Escape') {
                          setEditingFixture(null);
                        }
                      }}
                      className="flex-1 px-2 py-1 border-2 border-blue-500 rounded text-sm"
                      autoFocus
                      onClick={(e) => e.stopPropagation()}
                    />
                  ) : (
                    <span 
                      className="text-sm flex-1 hover:text-blue-600"
                      onClick={(e) => {
                        e.stopPropagation();
                        setEditingFixture(fixture.id);
                        setEditingFixtureName(fixture.name);
                      }}
                      title="Click to rename"
                    >
                      {fixture.name}
                    </span>
                  )}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteFixture(fixture.id);
                    }}
                    className="text-red-500 hover:text-red-700"
                  >
                    <Icons.Trash2 />
                  </button>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      <div className="flex-1 flex flex-col">
        <div className="bg-white shadow-md p-4 flex items-center justify-between flex-wrap gap-2">
          <div className="flex items-center gap-2 flex-wrap">
            {!showLibrary && (
              <button onClick={() => setShowLibrary(true)} className="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                Show Library
              </button>
            )}
            
            <button
              onClick={() => setHeatMapMode(!heatMapMode)}
              className={`px-3 py-2 rounded flex items-center gap-2 text-sm ${heatMapMode ? 'bg-orange-500 text-white' : 'bg-gray-200'}`}
            >
              <Icons.Flame />
              Heat Map
            </button>

            {/* Heat Map Type Selector */}
            {heatMapMode && (
              <div className="flex items-center gap-2 bg-gradient-to-r from-red-50 to-orange-50 px-3 py-2 rounded-lg border border-red-200 relative">
                <span className="text-sm font-semibold text-gray-700">Show:</span>
                <select
                  value={heatMapType}
                  onChange={(e) => setHeatMapType(e.target.value)}
                  className="px-2 py-1 bg-white border-2 border-red-300 rounded text-sm font-medium hover:border-red-500 focus:outline-none focus:border-red-600 cursor-pointer"
                >
                  <option value="profit">💰 Profit Density</option>
                  <option value="velocity">📦 Sales Velocity</option>
                  <option value="deadStock">🚨 Dead Stock</option>
                  <option value="margin">💸 Profit Margin</option>
                  <option value="stockHealth">❤️ Stock Health</option>
                  <option value="aov">🔥 High AOV Products</option>
                  <option value="returningCustomers">🔄 Returning Customer Favorites</option>
                  <option value="shoppingPath">🛒 Shopping Path (Cart Position)</option>
                </select>
                
                {/* Info Icon with Tooltip */}
                <div 
                  className="relative"
                  onMouseEnter={() => setShowHeatMapGuide(true)}
                  onMouseLeave={() => setShowHeatMapGuide(false)}
                >
                  <div className="w-5 h-5 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold cursor-help">
                    i
                  </div>
                  
                  {showHeatMapGuide && (
                    <div className="absolute left-0 top-8 z-[9999] w-96 bg-white rounded-lg shadow-2xl border-2 border-blue-500 p-4 text-xs">
                      <div className="font-bold text-lg mb-3 text-blue-600">🔥 Heat Map Guide</div>
                      
                      <div className="space-y-3 max-h-96 overflow-y-auto">
                        <div className="border-l-4 border-green-500 pl-2">
                          <div className="font-bold">💰 Profit Density</div>
                          <div className="text-gray-600">🟢 Green = High profit per sq ft | 🔴 Red = Low profit</div>
                        </div>
                        
                        <div className="border-l-4 border-green-500 pl-2">
                          <div className="font-bold">📦 Sales Velocity</div>
                          <div className="text-gray-600">🟢 Fast-moving products | 🔴 Slow sellers</div>
                        </div>
                        
                        <div className="border-l-4 border-red-500 pl-2">
                          <div className="font-bold">🚨 Dead Stock</div>
                          <div className="text-gray-600">🔴 Inventory with ZERO sales (clearance needed!) | 🟢 No dead stock</div>
                        </div>
                        
                        <div className="border-l-4 border-green-500 pl-2">
                          <div className="font-bold">💸 Profit Margin</div>
                          <div className="text-gray-600">🟢 50%+ margin | 🔴 Under 15% margin</div>
                        </div>
                        
                        <div className="border-l-4 border-green-500 pl-2">
                          <div className="font-bold">❤️ Stock Health</div>
                          <div className="text-gray-600">🟢 Perfect stock levels | 🔴 Out of stock or excess dead stock</div>
                        </div>
                        
                        <div className="border-l-4 border-orange-500 pl-2 bg-orange-50">
                          <div className="font-bold">🔥 High AOV Products</div>
                          <div className="text-gray-600">🟢 Products in $150+ orders (BIG SPENDERS!) | 🔴 Low-value orders</div>
                          <div className="text-xs italic mt-1">Requires order data - click 🔥 Orders button first!</div>
                        </div>
                        
                        <div className="border-l-4 border-blue-500 pl-2 bg-blue-50">
                          <div className="font-bold">🔄 Returning Customer Favorites</div>
                          <div className="text-gray-600">🟢 Loyal customer favorites (70%+ returning) | 🟣 New customer products</div>
                          <div className="text-xs italic mt-1">Shows what brings customers back!</div>
                        </div>
                        
                        <div className="border-l-4 border-purple-500 pl-2 bg-purple-50">
                          <div className="font-bold">🛒 Shopping Path (Cart Position)</div>
                          <div className="text-gray-600">🟢 Grabbed FIRST (entry products) | 🔴 Grabbed LAST (checkout impulse)</div>
                          <div className="text-xs italic mt-1">See HOW customers shop - what they look for vs add at checkout!</div>
                        </div>
                      </div>
                      
                      <div className="mt-3 pt-3 border-t text-center text-gray-500 italic">
                        💡 Use Period dropdown to change timeframe
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            <button
              onClick={saveToCloud}
              className="px-3 py-2 bg-green-500 text-white rounded flex items-center gap-2 text-sm hover:bg-green-600"
            >
              <Icons.Save />
              Save
            </button>

            {syncStatus && (
              <div className="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">
                {syncStatus}
              </div>
            )}

            <input type="file" ref={fileInputRef} onChange={handleBackgroundUpload} accept="image/*" className="hidden" />
            
            <button onClick={() => fileInputRef.current?.click()} className="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 flex items-center gap-2 text-sm">
              <Icons.Camera />
              BG
            </button>

            {backgroundImage && (
              <>
                <button onClick={removeBackground} className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                  Remove
                </button>
                <button onClick={resetBackgroundPosition} className="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 flex items-center gap-2 text-sm">
                  <Icons.Move />
                  Reset
                </button>
              </>
            )}

            <button onClick={exportLayout} className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center gap-2 text-sm">
              <Icons.Download />
              Export
            </button>

            <button onClick={loadFromCloud} className="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-2 text-sm">
              <Icons.Download />
              Load from Cloud
            </button>

            <button 
              onClick={() => {
                const savedSections = localStorage.getItem('planogram_sections');
                const savedFixtures = localStorage.getItem('planogram_fixtures');
                if (savedSections) {
                  setSections(JSON.parse(savedSections));
                  setFeedback('✅ Restored sections from backup!');
                }
                if (savedFixtures) {
                  setFixtures(JSON.parse(savedFixtures));
                }
                setTimeout(() => setFeedback(''), 3000);
              }}
              className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center gap-2 text-sm"
              title="Restore from localStorage backup"
            >
              🔄 Restore Backup
            </button>

            <button onClick={() => setShowSettings(true)} className="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm">
              Shopify
            </button>

            {/* Time Period Filter */}
            <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-3 py-2 rounded-lg border border-blue-200">
              <Icons.BarChart3 />
              <span className="text-sm font-semibold text-gray-700">Period:</span>
              <select
                value={timePeriod}
                onChange={(e) => setTimePeriod(e.target.value)}
                className="px-2 py-1 bg-white border-2 border-blue-300 rounded text-sm font-medium hover:border-blue-500 focus:outline-none focus:border-blue-600 cursor-pointer"
              >
                <option value="day">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
                <option value="all">All Time</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>

            {/* Custom Date Range Picker */}
            {timePeriod === 'custom' && (
              <div className="flex items-center gap-2 bg-gradient-to-r from-purple-50 to-pink-50 px-3 py-2 rounded-lg border border-purple-300">
                <input
                  type="date"
                  value={customDateRange.start}
                  onChange={(e) => setCustomDateRange({...customDateRange, start: e.target.value})}
                  className="px-2 py-1 border-2 border-purple-300 rounded text-sm focus:outline-none focus:border-purple-500"
                />
                <span className="text-sm font-semibold text-gray-600">to</span>
                <input
                  type="date"
                  value={customDateRange.end}
                  onChange={(e) => setCustomDateRange({...customDateRange, end: e.target.value})}
                  className="px-2 py-1 border-2 border-purple-300 rounded text-sm focus:outline-none focus:border-purple-500"
                />
              </div>
            )}

            {shopifyConfig.connected && (
              <div className="flex flex-col gap-2">
                {/* Refresh buttons row */}
                <div className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded text-xs">
                  <button
                    onClick={() => setAutoRefreshEnabled(!autoRefreshEnabled)}
                    className={`px-2 py-1 rounded ${autoRefreshEnabled ? 'bg-green-500 text-white' : 'bg-gray-300'}`}
                    title="Toggle auto-refresh"
                  >
                    {autoRefreshEnabled ? '🔄 Auto' : '⏸️ Paused'}
                  </button>
                  <button
                    onClick={() => refreshSalesOnly()}
                    className={`px-3 py-1 ${salesStatus.isStale ? 'bg-yellow-500 animate-pulse' : 'bg-green-500'} text-white rounded hover:bg-green-600 font-semibold flex items-center gap-1`}
                    title={`Refresh sales data only (fast!) - Last: ${salesStatus.message}`}
                  >
                    📊 Sales
                    {salesStatus.isStale && <span className="text-xs">!</span>}
                  </button>
                  <button
                    onClick={() => refreshProductCache(false)}
                    className={`px-3 py-1 ${productsStatus.isStale ? 'bg-yellow-500 animate-pulse' : 'bg-blue-500'} text-white rounded hover:bg-blue-600 font-semibold flex items-center gap-1`}
                    title={`Full refresh: products + sales (slow) - Products: ${productsStatus.message}`}
                  >
                    🔄 Full
                    {productsStatus.isStale && <span className="text-xs">!</span>}
                  </button>
                  <button
                    onClick={() => refreshOrders()}
                    className={`px-3 py-1 ${ordersStatus.isStale ? 'bg-red-500 animate-pulse' : 'bg-orange-500'} text-white rounded hover:bg-orange-600 font-semibold flex items-center gap-1`}
                    title={`🔥 BEAST MODE: Import full order data for analytics! - Last: ${ordersStatus.message}`}
                >
                  🔥 Orders
                  {ordersStatus.isStale && <span className="text-xs">!</span>}
                </button>
              </div>
              
              {/* Status row - shows last refresh times */}
              <div className="flex items-center gap-3 px-3 py-1 bg-white/50 rounded text-xs">
                <div className="flex items-center gap-1">
                  <span className="text-gray-600">Products:</span>
                  <span className={productsStatus.isStale ? 'text-yellow-600 font-semibold' : 'text-green-600'}>
                    {productsStatus.message}
                  </span>
                </div>
                <span className="text-gray-400">|</span>
                <div className="flex items-center gap-1">
                  <span className="text-gray-600">Sales:</span>
                  <span className={salesStatus.isStale ? 'text-yellow-600 font-semibold' : 'text-green-600'}>
                    {salesStatus.message}
                  </span>
                </div>
                <span className="text-gray-400">|</span>
                <div className="flex items-center gap-1">
                  <span className="text-gray-600">Orders:</span>
                  <span className={ordersStatus.isStale ? 'text-red-600 font-semibold' : 'text-green-600'}>
                    {ordersStatus.message}
                  </span>
                </div>
              </div>
            </div>
            )}
          </div>

          <div className="text-xl font-bold">{storeName}</div>

          {feedback && (
            <div className="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg text-sm">
              {feedback}
            </div>
          )}
        </div>

        <div 
          ref={canvasRef}
          className="flex-1 relative overflow-hidden bg-gray-50"
          style={{ 
            cursor: isPanning ? 'grabbing' : (isDraggingBg ? 'grabbing' : 'default'),
            backgroundImage: 'radial-gradient(circle, #d1d5db 1px, transparent 1px)',
            backgroundSize: '20px 20px'
          }}
          onWheel={handleCanvasWheel}
          onMouseDown={handleCanvasMouseDown}
          onMouseMove={(e) => {
            handleBgMouseMove(e);
            handleCanvasMouseMove(e);
          }}
          onMouseUp={(e) => {
            handleBgMouseUp();
            handleCanvasMouseUp(e);
          }}
          onMouseLeave={(e) => {
            handleBgMouseUp();
            handleCanvasMouseUp(e);
          }}
          onClick={(e) => {
            // Deselect if clicking on empty canvas (not on a fixture)
            if (e.target === e.currentTarget || e.target.closest('.canvas-background')) {
              setSelectedSection(null);
              setSelectedProduct(null);
            }
          }}
        >
          {/* Transform wrapper for zoom/pan */}
          <div style={{
            transform: `scale(${zoom}) translate(${panOffset.x / zoom}px, ${panOffset.y / zoom}px)`,
            transformOrigin: '0 0',
            width: '100%',
            height: '100%',
            position: 'relative'
          }}>
          {backgroundImage && (
            <img
              src={backgroundImage}
              alt="Store layout"
              style={{
                position: 'absolute',
                top: bgImagePosition.y,
                left: bgImagePosition.x,
                maxWidth: '100%',
                maxHeight: '100%',
                objectFit: 'contain',
                opacity: 0.3,
                pointerEvents: 'auto',
                cursor: isDraggingBg ? 'grabbing' : 'grab',
                zIndex: 0,
                userSelect: 'none'
              }}
              onMouseDown={handleBgMouseDown}
              draggable={false}
            />
          )}

          {(fixtures || []).map(fixture => (
            <Fixture
              key={fixture.id}
              fixture={fixture}
              onUpdate={updateFixture}
              onDelete={deleteFixture}
              onSelect={() => setSelectedFixture(fixture.id)}
              isSelected={selectedFixture === fixture.id}
            />
          ))}
          </div>
        </div>
      </div>

      {selectedFixture && (
        <div 
          className="bg-white shadow-lg p-4 overflow-y-auto relative"
          style={{ width: `${rightSidebarWidth}px`, minWidth: '250px', maxWidth: '800px' }}
        >
          {/* Resize Handle - LEFT edge */}
          <div
            className="absolute top-0 left-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors z-50"
            onMouseDown={(e) => {
              e.preventDefault();
              setIsResizingRightSidebar(true);
              const startX = e.clientX;
              const startWidth = rightSidebarWidth;
              
              const handleMouseMove = (moveEvent) => {
                const delta = startX - moveEvent.clientX; // Reversed delta for left edge
                const newWidth = Math.max(250, Math.min(800, startWidth + delta));
                setRightSidebarWidth(newWidth);
              };
              
              const handleMouseUp = () => {
                setIsResizingRightSidebar(false);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
            style={{ 
              background: isResizingRightSidebar ? '#3b82f6' : 'transparent',
              width: isResizingRightSidebar ? '4px' : '4px'
            }}
          >
            <div className="absolute top-1/2 left-0 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center text-white opacity-0 hover:opacity-100 transition-opacity shadow-lg pointer-events-none">
              ⇄
            </div>
          </div>

          {editingFixture === selectedFixture ? (
            <input
              type="text"
              value={editingFixtureName}
              onChange={(e) => setEditingFixtureName(e.target.value)}
              onBlur={() => {
                if (editingFixtureName.trim()) {
                  updateFixtureName(selectedFixture, editingFixtureName.trim());
                } else {
                  setEditingFixture(null);
                }
              }}
              onKeyPress={(e) => {
                if (e.key === 'Enter' && editingFixtureName.trim()) {
                  updateFixtureName(selectedFixture, editingFixtureName.trim());
                }
                if (e.key === 'Escape') {
                  setEditingFixture(null);
                }
              }}
              className="text-xl font-bold mb-4 px-2 py-1 border-2 border-blue-500 rounded w-full"
              autoFocus
            />
          ) : (
            <h2 
              className="text-xl font-bold mb-4 cursor-pointer hover:text-blue-600"
              onClick={() => {
                setEditingFixture(selectedFixture);
                setEditingFixtureName(fixtures.find(f => f.id === selectedFixture)?.name || '');
              }}
              title="Click to rename fixture"
            >
              {fixtures.find(f => f.id === selectedFixture)?.name}
            </h2>
          )}

          <button
            onClick={() => addSection(selectedFixture)}
            className="w-full px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 mb-2 flex items-center justify-center gap-2"
          >
            <Icons.Plus />
            Add Section
          </button>

          <button
            onClick={() => {
              // Collapse all sections
              setCollapsedSectionLayouts(new Set(['all']));
              setCollapsedRowsSections(new Set(['all']));
              setCollapsedUnknownProducts(new Set(['all']));
            }}
            className="w-full px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 mb-4 flex items-center justify-center gap-2 text-sm"
          >
            ▲ Collapse All Sections
          </button>

          <div className="space-y-4">
            {sections
              .filter(s => s.fixtureId === selectedFixture)
              .map(section => {
                const metrics = calculateMetrics(section, timePeriod);
                const isSectionCollapsed = collapsedSections.has(section.id);
                
                return (
                  <div
                    key={section.id}
                    ref={el => sectionRefs.current[section.id] = el}
                    className={`p-4 border-2 rounded-lg ${selectedSection === section.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                    onClick={() => {
                      setSelectedSection(section.id);
                      // Expand all collapsible sections when clicking
                      const newLayoutCollapsed = new Set(collapsedSectionLayouts);
                      newLayoutCollapsed.delete('all');
                      newLayoutCollapsed.delete(section.id);
                      setCollapsedSectionLayouts(newLayoutCollapsed);
                      
                      const newRowsCollapsed = new Set(collapsedRowsSections);
                      newRowsCollapsed.delete('all');
                      newRowsCollapsed.delete(section.id);
                      setCollapsedRowsSections(newRowsCollapsed);
                      
                      const newUnknownCollapsed = new Set(collapsedUnknownProducts);
                      newUnknownCollapsed.delete('all');
                      newUnknownCollapsed.delete(section.id);
                      setCollapsedUnknownProducts(newUnknownCollapsed);
                      
                      // Scroll to and focus UPC input
                      setTimeout(() => {
                        if (upcInputRef.current) {
                          upcInputRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                          upcInputRef.current.focus();
                        }
                      }, 100);
                    }}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          const newCollapsed = new Set(collapsedSections);
                          if (isSectionCollapsed) {
                            newCollapsed.delete(section.id);
                          } else {
                            newCollapsed.add(section.id);
                          }
                          setCollapsedSections(newCollapsed);
                        }}
                        className="text-gray-600 hover:text-gray-800 mr-2 font-bold text-lg"
                        title={isSectionCollapsed ? "Expand section" : "Collapse section"}
                      >
                        {isSectionCollapsed ? '▶' : '▼'}
                      </button>
                      {editingSection === section.id ? (
                        <input
                          type="text"
                          value={editingSectionName}
                          onChange={(e) => setEditingSectionName(e.target.value)}
                          onBlur={() => {
                            if (editingSectionName.trim()) {
                              updateSectionName(section.id, editingSectionName.trim());
                            } else {
                              setEditingSection(null);
                            }
                          }}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter' && editingSectionName.trim()) {
                              updateSectionName(section.id, editingSectionName.trim());
                            }
                            if (e.key === 'Escape') {
                              setEditingSection(null);
                            }
                          }}
                          className="flex-1 px-2 py-1 border-2 border-blue-500 rounded font-bold"
                          autoFocus
                          onClick={(e) => e.stopPropagation()}
                        />
                      ) : (
                        <h3 
                          className="font-bold cursor-pointer hover:text-blue-600 flex-1"
                          onClick={(e) => {
                            e.stopPropagation();
                            setEditingSection(section.id);
                            setEditingSectionName(section.name);
                          }}
                          title="Click to rename"
                        >
                          {section.name}
                        </h3>
                      )}
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          deleteSection(section.id);
                        }}
                        className="text-red-500 hover:text-red-700 ml-2"
                      >
                        <Icons.Trash2 />
                      </button>
                    </div>

                    {!isSectionCollapsed && (
                      <>
                        <div className="text-sm space-y-1 mb-3">
                      <div className="space-y-2">
                        {editingSectionArea === section.id ? (
                          <div className="space-y-2 p-2 bg-blue-50 rounded" onClick={(e) => e.stopPropagation()}>
                            <div className="font-semibold text-xs text-blue-700">Dimensions (inches):</div>
                            <div className="grid grid-cols-3 gap-2">
                              <div>
                                <label className="text-xs text-gray-600">Length</label>
                                <input
                                  type="number"
                                  step="1"
                                  min="1"
                                  value={editingDimensions.length}
                                  onChange={(e) => setEditingDimensions({ ...editingDimensions, length: e.target.value })}
                                  className="w-full px-2 py-1 border-2 border-blue-300 rounded text-sm"
                                  placeholder="L"
                                />
                              </div>
                              <div>
                                <label className="text-xs text-gray-600">Depth</label>
                                <input
                                  type="number"
                                  step="1"
                                  min="1"
                                  value={editingDimensions.depth}
                                  onChange={(e) => setEditingDimensions({ ...editingDimensions, depth: e.target.value })}
                                  className="w-full px-2 py-1 border-2 border-blue-300 rounded text-sm"
                                  placeholder="D"
                                />
                              </div>
                              <div>
                                <label className="text-xs text-gray-600">Height</label>
                                <input
                                  type="number"
                                  step="1"
                                  min="1"
                                  value={editingDimensions.height}
                                  onChange={(e) => setEditingDimensions({ ...editingDimensions, height: e.target.value })}
                                  className="w-full px-2 py-1 border-2 border-blue-300 rounded text-sm"
                                  placeholder="H"
                                />
                              </div>
                            </div>
                            <div className="text-xs text-gray-600">
                              = {((parseFloat(editingDimensions.length) * parseFloat(editingDimensions.depth)) / 144 || 0).toFixed(2)} sq ft
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  const l = parseFloat(editingDimensions.length);
                                  const d = parseFloat(editingDimensions.depth);
                                  const h = parseFloat(editingDimensions.height);
                                  if (l && d && h) {
                                    const area = (l * d) / 144; // Convert square inches to square feet
                                    const updatedSections = sections.map(s => 
                                      s.id === section.id 
                                        ? { ...s, length: l, depth: d, height: h, area: area }
                                        : s
                                    );
                                    setSections(updatedSections);
                                    autoSave(updatedSections, 'Auto-saved after updating dimensions');
                                  }
                                  setEditingSectionArea(null);
                                }}
                                className="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                              >
                                Save
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setEditingSectionArea(null);
                                }}
                                className="px-3 py-1 bg-gray-300 text-gray-700 rounded text-xs hover:bg-gray-400"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div
                            className="cursor-pointer hover:text-blue-600 hover:bg-blue-50 p-2 rounded -mx-2"
                            onClick={(e) => {
                              e.stopPropagation();
                              setEditingSectionArea(section.id);
                              setEditingDimensions({
                                length: (section.length || 48).toString(),
                                depth: (section.depth || 30).toString(),
                                height: (section.height || 72).toString()
                              });
                            }}
                            title="Click to edit dimensions"
                          >
                            <div className="text-xs text-gray-600">Dimensions (L×D×H):</div>
                            <div className="font-semibold">{section.length || 48}" × {section.depth || 30}" × {section.height || 72}"</div>
                            <div className="text-xs text-gray-600">Area: {section.area.toFixed(2)} sq ft</div>
                          </div>
                        )}
                      </div>
                      <div className="font-bold text-green-600">
                        Profit/sq ft: ${metrics.profitPerSqFt.toFixed(2)}
                      </div>
                      <div>Total Profit: ${metrics.totalProfit.toFixed(2)}</div>
                      <div>Products: {section.rows ? section.rows.reduce((sum, row) => sum + (row.products?.length || 0), 0) : section.products?.length || 0}</div>
                    </div>

                    {/* Section Layout Controls */}
                    <div className="space-y-2 mb-3 border-t pt-3">
                      <div 
                        className="flex items-center justify-between cursor-pointer hover:bg-blue-50 p-2 rounded -mx-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          const newCollapsed = new Set(collapsedSectionLayouts);
                          newCollapsed.delete('all'); // Remove 'all' flag when manually toggling
                          if (newCollapsed.has(section.id)) {
                            newCollapsed.delete(section.id);
                          } else {
                            newCollapsed.add(section.id);
                          }
                          setCollapsedSectionLayouts(newCollapsed);
                        }}
                      >
                        <div className="text-xs font-bold text-gray-600">SECTION LAYOUT</div>
                        <span className="text-lg text-gray-500 font-bold">
                          {(collapsedSectionLayouts.has('all') || collapsedSectionLayouts.has(section.id)) ? '▶' : '▼'}
                        </span>
                      </div>
                      
                      {!(collapsedSectionLayouts.has('all') || collapsedSectionLayouts.has(section.id)) && (
                        <>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="text-xs text-gray-600">X Position %</label>
                          <input
                            type="number"
                            min="0"
                            max="100"
                            value={section.layoutX || 0}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutX: parseFloat(e.target.value) || 0 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-600">Y Position %</label>
                          <input
                            type="number"
                            min="0"
                            max="100"
                            value={section.layoutY || 0}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutY: parseFloat(e.target.value) || 0 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-600">Width %</label>
                          <input
                            type="number"
                            min="1"
                            max="100"
                            value={section.layoutWidth || 100}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutWidth: parseFloat(e.target.value) || 100 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-600">Height %</label>
                          <input
                            type="number"
                            min="1"
                            max="100"
                            value={section.layoutHeight || 100}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutHeight: parseFloat(e.target.value) || 100 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 100, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections, 'Section layout reset');
                          }}
                          className="flex-1 px-2 py-1 bg-gray-200 text-xs rounded hover:bg-gray-300"
                        >
                          Reset Layout
                        </button>
                      </div>
                      <div className="text-xs text-gray-600 mt-2">Quick Layouts:</div>
                      <div className="grid grid-cols-3 gap-1">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 50, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Left Half"
                        >
                          ⬅️ Left
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 50, layoutY: 0, layoutWidth: 50, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Right Half"
                        >
                          Right ➡️
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 100, layoutHeight: 50 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Top Half"
                        >
                          ⬆️ Top
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 50, layoutWidth: 100, layoutHeight: 50 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Bottom Half"
                        >
                          Bottom ⬇️
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 33, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-green-100 text-xs rounded hover:bg-green-200"
                          title="1/3 Width"
                        >
                          1/3
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 25, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-green-100 text-xs rounded hover:bg-green-200"
                          title="1/4 Width"
                        >
                          1/4
                        </button>
                      </div>
                      </>
                      )}
                    </div>

                    {/* Rows Section */}
                    <div className="border-t pt-3 mb-3">
                      <div 
                        className="flex justify-between items-center mb-2 cursor-pointer hover:bg-blue-50 p-2 rounded -mx-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          const newCollapsed = new Set(collapsedRowsSections);
                          newCollapsed.delete('all'); // Remove 'all' flag when manually toggling
                          if (newCollapsed.has(section.id)) {
                            newCollapsed.delete(section.id);
                          } else {
                            newCollapsed.add(section.id);
                          }
                          setCollapsedRowsSections(newCollapsed);
                        }}
                      >
                        <div className="flex items-center gap-2">
                          <h4 className="font-semibold text-sm">Rows (Height Tracking)</h4>
                          <span className="text-lg text-gray-500 font-bold">
                            {(collapsedRowsSections.has('all') || collapsedRowsSections.has(section.id)) ? '▶' : '▼'}
                          </span>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            addRowToSection(section.id);
                          }}
                          className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                        >
                          + Add Row
                        </button>
                      </div>
                      
                      {!(collapsedRowsSections.has('all') || collapsedRowsSections.has(section.id)) && (
                      <div className="space-y-2">
                        {(section.rows || []).map((row, rowIdx) => {
                          // Calculate row metrics
                          const rowProducts = row.products || [];
                          let rowTotalSales = 0;
                          let rowTotalStock = 0;
                          let rowDeadStockCount = 0;
                          let rowProfit = 0;
                          
                          rowProducts.forEach(p => {
                            let sales = 0;
                            switch(timePeriod) {
                              case 'day': sales = p.dailySales || 0; break;
                              case 'week': sales = p.weeklySales || 0; break;
                              case 'month': sales = p.monthlySales || 0; break;
                              case 'quarter': sales = p.quarterlySales || 0; break;
                              case 'year': sales = p.yearlySales || 0; break;
                              case 'all': sales = p.allTimeSales || 0; break;
                              default: sales = p.monthlySales || 0;
                            }
                            
                            rowTotalSales += sales;
                            rowTotalStock += p.inventoryQuantity || 0;
                            if ((p.inventoryQuantity || 0) > 0 && sales === 0) rowDeadStockCount++;
                            rowProfit += (p.price - p.cost) * sales;
                          });
                          
                          // Calculate heat map color for this row
                          let rowHeatColor = 'bg-white';
                          if (heatMapMode && rowProducts.length > 0) {
                            const sectionArea = section.area || 1;
                            const rowProfitPerSqFt = rowProfit / sectionArea;
                            const rowVelocity = rowTotalSales / sectionArea;
                            
                            const deadStockValue = rowProducts
                              .filter(p => (p.inventoryQuantity || 0) > 0 && rowProducts.some(rp => {
                                let s = 0;
                                switch(timePeriod) {
                                  case 'day': s = rp.dailySales || 0; break;
                                  case 'week': s = rp.weeklySales || 0; break;
                                  case 'month': s = rp.monthlySales || 0; break;
                                  case 'quarter': s = rp.quarterlySales || 0; break;
                                  case 'year': s = rp.yearlySales || 0; break;
                                  case 'all': s = rp.allTimeSales || 0; break;
                                  default: s = rp.monthlySales || 0;
                                }
                                return rp.upc === p.upc && s === 0;
                              }))
                              .reduce((sum, p) => sum + (p.inventoryQuantity || 0) * p.cost, 0);
                            
                            const avgMargin = rowProducts.length > 0 ?
                              rowProducts.reduce((sum, p) => {
                                const margin = p.price > 0 ? ((p.price - p.cost) / p.price) : 0;
                                return sum + margin;
                              }, 0) / rowProducts.length : 0;
                            
                            const outOfStock = rowProducts.filter(p => (p.inventoryQuantity || 0) === 0 && rowTotalSales > 0).length;
                            const lowStock = rowProducts.filter(p => {
                              const stock = p.inventoryQuantity || 0;
                              let s = 0;
                              switch(timePeriod) {
                                case 'day': s = p.dailySales || 0; break;
                                case 'week': s = p.weeklySales || 0; break;
                                case 'month': s = p.monthlySales || 0; break;
                                default: s = p.monthlySales || 0;
                              }
                              const daysRemaining = s > 0 ? stock / (s / 30) : Infinity;
                              return stock > 0 && daysRemaining < 7;
                            }).length;
                            
                            switch(heatMapType) {
                              case 'profit':
                                if (rowProfitPerSqFt > 5) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (rowProfitPerSqFt > 2) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (rowProfitPerSqFt > 0.5) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                              case 'velocity':
                                if (rowVelocity > 2) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (rowVelocity > 1) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (rowVelocity > 0.2) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                              case 'deadStock':
                                if (deadStockValue > 500) rowHeatColor = 'bg-red-100 border-red-300';
                                else if (deadStockValue > 200) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else if (deadStockValue > 50) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else rowHeatColor = 'bg-green-100 border-green-300';
                                break;
                              case 'margin':
                                if (avgMargin > 0.5) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (avgMargin > 0.3) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (avgMargin > 0.15) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                              case 'stockHealth':
                                const problemScore = outOfStock * 3 + lowStock * 2 + rowDeadStockCount;
                                if (problemScore === 0) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (problemScore < 3) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (problemScore < 6) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                            }
                          }
                          
                          const isSelectedRow = selectedRow === row.id;
                          const isExpanded = expandedRows.has(row.id);
                          
                          return (
                            <div 
                              key={row.id}
                              className={`rounded-lg border-2 transition-all ${
                                isSelectedRow 
                                  ? 'border-blue-500 bg-blue-50' 
                                  : heatMapMode 
                                    ? `${rowHeatColor} hover:border-blue-300` 
                                    : 'border-gray-200 bg-white hover:border-blue-300'
                              }`}
                            >
                              {/* Row Header - Always Visible */}
                              <div 
                                className="p-3 cursor-pointer"
                                onClick={() => {
                                  setSelectedRow(row.id);
                                  setNewProduct({ ...newProduct, sectionId: section.id, rowId: row.id });
                                }}
                              >
                                <div className="flex justify-between items-start mb-2">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      {editingRow === row.id ? (
                                        <input
                                          type="text"
                                          defaultValue={row.name}
                                          autoFocus
                                          onBlur={(e) => {
                                            updateRowName(section.id, row.id, e.target.value);
                                            setEditingRow(null);
                                          }}
                                          onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                              updateRowName(section.id, row.id, e.target.value);
                                              setEditingRow(null);
                                            }
                                          }}
                                          className="font-semibold text-base px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          onClick={(e) => e.stopPropagation()}
                                        />
                                      ) : (
                                        <>
                                          <span 
                                            className="font-semibold text-base cursor-pointer hover:text-blue-600"
                                            onDoubleClick={(e) => {
                                              e.stopPropagation();
                                              setEditingRow(row.id);
                                            }}
                                            title="Double-click to rename"
                                          >
                                            {row.name}
                                          </span>
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingRow(row.id);
                                            }}
                                            className="text-gray-400 hover:text-blue-600 text-xs p-1 rounded hover:bg-blue-50"
                                            title="Rename row"
                                          >
                                            ✏️
                                          </button>
                                        </>
                                      )}
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          const newExpanded = new Set(expandedRows);
                                          if (newExpanded.has(row.id)) {
                                            newExpanded.delete(row.id);
                                          } else {
                                            newExpanded.add(row.id);
                                          }
                                          setExpandedRows(newExpanded);
                                        }}
                                        className="text-gray-500 hover:text-gray-700 text-xs p-1 rounded hover:bg-gray-100"
                                        title={isExpanded ? "Collapse" : "Expand"}
                                      >
                                        {isExpanded ? '▼' : '▶'}
                                      </button>
                                    </div>
                                  </div>
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      deleteRow(section.id, row.id);
                                    }}
                                    className="text-red-500 hover:text-red-700 text-xs p-1"
                                    title="Delete row"
                                  >
                                    <Icons.Trash2 />
                                  </button>
                                </div>
                                
                                {/* Summary Stats - Compact when collapsed, full grid when expanded */}
                                {isExpanded ? (
                                  <div className="grid grid-cols-4 gap-2 text-xs">
                                    <div className="bg-gray-50 p-2 rounded">
                                      <div className="text-gray-600 text-xs">Products</div>
                                      <div className="font-bold text-gray-800">{rowProducts.length}</div>
                                    </div>
                                    
                                    <div className={`p-2 rounded ${rowTotalSales > 0 ? 'bg-green-50' : 'bg-red-50'}`}>
                                      <div className="text-gray-600 text-xs">Sales</div>
                                      <div className={`font-bold ${rowTotalSales > 0 ? 'text-green-700' : 'text-red-600'}`}>
                                        {rowTotalSales}
                                      </div>
                                    </div>
                                    
                                    <div className="bg-blue-50 p-2 rounded">
                                      <div className="text-gray-600 text-xs">Profit</div>
                                      <div className="font-bold text-blue-700">${rowProfit.toFixed(2)}</div>
                                    </div>
                                    
                                    <div className={`p-2 rounded ${rowDeadStockCount > 0 ? 'bg-orange-50' : 'bg-gray-50'}`}>
                                      <div className="text-gray-600 text-xs">Stock</div>
                                      <div className={`font-bold ${rowDeadStockCount > 0 ? 'text-orange-700' : 'text-gray-700'}`}>
                                        {rowTotalStock}
                                        {rowDeadStockCount > 0 && <span className="text-xs ml-1">⚠️{rowDeadStockCount}</span>}
                                      </div>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="text-xs text-gray-600">
                                    {rowProducts.length} products • ${rowProfit.toFixed(0)} profit • {rowTotalSales} sales
                                  </div>
                                )}
                              </div>
                              
                              {/* Expanded Product Details */}
                              {isExpanded && rowProducts.length > 0 && (
                                <div className="mt-2 space-y-2">
                                  {row.products.map((product, pIdx) => {
                                    // Calculate sales based on current time period
                                    let sales = 0;
                                    switch(timePeriod) {
                                      case 'day': sales = product.dailySales || 0; break;
                                      case 'week': sales = product.weeklySales || 0; break;
                                      case 'month': sales = product.monthlySales || 0; break;
                                      case 'quarter': sales = product.quarterlySales || 0; break;
                                      case 'year': sales = product.yearlySales || 0; break;
                                      case 'all': sales = product.allTimeSales || 0; break;
                                      default: sales = product.monthlySales || 0;
                                    }
                                    
                                    // Calculate metrics
                                    const stock = product.inventoryQuantity || 0;
                                    const margin = product.price > 0 ? ((product.price - product.cost) / product.price * 100) : 0;
                                    const daysRemaining = sales > 0 ? Math.floor(stock / (sales / 30)) : Infinity;
                                    const isDeadStock = stock > 0 && sales === 0;
                                    const turnoverRate = stock > 0 ? (sales / stock).toFixed(2) : 0;
                                    
                                    // Stock status
                                    const stockStatus = stock === 0 ? 'OUT' : stock < 10 ? 'LOW' : 'OK';
                                    const stockColor = stock === 0 ? 'text-red-600 bg-red-50' : 
                                                      stock < 10 ? 'text-orange-600 bg-orange-50' : 
                                                      'text-green-600 bg-green-50';
                                    
                                    return (
                                      <div key={pIdx} className="bg-white border-2 border-gray-200 p-3 rounded-lg group hover:border-blue-300 transition-all">
                                        {/* Product Name & Controls */}
                                        <div className="flex items-start justify-between mb-2">
                                          <div className="flex-1">
                                            <div className="font-semibold text-sm text-gray-800">{product.name}</div>
                                            {product.sku && (
                                              <div className="text-xs text-gray-500">SKU: {product.sku}</div>
                                            )}
                                            {product.vendor && (
                                              <div className="text-xs text-gray-500">by {product.vendor}</div>
                                            )}
                                            {product.source === 'placeholder' && (
                                              <div className="mt-2">
                                                <input
                                                  type="text"
                                                  placeholder="Enter product name..."
                                                  value={(() => {
                                                    const found = unknownProducts.find(u => u.upc === product.upc);
                                                    console.log('Looking for UPC:', product.upc, 'Found:', found);
                                                    return found?.note || '';
                                                  })()}
                                                  onChange={(e) => {
                                                    console.log('Typing in note field, UPC:', product.upc, 'Value:', e.target.value);
                                                    const existing = unknownProducts.find(u => u.upc === product.upc);
                                                    console.log('Found unknown product:', existing);
                                                    if (existing) {
                                                      updateUnknownProductNote(existing.id, e.target.value);
                                                    } else {
                                                      console.error('Unknown product not found in array!');
                                                      // Create it if it doesn't exist
                                                      setUnknownProducts(prev => [...prev, {
                                                        id: Date.now(),
                                                        upc: product.upc,
                                                        note: e.target.value,
                                                        addedAt: new Date().toISOString(),
                                                        resolved: false
                                                      }]);
                                                    }
                                                  }}
                                                  onKeyPress={(e) => {
                                                    if (e.key === 'Enter') {
                                                      e.preventDefault();
                                                      console.log('Enter pressed - saving immediately!');
                                                      saveToFirebase(sections);
                                                      setFeedback('💾 Saved!');
                                                      setTimeout(() => setFeedback(''), 2000);
                                                    }
                                                  }}
                                                  onClick={(e) => e.stopPropagation()}
                                                  className="w-full px-2 py-1 text-xs border border-yellow-400 rounded bg-yellow-50 focus:outline-none focus:ring-1 focus:ring-yellow-500"
                                                />
                                              </div>
                                            )}
                                          </div>
                                          
                                          {/* Action Buttons */}
                                          <div className="flex gap-1 ml-2">
                                            {/* Move Up */}
                                            {pIdx > 0 && (
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  const updatedSections = sections.map(s => {
                                                    if (s.id === section.id) {
                                                      const updatedRows = s.rows.map(r => {
                                                        if (r.id === row.id) {
                                                          const newProducts = [...r.products];
                                                          [newProducts[pIdx - 1], newProducts[pIdx]] = [newProducts[pIdx], newProducts[pIdx - 1]];
                                                          return { ...r, products: newProducts };
                                                        }
                                                        return r;
                                                      });
                                                      return { ...s, rows: updatedRows };
                                                    }
                                                    return s;
                                                  });
                                                  setSections(updatedSections);
                                                  autoSave(updatedSections, 'Reordered product');
                                                  setFeedback('↑ Moved up');
                                                  setTimeout(() => setFeedback(''), 1000);
                                                }}
                                                className="opacity-0 group-hover:opacity-100 text-blue-500 hover:text-blue-700 p-1"
                                                title="Move up"
                                              >
                                                ↑
                                              </button>
                                            )}
                                            
                                            {/* Move Down */}
                                            {pIdx < row.products.length - 1 && (
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  const updatedSections = sections.map(s => {
                                                    if (s.id === section.id) {
                                                      const updatedRows = s.rows.map(r => {
                                                        if (r.id === row.id) {
                                                          const newProducts = [...r.products];
                                                          [newProducts[pIdx], newProducts[pIdx + 1]] = [newProducts[pIdx + 1], newProducts[pIdx]];
                                                          return { ...r, products: newProducts };
                                                        }
                                                        return r;
                                                      });
                                                      return { ...s, rows: updatedRows };
                                                    }
                                                    return s;
                                                  });
                                                  setSections(updatedSections);
                                                  autoSave(updatedSections, 'Reordered product');
                                                  setFeedback('↓ Moved down');
                                                  setTimeout(() => setFeedback(''), 1000);
                                                }}
                                                className="opacity-0 group-hover:opacity-100 text-blue-500 hover:text-blue-700 p-1"
                                                title="Move down"
                                              >
                                                ↓
                                              </button>
                                            )}
                                            
                                            {/* Delete */}
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                const updatedSections = sections.map(s => {
                                                  if (s.id === section.id) {
                                                    const updatedRows = s.rows.map(r => {
                                                      if (r.id === row.id) {
                                                        return {
                                                          ...r,
                                                          products: r.products.filter((_, idx) => idx !== pIdx)
                                                        };
                                                      }
                                                      return r;
                                                    });
                                                    return { ...s, rows: updatedRows };
                                                  }
                                                  return s;
                                                });
                                                setSections(updatedSections);
                                                autoSave(updatedSections, 'Deleted product');
                                                setFeedback('🗑️ Product removed');
                                                setTimeout(() => setFeedback(''), 2000);
                                              }}
                                              className="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 p-1"
                                              title="Delete product"
                                            >
                                              <Icons.X />
                                            </button>
                                          </div>
                                        </div>

                                        {/* Key Metrics Grid */}
                                        <div className="grid grid-cols-3 gap-2 text-xs mb-2">
                                          {/* Sales */}
                                          <div className={`p-2 rounded ${sales > 0 ? 'bg-green-50' : 'bg-red-50'}`}>
                                            <div className="text-gray-600 text-xs">Sales</div>
                                            <div className={`font-bold ${sales > 0 ? 'text-green-700' : 'text-red-600'}`}>
                                              {sales} sold
                                            </div>
                                          </div>

                                          {/* Stock */}
                                          <div className={`p-2 rounded ${stockColor}`}>
                                            <div className="text-gray-600 text-xs">Stock</div>
                                            <div className="font-bold">
                                              {stock} {stockStatus}
                                            </div>
                                            {daysRemaining !== Infinity && daysRemaining < 30 && (
                                              <div className="text-xs">{daysRemaining}d left</div>
                                            )}
                                          </div>

                                          {/* Margin */}
                                          <div className="p-2 rounded bg-blue-50">
                                            <div className="text-gray-600 text-xs">Margin</div>
                                            <div className="font-bold text-blue-700">
                                              {margin.toFixed(0)}%
                                            </div>
                                            <div className="text-xs text-gray-600">${((product.price - product.cost) * sales).toFixed(2)}</div>
                                          </div>
                                        </div>

                                        {/* Warnings & Alerts */}
                                        {isDeadStock && (
                                          <div className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded mb-1 font-semibold">
                                            ⚠️ DEAD STOCK: {stock} units, 0 sales!
                                          </div>
                                        )}
                                        {!isDeadStock && stock > 0 && daysRemaining < 7 && (
                                          <div className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mb-1">
                                            ⏰ Running low: {daysRemaining} days left
                                          </div>
                                        )}

                                        {/* Price & Turnover */}
                                        <div className="flex justify-between text-xs text-gray-600 mt-2 pt-2 border-t">
                                          <span>${product.price.toFixed(2)}</span>
                                          {stock > 0 && (
                                            <span title="Inventory turnover rate">Turnover: {turnoverRate}×</span>
                                          )}
                                        </div>

                                        {/* Tags */}
                                        {product.tags && (
                                          <div className="mt-2 flex flex-wrap gap-1">
                                            {product.tags.split(',').slice(0, 3).map((tag, idx) => (
                                              <span key={idx} className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">
                                                {tag.trim()}
                                              </span>
                                            ))}
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      )}
                    </div>

                    <div className="space-y-2 mb-3 border-t pt-3">
                      {/* 🔥 STICKY ROW MODE CONTROLS */}
                      <div className="space-y-2 mb-3">
                        {/* Sticky Mode Toggle */}
                        <div className="flex items-center justify-between p-2 bg-gradient-to-r from-blue-50 to-purple-50 rounded border border-blue-200">
                          <div className="flex items-center gap-2">
                            <span className="text-sm font-semibold">🔒 Sticky Row Mode</span>
                            <button
                              onClick={() => setStickyRowMode(!stickyRowMode)}
                              className={`px-3 py-1 rounded text-xs font-bold transition-all ${
                                stickyRowMode 
                                  ? 'bg-green-500 text-white' 
                                  : 'bg-gray-300 text-gray-600'
                              }`}
                            >
                              {stickyRowMode ? 'ON' : 'OFF'}
                            </button>
                          </div>
                          {stickyRowMode && newProduct.rowId && selectedSection === section.id && (
                            <span className="text-xs text-green-600 font-semibold">
                              ✓ Row locked
                            </span>
                          )}
                        </div>

                        {/* Current Row Indicator */}
                        {newProduct.rowId && selectedSection === section.id && (
                          <div className="p-3 bg-yellow-50 border-2 border-yellow-300 rounded">
                            <div className="text-xs text-gray-600 mb-1">Scanning into:</div>
                            <div className="text-lg font-bold text-yellow-800">
                              {(() => {
                                const row = section.rows?.find(r => r.id === newProduct.rowId);
                                return row ? `${section.name} - ${row.name}` : 'Unknown Row';
                              })()}
                            </div>
                            {stickyRowMode && (
                              <div className="text-xs text-yellow-600 mt-1">
                                Keep scanning! Row stays selected. Use Ctrl+↑/↓ to switch rows.
                              </div>
                            )}
                          </div>
                        )}
                      </div>

                      <input
                        ref={selectedSection === section.id ? upcInputRef : null}
                        type="text"
                        placeholder="Scan or enter UPC (select a row first)"
                        value={selectedSection === section.id ? newProduct.upc : ''}
                        onChange={(e) => {
                          setSelectedSection(section.id);
                          setNewProduct({ ...newProduct, upc: e.target.value, sectionId: section.id });
                        }}
                        className="w-full px-3 py-2 border rounded text-sm"
                        onKeyPress={(e) => {
                          if (e.key === 'Enter' && newProduct.upc && newProduct.rowId) {
                            addProductToSection();
                          }
                        }}
                      />
                      {(!newProduct.rowId || !stickyRowMode) && (
                        <button
                          onClick={() => {
                            if (!newProduct.rowId) {
                              setFeedback('⚠️ Select a row first');
                              setTimeout(() => setFeedback(''), 2000);
                              return;
                            }
                            addProductToSection();
                          }}
                          disabled={scanning || !newProduct.upc || !newProduct.rowId}
                          className="w-full px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 text-sm"
                        >
                          {scanning ? 'Adding...' : newProduct.rowId ? 'Add Product to Row' : 'Select Row First'}
                        </button>
                      )}
                    </div>

                    <div className="space-y-2">
                      {section.products.map((product, idx) => (
                        <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                          <div className="flex-1">
                            <div className="font-medium">{product.name}</div>
                            <div className="text-xs text-gray-600">
                              ${product.price} | Qty: {product.quantity}
                            </div>
                          </div>
                          
                          <div className="flex gap-1">
                            <button
                              onClick={() => updateProductQuantity(section.id, idx, -1)}
                              className="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300"
                            >
                              -
                            </button>
                            <button
                              onClick={() => updateProductQuantity(section.id, idx, 1)}
                              className="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300"
                            >
                              +
                            </button>
                            
                            <button
                              onClick={() => deleteProduct(section.id, idx)}
                              className="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                              title="Delete"
                            >
                              🗑️
                            </button>
                          </div>
                        </div>
                      ))}
                      
                      {/* Unknown Products for this section - inline */}
                      {unknownProducts.filter(u => !u.resolved).length > 0 && (
                        <div className="mt-3 pt-3 border-t">
                          <div 
                            className="flex items-center justify-between cursor-pointer hover:bg-yellow-50 p-2 rounded -mx-2 mb-2"
                            onClick={(e) => {
                              e.stopPropagation();
                              e.preventDefault();
                              const newCollapsed = new Set(collapsedUnknownProducts);
                              newCollapsed.delete('all'); // Remove 'all' flag when manually toggling
                              if (newCollapsed.has(section.id)) {
                                newCollapsed.delete(section.id);
                              } else {
                                newCollapsed.add(section.id);
                              }
                              setCollapsedUnknownProducts(newCollapsed);
                            }}
                          >
                            <div className="text-xs font-bold text-yellow-700">
                              ⚠️ UNKNOWN PRODUCTS ({unknownProducts.filter(u => !u.resolved).length})
                            </div>
                            <span className="text-lg text-yellow-600 font-bold">
                              {(collapsedUnknownProducts.has('all') || collapsedUnknownProducts.has(section.id)) ? '▶' : '▼'}
                            </span>
                          </div>
                          
                          {!(collapsedUnknownProducts.has('all') || collapsedUnknownProducts.has(section.id)) && (
                            <>
                      {unknownProducts.filter(u => !u.resolved).map(unknown => (
                        <div key={unknown.id} className="flex items-center justify-between p-2 bg-yellow-50 border border-yellow-300 rounded text-sm">
                          <div className="flex-1">
                            <div className="font-medium text-yellow-800">⚠️ Unknown UPC: {unknown.upc}</div>
                            <input
                              type="text"
                              value={unknown.note || ''}
                              onChange={(e) => updateUnknownProductNote(unknown.id, e.target.value)}
                              placeholder="Enter product name..."
                              className="mt-1 w-full px-2 py-1 text-xs border border-yellow-400 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500 bg-white"
                            />
                          </div>
                          
                          <div className="flex gap-1 ml-2">
                            <button
                              onClick={checkUnknownAgainstShopify}
                              className="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                              title="Check Shopify"
                            >
                              🔄
                            </button>
                            <button
                              onClick={() => deleteUnknownProduct(unknown.id)}
                              className="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                              title="Delete"
                            >
                              🗑️
                            </button>
                          </div>
                        </div>
                      ))}
                      </>
                      )}
                        </div>
                      )}
                    </div>
                      </>
                    )}
                  </div>
                );
              })}
          </div>
        </div>
      )}

      {showSettings && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h2 className="text-2xl font-bold mb-4">🛍️ Shopify Connection</h2>

            {shopifyConfig.connected && (
              <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm">
                <div className="font-semibold mb-2">💡 Two Refresh Options:</div>
                <div className="space-y-2 text-xs text-gray-700">
                  <div className="p-2 bg-white rounded border border-blue-200">
                    <div className="font-semibold text-blue-700">🔄 Refresh Product Cache</div>
                    <div>• Updates the backend database with ALL products from Shopify</div>
                    <div>• Takes 3-5 minutes for large catalogs</div>
                    <div>• Run this FIRST if you just deployed backend updates</div>
                    <div>• Watch progress in Render logs</div>
                  </div>
                  <div className="p-2 bg-white rounded border border-green-200">
                    <div className="font-semibold text-green-700">🔄 Update My Products</div>
                    <div>• Updates products in YOUR planogram with latest data</div>
                    <div>• Adds vendor/brand info to existing products</div>
                    <div>• Takes ~1 minute (only updates what's in your fixtures)</div>
                    <div>• <strong>Keeps all your layout work!</strong></div>
                  </div>
                </div>
              </div>
            )}

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Store Name</label>
                <input
                  type="text"
                  value={shopifyConfig.storeName}
                  onChange={(e) => setShopifyConfig({ ...shopifyConfig, storeName: e.target.value })}
                  placeholder="your-store.myshopify.com"
                  className="w-full px-3 py-2 border rounded"
                  disabled={shopifyConfig.connected}
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Admin API Access Token</label>
                <input
                  type="password"
                  value={shopifyConfig.accessToken}
                  onChange={(e) => setShopifyConfig({ ...shopifyConfig, accessToken: e.target.value })}
                  placeholder="shpat_xxxxx..."
                  className="w-full px-3 py-2 border rounded"
                  disabled={shopifyConfig.connected}
                />
              </div>

              <div className="flex gap-2">
                {!shopifyConfig.connected ? (
                  <button
                    onClick={testShopifyConnection}
                    className="flex-1 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                  >
                    Test Connection
                  </button>
                ) : (
                  <>
                    <button
                      onClick={refreshProductCache}
                      disabled={isRefreshing}
                      className={`flex-1 px-4 py-2 rounded flex items-center justify-center gap-2 ${
                        isRefreshing 
                          ? 'bg-gray-400 cursor-not-allowed' 
                          : 'bg-blue-500 hover:bg-blue-600'
                      } text-white`}
                    >
                      <Icons.RefreshCw />
                      {isRefreshing ? 'Refreshing... (Check Render Logs)' : 'Refresh Product Cache'}
                    </button>
                    <button
                      onClick={refreshAllProductData}
                      disabled={isRefreshing}
                      className={`flex-1 px-4 py-2 rounded flex items-center justify-center gap-2 ${
                        isRefreshing 
                          ? 'bg-gray-400 cursor-not-allowed' 
                          : 'bg-green-500 hover:bg-green-600'
                      } text-white`}
                    >
                      <Icons.RefreshCw />
                      {isRefreshing ? 'Updating...' : 'Update My Products'}
                    </button>
                    <button
                      onClick={disconnectShopify}
                      disabled={isRefreshing}
                      className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Disconnect
                    </button>
                  </>
                )}
              </div>

              {shopifyConfig.connected && (
                <div className="p-3 bg-green-100 text-green-800 rounded">
                  ✅ Connected
                </div>
              )}
            </div>

            <button
              onClick={() => setShowSettings(false)}
              className="mt-4 w-full px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
            >
              Close
            </button>
          </div>
        </div>
      )}
    </div>
    </>
    )}

      {/* 📊 DASHBOARD PAGE */}
      {currentPage === 'dashboard' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-3xl font-bold">📊 Store Analytics Dashboard</h1>
              <p className="text-gray-600 mt-1">Real-time insights from your planogram data</p>
            </div>
            
            {/* Time Period Filter */}
            <div className="bg-white rounded-lg shadow-lg px-4 py-3 flex items-center gap-3">
              <span className="text-sm font-semibold text-gray-700">📅 Period:</span>
              <select
                value={timePeriod}
                onChange={(e) => setTimePeriod(e.target.value)}
                className="px-3 py-2 bg-white border-2 border-blue-300 rounded text-sm font-medium hover:border-blue-500 focus:outline-none focus:border-blue-600 cursor-pointer"
              >
                <option value="day">📅 Daily</option>
                <option value="week">📅 Weekly</option>
                <option value="month">📅 Monthly</option>
                <option value="quarter">📅 Quarterly</option>
                <option value="year">📅 Yearly</option>
                <option value="all">📅 All Time</option>
                <option value="custom">📅 Custom Range</option>
              </select>
              
              {/* Custom Date Range Picker */}
              {timePeriod === 'custom' && (
                <div className="flex items-center gap-2 ml-2">
                  <input
                    type="date"
                    value={customStartDate}
                    onChange={(e) => setCustomStartDate(e.target.value)}
                    className="px-3 py-2 border-2 border-blue-300 rounded text-sm focus:outline-none focus:border-blue-600"
                  />
                  <span className="text-gray-600">to</span>
                  <input
                    type="date"
                    value={customEndDate}
                    onChange={(e) => setCustomEndDate(e.target.value)}
                    className="px-3 py-2 border-2 border-blue-300 rounded text-sm focus:outline-none focus:border-blue-600"
                  />
                </div>
              )}
            </div>
          </div>
          
          {/* Quick Stats Row */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">💰 Total Revenue</div>
              <div className="text-3xl font-bold">
                ${sections.reduce((sum, s) => {
                  const metrics = calculateMetrics(s, timePeriod);
                  return sum + metrics.totalRevenue;
                }, 0).toFixed(2)}
              </div>
              <div className="text-xs opacity-75 mt-2">
                {timePeriod === 'day' ? 'Today' : 
                 timePeriod === 'week' ? 'This Week' :
                 timePeriod === 'month' ? 'This Month' :
                 timePeriod === 'quarter' ? 'This Quarter' :
                 timePeriod === 'year' ? 'This Year' : 'All Time'}
              </div>
            </div>
            
            <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">📦 Units Sold</div>
              <div className="text-3xl font-bold">
                {sections.reduce((sum, s) => {
                  const metrics = calculateMetrics(s, timePeriod);
                  return sum + metrics.totalVolume;
                }, 0).toFixed(0)}
              </div>
              <div className="text-xs opacity-75 mt-2">Total items</div>
            </div>
            
            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">💎 Profit</div>
              <div className="text-3xl font-bold">
                ${sections.reduce((sum, s) => {
                  const metrics = calculateMetrics(s, timePeriod);
                  return sum + metrics.totalProfit;
                }, 0).toFixed(2)}
              </div>
              <div className="text-xs opacity-75 mt-2">Total margin</div>
            </div>
            
            <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">🏆 Best Product</div>
              <div className="text-base font-bold truncate">
                {(() => {
                  let bestProduct = null;
                  let maxRevenue = 0;
                  sections.forEach(s => {
                    const metrics = calculateMetrics(s, timePeriod);
                    metrics.productMetrics.forEach(p => {
                      if (p.periodRevenue > maxRevenue) {
                        maxRevenue = p.periodRevenue;
                        bestProduct = p;
                      }
                    });
                  });
                  return bestProduct ? (
                    <>
                      <div className="truncate">{bestProduct.name.substring(0, 25)}{bestProduct.name.length > 25 ? '...' : ''}</div>
                      <div className="text-xs opacity-75 font-normal mt-1">
                        {bestProduct.sku ? `SKU: ${bestProduct.sku}` : bestProduct.upc ? `UPC: ${bestProduct.upc}` : 'No SKU/UPC'}
                      </div>
                    </>
                  ) : 'N/A';
                })()}
              </div>
              <div className="text-xs opacity-75 mt-2">Top revenue generator</div>
            </div>
          </div>

          {/* Main Analytics Grid */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            {/* 🏆 Fixture Performance Ranking */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                🏆 Fixture Performance
                <span className="text-sm font-normal text-gray-500">(by profit)</span>
              </h2>
              <div className="space-y-3">
                {(fixtures || []).map(fixture => {
                  const fixtureSections = sections.filter(s => s.fixtureId === fixture.id);
                  const totalProfit = fixtureSections.reduce((sum, s) => {
                    const metrics = calculateMetrics(s, timePeriod);
                    return sum + metrics.totalProfit;
                  }, 0);
                  const totalRevenue = fixtureSections.reduce((sum, s) => {
                    const metrics = calculateMetrics(s, timePeriod);
                    return sum + metrics.totalRevenue;
                  }, 0);
                  return { fixture, totalProfit, totalRevenue };
                }).sort((a, b) => b.totalProfit - a.totalProfit).map(({ fixture, totalProfit, totalRevenue }, idx) => (
                  <div key={fixture.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div className="flex items-center gap-3">
                      <div className={`text-2xl ${idx === 0 ? '' : idx === 1 ? '' : idx === 2 ? '' : ''}`}>
                        {idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `#${idx + 1}`}
                      </div>
                      <div>
                        <div className="font-semibold">{fixture.name}</div>
                        <div className="text-xs text-gray-500">Revenue: ${totalRevenue.toFixed(2)}</div>
                      </div>
                    </div>
                    <div className={`font-bold text-lg ${totalProfit > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                      ${totalProfit.toFixed(2)}
                    </div>
                  </div>
                ))}
                {fixtures.length === 0 && (
                  <div className="text-gray-400 text-center py-8">No fixtures added yet</div>
                )}
              </div>
            </div>

            {/* 🔥 Section Performance */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                🔥 Top Sections
                <span className="text-sm font-normal text-gray-500">(by revenue)</span>
              </h2>
              <div className="space-y-3">
                {(sections || []).map(section => {
                  const metrics = calculateMetrics(section, timePeriod);
                  return { section, metrics };
                }).sort((a, b) => b.metrics.totalRevenue - a.metrics.totalRevenue).slice(0, 10).map(({ section, metrics }, idx) => (
                  <div key={section.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div className="flex items-center gap-3">
                      <div className="text-lg font-bold text-gray-400">#{idx + 1}</div>
                      <div>
                        <div className="font-semibold">{section.name}</div>
                        <div className="text-xs text-gray-500">
                          {section.rows ? section.rows.reduce((sum, row) => sum + (row.products?.length || 0), 0) : section.products?.length || 0} products • ${metrics.profitPerSqFt.toFixed(2)}/sq ft
                        </div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold text-green-600">${metrics.totalRevenue.toFixed(2)}</div>
                      <div className="text-xs text-gray-500">{metrics.totalVolume} units</div>
                    </div>
                  </div>
                ))}
                {sections.length === 0 && (
                  <div className="text-gray-400 text-center py-8">No sections added yet</div>
                )}
              </div>
            </div>

            {/* 🤝 Best Upsell Combinations */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4">🤝 Best Upsell Combinations</h2>
              <p className="text-sm text-gray-500 mb-4">Products actually bought together (from order data)</p>
              <div className="space-y-4">
                {productCorrelations.length > 0 ? (
                  productCorrelations.slice(0, 10).map((corr, idx) => (
                    <div key={idx} className="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="flex-1 min-w-0">
                          <div className="font-semibold text-sm truncate">{corr.productA.name}</div>
                          <div className="text-xs text-gray-500">{corr.productA.upc || 'No UPC'}</div>
                        </div>
                        <span className="text-blue-600 font-bold">+</span>
                        <div className="flex-1 min-w-0">
                          <div className="font-semibold text-sm truncate">{corr.productB.name}</div>
                          <div className="text-xs text-gray-500">{corr.productB.upc || 'No UPC'}</div>
                        </div>
                      </div>
                      <div className="flex items-center justify-between mt-3 pt-3 border-t border-blue-200">
                        <div className="text-xs text-gray-600">
                          Bought together <strong>{corr.timesBoughtTogether}</strong> times
                        </div>
                        <div className="text-sm font-bold text-green-600">
                          ${(corr.productA.price + corr.productB.price).toFixed(2)} bundle price
                        </div>
                      </div>
                      <div className="mt-2 p-2 bg-blue-100 rounded text-xs text-blue-800">
                        💡 <strong>Action:</strong> Place these products near each other • Create a bundle deal
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="p-8 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200 text-center">
                    <div className="text-4xl mb-3">🤝</div>
                    <div className="font-bold text-lg mb-2">No Correlation Data Yet</div>
                    <div className="text-sm text-gray-600">
                      Click <strong>🔥 Orders</strong> button to analyze which products are bought together
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* 💰 Revenue by Time Period */}
            {/* ⏰ When Do People Buy? */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4">⏰ When Do People Buy?</h2>
              <p className="text-sm text-gray-500 mb-4">Sales patterns by time of day and day of month</p>
              
              {orderAnalytics ? (
                <div className="space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-sm font-semibold mb-2">📊 Sales by Hour</div>
                      <div className="space-y-1">
                        {orderAnalytics.byHour.map((hourData) => (
                          <div key={hourData.hour} className="flex items-center gap-2">
                            <span className="text-xs w-20">{hourData.label}</span>
                            <div className="flex-1 bg-gray-200 rounded h-4">
                              <div 
                                className="bg-blue-500 h-full rounded transition-all"
                                style={{ width: `${(hourData.count / orderAnalytics.maxHourly * 100)}%` }}
                              />
                            </div>
                            <span className="text-xs w-12 text-right text-gray-600">{hourData.count}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    <div>
                      <div className="text-sm font-semibold mb-2">📅 Sales by Day of Month</div>
                      <div className="space-y-1">
                        {orderAnalytics.byDayOfMonth.map((dayData) => (
                          <div key={dayData.range} className="flex items-center gap-2">
                            <span className="text-xs w-12">{dayData.range}</span>
                            <div className="flex-1 bg-gray-200 rounded h-4">
                              <div 
                                className="bg-green-500 h-full rounded transition-all"
                                style={{ width: `${(dayData.count / orderAnalytics.maxDaily * 100)}%` }}
                              />
                            </div>
                            <span className="text-xs w-12 text-right text-gray-600">{dayData.count}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4 pt-4 border-t">
                    <div className="text-center p-4 bg-blue-50 rounded-lg">
                      <div className="text-2xl font-bold text-blue-600">{orderAnalytics.peakHour}</div>
                      <div className="text-sm text-gray-600">Peak Shopping Hour</div>
                    </div>
                    <div className="text-center p-4 bg-green-50 rounded-lg">
                      <div className="text-2xl font-bold text-green-600">{orderAnalytics.peakDayRange}</div>
                      <div className="text-sm text-gray-600">Peak Days of Month</div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="space-y-6">
                  <div className="p-8 bg-gradient-to-br from-orange-50 to-red-50 rounded-lg border-2 border-orange-200 text-center">
                    <div className="text-4xl mb-3">🔥</div>
                    <div className="font-bold text-lg mb-2">Import Order Data to Unlock</div>
                    <div className="text-sm text-gray-600 mb-4">
                      Click the <strong>🔥 Orders</strong> button in Store Planner to analyze:
                    </div>
                    <div className="space-y-2 text-left max-w-md mx-auto">
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-green-500">✓</span>
                        <span><strong>Peak Shopping Hours</strong> - Best times for staffing</span>
                      </div>
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-green-500">✓</span>
                        <span><strong>Popular Days of Month</strong> - When customers have money</span>
                      </div>
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-green-500">✓</span>
                        <span><strong>Weekend vs Weekday</strong> - Traffic patterns</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Preview/Example Charts */}
                  <div className="grid grid-cols-2 gap-4 opacity-50">
                    <div>
                      <div className="text-sm font-semibold mb-2">📊 Sales by Hour (Preview)</div>
                      <div className="space-y-1">
                        {['12am-6am', '6am-9am', '9am-12pm', '12pm-3pm', '3pm-6pm', '6pm-9pm', '9pm-12am'].map((hour, idx) => (
                          <div key={hour} className="flex items-center gap-2">
                            <span className="text-xs w-20">{hour}</span>
                            <div className="flex-1 bg-gray-200 rounded h-4">
                              <div 
                                className="bg-blue-400 h-full rounded"
                                style={{ width: `${[20, 40, 80, 90, 70, 95, 60][idx]}%` }}
                              />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    <div>
                      <div className="text-sm font-semibold mb-2">📅 Sales by Day of Month (Preview)</div>
                      <div className="space-y-1">
                        {['1-5', '6-10', '11-15', '16-20', '21-25', '26-31'].map((days, idx) => (
                          <div key={days} className="flex items-center gap-2">
                            <span className="text-xs w-12">{days}</span>
                            <div className="flex-1 bg-gray-200 rounded h-4">
                              <div 
                                className="bg-green-400 h-full rounded"
                                style={{ width: `${[85, 60, 95, 70, 40, 30][idx]}%` }}
                              />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

          </div>
        </div>
      )}

      {/* 📈 FORECASTING PAGE */}
      {currentPage === 'forecasting' && (
        <div className="flex-1 overflow-auto p-8">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">📈 Demand Forecasting & Inventory Intelligence</h1>
            <p className="text-gray-600">AI-powered predictions to prevent stockouts and optimize inventory</p>
          </div>

          {/* Filters */}
          <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div className="flex gap-4 flex-wrap items-center">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Group By</label>
                <select
                  value={forecastGroupBy}
                  onChange={(e) => setForecastGroupBy(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                >
                  <option value="all">All Products</option>
                  <option value="fixture">By Fixture</option>
                  <option value="brand">By Brand</option>
                </select>
              </div>

              {/* Specific Fixture Filter */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Fixture</label>
                <select
                  value={forecastFilterFixture}
                  onChange={(e) => setForecastFilterFixture(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Fixtures</option>
                  {(fixtures || []).map(fixture => (
                    <option key={fixture.id} value={fixture.id}>{fixture.name}</option>
                  ))}
                </select>
              </div>

              {/* Specific Brand Filter */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Brand</label>
                <select
                  value={forecastFilterBrand}
                  onChange={(e) => setForecastFilterBrand(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Brands</option>
                  {(() => {
                    const allProducts = sections.flatMap(section => {
                      const products = section.rows ? 
                        section.rows.flatMap(row => row.products || []) : 
                        (section.products || []);
                      return products;
                    });
                    const brands = [...new Set(allProducts.map(p => {
                      const vendor = p.vendor?.trim();
                      return vendor && vendor !== '' ? vendor : 'Unknown Brand';
                    }))].sort();
                    return brands.map(brand => (
                      <option key={brand} value={brand}>{brand}</option>
                    ));
                  })()}
                </select>
              </div>

              {/* Specific Distributor Filter */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Distributor</label>
                <select
                  value={forecastFilterDistributor}
                  onChange={(e) => setForecastFilterDistributor(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Distributors</option>
                  {(() => {
                    const allProducts = sections.flatMap(section => {
                      const products = section.rows ? 
                        section.rows.flatMap(row => row.products || []) : 
                        (section.products || []);
                      return products;
                    });
                    const distributors = [...new Set(allProducts.map(p => {
                      const dist = p.distributor?.trim();
                      return dist && dist !== '' ? dist : 'Unknown Distributor';
                    }))].sort();
                    return distributors.map(dist => (
                      <option key={dist} value={dist}>{dist}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Time Period</label>
                <select
                  value={timePeriod}
                  onChange={(e) => setTimePeriod(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                >
                  <option value="week">Last Week</option>
                  <option value="month">Last Month</option>
                  <option value="quarter">Last Quarter</option>
                  <option value="year">Last Year</option>
                </select>
              </div>

              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Sort By</label>
                <select
                  value={forecastSortBy}
                  onChange={(e) => setForecastSortBy(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                >
                  <option value="stockoutRisk">Stockout Risk</option>
                  <option value="velocity">Sales Velocity</option>
                  <option value="daysUntilOut">Days Until Out</option>
                  <option value="reorderQty">Reorder Quantity</option>
                </select>
              </div>

              {/* Clear Filters Button */}
              {(forecastFilterFixture !== 'all' || forecastFilterBrand !== 'all' || forecastFilterDistributor !== 'all') && (
                <div className="pt-5">
                  <button
                    onClick={() => {
                      setForecastFilterFixture('all');
                      setForecastFilterBrand('all');
                      setForecastFilterDistributor('all');
                    }}
                    className="px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 flex items-center gap-1"
                  >
                    <Icons.X />
                    Clear Filters
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Forecasting Content */}
          {(() => {
            // Gather all products from all sections
            let allProducts = sections.flatMap(section => {
              const products = section.rows ? 
                section.rows.flatMap(row => row.products || []) : 
                (section.products || []);
              
              return products.map(p => ({
                ...p,
                sectionId: section.id,
                sectionName: section.name,
                fixtureId: section.fixtureId,
                fixtureName: fixtures.find(f => f.id === section.fixtureId)?.name || 'Unknown'
              }));
            });

            // Apply filters BEFORE calculating forecasts
            if (forecastFilterFixture !== 'all') {
              allProducts = allProducts.filter(p => p.fixtureId === forecastFilterFixture);
            }
            
            if (forecastFilterBrand !== 'all') {
              allProducts = allProducts.filter(p => {
                const vendor = p.vendor?.trim();
                const brand = vendor && vendor !== '' ? vendor : 'Unknown Brand';
                return brand === forecastFilterBrand;
              });
            }

            if (forecastFilterDistributor !== 'all') {
              allProducts = allProducts.filter(p => {
                const dist = p.distributor?.trim();
                const distributor = dist && dist !== '' ? dist : 'Unknown Distributor';
                return distributor === forecastFilterDistributor;
              });
            }

            // Calculate forecasting metrics for each product
            const productsWithForecasts = allProducts.map(product => {
              // Get sales velocity based on time period
              let salesVolume = 0;
              let daysInPeriod = 30;
              
              switch(timePeriod) {
                case 'day':
                  salesVolume = product.dailySales || 0;
                  daysInPeriod = 1;
                  break;
                case 'week':
                  salesVolume = product.weeklySales || 0;
                  daysInPeriod = 7;
                  break;
                case 'month':
                  salesVolume = product.monthlySales || 0;
                  daysInPeriod = 30;
                  break;
                case 'quarter':
                  salesVolume = product.quarterlySales || 0;
                  daysInPeriod = 90;
                  break;
                case 'year':
                  salesVolume = product.yearlySales || 0;
                  daysInPeriod = 365;
                  break;
                default:
                  salesVolume = product.monthlySales || 0;
                  daysInPeriod = 30;
              }

              const dailyVelocity = daysInPeriod > 0 ? salesVolume / daysInPeriod : 0;
              const currentStock = product.inventoryQuantity || product.quantity || 0;
              const daysUntilOut = dailyVelocity > 0 ? currentStock / dailyVelocity : 999;
              
              // Stock out risk (high risk if < 7 days)
              let stockoutRisk = 'Low';
              let riskColor = 'green';
              if (daysUntilOut < 3) {
                stockoutRisk = 'CRITICAL';
                riskColor = 'red';
              } else if (daysUntilOut < 7) {
                stockoutRisk = 'High';
                riskColor = 'orange';
              } else if (daysUntilOut < 14) {
                stockoutRisk = 'Medium';
                riskColor = 'yellow';
              }

              // Recommended reorder quantity (2 weeks of sales + safety stock of 25%)
              const reorderQty = Math.ceil((dailyVelocity * 14) * 1.25);

              // Seasonal pattern (simplified - compare to average)
              const avgSales = (product.monthlySales || 0);
              const seasonalTrend = salesVolume > avgSales * 1.2 ? '📈 Trending Up' : 
                                   salesVolume < avgSales * 0.8 ? '📉 Trending Down' : 
                                   '➡️ Stable';

              return {
                ...product,
                dailyVelocity,
                daysUntilOut,
                stockoutRisk,
                riskColor,
                reorderQty,
                seasonalTrend,
                salesVolume
              };
            });

            // Group products based on filter
            let groupedData = {};
            
            if (forecastGroupBy === 'fixture') {
              productsWithForecasts.forEach(p => {
                if (!groupedData[p.fixtureName]) {
                  groupedData[p.fixtureName] = [];
                }
                groupedData[p.fixtureName].push(p);
              });
            } else if (forecastGroupBy === 'brand') {
              productsWithForecasts.forEach(p => {
                const vendor = p.vendor?.trim();
                const brand = vendor && vendor !== '' ? vendor : 'Unknown Brand';
                if (!groupedData[brand]) {
                  groupedData[brand] = [];
                }
                groupedData[brand].push(p);
              });
            } else {
              groupedData['All Products'] = productsWithForecasts;
            }

            // Sort products within each group
            Object.keys(groupedData).forEach(groupName => {
              groupedData[groupName].sort((a, b) => {
                switch(forecastSortBy) {
                  case 'stockoutRisk':
                    return a.daysUntilOut - b.daysUntilOut;
                  case 'velocity':
                    return b.dailyVelocity - a.dailyVelocity;
                  case 'daysUntilOut':
                    return a.daysUntilOut - b.daysUntilOut;
                  case 'reorderQty':
                    return b.reorderQty - a.reorderQty;
                  default:
                    return 0;
                }
              });
            });

            // Calculate summary stats
            const totalProducts = productsWithForecasts.length;
            const criticalStock = productsWithForecasts.filter(p => p.stockoutRisk === 'CRITICAL').length;
            const highRisk = productsWithForecasts.filter(p => p.stockoutRisk === 'High').length;
            const avgVelocity = productsWithForecasts.length > 0 
              ? productsWithForecasts.reduce((sum, p) => sum + p.dailyVelocity, 0) / productsWithForecasts.length 
              : 0;

            return (
              <>
                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow-lg p-4 border-2 border-red-300">
                    <div className="text-red-600 font-bold text-sm mb-1">🚨 CRITICAL ALERTS</div>
                    <div className="text-3xl font-bold text-red-700">{criticalStock}</div>
                    <div className="text-xs text-red-600 mt-1">Out in &lt;3 days</div>
                  </div>

                  <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow-lg p-4 border-2 border-orange-300">
                    <div className="text-orange-600 font-bold text-sm mb-1">⚠️ HIGH RISK</div>
                    <div className="text-3xl font-bold text-orange-700">{highRisk}</div>
                    <div className="text-xs text-orange-600 mt-1">Out in &lt;7 days</div>
                  </div>

                  <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-4 border-2 border-blue-300">
                    <div className="text-blue-600 font-bold text-sm mb-1">📦 TOTAL PRODUCTS</div>
                    <div className="text-3xl font-bold text-blue-700">{totalProducts}</div>
                    <div className="text-xs text-blue-600 mt-1">Being tracked</div>
                  </div>

                  <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-4 border-2 border-green-300">
                    <div className="text-green-600 font-bold text-sm mb-1">⚡ AVG VELOCITY</div>
                    <div className="text-3xl font-bold text-green-700">{avgVelocity.toFixed(1)}</div>
                    <div className="text-xs text-green-600 mt-1">units/day</div>
                  </div>
                </div>

                {/* Grouped Product Tables */}
                <div className="space-y-6">
                  {Object.keys(groupedData).sort().map(groupName => {
                    const products = groupedData[groupName];
                    if (products.length === 0) return null;

                    return (
                      <div key={groupName} className="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4">
                          <h2 className="text-xl font-bold">{groupName}</h2>
                          <div className="text-sm opacity-90 mt-1">{products.length} products</div>
                        </div>

                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead className="bg-gray-100 border-b-2 border-gray-300">
                              <tr>
                                <th className="text-left p-3 text-xs font-bold text-gray-700">PRODUCT</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">STOCK</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">VELOCITY</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">DAYS LEFT</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">RISK</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">REORDER QTY</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">TREND</th>
                                <th className="text-left p-3 text-xs font-bold text-gray-700">LOCATION</th>
                              </tr>
                            </thead>
                            <tbody>
                              {products.map((product, idx) => (
                                <tr 
                                  key={idx} 
                                  className={`border-b hover:bg-gray-50 ${
                                    product.riskColor === 'red' ? 'bg-red-50' :
                                    product.riskColor === 'orange' ? 'bg-orange-50' :
                                    product.riskColor === 'yellow' ? 'bg-yellow-50' : ''
                                  }`}
                                >
                                  <td className="p-3">
                                    <div className="font-semibold text-sm">{product.name}</div>
                                    <div className="text-xs text-gray-500">{product.sku || product.upc || 'No SKU'}</div>
                                    <div className="text-xs text-gray-400">{product.vendor || ''}</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className={`font-bold ${product.quantity < 10 ? 'text-red-600' : 'text-gray-700'}`}>
                                      {product.quantity || 0}
                                    </div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className="font-semibold text-blue-600">
                                      {product.dailyVelocity.toFixed(1)}
                                    </div>
                                    <div className="text-xs text-gray-500">per day</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className={`font-bold ${
                                      product.daysUntilOut < 3 ? 'text-red-600' :
                                      product.daysUntilOut < 7 ? 'text-orange-600' :
                                      product.daysUntilOut < 14 ? 'text-yellow-600' :
                                      'text-green-600'
                                    }`}>
                                      {product.daysUntilOut >= 999 ? '∞' : Math.floor(product.daysUntilOut)}
                                    </div>
                                    <div className="text-xs text-gray-500">days</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                                      product.riskColor === 'red' ? 'bg-red-200 text-red-800' :
                                      product.riskColor === 'orange' ? 'bg-orange-200 text-orange-800' :
                                      product.riskColor === 'yellow' ? 'bg-yellow-200 text-yellow-800' :
                                      'bg-green-200 text-green-800'
                                    }`}>
                                      {product.stockoutRisk}
                                    </span>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className="font-bold text-purple-600">
                                      {product.reorderQty}
                                    </div>
                                    <div className="text-xs text-gray-500">units</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className="text-sm">{product.seasonalTrend}</div>
                                  </td>
                                  <td className="p-3">
                                    <div className="text-xs text-gray-600">{product.fixtureName}</div>
                                    <div className="text-xs text-gray-400">{product.sectionName}</div>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {totalProducts === 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                    <div className="text-6xl mb-4">📦</div>
                    <h3 className="text-2xl font-bold text-gray-700 mb-2">No Products to Forecast</h3>
                    <p className="text-gray-500">Add products to your planogram to see demand forecasting!</p>
                  </div>
                )}
              </>
            );
          })()}
        </div>
      )}

      {/* ⚙️ SETTINGS PAGE */}
      {currentPage === 'rowAnalytics' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">📊 Row Analytics - Shelf Performance</h1>
            <p className="text-gray-600">Analyze performance by shelf with detailed metrics</p>
          </div>
          
          {/* Filters */}
          <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div className="flex flex-wrap items-center gap-4">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Fixture</label>
                <select
                  value={rowFilterFixture}
                  onChange={(e) => setRowFilterFixture(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Fixtures</option>
                  {(sections || []).map(section => (
                    <option key={section.id} value={section.id}>{section.name}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Brand</label>
                <select
                  value={rowFilterBrand}
                  onChange={(e) => setRowFilterBrand(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Brands</option>
                  {(() => {
                    const allProducts = sections.flatMap(section => 
                      (section.rows || []).flatMap(row => row.products || [])
                    );
                    const brands = [...new Set(allProducts.map(p => p.vendor?.trim() || 'Unknown Brand'))].sort();
                    return brands.map(brand => (
                      <option key={brand} value={brand}>{brand}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Distributor</label>
                <select
                  value={rowFilterDistributor}
                  onChange={(e) => setRowFilterDistributor(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Distributors</option>
                  {(() => {
                    const allProducts = sections.flatMap(section => 
                      (section.rows || []).flatMap(row => row.products || [])
                    );
                    const distributors = [...new Set(allProducts.map(p => p.distributor?.trim() || 'Unknown Distributor'))].sort();
                    return distributors.map(dist => (
                      <option key={dist} value={dist}>{dist}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Sort By</label>
                <select
                  value={rowSortBy}
                  onChange={(e) => setRowSortBy(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="profit">Highest Profit</option>
                  <option value="sales">Most Sales</option>
                  <option value="products">Most Products</option>
                  <option value="stock">Most Stock</option>
                </select>
              </div>
              
              {(rowFilterFixture !== 'all' || rowFilterBrand !== 'all' || rowFilterDistributor !== 'all') && (
                <div className="pt-5">
                  <button
                    onClick={() => {
                      setRowFilterFixture('all');
                      setRowFilterBrand('all');
                      setRowFilterDistributor('all');
                    }}
                    className="px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 flex items-center gap-1"
                  >
                    <span>×</span> Clear Filters
                  </button>
                </div>
              )}
            </div>
          </div>
          
          {sections.length === 0 ? (
            <div className="bg-white rounded-lg shadow-lg p-8 text-center">
              <p className="text-gray-500 text-lg">No fixtures created yet. Go to Store Planner to create your first fixture!</p>
            </div>
          ) : (
            <div className="space-y-6">
              {sections
                .filter(section => rowFilterFixture === 'all' || section.id === rowFilterFixture)
                .map((section) => {
                  if (!section.rows || section.rows.length === 0) return null;
                  
                  // Filter and sort rows
                  const filteredRows = section.rows.map((row, rowIndex) => {
                    let products = row.products || [];
                    
                    // Apply brand filter
                    if (rowFilterBrand !== 'all') {
                      products = products.filter(p => (p.vendor?.trim() || 'Unknown Brand') === rowFilterBrand);
                    }
                    
                    // Apply distributor filter
                    if (rowFilterDistributor !== 'all') {
                      products = products.filter(p => (p.distributor?.trim() || 'Unknown Distributor') === rowFilterDistributor);
                    }
                    
                    const totalProducts = products.length;
                    const totalSales = products.reduce((sum, p) => sum + (p.monthlySales || 0), 0);
                    const totalProfit = products.reduce((sum, p) => {
                      const profit = (p.price || 0) - (p.cost || 0);
                      return sum + (profit * (p.monthlySales || 0));
                    }, 0);
                    const totalStock = products.reduce((sum, p) => sum + (p.inventoryQuantity || 0), 0);
                    
                    return {
                      rowIndex,
                      products,
                      totalProducts,
                      totalSales,
                      totalProfit,
                      totalStock
                    };
                  })
                  .filter(row => row.totalProducts > 0) // Only show rows with products after filtering
                  .sort((a, b) => {
                    switch(rowSortBy) {
                      case 'profit': return b.totalProfit - a.totalProfit;
                      case 'sales': return b.totalSales - a.totalSales;
                      case 'products': return b.totalProducts - a.totalProducts;
                      case 'stock': return b.totalStock - a.totalStock;
                      default: return 0;
                    }
                  });
                  
                  if (filteredRows.length === 0) return null;
                  
                  return (
                  <div key={section.id} className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4">{section.name}</h2>
                    
                    <div className="space-y-4">
                      {filteredRows.map((rowData) => {
                        const { rowIndex, products, totalProducts, totalSales, totalProfit, totalStock } = rowData;
                        const lowStockCount = products.filter(p => (p.inventoryQuantity || 0) < 10).length;
                        
                        // Determine row color based on performance
                        const bgColor = rowIndex % 2 === 0 
                          ? 'bg-yellow-50 border-yellow-300' 
                          : 'bg-green-50 border-green-300';
                        
                        return (
                          <div key={rowIndex} className={`${bgColor} border-2 rounded-lg p-4`}>
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-xl font-bold">Row {rowIndex + 1}</h3>
                              {lowStockCount > 0 && (
                                <span className="px-3 py-1 bg-red-500 text-white rounded-full text-sm font-bold">
                                  ⚠️ {lowStockCount} Low Stock
                                </span>
                              )}
                            </div>
                            
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Products</div>
                                <div className="text-2xl font-bold">{totalProducts}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Monthly Sales</div>
                                <div className="text-2xl font-bold text-green-600">{totalSales}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Monthly Profit</div>
                                <div className="text-2xl font-bold text-blue-600">${totalProfit.toFixed(2)}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Total Stock</div>
                                <div className="text-2xl font-bold">{totalStock} {lowStockCount > 0 && <span className="text-red-500">⚠️{lowStockCount}</span>}</div>
                              </div>
                            </div>
                            
                            {/* Top 5 Products in Row */}
                            {products.length > 0 && (
                              <div>
                                <h4 className="font-semibold mb-2 text-gray-700">Top 5 Products by Sales:</h4>
                                <div className="space-y-2">
                                  {products
                                    .sort((a, b) => (b.monthlySales || 0) - (a.monthlySales || 0))
                                    .slice(0, 5)
                                    .map((product, idx) => {
                                      const profit = (product.price || 0) - (product.cost || 0);
                                      const monthlyProfit = profit * (product.monthlySales || 0);
                                      
                                      return (
                                        <div key={idx} className="bg-white rounded p-3 shadow-sm flex items-center justify-between">
                                          <div className="flex-1">
                                            <div className="font-semibold text-sm">{product.name}</div>
                                            <div className="text-xs text-gray-500">
                                              {product.vendor || 'Unknown Brand'} • SKU: {product.sku || product.upc}
                                            </div>
                                          </div>
                                          <div className="flex items-center gap-4 text-sm">
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Sales</div>
                                              <div className="font-bold text-green-600">{product.monthlySales || 0}</div>
                                            </div>
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Profit</div>
                                              <div className="font-bold text-blue-600">${monthlyProfit.toFixed(2)}</div>
                                            </div>
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Stock</div>
                                              <div className={`font-bold ${(product.inventoryQuantity || 0) < 10 ? 'text-red-500' : 'text-gray-700'}`}>
                                                {product.inventoryQuantity || 0}
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* 📦 BAD STOCK PAGE */}
      {currentPage === 'badStock' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">📦 Bad Stock</h1>
            <p className="text-gray-600">Products with negative inventory that need stock verification and updates</p>
          </div>

          {/* Analytics Cards */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Bad Stock</div>
              <div className="text-3xl font-bold text-red-600">
                {badStockProducts.filter(b => !b.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Resolved</div>
              <div className="text-3xl font-bold text-green-600">
                {badStockProducts.filter(b => b.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Avg. Negative Stock</div>
              <div className="text-3xl font-bold text-orange-600">
                {badStockProducts.filter(b => !b.resolved).length > 0 
                  ? Math.round(badStockProducts.filter(b => !b.resolved).reduce((sum, b) => sum + (b.inventoryQuantity || 0), 0) / badStockProducts.filter(b => !b.resolved).length)
                  : 0}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Negative Units</div>
              <div className="text-3xl font-bold text-gray-800">
                {badStockProducts.filter(b => !b.resolved).reduce((sum, b) => sum + Math.abs(b.inventoryQuantity || 0), 0)}
              </div>
            </div>
          </div>

          {/* Action Info */}
          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <p className="text-blue-800">
              <strong>💡 Workflow:</strong> These products have negative inventory counts in Shopify. Review each item, verify physical stock, and update Shopify inventory accordingly. Mark as resolved when fixed.
            </p>
          </div>

          {/* Bad Stock List */}
          <div className="space-y-4">
            {badStockProducts.filter(b => !b.resolved).length === 0 ? (
              <div className="bg-white rounded-lg shadow p-8 text-center">
                <div className="text-4xl mb-4">✅</div>
                <div className="text-xl font-semibold text-gray-800">All stock verified!</div>
                <div className="text-gray-600 mt-2">No negative stock issues found.</div>
              </div>
            ) : (
              badStockProducts.filter(b => !b.resolved).map(badStock => {
                // Find which section and row this product is in
                let location = null;
                sections.forEach(section => {
                  section.rows?.forEach(row => {
                    const product = row.products?.find(p => p.upc === badStock.upc);
                    if (product) {
                      location = { sectionName: section.name, rowName: row.name };
                    }
                  });
                });

                return (
                  <div key={badStock.id} className="bg-red-50 border-2 border-red-300 rounded-lg shadow p-6">
                    <div className="flex items-start gap-6">
                      {/* UPC & Location */}
                      <div className="flex-shrink-0">
                        <div className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded mb-2">
                          ⚠️ NEGATIVE STOCK: {badStock.inventoryQuantity}
                        </div>
                        <div className="text-sm text-gray-600 mb-1">UPC</div>
                        <div className="font-mono text-lg font-bold">{badStock.upc}</div>
                        {location && (
                          <div className="mt-2 text-xs text-gray-600">
                            📍 {location.sectionName} → {location.rowName}
                          </div>
                        )}
                        <div className="text-xs text-gray-500 mt-1">
                          Detected {new Date(badStock.addedAt).toLocaleDateString()}
                        </div>
                      </div>

                      {/* Note Field */}
                      <div className="flex-1">
                        <div className="text-sm text-gray-600 mb-1">Product Info / Notes</div>
                        <input
                          type="text"
                          value={badStock.note || ''}
                          onChange={(e) => updateBadStockNote(badStock.id, e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              e.preventDefault();
                              console.log('Enter pressed - saving immediately!');
                              saveToFirebase(sections);
                              setFeedback('💾 Saved!');
                              setTimeout(() => setFeedback(''), 2000);
                            }
                          }}
                          placeholder="Add notes about stock verification..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      {/* Actions */}
                      <div className="flex-shrink-0 flex gap-2">
                        <button
                          onClick={() => resolveBadStock(badStock.id)}
                          className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center gap-1"
                          title="Mark as Resolved"
                        >
                          ✓ Resolved
                        </button>
                        <button
                          onClick={() => deleteBadStockProduct(badStock.id)}
                          className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                          title="Delete"
                        >
                          <Icons.Trash2 />
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* Resolved Bad Stock */}
          {badStockProducts.filter(b => b.resolved).length > 0 && (
            <div className="mt-8">
              <h2 className="text-2xl font-bold mb-4">✅ Recently Resolved</h2>
              <div className="space-y-2">
                {badStockProducts.filter(b => b.resolved).map(badStock => (
                  <div key={badStock.id} className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between">
                    <div className="flex-1">
                      <div className="font-semibold text-green-800">{badStock.note || `UPC: ${badStock.upc}`}</div>
                      <div className="text-sm text-gray-600">
                        Previous Stock: {badStock.inventoryQuantity}
                      </div>
                    </div>
                    <button
                      onClick={() => deleteBadStockProduct(badStock.id)}
                      className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                    >
                      Remove
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {currentPage === 'settings' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">⚙️ Settings</h1>
          
          <div className="max-w-2xl space-y-6">
            {/* Shopify Connection */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">🛍️ Shopify Connection</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Store Name</label>
                  <input
                    type="text"
                    value={shopifyConfig.storeName}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, storeName: e.target.value})}
                    placeholder="your-store.myshopify.com"
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Admin API Access Token</label>
                  <input
                    type="password"
                    value={shopifyConfig.accessToken}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, accessToken: e.target.value})}
                    placeholder="shpat_..."
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <button
                  onClick={testShopifyConnection}
                  className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-semibold"
                >
                  Test Connection
                </button>
                
                {shopifyConfig.connected && (
                  <div className="p-3 bg-green-100 text-green-800 rounded">
                    ✅ Connected
                  </div>
                )}
              </div>
            </div>
            
            {/* Additional Settings Placeholder */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">🎨 Display Settings</h2>
              <p className="text-gray-600">More settings coming soon...</p>
            </div>
          </div>
        </div>
      )}

      {/* 🔍 FIND PRODUCT PAGE */}
      {currentPage === 'findProduct' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="max-w-3xl mx-auto">
            <div className="mb-8 text-center">
              <h1 className="text-4xl font-bold mb-2">🔍 Find Product Location</h1>
              <p className="text-gray-600">Scan or enter a UPC to see which section and row it's in</p>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <input
                type="text"
                placeholder="Scan or enter UPC..."
                value={searchUPC}
                onChange={(e) => setSearchUPC(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && searchUPC.trim()) {
                    // Search for product in all sections and rows
                    let found = null;
                    for (const section of sections) {
                      if (section.rows) {
                        for (const row of section.rows) {
                          const product = row.products?.find(p => p.upc === searchUPC.trim());
                          if (product) {
                            const fixture = fixtures.find(f => f.id === section.fixtureId);
                            found = {
                              product,
                              section,
                              row,
                              fixture
                            };
                            break;
                          }
                        }
                      }
                      if (found) break;
                    }
                    setSearchResults(found);
                  }
                }}
                className="w-full px-4 py-4 text-2xl border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-center font-mono"
                autoFocus
              />
              <div className="text-center text-sm text-gray-500 mt-2">
                Press Enter to search
              </div>
            </div>

            {/* Results */}
            {searchResults && (
              <div className="bg-green-50 border-2 border-green-500 rounded-lg p-8 shadow-lg">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">✅</div>
                  <h2 className="text-3xl font-bold text-green-800 mb-2">Product Found!</h2>
                </div>
                
                <div className="space-y-4">
                  <div className="bg-white rounded-lg p-4">
                    <div className="text-sm text-gray-600">Product</div>
                    <div className="text-2xl font-bold">{searchResults.product.name}</div>
                    <div className="text-gray-600 mt-1">UPC: {searchResults.product.upc}</div>
                  </div>

                  <div className="bg-white rounded-lg p-4">
                    <div className="text-sm text-gray-600">Location</div>
                    <div className="text-xl font-bold text-blue-600">
                      📍 {searchResults.fixture?.name || 'Unknown Fixture'} → {searchResults.section.name} → {searchResults.row.name}
                    </div>
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                    <div className="bg-white rounded-lg p-4">
                      <div className="text-xs text-gray-600">Price</div>
                      <div className="text-xl font-bold text-green-600">${searchResults.product.price?.toFixed(2) || '0.00'}</div>
                    </div>
                    <div className="bg-white rounded-lg p-4">
                      <div className="text-xs text-gray-600">Stock</div>
                      <div className="text-xl font-bold">{searchResults.product.inventoryQuantity || 0}</div>
                    </div>
                    <div className="bg-white rounded-lg p-4">
                      <div className="text-xs text-gray-600">Monthly Sales</div>
                      <div className="text-xl font-bold text-blue-600">{searchResults.product.monthlySales || 0}</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {searchResults === null && searchUPC && (
              <div className="bg-red-50 border-2 border-red-500 rounded-lg p-8 shadow-lg text-center">
                <div className="text-6xl mb-4">❌</div>
                <h2 className="text-3xl font-bold text-red-800 mb-2">Product Not Found</h2>
                <p className="text-gray-600">UPC "{searchUPC}" is not in any section or row</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ⚠️ UNKNOWN PRODUCTS PAGE */}
      {currentPage === 'unknownProducts' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">⚠️ Unknown Products</h1>
            <p className="text-gray-600">Products that need to be synced with Shopify</p>
          </div>

          {/* Analytics Cards */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Unknown</div>
              <div className="text-3xl font-bold text-orange-600">
                {unknownProducts.filter(u => !u.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Resolved</div>
              <div className="text-3xl font-bold text-green-600">
                {unknownProducts.filter(u => u.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">With Notes</div>
              <div className="text-3xl font-bold text-blue-600">
                {unknownProducts.filter(u => !u.resolved && u.note).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Store Products</div>
              <div className="text-3xl font-bold text-gray-800">
                {sections.reduce((total, section) => {
                  return total + (section.rows?.reduce((rowTotal, row) => {
                    return rowTotal + (row.products?.length || 0);
                  }, 0) || 0);
                }, 0)}
              </div>
              <div className="text-xs text-gray-500 mt-1">
                {((unknownProducts.filter(u => !u.resolved).length / Math.max(1, sections.reduce((total, section) => {
                  return total + (section.rows?.reduce((rowTotal, row) => {
                    return rowTotal + (row.products?.length || 0);
                  }, 0) || 0);
                }, 0))) * 100).toFixed(1)}% unsynced
              </div>
            </div>
          </div>

          {/* Actions Bar */}
          <div className="flex gap-2 mb-6">
            <button
              onClick={checkUnknownAgainstShopify}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-2"
            >
              <Icons.RefreshCw />
              Check All Against Shopify
            </button>
          </div>

          {/* Unknown Products List */}
          <div className="space-y-4">
            {unknownProducts.filter(u => !u.resolved).length === 0 ? (
              <div className="bg-white rounded-lg shadow p-8 text-center">
                <div className="text-4xl mb-4">🎉</div>
                <div className="text-xl font-semibold text-gray-800">All products synced!</div>
                <div className="text-gray-600 mt-2">No unknown products found.</div>
              </div>
            ) : (
              unknownProducts.filter(u => !u.resolved).map(unknown => {
                // Find which section and row this product is in
                let location = null;
                sections.forEach(section => {
                  section.rows?.forEach(row => {
                    const product = row.products?.find(p => p.upc === unknown.upc);
                    if (product) {
                      location = { sectionName: section.name, rowName: row.name };
                    }
                  });
                });

                return (
                  <div key={unknown.id} className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-start gap-6">
                      {/* UPC & Location */}
                      <div className="flex-shrink-0">
                        <div className="text-sm text-gray-600 mb-1">UPC</div>
                        <div className="font-mono text-lg font-bold">{unknown.upc}</div>
                        {location && (
                          <div className="mt-2 text-xs text-gray-600">
                            📍 {location.sectionName} → {location.rowName}
                          </div>
                        )}
                        <div className="text-xs text-gray-500 mt-1">
                          Added {new Date(unknown.addedAt).toLocaleDateString()}
                        </div>
                      </div>

                      {/* Note Field */}
                      <div className="flex-1">
                        <div className="text-sm text-gray-600 mb-1">Product Name / Notes</div>
                        <input
                          type="text"
                          value={unknown.note || ''}
                          onChange={(e) => updateUnknownProductNote(unknown.id, e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              e.preventDefault();
                              console.log('Enter pressed - saving immediately!');
                              saveToFirebase(sections);
                              setFeedback('💾 Saved!');
                              setTimeout(() => setFeedback(''), 2000);
                            }
                          }}
                          placeholder="Enter product name or description..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      {/* Actions */}
                      <div className="flex-shrink-0 flex gap-2">
                        <button
                          onClick={checkUnknownAgainstShopify}
                          className="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-1"
                          title="Check if now in Shopify"
                        >
                          <Icons.RefreshCw />
                          Check
                        </button>
                        <button
                          onClick={() => deleteUnknownProduct(unknown.id)}
                          className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                          title="Delete"
                        >
                          <Icons.Trash2 />
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* Resolved Products */}
          {unknownProducts.filter(u => u.resolved).length > 0 && (
            <div className="mt-8">
              <h2 className="text-2xl font-bold mb-4">✅ Recently Resolved</h2>
              <div className="space-y-2">
                {unknownProducts.filter(u => u.resolved).map(unknown => (
                  <div key={unknown.id} className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between">
                    <div className="flex-1">
                      <div className="font-semibold text-green-800">{unknown.matchedProduct?.name}</div>
                      <div className="text-sm text-gray-600">
                        UPC: {unknown.upc} • {unknown.matchedProduct?.vendor} • ${unknown.matchedProduct?.price}
                      </div>
                    </div>
                    <button
                      onClick={() => deleteUnknownProduct(unknown.id)}
                      className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                    >
                      Remove
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

    createRoot(document.getElementById('root')).render(<PlanogramProfitTracker />);
  </script>
</body>
</html>
