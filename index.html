<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Planogram Profit Tracker - v3 Complete</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Firebase Configuration and Service -->
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>
  
  <!-- D3.js for network visualizations -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /* üçé Apple-Inspired Design System */
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #f5f5f7;
    }
    
    /* Glassmorphism Cards */
    .apple-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .apple-card:hover {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    /* Apple Buttons */
    .apple-button {
      background: linear-gradient(180deg, #007aff 0%, #0051d5 100%);
      border: none;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      transition: all 0.2s ease;
      font-weight: 500;
      letter-spacing: -0.01em;
    }
    
    .apple-button:hover {
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
      transform: translateY(-1px);
    }
    
    .apple-button:active {
      transform: scale(0.98);
    }
    
    .apple-button-secondary {
      background: rgba(0, 0, 0, 0.04);
      color: #1d1d1f;
      border: 1px solid rgba(0, 0, 0, 0.08);
      transition: all 0.2s ease;
    }
    
    .apple-button-secondary:hover {
      background: rgba(0, 0, 0, 0.06);
    }
    
    /* Apple Inputs */
    .apple-input {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      transition: all 0.2s ease;
      font-size: 15px;
      letter-spacing: -0.01em;
    }
    
    .apple-input:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }
    
    /* Smooth Scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    
    /* Typography */
    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: -0.02em;
      color: #1d1d1f;
    }
    
    /* Smooth Transitions */
    .smooth-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Compact Toolbar Buttons */
    .toolbar-compact button {
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
      font-size: 0.8rem !important;
    }
    
    .toolbar-compact select {
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
      font-size: 0.8rem !important;
    }
    
    /* Toolbar horizontal scroll */
    .toolbar-compact {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    .toolbar-compact::-webkit-scrollbar {
      height: 4px;
    }
    
    .toolbar-compact::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .toolbar-compact::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
  </style>
</head>
  
<body>
  <div id="root"></div>

  <!-- Firebase Configuration - Inline -->
  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyDfHWJMZV6uE-zEo8sXqGxV8K7NqGxK0Qs",
      authDomain: "planogram-tracker.firebaseapp.com",
      databaseURL: "https://planogram-tracker-default-rtdb.firebaseio.com",
      projectId: "planogram-tracker",
      storageBucket: "planogram-tracker.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

// Custom Icons
const Icons = {
  Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
  Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
  Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
  Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
  Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
  Package: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
  BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
  DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
  Maximize2: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
  Grid3x3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
  Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>,
  Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
  AlignVertical: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="16" width="14" height="6" rx="2"></rect><rect x="7" y="2" width="10" height="6" rx="2"></rect><path d="M2 12h20"></path></svg>,
  Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
  Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
  Flame: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>,
  RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
  X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
  FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
  Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>,
  AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
  Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
};

const FIXTURE_TYPES = {
  GRID_WALL: {
    id: 'grid_wall',
    name: 'Grid Wall',
    icon: 'Grid3x3',
    color: '#64748b',
    defaultWidth: 120,
    defaultHeight: 200
  },
  JEWELRY_CASE: {
    id: 'jewelry_case',
    name: 'Jewelry Case',
    icon: 'Box',
    color: '#8b5cf6',
    defaultWidth: 100,
    defaultHeight: 80
  },
  GONDOLA: {
    id: 'gondola',
    name: 'Gondola',
    icon: 'Layers',
    color: '#ef4444',
    defaultWidth: 14,  // 14 inches deep
    defaultHeight: 57.5  // 57.5 inches high
  },
  SLAT_WALL: {
    id: 'slat_wall',
    name: 'Slat Wall',
    icon: 'AlignVertical',
    color: '#f59e0b',
    defaultWidth: 150,
    defaultHeight: 180
  },
  END_CAP: {
    id: 'end_cap',
    name: 'End Cap',
    icon: 'Package',
    color: '#10b981',
    defaultWidth: 80,
    defaultHeight: 120
  },
  JEWELRY_DISPLAY: {
    id: 'jewelry_display',
    name: 'Jewelry Display',
    icon: 'Box',
    color: '#fbbf24',
    defaultWidth: 90,
    defaultHeight: 90
  },
  MAKEUP_WALL: {
    id: 'makeup_wall',
    name: 'Makeup Wall',
    icon: 'Grid3x3',
    color: '#ff1493',
    defaultWidth: 200,
    defaultHeight: 220
  }
};

const getCursor = (position) => {
  const cursors = {
    'nw': 'nwse-resize', 'ne': 'nesw-resize', 'se': 'nwse-resize', 'sw': 'nesw-resize',
    'n': 'ns-resize', 's': 'ns-resize', 'e': 'ew-resize', 'w': 'ew-resize'
  };
  return cursors[position];
};

const getHandlePosition = (position) => {
  const positions = {
    'nw': { top: -6, left: -6, width: '12px', height: '12px' },
    'n': { top: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'ne': { top: -6, right: -6, width: '12px', height: '12px' },
    'e': { right: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' },
    'se': { bottom: -6, right: -6, width: '12px', height: '12px' },
    's': { bottom: -6, left: '50%', transform: 'translateX(-50%)', width: '60px', height: '12px' },
    'sw': { bottom: -6, left: -6, width: '12px', height: '12px' },
    'w': { left: -6, top: '50%', transform: 'translateY(-50%)', width: '12px', height: '60px' }
  };
  return positions[position];
};

const PlanogramProfitTracker = () => {
  console.log('üöÄ Store Planner Pro - Component Loaded');
  console.log('üìÖ Timestamp:', new Date().toISOString());
  
  const [fixtures, setFixtures] = useState([]);
  const [selectedFixture, setSelectedFixture] = useState(null);
  const [sections, setSections] = useState([]);
  const [selectedSection, setSelectedSection] = useState(null);
  const [selectedRow, setSelectedRow] = useState(null);
  const [scale, setScale] = useState(20);
  const [storeName, setStoreName] = useState('My Store Layout');
  const [newProduct, setNewProduct] = useState({ upc: '', sectionId: '', rowId: '' });
  const [scanning, setScanning] = useState(false);
  const [savedLayouts, setSavedLayouts] = useState([]);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [showLoadModal, setShowLoadModal] = useState(false);
  const [feedback, setFeedback] = useState('');
  const [syncProgress, setSyncProgress] = useState({ message: '', current: 0, total: 0 });
  const [timeFilter, setTimeFilter] = useState('monthly');
  const [sortBy, setSortBy] = useState('profit');
  const [showSettings, setShowSettings] = useState(false);
  const [shopifyConfig, setShopifyConfig] = useState({
    storeName: '1m3tfh-xt.myshopify.com',
    accessToken: '',
    connected: false
  });
  const [firebaseReady, setFirebaseReady] = useState(false);
  const [stickyRowMode, setStickyRowMode] = useState(true); // NEW: Sticky row scanning mode
  const [unknownProducts, setUnknownProducts] = useState([]);
  const [badStockProducts, setBadStockProducts] = useState([]); // NEW: Separate list for negative stock items
  const [allDatabaseProducts, setAllDatabaseProducts] = useState([]); // NEW: All products from database for forecasting
  const [loadingAllProducts, setLoadingAllProducts] = useState(false); // NEW: Loading state
  const [loadingMessage, setLoadingMessage] = useState(''); // For bulk UPC sync loading state
  const [showUnknownProducts, setShowUnknownProducts] = useState(true);
  const [selectedFixtures, setSelectedFixtures] = useState([]); // Multi-select fixtures
  const [shiftPressed, setShiftPressed] = useState(false); // Track shift key for multi-select

  // Discount feature state
  const [discountConfig, setDiscountConfig] = useState({
    method: 'compare_at_price', // 'compare_at_price' or 'discount_code'
    type: 'percentage', // 'percentage' or 'fixed'
    value: 20,
    target: 'all', // 'all', 'sections', 'fixture', 'product', 'selected_products'
    targetId: '',
    selectedSections: [], // Array of section IDs for multi-select
    selectedProducts: [], // Array of UPCs for selected products
    codeName: 'SAVE20',
    autoApply: true, // Auto-apply at cart (automatic discount) or require code entry
    startDate: new Date().toISOString().split('T')[0],
    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  });
  const [discountImpact, setDiscountImpact] = useState(null);
  const [showProductSelector, setShowProductSelector] = useState(false);

  // üÜï SAVED LAYOUTS STATE (rest of the state - savedLayouts already declared above)
  const [showSaveLayoutModal, setShowSaveLayoutModal] = useState(false); // Save modal
  const [showLoadLayoutModal, setShowLoadLayoutModal] = useState(false); // Load modal
  const [showCompareModal, setShowCompareModal] = useState(false); // Compare modal
  const [compareData, setCompareData] = useState(null); // Comparison results
  const [compareSelectedSection, setCompareSelectedSection] = useState(null); // Selected section in compare view
  const [compareSearchTerm, setCompareSearchTerm] = useState(''); // Search products in compare
  
  // SECTION VERSION CONTROL
  const [showSaveSectionModal, setShowSaveSectionModal] = useState(false);
  const [showSectionHistoryPanel, setShowSectionHistoryPanel] = useState(false);
  const [sectionVersions, setSectionVersions] = useState([]); // All versions of selected section
  const [selectedSectionForHistory, setSelectedSectionForHistory] = useState(null);
  const [sectionVersionName, setSectionVersionName] = useState('');
  const [savingSectionVersion, setSavingSectionVersion] = useState(false);
  const [loadingSectionVersions, setLoadingSectionVersions] = useState(false);
  const [compareSectionVersions, setCompareSectionVersions] = useState(null); // {version1, version2}
  
  // Firebase Cleanup
  const [showCleanupModal, setShowCleanupModal] = useState(false);
  const [allFirebaseItems, setAllFirebaseItems] = useState([]);
  const [loadingFirebaseItems, setLoadingFirebaseItems] = useState(false);
  
  // Load Modal state already declared above - removed duplicate
  const [loadingPlanogram, setLoadingPlanogram] = useState(false);
  
  const [layoutNameInput, setLayoutNameInput] = useState(''); // Input for layout name
  const [savingLayout, setSavingLayout] = useState(false); // Loading state for save
  const [loadingLayouts, setLoadingLayouts] = useState(false); // Loading state for load

  // Debug helper - expose data to window for debugging
  useEffect(() => {
    window.debugStorePlanner = {
      sections,
      fixtures,
      discountConfig,
      discountImpact,
      logData: () => {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üêõ DEBUG DATA DUMP');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('Fixtures:', fixtures);
        console.log('Sections:', sections);
        console.log('Discount Config:', discountConfig);
        console.log('Discount Impact:', discountImpact);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        // Log sample products
        if (sections.length > 0) {
          sections.forEach((section, idx) => {
            console.log(`\nSection ${idx}: ${section.name}`);
            if (section.rows && section.rows.length > 0) {
              section.rows.forEach((row, rIdx) => {
                if (row.products && row.products.length > 0) {
                  console.log(`  Row ${rIdx}: ${row.products.length} products`);
                  console.log('  Sample product:', row.products[0]);
                }
              });
            }
          });
        }
      }
    };
    
    console.log('üîß Debug helper installed. Type "window.debugStorePlanner.logData()" in console to see all data');
  }, [sections, fixtures, discountConfig, discountImpact]);

  // üöÄ AUTO-LOAD DATA ON STARTUP
  useEffect(() => {
    const autoLoadData = async () => {
      // Only auto-load if Shopify is connected
      if (!shopifyConfig.connected) {
        console.log('‚è≠Ô∏è Skipping auto-load: Shopify not connected');
        return;
      }

      console.log('üöÄ Auto-loading data on startup...');
      
      // Wait a bit for the planogram to load first
      setTimeout(async () => {
        try {
          // Load products first (needed for everything else)
          await refreshProductCache(true);
          
          // Then load sales data
          await refreshSalesOnly();
          
          // Load orders for analytics (can be slow, so do last)
          await refreshOrders();
          
          console.log('‚úÖ Auto-load complete!');
        } catch (error) {
          console.error('‚ùå Auto-load error:', error);
        }
      }, 2000); // Wait 2 seconds for Firebase/planogram to load
    };

    autoLoadData();
  }, [shopifyConfig.connected]); // Only run when Shopify connection changes

  // Initialize Firebase on mount
  useEffect(() => {
    // Simple timer-based fallback - if Firebase doesn't load in 3 seconds, mark as ready anyway
    const fallbackTimer = setTimeout(() => {
      if (!firebaseReady) {
        console.log('‚ö†Ô∏è Firebase timeout - proceeding with localStorage only');
        setFirebaseReady(true);
      }
    }, 3000);

    const initFirebase = async () => {
      try {
        if (window.firebaseService) {
          clearTimeout(fallbackTimer);
          await window.firebaseService.initialize();
          await window.firebaseService.signInAnonymously();
          setFirebaseReady(true);
          console.log('Firebase ready');
          
          // Auto-load the most recent planogram from cloud
          // EMERGENCY FIX: Skip auto-load if URL has ?skipload=true
          const urlParams = new URLSearchParams(window.location.search);
          const skipAutoLoad = urlParams.get('skipload') === 'true';
          
          if (!skipAutoLoad) {
            setTimeout(async () => {
              try {
                const planograms = await window.firebaseService.listPlanograms();
                
                if (planograms.length > 0) {
                  // Load the most recent one (first in list)
                  const mostRecent = planograms[0];
                  const data = await window.firebaseService.loadPlanogram(mostRecent.id);
                
                if (data) {
                  setStoreName(data.name || 'Loaded Layout');
                  setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
                  
                  const safeSections = Array.isArray(data.sections) 
                    ? data.sections.map(section => ({
                        ...section,
                        length: section.length || 48,
                        depth: section.depth || 30,
                        height: section.height || 72,
                        area: section.area || ((section.length || 48) * (section.depth || 30)) / 144,
                        rows: Array.isArray(section.rows) ? section.rows : [],
                        products: Array.isArray(section.products) ? section.products : []
                      }))
                    : [];
                  setSections(safeSections);
                  
                  // Load unknown products if they exist
                  if (data.unknownProducts) {
                    setUnknownProducts(Array.isArray(data.unknownProducts) ? data.unknownProducts : []);
                  }
                  
                  // Load bad stock products if they exist
                  if (data.badStockProducts) {
                    setBadStockProducts(Array.isArray(data.badStockProducts) ? data.badStockProducts : []);
                  }
                  
                  if (data.shopifyConfig) {
                    setShopifyConfig(prev => ({
                      ...prev,
                      storeName: data.shopifyConfig.storeName || prev.storeName,
                      connected: data.shopifyConfig.connected || false
                    }));
                  }
                  
                  console.log('‚úÖ Auto-loaded from cloud:', mostRecent.name);
                }
              }
            } catch (error) {
              console.log('Auto-load skipped:', error.message);
              alert('Could not auto-load planogram due to large data size. Use ?skipload=true in URL to skip auto-load and delete old data.');
            }
          }, 1000); // Wait 1 second for Firebase to fully initialize
          } else {
            console.log('üö´ Auto-load disabled via URL parameter');
            alert('Auto-load disabled. You can now manually manage your planograms without hitting the size limit.');
          }
        }
      } catch (error) {
        console.error('Firebase init failed:', error);
      }
    };
    initFirebase();
    
    return () => clearTimeout(fallbackTimer);
  }, []);

  // üî• KEYBOARD SHORTCUTS for row switching
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Only when sticky mode is on and a section/row is selected
      if (!stickyRowMode || !newProduct.sectionId) return;
      
      // Ctrl+Up: Switch to previous row
      if (e.ctrlKey && e.key === 'ArrowUp') {
        e.preventDefault();
        const section = sections.find(s => s.id === newProduct.sectionId);
        if (!section?.rows) return;
        
        const currentRowIndex = section.rows.findIndex(r => r.id === newProduct.rowId);
        if (currentRowIndex > 0) {
          const prevRow = section.rows[currentRowIndex - 1];
          setNewProduct({ ...newProduct, rowId: prevRow.id });
          setFeedback(`‚¨ÜÔ∏è Switched to: ${prevRow.name}`);
          setTimeout(() => setFeedback(''), 1500);
        }
      }
      
      // Ctrl+Down: Switch to next row
      if (e.ctrlKey && e.key === 'ArrowDown') {
        e.preventDefault();
        const section = sections.find(s => s.id === newProduct.sectionId);
        if (!section?.rows) return;
        
        const currentRowIndex = section.rows.findIndex(r => r.id === newProduct.rowId);
        if (currentRowIndex < section.rows.length - 1 && currentRowIndex !== -1) {
          const nextRow = section.rows[currentRowIndex + 1];
          setNewProduct({ ...newProduct, rowId: nextRow.id });
          setFeedback(`‚¨áÔ∏è Switched to: ${nextRow.name}`);
          setTimeout(() => setFeedback(''), 1500);
        }
      }
      
      // Ctrl+S: Quick save to cloud
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveToCloud();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [stickyRowMode, newProduct, sections]);

  // Save to Firebase Cloud
  const saveToCloud = async (silent = false) => {
    if (!firebaseReady) {
      if (!silent) alert('Firebase not ready. Please wait a moment and try again.');
      return;
    }

    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      if (!silent) alert('Firebase authentication failed. Please refresh the page.');
      return;
    }

    try {
      setSyncStatus('üíæ Saving...');
      
      const planogramData = {
        name: storeName,
        fixtures: fixtures,
        sections: sections,
        unknownProducts: unknownProducts,
        badStockProducts: badStockProducts,
        shopifyConfig: {
          storeName: shopifyConfig.storeName,
          connected: shopifyConfig.connected
        }
      };

      const id = await window.firebaseService.savePlanogram(planogramData);
      if (id) {
        const timestamp = new Date().toLocaleTimeString();
        setSyncStatus(`‚òÅÔ∏è Saved at ${timestamp}`);
        setTimeout(() => setSyncStatus(''), 3000);
        console.log(`‚òÅÔ∏è ${silent ? 'Auto-saved' : 'Saved'} at ${timestamp}`);
      }
    } catch (error) {
      console.error('Save failed:', error);
      setSyncStatus('‚ùå Save failed!');
      setTimeout(() => setSyncStatus(''), 3000);
      if (!silent) {
        alert('‚ùå Failed to save to cloud: ' + error.message);
      }
    }
  };

  // Load from Firebase Cloud
  const loadFromCloud = async () => {
    if (!firebaseReady) {
      alert('Firebase not ready. Please wait a moment and try again.');
      return;
    }

    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase authentication failed. Please refresh the page.');
      return;
    }

    try {
      const planograms = await window.firebaseService.listPlanograms();
      
      if (planograms.length === 0) {
        alert('No saved layouts found in cloud.');
        return;
      }

      // Show list to user
      const planogramNames = planograms.map((p, idx) => 
        `${idx + 1}. ${p.name} (${new Date(p.lastModified).toLocaleString()})`
      ).join('\n');
      
      const selection = prompt(`Choose a layout to load:\n\n${planogramNames}\n\nEnter number (1-${planograms.length}):`);
      
      if (selection) {
        const index = parseInt(selection) - 1;
        if (index >= 0 && index < planograms.length) {
          const selectedPlanogram = planograms[index];
          const data = await window.firebaseService.loadPlanogram(selectedPlanogram.id);
          
          if (data) {
            setStoreName(data.name || 'Loaded Layout');
            
            // Ensure fixtures is always an array
            setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
            
            // Ensure sections is always an array and each section has rows array
            const safeSections = Array.isArray(data.sections) 
              ? data.sections.map(section => ({
                  ...section,
                  length: section.length || 48,
                  depth: section.depth || 30,
                  height: section.height || 72,
                  area: section.area || ((section.length || 48) * (section.depth || 30)) / 144,
                  rows: Array.isArray(section.rows) ? section.rows : [],
                  products: Array.isArray(section.products) ? section.products : []
                }))
              : [];
            setSections(safeSections);
            
            // Load unknown products if they exist
            if (data.unknownProducts) {
              setUnknownProducts(Array.isArray(data.unknownProducts) ? data.unknownProducts : []);
            }
            
            // Load bad stock products if they exist
            if (data.badStockProducts) {
              setBadStockProducts(Array.isArray(data.badStockProducts) ? data.badStockProducts : []);
            }
            
            if (data.shopifyConfig) {
              setShopifyConfig(prev => ({
                ...prev,
                storeName: data.shopifyConfig.storeName || prev.storeName,
                connected: data.shopifyConfig.connected || false
              }));
            }
            alert('‚úÖ Layout loaded from cloud!');
          }
        }
      }
    } catch (error) {
      console.error('Load failed:', error);
      alert('‚ùå Failed to load from cloud.');
    }
  };

  // üÜï SAVED LAYOUTS SYSTEM

  // Save current layout with a custom name
  const saveLayoutAs = async (layoutName) => {
    if (!firebaseReady) {
      alert('Firebase not ready. Please wait a moment and try again.');
      return false;
    }

    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase authentication failed. Please refresh the page.');
      return false;
    }

    if (!layoutName || layoutName.trim() === '') {
      alert('Please enter a layout name');
      return false;
    }

    try {
      setSavingLayout(true);
      console.log(`üíæ Starting save for layout: "${layoutName}"`);
      
      // Count products properly
      const productCount = sections.reduce((sum, s) => {
        let rowProducts = 0;
        if (s.rows && Array.isArray(s.rows)) {
          s.rows.forEach(row => {
            if (row.products && Array.isArray(row.products)) {
              rowProducts += row.products.length;
            }
          });
        }
        const directProducts = (s.products?.length || 0);
        return sum + rowProducts + directProducts;
      }, 0);
      
      console.log(`üìä Layout has: ${fixtures.length} fixtures, ${sections.length} sections, ${productCount} products`);
      
      const layoutData = {
        name: layoutName.trim(),
        timestamp: new Date().toISOString(),
        isSavedLayout: true, // Mark this as a saved layout (not the working copy)
        fixtures: fixtures,
        sections: sections,
        unknownProducts: unknownProducts,
        badStockProducts: badStockProducts,
        shopifyConfig: {
          storeName: shopifyConfig.storeName,
          connected: shopifyConfig.connected
        },
        // Add metadata
        metadata: {
          fixtureCount: fixtures.length,
          sectionCount: sections.length,
          productCount: productCount // Use the pre-calculated count
        }
      };

      console.log('üíæ Calling Firebase savePlanogram...');
      console.log('üíæ Layout data being saved:', {
        name: layoutData.name,
        isSavedLayout: layoutData.isSavedLayout,
        timestamp: layoutData.timestamp
      });
      
      // Save to Firebase (let Firebase generate the ID)
      const savedId = await window.firebaseService.savePlanogram(layoutData);
      
      if (!savedId) {
        throw new Error('Firebase did not return an ID - save may have failed');
      }
      
      console.log(`‚úÖ Layout "${layoutName}" saved with ID: ${savedId}`);
      
      // Add to local list immediately (no need to refetch everything!)
      const newLayout = {
        id: savedId,
        name: layoutData.name,
        timestamp: layoutData.timestamp,
        metadata: layoutData.metadata
      };
      setSavedLayouts(prev => {
        const updated = [newLayout, ...prev];
        console.log(`üìù Local state updated - now have ${updated.length} layouts`);
        return updated;
      });
      
      setFeedback(`‚úÖ Layout "${layoutName}" saved!`);
      setTimeout(() => setFeedback(''), 3000);
      
      setSavingLayout(false);
      return true;
    } catch (error) {
      console.error('‚ùå Save layout failed:', error);
      alert('‚ùå Failed to save layout: ' + error.message);
      setSavingLayout(false);
      return false;
    }
  };

  // Get all saved layouts
  const getAllSavedLayouts = async () => {
    if (!firebaseReady || !window.firebaseService) {
      console.log('Firebase not ready, skipping layout list');
      return;
    }

    try {
      setLoadingLayouts(true);
      console.log('üìÇ Fetching all planograms...');
      
      let allPlanograms = [];
      try {
        allPlanograms = await window.firebaseService.listPlanograms();
        console.log(`üìÇ Got ${allPlanograms.length} total planograms`);
      } catch (fetchError) {
        if (fetchError.message && fetchError.message.includes('payload is too large')) {
          console.warn('‚ö†Ô∏è WARNING: Some items in Firebase are too large to load');
          console.warn('‚ö†Ô∏è Use the Cleanup tool to delete oversized items');
          alert('‚ö†Ô∏è WARNING: Firebase has oversized items!\n\nSome saved data is too large to load.\n\nClick "üóëÔ∏è Cleanup Firebase" to delete oversized items.');
          setLoadingLayouts(false);
          return;
        }
        throw fetchError; // Re-throw if it's a different error
      }
      
      // Filter for saved layouts (those marked with isSavedLayout: true)
      const layouts = allPlanograms
        .filter(p => {
          const isSaved = p.isSavedLayout === true;
          if (!isSaved && p.name) {
            console.log(`‚è≠Ô∏è Skipping "${p.name}" - isSavedLayout: ${p.isSavedLayout}`);
          }
          return isSaved;
        })
        .map(p => ({
          id: p.id,
          name: p.name || 'Unnamed Layout',
          timestamp: p.timestamp || p.created || new Date().toISOString(),
          metadata: p.metadata || {}
        }))
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Newest first
      
      console.log(`üìÇ Found ${layouts.length} saved layouts`);
      if (layouts.length > 0) {
        console.log('‚úÖ Saved layouts:', layouts.map(l => l.name));
      }
      setSavedLayouts(layouts);
      setLoadingLayouts(false);
    } catch (error) {
      console.error('‚ùå Failed to load layouts:', error);
      setLoadingLayouts(false);
    }
  };

  // Load a saved layout
  const loadSavedLayout = async (layoutId) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    try {
      setLoadingLayouts(true);
      const data = await window.firebaseService.loadPlanogram(layoutId);
      
      if (data) {
        // Load the layout data
        setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
        
        const safeSections = Array.isArray(data.sections) 
          ? data.sections.map(section => ({
              ...section,
              length: section.length || 48,
              depth: section.depth || 30,
              height: section.height || 72,
              area: section.area || ((section.length || 48) * (section.depth || 30)) / 144,
              rows: Array.isArray(section.rows) ? section.rows : [],
              products: Array.isArray(section.products) ? section.products : []
            }))
          : [];
        setSections(safeSections);
        
        if (data.unknownProducts) {
          setUnknownProducts(Array.isArray(data.unknownProducts) ? data.unknownProducts : []);
        }
        
        if (data.badStockProducts) {
          setBadStockProducts(Array.isArray(data.badStockProducts) ? data.badStockProducts : []);
        }
        
        if (data.shopifyConfig) {
          setShopifyConfig(prev => ({
            ...prev,
            storeName: data.shopifyConfig.storeName || prev.storeName,
            connected: data.shopifyConfig.connected || false
          }));
        }
        
        setFeedback(`‚úÖ Loaded layout: ${data.name}`);
        setTimeout(() => setFeedback(''), 3000);
        console.log(`‚úÖ Loaded layout: ${data.name}`);
        
        setLoadingLayouts(false);
        setShowLoadLayoutModal(false); // Close the modal
        return true;
      }
      
      setLoadingLayouts(false);
      return false;
    } catch (error) {
      console.error('Load layout failed:', error);
      alert('‚ùå Failed to load layout: ' + error.message);
      setLoadingLayouts(false);
      return false;
    }
  };

  // Delete a saved layout
  const deleteSavedLayout = async (layoutId) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    try {
      await window.firebaseService.deletePlanogram(layoutId);
      console.log(`üóëÔ∏è Deleted layout: ${layoutId}`);
      
      // Remove from local list immediately (no need to refetch!)
      setSavedLayouts(prev => prev.filter(layout => layout.id !== layoutId));
      
      setFeedback('‚úÖ Layout deleted');
      setTimeout(() => setFeedback(''), 3000);
      return true;
    } catch (error) {
      console.error('Delete layout failed:', error);
      alert('‚ùå Failed to delete layout: ' + error.message);
      return false;
    }
  };

  // Compare a saved layout to current layout
  const compareLayouts = async (layoutId, layoutName) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    // Auto-timeout after 10 seconds
    const timeoutId = setTimeout(() => {
      console.error('‚ö†Ô∏è Comparison timed out after 10 seconds');
      setLoadingLayouts(false);
      alert('Comparison took too long. Please try again.');
    }, 10000);

    try {
      setLoadingLayouts(true);
      console.log(`üîç Comparing layout: ${layoutName}`);
      console.time('Compare Layout');
      
      const savedData = await window.firebaseService.loadPlanogram(layoutId);
      console.log('‚úÖ Loaded saved data from Firebase');
      
      if (!savedData) {
        clearTimeout(timeoutId);
        alert('Failed to load saved layout for comparison');
        setLoadingLayouts(false);
        return false;
      }

      // Ensure sections and fixtures exist
      const savedFixtures = savedData.fixtures || [];
      const savedSections = savedData.sections || [];
      
      console.log(`Saved layout has ${savedFixtures.length} fixtures, ${savedSections.length} sections`);

      // Compare fixtures (fast)
      const currentFixtureIds = new Set(fixtures.map(f => f.id));
      const savedFixtureIds = new Set(savedFixtures.map(f => f.id));
      
      const addedFixtures = savedFixtures.filter(f => !currentFixtureIds.has(f.id));
      const removedFixtures = fixtures.filter(f => !savedFixtureIds.has(f.id));
      const sameFixtures = savedFixtures.filter(f => currentFixtureIds.has(f.id));

      // Compare sections (fast)
      const currentSectionNames = new Set(sections.map(s => s.name));
      const savedSectionNames = new Set(savedSections.map(s => s.name));
      
      const addedSections = savedSections.filter(s => !currentSectionNames.has(s.name));
      const removedSections = sections.filter(s => !savedSectionNames.has(s.name));

      // Count products (fast)
      const currentProducts = sections.reduce((sum, s) => {
        let count = 0;
        if (s.rows) s.rows.forEach(row => count += (row.products?.length || 0));
        count += (s.products?.length || 0);
        return sum + count;
      }, 0);

      const savedProducts = savedSections.reduce((sum, s) => {
        let count = 0;
        if (s.rows) s.rows.forEach(row => count += (row.products?.length || 0));
        count += (s.products?.length || 0);
        return sum + count;
      }, 0);

      const comparison = {
        layoutName: layoutName,
        layoutId: layoutId,
        savedData: savedData,
        currentSectionMetrics: currentSectionMetrics, // Pre-calculated!
        savedSectionMetrics: savedSectionMetrics, // Pre-calculated!
        current: {
          fixtures: fixtures.length,
          sections: sections.length,
          products: currentProducts
        },
        saved: {
          fixtures: savedFixtures.length,
          sections: savedSections.length,
          products: savedProducts
        },
        changes: {
          addedFixtures: addedFixtures,
          removedFixtures: removedFixtures,
          sameFixtures: sameFixtures.length,
          addedSections: addedSections,
          removedSections: removedSections,
          productDiff: savedProducts - currentProducts
        }
      };

      console.log('üîç Comparison complete:', comparison);
      console.timeEnd('Compare Layout');
      
      clearTimeout(timeoutId);
      
      // Update state
      setCompareData(comparison);
      setLoadingLayouts(false);
      setShowCompareModal(true);
      setShowLoadLayoutModal(false);
      
      return true;
    } catch (error) {
      clearTimeout(timeoutId);
      console.error('‚ùå Compare failed:', error);
      setLoadingLayouts(false); // ALWAYS reset loading state
      alert('‚ùå Failed to compare layout: ' + error.message);
      return false;
    }
  };

  // ========================================
  // SECTION VERSION CONTROL SYSTEM
  // ========================================

  // ULTRA-LIGHTWEIGHT SECTION SAVE (IDs only!)
  const saveCurrentSection = async (section, versionName) => {
    console.log('üîß saveCurrentSection called');
    console.log('  section:', section);
    console.log('  versionName:', versionName);
    
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      console.error('‚ùå Firebase not ready');
      alert('Firebase not ready');
      return false;
    }
    console.log('‚úÖ Firebase is ready');

    if (!versionName || !versionName.trim()) {
      console.error('‚ùå No version name provided');
      alert('Please enter a version name');
      return false;
    }
    console.log('‚úÖ Version name valid');

    try {
      setSavingSectionVersion(true);
      console.log(`üíæ Saving section: ${section.name} - ${versionName}`);

      // Count products
      let totalProducts = 0;
      if (section.rows) {
        section.rows.forEach(row => {
          totalProducts += (row.products?.length || 0);
        });
      }
      totalProducts += (section.products?.length || 0);

      console.log(`üìä Section has ${totalProducts} products`);

      // HARD LIMIT: Max 50 products
      if (totalProducts > 50) {
        console.error(`‚ùå Too many products: ${totalProducts}`);
        alert(`‚ùå TOO MANY PRODUCTS!\n\nSection: ${section.name}\nProducts: ${totalProducts}\nLimit: 50\n\nSplit this section to save it.`);
        setSavingSectionVersion(false);
        return false;
      }
      console.log('‚úÖ Product count within limit');

      // Save ONLY product IDs (not full data!)
      const lightweightRows = (section.rows || []).map(row => ({
        id: row.id,
        name: row.name,
        productIds: (row.products || []).map(p => p.id) // Just IDs!
      }));

      const lightweightProductIds = (section.products || []).map(p => p.id);
      
      console.log(`  Lightweight rows:`, lightweightRows);
      console.log(`  Product IDs:`, lightweightProductIds);

      const versionData = {
        sectionName: section.name,
        versionName: versionName.trim(),
        timestamp: new Date().toISOString(),
        isSectionVersion: true,
        
        // Minimal section structure
        id: section.id,
        fixtureId: section.fixtureId,
        rows: lightweightRows,
        productIds: lightweightProductIds, // Just IDs!
        layoutX: section.layoutX,
        layoutY: section.layoutY,
        layoutWidth: section.layoutWidth,
        layoutHeight: section.layoutHeight,
        
        metadata: {
          productCount: totalProducts,
          savedFrom: 'current'
        }
      };

      const payloadSize = JSON.stringify(versionData).length;
      console.log(`üíæ Payload size: ${Math.round(payloadSize/1000)}KB (${payloadSize} bytes)`);
      
      if (payloadSize > 50000) { // 50KB limit for safety
        console.error(`‚ùå Payload too large: ${payloadSize} bytes`);
        alert(`‚ùå Section still too large: ${Math.round(payloadSize/1000)}KB\n\nTry a smaller section.`);
        setSavingSectionVersion(false);
        return false;
      }
      console.log('‚úÖ Payload size OK');
      
      console.log('  Calling Firebase savePlanogram...');
      const versionId = await window.firebaseService.savePlanogram(versionData);
      
      console.log(`‚úÖ Section saved with ID: ${versionId}`);
      setFeedback(`‚úÖ Saved: ${section.name} - ${versionName}`);
      setTimeout(() => setFeedback(''), 3000);

      setSavingSectionVersion(false);
      return true;
    } catch (error) {
      console.error('‚ùå Save failed:', error);
      console.error('  Error details:', error.stack);
      alert('‚ùå Failed to save: ' + error.message);
      setSavingSectionVersion(false);
      return false;
    }
  };

  // Load section version (reconstruct products from IDs)
  const loadSectionVersionById = async (versionId, sectionName) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    try {
      setLoadingPlanogram(true);
      console.log(`üìÇ Loading section version: ${versionId}`);
      
      const versionData = await window.firebaseService.loadPlanogram(versionId);
      
      if (!versionData) {
        alert('Section version not found');
        setLoadingPlanogram(false);
        return false;
      }

      // Find the current section
      const sectionIndex = sections.findIndex(s => s.name === sectionName);
      if (sectionIndex === -1) {
        alert(`Section "${sectionName}" not found in current layout`);
        setLoadingPlanogram(false);
        return false;
      }

      // Reconstruct products from IDs by looking them up in the products array
      const reconstructedRows = (versionData.rows || []).map(row => ({
        ...row,
        products: (row.productIds || []).map(productId => {
          const product = products.find(p => p.id === productId);
          return product || { id: productId, title: 'Product not found', sku: '???' };
        })
      }));

      const reconstructedProducts = (versionData.productIds || []).map(productId => {
        const product = products.find(p => p.id === productId);
        return product || { id: productId, title: 'Product not found', sku: '???' };
      });

      // Update the section
      const updatedSections = [...sections];
      updatedSections[sectionIndex] = {
        ...updatedSections[sectionIndex],
        rows: reconstructedRows,
        products: reconstructedProducts
      };

      setSections(updatedSections);
      setLoadingPlanogram(false);
      
      console.log(`‚úÖ Loaded section version`);
      return true;
    } catch (error) {
      console.error('‚ùå Load failed:', error);
      alert('‚ùå Failed to load: ' + error.message);
      setLoadingPlanogram(false);
      return false;
    }
  };

  // Save current section as a version
  const saveSectionVersion = async (section, versionName) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    if (!versionName || !versionName.trim()) {
      alert('Please enter a version name');
      return false;
    }

    try {
      setSavingSectionVersion(true);
      console.log(`üíæ Saving section version: ${section.name} - ${versionName}`);

      // ULTRA-MINIMAL product data - absolute essentials only!
      const stripProduct = (product) => ({
        id: product.id,
        title: product.title?.substring(0, 100), // Truncate title
        sku: product.sku,
        price: product.price,
        upc: product.upc
        // Removed: inventory, cost, and everything else
      });

      // Count total products first
      let totalProducts = 0;
      if (section.rows) {
        section.rows.forEach(row => {
          totalProducts += (row.products?.length || 0);
        });
      }
      totalProducts += (section.products?.length || 0);

      console.log(`üìä Section has ${totalProducts} products`);

      // HARD LIMIT: Max 100 products per section save
      if (totalProducts > 100) {
        alert(`‚ö†Ô∏è Too Many Products!\n\nThis section has ${totalProducts} products.\nFirebase limit: 100 products per section.\n\nTo save this section:\n1. Split it into smaller sections\n2. Or remove some products temporarily`);
        setSavingSectionVersion(false);
        return false;
      }

      const lightweightRows = (section.rows || []).map(row => ({
        id: row.id,
        name: row.name,
        products: (row.products || []).slice(0, 50).map(stripProduct) // Max 50 per row
      }));

      const lightweightProducts = (section.products || []).slice(0, 50).map(stripProduct);

      const versionData = {
        sectionName: section.name,
        versionName: versionName.trim(),
        timestamp: new Date().toISOString(),
        isSectionVersion: true,
        
        // Minimal section data
        id: section.id,
        fixtureId: section.fixtureId,
        rows: lightweightRows,
        products: lightweightProducts,
        layoutX: section.layoutX,
        layoutY: section.layoutY,
        layoutWidth: section.layoutWidth,
        layoutHeight: section.layoutHeight,
        
        // Metadata
        metadata: {
          productCount: totalProducts,
          savedFrom: 'current'
        }
      };

      const payloadSize = JSON.stringify(versionData).length;
      console.log(`üíæ Payload size: ${Math.round(payloadSize/1000)}KB (${payloadSize} bytes)`);
      
      // Firebase Real-time Database has a 256KB limit per location
      // We use 200KB as safe limit
      if (payloadSize > 200000) {
        const productAvg = Math.round(payloadSize / totalProducts);
        alert(`‚ö†Ô∏è Section Still Too Large!\n\nSize: ${Math.round(payloadSize/1000)}KB\nLimit: 200KB\nProducts: ${totalProducts}\n\nThis section has too much data even after compression.\n\nOptions:\n1. Split into 2 smaller sections\n2. Current section averages ${productAvg} bytes per product`);
        setSavingSectionVersion(false);
        return false;
      }
      
      console.log('üíæ Saving lightweight version...');
      
      const versionId = await window.firebaseService.savePlanogram(versionData);
      
      console.log(`‚úÖ Section version saved with ID: ${versionId}`);
      setFeedback(`‚úÖ Saved: ${section.name} - ${versionName}`);
      setTimeout(() => setFeedback(''), 3000);

      // Refresh versions list if we have the panel open
      if (showSectionHistoryPanel && selectedSectionForHistory?.name === section.name) {
        await getSectionVersions(section.name);
      }

      setSavingSectionVersion(false);
      return true;
    } catch (error) {
      console.error('‚ùå Save section version failed:', error);
      
      // Show specific error message
      if (error.message && error.message.includes('payload is too large')) {
        alert('‚ùå FIREBASE ERROR: Payload too large\n\nEven after compression, this section has too much data.\n\nYou MUST split this section into 2-3 smaller sections to save it.');
      } else {
        alert('‚ùå Failed to save section version: ' + error.message);
      }
      
      setSavingSectionVersion(false);
      return false;
    }
  };

  // Get all versions of a specific section
  const getSectionVersions = async (sectionName) => {
    if (!firebaseReady || !window.firebaseService) {
      console.log('Firebase not ready');
      return [];
    }

    try {
      setLoadingSectionVersions(true);
      console.log(`üìö Fetching versions for section: ${sectionName}`);
      
      let allPlanograms = [];
      try {
        allPlanograms = await window.firebaseService.listPlanograms();
      } catch (fetchError) {
        if (fetchError.message && fetchError.message.includes('payload is too large')) {
          console.warn('‚ö†Ô∏è WARNING: Some items in Firebase are too large to load');
          alert('‚ö†Ô∏è WARNING: Firebase has oversized items!\n\nCannot load section versions.\n\nClick "üóëÔ∏è Cleanup Firebase" to delete oversized items.');
          setLoadingSectionVersions(false);
          return [];
        }
        throw fetchError;
      }
      
      // Filter for this section's versions
      const versions = allPlanograms
        .filter(p => p.isSectionVersion === true && p.sectionName === sectionName)
        .map(p => ({
          id: p.id,
          versionName: p.versionName,
          sectionName: p.sectionName,
          timestamp: p.timestamp,
          metadata: p.metadata,
          data: p // Keep full data for loading later
        }))
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Newest first

      console.log(`üìö Found ${versions.length} versions for ${sectionName}`);
      setSectionVersions(versions);
      setLoadingSectionVersions(false);
      return versions;
    } catch (error) {
      console.error('Failed to load section versions:', error);
      setLoadingSectionVersions(false);
      return [];
    }
  };

  // Load a section version (replace current section)
  const loadSectionVersion = async (versionId, sectionName) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    try {
      console.log(`üìÇ Loading section version: ${versionId}`);
      const versionData = await window.firebaseService.loadPlanogram(versionId);
      
      if (!versionData) {
        alert('Failed to load section version');
        return false;
      }

      console.log('üìÇ Loaded lightweight version data');
      
      // NOTE: Loaded products only have basic fields (title, sku, price, inventory, upc, cost)
      // Images and other heavy data were stripped during save to reduce payload size
      // The products will work fine for display and calculations, but won't have images
      
      // Find the current section with this name and replace it
      const updatedSections = sections.map(s => {
        if (s.name === sectionName) {
          return {
            ...s,
            rows: versionData.rows || [],
            products: versionData.products || [],
            layoutX: versionData.layoutX,
            layoutY: versionData.layoutY,
            layoutWidth: versionData.layoutWidth,
            layoutHeight: versionData.layoutHeight
          };
        }
        return s;
      });

      setSections(updatedSections);
      setFeedback(`‚úÖ Loaded: ${versionData.versionName}`);
      setTimeout(() => setFeedback(''), 3000);
      console.log(`‚úÖ Loaded section version: ${versionData.versionName}`);
      console.log('‚ÑπÔ∏è Note: Products have basic data only (images/descriptions were stripped to save space)');
      return true;
    } catch (error) {
      console.error('Load section version failed:', error);
      alert('‚ùå Failed to load section version: ' + error.message);
      return false;
    }
  };

  // Delete a section version
  const deleteSectionVersion = async (versionId) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    try {
      await window.firebaseService.deletePlanogram(versionId);
      console.log(`üóëÔ∏è Deleted section version: ${versionId}`);
      
      // Remove from local list
      setSectionVersions(prev => prev.filter(v => v.id !== versionId));
      
      setFeedback('‚úÖ Version deleted');
      setTimeout(() => setFeedback(''), 3000);
      return true;
    } catch (error) {
      console.error('Delete section version failed:', error);
      alert('‚ùå Failed to delete version: ' + error.message);
      return false;
    }
  };

  // ========================================
  // FIREBASE CLEANUP UTILITIES
  // ========================================

  // Load all items from Firebase and analyze them
  const loadAllFirebaseItems = async () => {
    if (!firebaseReady || !window.firebaseService) {
      alert('Firebase not ready');
      return;
    }

    try {
      setLoadingFirebaseItems(true);
      console.log('üîç Loading all Firebase items...');
      
      let allItems = [];
      try {
        allItems = await window.firebaseService.listPlanograms();
      } catch (fetchError) {
        if (fetchError.message && fetchError.message.includes('payload is too large')) {
          console.error('‚ùå CRITICAL: Firebase has items too large to even LIST!');
          alert('üö® CRITICAL ERROR!\n\nFirebase has items SO LARGE that we cannot even list them!\n\nYou need to manually delete data in Firebase Console:\nhttps://console.firebase.google.com/\n\nGo to Realtime Database ‚Üí planograms ‚Üí Delete oversized items');
          setLoadingFirebaseItems(false);
          return;
        }
        throw fetchError;
      }
      
      // Analyze each item
      const analyzed = allItems.map(item => {
        const itemStr = JSON.stringify(item);
        const sizeKB = Math.round(itemStr.length / 1000);
        
        return {
          id: item.id,
          name: item.name || item.versionName || 'Unnamed',
          timestamp: item.timestamp,
          type: item.isSectionVersion ? 'Section Version' : 'Full Layout',
          sectionName: item.sectionName || 'N/A',
          sizeKB: sizeKB,
          productCount: item.metadata?.productCount || 0,
          fixtureCount: item.metadata?.fixtureCount || 0,
          sectionCount: item.metadata?.sectionCount || 0,
          data: item
        };
      }).sort((a, b) => b.sizeKB - a.sizeKB); // Sort by size, largest first
      
      console.log(`üìä Found ${analyzed.length} items in Firebase`);
      console.log(`üíæ Total size: ${Math.round(analyzed.reduce((sum, i) => sum + i.sizeKB, 0))}KB`);
      
      setAllFirebaseItems(analyzed);
      setLoadingFirebaseItems(false);
    } catch (error) {
      console.error('Failed to load Firebase items:', error);
      setLoadingFirebaseItems(false);
      alert('Failed to load Firebase data: ' + error.message);
    }
  };

  // Delete multiple items
  const deleteFirebaseItems = async (itemIds) => {
    if (!window.firebaseService || !window.firebaseService.isAuthenticated()) {
      alert('Firebase not ready');
      return false;
    }

    try {
      console.log(`üóëÔ∏è Deleting ${itemIds.length} items...`);
      
      for (const id of itemIds) {
        await window.firebaseService.deletePlanogram(id);
        console.log(`‚úÖ Deleted: ${id}`);
      }
      
      // Refresh the list
      await loadAllFirebaseItems();
      
      setFeedback(`‚úÖ Deleted ${itemIds.length} items`);
      setTimeout(() => setFeedback(''), 3000);
      return true;
    } catch (error) {
      console.error('Delete failed:', error);
      alert('‚ùå Failed to delete items: ' + error.message);
      return false;
    }
  };

  // Load saved layouts on mount
  useEffect(() => {
    if (firebaseReady) {
      getAllSavedLayouts();
    }
  }, [firebaseReady]);
  
 const [showLibrary, setShowLibrary] = useState(false);
  const [heatMapMode, setHeatMapMode] = useState(true); // Heat map ON by default
  const [dimensionsMasterLock, setDimensionsMasterLock] = useState(() => {
    const saved = localStorage.getItem('planogram_dimensions_locked');
    return saved ? JSON.parse(saved) : false;
  }); // Master lock for all dimensions
  const [timePeriod, setTimePeriod] = useState('month'); // day, week, month, quarter, year, dateRange
  const [useCustomDateRange, setUseCustomDateRange] = useState(false);
  const [dateRangeStart, setDateRangeStart] = useState('');
  const [dateRangeEnd, setDateRangeEnd] = useState('');
  const [dateRangeSalesData, setDateRangeSalesData] = useState(null);
  const [loadingDateRangeSales, setLoadingDateRangeSales] = useState(false);
  const [customStartDate, setCustomStartDate] = useState(() => {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  });
  const [customEndDate, setCustomEndDate] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });
  const [customDateRange, setCustomDateRange] = useState({ start: '', end: '' });
  const [showQuickOrderStats, setShowQuickOrderStats] = useState(() => {
    const saved = localStorage.getItem('showQuickOrderStats');
    return saved ? JSON.parse(saved) : true; // Show by default
  });
  const [quickStatsMetrics, setQuickStatsMetrics] = useState(() => {
    const saved = localStorage.getItem('quickStatsMetrics');
    return saved ? JSON.parse(saved) : ['totalOrders', 'totalSales', 'weekSales', 'monthSales'];
  });
  const [backgroundImage, setBackgroundImage] = useState(null);
  const [expandedOrderId, setExpandedOrderId] = useState(null);
  const [bgImagePosition, setBgImagePosition] = useState({ x: 0, y: 0 });
  const [isDraggingBg, setIsDraggingBg] = useState(false);
  const [bgDragStart, setBgDragStart] = useState({ x: 0, y: 0 });
  const [showVisualMode, setShowVisualMode] = useState(true);
  const [editingSection, setEditingSection] = useState(null);
  const [editingSectionName, setEditingSectionName] = useState('');
  const [editingSectionArea, setEditingSectionArea] = useState(null);
  const [editingAreaValue, setEditingAreaValue] = useState('');
  const [editingDimensions, setEditingDimensions] = useState({ length: '', depth: '', height: '' });
  const [dimensionLockOverride, setDimensionLockOverride] = useState(false); // For overriding gondola locks
  const [editingFixture, setEditingFixture] = useState(null);
  const [editingFixtureName, setEditingFixtureName] = useState('');
  const [editingRow, setEditingRow] = useState(null);
  const [lastRefresh, setLastRefresh] = useState(null);
  const [lastProductsRefresh, setLastProductsRefresh] = useState(null);
  const [lastSalesRefresh, setLastSalesRefresh] = useState(null);
  const [lastOrdersRefresh, setLastOrdersRefresh] = useState(null);
  const [orderAnalytics, setOrderAnalytics] = useState(null);
  const [orderAnalyticsData, setOrderAnalyticsData] = useState({
    totalOrders: 0,
    totalSales: 0,
    lastRefresh: null,
    status: 'Idle',
    recentOrders: [],
    allOrders: [],
    salesByPeriod: { today: 0, week: 0, month: 0, year: 0 },
    ordersByPeriod: { today: 0, week: 0, month: 0, year: 0 }
  });
  const [productCorrelations, setProductCorrelations] = useState([]);
  const [correlationFixtureFilter, setCorrelationFixtureFilter] = useState('all'); // For Best Upsell Combinations filter
  const [correlationSortBy, setCorrelationSortBy] = useState('count_desc'); // Sort method
  const [heatMapView, setHeatMapView] = useState('category'); // 'category' or 'planogram'
  const [salesExplorerDateRange, setSalesExplorerDateRange] = useState({ start: null, end: null }); // For Interactive Sales Explorer
  const [salesExplorerView, setSalesExplorerView] = useState('hourly'); // For Interactive Sales Explorer view toggle
  const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(true); // Enabled by default
  const [showRefreshPrompt, setShowRefreshPrompt] = useState(false);
  const [expandedRows, setExpandedRows] = useState(new Set());
  const [collapsedSectionLayouts, setCollapsedSectionLayouts] = useState(new Set(['all'])); // Start with all collapsed
  const [collapsedRowsSections, setCollapsedRowsSections] = useState(new Set(['all'])); // Start with all collapsed
  const [collapsedUnknownProducts, setCollapsedUnknownProducts] = useState(new Set(['all'])); // Start with all collapsed
  const [collapsedSections, setCollapsedSections] = useState(new Set()); // Track which sections are collapsed
  const sectionRefs = useRef({}); // Refs for scrolling to sections
  const [heatMapType, setHeatMapType] = useState('profit'); // profit, velocity, deadStock, margin, stockHealth
  const [showHeatMapGuide, setShowHeatMapGuide] = useState(false);
  const [sidebarWidth, setSidebarWidth] = useState(500); // Default 500px - balanced width
  const [isResizingSidebar, setIsResizingSidebar] = useState(false);
  const [rightSidebarWidth, setRightSidebarWidth] = useState(500);
  const [isResizingRightSidebar, setIsResizingRightSidebar] = useState(false);
  
  // Refresh states
  const [isRefreshing, setIsRefreshing] = useState(false);
  
  // Forecasting filters
  const [forecastGroupBy, setForecastGroupBy] = useState('all'); // all, fixture, brand
  const [forecastSortBy, setForecastSortBy] = useState('stockoutRisk'); // stockoutRisk, velocity, daysUntilOut, reorderQty
  const [forecastFilterFixture, setForecastFilterFixture] = useState('all'); // specific fixture filter
  const [forecastFilterBrand, setForecastFilterBrand] = useState('all'); // specific brand filter
  const [forecastFilterDistributor, setForecastFilterDistributor] = useState('all'); // specific distributor filter
  const [forecastSearchQuery, setForecastSearchQuery] = useState(''); // search filter for UPC/SKU/name
  
  // Row Analytics filters
  const [rowFilterFixture, setRowFilterFixture] = useState('all');
  const [rowFilterBrand, setRowFilterBrand] = useState('all');
  const [rowFilterDistributor, setRowFilterDistributor] = useState('all');
  const [rowSortBy, setRowSortBy] = useState('profit'); // profit, sales, products, stock
  const [rowDateRangeStart, setRowDateRangeStart] = useState('');
  const [rowDateRangeEnd, setRowDateRangeEnd] = useState('');
  
  // Navigation
  const [currentPage, setCurrentPage] = useState(() => {
    // Remember last visited tab
    const savedPage = localStorage.getItem('store-planner-last-page');
    return savedPage || 'forecasting';
  }); // planner, dashboard, forecasting, rowAnalytics, settings
  
  // Wrapper to save page to localStorage
  const changePage = (page) => {
    setCurrentPage(page);
    localStorage.setItem('store-planner-last-page', page);
  };
  
  const [searchUPC, setSearchUPC] = useState(''); // For Find Product page
  const [searchResults, setSearchResults] = useState(null); // Store search results
  
  // Firebase states
  const [firebaseConfig, setFirebaseConfig] = useState({
    apiKey: 'AIzaSyBZ6qLt8KVgV877K6IBy0pwZ5a9y1FqGLY',
    authDomain: 'storeplannerpro.firebaseapp.com',
    databaseURL: 'https://storeplannerpro-default-rtdb.firebaseio.com',
    projectId: 'storeplannerpro',
    storageBucket: 'storeplannerpro.firebasestorage.app',
    messagingSenderId: '339443807903',
    appId: '1:339443807903:web:f24e76cc784f7177b494aa'
  });
  const [firebaseInitialized, setFirebaseInitialized] = useState(false);
  const [cloudSyncEnabled, setCloudSyncEnabled] = useState(true);
  const initialLoadComplete = useRef(false);
  const sectionsRef = useRef([]);
  const fixturesRef = useRef([]);
  const unknownProductsRef = useRef([]);
  const badStockProductsRef = useRef([]);
  const [syncStatus, setSyncStatus] = useState('');
  const [showFirebaseSettings, setShowFirebaseSettings] = useState(false);
  
  const fileInputRef = useRef(null);
  const importInputRef = useRef(null);
  const firebaseRef = useRef(null);
  const dbRef = useRef(null);
  const upcInputRef = useRef(null); // Ref for UPC scanning input
  const [zoom, setZoom] = useState(1);
  const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
  const [rotation, setRotation] = useState(0); // Canvas rotation in degrees
  const [mouseDownPos, setMouseDownPos] = useState(null); // Track if this is a click or drag
  const canvasRef = useRef(null);
  
  // Touch gesture states
  const [touchStartDistance, setTouchStartDistance] = useState(null);
  const [touchStartRotation, setTouchStartRotation] = useState(null);
  const [initialZoom, setInitialZoom] = useState(1);
  const [initialRotation, setInitialRotation] = useState(0);
  
  // Auto-pan to selected section (snap to left of sidebar)
  useEffect(() => {
    if (selectedSection && canvasRef.current) {
      const section = sections.find(s => s.id === selectedSection);
      if (section) {
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const sidebarWidth = 500; // Actual width of the right sidebar
        const targetX = (canvasRect.width - sidebarWidth) / 4; // Position section on left quarter of visible area
        
        // Calculate the pan offset needed to center the section at targetX
        const sectionCenterX = section.x + section.width / 2;
        const newPanX = (targetX - sectionCenterX * zoom) / zoom * zoom;
        const newPanY = panOffset.y; // Keep Y position unchanged
        
        setPanOffset({ x: newPanX, y: newPanY });
      }
    }
  }, [selectedSection, zoom]);
  
  // Multi-select keyboard shortcuts for FIXTURES
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'Shift') setShiftPressed(true);
      if (e.key === 'Escape') setSelectedFixtures([]);
      if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        setSelectedFixtures(fixtures.map(f => f.id));
      }
    };

    const handleKeyUp = (e) => {
      if (e.key === 'Shift') setShiftPressed(false);
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, [fixtures]);
  
  const BACKEND_URL = 'https://planogram-backend-gx85.onrender.com';
  
  const productDatabase = {
    '123456789012': { name: 'Premium Coffee Beans', price: 24.99, cost: 12.50, monthlySales: 145 },
    '234567890123': { name: 'Organic Tea Set', price: 18.99, cost: 9.00, monthlySales: 89 },
    '345678901234': { name: 'Artisan Chocolate', price: 12.99, cost: 6.50, monthlySales: 234 },
    '456789012345': { name: 'Gourmet Cookies', price: 8.99, cost: 4.00, monthlySales: 312 },
    '567890123456': { name: 'Specialty Honey', price: 15.99, cost: 7.50, monthlySales: 67 },
  };

  useEffect(() => {
    try {
      const savedSections = localStorage.getItem('planogram_sections');
      const savedFixtures = localStorage.getItem('planogram_fixtures');
      const savedBg = localStorage.getItem('planogram_background');
      const savedBgPos = localStorage.getItem('planogram_bg_position');
      const savedShopify = localStorage.getItem('planogram_shopify');
      const savedLastRefresh = localStorage.getItem('planogram_last_refresh');
      const savedLastProducts = localStorage.getItem('planogram_last_products_refresh');
      const savedLastSales = localStorage.getItem('planogram_last_sales_refresh');
      const savedLastOrders = localStorage.getItem('planogram_last_orders_refresh');
      const savedUnknownProducts = localStorage.getItem('planogram_unknown_products');
      const savedBadStock = localStorage.getItem('planogram_bad_stock_products');
      const savedLayoutsData = localStorage.getItem('saved_layouts');
      
      if (savedSections) {
        const parsed = JSON.parse(savedSections);
        setSections(Array.isArray(parsed) ? parsed : []);
      }
      if (savedFixtures) {
        const parsed = JSON.parse(savedFixtures);
        setFixtures(Array.isArray(parsed) ? parsed : []);
      }
      if (savedBg) setBackgroundImage(savedBg);
      if (savedBgPos) setBgImagePosition(JSON.parse(savedBgPos));
      if (savedUnknownProducts) {
        const parsed = JSON.parse(savedUnknownProducts);
        setUnknownProducts(Array.isArray(parsed) ? parsed : []);
      }
      if (savedBadStock) {
        const parsed = JSON.parse(savedBadStock);
        setBadStockProducts(Array.isArray(parsed) ? parsed : []);
      }
      if (savedLayoutsData) {
        const parsed = JSON.parse(savedLayoutsData);
        setSavedLayouts(Array.isArray(parsed) ? parsed : []);
        console.log(`üì¶ Loaded ${parsed.length} saved layouts`);
      }
      if (savedShopify) {
        const config = JSON.parse(savedShopify);
        setShopifyConfig(config);
      }
      if (savedLastRefresh) {
        setLastRefresh(new Date(savedLastRefresh));
      }
      if (savedLastProducts) {
        setLastProductsRefresh(new Date(savedLastProducts));
      }
      if (savedLastSales) {
        setLastSalesRefresh(new Date(savedLastSales));
      }
      if (savedLastOrders) {
        setLastOrdersRefresh(new Date(savedLastOrders));
      }
      
      const savedAnalytics = localStorage.getItem('planogram_order_analytics');
      if (savedAnalytics) {
        setOrderAnalytics(JSON.parse(savedAnalytics));
      }
      
      // Mark initial load as complete after a brief delay
      setTimeout(() => {
        initialLoadComplete.current = true;
        console.log('‚úÖ Initial load complete - auto-save enabled');
      }, 1000);
    } catch (error) {
      console.error('Error loading saved data:', error);
      initialLoadComplete.current = true; // Enable auto-save even if there's an error
    }
  }, []);

  // Keep refs in sync with state for Firebase saves
  useEffect(() => {
    sectionsRef.current = sections;
  }, [sections]);

  useEffect(() => {
    fixturesRef.current = fixtures;
  }, [fixtures]);

  useEffect(() => {
    unknownProductsRef.current = unknownProducts;
  }, [unknownProducts]);

  useEffect(() => {
    badStockProductsRef.current = badStockProducts;
  }, [badStockProducts]);

  // Load correlations when connected to Shopify
  useEffect(() => {
    if (shopifyConfig.connected) {
      fetchCorrelations();
    }
  }, [shopifyConfig.connected]);

  // Auto-refresh every 5 minutes
  useEffect(() => {
    if (!autoRefreshEnabled || !shopifyConfig.connected) return;

    const interval = setInterval(() => {
      console.log('üîÑ Auto-refreshing product data...');
      refreshProductCache(true);
    }, 5 * 60 * 1000); // 5 minutes

    return () => clearInterval(interval);
  }, [autoRefreshEnabled, shopifyConfig.connected]);

  // Auto-load Order Analytics when Dashboard page opens
  useEffect(() => {
    if (currentPage === 'dashboard' && !orderAnalyticsData.totalOrders) {
      console.log('üìä Auto-loading Order Analytics for Dashboard...');
      fetchAllOrders().catch(err => {
        console.log('‚ö†Ô∏è Could not auto-load orders:', err.message);
      });
    }
  }, [currentPage]);

  // DEBUG: Global function to manually verify today's order count
  useEffect(() => {
    window.debugTodayOrders = () => {
      if (!orderAnalyticsData.allOrders) {
        console.log('‚ùå No orders loaded. Click "Refresh Orders" first.');
        return;
      }
      
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
      
      // USER SAYS: Today's orders begin at #10763
      const TODAYS_FIRST_ORDER = 10763;
      
      console.log('üîç Manual Order Count Debug');
      console.log('Current time:', now.toLocaleString());
      console.log('Today range:', todayStart.toLocaleString(), 'to', todayEnd.toLocaleString());
      console.log('‚ö†Ô∏è USER CONFIRMED: Today\'s orders begin at #' + TODAYS_FIRST_ORDER);
      console.log('Total orders in memory:', orderAnalyticsData.allOrders?.length || 0);
      
      let count = 0;
      let total = 0;
      const samples = [];
      const orderIdsSeen = new Set();
      const duplicates = [];
      const wrongOrders = [];
      
      (orderAnalyticsData.allOrders || []).forEach(order => {
        const orderDate = new Date(order.created_at);
        const orderTotal = parseFloat(order.total_price || 0);
        const orderId = order.order_number || order.id;
        
        // Check for duplicates
        if (orderIdsSeen.has(orderId)) {
          duplicates.push(orderId);
          console.log(`‚ö†Ô∏è DUPLICATE: Order #${orderId}`);
        }
        orderIdsSeen.add(orderId);
        
        if (orderDate >= todayStart && orderDate < todayEnd) {
          count++;
          total += orderTotal;
          
          const shouldNotBeToday = orderId < TODAYS_FIRST_ORDER;
          if (shouldNotBeToday) {
            wrongOrders.push(orderId);
          }
          
          samples.push({
            orderNumber: orderId,
            created_at: order.created_at,
            parsedDate: orderDate.toLocaleString(),
            timestamp: orderDate.getTime(),
            total: `$${orderTotal.toFixed(2)}`,
            isDuplicate: duplicates.includes(orderId),
            wrongDate: shouldNotBeToday ? 'üö® BEFORE TODAY!' : ''
          });
        }
      });
      
      console.log('\nüìä Results:');
      console.log(`  Orders today: ${count}`);
      console.log(`  Sales today: $${total.toFixed(2)}`);
      console.log(`  Duplicates found: ${duplicates.length}`);
      console.log(`  üö® Orders < #${TODAYS_FIRST_ORDER} wrongly counted: ${wrongOrders.length}`);
      console.log('\nüìù ALL orders counted as today:');
      console.table(samples);
      
      if (duplicates.length > 0) {
        console.log('\n‚ö†Ô∏è DUPLICATE ORDER IDs:', duplicates);
      }
      
      if (wrongOrders.length > 0) {
        console.log('\nüö® ORDERS WITH WRONG DATES (< #' + TODAYS_FIRST_ORDER + '):', wrongOrders);
        console.log('These orders are from YESTERDAY or earlier but being counted as TODAY!');
      }
      
      return { count, total, samples, duplicates, wrongOrders };
    };
  }, [orderAnalyticsData]);

  const autoSave = (updatedSections, updatedFixtures = null, message = 'Auto-saved') => {
    try {
      localStorage.setItem('planogram_sections', JSON.stringify(updatedSections));
      localStorage.setItem('planogram_last_save', new Date().toISOString());
      
      // Also save fixtures if provided
      if (updatedFixtures) {
        localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
      }
      
      console.log(`‚úÖ ${message}`);
      
      // Also save to Firebase if enabled
      if (cloudSyncEnabled && dbRef.current) {
        saveToFirebase(updatedSections, updatedFixtures || fixtures, unknownProducts, badStockProducts);
      }
    } catch (error) {
      console.error('‚ùå Auto-save failed:', error);
    }
  };

  // Save Layout Management Functions
  const saveCurrentLayout = (name, description = '') => {
    try {
      console.log('üîç Saving layout with sections:', sections);
      console.log('üîç Number of sections:', sections.length);
      
      const layout = {
        id: Date.now().toString(),
        name: name || `Layout ${savedLayouts.length + 1}`,
        description,
        storeName,
        sections: JSON.parse(JSON.stringify(sections)), // Deep clone
        fixtures: JSON.parse(JSON.stringify(fixtures)),
        backgroundImage,
        bgImagePosition,
        createdAt: new Date().toISOString(),
        metrics: calculateLayoutMetrics(sections)
      };

      console.log('üîç Calculated metrics:', layout.metrics);

      const updated = [...savedLayouts, layout];
      setSavedLayouts(updated);
      localStorage.setItem('saved_layouts', JSON.stringify(updated));
      
      // Also save to Firebase if enabled
      if (cloudSyncEnabled && dbRef.current) {
        dbRef.current.ref('savedLayouts').set(updated);
      }
      
      setFeedback(`üíæ Layout "${name}" saved!`);
      setTimeout(() => setFeedback(''), 3000);
      console.log('‚úÖ Layout saved:', name);
      return layout;
    } catch (error) {
      console.error('‚ùå Save layout failed:', error);
      setFeedback('‚ùå Failed to save layout');
      setTimeout(() => setFeedback(''), 3000);
    }
  };

  const loadLayout = (layout) => {
    try {
      setSections(JSON.parse(JSON.stringify(layout.sections)));
      setFixtures(JSON.parse(JSON.stringify(layout.fixtures)));
      if (layout.backgroundImage) setBackgroundImage(layout.backgroundImage);
      if (layout.bgImagePosition) setBgImagePosition(layout.bgImagePosition);
      
      setFeedback(`‚úÖ Loaded layout "${layout.name}"`);
      setTimeout(() => setFeedback(''), 3000);
      console.log('‚úÖ Layout loaded:', layout.name);
    } catch (error) {
      console.error('‚ùå Load layout failed:', error);
      setFeedback('‚ùå Failed to load layout');
      setTimeout(() => setFeedback(''), 3000);
    }
  };

  const deleteLayout = (layoutId) => {
    try {
      const updated = savedLayouts.filter(l => l.id !== layoutId);
      setSavedLayouts(updated);
      localStorage.setItem('saved_layouts', JSON.stringify(updated));
      
      // Also update Firebase if enabled
      if (cloudSyncEnabled && dbRef.current) {
        dbRef.current.ref('savedLayouts').set(updated);
      }
      
      setFeedback('üóëÔ∏è Layout deleted');
      setTimeout(() => setFeedback(''), 2000);
    } catch (error) {
      console.error('‚ùå Delete layout failed:', error);
    }
  };

  const calculateLayoutMetrics = (layoutSections) => {
    let totalRevenue = 0;
    let totalArea = 0;
    let productCount = 0;

    layoutSections.forEach(section => {
      const sectionArea = (section.dimensions?.width || 0) * (section.dimensions?.depth || 0);
      totalArea += sectionArea;

      section.rows?.forEach(row => {
        row.products?.forEach(product => {
          const qty = product.quantity || 1;
          const price = product.price || 0;
          totalRevenue += qty * price;
          productCount += qty;
        });
      });
    });

    return {
      totalRevenue,
      totalArea: totalArea / 144, // Convert to sq ft
      profitPerSqFt: totalArea > 0 ? totalRevenue / (totalArea / 144) : 0,
      productCount
    };
  };

  // Firebase Functions
  const initializeFirebase = () => {
    try {
      const config = window.firebaseConfig || {
        apiKey: "AIzaSyDfHWJMZV6uE-zEo8sXqGxV8K7NqGxK0Qs",
        authDomain: "planogram-tracker.firebaseapp.com",
        databaseURL: "https://planogram-tracker-default-rtdb.firebaseio.com",
        projectId: "planogram-tracker",
        storageBucket: "planogram-tracker.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdef123456"
      };

      if (!firebase.apps.length) {
        firebaseRef.current = firebase.initializeApp(config);
      } else {
        firebaseRef.current = firebase.app();
      }
      
      // Use Realtime Database instead of Firestore
      dbRef.current = firebase.database();
      setFirebaseInitialized(true);
      setSyncStatus('‚úÖ Firebase connected');
      setTimeout(() => setSyncStatus(''), 3000);
      
      // Save config to localStorage
      localStorage.setItem('planogram_firebase_config', JSON.stringify(firebaseConfig));
      
      console.log('üî• Firebase initialized with Realtime Database');
      
      return true;
    } catch (error) {
      console.error('Firebase initialization error:', error);
      setSyncStatus(`‚ùå ${error.message}`);
      setTimeout(() => setSyncStatus(''), 5000);
      return false;
    }
  };

  const saveToFirebase = async (sectionsData, fixturesData = null, unknownData = null, badStockData = null) => {
    if (!dbRef.current || !cloudSyncEnabled) return;

    try {
      const layoutData = {
        storeName,
        fixtures: fixturesData || fixtures,
        sections: sectionsData,
        unknownProducts: unknownData || unknownProducts,
        badStockProducts: badStockData || badStockProducts,
        backgroundImage: backgroundImage ? 'stored_separately' : null,
        bgImagePosition,
        lastUpdated: Date.now(),
        version: 3
      };

      // Use Realtime Database API: ref().set()
      await dbRef.current.ref('planograms/default').set(layoutData);
      console.log('‚òÅÔ∏è Saved to Firebase Realtime Database');
    } catch (error) {
      console.error('Firebase save error:', error);
    }
  };

  const loadFromFirebase = async () => {
    if (!dbRef.current) return;

    try {
      setSyncStatus('üîÑ Loading from cloud...');
      
      // Use Realtime Database API: ref().once()
      const snapshot = await dbRef.current.ref('planograms/default').once('value');
      
      if (snapshot.exists()) {
        const data = snapshot.val();
        if (data.storeName) setStoreName(data.storeName);
        if (data.fixtures) {
          setFixtures(Array.isArray(data.fixtures) ? data.fixtures : []);
          localStorage.setItem('planogram_fixtures', JSON.stringify(Array.isArray(data.fixtures) ? data.fixtures : []));
        }
        if (data.sections) {
          setSections(Array.isArray(data.sections) ? data.sections : []);
          localStorage.setItem('planogram_sections', JSON.stringify(Array.isArray(data.sections) ? data.sections : []));
        }
        if (data.unknownProducts) {
          setUnknownProducts(data.unknownProducts);
        }
        if (data.badStockProducts) {
          setBadStockProducts(data.badStockProducts);
        }
        if (data.bgImagePosition) {
          setBgImagePosition(data.bgImagePosition);
          localStorage.setItem('planogram_bg_position', JSON.stringify(data.bgImagePosition));
        }
        
        setSyncStatus('‚úÖ Loaded from cloud');
        setFeedback('‚úÖ Cloud data loaded!');
        setTimeout(() => {
          setSyncStatus('');
          setFeedback('');
        }, 3000);
      } else {
        setSyncStatus('‚ö†Ô∏è No cloud data found');
        setTimeout(() => setSyncStatus(''), 3000);
      }
    } catch (error) {
      console.error('Firebase load error:', error);
      setSyncStatus(`‚ùå Load failed: ${error.message}`);
      setTimeout(() => setSyncStatus(''), 5000);
    }
  };

  const exportLayout = () => {
    const layoutData = {
      version: 3,
      storeName,
      fixtures,
      sections,
      backgroundImage,
      bgImagePosition,
      shopifyConfig: {
        storeName: shopifyConfig.storeName,
        connected: shopifyConfig.connected
      },
      exportDate: new Date().toISOString()
    };

    const dataStr = JSON.stringify(layoutData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `planogram-${storeName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    
    setFeedback('‚úÖ Layout exported!');
    setTimeout(() => setFeedback(''), 3000);
  };

  const importLayout = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const layoutData = JSON.parse(e.target.result);
        
        if (layoutData.version !== 3) {
          setFeedback('‚ö†Ô∏è Old version file.');
        }
        
        if (layoutData.storeName) setStoreName(layoutData.storeName);
        if (layoutData.fixtures) {
          setFixtures(layoutData.fixtures);
          localStorage.setItem('planogram_fixtures', JSON.stringify(layoutData.fixtures));
        }
        if (layoutData.sections) {
          setSections(layoutData.sections);
          localStorage.setItem('planogram_sections', JSON.stringify(layoutData.sections));
        }
        if (layoutData.backgroundImage) {
          setBackgroundImage(layoutData.backgroundImage);
          localStorage.setItem('planogram_background', layoutData.backgroundImage);
        }
        if (layoutData.bgImagePosition) {
          setBgImagePosition(layoutData.bgImagePosition);
          localStorage.setItem('planogram_bg_position', JSON.stringify(layoutData.bgImagePosition));
        }
        
        setFeedback('‚úÖ Layout imported!');
        setTimeout(() => setFeedback(''), 3000);
        
      } catch (error) {
        console.error('Import error:', error);
        setFeedback('‚ùå Failed to import. Invalid file.');
        setTimeout(() => setFeedback(''), 5000);
      }
    };
    
    reader.readAsText(file);
    event.target.value = '';
  };

  const handleBgMouseDown = (e) => {
    if (e.target.tagName !== 'IMG') return;
    setIsDraggingBg(true);
    setBgDragStart({
      x: e.clientX - bgImagePosition.x,
      y: e.clientY - bgImagePosition.y
    });
    e.preventDefault();
    e.stopPropagation();
  };

  const handleBgMouseMove = (e) => {
    if (!isDraggingBg) return;
    setBgImagePosition({
      x: e.clientX - bgDragStart.x,
      y: e.clientY - bgDragStart.y
    });
  };

  const handleBgMouseUp = () => {
    if (isDraggingBg) {
      setIsDraggingBg(false);
      try {
        localStorage.setItem('planogram_bg_position', JSON.stringify(bgImagePosition));
      } catch (error) {
        console.error('Failed to save background position:', error);
      }
    }
  };

  const resetBackgroundPosition = () => {
    const resetPos = { x: 0, y: 0 };
    setBgImagePosition(resetPos);
    localStorage.setItem('planogram_bg_position', JSON.stringify(resetPos));
    setFeedback('‚úÖ Background reset');
    setTimeout(() => setFeedback(''), 2000);
  };

  // Canvas pan and zoom
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({ x: 0, y: 0 });

  const handleCanvasWheel = (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    setZoom(prev => Math.max(0.1, Math.min(3, prev * delta)));
  };

  const handleCanvasMouseDown = (e) => {
    // Track where the mouse went down
    setMouseDownPos({ x: e.clientX, y: e.clientY });
    
    // Pan with middle mouse button (button 1) or Ctrl + left click
    if (e.button === 1 || (e.button === 0 && e.ctrlKey)) {
      e.preventDefault();
      setIsPanning(true);
      setPanStart({ 
        x: e.clientX - panOffset.x, 
        y: e.clientY - panOffset.y 
      });
      return;
    }
    
    // Allow panning on normal left click (button 0) - fixtures will stop propagation if needed
    if (e.button === 0) {
      setIsPanning(true);
      setPanStart({ 
        x: e.clientX - panOffset.x, 
        y: e.clientY - panOffset.y 
      });
    }
  };

  const handleCanvasMouseMove = (e) => {
    if (isPanning) {
      setPanOffset({
        x: e.clientX - panStart.x,
        y: e.clientY - panStart.y
      });
    }
  };

  const handleCanvasMouseUp = (e) => {
    setIsPanning(false);
    
    // If we didn't move much (less than 5 pixels), treat it as a click and deselect
    if (mouseDownPos) {
      const dx = Math.abs(e.clientX - mouseDownPos.x);
      const dy = Math.abs(e.clientY - mouseDownPos.y);
      
      if (dx < 5 && dy < 5) {
        // This was a click, not a drag - deselect if not clicking on a fixture
        const clickedElement = document.elementFromPoint(e.clientX, e.clientY);
        const isFixture = clickedElement?.closest('[data-fixture-id]');
        
        if (!isFixture) {
          setSelectedSection(null);
          setSelectedProduct(null);
          setSelectedFixtures([]); // Clear multi-selected fixtures
        }
      }
      
      setMouseDownPos(null);
    }
  };

  // Touch gesture handlers
  const getTouchDistance = (touch1, touch2) => {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  };

  const getTouchAngle = (touch1, touch2) => {
    const dx = touch2.clientX - touch1.clientX;
    const dy = touch2.clientY - touch1.clientY;
    return Math.atan2(dy, dx) * (180 / Math.PI);
  };

  const getTouchCenter = (touch1, touch2) => {
    return {
      x: (touch1.clientX + touch2.clientX) / 2,
      y: (touch1.clientY + touch2.clientY) / 2
    };
  };

  const handleCanvasTouchStart = (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const distance = getTouchDistance(e.touches[0], e.touches[1]);
      const angle = getTouchAngle(e.touches[0], e.touches[1]);
      setTouchStartDistance(distance);
      setTouchStartRotation(angle);
      setInitialZoom(zoom);
      setInitialRotation(rotation);
      setIsPanning(false);
    } else if (e.touches.length === 1) {
      // Single touch for panning
      setIsPanning(true);
      setPanStart({
        x: e.touches[0].clientX - panOffset.x,
        y: e.touches[0].clientY - panOffset.y
      });
    }
  };

  const handleCanvasTouchMove = (e) => {
    if (e.touches.length === 2 && touchStartDistance && touchStartRotation !== null) {
      e.preventDefault();
      
      // Calculate pinch zoom
      const currentDistance = getTouchDistance(e.touches[0], e.touches[1]);
      const scale = currentDistance / touchStartDistance;
      const newZoom = Math.max(0.1, Math.min(3, initialZoom * scale));
      setZoom(newZoom);
      
      // Calculate rotation
      const currentAngle = getTouchAngle(e.touches[0], e.touches[1]);
      const angleDiff = currentAngle - touchStartRotation;
      const newRotation = (initialRotation + angleDiff) % 360;
      setRotation(newRotation);
      
    } else if (e.touches.length === 1 && isPanning) {
      // Pan with single touch
      setPanOffset({
        x: e.touches[0].clientX - panStart.x,
        y: e.touches[0].clientY - panStart.y
      });
    }
  };

  const handleCanvasTouchEnd = (e) => {
    if (e.touches.length < 2) {
      setTouchStartDistance(null);
      setTouchStartRotation(null);
    }
    if (e.touches.length === 0) {
      setIsPanning(false);
    }
  };

  const testShopifyConnection = async () => {
    if (!shopifyConfig.storeName || !shopifyConfig.accessToken) {
      setFeedback('‚ö†Ô∏è Enter store name and token');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('üîÑ Testing...');

    try {
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'testConnection'
        })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        const updatedConfig = { ...shopifyConfig, connected: true };
        setShopifyConfig(updatedConfig);
        localStorage.setItem('planogram_shopify', JSON.stringify(updatedConfig));
        setFeedback(`‚úÖ Connected!`);
        setTimeout(() => {
          setFeedback('');
          setShowSettings(false);
        }, 2000);
      } else {
        setFeedback(`‚ùå ${data.error || 'Failed'}`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } catch (error) {
      console.error('Connection error:', error);
      setFeedback('‚ùå Connection error');
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  const disconnectShopify = () => {
    const updatedConfig = {
      storeName: shopifyConfig.storeName,
      accessToken: '',
      connected: false
    };
    setShopifyConfig(updatedConfig);
    localStorage.setItem('planogram_shopify', JSON.stringify(updatedConfig));
    setFeedback('‚úÖ Disconnected');
    setTimeout(() => setFeedback(''), 2000);
  };

  const refreshProductCache = async (isAutoRefresh = false) => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      if (!isAutoRefresh) {
        setFeedback('‚ö†Ô∏è Connect to Shopify first');
        setTimeout(() => setFeedback(''), 3000);
      }
      return;
    }

    if (!isAutoRefresh) {
      console.log('üîÑ Starting product refresh...');
      setIsRefreshing(true);
      setSyncProgress({ message: 'Loading products', current: 0, total: 0 });
      setFeedback('üîÑ Starting product refresh...');
    }
    
    try {
      console.log('üì° Calling backend /api/shopify with action: refreshProducts');
      // Use backend proxy to avoid CORS issues
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshProducts'
        })
      });

      if (!response.ok) {
        throw new Error(`Backend returned ${response.status}`);
      }

      const data = await response.json();
      console.log('‚úÖ Backend response:', data);

      if (data.success) {
        if (data.totalProducts && !isAutoRefresh) {
          console.log(`üì¶ Loaded ${data.totalProducts} products`);
          setSyncProgress({ message: 'Products loaded', current: data.totalProducts, total: data.totalProducts });
          setFeedback(`‚úÖ Loaded ${data.totalProducts} products`);
        }
        
        const now = new Date();
        setLastRefresh(now);
        setLastProductsRefresh(now);
        localStorage.setItem('planogram_last_refresh', now.toISOString());
        localStorage.setItem('planogram_last_products_refresh', now.toISOString());
        
        if (!isAutoRefresh) {
          setTimeout(() => {
            setSyncProgress({ message: '', current: 0, total: 0 });
            setFeedback('');
          }, 3000);
        } else {
          console.log('‚úÖ Auto-refresh completed at', now.toLocaleTimeString());
        }
      } else {
        if (!isAutoRefresh) {
          setFeedback(`‚ùå ${data.error || 'Refresh failed'}`);
          setTimeout(() => setFeedback(''), 5000);
        }
      }
    } catch (error) {
      if (!isAutoRefresh) {
        setFeedback(`‚ùå Cache refresh failed: ${error.message}. Check Shopify connection.`);
        setTimeout(() => setFeedback(''), 5000);
      }
      console.error('Refresh error:', error);
    } finally {
      if (!isAutoRefresh) {
        setIsRefreshing(false);
      }
    }
  };

  // UPDATED: Load all products with LIVE INVENTORY from Shopify (not database!)
  const loadAllProductsFromDatabase = async () => {
    if (!shopifyConfig.connected) {
      setFeedback('‚ö†Ô∏è Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setLoadingAllProducts(true);
    setFeedback('üî¥ Loading ALL products with sales data from database...');

    try {
      // Use the correct endpoint - /api/products/all (no params needed)
      const response = await fetch(`${BACKEND_URL}/api/products/all`);

      if (!response.ok) {
        throw new Error(`Failed to load products: ${response.status}`);
      }

      const data = await response.json();
      const products = data.products || [];
      
      console.log(`‚úÖ Loaded ${products.length} products with sales data from database`);
      console.log(`üìä Summary:`, data.summary);
      setAllDatabaseProducts(products);
      setFeedback(`‚úÖ Loaded ${products.length} products with sales data (${data.summary?.criticalAlerts || 0} critical alerts)`);
      
      // Save timestamp
      localStorage.setItem('lastInventoryLoadTime', Date.now().toString());
      
      // AUTO-SYNC 1: Update distributor values in planogram (silent)
      setTimeout(() => autoSyncDistributors(products), 500);
      
      // AUTO-SYNC 2: Check for negative stock and add to Bad Stock list (with notification)
      setTimeout(() => autoSyncBadStock(products), 1000);

    } catch (error) {
      console.error('‚ùå Error loading all products:', error);
      setFeedback(`‚ùå Failed to load products: ${error.message}`);
      setTimeout(() => setFeedback(''), 5000);
    } finally {
      setLoadingAllProducts(false);
    }
  };

  // AUTO-SYNC: Update distributor values from database (runs silently after load)
  const autoSyncDistributors = async (products) => {
    if (!products || products.length === 0) return;

    console.log('üîÑ Auto-syncing distributor values...');

    // Create a lookup map: UPC -> distributor
    const distributorMap = new Map();
    products.forEach(p => {
      if (p.barcode && p.distributor) {
        distributorMap.set(p.barcode, p.distributor);
      }
    });

    let updatedCount = 0;

    // Update all products in all sections
    const updatedSections = sections.map(section => {
      if (section.rows) {
        const updatedRows = section.rows.map(row => {
          const updatedProducts = (row.products || []).map(product => {
            if (product.upc && distributorMap.has(product.upc)) {
              const newDistributor = distributorMap.get(product.upc);
              if (product.distributor !== newDistributor) {
                updatedCount++;
                return { ...product, distributor: newDistributor };
              }
            }
            return product;
          });
          return { ...row, products: updatedProducts };
        });
        return { ...section, rows: updatedRows };
      } else {
        const updatedProducts = (section.products || []).map(product => {
          if (product.upc && distributorMap.has(product.upc)) {
            const newDistributor = distributorMap.get(product.upc);
            if (product.distributor !== newDistributor) {
              updatedCount++;
              return { ...product, distributor: newDistributor };
            }
          }
          return product;
        });
        return { ...section, products: updatedProducts };
      }
    });

    if (updatedCount > 0) {
      setSections(updatedSections);
      console.log(`‚úÖ Auto-synced ${updatedCount} distributor values`);
      
      // Save silently to Firebase
      if (firebaseUser) {
        try {
          const planogramData = {
            name: storeName,
            fixtures: fixtures,
            sections: updatedSections,
            unknownProducts: unknownProducts,
            badStockProducts: badStockProducts,
            shopifyConfig: {
              storeName: shopifyConfig.storeName,
              connected: shopifyConfig.connected
            }
          };
          await window.firebaseService.savePlanogram(planogramData);
          console.log('üíæ Distributor updates saved to Firebase');
        } catch (error) {
          console.error('‚ùå Failed to save distributor updates:', error);
        }
      }
    }
  };

  // AUTO-SYNC: Check for negative stock and add to Bad Stock list (with notification)
  const autoSyncBadStock = (products) => {
    console.log('üîç Checking for negative stock products from API...');
    
    // Use the products passed in (from API with stock field)
    if (!products || products.length === 0) {
      console.log('‚ö†Ô∏è No products provided to scan');
      return;
    }

    console.log(`Total products to check: ${products.length}`);
    
    // Sample first 5 products
    const sample = products.slice(0, 5);
    console.log('Sample product inventory data:', sample.map(p => ({
      title: p.title,
      stock: p.stock,
      variantTitle: p.variantTitle
    })));

    const negativeStockProducts = products.filter(p => {
      // API returns 'stock' field
      const currentStock = p.stock !== null && p.stock !== undefined ? p.stock : 0;
      
      if (currentStock < 0) {
        console.log(`‚ùå NEGATIVE: ${p.title} ${p.variantTitle || ''} = ${currentStock}`);
      }
      return currentStock < 0;
    });

    console.log(`Found ${negativeStockProducts.length} products with negative stock`);

    if (negativeStockProducts.length === 0) {
      console.log('‚úÖ No negative stock products found');
      return;
    }

    // Add to bad stock list (avoid duplicates)
    const existingIds = new Set(badStockProducts.map(b => b.shopifyId));
    const newBadStockProducts = negativeStockProducts
      .filter(p => {
        const id = p.variantId;
        return id && !existingIds.has(id);
      })
      .map(p => {
        return {
          id: Date.now() + Math.random(),
          shopifyId: p.variantId,
          title: `${p.title}${p.variantTitle ? ` - ${p.variantTitle}` : ''}`,
          sku: p.sku,
          upc: p.barcode || '',
          currentStock: p.stock,
          reason: 'Negative Stock (Auto-detected)',
          addedDate: new Date().toISOString(),
          status: 'pending'
        };
      });

    if (newBadStockProducts.length > 0) {
      setBadStockProducts(prev => [...prev, ...newBadStockProducts]);
      setFeedback(`üî¥ Found ${newBadStockProducts.length} product(s) with negative stock - added to Bad Stock list`);
      setTimeout(() => setFeedback(''), 5000);
      console.log(`‚úÖ Added ${newBadStockProducts.length} products to Bad Stock list`);
    } else {
      console.log('‚ÑπÔ∏è All negative stock products already in Bad Stock list');
    }
  };

  // Manual fix for distributor duplicates
  const fixAllDistributors = async () => {
    const distributorFixes = {
      'Jinny Beauty': 'Jinny',
      'Jinny Beauty Supply': 'Jinny',
      'Jinny Beauty Suooly': 'Jinny',
      'Jinny ': 'Jinny',
    };

    console.log('üîß Starting distributor fix...');
    setFeedback('üîß Fixing distributor duplicates...');
    
    let totalFixed = 0;
    
    const fixedSections = sections.map(section => {
      if (section.rows) {
        const fixedRows = section.rows.map(row => {
          const fixedProducts = (row.products || []).map(product => {
            if (product.distributor && distributorFixes[product.distributor]) {
              console.log(`Fixing: "${product.distributor}" ‚Üí "${distributorFixes[product.distributor]}"`);
              totalFixed++;
              return { ...product, distributor: distributorFixes[product.distributor] };
            }
            return product;
          });
          return { ...row, products: fixedProducts };
        });
        return { ...section, rows: fixedRows };
      } else {
        const fixedProducts = (section.products || []).map(product => {
          if (product.distributor && distributorFixes[product.distributor]) {
            console.log(`Fixing: "${product.distributor}" ‚Üí "${distributorFixes[product.distributor]}"`);
            totalFixed++;
            return { ...product, distributor: distributorFixes[product.distributor] };
          }
          return product;
        });
        return { ...section, products: fixedProducts };
      }
    });
    
    console.log(`‚úÖ Fixed ${totalFixed} distributor values`);
    setSections(fixedSections);
    
    if (firebaseUser && totalFixed > 0) {
      try {
        setFeedback('üíæ Saving fixes to Firebase...');
        const planogramData = {
          name: storeName,
          fixtures: fixtures,
          sections: fixedSections,
          unknownProducts: unknownProducts,
          badStockProducts: badStockProducts,
          shopifyConfig: {
            storeName: shopifyConfig.storeName,
            connected: shopifyConfig.connected
          }
        };
        
        await window.firebaseService.savePlanogram(planogramData);
        setFeedback(`‚úÖ Fixed and saved ${totalFixed} distributor values!`);
        setTimeout(() => setFeedback(''), 5000);
        console.log('‚úÖ DONE! Saved to Firebase');
      } catch (error) {
        console.error('‚ùå Save failed:', error);
        setFeedback('‚ùå Fixed values but failed to save to Firebase');
        setTimeout(() => setFeedback(''), 5000);
      }
    } else if (totalFixed === 0) {
      setFeedback('‚úÖ No distributor duplicates found!');
      setTimeout(() => setFeedback(''), 3000);
    }
  };

  // Expose fix function to window for console access
  React.useEffect(() => {
    window.fixAllDistributors = fixAllDistributors;
    window.scanForBadStock = manualBadStockScan;
  }, []);

  // Sync negative stock products to Bad Stock list
  const syncNegativeStockToBadStock = () => {
    console.log('üîç SYNC TO BAD STOCK CLICKED');
    console.log('Products loaded:', allDatabaseProducts.length);
    
    if (allDatabaseProducts.length === 0) {
      console.log('‚ùå No products loaded');
      setFeedback('‚ö†Ô∏è Load products first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    const negativeStockProducts = allDatabaseProducts.filter(p => {
      const qty = parseInt(p.inventory_quantity) || 0;
      return qty < 0;
    });

    console.log('Negative stock products found:', negativeStockProducts.length);

    if (negativeStockProducts.length === 0) {
      console.log('‚úÖ No negative stock found');
      setFeedback('‚úÖ No negative stock products found');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    // Add to bad stock list (avoid duplicates)
    const existingIds = new Set(badStockProducts.map(b => b.shopifyId));
    const newBadStockProducts = negativeStockProducts
      .filter(p => !existingIds.has(p.id))
      .map(p => ({
        id: Date.now() + Math.random(),
        shopifyId: p.id,
        title: p.title,
        sku: p.sku,
        upc: p.upc || '',
        currentStock: parseInt(p.inventory_quantity) || 0,
        reason: 'Negative Stock from Forecasting',
        addedDate: new Date().toISOString(),
        status: 'pending'
      }));

    console.log('New products to add:', newBadStockProducts.length);

    if (newBadStockProducts.length > 0) {
      setBadStockProducts(prev => [...prev, ...newBadStockProducts]);
      setFeedback(`‚úÖ Added ${newBadStockProducts.length} negative stock product(s) to Bad Stock list`);
      setTimeout(() => setFeedback(''), 3000);
      console.log('‚úÖ Added to bad stock list');
    } else {
      setFeedback('‚ÑπÔ∏è All negative stock products already in Bad Stock list');
      setTimeout(() => setFeedback(''), 3000);
      console.log('‚ÑπÔ∏è Already in list');
    }
  };

  // Sync distributor values from database to planogram products
  const syncDistributorsFromDatabase = async () => {
    if (allDatabaseProducts.length === 0) {
      setFeedback('‚ö†Ô∏è Load products from database first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('üîÑ Syncing distributor values from database...');

    // Create a lookup map: UPC -> distributor
    const distributorMap = new Map();
    allDatabaseProducts.forEach(p => {
      if (p.barcode && p.distributor) {
        distributorMap.set(p.barcode, p.distributor);
      }
    });

    let updatedCount = 0;

    // Update all products in all sections
    const updatedSections = sections.map(section => {
      if (section.rows) {
        // Grid wall with rows
        const updatedRows = section.rows.map(row => {
          const updatedProducts = (row.products || []).map(product => {
            if (product.upc && distributorMap.has(product.upc)) {
              const newDistributor = distributorMap.get(product.upc);
              if (product.distributor !== newDistributor) {
                updatedCount++;
                return { ...product, distributor: newDistributor };
              }
            }
            return product;
          });
          return { ...row, products: updatedProducts };
        });
        return { ...section, rows: updatedRows };
      } else {
        // Regular section with products
        const updatedProducts = (section.products || []).map(product => {
          if (product.upc && distributorMap.has(product.upc)) {
            const newDistributor = distributorMap.get(product.upc);
            if (product.distributor !== newDistributor) {
              updatedCount++;
              return { ...product, distributor: newDistributor };
            }
          }
          return product;
        });
        return { ...section, products: updatedProducts };
      }
    });

    // Update state first
    setSections(updatedSections);

    // Then save using the same method as regular save
    if (firebaseUser && updatedCount > 0) {
      try {
        setFeedback(`üíæ Saving ${updatedCount} updates to Firebase...`);
        
        const planogramData = {
          name: storeName,
          fixtures: fixtures,
          sections: updatedSections,
          unknownProducts: unknownProducts,
          badStockProducts: badStockProducts,
          shopifyConfig: {
            storeName: shopifyConfig.storeName,
            connected: shopifyConfig.connected
          }
        };

        const id = await window.firebaseService.savePlanogram(planogramData);
        if (id) {
          setFeedback(`‚úÖ Updated and saved ${updatedCount} product distributor values!`);
          setTimeout(() => setFeedback(''), 3000);
        }
      } catch (error) {
        console.error('Error saving to Firebase:', error);
        setFeedback(`‚ö†Ô∏è Updated ${updatedCount} products but failed to save to Firebase`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } else {
      setFeedback(`‚úÖ Updated ${updatedCount} product distributor values from database`);
      setTimeout(() => setFeedback(''), 3000);
    }
  };

  // Generate CSV export with forecasting data
  const generateCSV = () => {
    if (allDatabaseProducts.length === 0) {
      setFeedback('‚ö†Ô∏è Load products first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    try {
      // Create cost lookup from planogram
      const costLookup = {};
      sections.forEach(section => {
        const products = section.rows ? 
          section.rows.flatMap(row => row.products || []) : 
          (section.products || []);
        
        products.forEach(product => {
          if (product.upc && product.cost !== undefined && product.cost !== null && product.cost !== '') {
            costLookup[product.upc] = product.cost;
          }
        });
      });
      
      // Use API data with planogram costs
      let allProducts = allDatabaseProducts.map(p => ({
        upc: p.barcode,
        name: p.variantTitle ? `${p.title} - ${p.variantTitle}` : p.title,
        sku: p.sku,
        vendor: p.vendor,
        distributor: p.distributor,
        cost: costLookup[p.barcode] || p.cost,
        inventoryQuantity: p.stock,
        dailySales: p.dailySales,
        weeklySales: p.weeklySales,
        monthlySales: p.monthlySales
      }));

      // Apply current filters
      if (forecastFilterDistributor !== 'all') {
        allProducts = allProducts.filter(p => {
          const dist = p.distributor?.trim();
          const distributor = dist && dist !== '' ? dist : 'Unknown Distributor';
          return distributor === forecastFilterDistributor;
        });
      }

      // Calculate forecasting metrics
      const productsWithForecasts = allProducts.map(product => {
        let salesVolume = 0;
        let daysInPeriod = 30;
        
        if (timePeriod === 'dateRange' && dateRangeSalesData) {
          const variantSales = dateRangeSalesData.salesData.find(
            s => s.variantId.toString() === product.variantId?.toString()
          );
          salesVolume = variantSales ? variantSales.totalSales : 0;
          daysInPeriod = dateRangeSalesData.daysInPeriod;
        } else {
          // For products with low/zero stock, use longer periods to capture true velocity
          const currentStock = product.inventoryQuantity !== null && product.inventoryQuantity !== undefined 
            ? product.inventoryQuantity 
            : 0;
          
          // If stock is very low (‚â§5), look at longer history for more accurate velocity
          if (currentStock <= 5) {
            // Try quarterly first, then yearly, then allTime
            if (product.quarterlySales && product.quarterlySales > 0) {
              salesVolume = product.quarterlySales;
              daysInPeriod = 90;
            } else if (product.yearlySales && product.yearlySales > 0) {
              salesVolume = product.yearlySales;
              daysInPeriod = 365;
            } else if (product.allTimeSales && product.allTimeSales > 0) {
              // Use all-time sales but cap at 1 year for realistic velocity
              salesVolume = product.allTimeSales;
              daysInPeriod = Math.min(365, 180); // Assume at least 6 months of history
            } else {
              // Fallback to monthly
              salesVolume = product.monthlySales || 0;
              daysInPeriod = 30;
            }
          } else {
            // Normal stock levels - use selected time period
            switch(timePeriod) {
              case 'week':
                salesVolume = product.weeklySales || 0;
                daysInPeriod = 7;
                break;
              case 'month':
                salesVolume = product.monthlySales || 0;
                daysInPeriod = 30;
                break;
              default:
                salesVolume = product.monthlySales || 0;
                daysInPeriod = 30;
            }
          }
        }

        const dailyVelocity = daysInPeriod > 0 ? salesVolume / daysInPeriod : 0;
        const currentStock = product.inventoryQuantity !== null && product.inventoryQuantity !== undefined 
          ? product.inventoryQuantity 
          : 0;
        
        const targetSupply = dailyVelocity * 30;
        const safetyStock = targetSupply * 0.25;
        const reorderQty = Math.max(0, Math.ceil(targetSupply + safetyStock - currentStock));

        return {
          ...product,
          currentStock,
          dailyVelocity,
          reorderQty
        };
      });

      // Sort by reorder quantity (highest first)
      const sortedProducts = productsWithForecasts.sort((a, b) => b.reorderQty - a.reorderQty);

      // Create CSV content
      const headers = ['SKU', 'Product', 'Distributor', 'Velocity', 'Stock', 'Cost', 'Order Qty'];
      const rows = sortedProducts.map(p => [
        p.sku || 'N/A',
        `"${p.name.replace(/"/g, '""')}"`, // Escape quotes in product names
        p.distributor || 'Unknown',
        p.dailyVelocity.toFixed(1),
        p.currentStock,
        p.cost ? p.cost.toFixed(2) : 'N/A',
        p.reorderQty
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');

      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const distributor = forecastFilterDistributor !== 'all' ? forecastFilterDistributor : 'All';
      const fileName = `Forecast_${distributor.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      setFeedback('‚úÖ CSV downloaded!');
      setTimeout(() => setFeedback(''), 3000);
    } catch (error) {
      console.error('CSV generation error:', error);
      setFeedback('‚ùå Error generating CSV');
      setTimeout(() => setFeedback(''), 3000);
    }
  };

  // Generate Purchase Orders by Distributor
  const generatePurchaseOrders = () => {
    if (allDatabaseProducts.length === 0) {
      setFeedback('‚ö†Ô∏è Load products first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    try {
      // Create cost lookup from planogram (distributor stays API-only)
      const costLookup = {};
      sections.forEach(section => {
        const products = section.rows ? 
          section.rows.flatMap(row => row.products || []) : 
          (section.products || []);
        
        products.forEach(product => {
          if (product.upc && product.cost !== undefined && product.cost !== null && product.cost !== '') {
            costLookup[product.upc] = product.cost;
          }
        });
      });
      
      // Use API data with planogram costs
      let allProducts = allDatabaseProducts.map(p => ({
        upc: p.barcode,
        name: p.variantTitle ? `${p.title} - ${p.variantTitle}` : p.title,
        sku: p.sku,
        vendor: p.vendor,
        distributor: p.distributor,  // Always from API
        cost: costLookup[p.barcode] || p.cost,  // Planogram cost first, fallback to API
        inventoryQuantity: p.stock,
        dailySales: p.dailySales,
        weeklySales: p.weeklySales,
        monthlySales: p.monthlySales
      }));

      // Apply current filters
      if (forecastFilterDistributor !== 'all') {
        allProducts = allProducts.filter(p => {
          const dist = p.distributor?.trim();
          const distributor = dist && dist !== '' ? dist : 'Unknown Distributor';
          return distributor === forecastFilterDistributor;
        });
      }

      // Calculate forecasting metrics
      const productsWithForecasts = allProducts.map(product => {
        let salesVolume = 0;
        let daysInPeriod = 30;
        
        if (timePeriod === 'dateRange' && dateRangeSalesData) {
          const variantSales = dateRangeSalesData.salesData.find(
            s => s.variantId.toString() === product.variantId?.toString()
          );
          salesVolume = variantSales ? variantSales.totalSales : 0;
          daysInPeriod = dateRangeSalesData.daysInPeriod;
        } else {
          switch(timePeriod) {
            case 'day':
              salesVolume = product.dailySales || 0;
              daysInPeriod = 1;
              break;
            case 'week':
              salesVolume = product.weeklySales || 0;
              daysInPeriod = 7;
              break;
            case 'month':
              salesVolume = product.monthlySales || 0;
              daysInPeriod = 30;
              break;
            default:
              salesVolume = product.monthlySales || 0;
              daysInPeriod = 30;
          }
        }

        const dailyVelocity = daysInPeriod > 0 ? salesVolume / daysInPeriod : 0;
        const currentStock = product.inventoryQuantity !== null && product.inventoryQuantity !== undefined 
          ? product.inventoryQuantity 
          : 0;
        
        const targetSupply = dailyVelocity * 30;
        const safetyStock = targetSupply * 0.25;
        const reorderQty = Math.max(0, Math.ceil(targetSupply + safetyStock - currentStock));

        return {
          ...product,
          currentStock,
          dailyVelocity,
          reorderQty
        };
      });

      // Use all products (don't filter by reorderQty - include everything from this distributor)
      const productsNeedingReorder = productsWithForecasts;

      if (productsNeedingReorder.length === 0) {
        setFeedback('‚úÖ No products need reordering!');
        setTimeout(() => setFeedback(''), 3000);
        return;
      }

      // Group by distributor
      const byDistributor = {};
      productsNeedingReorder.forEach(product => {
        const dist = product.distributor?.trim() || 'Unknown Distributor';
        if (!byDistributor[dist]) {
          byDistributor[dist] = [];
        }
        byDistributor[dist].push(product);
      });

      // Generate PDF for each distributor
      const { jsPDF } = window.jspdf;
      const distributorNames = Object.keys(byDistributor).sort();

      distributorNames.forEach((distributor) => {
        const products = byDistributor[distributor];
        
        // Sort by reorder quantity (highest first)
        const sortedProducts = products.sort((a, b) => b.reorderQty - a.reorderQty);
        
        const doc = new jsPDF();
        
        // Header
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('PURCHASE ORDER', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const today = new Date().toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        doc.text(`Date: ${today}`, 20, 35);
        
        // Distributor info
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Vendor:', 20, 45);
        doc.setFont(undefined, 'normal');
        doc.text(distributor, 45, 45);
        
        // Store info
        doc.setFontSize(10);
        doc.text('From:', 20, 55);
        doc.text('A1 Beauty Supply', 20, 60);
        doc.text('Denver, Colorado', 20, 65);
        
        // Table header
        const startY = 80;
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('SKU', 20, startY);
        doc.text('Product', 50, startY);
        doc.text('Velocity', 120, startY);
        doc.text('Stock', 145, startY);
        doc.text('Cost', 165, startY);
        doc.text('Order Qty', 182, startY);
        
        // Draw header line
        doc.setLineWidth(0.5);
        doc.line(20, startY + 2, 200, startY + 2);
        
        // Table rows
        doc.setFont(undefined, 'normal');
        let yPos = startY + 8;
        let totalQty = 0;
        let totalCost = 0;
        
        sortedProducts.forEach((product) => {
          // Check if we need a new page
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
            
            // Repeat header on new page
            doc.setFont(undefined, 'bold');
            doc.text('SKU', 20, yPos);
            doc.text('Product', 50, yPos);
            doc.text('Velocity', 120, yPos);
            doc.text('Stock', 145, yPos);
            doc.text('Cost', 165, yPos);
            doc.text('Order Qty', 182, yPos);
            doc.line(20, yPos + 2, 200, yPos + 2);
            doc.setFont(undefined, 'normal');
            yPos += 8;
          }
          
          const sku = product.sku || 'N/A';
          const name = product.name.length > 35 ? product.name.substring(0, 35) + '...' : product.name;
          const velocity = product.dailyVelocity.toFixed(1);
          const stock = product.currentStock.toString();
          const cost = product.cost ? '$' + product.cost.toFixed(2) : 'N/A';
          const qty = product.reorderQty.toString();
          
          doc.text(sku, 20, yPos);
          doc.text(name, 50, yPos);
          doc.text(velocity, 127, yPos, { align: 'right' });
          doc.text(stock, 152, yPos, { align: 'right' });
          doc.text(cost, 177, yPos, { align: 'right' });
          doc.text(qty, 195, yPos, { align: 'right' });
          
          totalQty += product.reorderQty;
          if (product.cost) {
            totalCost += product.cost * product.reorderQty;
          }
          yPos += 6;
        });
        
        // Summary
        yPos += 5;
        doc.setLineWidth(0.5);
        doc.line(20, yPos, 200, yPos);
        yPos += 8;
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(10);
        doc.text('TOTAL ITEMS:', 140, yPos);
        doc.text(sortedProducts.length.toString(), 190, yPos, { align: 'right' });
        
        yPos += 6;
        doc.text('TOTAL UNITS:', 140, yPos);
        doc.text(totalQty.toString(), 190, yPos, { align: 'right' });
        
        yPos += 6;
        doc.text('ESTIMATED COST:', 140, yPos);
        doc.text('$' + totalCost.toFixed(2), 190, yPos, { align: 'right' });
        
        // Footer - position dynamically to avoid overlap
        yPos += 10; // Add space after summary
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.text('Order quantities based on 30-day supply forecast with 25% safety stock. Items with 0 qty are well-stocked.', 105, yPos, { align: 'center' });
        yPos += 5;
        doc.text('Please confirm pricing and availability before processing.', 105, yPos, { align: 'center' });
        
        // Save PDF
        const fileName = `PO_${distributor.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
      });

      setFeedback(`‚úÖ Generated ${distributorNames.length} purchase order(s)`);
      setTimeout(() => setFeedback(''), 3000);

    } catch (error) {
      console.error('Error generating PO:', error);
      setFeedback(`‚ùå Error generating PO: ${error.message}`);
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  // Fetch sales data for custom date range
  const fetchDateRangeSales = async () => {
    if (!dateRangeStart || !dateRangeEnd) {
      setFeedback('‚ö†Ô∏è Please select both start and end dates');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    const start = new Date(dateRangeStart);
    const end = new Date(dateRangeEnd);
    
    if (start > end) {
      setFeedback('‚ö†Ô∏è Start date must be before end date');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setLoadingDateRangeSales(true);
    
    try {
      const config = JSON.parse(localStorage.getItem('shopifyConfig') || '{}');
      
      if (!config.storeName || !config.accessToken) {
        setFeedback('‚ùå Not connected to Shopify');
        setTimeout(() => setFeedback(''), 3000);
        return;
      }

      // Format dates for Shopify API (ISO 8601)
      const startISO = `${dateRangeStart}T00:00:00Z`;
      const endISO = `${dateRangeEnd}T23:59:59Z`;

      console.log('üìä Fetching sales for date range:', startISO, 'to', endISO);

      const response = await fetch(
        `${BACKEND_URL}/api/sales/date-range?` + 
        `storeName=${encodeURIComponent(config.storeName)}&` +
        `accessToken=${encodeURIComponent(config.accessToken)}&` +
        `startDate=${encodeURIComponent(startISO)}&` +
        `endDate=${encodeURIComponent(endISO)}`
      );

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      
      console.log('‚úÖ Date range sales loaded:', data.variantsWithSales, 'variants');
      
      setDateRangeSalesData(data);
      setUseCustomDateRange(true);
      setTimePeriod('dateRange');
      
      setFeedback(`‚úÖ Loaded sales for ${data.daysInPeriod} days (${data.totalOrders} orders)`);
      setTimeout(() => setFeedback(''), 3000);
      
    } catch (error) {
      console.error('‚ùå Error fetching date range sales:', error);
      setFeedback(`‚ùå Failed to fetch date range sales: ${error.message}`);
      setTimeout(() => setFeedback(''), 5000);
    } finally {
      setLoadingDateRangeSales(false);
    }
  };

  // Auto-refresh live inventory once per day
  useEffect(() => {
    if (!shopifyConfig.connected) return;
    
    const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
    
    // Check if we should load on initial mount
    const lastLoadTime = localStorage.getItem('lastInventoryLoadTime');
    const now = Date.now();
    
    if (!lastLoadTime || (now - parseInt(lastLoadTime)) > TWENTY_FOUR_HOURS) {
      console.log('üîÑ Auto-loading inventory (daily refresh)...');
      loadAllProductsFromDatabase();
      localStorage.setItem('lastInventoryLoadTime', now.toString());
    }
    
    // Set up daily refresh interval
    const intervalId = setInterval(() => {
      console.log('üîÑ Daily auto-refresh triggered...');
      loadAllProductsFromDatabase();
      localStorage.setItem('lastInventoryLoadTime', Date.now().toString());
    }, TWENTY_FOUR_HOURS);
    
    return () => clearInterval(intervalId);
  }, [shopifyConfig.connected]);

  const refreshAllProductData = async () => {
    if (!shopifyConfig.connected) {
      setFeedback('‚ö†Ô∏è Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setIsRefreshing(true);
    setFeedback('üîÑ Refreshing all product data... Please wait.');

    try {
      // Gather all unique UPCs from all sections
      const allUPCs = new Set();
      sections.forEach(section => {
        const products = section.rows ? 
          section.rows.flatMap(row => row.products || []) : 
          (section.products || []);
        products.forEach(p => {
          if (p.upc) allUPCs.add(p.upc);
        });
      });

      const upcArray = Array.from(allUPCs);
      console.log(`üîç Found ${upcArray.length} unique products to refresh`);
      setFeedback(`üîÑ Refreshing ${upcArray.length} products...`);

      // Fetch fresh data for each UPC
      const freshProductData = {};
      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < upcArray.length; i++) {
        const upc = upcArray[i];
        try {
          // üî¥ FETCH LIVE INVENTORY FROM SHOPIFY
          const url = new URL(`${BACKEND_URL}/api/shopify/live-inventory/${upc}`);
          if (shopifyConfig.connected) {
            url.searchParams.append('storeName', shopifyConfig.storeName);
            url.searchParams.append('accessToken', shopifyConfig.accessToken);
          }
          
          const response = await fetch(url);
          if (response.ok) {
            const data = await response.json();
            console.log('üî¥ LIVE product data received:', { 
              name: data.title, 
              stock: data.inventoryQuantity,
              source: data.source
            });
            freshProductData[upc] = {
              name: data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title,
              price: data.price,
              compareAtPrice: data.compareAtPrice,
              cost: data.cost,
              dailySales: data.dailySales || 0,
              weeklySales: data.weeklySales || 0,
              monthlySales: data.monthlySales || 0,
              quarterlySales: data.quarterlySales || 0,
              yearlySales: data.yearlySales || 0,
              allTimeSales: data.allTimeSales || 0,
              inventoryQuantity: data.inventoryQuantity !== null && data.inventoryQuantity !== undefined 
                ? data.inventoryQuantity 
                : 0,
              sku: data.sku,
              vendor: data.vendor,
              distributor: data.distributor,
              tags: data.tags,
              createdAt: data.createdAt,
              analytics: data.analytics || {}
            };
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          console.error(`Failed to fetch ${upc}:`, error);
          errorCount++;
        }

        // Update feedback every 10 products
        if ((i + 1) % 10 === 0) {
          setFeedback(`üîÑ Progress: ${i + 1}/${upcArray.length} products...`);
        }
      }

      console.log(`‚úÖ Fetched fresh data for ${successCount} products (${errorCount} errors)`);
      setFeedback(`üîÑ Updating products in planogram...`);

      // Update all products in sections with fresh data
      const updatedSections = sections.map(section => {
        if (section.rows) {
          // Update products in rows
          const updatedRows = section.rows.map(row => ({
            ...row,
            products: (row.products || []).map(product => {
              if (product.upc && freshProductData[product.upc]) {
                return {
                  ...product,
                  ...freshProductData[product.upc],
                  source: 'database'
                };
              }
              return product;
            })
          }));
          return { ...section, rows: updatedRows };
        } else if (section.products) {
          // Update products directly in section
          const updatedProducts = section.products.map(product => {
            if (product.upc && freshProductData[product.upc]) {
              return {
                ...product,
                ...freshProductData[product.upc],
                source: 'database'
              };
            }
            return product;
          });
          return { ...section, products: updatedProducts };
        }
        return section;
      });

      setSections(updatedSections);
      autoSave(updatedSections, 'Refreshed all product data');
      
      setFeedback(`‚úÖ Success! Updated ${successCount} products with fresh data (${errorCount} failed)`);
      setTimeout(() => {
        setFeedback('');
        window.location.reload(); // Reload page to show updated inventory
      }, 2000); // Wait 2 seconds so user sees the success message

    } catch (error) {
      console.error('Error refreshing product data:', error);
      setFeedback('‚ùå Failed to refresh product data');
      setTimeout(() => setFeedback(''), 5000);
    } finally {
      setIsRefreshing(false);
    }
  };

  const refreshSalesOnly = async () => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      setFeedback('‚ö†Ô∏è Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    console.log('üí∞ Starting sales refresh...');
    setSyncProgress({ message: 'Loading sales', current: 0, total: 0 });
    setFeedback('üìä Refreshing sales data...');
    
    try {
      console.log('üì° Calling backend /api/shopify with action: refreshSales');
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshSales'
        })
      });

      const data = await response.json();
      console.log('‚úÖ Backend response:', data);

      if (response.ok && data.success) {
        const now = new Date();
        setLastRefresh(now);
        setLastSalesRefresh(now);
        localStorage.setItem('planogram_last_refresh', now.toISOString());
        localStorage.setItem('planogram_last_sales_refresh', now.toISOString());
        
        if (data.totalUpdated) {
          setSyncProgress({ message: 'Sales loaded', current: data.totalUpdated, total: data.totalUpdated });
          setFeedback(`‚úÖ Updated ${data.totalUpdated} products with sales data`);
        } else {
          setFeedback(`‚úÖ ${data.message}`);
        }
        
        setTimeout(() => {
          setSyncProgress({ message: '', current: 0, total: 0 });
          setFeedback('');
        }, 3000);
      } else {
        setSyncProgress({ message: '', current: 0, total: 0 });
        setFeedback(`‚ùå ${data.error || 'Failed'}`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } catch (error) {
      setSyncProgress({ message: '', current: 0, total: 0 });
      setFeedback('‚ùå Sales refresh failed');
      setTimeout(() => setFeedback(''), 5000);
      console.error('Sales refresh error:', error);
    }
  };

  // üî• Order Blitz: Refresh order data
  const refreshOrders = async () => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      setFeedback('‚ö†Ô∏è Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    console.log('üî• Starting Order Blitz...');
    setSyncProgress({ message: 'üî• Starting Order Blitz...', current: 0, total: 0 });
    setFeedback('üî• Order Blitz: Starting...');
    
    try {
      console.log('üì° Calling backend /api/shopify with action: refreshOrders');
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshOrders'
        })
      });

      const data = await response.json();
      console.log('‚úÖ Backend response:', data);

      if (response.ok && data.success) {
        const now = new Date();
        setLastOrdersRefresh(now);
        localStorage.setItem('planogram_last_orders_refresh', now.toISOString());
        
        // Check if processing in background
        if (data.processing) {
          console.log(`üìä Processing ${data.totalOrders || '...'} orders in background`);
          setSyncProgress({ message: 'üî• Processing orders...', current: 0, total: data.totalOrders || 0 });
          setFeedback(`üî• Order Blitz: Processing ${data.totalOrders || '...'} orders...`);
          
          // Poll every 2 seconds to check progress
          console.log('‚è±Ô∏è Starting progress polling every 2 seconds...');
          let pollCount = 0;
          const maxPolls = 150; // Stop after 5 minutes (150 polls x 2 seconds)
          const checkStatus = setInterval(async () => {
            try {
              pollCount++;
              console.log(`üîÑ Poll #${pollCount}/${maxPolls} - Checking order status...`);
              
              // Safety: Stop polling after max attempts
              if (pollCount > maxPolls) {
                console.log('‚ö†Ô∏è Max polling attempts reached, stopping...');
                clearInterval(checkStatus);
                setSyncProgress({ message: '', current: 0, total: 0 });
                setFeedback('‚ö†Ô∏è Order processing took too long. Check Settings > Data Management.');
                setTimeout(() => setFeedback(''), 5000);
                return;
              }
              
              const statusRes = await fetch(`${BACKEND_URL}/api/orders/status`);
              const statusData = await statusRes.json();
              console.log(`üì• Status response:`, statusData);
              
              // Update progress if backend provides it
              if (statusData.progress) {
                const { processed, total } = statusData.progress;
                console.log(`üìä Progress: ${processed}/${total} orders processed`);
                setSyncProgress({ 
                  message: `Processing orders`, 
                  current: processed || 0, 
                  total: total || 0 
                });
                setFeedback(`üî• Order Blitz: ${processed || 0}/${total || 0} orders processed`);
              } else {
                // Backend doesn't report progress - just show we're still processing
                console.log(`‚è≥ No progress data from backend, still processing...`);
                setFeedback(`üî• Order Blitz: Processing... (${pollCount * 2}s elapsed)`);
              }
              
              if (!statusData.isProcessing && statusData.lastResult) {
                console.log('‚úÖ Order processing complete!');
                clearInterval(checkStatus);
                setSyncProgress({ message: '', current: 0, total: 0 });
                
                // Update with results
                if (statusData.lastResult.analytics) {
                  setOrderAnalytics(statusData.lastResult.analytics);
                  localStorage.setItem('planogram_order_analytics', JSON.stringify(statusData.lastResult.analytics));
                }
                
                // Update orderAnalyticsData for Order Analytics page
                if (statusData.lastResult.orders) {
                  const orders = statusData.lastResult.orders;
                  const now = new Date();
                  
                  // Create date boundaries in LOCAL timezone
                  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                  const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
                  const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  weekStart.setHours(0, 0, 0, 0);
                  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
                  const yearStart = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
                  
                  console.log('üìÖ Background Processing Date Debug:');
                  console.log('  Current time (now):', now.toLocaleString());
                  console.log('  now.getMonth():', now.getMonth(), '(0=Jan, 11=Dec)');
                  console.log('  Current month name:', now.toLocaleString('en-US', { month: 'long' }));
                  console.log('  Today range:', todayStart.toLocaleString(), 'to', todayEnd.toLocaleString());
                  console.log('  Week start:', weekStart.toLocaleString());
                  console.log('  Month start:', monthStart.toLocaleString());
                  console.log('  Month start month name:', monthStart.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }));
                  console.log('  Year start:', yearStart.toLocaleString());
                  
                  let totalSales = 0;
                  let salesToday = 0, salesWeek = 0, salesMonth = 0, salesYear = 0;
                  let ordersToday = 0, ordersWeek = 0, ordersMonth = 0, ordersYear = 0;
                  
                  const monthOrders = []; // Debug: track which orders count as "this month"
                  
                  orders.forEach(order => {
                    const orderDate = new Date(order.created_at);
                    const orderTotal = parseFloat(order.total_price || 0);
                    totalSales += orderTotal;
                    
                    // Use proper date range for "today" (start to end of day)
                    const isToday = orderDate >= todayStart && orderDate < todayEnd;
                    if (isToday) {
                      salesToday += orderTotal;
                      ordersToday++;
                    }
                    if (orderDate >= weekStart) {
                      salesWeek += orderTotal;
                      ordersWeek++;
                    }
                    if (orderDate >= monthStart) {
                      salesMonth += orderTotal;
                      ordersMonth++;
                      // Debug: save first 5 orders
                      if (monthOrders.length < 5) {
                        monthOrders.push({
                          id: order.order_number || order.id,
                          date: orderDate.toLocaleString(),
                          total: orderTotal
                        });
                      }
                    }
                    if (orderDate >= yearStart) {
                      salesYear += orderTotal;
                      ordersYear++;
                    }
                  });
                  
                  console.log(`  üí∞ Background calc: ${ordersToday} orders today, $${salesToday.toFixed(2)}`);
                  console.log(`  üìä Month calc: ${ordersMonth} orders this month, $${salesMonth.toFixed(2)}`);
                  console.log(`  üì¶ Sample month orders:`, monthOrders);
                  
                  setOrderAnalyticsData({
                    totalOrders: orders.length,
                    totalSales: totalSales,
                    lastRefresh: now.toLocaleString(),
                    status: 'Complete',
                    recentOrders: orders.slice(0, 50),
                    allOrders: orders,  // Store ALL orders for pattern analysis
                    salesByPeriod: {
                      today: salesToday,
                      week: salesWeek,
                      month: salesMonth,
                      year: salesYear
                    },
                    ordersByPeriod: {
                      today: ordersToday,
                      week: ordersWeek,
                      month: ordersMonth,
                      year: ordersYear
                    }
                  });
                }
                
                setLastOrdersRefresh(new Date(statusData.lastCompleted));
                localStorage.setItem('planogram_last_orders_refresh', statusData.lastCompleted);
                
                // Fetch correlations after orders are processed
                fetchCorrelations();
                
                setFeedback(`‚úÖ COMPLETE: ${statusData.lastResult.ordersProcessed} orders, ${statusData.lastResult.itemsProcessed} items analyzed!`);
                setTimeout(() => setFeedback(''), 8000);
              }
            } catch (err) {
              console.error('‚ùå Status check failed:', err);
              setFeedback(`‚ö†Ô∏è Status check error: ${err.message}`);
            }
          }, 2000); // Check every 2 seconds (was 10 seconds)
          
          // Also set a timeout to stop polling after 5 minutes
          setTimeout(() => {
            clearInterval(checkStatus);
          }, 5 * 60 * 1000);
        } else {
          // Old response format (immediate completion) OR backend doesn't support background processing
          console.log('‚ö° Immediate completion (no background processing)');
          setSyncProgress({ message: '', current: 0, total: 0 });
          
          if (data.analytics) {
            setOrderAnalytics(data.analytics);
            localStorage.setItem('planogram_order_analytics', JSON.stringify(data.analytics));
          }
          
          // Fetch correlations after orders are processed
          fetchCorrelations();
          
          setFeedback(`‚úÖ Order Blitz: ${data.ordersProcessed || '?'} orders, ${data.itemsProcessed || '?'} items analyzed!`);
          setTimeout(() => setFeedback(''), 8000);
        }
      } else {
        console.error('‚ùå Backend error:', data);
        setSyncProgress({ message: '', current: 0, total: 0 });
        setFeedback(`‚ùå ${data.error || 'Order import failed'}`);
        setTimeout(() => setFeedback(''), 5000);
      }
    } catch (error) {
      console.error('‚ùå Order import error:', error);
      setSyncProgress({ message: '', current: 0, total: 0 });
      setFeedback(`‚ùå Order import failed: ${error.message}`);
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  const fetchAllOrders = async () => {
    setOrderAnalyticsData(prev => ({ ...prev, status: 'Loading...' }));
    
    try {
      // ALWAYS call getOrderAnalytics to get recent orders WITH line items
      const analyticsResponse = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storeName: '1m3tfh-xt.myshopify.com',
          accessToken: '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',
          action: 'getOrderAnalytics'
        })
      });

      if (!analyticsResponse.ok) {
        throw new Error(`HTTP ${analyticsResponse.status}: Backend error`);
      }

      const analyticsData = await analyticsResponse.json();
      console.log('‚úÖ Got analytics with line items:', analyticsData.recentOrders?.length, 'orders');
      
      // Try to also get full order list for analysis
      try {
        const ordersResponse = await fetch(`${BACKEND_URL}/api/shopify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            storeName: '1m3tfh-xt.myshopify.com',
            accessToken: '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',
            action: 'getOrders'
          })
        });

        if (ordersResponse.ok) {
          const ordersData = await ordersResponse.json();
          console.log('‚úÖ Got full order list:', ordersData.orders?.length, 'orders');
          
          // Combine: use analytics data for recent orders (WITH line items),
          // but use full order list for pattern analysis
          setOrderAnalyticsData({
            totalOrders: analyticsData.totalOrders || ordersData.orders?.length || 0,
            totalSales: analyticsData.totalSales || 0,
            avgOrderValue: analyticsData.avgOrderValue || 0,
            uniqueCustomers: analyticsData.uniqueCustomers || 0,
            processingStatus: 'Complete',
            lastRefresh: new Date().toLocaleString(),
            status: 'Complete',
            recentOrders: analyticsData.recentOrders || [], // FROM ANALYTICS (has line items!)
            allOrders: ordersData.orders || [], // FROM getOrders (for pattern analysis)
            topProducts: analyticsData.topProducts || [],
            salesByPeriod: analyticsData.salesByPeriod || {
              today: { orders: 0, sales: 0 },
              week: { orders: 0, sales: 0 },
              month: { orders: 0, sales: 0 },
              year: { orders: 0, sales: 0 }
            }
          });
          
          return;
        }
      } catch (ordersErr) {
        console.log('‚ö†Ô∏è Could not fetch full order list, using analytics only:', ordersErr.message);
      }
      
      // If getOrders failed, just use analytics data
      setOrderAnalyticsData({
        totalOrders: analyticsData.totalOrders || 0,
        totalSales: analyticsData.totalSales || 0,
        avgOrderValue: analyticsData.avgOrderValue || 0,
        uniqueCustomers: analyticsData.uniqueCustomers || 0,
        processingStatus: 'Complete',
        lastRefresh: new Date().toLocaleString(),
        status: 'Complete',
        recentOrders: analyticsData.recentOrders || [],
        topProducts: analyticsData.topProducts || [],
        salesByPeriod: analyticsData.salesByPeriod || {
          today: { orders: 0, sales: 0 },
          week: { orders: 0, sales: 0 },
          month: { orders: 0, sales: 0 },
          year: { orders: 0, sales: 0 }
        }
      });
      
      // Check if we got orders array or analytics object
      if (data.orders) {
        // Full orders data - process it
        const orders = data.orders;
        console.log('üìä Got full orders, total:', orders.length);
        if (orders.length > 0) {
          console.log('üìä Sample order:', orders[0]);
        }
        
        const now = new Date();
        
        // Create date boundaries in LOCAL timezone (Denver/Mountain Time)
        // This ensures "today" means today in YOUR timezone, not UTC
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
        const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
        const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        weekStart.setHours(0, 0, 0, 0); // Start of that day
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
        const yearStart = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
        
        console.log('üìÖ Date Filtering Debug:');
        console.log('  Current time:', now.toLocaleString());
        console.log('  Today range:', todayStart.toLocaleString(), 'to', todayEnd.toLocaleString());
        console.log('  todayStart timestamp:', todayStart.getTime());
        console.log('  todayEnd timestamp:', todayEnd.getTime());
        
        let totalSales = 0;
        let salesToday = 0, salesWeek = 0, salesMonth = 0, salesYear = 0;
        let ordersToday = 0, ordersWeek = 0, ordersMonth = 0, ordersYear = 0;
        
        let todayOrders = [];
        const orderIdsSeen = new Set(); // Track duplicates
        
        // USER SAYS: Today's orders begin at #10763
        const TODAYS_FIRST_ORDER = 10763;
        
        console.log('\nüîç DETAILED ORDER ANALYSIS:');
        console.log('‚ö†Ô∏è USER CONFIRMED: Today\'s orders begin at #' + TODAYS_FIRST_ORDER);
        console.log('Checking each order against today range...\n');
        
        orders.forEach((order, index) => {
          // Parse order date and convert to local timezone for comparison
          const orderDate = new Date(order.created_at);
          const orderTotal = parseFloat(order.total_price || 0);
          const orderId = order.order_number || order.id;
          
          totalSales += orderTotal;
          
          // Check if this is a duplicate
          const isDuplicate = orderIdsSeen.has(orderId);
          if (isDuplicate) {
            console.log(`‚ö†Ô∏è DUPLICATE ORDER DETECTED: #${orderId}`);
          }
          orderIdsSeen.add(orderId);
          
          // Check if order number is before today's range
          const isBeforeTodayRange = orderId < TODAYS_FIRST_ORDER;
          
          // Compare dates (both are now in local timezone)
          const orderTimestamp = orderDate.getTime();
          const todayStartTimestamp = todayStart.getTime();
          const todayEndTimestamp = todayEnd.getTime();
          
          const isToday = orderDate >= todayStart && orderDate < todayEnd;
          
          // Log first 40 orders to see what's happening
          if (index < 40) {
            console.log(`Order #${orderId}:`);
            console.log(`  created_at: ${order.created_at}`);
            console.log(`  Parsed date: ${orderDate.toLocaleString()}`);
            console.log(`  Timestamp: ${orderTimestamp}`);
            console.log(`  >= todayStart? ${orderTimestamp >= todayStartTimestamp} (${orderTimestamp} >= ${todayStartTimestamp})`);
            console.log(`  < todayEnd? ${orderTimestamp < todayEndTimestamp} (${orderTimestamp} < ${todayEndTimestamp})`);
            console.log(`  ‚úÖ Counted as TODAY? ${isToday}`);
            if (isToday && isBeforeTodayRange) {
              console.log(`  üö® WARNING: Order #${orderId} < #${TODAYS_FIRST_ORDER} but counted as TODAY! (WRONG DATE)`);
            }
            console.log(`  Total: $${orderTotal.toFixed(2)}`);
            console.log('');
          }
          
          if (isToday) {
            salesToday += orderTotal;
            ordersToday++;
            todayOrders.push({
              orderNumber: orderId,
              created_at: order.created_at,
              date: orderDate.toLocaleString(),
              timestamp: orderTimestamp,
              total: orderTotal,
              isDuplicate: isDuplicate,
              shouldNotBeToday: isBeforeTodayRange
            });
          }
          if (orderDate >= weekStart) {
            salesWeek += orderTotal;
            ordersWeek++;
          }
          if (orderDate >= monthStart) {
            salesMonth += orderTotal;
            ordersMonth++;
          }
          if (orderDate >= yearStart) {
            salesYear += orderTotal;
            ordersYear++;
          }
        });
        
        // Find orders wrongly counted as today
        const wrongOrders = todayOrders.filter(o => o.shouldNotBeToday);
        
        console.log(`\nüìä TODAY'S ORDERS (${ordersToday} total):`);
        console.log('All orders counted as today:');
        console.table(todayOrders);
        console.log(`\nüí∞ Today's total: ${ordersToday} orders, $${salesToday.toFixed(2)}`);
        console.log(`‚ö†Ô∏è Duplicates detected: ${todayOrders.filter(o => o.isDuplicate).length}`);
        console.log(`üö® Orders < #${TODAYS_FIRST_ORDER} wrongly counted: ${wrongOrders.length}`);
        
        if (wrongOrders.length > 0) {
          console.log(`\nüö® THESE ORDERS SHOULD NOT BE COUNTED AS TODAY:`);
          console.table(wrongOrders);
        }
        
        setOrderAnalyticsData({
          totalOrders: orders.length,
          totalSales: totalSales,
          avgOrderValue: orders.length > 0 ? totalSales / orders.length : 0,
          uniqueCustomers: new Set(orders.map(o => o.customer?.id).filter(Boolean)).size,
          processingStatus: 'Complete',
          lastRefresh: new Date().toLocaleString(),
          status: 'Complete',
          recentOrders: orders.slice(0, 50).sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
          ),
          allOrders: orders,  // Store ALL orders for pattern analysis
          topProducts: [],
          salesByPeriod: {
            today: { orders: ordersToday, sales: salesToday },
            week: { orders: ordersWeek, sales: salesWeek },
            month: { orders: ordersMonth, sales: salesMonth },
            year: { orders: ordersYear, sales: salesYear }
          }
        });
        
        console.log('‚úÖ Processed full order data');
        
      } else {
        // Analytics summary data - use directly
        console.log('üìä Got analytics summary');
        setOrderAnalyticsData({
          totalOrders: data.totalOrders || 0,
          totalSales: data.totalSales || 0,
          avgOrderValue: data.avgOrderValue || 0,
          uniqueCustomers: data.uniqueCustomers || 0,
          processingStatus: 'Complete',
          lastRefresh: new Date().toLocaleString(),
          status: 'Complete',
          recentOrders: data.recentOrders || [],
          topProducts: data.topProducts || [],
          salesByPeriod: data.salesByPeriod || {
            today: { orders: 0, sales: 0 },
            week: { orders: 0, sales: 0 },
            month: { orders: 0, sales: 0 },
            year: { orders: 0, sales: 0 }
          }
        });
        
        console.log('‚úÖ Used analytics summary');
      }
      
    } catch (err) {
      console.error('‚ùå Failed to fetch order analytics:', err);
      setOrderAnalyticsData(prev => ({ 
        ...prev, 
        status: 'Error: ' + err.message,
        lastRefresh: new Date().toLocaleString()
      }));
    }
  };

  const fetchCorrelations = async () => {
    if (!shopifyConfig.connected) return;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/correlations`);
      if (response.ok) {
        const data = await response.json();
        setProductCorrelations(data.correlations || []);
        console.log(`‚úÖ Loaded ${data.correlations?.length || 0} product correlations`);
      }
    } catch (error) {
      console.error('Failed to fetch correlations:', error);
    }
  };


  const addProductToSection = async () => {
    console.log('üî• addProductToSection CALLED');
    console.log('üî• newProduct:', newProduct);
    
    if (!newProduct.upc || !newProduct.sectionId || !newProduct.rowId) {
      console.log('‚ùå Missing required fields');
      setFeedback('‚ö†Ô∏è Enter UPC and select section & row');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    console.log('‚úÖ All fields present, starting scan...');
    setScanning(true);
    const sectionIndex = sections.findIndex(s => s.id === newProduct.sectionId);
    
    if (sectionIndex === -1) {
      console.log('‚ùå Section not found');
      setFeedback('‚ö†Ô∏è Section not found');
      setScanning(false);
      return;
    }

    console.log('‚úÖ Section found at index:', sectionIndex);

    let product = null;
    
    if (shopifyConfig.connected) {
      try {
        // üî¥ FETCH LIVE INVENTORY FROM SHOPIFY (not database!)
        const url = new URL(`${BACKEND_URL}/api/shopify/live-inventory/${newProduct.upc}`);
        url.searchParams.append('storeName', shopifyConfig.storeName);
        url.searchParams.append('accessToken', shopifyConfig.accessToken);
        
        console.log('üî¥ Fetching LIVE inventory from Shopify...');
        const response = await fetch(url);
        const data = await response.json();

        if (response.ok && data.title) {
          // üî• Check for negative inventory - add to bad stock list BUT STILL add to row
          if (data.inventoryQuantity < 0) {
            // Add to BAD STOCK list (separate from unknown)
            const existingBadStock = badStockProducts.find(b => b.upc === newProduct.upc);
            if (!existingBadStock) {
              setBadStockProducts(prev => [...prev, {
                id: Date.now(),
                upc: newProduct.upc,
                note: `${data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title} (Stock: ${data.inventoryQuantity})`,
                addedAt: new Date().toISOString(),
                resolved: false,
                inventoryQuantity: data.inventoryQuantity,
                productData: data
              }]);
            }
          }
          
          // ALWAYS create product object regardless of stock level
          product = {
              upc: newProduct.upc,
              name: data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title,
              price: data.price,
              compareAtPrice: data.compareAtPrice,
              cost: data.cost,
              dailySales: data.dailySales || 0,
              weeklySales: data.weeklySales || 0,
              monthlySales: data.monthlySales || 0,
              quarterlySales: data.quarterlySales || 0,
              yearlySales: data.yearlySales || 0,
              allTimeSales: data.allTimeSales || 0,
              inventoryQuantity: data.inventoryQuantity,
              sku: data.sku,
              vendor: data.vendor,
              distributor: data.distributor,
              tags: data.tags,
              createdAt: data.createdAt,
              analytics: data.analytics || {
                timesPurchased: 0,
                averageOrderValue: 0,
                returningCustomerPurchases: 0,
                newCustomerPurchases: 0,
                averageCartPosition: 0,
                boughtTogether: []
              },
              quantity: 1,
              source: 'database',
              visualX: Math.random() * 80 + 10,
              visualY: Math.random() * 80 + 10
            };
            
            // Create feedback based on stock level
            if (data.inventoryQuantity < 0) {
              setFeedback(`‚ö†Ô∏è NEGATIVE STOCK (${data.inventoryQuantity}) - ${product.name} added to row AND Bad Stock list`);
            } else {
              const stockWarning = data.inventoryQuantity === 0 ? ' ‚ö†Ô∏è OUT OF STOCK' : 
                                  data.inventoryQuantity < 10 ? ' ‚ö†Ô∏è LOW STOCK' : '';
              const aovInfo = data.analytics?.averageOrderValue > 0 ? ` | AOV: $${data.analytics.averageOrderValue.toFixed(2)}` : '';
              setFeedback(`‚úÖ Added: ${product.name} (${data.monthlySales || 0} sales, ${data.inventoryQuantity} stock)${stockWarning}${aovInfo}`);
            }
        }
      } catch (error) {
        console.error('Error fetching from database:', error);
      }
    }
    
    if (!product && productDatabase[newProduct.upc]) {
      product = { 
        upc: newProduct.upc, 
        ...productDatabase[newProduct.upc],
        quantity: 1,
        source: 'sample',
        visualX: Math.random() * 80 + 10,
        visualY: Math.random() * 80 + 10
      };
      setFeedback(`‚úÖ Added: ${product.name} (Sample)`);
    }
    
    if (!product) {
      // Add to unknown products list
      const existingUnknown = unknownProducts.find(u => u.upc === newProduct.upc);
      if (!existingUnknown) {
        setUnknownProducts(prev => [...prev, {
          id: Date.now(),
          upc: newProduct.upc,
          note: '',
          addedAt: new Date().toISOString(),
          resolved: false
        }]);
      }
      
      product = {
        upc: newProduct.upc,
        name: `UPC: ${newProduct.upc}`,
        price: 0,
        cost: 0,
        monthlySales: 0,
        quantity: 1,
        source: 'placeholder',
        visualX: Math.random() * 80 + 10,
        visualY: Math.random() * 80 + 10
      };
      setFeedback('‚ö†Ô∏è Not found - added to Unknown Products list');
    }

    // Add product to the specified row
    const updatedSections = [...sections];
    const section = updatedSections[sectionIndex];
    const rowIndex = (section.rows || []).findIndex(r => r.id === newProduct.rowId);
    
    if (rowIndex >= 0) {
      // Initialize products array if it doesn't exist
      if (!section.rows[rowIndex].products) {
        section.rows[rowIndex].products = [];
      }
      section.rows[rowIndex].products.push(product);
      console.log('‚úÖ Product added to row:', section.rows[rowIndex].name);
    } else {
      // Fallback: add to section products if row not found
      if (!section.products) section.products = [];
      section.products.push(product);
      console.log('‚ö†Ô∏è Row not found, added to section products');
    }
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding product');

    setScanning(false);
    
    console.log('üîç Before clearing - UPC:', newProduct.upc, 'Sticky mode:', stickyRowMode);
    
    // üî• STICKY ROW MODE: Keep section and row selected, only clear UPC
    if (stickyRowMode) {
      setNewProduct({ 
        upc: '', 
        sectionId: newProduct.sectionId, 
        rowId: newProduct.rowId 
      });
      // Refocus the UPC input for rapid scanning
      setTimeout(() => {
        console.log('üîç After clearing - UPC should be empty, refocusing input');
        if (upcInputRef.current) {
          upcInputRef.current.focus();
          upcInputRef.current.value = ''; // Force clear the input value
        }
      }, 100);
    } else {
      setNewProduct({ upc: '', sectionId: '', rowId: '' });
    }
    
    setTimeout(() => setFeedback(''), 3000);
  };

  const updateProductQuantity = (sectionId, productIndex, delta) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedProducts = [...section.products];
        updatedProducts[productIndex] = {
          ...updatedProducts[productIndex],
          quantity: Math.max(0, updatedProducts[productIndex].quantity + delta)
        };
        return { ...section, products: updatedProducts };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after quantity update');
  };

  const updateProductPosition = (sectionId, productIndex, newX, newY) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedProducts = [...section.products];
        updatedProducts[productIndex] = {
          ...updatedProducts[productIndex],
          visualX: newX,
          visualY: newY
        };
        return { ...section, products: updatedProducts };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved product position');
  };

  const deleteProduct = (sectionId, productIndex) => {
    if (!confirm('Delete this product?')) return;

    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedProducts = section.products.filter((_, idx) => idx !== productIndex);
        return { ...section, products: updatedProducts };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after deleting product');
    
    setFeedback('‚úÖ Product deleted');
    setTimeout(() => setFeedback(''), 2000);
  };

  const addFixture = (type) => {
    const fixtureType = FIXTURE_TYPES[type];
    const newFixture = {
      id: `fixture-${Date.now()}`,
      type: fixtureType.id,
      name: fixtureType.name,
      x: 100,
      y: 100,
      width: fixtureType.defaultWidth,
      height: fixtureType.defaultHeight,
      color: fixtureType.color,
      sections: []
    };
    
    const updatedFixtures = [...fixtures, newFixture];
    setFixtures(updatedFixtures);
    localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
    setSelectedFixture(newFixture.id);
    autoSave(sections, updatedFixtures, 'Auto-saved after adding fixture');
  };

  const deleteFixture = (fixtureId) => {
    if (!confirm('Delete fixture and all sections?')) return;
    
    const updatedFixtures = fixtures.filter(f => f.id !== fixtureId);
    setFixtures(updatedFixtures);
    localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
    
    const updatedSections = sections.filter(s => s.fixtureId !== fixtureId);
    setSections(updatedSections);
    autoSave(updatedSections, updatedFixtures, 'Auto-saved after deleting fixture');
    
    if (selectedFixture === fixtureId) {
      setSelectedFixture(null);
    }
  };

  const updateFixture = (updatedFixture) => {
    const updatedFixtures = (fixtures || []).map(f => 
      f.id === updatedFixture.id ? updatedFixture : f
    );
    setFixtures(updatedFixtures);
    localStorage.setItem('planogram_fixtures', JSON.stringify(updatedFixtures));
    autoSave(sections, updatedFixtures, 'Auto-saved after updating fixture');
  };

  const addSection = (fixtureId) => {
    const fixture = fixtures.find(f => f.id === fixtureId);
    if (!fixture) return;

    const existingSections = sections.filter(s => s.fixtureId === fixtureId);

    // Smart default positioning - try to fit new section without overlap
    const numExisting = existingSections.length;
    let defaultX = 0;
    let defaultY = 0;
    let defaultWidth = 100;
    let defaultHeight = 100;

    if (numExisting > 0) {
      // Place new sections in rows
      const sectionsPerRow = 2;
      const row = Math.floor(numExisting / sectionsPerRow);
      const col = numExisting % sectionsPerRow;
      
      defaultWidth = 50;
      defaultHeight = 50;
      defaultX = col * 50;
      defaultY = row * 50;
    }

    // Set default dimensions based on fixture type
    let dimLength = 48;
    let dimDepth = 30;
    let dimHeight = 72;
    
    if (fixture.type === 'gondola') {
      dimDepth = 14;    // Gondolas are always 14" deep
      dimHeight = 57.5; // Gondolas are always 57.5" high
    }

    const newSection = {
      id: `section-${Date.now()}`,
      fixtureId: fixtureId,
      name: `Section ${existingSections.length + 1}`,
      type: 'regular', // 'regular' or 'deadspace'
      products: [],
      length: dimLength,
      depth: dimDepth,
      height: dimHeight,
      area: (dimLength * dimDepth) / 144, // Calculate from dimensions
      // Position and size within fixture (percentage-based 0-100)
      layoutX: defaultX,
      layoutY: defaultY,
      layoutWidth: defaultWidth,
      layoutHeight: defaultHeight,
      // NEW: Rows for height tracking
      rows: [
        { id: `row-${Date.now()}-1`, name: 'Row 1', products: [], isDeadSpace: false },
        { id: `row-${Date.now()}-2`, name: 'Row 2', products: [], isDeadSpace: false },
        { id: `row-${Date.now()}-3`, name: 'Row 3', products: [], isDeadSpace: false }
      ]
    };

    const updatedSections = [...sections, newSection];
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding section');
  };

  const addDeadSpaceSection = (fixtureId) => {
    const fixture = fixtures.find(f => f.id === fixtureId);
    if (!fixture) return;

    const existingSections = sections.filter(s => s.fixtureId === fixtureId);

    // Smart default positioning
    const numExisting = existingSections.length;
    let defaultX = 0;
    let defaultY = 0;
    let defaultWidth = 100;
    let defaultHeight = 100;

    if (numExisting > 0) {
      const sectionsPerRow = 2;
      const row = Math.floor(numExisting / sectionsPerRow);
      const col = numExisting % sectionsPerRow;
      
      defaultWidth = 50;
      defaultHeight = 50;
      defaultX = col * 50;
      defaultY = row * 50;
    }

    let dimLength = 48;
    let dimDepth = 30;
    let dimHeight = 72;
    
    if (fixture.type === 'gondola') {
      dimDepth = 14;
      dimHeight = 57.5;
    }

    const deadSpaceSection = {
      id: `section-${Date.now()}`,
      fixtureId: fixtureId,
      name: `Dead Space ${existingSections.filter(s => s.type === 'deadspace').length + 1}`,
      type: 'deadspace',
      products: [],
      length: dimLength,
      depth: dimDepth,
      height: dimHeight,
      area: (dimLength * dimDepth) / 144,
      layoutX: defaultX,
      layoutY: defaultY,
      layoutWidth: defaultWidth,
      layoutHeight: defaultHeight,
      rows: [] // Dead space doesn't need rows
    };

    const updatedSections = [...sections, deadSpaceSection];
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding dead space');
    setFeedback('‚úÖ Dead space section added');
    setTimeout(() => setFeedback(''), 2000);
  };

  const deleteSection = (sectionId) => {
    if (!confirm('Delete section and all products?')) return;
    
    const updatedSections = sections.filter(s => s.id !== sectionId);
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after deleting section');
    
    if (selectedSection === sectionId) {
      setSelectedSection(null);
    }
  };

  const updateSectionName = (sectionId, newName) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return { ...section, name: newName };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after renaming section');
    setEditingSection(null);
    setFeedback('‚úÖ Section renamed');
    setTimeout(() => setFeedback(''), 2000);
  };

  const moveSectionInList = (sectionId, direction) => {
    const sectionIndex = sections.findIndex(s => s.id === sectionId);
    if (sectionIndex === -1) return;
    
    const section = sections[sectionIndex];
    const fixtureSections = sections.filter(s => s.fixtureId === section.fixtureId);
    const fixtureIndex = fixtureSections.findIndex(s => s.id === sectionId);
    
    // Can't move up if first, can't move down if last
    if ((direction === 'up' && fixtureIndex === 0) || 
        (direction === 'down' && fixtureIndex === fixtureSections.length - 1)) {
      return;
    }
    
    // Get the section to swap with
    const swapSection = direction === 'up' 
      ? fixtureSections[fixtureIndex - 1]
      : fixtureSections[fixtureIndex + 1];
    
    // Find indices in main sections array
    const swapIndex = sections.findIndex(s => s.id === swapSection.id);
    
    // Swap the sections
    const updatedSections = [...sections];
    updatedSections[sectionIndex] = swapSection;
    updatedSections[swapIndex] = section;
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after reordering sections');
    setFeedback(`‚úÖ Section moved ${direction}`);
    setTimeout(() => setFeedback(''), 2000);
  };

  const updateSectionArea = (sectionId, newArea) => {
    const area = parseFloat(newArea);
    if (isNaN(area) || area <= 0) {
      setFeedback('‚ö†Ô∏è Area must be a positive number');
      setTimeout(() => setFeedback(''), 2000);
      return;
    }

    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return { ...section, area };
      }
      return section;
    });
    
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after updating area');
    setEditingSectionArea(null);
    setFeedback('‚úÖ Area updated');
    setTimeout(() => setFeedback(''), 2000);
  };

  const updateSection = (updatedSection) => {
    const updatedSections = sections.map(s => 
      s.id === updatedSection.id ? updatedSection : s
    );
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved section layout');
  };

  const updateFixtureName = (fixtureId, newName) => {
    const updatedFixtures = (fixtures || []).map(fixture => {
      if (fixture.id === fixtureId) {
        return { ...fixture, name: newName };
      }
      return fixture;
    });
    
    setFixtures(updatedFixtures);
    setEditingFixture(null);
    setFeedback('‚úÖ Fixture renamed');
    setTimeout(() => setFeedback(''), 2000);
  };

  // NEW: Row management functions
  const addRowToSection = (sectionId) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const rows = section.rows || [];
        const newRow = {
          id: `row-${Date.now()}`,
          name: `Row ${rows.length + 1}`,
          products: [],
          isDeadSpace: false
        };
        return {
          ...section,
          rows: [...rows, newRow]
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding row');
    setFeedback('‚úÖ Row added');
    setTimeout(() => setFeedback(''), 2000);
  };

  const addDeadRowToSection = (sectionId) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const rows = section.rows || [];
        const deadRowCount = rows.filter(r => r.isDeadSpace).length;
        const newRow = {
          id: `row-${Date.now()}`,
          name: `Dead Row ${deadRowCount + 1}`,
          products: [],
          isDeadSpace: true
        };
        return {
          ...section,
          rows: [...rows, newRow]
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after adding dead row');
    setFeedback('‚úÖ Dead row added');
    setTimeout(() => setFeedback(''), 2000);
  };

  const toggleRowDeadSpace = (sectionId, rowId) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        const updatedRows = (section.rows || []).map(row => {
          if (row.id === rowId) {
            return { ...row, isDeadSpace: !row.isDeadSpace };
          }
          return row;
        });
        return { ...section, rows: updatedRows };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after toggling row dead space');
    setFeedback('‚úÖ Row updated');
    setTimeout(() => setFeedback(''), 2000);
  };

  const deleteRow = (sectionId, rowId) => {
    if (!confirm('Delete row and all products in it?')) return;
    
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          rows: (section.rows || []).filter(r => r.id !== rowId)
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after deleting row');
    setFeedback('‚úÖ Row deleted');
    setTimeout(() => setFeedback(''), 2000);
  };

  const updateRowName = (sectionId, rowId, newName) => {
    const updatedSections = sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          rows: (section.rows || []).map(row => 
            row.id === rowId ? { ...row, name: newName } : row
          )
        };
      }
      return section;
    });
    setSections(updatedSections);
    autoSave(updatedSections, 'Auto-saved after renaming row');
  };

  const handleBackgroundUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const imageData = event.target.result;
        setBackgroundImage(imageData);
        localStorage.setItem('planogram_background', imageData);
        setFeedback('‚úÖ Background uploaded');
        setTimeout(() => setFeedback(''), 2000);
      };
      reader.readAsDataURL(file);
    }
  };

  const removeBackground = () => {
    setBackgroundImage(null);
    setBgImagePosition({ x: 0, y: 0 });
    localStorage.removeItem('planogram_background');
    localStorage.removeItem('planogram_bg_position');
    setFeedback('‚úÖ Background removed');
    setTimeout(() => setFeedback(''), 2000);
  };

  const calculateMetrics = (section, timePeriodFilter) => {
    // ALWAYS calculate area from dimensions if available, never rely on stored area
    const area = (section.length && section.depth) 
      ? (section.length * section.depth) / 144  // Convert sq inches to sq feet
      : (section.area || 1); // Fallback to stored area or 1

    // Gather all products from all rows, but EXCLUDE dead rows from metrics
    const allProducts = section.rows ? 
      section.rows
        .filter(row => !row.isDeadSpace) // Filter out dead rows
        .flatMap(row => row.products || []) : 
      (section.products || []);
    
    // Count dead rows for utilization tracking
    const totalRows = section.rows ? section.rows.length : 0;
    const deadRows = section.rows ? section.rows.filter(row => row.isDeadSpace).length : 0;
    const activeRows = totalRows - deadRows;

    const productMetrics = allProducts.map(p => {
      // Use the appropriate sales field based on time period
      let salesVolume = 0;
      switch(timePeriodFilter) {
        case 'day':
          salesVolume = p.dailySales || 0;
          break;
        case 'week':
          salesVolume = p.weeklySales || 0;
          break;
        case 'month':
          salesVolume = p.monthlySales || 0;
          break;
        case 'quarter':
          salesVolume = p.quarterlySales || 0;
          break;
        case 'year':
          salesVolume = p.yearlySales || 0;
          break;
        case 'all':
          salesVolume = p.allTimeSales || 0;
          break;
        case 'custom':
          // Calculate days in custom range and estimate proportionally
          if (customStartDate && customEndDate) {
            const start = new Date(customStartDate);
            const end = new Date(customEndDate);
            const daysInRange = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const daysInMonth = 30;
            // Estimate based on monthly sales proportionally
            salesVolume = (p.monthlySales || 0) * (daysInRange / daysInMonth);
          } else {
            salesVolume = p.monthlySales || 0;
          }
          break;
        default:
          salesVolume = p.monthlySales || 0;
      }

      const periodRevenue = p.price * salesVolume;
      const periodProfit = (p.cost !== null && p.cost !== undefined) 
        ? (p.price - p.cost) * salesVolume 
        : 0; // If no cost, profit is 0 (unknown)
      const velocity = salesVolume / area;

      return { ...p, periodVolume: salesVolume, periodRevenue, periodProfit, velocity };
    });

    productMetrics.sort((a, b) => {
      switch(sortBy) {
        case 'profit': return b.periodProfit - a.periodProfit;
        case 'revenue': return b.periodRevenue - a.periodRevenue;
        case 'velocity': return b.velocity - a.velocity;
        case 'volume': return b.periodVolume - a.periodVolume;
        case 'name': return a.name.localeCompare(b.name);
        default: return 0;
      }
    });
    
    const totalRevenue = productMetrics.reduce((sum, p) => sum + p.periodRevenue, 0);
    const totalCost = productMetrics.reduce((sum, p) => sum + ((p.cost !== null ? p.cost : 0) * p.periodVolume), 0);
    const totalProfit = productMetrics.reduce((sum, p) => sum + p.periodProfit, 0);
    const totalVolume = productMetrics.reduce((sum, p) => sum + p.periodVolume, 0);
    const totalVelocity = productMetrics.reduce((sum, p) => sum + p.velocity, 0);
    const profitPerSqFt = area > 0 ? totalProfit / area : 0;

    return { 
      area, 
      totalRevenue, 
      totalCost, 
      totalProfit, 
      profitPerSqFt, 
      totalVolume, 
      totalVelocity, 
      productMetrics,
      totalRows,
      deadRows,
      activeRows,
      rowUtilization: totalRows > 0 ? (activeRows / totalRows) * 100 : 100
    };
  };

  const getHeatMapColor = (metrics) => {
    // Smooth gradient helper - creates continuous color transitions
    const getGradientColor = (intensity) => {
      // Clamp intensity between 0 and 1
      intensity = Math.max(0, Math.min(1, intensity));
      
      // Create smooth gradient from red (0) -> orange -> yellow -> green (1)
      if (intensity < 0.25) {
        // Red to Orange (0-25%)
        const t = intensity / 0.25;
        const r = 239;
        const g = Math.floor(68 + (115 - 68) * t);
        const b = 68;
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      } else if (intensity < 0.5) {
        // Orange to Yellow (25-50%)
        const t = (intensity - 0.25) / 0.25;
        const r = Math.floor(249 - (249 - 234) * t);
        const g = Math.floor(115 + (179 - 115) * t);
        const b = Math.floor(22 - 14 * t);
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      } else if (intensity < 0.75) {
        // Yellow to Light Green (50-75%)
        const t = (intensity - 0.5) / 0.25;
        const r = Math.floor(234 - (234 - 134) * t);
        const g = Math.floor(179 + (197 - 179) * t);
        const b = Math.floor(8 + (86 * t));
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      } else {
        // Light Green to Dark Green (75-100%)
        const t = (intensity - 0.75) / 0.25;
        const r = Math.floor(134 - (134 - 34) * t);
        const g = 197;
        const b = Math.floor(94 - (94 - 94) * t);
        return `rgba(${r}, ${g}, ${b}, 0.75)`;
      }
    };
    
    // Calculate different metrics for different heat map types
    const allMetrics = sections.map(s => calculateMetrics(s, timePeriod));
    
    switch(heatMapType) {
      case 'profit': {
        const maxProfit = Math.max(...allMetrics.map(m => m.profitPerSqFt), 0.01);
        const intensity = maxProfit > 0 ? metrics.profitPerSqFt / maxProfit : 0;
        return getGradientColor(intensity);
      }
      
      case 'velocity': {
        const maxVelocity = Math.max(...allMetrics.map(m => m.totalVelocity), 0.01);
        const intensity = maxVelocity > 0 ? metrics.totalVelocity / maxVelocity : 0;
        return getGradientColor(intensity);
      }
      
      case 'deadStock': {
        // Count dead stock items (inventory > 0 but sales = 0)
        const deadStockValue = metrics.productMetrics
          .filter(p => (p.inventoryQuantity || 0) > 0 && p.periodVolume === 0)
          .reduce((sum, p) => sum + (p.inventoryQuantity || 0) * p.cost, 0);
        
        const maxDeadStock = Math.max(...allMetrics.map(m => 
          m.productMetrics
            .filter(p => (p.inventoryQuantity || 0) > 0 && p.periodVolume === 0)
            .reduce((sum, p) => sum + (p.inventoryQuantity || 0) * p.cost, 0)
        ), 1);
        
        // Invert for dead stock (more dead stock = worse = red)
        const intensity = 1 - (deadStockValue / maxDeadStock);
        return getGradientColor(intensity);
      }
      
      case 'margin': {
        // Average profit margin %
        const avgMargin = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            const margin = p.price > 0 ? ((p.price - p.cost) / p.price) : 0;
            return sum + margin;
          }, 0) / metrics.productMetrics.length : 0;
        
        // Scale margin to 0-1 (assume max 70% margin is best)
        const intensity = Math.min(avgMargin / 0.7, 1);
        return getGradientColor(intensity);
      }
      
      case 'stockHealth': {
        // Combine multiple factors: out of stock, low stock, dead stock
        const products = metrics.productMetrics;
        const outOfStock = products.filter(p => (p.inventoryQuantity || 0) === 0 && p.periodVolume > 0).length;
        const lowStock = products.filter(p => {
          const stock = p.inventoryQuantity || 0;
          const daysRemaining = p.periodVolume > 0 ? stock / (p.periodVolume / 30) : Infinity;
          return stock > 0 && daysRemaining < 7;
        }).length;
        const deadStock = products.filter(p => 
          (p.inventoryQuantity || 0) > 0 && p.periodVolume === 0
        ).length;
        
        const problemScore = outOfStock * 3 + lowStock * 2 + deadStock;
        const maxProblemScore = Math.max(...allMetrics.map(m => {
          const p = m.productMetrics;
          const os = p.filter(pr => (pr.inventoryQuantity || 0) === 0 && pr.periodVolume > 0).length;
          const ls = p.filter(pr => {
            const stock = pr.inventoryQuantity || 0;
            const daysRemaining = pr.periodVolume > 0 ? stock / (pr.periodVolume / 30) : Infinity;
            return stock > 0 && daysRemaining < 7;
          }).length;
          const ds = p.filter(pr => (pr.inventoryQuantity || 0) > 0 && pr.periodVolume === 0).length;
          return os * 3 + ls * 2 + ds;
        }), 1);
        
        // Invert (lower problem score = better = green)
        const intensity = 1 - (problemScore / maxProblemScore);
        return getGradientColor(intensity);
      }
      
      case 'aov': {
        // üî• Order Blitz: Average Order Value heat map
        const avgAOV = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            return sum + (p.analytics?.averageOrderValue || 0);
          }, 0) / metrics.productMetrics.filter(p => p.analytics?.averageOrderValue > 0).length : 0;
        
        const maxAOV = Math.max(...allMetrics.map(m => {
          const aov = m.productMetrics.length > 0 ?
            m.productMetrics.reduce((sum, p) => sum + (p.analytics?.averageOrderValue || 0), 0) / 
            m.productMetrics.filter(p => p.analytics?.averageOrderValue > 0).length : 0;
          return aov || 0;
        }), 1);
        
        const intensity = avgAOV / maxAOV;
        return getGradientColor(intensity);
      }
      
      case 'returningCustomers': {
        // üî• Order Blitz: Returning customer preferences
        const returningCustomerRatio = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            const total = (p.analytics?.returningCustomerPurchases || 0) + (p.analytics?.newCustomerPurchases || 0);
            return sum + (total > 0 ? (p.analytics?.returningCustomerPurchases || 0) / total : 0);
          }, 0) / metrics.productMetrics.filter(p => {
            const total = (p.analytics?.returningCustomerPurchases || 0) + (p.analytics?.newCustomerPurchases || 0);
            return total > 0;
          }).length : 0;
        
        return getGradientColor(returningCustomerRatio);
      }
      
      case 'shoppingPath': {
        // üî• Order Blitz: Cart position (what they grab first vs last)
        const avgCartPosition = metrics.productMetrics.length > 0 ?
          metrics.productMetrics.reduce((sum, p) => {
            return sum + (p.analytics?.averageCartPosition || 99);
          }, 0) / metrics.productMetrics.filter(p => p.analytics?.averageCartPosition > 0).length : 0;
        
        const maxCartPosition = Math.max(...allMetrics.map(m => {
          const pos = m.productMetrics.length > 0 ?
            m.productMetrics.reduce((sum, p) => sum + (p.analytics?.averageCartPosition || 99), 0) / 
            m.productMetrics.filter(p => p.analytics?.averageCartPosition > 0).length : 0;
          return pos || 10;
        }), 10);
        
        // Invert - lower cart position (grabbed first) = better = green
        const intensity = 1 - (avgCartPosition / maxCartPosition);
        return getGradientColor(intensity);
      }
      
      default:
        return 'rgba(100, 116, 139, 0.3)'; // Gray - Default
    }
  };

  const ProductBox = ({ product, productIndex, sectionId, fixtureX, fixtureY, fixtureWidth, fixtureHeight }) => {
    const [isDragging, setIsDragging] = useState(false);
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

    const handleMouseDown = (e) => {
      e.stopPropagation();
      setIsDragging(true);
      setDragStart({ x: e.clientX, y: e.clientY });
    };

    useEffect(() => {
      if (!isDragging) return;

      const handleMouseMove = (e) => {
        const deltaX = e.clientX - dragStart.x;
        const deltaY = e.clientY - dragStart.y;
        
        const newX = Math.max(5, Math.min(95, ((product.visualX / 100) * fixtureWidth + deltaX) / fixtureWidth * 100));
        const newY = Math.max(5, Math.min(95, ((product.visualY / 100) * fixtureHeight + deltaY) / fixtureHeight * 100));
        
        updateProductPosition(sectionId, productIndex, newX, newY);
        setDragStart({ x: e.clientX, y: e.clientY });
      };

      const handleMouseUp = () => {
        setIsDragging(false);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }, [isDragging, dragStart]);

    const profit = product.cost !== null && product.cost !== undefined
      ? (product.price - product.cost) * (product.monthlySales || 0)
      : null;
    
    let colorClass = 'bg-gray-400';
    if (profit !== null) {
      if (profit > 100) colorClass = 'bg-green-500';
      else if (profit > 50) colorClass = 'bg-yellow-500';
      else if (profit > 0) colorClass = 'bg-orange-500';
      else if (profit < 0) colorClass = 'bg-red-500';
    }

    const size = Math.min(Math.max(20, 15 + product.quantity * 3), 40);
    
    const profitDisplay = profit !== null ? `$${profit.toFixed(2)}` : 'N/A';

  return (
      <div
        className={`absolute ${colorClass} rounded shadow-lg flex items-center justify-center text-white text-xs font-bold cursor-move hover:opacity-80`}
        style={{
          left: `${product.visualX}%`,
          top: `${product.visualY}%`,
          width: `${size}px`,
          height: `${size}px`,
          transform: 'translate(-50%, -50%)',
          zIndex: isDragging ? 1000 : 50,
          pointerEvents: 'auto'
        }}
        onMouseDown={handleMouseDown}
        title={`${product.name}\n$${product.price}\nQty: ${product.quantity}\nProfit: ${profitDisplay}`}
      >
        {product.quantity}
      </div>
    );
  };

  // Calculate proportional layout based on section dimensions
  const calculateProportionalLayout = (sections, fixtureId) => {
    const fixtureSections = sections.filter(s => s.fixtureId === fixtureId);
    
    if (fixtureSections.length === 0) return [];
    
    // Calculate total length of all sections
    const totalLength = fixtureSections.reduce((sum, s) => sum + (s.length || 48), 0);
    
    // Calculate proportional widths and positions
    let currentX = 0;
    return fixtureSections.map(section => {
      const sectionLength = section.length || 48;
      const proportionalWidth = (sectionLength / totalLength) * 100;
      
      const layoutSection = {
        ...section,
        layoutX: currentX,
        layoutY: 0, // All sections start at top
        layoutWidth: proportionalWidth,
        layoutHeight: 100 // Full height
      };
      
      currentX += proportionalWidth;
      return layoutSection;
    });
  };

 const DraggableSection = ({ section, fixture, isSelected, onSelect }) => {
    const [isDragging, setIsDragging] = useState(false);
    const [isResizing, setIsResizing] = useState(false);
    const metrics = calculateMetrics(section, timePeriod);
    
    // Dead space sections are always gray, regular sections use heat map or default
    const color = section.type === 'deadspace' 
      ? 'rgba(150, 150, 150, 0.5)' 
      : (heatMapMode ? getHeatMapColor(metrics) : 'rgba(100, 116, 139, 0.3)');
    
    // Use custom layout properties or default to full fixture
    const layoutX = section.layoutX !== undefined ? section.layoutX : 0;
    const layoutY = section.layoutY !== undefined ? section.layoutY : 0;
    const layoutWidth = section.layoutWidth !== undefined ? section.layoutWidth : 100;
    const layoutHeight = section.layoutHeight !== undefined ? section.layoutHeight : 100;
    
 const handleMouseDown = (e) => {
      if (e.target.classList.contains('section-resize-handle')) {
        e.stopPropagation();
        setIsResizing(true);
        const resizePosition = e.target.dataset.position;
        const startX = e.clientX;
        const startY = e.clientY;
        const startLayoutX = layoutX;
        const startLayoutY = layoutY;
        const startLayoutWidth = layoutWidth;
        const startLayoutHeight = layoutHeight;

        const handleMouseMove = (e) => {
          const deltaX = ((e.clientX - startX) / fixture.width) * 100;
          const deltaY = ((e.clientY - startY) / fixture.height) * 100;

          let newLayoutX = startLayoutX;
          let newLayoutY = startLayoutY;
          let newLayoutWidth = startLayoutWidth;
          let newLayoutHeight = startLayoutHeight;

          if (resizePosition.includes('e')) {
            newLayoutWidth = Math.max(10, Math.min(100 - startLayoutX, startLayoutWidth + deltaX));
          }
          if (resizePosition.includes('w')) {
            const widthChange = Math.max(10, startLayoutWidth - deltaX);
            newLayoutWidth = widthChange;
            newLayoutX = startLayoutX + (startLayoutWidth - widthChange);
          }
          if (resizePosition.includes('s')) {
            newLayoutHeight = Math.max(10, Math.min(100 - startLayoutY, startLayoutHeight + deltaY));
          }
          if (resizePosition.includes('n')) {
            const heightChange = Math.max(10, startLayoutHeight - deltaY);
            newLayoutHeight = heightChange;
            newLayoutY = startLayoutY + (startLayoutHeight - heightChange);
          }

          // No snapping - free resizing
          updateSection({
            ...section,
            layoutX: Math.max(0, Math.min(100 - newLayoutWidth, newLayoutX)),
            layoutY: Math.max(0, Math.min(100 - newLayoutHeight, newLayoutY)),
            layoutWidth: Math.max(5, newLayoutWidth),
            layoutHeight: Math.max(5, newLayoutHeight)
          });
        };

        const handleMouseUp = () => {
          setIsResizing(false);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return;
      }

      // Handle dragging - let Shift+Click pass through to fixture
      if (shiftPressed) {
        // Don't stop propagation - let the fixture handle the Shift+Click
        return;
      }
      
      e.stopPropagation();
      setIsDragging(true);
      
      const startX = e.clientX;
      const startY = e.clientY;
      const startLayoutX = layoutX;
      const startLayoutY = layoutY;

      const handleMouseMove = (e) => {
        const deltaX = ((e.clientX - startX) / fixture.width) * 100;
        const deltaY = ((e.clientY - startY) / fixture.height) * 100;
        
        let newX = Math.max(0, Math.min(100 - layoutWidth, startLayoutX + deltaX));
        let newY = Math.max(0, Math.min(100 - layoutHeight, startLayoutY + deltaY));
        
        // No snapping - free positioning
        updateSection({
          ...section,
          layoutX: newX,
          layoutY: newY
        });
      };

      const handleMouseUp = () => {
        setIsDragging(false);
        onSelect();
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    };

    // Calculate actual pixel positions
    const left = (layoutX / 100) * fixture.width;
    const top = (layoutY / 100) * fixture.height;
    const width = (layoutWidth / 100) * fixture.width;
    const height = (layoutHeight / 100) * fixture.height;

 return (
      <div
       style={{
          position: 'absolute',
          left: left,
          top: top,
          width: width,
          height: height,
          background: color,
          border: isSelected 
            ? '2px solid #3b82f6' 
            : 'none',
          cursor: isDragging ? 'grabbing' : 'grab',
          pointerEvents: 'auto',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: width > 60 && height > 40 ? '11px' : '9px',
          color: 'white',
          fontWeight: 'bold',
          textShadow: '1px 1px 2px rgba(0,0,0,0.8)',
          zIndex: isSelected ? 60 : 40,
          overflow: 'hidden',
          borderRadius: '0',
          boxShadow: 'none',
          backdropFilter: 'none'
        }}
        onMouseDown={handleMouseDown}
        onClick={(e) => {
          if (!isDragging && !isResizing && !shiftPressed) {
            e.stopPropagation();
            onSelect();
          }
        }}
      >
        {/* Only show label if section is big enough */}
        {width > 30 && height > 20 && (
          <div 
            className="text-center pointer-events-none px-1" 
            style={{ 
              maxWidth: '95%', 
              overflow: 'hidden',
              fontSize: width < 50 ? '8px' : (width < 80 ? '10px' : '11px'),
              lineHeight: width < 50 ? '10px' : '1.2',
              transform: height > width * 1.5 ? 'rotate(-90deg)' : 'none',
              transformOrigin: 'center center',
              whiteSpace: 'nowrap'
            }}
          >
            <div style={{ 
              overflow: 'hidden', 
              textOverflow: 'ellipsis', 
              whiteSpace: 'nowrap' 
            }}>
              {section.name}
            </div>
            {heatMapMode && width > 60 && height > 35 && (
              <div style={{ 
                fontSize: width < 80 ? '8px' : '9px',
                overflow: 'hidden',
                textOverflow: 'ellipsis',
                whiteSpace: 'nowrap'
              }}>
                ${metrics.profitPerSqFt.toFixed(0)}/sqft
              </div>
            )}
          </div>
        )}

       {/* Resize handles - only show when selected */}
        {isSelected && ['nw', 'ne', 'se', 'sw', 'n', 's', 'e', 'w'].map(position => (
          <div
            key={position}
            className="section-resize-handle"
            data-position={position}
            style={{
              position: 'absolute',
              background: '#3b82f6',
              border: '1px solid white',
              cursor: getCursor(position),
              zIndex: 70,
              pointerEvents: 'auto',
              ...getHandlePosition(position)
            }}
          />
        ))}
      </div>
    );
  };

const Fixture = ({ fixture, onUpdate, onDelete, onSelect, isSelected }) => {
    const [dragging, setDragging] = useState(false);

    const handleMouseDown = (e) => {
      // Handle rotation from rotate handle
      if (e.target.closest('.rotate-handle')) {
        e.stopPropagation();
        
        const rect = e.currentTarget.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const startAngle = Math.atan2(
          e.clientY - centerY,
          e.clientX - centerX
        ) * (180 / Math.PI);
        
        const startRotation = fixture.rotation || 0;

        const handleMouseMove = (moveEvent) => {
          const currentAngle = Math.atan2(
            moveEvent.clientY - centerY,
            moveEvent.clientX - centerX
          ) * (180 / Math.PI);
          
          const angleDiff = currentAngle - startAngle;
          let newRotation = (startRotation + angleDiff) % 360;
          
          // Normalize to 0-360
          if (newRotation < 0) newRotation += 360;
          
          onUpdate({ ...fixture, rotation: newRotation });
        };

        const handleMouseUp = () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return;
      }

      if (e.target.classList.contains('resize-handle')) {
        e.stopPropagation();
        const resizePosition = e.target.dataset.position;
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = fixture.width;
        const startHeight = fixture.height;
        const startLeft = fixture.x;
        const startTop = fixture.y;

        const handleMouseMove = (e) => {
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;

          let newWidth = startWidth;
          let newHeight = startHeight;
          let newX = startLeft;
          let newY = startTop;

          if (resizePosition.includes('e')) newWidth = Math.max(60, startWidth + deltaX);
          if (resizePosition.includes('w')) {
            newWidth = Math.max(60, startWidth - deltaX);
            newX = startLeft + (startWidth - newWidth);
          }
          if (resizePosition.includes('s')) newHeight = Math.max(60, startHeight + deltaY);
          if (resizePosition.includes('n')) {
            newHeight = Math.max(60, startHeight - deltaY);
            newY = startTop + (startHeight - newHeight);
          }

          onUpdate({ ...fixture, width: newWidth, height: newHeight, x: newX, y: newY });
        };

        const handleMouseUp = () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return;
      }

      // If panning with middle mouse or Ctrl key, don't handle fixture interaction
      if (e.button === 1 || e.ctrlKey) {
        return; // Let it bubble to canvas for panning
      }
      
      // Stop canvas panning and handle fixture interaction
      setIsPanning(false);
      e.stopPropagation();
      
      // Multi-select logic for FIXTURES
      if (shiftPressed) {
        // Shift-click: toggle selection
        if (selectedFixtures.includes(fixture.id)) {
          setSelectedFixtures(selectedFixtures.filter(id => id !== fixture.id));
        } else {
          setSelectedFixtures([...selectedFixtures, fixture.id]);
        }
        return; // Don't start drag on shift-click
      } else if (!selectedFixtures.includes(fixture.id)) {
        // If not selected and not shift-clicking, select only this one
        setSelectedFixtures([fixture.id]);
      }
      
      setDragging(true);
      
      const startX = e.clientX;
      const startY = e.clientY;
      
      // Capture the current selected fixtures at drag start to avoid stale closure
      const draggedFixtureIds = selectedFixtures.includes(fixture.id) 
        ? [...selectedFixtures] 
        : [fixture.id];
      
      // Use functional form to get current fixtures at drag start
      let startPositions = [];
      setFixtures(currentFixtures => {
        const fixturesToMove = currentFixtures.filter(f => draggedFixtureIds.includes(f.id));
        startPositions = fixturesToMove.map(f => ({
          id: f.id,
          x: f.x,
          y: f.y
        }));
        return currentFixtures; // Don't change fixtures yet
      });

      const handleMouseMove = (e) => {
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        // Use functional form to get current state
        setFixtures(currentFixtures => {
          return currentFixtures.map(f => {
            const startPos = startPositions.find(sp => sp.id === f.id);
            if (startPos) {
              // This fixture is selected, move it
              return {
                ...f,
                x: startPos.x + deltaX,
                y: startPos.y + deltaY
              };
            }
            // Not selected, keep as is
            return f;
          });
        });
      };

      const handleMouseUp = () => {
        setDragging(false);
        // Call onSelect here instead, after drag is complete
        onSelect();
        // Save to localStorage on mouse up - use functional form to get latest
        setFixtures(currentFixtures => {
          localStorage.setItem('planogram_fixtures', JSON.stringify(currentFixtures));
          autoSave(sections, currentFixtures, 'Auto-saved after moving fixtures');
          return currentFixtures;
        });
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    };

 const fixtureSections = sections.filter(s => s.fixtureId === fixture.id);
    const totalProfit = fixtureSections.reduce((sum, s) => {
      const metrics = calculateMetrics(s, timePeriod);
      return sum + metrics.totalProfit;
    }, 0);
    
    return (
      <div
        data-fixture-id={fixture.id}
        onMouseDown={handleMouseDown}
        style={{
          position: 'absolute',
          left: fixture.x,
          top: fixture.y,
          width: fixture.width,
          height: fixture.height,
          cursor: dragging ? 'grabbing' : 'grab',
          zIndex: isSelected ? 100 : 10,
          pointerEvents: 'auto', // Enable pointer events so buttons work
        }}
      >
        {/* Rotated inner content */}
        <div 
          style={{
            position: 'absolute',
            top: 0,
            left: 0,
            width: '100%',
            height: '100%',
            backgroundColor: heatMapMode ? '#e5e7eb' : fixture.color,
            border: selectedFixtures.includes(fixture.id)
              ? '4px solid #fbbf24'
              : isSelected 
                ? '3px solid #3b82f6'
                : '2px solid #cbd5e1',
            borderRadius: '8px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            pointerEvents: 'auto', // Changed back to auto so it can be clicked and dragged
            opacity: heatMapMode ? 0.95 : 0.9,
            overflow: 'hidden',
            transform: `rotate(${fixture.rotation || 0}deg)`,
            transformOrigin: 'center center'
          }}
        >
        {/* Inner wrapper to contain overflowing content */}
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          overflow: 'hidden',
          borderRadius: '8px',
          pointerEvents: 'none'
        }}>
        {/* Draggable/Resizable Sections - always visible */}
        {fixtureSections.map(section => (
          <DraggableSection
            key={section.id}
            section={section}
            fixture={fixture}
            isSelected={selectedSection === section.id}
            onSelect={() => {
              setSelectedSection(section.id);
              setSelectedFixture(section.fixtureId); // Open the fixture sidebar
              
              // Scroll to section in sidebar
              setTimeout(() => {
                if (sectionRefs.current[section.id]) {
                  sectionRefs.current[section.id].scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                  });
                }
              }, 100);
              
              // Expand all collapsible sections when clicking on map
              const newLayoutCollapsed = new Set(collapsedSectionLayouts);
              newLayoutCollapsed.delete('all');
              newLayoutCollapsed.delete(section.id);
              setCollapsedSectionLayouts(newLayoutCollapsed);
              
              const newRowsCollapsed = new Set(collapsedRowsSections);
              newRowsCollapsed.delete('all');
              newRowsCollapsed.delete(section.id);
              setCollapsedRowsSections(newRowsCollapsed);
              
              const newUnknownCollapsed = new Set(collapsedUnknownProducts);
              newUnknownCollapsed.delete('all');
              newUnknownCollapsed.delete(section.id);
              setCollapsedUnknownProducts(newUnknownCollapsed);
              
              // Scroll to and focus UPC input
              setTimeout(() => {
                if (upcInputRef.current) {
                  upcInputRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  upcInputRef.current.focus();
                }
              }, 100);
            }}
          />
        ))}

        {/* Fixture label - only show when NOT in heat map mode */}
        {!heatMapMode && fixture.width > 40 && fixture.height > 30 && (
          <div 
            className="text-white text-center p-1 pointer-events-none" 
            style={{ 
              maxWidth: '90%',
              overflow: 'hidden',
              transform: fixture.height > fixture.width 
                ? `rotate(-90deg) rotate(-${fixture.rotation || 0}deg)` 
                : `rotate(-${fixture.rotation || 0}deg)`,
              transformOrigin: 'center center',
              whiteSpace: 'nowrap'
            }}
          >
            <div 
              className="font-bold" 
              style={{ 
                fontSize: fixture.width < 60 ? '9px' : (fixture.width < 100 ? '11px' : '13px'),
                lineHeight: fixture.width < 60 ? '11px' : '1.2',
                overflow: 'hidden',
                textOverflow: 'ellipsis',
                whiteSpace: 'nowrap',
                marginBottom: fixture.height < 50 ? '0' : '2px'
              }}
            >
              {fixture.name}
            </div>
            {fixture.height > 50 && (
              <div 
                style={{ 
                  fontSize: fixture.width < 60 ? '8px' : '10px',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  whiteSpace: 'nowrap'
                }}
              >
                {fixtureSections.length} sections
              </div>
            )}
          </div>
        )}

        {showVisualMode && fixtureSections.map(section => 
          section.products.map((product, idx) => (
            <ProductBox
              key={`${section.id}-${idx}`}
              product={product}
              productIndex={idx}
              sectionId={section.id}
              fixtureX={fixture.x}
              fixtureY={fixture.y}
              fixtureWidth={fixture.width}
              fixtureHeight={fixture.height}
            />
          ))
        )}
        </div>
        {/* End inner wrapper */}
        </div>
        {/* End rotated content */}

        {/* Delete button removed - use sidebar delete button instead */}

        {/* Rotation handle - NOT rotated, stays in corner, OUTSIDE rotated content */}
        {isSelected && (
          <div
            className="rotate-handle"
            onMouseDown={(e) => {
              e.stopPropagation();
              
              const rect = e.currentTarget.parentElement.getBoundingClientRect();
              const centerX = rect.left + rect.width / 2;
              const centerY = rect.top + rect.height / 2;
              
              const startAngle = Math.atan2(
                e.clientY - centerY,
                e.clientX - centerX
              ) * (180 / Math.PI);
              
              const startRotation = fixture.rotation || 0;

              const handleMouseMove = (moveEvent) => {
                const currentAngle = Math.atan2(
                  moveEvent.clientY - centerY,
                  moveEvent.clientX - centerX
                ) * (180 / Math.PI);
                
                const angleDiff = currentAngle - startAngle;
                let newRotation = (startRotation + angleDiff) % 360;
                
                // Normalize to 0-360
                if (newRotation < 0) newRotation += 360;
                
                onUpdate({ ...fixture, rotation: newRotation });
              };

              const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };

              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
            style={{
              position: 'absolute',
              top: -20,
              right: -20,
              width: '24px',
              height: '24px',
              background: '#a855f7',
              border: '3px solid white',
              borderRadius: '50%',
              cursor: 'grab',
              zIndex: 200,
              pointerEvents: 'auto',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '14px',
              color: 'white',
              fontWeight: 'bold',
              boxShadow: '0 2px 8px rgba(0,0,0,0.3)'
            }}
            title={`Rotate (${Math.round(fixture.rotation || 0)}¬∞)`}
          >
            ‚Üª
          </div>
        )}

        {/* Resize handles - NOT rotated, stay aligned to viewport */}
        {isSelected && ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'].map(position => (
          <div
            key={position}
            className="resize-handle"
            data-position={position}
            style={{
              position: 'absolute',
              background: 'white',
              border: '2px solid #3b82f6',
              cursor: getCursor(position),
              zIndex: 200,
              pointerEvents: 'auto',
              ...getHandlePosition(position)
            }}
          />
        ))}
      </div>
    );
  };

  // Helper function to check if data is stale
  const getRefreshStatus = (lastRefreshTime, thresholdDays) => {
    if (!lastRefreshTime) return { isStale: true, daysAgo: null, message: 'Never refreshed' };
    
    const now = new Date();
    const diffMs = now - lastRefreshTime;
    const diffDays = diffMs / (1000 * 60 * 60 * 24);
    
    const isStale = diffDays > thresholdDays;
    const daysAgo = Math.floor(diffDays);
    const hoursAgo = Math.floor(diffMs / (1000 * 60 * 60));
    
    let message = '';
    if (daysAgo === 0) {
      if (hoursAgo === 0) {
        message = 'Just now';
      } else {
        message = `${hoursAgo}h ago`;
      }
    } else if (daysAgo === 1) {
      message = 'Yesterday';
    } else {
      message = `${daysAgo}d ago`;
    }
    
    return { isStale, daysAgo, message };
  };

  // Check refresh statuses
  const productsStatus = getRefreshStatus(lastProductsRefresh, 30); // 30 days for products
  const salesStatus = getRefreshStatus(lastSalesRefresh, 7); // 7 days for sales
  const ordersStatus = getRefreshStatus(lastOrdersRefresh, 7); // 7 days for orders

  // Unknown Products Management
  const updateUnknownProductNote = (id, note) => {
    const updatedProducts = unknownProducts.map(u => u.id === id ? { ...u, note } : u);
    setUnknownProducts(updatedProducts);
    console.log('Updated unknown products:', updatedProducts);
  };

  // Auto-save unknown products when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      if (unknownProducts.length >= 0) {
        console.log('Auto-saving unknown products...');
        localStorage.setItem('planogram_unknown_products', JSON.stringify(unknownProducts));
        if (firebaseReady) {
          saveToCloud(true); // silent mode
        }
      }
    }, 2000);
    return () => clearTimeout(timeoutId);
  }, [unknownProducts]);

  const deleteUnknownProduct = (id) => {
    setUnknownProducts(prev => prev.filter(u => u.id !== id));
  };

  // Bad Stock Products Management
  const updateBadStockNote = (id, note) => {
    const updatedProducts = badStockProducts.map(b => b.id === id ? { ...b, note } : b);
    setBadStockProducts(updatedProducts);
    console.log('Updated bad stock products:', updatedProducts);
  };

  // Auto-save bad stock products when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      if (badStockProducts.length >= 0) {
        console.log('Auto-saving bad stock products...');
        localStorage.setItem('planogram_bad_stock_products', JSON.stringify(badStockProducts));
        if (firebaseReady) {
          saveToCloud(true); // silent mode
        }
      }
    }, 2000);
    return () => clearTimeout(timeoutId);
  }, [badStockProducts]);

  const deleteBadStockProduct = (id) => {
    setBadStockProducts(prev => prev.filter(b => b.id !== id));
  };

  // Auto-save sections when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      console.log('Auto-saving sections to Firebase...');
      localStorage.setItem('planogram_sections', JSON.stringify(sections));
      if (firebaseReady) {
        saveToCloud(true); // silent mode
      }
    }, 2000); // 2 second delay
    return () => clearTimeout(timeoutId);
  }, [sections]);

  // Auto-save fixtures when they change
  useEffect(() => {
    if (!initialLoadComplete.current) return; // Skip first render
    
    const timeoutId = setTimeout(() => {
      console.log('Auto-saving fixtures to Firebase...');
      localStorage.setItem('planogram_fixtures', JSON.stringify(fixtures));
      if (firebaseReady) {
        saveToCloud(true); // silent mode
      }
    }, 2000); // 2 second delay
    return () => clearTimeout(timeoutId);
  }, [fixtures]);

  const resolveBadStock = (id) => {
    setBadStockProducts(prev =>
      prev.map(b => b.id === id ? { ...b, resolved: true } : b)
    );
    setFeedback('‚úÖ Marked as resolved');
  };

  // Manual trigger for bad stock scan
  const manualBadStockScan = () => {
    console.log('üîç MANUAL BAD STOCK SCAN TRIGGERED');
    console.log('Products loaded:', allDatabaseProducts.length);
    
    if (allDatabaseProducts.length === 0) {
      console.log('‚ùå No products loaded - stopping');
      setFeedback('‚ö†Ô∏è Load products first - go to Forecasting tab and click "Load All Products"');
      setTimeout(() => setFeedback(''), 5000);
      return;
    }
    
    console.log('‚úÖ Calling autoSyncBadStock...');
    autoSyncBadStock(allDatabaseProducts);
    console.log('‚úÖ autoSyncBadStock called');
  };

  const checkUnknownAgainstShopify = async () => {
    if (!shopifyConfig.connected) {
      setFeedback('‚ö†Ô∏è Connect to Shopify first');
      return;
    }
    
    // Check each unknown product against current Shopify data
    for (const unknown of unknownProducts.filter(u => !u.resolved)) {
      try {
        const url = new URL(`${BACKEND_URL}/api/product/${unknown.upc}`);
        url.searchParams.append('storeName', shopifyConfig.storeName);
        url.searchParams.append('accessToken', shopifyConfig.accessToken);
        
        const response = await fetch(url);
        const data = await response.json();

        if (response.ok && data.title) {
          setUnknownProducts(prev =>
            prev.map(u => u.id === unknown.id ? {
              ...u,
              resolved: true,
              matchedProduct: {
                name: data.variantTitle ? `${data.title} - ${data.variantTitle}` : data.title,
                vendor: data.vendor,
                price: data.price
              },
              resolvedAt: new Date().toISOString()
            } : u)
          );
        }
      } catch (error) {
        console.error(`Error checking UPC ${unknown.upc}:`, error);
      }
    }
    
    setFeedback('‚úÖ Checked unknown products');
    setTimeout(() => setFeedback(''), 3000);
  };

  // Calculate discount impact
  const calculateDiscountImpact = () => {
    console.log('üöÄ FUNCTION CALLED - calculateDiscountImpact');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üîç STARTING DISCOUNT CALCULATION');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('Discount Config:', discountConfig);
    console.log('Sections available:', sections.length);
    console.log('Fixtures available:', fixtures.length);
    
    try {
      // Validate selections
      if (discountConfig.target === 'sections' && discountConfig.selectedSections.length === 0) {
        console.log('‚ùå VALIDATION FAILED: No sections selected');
        setFeedback('‚ö†Ô∏è Please select at least one section');
        setTimeout(() => setFeedback(''), 3000);
        return;
      }

      if (discountConfig.target === 'fixture' && !discountConfig.targetId) {
        console.log('‚ùå VALIDATION FAILED: No fixture selected');
        setFeedback('‚ö†Ô∏è Please select a fixture');
        setTimeout(() => setFeedback(''), 3000);
        return;
      }

      console.log('‚úÖ Validation passed');
      console.log('Target:', discountConfig.target);
      console.log('Selected sections:', discountConfig.selectedSections);
      console.log('Total sections available:', sections.length);
      console.log('Total fixtures available:', fixtures.length);
      
      // Log first section structure to debug
      if (sections.length > 0) {
        console.log('First section structure:', sections[0]);
        console.log('First section rows:', sections[0].rows);
        if (sections[0].rows && sections[0].rows.length > 0) {
          console.log('First section first row:', sections[0].rows[0]);
          console.log('First section first row products:', sections[0].rows[0].products);
        }
      }
      
      // Get affected products based on target
      let affectedProducts = [];

      if (discountConfig.target === 'all') {
        // Get all products from all sections
        console.log('üì¶ Getting ALL products from all sections');
        sections.forEach(section => {
          const fixture = fixtures.find(f => f.id === section.fixtureId);
          console.log(`  Section: ${section.name}, Rows: ${section.rows?.length || 0}`);
          
          section.rows?.forEach((row, rowIdx) => {
            const products = row.products || [];
            console.log(`    Row ${rowIdx}: ${products.length} products`);
            
            products.forEach(product => {
              affectedProducts.push({
                ...product,
                sectionName: section.name,
                fixtureName: fixture?.name || 'Unknown Fixture'
              });
            });
          });
        });
      } else if (discountConfig.target === 'sections' && discountConfig.selectedSections.length > 0) {
        // Get products from selected sections
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üì¶ GATHERING PRODUCTS FROM SELECTED SECTIONS');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('Selected section IDs:', discountConfig.selectedSections);
        
        sections.forEach(section => {
          if (discountConfig.selectedSections.includes(section.id)) {
            const fixture = fixtures.find(f => f.id === section.fixtureId);
            console.log(`\n‚úì Section: ${section.name} (ID: ${section.id})`);
            console.log(`  Fixture: ${fixture?.name || 'Unknown'}`);
            console.log(`  Rows: ${section.rows?.length || 0}`);
            
            if (!section.rows || section.rows.length === 0) {
              console.log('  ‚ö†Ô∏è NO ROWS in this section!');
            }
            
            section.rows?.forEach((row, rowIdx) => {
              const products = row.products || [];
              console.log(`  Row ${rowIdx}: ${products.length} products`);
              
              if (products.length === 0) {
                console.log('    ‚ö†Ô∏è Empty row');
              } else {
                console.log(`    First product in row:`, products[0]);
              }
              
              products.forEach((product, pIdx) => {
                console.log(`    Product ${pIdx}: ${product.name || product.upc || 'Unknown'}`);
                console.log(`      - price: ${product.price}, retail_price: ${product.retail_price}, variant_price: ${product.variant_price}`);
                affectedProducts.push({
                  ...product,
                  sectionName: section.name,
                  fixtureName: fixture?.name || 'Unknown Fixture'
                });
              });
            });
          }
        });
        
        console.log(`\nüìä Total products gathered: ${affectedProducts.length}`);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
      } else if (discountConfig.target === 'fixture' && discountConfig.targetId) {
        // Get products from all sections in specific fixture
        const fixtureSections = sections.filter(s => s.fixtureId === discountConfig.targetId);
        const fixture = fixtures.find(f => f.id === discountConfig.targetId);
        
        fixtureSections.forEach(section => {
          section.rows?.forEach(row => {
            row.products?.forEach(product => {
              affectedProducts.push({
                ...product,
                sectionName: section.name,
                fixtureName: fixture?.name || 'Unknown Fixture'
              });
            });
          });
        });
      } else if (discountConfig.target === 'selected_products' && discountConfig.selectedProducts.length > 0) {
        // Get only selected products by UPC
        sections.forEach(section => {
          const fixture = fixtures.find(f => f.id === section.fixtureId);
          section.rows?.forEach(row => {
            row.products?.forEach(product => {
              if (discountConfig.selectedProducts.includes(product.upc)) {
                affectedProducts.push({
                  ...product,
                  sectionName: section.name,
                  fixtureName: fixture?.name || 'Unknown Fixture'
                });
              }
            });
          });
        });
      }

      // Get actual price from various possible fields and formats
      const getProductPrice = (product) => {
        // Check multiple possible price fields
        const priceFields = [
          product.price,
          product.retail_price,
          product.variant_price,
          product.selling_price
        ];
        
        for (const field of priceFields) {
          if (field !== null && field !== undefined) {
            const price = typeof field === 'string' ? parseFloat(field) : field;
            if (!isNaN(price) && price > 0) {
              return price;
            }
          }
        }
        return null;
      };

      // Normalize products with actual prices
      const normalizedProducts = affectedProducts.map(p => ({
        ...p,
        price: getProductPrice(p)
      }));

      // Filter products that have prices and separate those without
      const productsWithPrices = normalizedProducts.filter(p => p.price && p.price > 0);
      const productsWithoutPrices = normalizedProducts.filter(p => !p.price || p.price <= 0);

      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üîç DISCOUNT CALCULATION RESULTS');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log(`üì¶ Total products found: ${affectedProducts.length}`);
      console.log(`‚úÖ Products WITH prices: ${productsWithPrices.length}`);
      console.log(`‚ùå Products WITHOUT prices: ${productsWithoutPrices.length}`);
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      
      if (productsWithoutPrices.length > 0) {
        console.log('‚ùå PRODUCTS WITHOUT PRICES (sample):');
        productsWithoutPrices.slice(0, 5).forEach((p, idx) => {
          console.log(`  ${idx + 1}. ${p.name || 'Unnamed'}`);
          console.log(`     UPC: ${p.upc || 'N/A'}`);
          console.log(`     Price field: ${p.price === undefined ? 'undefined' : p.price === null ? 'null' : p.price}`);
          console.log(`     Retail_price: ${p.retail_price || 'N/A'}`);
          console.log(`     Variant_price: ${p.variant_price || 'N/A'}`);
          console.log(`     Cost: ${p.cost || 'N/A'}`);
          console.log(`     Vendor: ${p.vendor || 'N/A'}`);
          console.log(`     Section: ${p.sectionName || 'N/A'}`);
          console.log(`     Available fields:`, Object.keys(p).join(', '));
          console.log(`     Full product object:`, p);
          console.log('     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        });
        console.log('\n‚ö†Ô∏è OPEN BROWSER CONSOLE (F12) TO SEE DETAILED PRODUCT INFO! ‚ö†Ô∏è\n');
      }
      
      if (productsWithPrices.length > 0) {
        console.log('‚úÖ PRODUCTS WITH PRICES (sample):');
        productsWithPrices.slice(0, 3).forEach((p, idx) => {
          console.log(`  ${idx + 1}. ${p.name} - $${p.price}`);
        });
      }
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

      if (productsWithPrices.length === 0) {
        if (productsWithoutPrices.length > 0) {
          setFeedback(`‚ö†Ô∏è Found ${productsWithoutPrices.length} products but none have prices. Check console (F12) to see available price fields. Products may need 'price', 'retail_price', or 'variant_price' field.`);
        } else {
          setFeedback('‚ö†Ô∏è No products found for the selected target');
        }
        setTimeout(() => setFeedback(''), 10000);
        return;
      }

      // Show warning if some products don't have prices
      if (productsWithoutPrices.length > 0) {
        console.warn(`‚ö†Ô∏è ${productsWithoutPrices.length} products excluded (no price):`, productsWithoutPrices);
      }

      // Check if we have actual cost data
      const productsWithCosts = productsWithPrices.filter(p => 
        p.cost !== null && p.cost !== undefined && p.cost > 0
      );
      const hasCostData = productsWithCosts.length > 0;

      console.log(`üí∞ Cost Data Check: ${productsWithCosts.length}/${productsWithPrices.length} products have cost data`);
      if (!hasCostData) {
        console.log('‚ö†Ô∏è No cost data available - using revenue-only forecasting');
      }

      // Calculate new prices and impact using only products with prices
      const productsWithDiscounts = productsWithPrices.map(product => {
        const currentPrice = product.price;
        let newPrice;

        if (discountConfig.type === 'percentage') {
          newPrice = currentPrice * (1 - discountConfig.value / 100);
        } else {
          newPrice = Math.max(0, currentPrice - discountConfig.value);
        }

        const savings = currentPrice - newPrice;
        
        // Only calculate margins if we have actual cost data
        let cost = null;
        let currentMargin = null;
        let newMargin = null;
        
        if (product.cost !== null && product.cost !== undefined && product.cost > 0) {
          cost = product.cost;
          currentMargin = ((currentPrice - cost) / currentPrice) * 100;
          newMargin = ((newPrice - cost) / newPrice) * 100;
        }

        return {
          name: product.name,
          vendor: product.vendor,
          currentPrice,
          newPrice,
          savings,
          cost,
          currentMargin,
          newMargin,
          monthlySales: product.monthlySales || 0,
          upc: product.upc,
          variantId: product.variantId
        };
      });

      // Calculate totals
      const currentRevenue = productsWithDiscounts.reduce((sum, p) => 
        sum + (p.currentPrice * p.monthlySales), 0
      );

      // Assume discount increases sales by a percentage based on discount depth
      const assumedUplift = discountConfig.value >= 30 ? 40 : 
                           discountConfig.value >= 20 ? 30 : 
                           discountConfig.value >= 10 ? 20 : 10;

      const projectedRevenue = productsWithDiscounts.reduce((sum, p) => 
        sum + (p.newPrice * p.monthlySales * (1 + assumedUplift / 100)), 0
      );

      const revenueChange = ((projectedRevenue - currentRevenue) / currentRevenue) * 100;

      // Calculate units regardless of cost data availability
      const totalUnitsSold = productsWithDiscounts.reduce((sum, p) => sum + p.monthlySales, 0);
      const projectedUnitsSold = totalUnitsSold * (1 + assumedUplift / 100);

      // Only calculate profit metrics if we have cost data
      let currentProfit = null;
      let projectedProfit = null;
      let currentMargin = null;
      let newMargin = null;
      let profitChange = null;
      let breakEvenUnits = null;

      if (hasCostData) {
        currentProfit = productsWithDiscounts.reduce((sum, p) => {
          if (p.cost !== null) {
            return sum + ((p.currentPrice - p.cost) * p.monthlySales);
          }
          return sum;
        }, 0);

        projectedProfit = productsWithDiscounts.reduce((sum, p) => {
          if (p.cost !== null) {
            return sum + ((p.newPrice - p.cost) * p.monthlySales * (1 + assumedUplift / 100));
          }
          return sum;
        }, 0);

        currentMargin = currentRevenue > 0 ? (currentProfit / currentRevenue) * 100 : 0;
        newMargin = projectedRevenue > 0 ? (projectedProfit / projectedRevenue) * 100 : 0;
        profitChange = currentProfit > 0 ? ((projectedProfit - currentProfit) / currentProfit) * 100 : 0;

        // Calculate break-even units
        const avgNewMargin = projectedUnitsSold > 0 ? projectedProfit / projectedUnitsSold : 0;
        const profitLoss = currentProfit - projectedProfit;
        breakEvenUnits = profitLoss > 0 && avgNewMargin > 0 ? Math.ceil(profitLoss / avgNewMargin) : 0;
      }

      console.log('üí∞ Financial Summary:');
      console.log(`  Current Revenue: $${currentRevenue.toFixed(2)}`);
      console.log(`  Projected Revenue: $${projectedRevenue.toFixed(2)} (${revenueChange.toFixed(1)}%)`);
      console.log(`  Units: ${totalUnitsSold} ‚Üí ${projectedUnitsSold.toFixed(0)} (+${assumedUplift}%)`);
      if (hasCostData) {
        console.log(`  Current Profit: $${currentProfit.toFixed(2)}`);
        console.log(`  Projected Profit: $${projectedProfit.toFixed(2)} (${profitChange.toFixed(1)}%)`);
      } else {
        console.log(`  ‚ö†Ô∏è Profit metrics unavailable (no cost data)`);
      }

      setDiscountImpact({
        hasCostData,
        productsAffected: productsWithDiscounts.length,
        currentRevenue,
        projectedRevenue,
        revenueChange,
        currentProfit,
        projectedProfit,
        profitChange,
        currentMargin,
        newMargin,
        totalUnitsSold,
        projectedUnitsSold: Math.round(projectedUnitsSold),
        breakEvenUnits,
        assumedUplift,
        affectedProducts: productsWithDiscounts,
        productsWithoutPrices: productsWithoutPrices.length
      });

      if (productsWithoutPrices.length > 0) {
        setFeedback(`‚úÖ Impact calculated (${productsWithoutPrices.length} products excluded - no price set)`);
      } else {
        setFeedback('‚úÖ Impact calculated successfully');
      }
      setTimeout(() => setFeedback(''), 5000);

    } catch (error) {
      console.error('‚ùå‚ùå‚ùå ERROR CALCULATING DISCOUNT IMPACT ‚ùå‚ùå‚ùå');
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
      console.error('Full error:', error);
      setFeedback('‚ùå Error calculating impact - check console (F12)');
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  // Push discount to Shopify
  const pushDiscountToShopify = async () => {
    if (!shopifyConfig.connected) {
      setFeedback('‚ö†Ô∏è Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    if (discountConfig.method === 'discount_code' && !discountConfig.autoApply && !discountConfig.codeName) {
      setFeedback('‚ö†Ô∏è Please enter a discount code name');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    if (discountConfig.method === 'discount_code' && discountConfig.autoApply && !discountConfig.codeName) {
      setFeedback('‚ö†Ô∏è Please enter a discount title');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    if (!discountImpact) {
      setFeedback('‚ö†Ô∏è Calculate impact first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    if (discountConfig.method === 'compare_at_price') {
      // Update product prices with compare_at_price
      setFeedback('üîÑ Updating product prices in Shopify...');

      try {
        // Prepare products with new pricing
        const productsToUpdate = discountImpact.affectedProducts.map(p => ({
          variantId: p.variantId,
          currentPrice: p.currentPrice,
          newPrice: p.newPrice,
          compareAtPrice: p.currentPrice // Old price becomes compare_at_price
        })).filter(p => p.variantId);

        if (productsToUpdate.length === 0) {
          setFeedback('‚ùå No products with variant IDs found');
          setTimeout(() => setFeedback(''), 3000);
          return;
        }

        const response = await fetch(`${BACKEND_URL}/api/shopify/update-prices`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            storeName: shopifyConfig.storeName,
            accessToken: shopifyConfig.accessToken,
            products: productsToUpdate
          })
        });

        const data = await response.json();

        if (response.ok) {
          setFeedback(`‚úÖ Updated ${data.updated} product prices in Shopify with compare at pricing!`);
          setTimeout(() => setFeedback(''), 5000);
        } else {
          setFeedback(`‚ùå Error: ${data.error || 'Failed to update prices'}`);
          setTimeout(() => setFeedback(''), 5000);
        }

      } catch (error) {
        console.error('Error updating prices in Shopify:', error);
        setFeedback('‚ùå Error updating prices in Shopify');
        setTimeout(() => setFeedback(''), 5000);
      }

    } else {
      // Create discount code (auto-apply or manual)
      const isAutomatic = discountConfig.autoApply;
      setFeedback(isAutomatic ? 'üîÑ Creating automatic discount in Shopify...' : 'üîÑ Creating discount code in Shopify...');

      try {
        // Get variant IDs for affected products
        const variantIds = discountImpact.affectedProducts
          .map(p => p.variantId)
          .filter(id => id);

        const response = await fetch(`${BACKEND_URL}/api/shopify/discount`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            storeName: shopifyConfig.storeName,
            accessToken: shopifyConfig.accessToken,
            discountCode: discountConfig.codeName,
            discountType: discountConfig.type,
            discountValue: discountConfig.value,
            startDate: discountConfig.startDate,
            endDate: discountConfig.endDate,
            variantIds: variantIds,
            automatic: isAutomatic
          })
        });

        const data = await response.json();

        if (response.ok) {
          if (isAutomatic) {
            setFeedback(`‚úÖ Automatic discount "${discountConfig.codeName}" created! Applies to all eligible carts automatically.`);
          } else {
            const storeUrl = shopifyConfig.storeName.replace('.myshopify.com', '');
            const checkoutUrl = `https://${storeUrl}.myshopify.com/discount/${data.code}`;
            setFeedback(`‚úÖ Discount code "${data.code}" created! Share this URL: ${checkoutUrl}`);
          }
          setTimeout(() => setFeedback(''), 8000);
        } else {
          setFeedback(`‚ùå Error: ${data.error || 'Failed to create discount'}`);
          setTimeout(() => setFeedback(''), 5000);
        }

      } catch (error) {
        console.error('Error creating discount in Shopify:', error);
        setFeedback('‚ùå Error creating discount in Shopify');
        setTimeout(() => setFeedback(''), 5000);
      }
    }
  };

  return (
    <div className="flex flex-col h-screen" style={{ background: '#f5f5f7' }}>
      {/* üçé NAVIGATION MENU - Apple Style */}
      <div className="bg-white/80 backdrop-blur-xl border-b border-gray-200/50 shadow-sm relative z-50 group" style={{
        backdropFilter: 'blur(20px) saturate(180%)',
        WebkitBackdropFilter: 'blur(20px) saturate(180%)'
      }}>
        <div className="px-6 py-3 overflow-hidden">
          <div className="flex gap-1 flex-nowrap relative">
            <button
              onClick={() => changePage('planner')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'planner'
                  ? 'bg-blue-500 text-white shadow-md'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'planner' ? '500' : '400',
                background: currentPage !== 'planner' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üó∫Ô∏è Store Planner
            </button>
            <button
              onClick={() => changePage('findProduct')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'findProduct'
                  ? 'bg-blue-500 text-white shadow-md'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'findProduct' ? '500' : '400',
                background: currentPage !== 'findProduct' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üîç Find Product
            </button>
            <button
              onClick={() => changePage('dashboard')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'dashboard'
                  ? 'bg-blue-500 text-white shadow-md'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'dashboard' ? '500' : '400',
                background: currentPage !== 'dashboard' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üìä Dashboard
            </button>
            <button
              onClick={() => changePage('forecasting')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'forecasting'
                  ? 'bg-blue-500 text-white shadow-md'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'forecasting' ? '500' : '400',
                background: currentPage !== 'forecasting' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üìà Forecasting
            </button>
            <button
              onClick={() => changePage('rowAnalytics')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'rowAnalytics'
                  ? 'bg-blue-500 text-white shadow-md'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'rowAnalytics' ? '500' : '400',
                background: currentPage !== 'rowAnalytics' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üìä Row Analytics
            </button>
            <button
              onClick={() => changePage('unknownProducts')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap relative ${
                currentPage === 'unknownProducts'
                  ? 'bg-blue-500 text-white shadow-md z-10'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'unknownProducts' ? '500' : '400',
                background: currentPage !== 'unknownProducts' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              ‚ö†Ô∏è Unknown Products
              {unknownProducts.filter(u => !u.resolved).length > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center shadow-sm">
                  {unknownProducts.filter(u => !u.resolved).length}
                </span>
              )}
            </button>
            <button
              onClick={() => changePage('badStock')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap relative ${
                currentPage === 'badStock'
                  ? 'bg-blue-500 text-white shadow-md z-10'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'badStock' ? '500' : '400',
                background: currentPage !== 'badStock' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üì¶ Bad Stock
              {badStockProducts.filter(b => !b.resolved).length > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center shadow-sm">
                  {badStockProducts.filter(b => !b.resolved).length}
                </span>
              )}
            </button>
            <button
              onClick={() => changePage('discounts')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'discounts'
                  ? 'bg-blue-500 text-white shadow-md relative z-10'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'discounts' ? '500' : '400',
                background: currentPage !== 'discounts' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              üí∞ Discounts
            </button>
            <button
              onClick={() => changePage('settings')}
              className={`px-4 py-2.5 rounded-xl font-medium transition-all text-sm whitespace-nowrap ${
                currentPage === 'settings'
                  ? 'bg-blue-500 text-white shadow-md relative z-10'
                  : 'text-gray-700 absolute opacity-0 group-hover:opacity-100 group-hover:relative transition-all duration-300'
              }`}
              style={{
                letterSpacing: '-0.01em',
                fontSize: '0.875rem',
                fontWeight: currentPage === 'settings' ? '500' : '400',
                background: currentPage !== 'settings' ? 'linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%)' : undefined
              }}
            >
              ‚öôÔ∏è Settings
            </button>
          </div>
        </div>
      </div>

      {/* üÜï SAVE SECTION VERSION MODAL */}
      {showSaveLayoutModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999]">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 className="text-2xl font-bold mb-4" style={{ color: '#1d1d1f', letterSpacing: '-0.02em' }}>
              üíæ Save Section Version
            </h2>
            <p className="text-sm mb-6" style={{ color: '#86868b' }}>
              Select a section and save its current state for comparison later.
            </p>
            
            {/* Section Dropdown */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Select Section</label>
              <select
                value={selectedSectionForHistory?.id || ''}
                onChange={(e) => {
                  const section = sections.find(s => s.id === e.target.value);
                  setSelectedSectionForHistory(section || null);
                }}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-base"
                style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}
              >
                <option value="">-- Choose a section --</option>
                {sections.map(section => (
                  <option key={section.id} value={section.id}>
                    {section.name}
                  </option>
                ))}
              </select>
            </div>
            
            {/* Version Name Input */}
            <input
              type="text"
              value={layoutNameInput}
              onChange={(e) => setLayoutNameInput(e.target.value)}
              placeholder="Version name (e.g., Summer 2024, After Remodel)"
              className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 mb-6 text-base"
              style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}
              disabled={!selectedSectionForHistory}
              onKeyPress={(e) => {
                if (e.key === 'Enter' && layoutNameInput.trim() && selectedSectionForHistory) {
                  console.log('  Enter key pressed, calling saveCurrentSection');
                  saveCurrentSection(selectedSectionForHistory, layoutNameInput).then(success => {
                    if (success) {
                      setLayoutNameInput('');
                      setShowSaveLayoutModal(false);
                      setSelectedSectionForHistory(null);
                    }
                  });
                }
              }}
            />
            
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setShowSaveLayoutModal(false);
                  setLayoutNameInput('');
                  setSelectedSectionForHistory(null);
                }}
                className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
                disabled={savingSectionVersion}
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  console.log('üíæ Modal Save Section clicked');
                  if (selectedSectionForHistory) {
                    console.log('  Calling saveCurrentSection with:', selectedSectionForHistory.name, layoutNameInput);
                    const success = await saveCurrentSection(selectedSectionForHistory, layoutNameInput);
                    console.log('  Result:', success);
                    if (success) {
                      setLayoutNameInput('');
                      setShowSaveLayoutModal(false);
                      setSelectedSectionForHistory(null);
                    }
                  } else {
                    console.log('  No section selected!');
                    alert('Please select a section first');
                  }
                }}
                disabled={!layoutNameInput.trim() || !selectedSectionForHistory || savingSectionVersion}
                className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {savingSectionVersion ? 'üíæ Saving...' : 'üíæ Save Section'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* üÜï LOAD LAYOUT MODAL */}
      {showLoadLayoutModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999]">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <h2 className="text-2xl font-bold mb-4" style={{ color: '#1d1d1f', letterSpacing: '-0.02em' }}>
              üìÇ Load Saved Layout
            </h2>
            <p className="text-sm mb-6" style={{ color: '#86868b' }}>
              Select a saved layout to load. This will replace your current layout.
            </p>
            
            {loadingLayouts ? (
              <div className="flex items-center justify-center py-12">
                <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
              </div>
            ) : savedLayouts.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-4xl mb-3">üìÇ</div>
                <div className="font-bold text-lg text-gray-700 mb-2">No Saved Layouts</div>
                <div className="text-sm text-gray-600">
                  Use "Save Layout As..." to save your current layout.
                </div>
              </div>
            ) : (
              <div className="flex-1 overflow-y-auto mb-6 -mx-2 px-2">
                <div className="space-y-3">
                  {savedLayouts.map((layout) => (
                    <div 
                      key={layout.id} 
                      className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-4 hover:border-blue-400 transition-all"
                    >
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1 min-w-0">
                          <h3 className="font-bold text-lg text-gray-900 mb-1">{layout.name}</h3>
                          <div className="text-sm text-gray-600 space-y-1">
                            <div>üìÖ {new Date(layout.timestamp).toLocaleString()}</div>
                            {layout.metadata && (
                              <div className="flex gap-4 text-xs">
                                <span>üèóÔ∏è {layout.metadata.fixtureCount || 0} fixtures</span>
                                <span>üì¶ {layout.metadata.sectionCount || 0} sections</span>
                                <span>üéØ {layout.metadata.productCount || 0} products</span>
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="flex gap-2 shrink-0">
                          <button
                            onClick={() => compareLayouts(layout.id, layout.name)}
                            disabled={loadingLayouts}
                            className={`px-4 py-2 text-white rounded-lg font-medium text-sm ${
                              loadingLayouts 
                                ? 'bg-gray-400 cursor-not-allowed' 
                                : 'bg-purple-500 hover:bg-purple-600'
                            }`}
                          >
                            {loadingLayouts ? '‚è≥ Loading...' : 'üîç Compare'}
                          </button>
                          <button
                            onClick={() => {
                              if (confirm(`Load "${layout.name}"? This will replace your current layout.`)) {
                                loadSavedLayout(layout.id);
                              }
                            }}
                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium text-sm"
                          >
                            üìÇ Load
                          </button>
                          <button
                            onClick={() => {
                              if (confirm(`Delete "${layout.name}"? This cannot be undone.`)) {
                                deleteSavedLayout(layout.id);
                              }
                            }}
                            className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
                            title="Delete layout"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            <div className="flex justify-end">
              <button
                onClick={() => setShowLoadLayoutModal(false)}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}


      {/* COMPARE LAYOUT MODAL - VISUAL SIDE-BY-SIDE WITH PRODUCTS */}
      {showCompareModal && compareData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
          <div className="bg-white rounded-lg shadow-2xl w-[98vw] h-[95vh] flex flex-col">
            {/* Header */}
            <div className="p-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50 flex justify-between items-center">
              <div>
                <h2 className="text-xl font-bold text-gray-900">
                  üîç Compare: {compareData.layoutName}
                </h2>
                <p className="text-sm text-gray-600">Click sections to see products ‚Ä¢ Search to find items</p>
              </div>
              <div className="flex gap-2">
                <input
                  type="text"
                  placeholder="üîé Search products..."
                  value={compareSearchTerm}
                  onChange={(e) => setCompareSearchTerm(e.target.value)}
                  className="px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-sm"
                  style={{ width: '200px' }}
                />
                <button
                  onClick={() => {
                    setShowCompareModal(false);
                    setShowLoadLayoutModal(true);
                    setCompareSelectedSection(null);
                    setCompareSearchTerm('');
                  }}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-medium"
                >
                  ‚Üê Back
                </button>
                <button
                  onClick={() => {
                    if (confirm(`Load "${compareData.layoutName}"? This will replace your current layout.`)) {
                      loadSavedLayout(compareData.layoutId);
                      setShowCompareModal(false);
                      setCompareSelectedSection(null);
                      setCompareSearchTerm('');
                    }
                  }}
                  className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-medium"
                >
                  üìÇ Load This Layout
                </button>
              </div>
            </div>

            {/* Stats Bar */}
            <div className="grid grid-cols-3 gap-2 p-3 bg-gray-50 border-b text-sm">
              <div className="flex items-center justify-center gap-2">
                <span className="font-semibold">üèóÔ∏è Fixtures:</span>
                <span className="px-2 py-1 bg-blue-100 rounded">{compareData.current.fixtures}</span>
                <span>‚Üí</span>
                <span className="px-2 py-1 bg-green-100 rounded font-bold">{compareData.saved.fixtures}</span>
                <span className="text-xs text-gray-600">
                  ({compareData.saved.fixtures - compareData.current.fixtures > 0 ? '+' : ''}
                  {compareData.saved.fixtures - compareData.current.fixtures})
                </span>
              </div>
              <div className="flex items-center justify-center gap-2">
                <span className="font-semibold">üì¶ Sections:</span>
                <span className="px-2 py-1 bg-blue-100 rounded">{compareData.current.sections}</span>
                <span>‚Üí</span>
                <span className="px-2 py-1 bg-green-100 rounded font-bold">{compareData.saved.sections}</span>
                <span className="text-xs text-gray-600">
                  ({compareData.saved.sections - compareData.current.sections > 0 ? '+' : ''}
                  {compareData.saved.sections - compareData.current.sections})
                </span>
              </div>
              <div className="flex items-center justify-center gap-2">
                <span className="font-semibold">üéØ Products:</span>
                <span className="px-2 py-1 bg-blue-100 rounded">{compareData.current.products}</span>
                <span>‚Üí</span>
                <span className="px-2 py-1 bg-green-100 rounded font-bold">{compareData.saved.products}</span>
                <span className="text-xs text-gray-600">
                  ({compareData.changes.productDiff > 0 ? '+' : ''}
                  {compareData.changes.productDiff})
                </span>
              </div>
            </div>

            {/* Side-by-Side Comparison with Product Panel */}
            <div className="flex-1 flex gap-2 p-4 overflow-hidden">
              {/* Planogram Views */}
              <div className="flex-1 grid grid-cols-2 gap-2">
                {/* LEFT SIDE - CURRENT LAYOUT */}
                <div className="flex flex-col border-2 border-blue-400 rounded-lg overflow-hidden bg-blue-50">
                  <div className="bg-blue-500 text-white px-4 py-2 font-bold text-center">
                    üìç CURRENT LAYOUT
                  </div>
                  <div className="flex-1 overflow-auto p-4 bg-white">
                    {fixtures.map((fixture, idx) => (
                      <div key={fixture.id} className="mb-4">
                        <div className="text-xs font-bold text-gray-700 mb-2 bg-gray-100 px-2 py-1 rounded">
                          {fixture.name || `Fixture ${idx + 1}`} ({fixture.width}√ó{fixture.height})
                        </div>
                        <div 
                          className="relative border-2 border-gray-300 bg-gray-100"
                          style={{ 
                            width: Math.min(fixture.width, 500), 
                            height: Math.min(fixture.height, 350) 
                          }}
                        >
                          {sections
                            .filter(s => s.fixtureId === fixture.id)
                            .map((section) => {
                              const layoutX = section.layoutX !== undefined ? section.layoutX : 0;
                              const layoutY = section.layoutY !== undefined ? section.layoutY : 0;
                              const layoutWidth = section.layoutWidth !== undefined ? section.layoutWidth : 100;
                              const layoutHeight = section.layoutHeight !== undefined ? section.layoutHeight : 100;
                              
                              const left = (layoutX / 100) * Math.min(fixture.width, 500);
                              const top = (layoutY / 100) * Math.min(fixture.height, 350);
                              const width = (layoutWidth / 100) * Math.min(fixture.width, 500);
                              const height = (layoutHeight / 100) * Math.min(fixture.height, 350);
                              
                              const isRemoved = !compareData.savedData.sections?.some(s => s.name === section.name);
                              const metrics = calculateMetrics(section, timePeriod);
                              
                              // Check if section has search term
                              let hasSearchMatch = false;
                              if (compareSearchTerm) {
                                const searchLower = compareSearchTerm.toLowerCase();
                                if (section.rows) {
                                  section.rows.forEach(row => {
                                    if (row.products) {
                                      row.products.forEach(p => {
                                        if (p.title?.toLowerCase().includes(searchLower) || 
                                            p.sku?.toLowerCase().includes(searchLower)) {
                                          hasSearchMatch = true;
                                        }
                                      });
                                    }
                                  });
                                }
                              }
                              
                              const isSelected = compareSelectedSection?.side === 'current' && compareSelectedSection?.id === section.id;
                              
                              return (
                                <div
                                  key={section.id}
                                  onClick={() => setCompareSelectedSection({ side: 'current', id: section.id, section: section })}
                                  style={{
                                    position: 'absolute',
                                    left: left,
                                    top: top,
                                    width: width,
                                    height: height,
                                    background: isRemoved 
                                      ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
                                      : 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)',
                                    border: isSelected ? '3px solid #ffeb3b' : (isRemoved ? '2px solid #991b1b' : '2px solid #1e40af'),
                                    borderRadius: '4px',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    fontSize: width < 60 ? '8px' : '10px',
                                    fontWeight: 'bold',
                                    padding: '4px',
                                    textAlign: 'center',
                                    overflow: 'hidden',
                                    textShadow: '0 1px 2px rgba(0,0,0,0.5)',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: hasSearchMatch ? '0 0 0 3px #ffeb3b' : (isSelected ? '0 0 10px rgba(255,235,59,0.5)' : 'none'),
                                    transform: isSelected ? 'scale(1.02)' : 'scale(1)'
                                  }}
                                  title={`${section.name} - $${metrics.profitPerSqFt.toFixed(0)}/sqft`}
                                >
                                  <div style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', width: '100%' }}>
                                    {isRemoved && '‚ùå '}
                                    {section.name}
                                  </div>
                                  {width > 70 && height > 40 && (
                                    <div style={{ fontSize: '9px', opacity: 0.9, marginTop: '2px' }}>
                                      ${metrics.profitPerSqFt.toFixed(0)}/sqft
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                        </div>
                      </div>
                    ))}
                    {fixtures.length === 0 && (
                      <div className="text-center text-gray-500 py-8">No fixtures in current layout</div>
                    )}
                  </div>
                </div>

                {/* RIGHT SIDE - SAVED LAYOUT */}
                <div className="flex flex-col border-2 border-green-400 rounded-lg overflow-hidden bg-green-50">
                  <div className="bg-green-500 text-white px-4 py-2 font-bold text-center">
                    üíæ SAVED LAYOUT: {compareData.layoutName}
                  </div>
                  <div className="flex-1 overflow-auto p-4 bg-white">
                    {(compareData.savedData.fixtures || []).map((fixture, idx) => (
                      <div key={fixture.id} className="mb-4">
                        <div className="text-xs font-bold text-gray-700 mb-2 bg-gray-100 px-2 py-1 rounded">
                          {fixture.name || `Fixture ${idx + 1}`} ({fixture.width}√ó{fixture.height})
                        </div>
                        <div 
                          className="relative border-2 border-gray-300 bg-gray-100"
                          style={{ 
                            width: Math.min(fixture.width, 500), 
                            height: Math.min(fixture.height, 350) 
                          }}
                        >
                          {(compareData.savedData.sections || [])
                            .filter(s => s.fixtureId === fixture.id)
                            .map((section) => {
                              const layoutX = section.layoutX !== undefined ? section.layoutX : 0;
                              const layoutY = section.layoutY !== undefined ? section.layoutY : 0;
                              const layoutWidth = section.layoutWidth !== undefined ? section.layoutWidth : 100;
                              const layoutHeight = section.layoutHeight !== undefined ? section.layoutHeight : 100;
                              
                              const left = (layoutX / 100) * Math.min(fixture.width, 500);
                              const top = (layoutY / 100) * Math.min(fixture.height, 350);
                              const width = (layoutWidth / 100) * Math.min(fixture.width, 500);
                              const height = (layoutHeight / 100) * Math.min(fixture.height, 350);
                              
                              const isNew = !sections.some(s => s.name === section.name);
                              const metrics = calculateMetrics(section, timePeriod);
                              
                              // Check if section has search term
                              let hasSearchMatch = false;
                              if (compareSearchTerm) {
                                const searchLower = compareSearchTerm.toLowerCase();
                                if (section.rows) {
                                  section.rows.forEach(row => {
                                    if (row.products) {
                                      row.products.forEach(p => {
                                        if (p.title?.toLowerCase().includes(searchLower) || 
                                            p.sku?.toLowerCase().includes(searchLower)) {
                                          hasSearchMatch = true;
                                        }
                                      });
                                    }
                                  });
                                }
                              }
                              
                              const isSelected = compareSelectedSection?.side === 'saved' && compareSelectedSection?.id === section.id;
                              
                              return (
                                <div
                                  key={section.id}
                                  onClick={() => setCompareSelectedSection({ side: 'saved', id: section.id, section: section })}
                                  style={{
                                    position: 'absolute',
                                    left: left,
                                    top: top,
                                    width: width,
                                    height: height,
                                    background: isNew 
                                      ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                                      : 'linear-gradient(135deg, #34d399 0%, #10b981 100%)',
                                    border: isSelected ? '3px solid #ffeb3b' : (isNew ? '2px solid #065f46' : '2px solid #047857'),
                                    borderRadius: '4px',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    fontSize: width < 60 ? '8px' : '10px',
                                    fontWeight: 'bold',
                                    padding: '4px',
                                    textAlign: 'center',
                                    overflow: 'hidden',
                                    textShadow: '0 1px 2px rgba(0,0,0,0.5)',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: hasSearchMatch ? '0 0 0 3px #ffeb3b' : (isSelected ? '0 0 10px rgba(255,235,59,0.5)' : 'none'),
                                    transform: isSelected ? 'scale(1.02)' : 'scale(1)'
                                  }}
                                  title={`${section.name} - $${metrics.profitPerSqFt.toFixed(0)}/sqft`}
                                >
                                  <div style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', width: '100%' }}>
                                    {isNew && '‚ú® '}
                                    {section.name}
                                  </div>
                                  {width > 70 && height > 40 && (
                                    <div style={{ fontSize: '9px', opacity: 0.9, marginTop: '2px' }}>
                                      ${metrics.profitPerSqFt.toFixed(0)}/sqft
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                        </div>
                      </div>
                    ))}
                    {(compareData.savedData.fixtures || []).length === 0 && (
                      <div className="text-center text-gray-500 py-8">No fixtures in saved layout</div>
                    )}
                  </div>
                </div>
              </div>

              {/* Product Details Panel */}
              {compareSelectedSection && (
                <div className="w-80 flex flex-col border-2 border-yellow-400 rounded-lg overflow-hidden bg-yellow-50">
                  <div className="bg-yellow-500 text-white px-4 py-2 font-bold text-sm flex justify-between items-center">
                    <span>üìã {compareSelectedSection.section.name}</span>
                    <button 
                      onClick={() => setCompareSelectedSection(null)}
                      className="text-white hover:bg-yellow-600 rounded px-2"
                    >
                      ‚úï
                    </button>
                  </div>
                  <div className="p-3 bg-white border-b">
                    <div className="text-xs space-y-1">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Side:</span>
                        <span className="font-bold">{compareSelectedSection.side === 'current' ? 'üìç Current' : 'üíæ Saved'}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Profit/sqft:</span>
                        <span className="font-bold text-green-600">
                          ${calculateMetrics(compareSelectedSection.section, timePeriod).profitPerSqFt.toFixed(2)}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div className="flex-1 overflow-auto p-3 bg-white">
                    <div className="text-xs font-bold text-gray-700 mb-2">Products:</div>
                    {(() => {
                      const products = [];
                      if (compareSelectedSection.section.rows) {
                        compareSelectedSection.section.rows.forEach(row => {
                          if (row.products) {
                            products.push(...row.products);
                          }
                        });
                      }
                      
                      const filteredProducts = compareSearchTerm 
                        ? products.filter(p => 
                            p.title?.toLowerCase().includes(compareSearchTerm.toLowerCase()) ||
                            p.sku?.toLowerCase().includes(compareSearchTerm.toLowerCase())
                          )
                        : products;
                      
                      if (filteredProducts.length === 0) {
                        return <div className="text-gray-500 text-xs italic">No products</div>;
                      }
                      
                      return (
                        <div className="space-y-2">
                          {filteredProducts.map((product, idx) => (
                            <div 
                              key={idx} 
                              className={`p-2 rounded border text-xs ${
                                compareSearchTerm && (
                                  product.title?.toLowerCase().includes(compareSearchTerm.toLowerCase()) ||
                                  product.sku?.toLowerCase().includes(compareSearchTerm.toLowerCase())
                                ) ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-50 border-gray-200'
                              }`}
                            >
                              <div className="font-bold text-gray-900 mb-1">{product.title || 'Unnamed Product'}</div>
                              <div className="text-gray-600 space-y-0.5">
                                <div>SKU: {product.sku || 'N/A'}</div>
                                <div>Price: ${product.price || '0'}</div>
                                <div>Stock: {product.inventory || 0}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>
                </div>
              )}
            </div>

            {/* Legend */}
            <div className="p-3 border-t bg-gray-50 flex justify-center gap-6 text-sm">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{ background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' }}></div>
                <span>‚ùå Will be removed</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{ background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' }}></div>
                <span>‚ú® Will be added</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded border-2 border-yellow-400"></div>
                <span>Selected / Search match</span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* SAVE SECTION VERSION MODAL */}
      {showSaveSectionModal && selectedSectionForHistory && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] backdrop-blur-sm">
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 className="text-2xl font-bold mb-4 text-gray-900">
              üíæ Save Section Version
            </h2>
            <p className="text-gray-600 mb-4">
              Save current state of <span className="font-bold">{selectedSectionForHistory.name}</span>
            </p>
            
            <input
              type="text"
              placeholder="Version name (e.g., 'Summer 2024', 'After Remodel')"
              value={sectionVersionName}
              onChange={(e) => setSectionVersionName(e.target.value)}
              onKeyPress={(e) => {
                if (e.key === 'Enter' && sectionVersionName.trim()) {
                  saveSectionVersion(selectedSectionForHistory, sectionVersionName);
                  setShowSaveSectionModal(false);
                  setSectionVersionName('');
                }
              }}
              className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg mb-4"
              autoFocus
              disabled={savingSectionVersion}
            />
            
            <div className="flex gap-2 justify-end">
              <button
                onClick={() => {
                  setShowSaveSectionModal(false);
                  setSectionVersionName('');
                }}
                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
                disabled={savingSectionVersion}
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  const success = await saveSectionVersion(selectedSectionForHistory, sectionVersionName);
                  if (success) {
                    setShowSaveSectionModal(false);
                    setSectionVersionName('');
                  }
                }}
                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-medium"
                disabled={!sectionVersionName.trim() || savingSectionVersion}
              >
                {savingSectionVersion ? 'üíæ Saving...' : 'üíæ Save Version'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* SECTION HISTORY PANEL */}
      {showSectionHistoryPanel && selectedSectionForHistory && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                üìö Version History: {selectedSectionForHistory.name}
              </h2>
              <p className="text-gray-600 mt-1">Compare and restore previous versions</p>
            </div>
            
            <div className="p-6">
              {loadingSectionVersions ? (
                <div className="text-center py-8">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-500 mx-auto mb-4"></div>
                  <div className="text-gray-600">Loading versions...</div>
                </div>
              ) : sectionVersions.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">üìÇ</div>
                  <div className="font-bold text-lg text-gray-900 mb-2">No Saved Versions</div>
                  <div className="text-gray-600">
                    Click "üíæ Save Version" to save the current state of this section
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 mb-4">
                    <div className="text-sm font-medium text-blue-900">
                      üí° Select 2 versions to compare side-by-side
                    </div>
                  </div>
                  
                  {sectionVersions.map((version, idx) => {
                    const isSelected = compareSectionVersions?.version1?.id === version.id || 
                                      compareSectionVersions?.version2?.id === version.id;
                    
                    return (
                      <div
                        key={version.id}
                        className={`border-2 rounded-lg p-4 hover:border-indigo-400 transition-all ${
                          isSelected ? 'border-yellow-400 bg-yellow-50' : 'border-indigo-200 bg-gradient-to-r from-indigo-50 to-purple-50'
                        }`}
                      >
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex items-start gap-3 flex-1">
                            <input
                              type="checkbox"
                              checked={isSelected}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  if (!compareSectionVersions) {
                                    setCompareSectionVersions({ version1: version, version2: null });
                                  } else if (!compareSectionVersions.version2) {
                                    setCompareSectionVersions({ ...compareSectionVersions, version2: version });
                                  } else {
                                    // Already have 2, replace the first
                                    setCompareSectionVersions({ version1: version, version2: compareSectionVersions.version2 });
                                  }
                                } else {
                                  if (compareSectionVersions?.version1?.id === version.id) {
                                    setCompareSectionVersions(compareSectionVersions.version2 ? 
                                      { version1: compareSectionVersions.version2, version2: null } : 
                                      null
                                    );
                                  } else if (compareSectionVersions?.version2?.id === version.id) {
                                    setCompareSectionVersions({ ...compareSectionVersions, version2: null });
                                  }
                                }
                              }}
                              className="mt-1 w-4 h-4"
                            />
                            <div className="flex-1">
                              <h3 className="font-bold text-lg text-gray-900 mb-1">
                                {idx === 0 && '‚≠ê '}{version.versionName}
                              </h3>
                              <div className="text-sm text-gray-600 space-y-1">
                                <div>üìÖ {new Date(version.timestamp).toLocaleString()}</div>
                                {version.metadata && (
                                  <div className="text-xs">
                                    üéØ {version.metadata.productCount || 0} products
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                          <div className="flex gap-2 shrink-0">
                            <button
                              onClick={() => {
                                if (confirm(`Load "${version.versionName}"? This will replace the current section.`)) {
                                  loadSectionVersion(version.id, selectedSectionForHistory.name);
                                  setShowSectionHistoryPanel(false);
                                }
                              }}
                              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium text-sm"
                            >
                              üìÇ Load
                            </button>
                            <button
                              onClick={() => {
                                if (confirm(`Delete "${version.versionName}"? This cannot be undone.`)) {
                                  deleteSectionVersion(version.id);
                                }
                              }}
                              className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
                              title="Delete version"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                  
                  {/* Compare Button */}
                  {compareSectionVersions?.version1 && compareSectionVersions?.version2 && (
                    <div className="sticky bottom-0 bg-gradient-to-r from-green-500 to-blue-500 text-white p-4 rounded-lg shadow-lg">
                      <div className="flex items-center justify-between">
                        <div className="text-sm">
                          <div className="font-bold mb-1">Ready to Compare:</div>
                          <div>‚Ä¢ {compareSectionVersions.version1.versionName}</div>
                          <div>‚Ä¢ {compareSectionVersions.version2.versionName}</div>
                        </div>
                        <button
                          onClick={() => {
                            alert('üöß Comparison view coming soon! For now, load each version to see the difference.');
                            // TODO: Open comparison modal
                          }}
                          className="px-6 py-3 bg-white text-blue-600 rounded-lg hover:bg-gray-100 font-bold"
                        >
                          üîç Compare Now
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            <div className="p-6 bg-gray-50 flex justify-end border-t">
              <button
                onClick={() => {
                  setShowSectionHistoryPanel(false);
                  setSectionVersions([]);
                }}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* LOAD SECTION VERSION MODAL */}
      {showLoadModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                üìÇ Load Section Version
              </h2>
              <p className="text-gray-600 mt-1">
                {selectedSection ? `Versions of: ${selectedSection.name}` : 'No section selected'}
              </p>
            </div>
            
            <div className="p-6">
              {loadingSectionVersions ? (
                <div className="text-center py-8">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-500 mx-auto mb-4"></div>
                  <div className="text-gray-600">Loading section versions...</div>
                </div>
              ) : !selectedSection ? (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                  <div className="font-bold text-lg text-gray-900 mb-2">No Section Selected</div>
                  <div className="text-gray-600">Select a section from the sidebar first</div>
                </div>
              ) : sectionVersions.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">üì≠</div>
                  <div className="font-bold text-lg text-gray-900 mb-2">No Saved Versions</div>
                  <div className="text-gray-600">
                    Use the üíæ Save Section button to save "{selectedSection.name}"
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  {sectionVersions.map((version) => (
                    <div
                      key={version.id}
                      className="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:bg-blue-50 transition-all"
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="font-bold text-lg text-gray-900">{version.versionName}</div>
                          <div className="text-sm text-gray-600 mt-1">
                            {new Date(version.timestamp).toLocaleString()}
                          </div>
                          {version.metadata && (
                            <div className="text-xs text-gray-500 mt-2">
                              üì¶ {version.metadata.productCount} products
                            </div>
                          )}
                        </div>
                        <div className="ml-4">
                          <button
                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium"
                            onClick={async () => {
                              if (confirm(`Load "${version.versionName}"?\n\nThis will replace the current section.`)) {
                                const success = await loadSectionVersionById(version.id, selectedSection.name);
                                if (success) {
                                  setShowLoadModal(false);
                                  setFeedback(`‚úÖ Loaded: ${version.versionName}`);
                                  setTimeout(() => setFeedback(''), 3000);
                                }
                              }
                            }}
                          >
                            üìÇ Load
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            <div className="p-6 bg-gray-50 flex justify-end border-t">
              <button
                onClick={() => setShowLoadModal(false)}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* FIREBASE CLEANUP MODAL */}
      {showCleanupModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-red-50 to-orange-50">
              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                üóëÔ∏è Firebase Storage Cleanup
              </h2>
              <p className="text-gray-600 mt-1">Review and delete old layouts and section versions</p>
            </div>
            
            <div className="p-6">
              {loadingFirebaseItems ? (
                <div className="text-center py-8">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-red-500 mx-auto mb-4"></div>
                  <div className="text-gray-600">Loading Firebase data...</div>
                </div>
              ) : allFirebaseItems.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">üéâ</div>
                  <div className="font-bold text-lg text-gray-900 mb-2">All Clean!</div>
                  <div className="text-gray-600">No saved data in Firebase</div>
                </div>
              ) : (
                <div>
                  {/* Summary Stats */}
                  <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 text-center">
                      <div className="text-3xl font-bold text-blue-600">
                        {allFirebaseItems.length}
                      </div>
                      <div className="text-sm text-blue-700">Total Items</div>
                    </div>
                    <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 text-center">
                      <div className="text-3xl font-bold text-purple-600">
                        {allFirebaseItems.filter(i => i.type === 'Section Version').length}
                      </div>
                      <div className="text-sm text-purple-700">Section Versions</div>
                    </div>
                    <div className="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 text-center">
                      <div className="text-3xl font-bold text-orange-600">
                        {allFirebaseItems.filter(i => i.type === 'Full Layout').length}
                      </div>
                      <div className="text-sm text-orange-700">Full Layouts (OLD)</div>
                    </div>
                    <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 text-center">
                      <div className="text-3xl font-bold text-red-600">
                        {Math.round(allFirebaseItems.reduce((sum, i) => sum + i.sizeKB, 0))}KB
                      </div>
                      <div className="text-sm text-red-700">Total Storage</div>
                    </div>
                  </div>

                  {/* Quick Actions */}
                  <div className="flex gap-2 mb-4">
                    <button
                      onClick={() => {
                        const fullLayouts = allFirebaseItems.filter(i => i.type === 'Full Layout');
                        if (fullLayouts.length === 0) {
                          alert('No full layouts to delete');
                          return;
                        }
                        if (confirm(`Delete ALL ${fullLayouts.length} full layouts? (Keep section versions)\n\nThis will free up space since we only use section versions now.`)) {
                          deleteFirebaseItems(fullLayouts.map(i => i.id));
                        }
                      }}
                      className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-medium text-sm"
                    >
                      üî• Delete All Full Layouts
                    </button>
                    <button
                      onClick={() => {
                        const largeItems = allFirebaseItems.filter(i => i.sizeKB > 100);
                        if (largeItems.length === 0) {
                          alert('No large items (>100KB) found');
                          return;
                        }
                        if (confirm(`Delete ${largeItems.length} large items (>100KB)?`)) {
                          deleteFirebaseItems(largeItems.map(i => i.id));
                        }
                      }}
                      className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium text-sm"
                    >
                      üí£ Delete Large Items (>100KB)
                    </button>
                    <button
                      onClick={() => {
                        if (confirm(`DELETE EVERYTHING?\n\nThis will delete all ${allFirebaseItems.length} items from Firebase.\n\nThis cannot be undone!`)) {
                          deleteFirebaseItems(allFirebaseItems.map(i => i.id));
                        }
                      }}
                      className="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 font-medium text-sm"
                    >
                      ‚ò†Ô∏è DELETE EVERYTHING
                    </button>
                  </div>

                  {/* Items Table */}
                  <div className="border rounded-lg overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="text-left p-3 font-bold">Name</th>
                          <th className="text-left p-3 font-bold">Type</th>
                          <th className="text-left p-3 font-bold">Section</th>
                          <th className="text-right p-3 font-bold">Size</th>
                          <th className="text-right p-3 font-bold">Products</th>
                          <th className="text-left p-3 font-bold">Date</th>
                          <th className="text-center p-3 font-bold">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {allFirebaseItems.map((item, idx) => (
                          <tr key={item.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="p-3">{item.name}</td>
                            <td className="p-3">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                item.type === 'Section Version' 
                                  ? 'bg-purple-100 text-purple-700' 
                                  : 'bg-orange-100 text-orange-700'
                              }`}>
                                {item.type}
                              </span>
                            </td>
                            <td className="p-3 text-gray-600">{item.sectionName}</td>
                            <td className="p-3 text-right">
                              <span className={`font-mono ${item.sizeKB > 100 ? 'text-red-600 font-bold' : ''}`}>
                                {item.sizeKB}KB
                              </span>
                            </td>
                            <td className="p-3 text-right text-gray-600">{item.productCount || 0}</td>
                            <td className="p-3 text-gray-600 text-xs">
                              {new Date(item.timestamp).toLocaleDateString()}
                            </td>
                            <td className="p-3 text-center">
                              <button
                                onClick={() => {
                                  if (confirm(`Delete "${item.name}"?`)) {
                                    deleteFirebaseItems([item.id]);
                                  }
                                }}
                                className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"
                              >
                                üóëÔ∏è Delete
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
            
            <div className="p-6 bg-gray-50 flex justify-end border-t">
              <button
                onClick={() => {
                  setShowCleanupModal(false);
                  setAllFirebaseItems([]);
                }}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* PAGE CONTENT */}
      {currentPage === 'planner' && (
        <>
    <div className="flex flex-1 overflow-hidden bg-gray-100">
      {showLibrary && (
        <div 
          className="bg-white shadow-lg p-4 overflow-y-auto relative"
          style={{ width: `${sidebarWidth}px`, minWidth: '250px', maxWidth: '800px' }}
        >
          {/* Resize Handle */}
          <div
            className="absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors z-50"
            onMouseDown={(e) => {
              e.preventDefault();
              setIsResizingSidebar(true);
              const startX = e.clientX;
              const startWidth = sidebarWidth;
              
              const handleMouseMove = (moveEvent) => {
                const delta = moveEvent.clientX - startX;
                const newWidth = Math.max(250, Math.min(800, startWidth + delta));
                setSidebarWidth(newWidth);
              };
              
              const handleMouseUp = () => {
                setIsResizingSidebar(false);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
            style={{ 
              background: isResizingSidebar ? '#3b82f6' : 'transparent',
              width: isResizingSidebar ? '4px' : '4px'
            }}
          >
            <div className="absolute top-1/2 right-0 transform translate-x-1/2 -translate-y-1/2 bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center text-white opacity-0 hover:opacity-100 transition-opacity shadow-lg pointer-events-none">
              ‚áÑ
            </div>
          </div>

          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold flex items-center gap-2">
              <Icons.Package />
              Fixture Library
            </h2>
            <button onClick={() => setShowLibrary(false)} className="p-1 hover:bg-gray-100 rounded">
              <Icons.X />
            </button>
          </div>

          <div className="space-y-2">
            {Object.entries(FIXTURE_TYPES).map(([key, type]) => {
              const IconComponent = Icons[type.icon];
              return (
                <button
                  key={key}
                  onClick={() => addFixture(key)}
                  className="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200"
                >
                  <div className="w-10 h-10 rounded flex items-center justify-center" style={{ backgroundColor: type.color }}>
                    {IconComponent && <IconComponent />}
                  </div>
                  <span className="font-medium">{type.name}</span>
                </button>
              );
            })}
          </div>

          <div className="mt-6 pt-6 border-t">
            <div className="flex gap-2 mb-3">
              <button
                onClick={() => {
                  setSelectedFixtures(fixtures.map(f => f.id));
                  setFeedback(`‚úÖ Selected all ${fixtures.length} fixtures`);
                  setTimeout(() => setFeedback(''), 2000);
                }}
                className="flex-1 px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm font-semibold"
                title="Select all fixtures (Shift+Click to multi-select, Ctrl/Cmd+A)"
              >
                ‚òëÔ∏è Select All
              </button>
              <button
                onClick={() => {
                  setSelectedFixtures([]);
                  setFeedback('‚úÖ Deselected all fixtures');
                  setTimeout(() => setFeedback(''), 2000);
                }}
                disabled={selectedFixtures.length === 0}
                className={`flex-1 px-3 py-2 rounded text-sm font-semibold ${
                  selectedFixtures.length === 0 
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                    : 'bg-gray-500 text-white hover:bg-gray-600'
                }`}
                title="Deselect all fixtures (or press ESC)"
              >
                ‚¨ú Clear
              </button>
            </div>
            
            {selectedFixtures.length > 0 && (
              <div className="p-3 bg-yellow-50 border-2 border-yellow-400 rounded mb-3">
                <div className="text-sm font-bold text-yellow-800">
                  ‚ú® {selectedFixtures.length} fixture(s) selected
                </div>
                <div className="text-xs text-yellow-700 mt-1">
                  Drag any selected fixture to move them all together
                </div>
              </div>
            )}
            
            <h3 className="font-bold mb-2">Active Fixtures</h3>
            <div className="space-y-1">
              {(fixtures || []).map(fixture => (
                <div
                  key={fixture.id}
                  className={`p-2 rounded cursor-pointer flex items-center justify-between ${
                    selectedFixture === fixture.id ? 'bg-blue-100' : 'hover:bg-gray-100'
                  }`}
                  onClick={() => setSelectedFixture(fixture.id)}
                >
                  {editingFixture === fixture.id ? (
                    <input
                      type="text"
                      value={editingFixtureName}
                      onChange={(e) => setEditingFixtureName(e.target.value)}
                      onBlur={() => {
                        if (editingFixtureName.trim()) {
                          updateFixtureName(fixture.id, editingFixtureName.trim());
                        } else {
                          setEditingFixture(null);
                        }
                      }}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && editingFixtureName.trim()) {
                          updateFixtureName(fixture.id, editingFixtureName.trim());
                        }
                        if (e.key === 'Escape') {
                          setEditingFixture(null);
                        }
                      }}
                      className="flex-1 px-2 py-1 border-2 border-blue-500 rounded text-sm"
                      autoFocus
                      onClick={(e) => e.stopPropagation()}
                    />
                  ) : (
                    <span 
                      className="text-sm flex-1 hover:text-blue-600"
                      onClick={(e) => {
                        e.stopPropagation();
                        setEditingFixture(fixture.id);
                        setEditingFixtureName(fixture.name);
                      }}
                      title="Click to rename"
                    >
                      {fixture.name}
                    </span>
                  )}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteFixture(fixture.id);
                    }}
                    className="text-red-500 hover:text-red-700"
                  >
                    <Icons.Trash2 />
                  </button>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      <div className="flex-1 flex flex-col">
        <div className="px-3 py-1 flex items-center justify-between flex-wrap gap-1 toolbar-compact" style={{
          minHeight: '44px'
        }}>
          <div className="flex items-center gap-2 flex-wrap">
            {!showLibrary && (
              <button onClick={() => setShowLibrary(true)} className="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                Show Library
              </button>
            )}
            
         <button
              onClick={() => setHeatMapMode(!heatMapMode)}
              className={`px-3 py-2 rounded flex items-center gap-2 text-sm ${heatMapMode ? 'bg-orange-500 text-white' : 'bg-gray-200'}`}
            >
              <Icons.Flame />
              Heat Map
            </button>

            {/* Heat Map Type Selector - Button Style */}
            {heatMapMode && (
              <select
                value={heatMapType}
                onChange={(e) => setHeatMapType(e.target.value)}
                className="px-3 py-2 bg-orange-100 text-orange-900 border-2 border-orange-300 rounded hover:bg-orange-200 text-sm font-medium focus:outline-none focus:border-orange-500 cursor-pointer appearance-none"
                style={{ minWidth: '180px' }}
              >
                <option value="profit">üí∞ Profit Density</option>
                <option value="velocity">üì¶ Sales Velocity</option>
                <option value="deadStock">üö® Dead Stock</option>
                <option value="margin">üí∏ Profit Margin</option>
                <option value="stockHealth">‚ù§Ô∏è Stock Health</option>
                <option value="aov">üî• High AOV Products</option>
                <option value="returningCustomers">üîÑ Returning Customer Favorites</option>
                <option value="shoppingPath">üõí Shopping Path</option>
              </select>
            )}

            <button
              onClick={saveToCloud}
              className="px-3 py-2 bg-green-500 text-white rounded flex items-center gap-2 text-sm hover:bg-green-600"
            >
              <Icons.Save />
              Save
            </button>

            {/* üíæ SAVE AND LOAD SECTIONS */}
            <button
              onClick={async () => {
                alert('üîç TEST: Save Section button was clicked!');
                console.log('üíæ Save Section button clicked');
                console.log('  selectedSection:', selectedSection);
                
                if (!selectedSection) {
                  alert('‚ö†Ô∏è No section selected!\n\nPlease select a section from the sidebar first.');
                  return;
                }
                
                console.log(`  Section name: ${selectedSection.name}`);
                console.log(`  Section has ${selectedSection.rows?.length || 0} rows`);
                
                const versionName = prompt(`Save section "${selectedSection.name}"\n\nEnter version name:`);
                console.log(`  Version name entered: "${versionName}"`);
                
                if (versionName && versionName.trim()) {
                  console.log('  Calling saveCurrentSection...');
                  try {
                    const success = await saveCurrentSection(selectedSection, versionName);
                    console.log(`  Save result: ${success ? 'SUCCESS' : 'FAILED'}`);
                  } catch (err) {
                    console.error('  Save error:', err);
                    alert('‚ùå Save error: ' + err.message);
                  }
                } else {
                  console.log('  Save cancelled (no version name)');
                }
              }}
              className="px-3 py-2 bg-purple-500 text-white rounded flex items-center gap-2 text-sm hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Save current section"
            >
              üíæ Save Section
            </button>

            <button
              onClick={() => {
                alert('üîç TEST: Load Section button was clicked!');
                if (selectedSection) {
                  setShowLoadModal(true);
                  getSectionVersions(selectedSection.name);
                } else {
                  alert('Please select a section first');
                }
              }}
              className="px-3 py-2 bg-blue-500 text-white rounded flex items-center gap-2 text-sm hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Load a saved section version"
            >
              üìÇ Load Section
            </button>

            {syncStatus && (
              <div className="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">
                {syncStatus}
              </div>
            )}

            <input type="file" ref={fileInputRef} onChange={handleBackgroundUpload} accept="image/*" className="hidden" />

            {backgroundImage && (
              <>
                <button onClick={removeBackground} className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                  Remove
                </button>
                <button onClick={resetBackgroundPosition} className="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 flex items-center gap-2 text-sm">
                  <Icons.Move />
                  Reset
                </button>
              </>
            )}

            <button onClick={exportLayout} className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center gap-2 text-sm">
              <Icons.Download />
              Export
            </button>

            {/* Sync All Button - Quick Access */}
            {shopifyConfig.connected && (
              <button 
                onClick={async () => {
                  setFeedback('üîÑ Syncing all data...');
                  try {
                    await refreshProductCache(false);
                    await refreshSalesOnly();
                    await refreshOrders();
                    setFeedback('‚úÖ All data synced!');
                    setTimeout(() => setFeedback(''), 3000);
                  } catch (error) {
                    setFeedback('‚ùå Sync failed');
                  }
                }}
                className="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded hover:from-blue-600 hover:to-blue-700 text-sm font-medium flex items-center gap-1 shadow-sm"
                title="Sync all data: Products, Sales, and Orders"
              >
                üîÑ Sync All
              </button>
            )}

            {/* Time Period Filter - Button Style */}
            <select
              value={timePeriod}
              onChange={(e) => setTimePeriod(e.target.value)}
              className="px-3 py-2 bg-blue-100 text-blue-900 border-2 border-blue-300 rounded hover:bg-blue-200 text-sm font-medium focus:outline-none focus:border-blue-500 cursor-pointer appearance-none flex items-center gap-2"
              style={{ minWidth: '140px' }}
            >
              <option value="day">üìÖ Today</option>
              <option value="week">üìÖ This Week</option>
              <option value="month">üìÖ This Month</option>
              <option value="quarter">üìÖ This Quarter</option>
              <option value="year">üìÖ This Year</option>
              <option value="all">üìÖ All Time</option>
              <option value="custom">üìÖ Custom Range</option>
            </select>

            {/* Compact Progress Display - Inline with toolbar */}
            {(feedback || syncProgress.message || syncProgress.total > 0) && (
              <div className="px-3 py-2 bg-gradient-to-r from-blue-100 to-purple-100 border border-blue-300 rounded-lg text-sm flex items-center gap-2">
                <span className="font-medium text-blue-900">{feedback || syncProgress.message}</span>
                {syncProgress.total > 0 && (
                  <span className="font-bold text-blue-700">{syncProgress.current}/{syncProgress.total}</span>
                )}
              </div>
            )}

            {/* Custom Date Range Picker */}
            {timePeriod === 'custom' && (
              <div className="flex items-center gap-2 bg-gradient-to-r from-purple-50 to-pink-50 px-3 py-2 rounded-lg border border-purple-300">
                <input
                  type="date"
                  value={customDateRange.start}
                  onChange={(e) => setCustomDateRange({...customDateRange, start: e.target.value})}
                  className="px-2 py-1 border-2 border-purple-300 rounded text-sm focus:outline-none focus:border-purple-500"
                />
                <span className="text-sm font-semibold text-gray-600">to</span>
                <input
                  type="date"
                  value={customDateRange.end}
                  onChange={(e) => setCustomDateRange({...customDateRange, end: e.target.value})}
                  className="px-2 py-1 border-2 border-purple-300 rounded text-sm focus:outline-none focus:border-purple-500"
                />
              </div>
            )}
          </div>
        </div>

        <div 
          ref={canvasRef}
          className="flex-1 relative overflow-hidden bg-gray-50"
          style={{ 
            cursor: isPanning ? 'grabbing' : (isDraggingBg ? 'grabbing' : 'default'),
            backgroundImage: 'radial-gradient(circle, #d1d5db 1px, transparent 1px)',
            backgroundSize: '20px 20px',
            touchAction: 'none' // Prevent default touch behaviors
          }}
          onWheel={handleCanvasWheel}
          onMouseDown={handleCanvasMouseDown}
          onMouseMove={(e) => {
            handleBgMouseMove(e);
            handleCanvasMouseMove(e);
          }}
          onMouseUp={(e) => {
            handleBgMouseUp();
            handleCanvasMouseUp(e);
          }}
          onMouseLeave={(e) => {
            handleBgMouseUp();
            handleCanvasMouseUp(e);
          }}
          onTouchStart={handleCanvasTouchStart}
          onTouchMove={handleCanvasTouchMove}
          onTouchEnd={handleCanvasTouchEnd}
          onClick={(e) => {
            // Deselect if clicking on empty canvas (not on a fixture)
            if (e.target === e.currentTarget || e.target.closest('.canvas-background')) {
              setSelectedSection(null);
              setSelectedProduct(null);
              setSelectedFixture(null); // Close right sidebar when clicking empty space
            }
          }}
        >
          {/* Transform wrapper for zoom/pan/rotate */}
          <div style={{
            transform: `scale(${zoom}) translate(${panOffset.x / zoom}px, ${panOffset.y / zoom}px) rotate(${rotation}deg)`,
            transformOrigin: '0 0',
            width: '100%',
            height: '100%',
            position: 'relative'
          }}>
          {backgroundImage && (
            <img
              src={backgroundImage}
              alt="Store layout"
              style={{
                position: 'absolute',
                top: bgImagePosition.y,
                left: bgImagePosition.x,
                maxWidth: '100%',
                maxHeight: '100%',
                objectFit: 'contain',
                opacity: 0.3,
                pointerEvents: 'auto',
                cursor: isDraggingBg ? 'grabbing' : 'grab',
                zIndex: 0,
                userSelect: 'none'
              }}
              onMouseDown={handleBgMouseDown}
              draggable={false}
            />
          )}

          {(fixtures || []).map(fixture => (
            <Fixture
              key={fixture.id}
              fixture={fixture}
              onUpdate={updateFixture}
              onDelete={deleteFixture}
              onSelect={() => setSelectedFixture(fixture.id)}
              isSelected={selectedFixture === fixture.id}
            />
          ))}
          </div>
          
          {/* Floating Touch Controls */}
          <div 
            className="absolute bottom-4 right-4 flex flex-col gap-2"
            style={{ pointerEvents: 'auto', zIndex: 1000 }}
          >
            {/* Zoom Controls */}
            <div className="flex flex-col gap-1 bg-white rounded-lg shadow-lg p-2">
              <button
                onClick={() => setZoom(prev => Math.min(3, prev * 1.2))}
                className="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors text-xl font-bold"
                style={{ touchAction: 'manipulation' }}
              >
                ‚Üë +
              </button>
              <div className="text-center text-xs py-1 font-semibold">
                {Math.round(zoom * 100)}%
              </div>
              <button
                onClick={() => setZoom(prev => Math.max(0.1, prev / 1.2))}
                className="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors text-xl font-bold"
                style={{ touchAction: 'manipulation' }}
              >
                ‚Üì ‚àí
              </button>
            </div>
            
            {/* Pan Controls */}
            <div className="bg-white rounded-lg shadow-lg p-2">
              <div className="grid grid-cols-3 gap-1">
                <div></div>
                <button
                  onClick={() => setPanOffset(prev => ({ ...prev, y: prev.y + 50 }))}
                  className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 transition-colors text-xl font-bold"
                  style={{ touchAction: 'manipulation' }}
                >
                  ‚Üë
                </button>
                <div></div>
                <button
                  onClick={() => setPanOffset(prev => ({ ...prev, x: prev.x + 50 }))}
                  className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 transition-colors text-xl font-bold"
                  style={{ touchAction: 'manipulation' }}
                >
                  ‚Üê
                </button>
                <div className="flex items-center justify-center text-xs font-semibold">Pan</div>
                <button
                  onClick={() => setPanOffset(prev => ({ ...prev, x: prev.x - 50 }))}
                  className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 transition-colors text-xl font-bold"
                  style={{ touchAction: 'manipulation' }}
                >
                  ‚Üí
                </button>
                <div></div>
                <button
                  onClick={() => setPanOffset(prev => ({ ...prev, y: prev.y - 50 }))}
                  className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 transition-colors text-xl font-bold"
                  style={{ touchAction: 'manipulation' }}
                >
                  ‚Üì
                </button>
                <div></div>
              </div>
            </div>
            
            {/* Rotation Controls */}
            <div className="flex flex-col gap-1 bg-white rounded-lg shadow-lg p-2">
              <button
                onClick={() => setRotation(prev => (prev - 15) % 360)}
                className="p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 active:bg-purple-700 transition-colors text-xl"
                style={{ touchAction: 'manipulation' }}
                title="Rotate canvas view counter-clockwise"
              >
                ‚Ü∂
              </button>
              <div className="text-center text-xs py-1 font-semibold" title="Canvas rotation">
                {Math.round(rotation)}¬∞
              </div>
              <button
                onClick={() => setRotation(prev => (prev + 15) % 360)}
                className="p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 active:bg-purple-700 transition-colors text-xl"
                style={{ touchAction: 'manipulation' }}
                title="Rotate canvas view clockwise"
              >
                ‚Ü∑
              </button>
            </div>
            
            {/* Reset Controls */}
            <div className="flex flex-col gap-1 bg-white rounded-lg shadow-lg p-2">
              <button
                onClick={() => {
                  setZoom(1);
                  setPanOffset({ x: 0, y: 0 });
                  setRotation(0);
                }}
                className="p-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 active:bg-gray-800 transition-colors text-sm font-semibold"
                style={{ touchAction: 'manipulation' }}
                title="Reset view"
              >
                Reset
              </button>
            </div>
          </div>
        </div>
      </div>

      {selectedFixture && (
        <div 
          className="bg-white shadow-lg p-4 overflow-y-auto relative"
          style={{ width: `${rightSidebarWidth}px`, minWidth: '250px', maxWidth: '800px' }}
        >
          {/* Resize Handle - LEFT edge */}
          <div
            className="absolute top-0 left-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors z-50"
            onMouseDown={(e) => {
              e.preventDefault();
              setIsResizingRightSidebar(true);
              const startX = e.clientX;
              const startWidth = rightSidebarWidth;
              
              const handleMouseMove = (moveEvent) => {
                const delta = startX - moveEvent.clientX; // Reversed delta for left edge
                const newWidth = Math.max(250, Math.min(800, startWidth + delta));
                setRightSidebarWidth(newWidth);
              };
              
              const handleMouseUp = () => {
                setIsResizingRightSidebar(false);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
            style={{ 
              background: isResizingRightSidebar ? '#3b82f6' : 'transparent',
              width: isResizingRightSidebar ? '4px' : '4px'
            }}
          >
            <div className="absolute top-1/2 left-0 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center text-white opacity-0 hover:opacity-100 transition-opacity shadow-lg pointer-events-none">
              ‚áÑ
            </div>
          </div>

          {editingFixture === selectedFixture ? (
            <div className="flex items-center justify-between mb-4">
              <input
                type="text"
                value={editingFixtureName}
                onChange={(e) => setEditingFixtureName(e.target.value)}
                onBlur={() => {
                  if (editingFixtureName.trim()) {
                    updateFixtureName(selectedFixture, editingFixtureName.trim());
                  } else {
                    setEditingFixture(null);
                  }
                }}
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && editingFixtureName.trim()) {
                    updateFixtureName(selectedFixture, editingFixtureName.trim());
                  }
                  if (e.key === 'Escape') {
                    setEditingFixture(null);
                  }
                }}
                className="text-xl font-bold px-2 py-1 border-2 border-blue-500 rounded flex-1"
                autoFocus
              />
              <button
                onClick={() => setSelectedFixture(null)}
                className="ml-2 p-2 hover:bg-gray-100 rounded-full transition-colors"
                title="Close sidebar"
              >
                <Icons.X />
              </button>
            </div>
          ) : (
            <div className="flex items-center justify-between mb-4">
              <h2 
                className="text-xl font-bold cursor-pointer hover:text-blue-600 flex-1"
                onClick={() => {
                  setEditingFixture(selectedFixture);
                  setEditingFixtureName(fixtures.find(f => f.id === selectedFixture)?.name || '');
                }}
                title="Click to rename fixture"
              >
                {fixtures.find(f => f.id === selectedFixture)?.name}
              </h2>
              <button
                onClick={() => {
                  const fixture = fixtures.find(f => f.id === selectedFixture);
                  if (confirm(`Delete "${fixture?.name}" and all its sections?`)) {
                    deleteFixture(selectedFixture);
                    setSelectedFixture(null);
                  }
                }}
                className="ml-2 p-2 bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors"
                title="Delete this fixture"
              >
                <Icons.Trash2 />
              </button>
              <button
                onClick={() => setSelectedFixture(null)}
                className="ml-2 p-2 hover:bg-gray-100 rounded-full transition-colors"
                title="Close sidebar"
              >
                <Icons.X />
              </button>
            </div>
          )}

        <button
            onClick={() => addSection(selectedFixture)}
            className="w-full px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 mb-2 flex items-center justify-center gap-2"
          >
            <Icons.Plus />
            Add Section
          </button>

          <button
            onClick={() => addDeadSpaceSection(selectedFixture)}
            className="w-full px-3 py-2 bg-gray-400 text-white rounded hover:bg-gray-500 mb-2 flex items-center justify-center gap-2"
            title="Add a dead space section to track unutilized areas"
          >
            <Icons.Package />
            Add Dead Space
          </button>

          <button
            onClick={() => setShowSaveModal(true)}
            className="w-full px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 mb-2 flex items-center justify-center gap-2"
            title="Save current layout for comparison"
          >
            <Icons.Save />
            üíæ Quick Save Layout
          </button>

          <button
            onClick={() => {
              const proportionalSections = calculateProportionalLayout(sections, selectedFixture);
              setSections(sections.map(s => {
                const updated = proportionalSections.find(ps => ps.id === s.id);
                return updated || s;
              }));
              autoSave(sections.map(s => {
                const updated = proportionalSections.find(ps => ps.id === s.id);
                return updated || s;
              }), 'Auto-saved proportional layout');
              setFeedback('‚úÖ Applied proportional layout based on section lengths');
              setTimeout(() => setFeedback(''), 3000);
            }}
            className="w-full px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 mb-2 flex items-center justify-center gap-2"
            title="Automatically arrange sections based on their length dimensions"
          >
            <Icons.Maximize2 />
            Apply Proportional Layout
          </button>

          <button
            onClick={() => {
              // Collapse all sections
              setCollapsedSectionLayouts(new Set(['all']));
              setCollapsedRowsSections(new Set(['all']));
              setCollapsedUnknownProducts(new Set(['all']));
            }}
            className="w-full px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 mb-4 flex items-center justify-center gap-2 text-sm"
          >
            ‚ñ≤ Collapse All Sections
          </button>

          <button
            onClick={() => {
              setDimensionsMasterLock(!dimensionsMasterLock);
              // Save lock state to localStorage
              localStorage.setItem('planogram_dimensions_locked', JSON.stringify(!dimensionsMasterLock));
            }}
            className={`w-full px-3 py-2 rounded mb-4 flex items-center justify-center gap-2 text-sm font-bold ${
              dimensionsMasterLock 
                ? 'bg-red-600 text-white hover:bg-red-700' 
                : 'bg-green-600 text-white hover:bg-green-700'
            }`}
          >
            {dimensionsMasterLock ? 'üîí DIMENSIONS LOCKED - Click to Unlock' : 'üîì Lock All Dimensions'}
          </button>

          <div className="space-y-4">
            {sections
              .filter(s => s.fixtureId === selectedFixture)
              .map(section => {
                const metrics = calculateMetrics(section, timePeriod);
                const isSectionCollapsed = collapsedSections.has(section.id);
                
                return (
                  <div
                    key={section.id}
                    ref={el => sectionRefs.current[section.id] = el}
                    className={`p-4 border-2 rounded-lg ${selectedSection === section.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                    onClick={() => {
                      setSelectedSection(section.id);
                      // Expand all collapsible sections when clicking
                      const newLayoutCollapsed = new Set(collapsedSectionLayouts);
                      newLayoutCollapsed.delete('all');
                      newLayoutCollapsed.delete(section.id);
                      setCollapsedSectionLayouts(newLayoutCollapsed);
                      
                      const newRowsCollapsed = new Set(collapsedRowsSections);
                      newRowsCollapsed.delete('all');
                      newRowsCollapsed.delete(section.id);
                      setCollapsedRowsSections(newRowsCollapsed);
                      
                      const newUnknownCollapsed = new Set(collapsedUnknownProducts);
                      newUnknownCollapsed.delete('all');
                      newUnknownCollapsed.delete(section.id);
                      setCollapsedUnknownProducts(newUnknownCollapsed);
                      
                      // Scroll to and focus UPC input
                      setTimeout(() => {
                        if (upcInputRef.current) {
                          upcInputRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                          upcInputRef.current.focus();
                        }
                      }, 100);
                    }}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-1">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const newCollapsed = new Set(collapsedSections);
                            if (isSectionCollapsed) {
                              newCollapsed.delete(section.id);
                            } else {
                              newCollapsed.add(section.id);
                            }
                            setCollapsedSections(newCollapsed);
                          }}
                          className="text-gray-600 hover:text-gray-800 font-bold text-lg"
                          title={isSectionCollapsed ? "Expand section" : "Collapse section"}
                        >
                          {isSectionCollapsed ? '‚ñ∂' : '‚ñº'}
                        </button>
                      </div>
                      
                      {editingSection === section.id ? (
                        <input
                          type="text"
                          value={editingSectionName}
                          onChange={(e) => setEditingSectionName(e.target.value)}
                          onBlur={() => {
                            if (editingSectionName.trim()) {
                              updateSectionName(section.id, editingSectionName.trim());
                            } else {
                              setEditingSection(null);
                            }
                          }}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter' && editingSectionName.trim()) {
                              updateSectionName(section.id, editingSectionName.trim());
                            }
                            if (e.key === 'Escape') {
                              setEditingSection(null);
                            }
                          }}
                          className="flex-1 px-2 py-1 border-2 border-blue-500 rounded font-bold"
                          autoFocus
                          onClick={(e) => e.stopPropagation()}
                        />
                      ) : (
                        <h3 
                          className="font-bold cursor-pointer hover:text-blue-600 flex-1"
                          onClick={(e) => {
                            e.stopPropagation();
                            setEditingSection(section.id);
                            setEditingSectionName(section.name);
                          }}
                          title="Click to rename"
                        >
                          {section.name}
                        </h3>
                      )}
                      
                      {/* Section Version Control */}
                      {selectedSection === section.id && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setSelectedSectionForHistory(section);
                            setShowSectionHistoryPanel(true);
                            getSectionVersions(section.name);
                          }}
                          className="px-2 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 text-xs font-medium ml-2"
                          title="View version history for this section"
                        >
                          üìö History
                        </button>
                      )}
                      
                      {/* Reorder buttons - on the right side */}
                      <div className="flex flex-col ml-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            moveSectionInList(section.id, 'up');
                          }}
                          className="text-gray-500 hover:text-blue-600 text-xs leading-none"
                          title="Move section up in list"
                        >
                          ‚ñ≤
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            moveSectionInList(section.id, 'down');
                          }}
                          className="text-gray-500 hover:text-blue-600 text-xs leading-none"
                          title="Move section down in list"
                        >
                          ‚ñº
                        </button>
                      </div>
                      
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          deleteSection(section.id);
                        }}
                        className="text-red-500 hover:text-red-700 ml-2"
                      >
                        <Icons.Trash2 />
                      </button>
                    </div>

                    {!isSectionCollapsed && (
                      <>
                        <div className="text-sm space-y-1 mb-3">
                      <div className="space-y-2">
                        {editingSectionArea === section.id ? (
                          <div className="space-y-2 p-2 bg-blue-50 rounded" onClick={(e) => e.stopPropagation()}>
                            <div className="font-semibold text-xs text-blue-700">Dimensions (inches):</div>
                            {(() => {
                              const fixture = fixtures.find(f => f.id === section.fixtureId);
                              const isGondola = fixture?.type === 'gondola';
                              
                              return (
                                <>
                                  <div className="grid grid-cols-3 gap-2">
                                    <div>
                                      <label className="text-xs text-gray-600">Length</label>
                                      <input
                                        type="number"
                                        step="1"
                                        min="1"
                                        value={editingDimensions.length}
                                        onChange={(e) => setEditingDimensions({ ...editingDimensions, length: e.target.value })}
                                        className="w-full px-2 py-1 border-2 border-blue-300 rounded text-sm"
                                        placeholder="L"
                                      />
                                    </div>
                                    <div>
                                      <label className="text-xs text-gray-600">
                                        Depth {isGondola && !dimensionLockOverride && <span className="text-red-600">üîí LOCKED</span>}
                                      </label>
                                      <input
                                        type="number"
                                        step="1"
                                        min="1"
                                        value={editingDimensions.depth}
                                        onChange={(e) => setEditingDimensions({ ...editingDimensions, depth: e.target.value })}
                                        className={`w-full px-2 py-1 border-2 rounded text-sm ${isGondola && !dimensionLockOverride ? 'bg-gray-200 border-gray-400 cursor-not-allowed' : 'border-blue-300'}`}
                                        placeholder="D"
                                        readOnly={isGondola && !dimensionLockOverride}
                                        disabled={isGondola && !dimensionLockOverride}
                                      />
                                    </div>
                                    <div>
                                      <label className="text-xs text-gray-600">
                                        Height {isGondola && !dimensionLockOverride && <span className="text-red-600">üîí LOCKED</span>}
                                      </label>
                                      <input
                                        type="number"
                                        step="1"
                                        min="1"
                                        value={editingDimensions.height}
                                        onChange={(e) => setEditingDimensions({ ...editingDimensions, height: e.target.value })}
                                        className={`w-full px-2 py-1 border-2 rounded text-sm ${isGondola && !dimensionLockOverride ? 'bg-gray-200 border-gray-400 cursor-not-allowed' : 'border-blue-300'}`}
                                        placeholder="H"
                                        readOnly={isGondola && !dimensionLockOverride}
                                        disabled={isGondola && !dimensionLockOverride}
                                      />
                                    </div>
                                  </div>
                                  {isGondola && !dimensionLockOverride && (
                                    <div className="space-y-1">
                                      <div className="text-xs text-red-600 font-semibold">
                                        ‚ö†Ô∏è Gondola depth (14") and height (57.5") are locked - only length can be edited
                                      </div>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          setDimensionLockOverride(true);
                                        }}
                                        className="px-2 py-1 bg-orange-500 text-white rounded text-xs hover:bg-orange-600"
                                      >
                                        ‚öôÔ∏è Override Lock
                                      </button>
                                    </div>
                                  )}
                                  {isGondola && dimensionLockOverride && (
                                    <div className="text-xs text-orange-600 font-semibold">
                                      üîì Lock overridden - you can now edit depth and height
                                    </div>
                                  )}
                                </>
                              );
                            })()}
                            <div className="text-xs text-gray-600">
                              = {((parseFloat(editingDimensions.length) * parseFloat(editingDimensions.depth)) / 144 || 0).toFixed(2)} sq ft
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  const l = parseFloat(editingDimensions.length);
                                  const d = parseFloat(editingDimensions.depth);
                                  const h = parseFloat(editingDimensions.height);
                                  if (l && d && h) {
                                    const area = (l * d) / 144; // Convert square inches to square feet
                                    const updatedSections = sections.map(s => 
                                      s.id === section.id 
                                        ? { ...s, length: l, depth: d, height: h, area: area }
                                        : s
                                    );
                                    setSections(updatedSections);
                                    autoSave(updatedSections, 'Auto-saved after updating dimensions');
                                  }
                                  setEditingSectionArea(null);
                                  setDimensionLockOverride(false);
                                }}
                                className="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                              >
                                Save
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setEditingSectionArea(null);
                                  setDimensionLockOverride(false);
                                }}
                                className="px-3 py-1 bg-gray-300 text-gray-700 rounded text-xs hover:bg-gray-400"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div
                            className={`p-2 rounded -mx-2 ${dimensionsMasterLock ? 'cursor-not-allowed bg-red-50' : 'cursor-pointer hover:text-blue-600 hover:bg-blue-50'}`}
                            onClick={(e) => {
                              e.stopPropagation();
                              
                              if (dimensionsMasterLock) {
                                alert('üîí Dimensions are LOCKED! Click "üîí DIMENSIONS LOCKED" button above to unlock.');
                                return;
                              }
                              
                              setEditingSectionArea(section.id);
                              
                              // Check if this section belongs to a gondola
                              const fixture = fixtures.find(f => f.id === section.fixtureId);
                              const isGondola = fixture?.type === 'gondola';
                              
                              setEditingDimensions({
                                length: (section.length || 48).toString(),
                                depth: (isGondola ? 14 : (section.depth || 30)).toString(),
                                height: (isGondola ? 57.5 : (section.height || 72)).toString()
                              });
                            }}
                            title={dimensionsMasterLock ? "üîí LOCKED - Click master lock button to unlock" : "Click to edit dimensions"}
                          >
                            {dimensionsMasterLock && (
                              <div className="text-xs text-red-600 font-bold mb-1">üîí LOCKED</div>
                            )}
                            <div className="text-xs text-gray-600">Dimensions (L√óD√óH):</div>
                            <div className="font-semibold">{section.length || 48}" √ó {section.depth || 30}" √ó {section.height || 72}"</div>
                            <div className="text-xs text-gray-600">
                              Area: {(((section.length || 48) * (section.depth || 30)) / 144).toFixed(2)} sq ft
                            </div>
                          </div>
                        )}
                      </div>
                      <div className="font-bold text-green-600">
                        Profit/sq ft: ${metrics.profitPerSqFt.toFixed(2)}
                      </div>
                      <div>Total Profit: ${metrics.totalProfit.toFixed(2)}</div>
                      <div>Products: {section.rows ? section.rows.reduce((sum, row) => sum + (row.products?.length || 0), 0) : section.products?.length || 0}</div>
                    </div>

                    {/* Section Layout Controls */}
                    <div className="space-y-2 mb-3 border-t pt-3">
                      <div 
                        className="flex items-center justify-between cursor-pointer hover:bg-blue-50 p-2 rounded -mx-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          const newCollapsed = new Set(collapsedSectionLayouts);
                          newCollapsed.delete('all'); // Remove 'all' flag when manually toggling
                          if (newCollapsed.has(section.id)) {
                            newCollapsed.delete(section.id);
                          } else {
                            newCollapsed.add(section.id);
                          }
                          setCollapsedSectionLayouts(newCollapsed);
                        }}
                      >
                        <div className="text-xs font-bold text-gray-600">SECTION LAYOUT</div>
                        <span className="text-lg text-gray-500 font-bold">
                          {(collapsedSectionLayouts.has('all') || collapsedSectionLayouts.has(section.id)) ? '‚ñ∂' : '‚ñº'}
                        </span>
                      </div>
                      
                      {!(collapsedSectionLayouts.has('all') || collapsedSectionLayouts.has(section.id)) && (
                        <>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="text-xs text-gray-600">X Position %</label>
                          <input
                            type="number"
                            min="0"
                            max="100"
                            value={section.layoutX || 0}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutX: parseFloat(e.target.value) || 0 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-600">Y Position %</label>
                          <input
                            type="number"
                            min="0"
                            max="100"
                            value={section.layoutY || 0}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutY: parseFloat(e.target.value) || 0 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-600">Width %</label>
                          <input
                            type="number"
                            min="1"
                            max="100"
                            value={section.layoutWidth || 100}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutWidth: parseFloat(e.target.value) || 100 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-600">Height %</label>
                          <input
                            type="number"
                            min="1"
                            max="100"
                            value={section.layoutHeight || 100}
                            onChange={(e) => {
                              const updatedSections = sections.map(s => 
                                s.id === section.id ? { ...s, layoutHeight: parseFloat(e.target.value) || 100 } : s
                              );
                              setSections(updatedSections);
                              autoSave(updatedSections, 'Section layout updated');
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 100, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections, 'Section layout reset');
                          }}
                          className="flex-1 px-2 py-1 bg-gray-200 text-xs rounded hover:bg-gray-300"
                        >
                          Reset Layout
                        </button>
                      </div>
                      <div className="text-xs text-gray-600 mt-2">Quick Layouts:</div>
                      <div className="grid grid-cols-3 gap-1">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 50, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Left Half"
                        >
                          ‚¨ÖÔ∏è Left
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 50, layoutY: 0, layoutWidth: 50, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Right Half"
                        >
                          Right ‚û°Ô∏è
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 100, layoutHeight: 50 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Top Half"
                        >
                          ‚¨ÜÔ∏è Top
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 50, layoutWidth: 100, layoutHeight: 50 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-blue-100 text-xs rounded hover:bg-blue-200"
                          title="Bottom Half"
                        >
                          Bottom ‚¨áÔ∏è
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 33, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-green-100 text-xs rounded hover:bg-green-200"
                          title="1/3 Width"
                        >
                          1/3
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const updatedSections = sections.map(s => 
                              s.id === section.id ? { ...s, layoutX: 0, layoutY: 0, layoutWidth: 25, layoutHeight: 100 } : s
                            );
                            setSections(updatedSections);
                            autoSave(updatedSections);
                          }}
                          className="px-2 py-1 bg-green-100 text-xs rounded hover:bg-green-200"
                          title="1/4 Width"
                        >
                          1/4
                        </button>
                      </div>
                      </>
                      )}
                    </div>

                    {/* Rows Section */}
                    <div className="border-t pt-3 mb-3">
                      <div 
                        className="flex justify-between items-center mb-2 cursor-pointer hover:bg-blue-50 p-2 rounded -mx-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          const newCollapsed = new Set(collapsedRowsSections);
                          newCollapsed.delete('all'); // Remove 'all' flag when manually toggling
                          if (newCollapsed.has(section.id)) {
                            newCollapsed.delete(section.id);
                          } else {
                            newCollapsed.add(section.id);
                          }
                          setCollapsedRowsSections(newCollapsed);
                        }}
                      >
                        <div className="flex items-center gap-2">
                          <h4 className="font-semibold text-sm">Rows (Height Tracking)</h4>
                          <span className="text-lg text-gray-500 font-bold">
                            {(collapsedRowsSections.has('all') || collapsedRowsSections.has(section.id)) ? '‚ñ∂' : '‚ñº'}
                          </span>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              e.preventDefault();
                              addRowToSection(section.id);
                            }}
                            className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                          >
                            + Add Row
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              e.preventDefault();
                              addDeadRowToSection(section.id);
                            }}
                            className="px-2 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600"
                            title="Add a dead row to track unutilized shelf space"
                          >
                            + Add Dead Row
                          </button>
                        </div>
                      </div>
                      
                      {!(collapsedRowsSections.has('all') || collapsedRowsSections.has(section.id)) && (
                      <div className="space-y-2">
                        {(section.rows || []).map((row, rowIdx) => {
                          // Calculate row metrics
                          const rowProducts = row.products || [];
                          let rowTotalSales = 0;
                          let rowTotalStock = 0;
                          let rowDeadStockCount = 0;
                          let rowProfit = 0;
                          
                          rowProducts.forEach(p => {
                            let sales = 0;
                            switch(timePeriod) {
                              case 'day': sales = p.dailySales || 0; break;
                              case 'week': sales = p.weeklySales || 0; break;
                              case 'month': sales = p.monthlySales || 0; break;
                              case 'quarter': sales = p.quarterlySales || 0; break;
                              case 'year': sales = p.yearlySales || 0; break;
                              case 'all': sales = p.allTimeSales || 0; break;
                              default: sales = p.monthlySales || 0;
                            }
                            
                            rowTotalSales += sales;
                            rowTotalStock += p.inventoryQuantity || 0;
                            if ((p.inventoryQuantity || 0) > 0 && sales === 0) rowDeadStockCount++;
                            rowProfit += (p.price - p.cost) * sales;
                          });
                          
                          // Calculate heat map color for this row
                          let rowHeatColor = 'bg-white';
                          if (heatMapMode && rowProducts.length > 0) {
                            const sectionArea = (section.length && section.depth) 
                              ? (section.length * section.depth) / 144
                              : (section.area || 1);
                            const rowProfitPerSqFt = rowProfit / sectionArea;
                            const rowVelocity = rowTotalSales / sectionArea;
                            
                            const deadStockValue = rowProducts
                              .filter(p => (p.inventoryQuantity || 0) > 0 && rowProducts.some(rp => {
                                let s = 0;
                                switch(timePeriod) {
                                  case 'day': s = rp.dailySales || 0; break;
                                  case 'week': s = rp.weeklySales || 0; break;
                                  case 'month': s = rp.monthlySales || 0; break;
                                  case 'quarter': s = rp.quarterlySales || 0; break;
                                  case 'year': s = rp.yearlySales || 0; break;
                                  case 'all': s = rp.allTimeSales || 0; break;
                                  default: s = rp.monthlySales || 0;
                                }
                                return rp.upc === p.upc && s === 0;
                              }))
                              .reduce((sum, p) => sum + (p.inventoryQuantity || 0) * p.cost, 0);
                            
                            const avgMargin = rowProducts.length > 0 ?
                              rowProducts.reduce((sum, p) => {
                                const margin = p.price > 0 ? ((p.price - p.cost) / p.price) : 0;
                                return sum + margin;
                              }, 0) / rowProducts.length : 0;
                            
                            const outOfStock = rowProducts.filter(p => (p.inventoryQuantity || 0) === 0 && rowTotalSales > 0).length;
                            const lowStock = rowProducts.filter(p => {
                              const stock = p.inventoryQuantity || 0;
                              let s = 0;
                              switch(timePeriod) {
                                case 'day': s = p.dailySales || 0; break;
                                case 'week': s = p.weeklySales || 0; break;
                                case 'month': s = p.monthlySales || 0; break;
                                default: s = p.monthlySales || 0;
                              }
                              const daysRemaining = s > 0 ? stock / (s / 30) : Infinity;
                              return stock > 0 && daysRemaining < 7;
                            }).length;
                            
                            switch(heatMapType) {
                              case 'profit':
                                if (rowProfitPerSqFt > 5) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (rowProfitPerSqFt > 2) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (rowProfitPerSqFt > 0.5) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                              case 'velocity':
                                if (rowVelocity > 2) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (rowVelocity > 1) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (rowVelocity > 0.2) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                              case 'deadStock':
                                if (deadStockValue > 500) rowHeatColor = 'bg-red-100 border-red-300';
                                else if (deadStockValue > 200) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else if (deadStockValue > 50) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else rowHeatColor = 'bg-green-100 border-green-300';
                                break;
                              case 'margin':
                                if (avgMargin > 0.5) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (avgMargin > 0.3) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (avgMargin > 0.15) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                              case 'stockHealth':
                                const problemScore = outOfStock * 3 + lowStock * 2 + rowDeadStockCount;
                                if (problemScore === 0) rowHeatColor = 'bg-green-100 border-green-300';
                                else if (problemScore < 3) rowHeatColor = 'bg-yellow-100 border-yellow-300';
                                else if (problemScore < 6) rowHeatColor = 'bg-orange-100 border-orange-300';
                                else rowHeatColor = 'bg-red-100 border-red-300';
                                break;
                            }
                          }
                          
                          const isSelectedRow = selectedRow === row.id;
                          const isExpanded = expandedRows.has(row.id);
                          
                          return (
                            <div 
                              key={row.id}
                              className={`rounded-lg border-2 transition-all ${
                                row.isDeadSpace
                                  ? 'border-gray-400 bg-gray-200'
                                  : isSelectedRow 
                                    ? 'border-blue-500 bg-blue-50' 
                                    : heatMapMode 
                                      ? `${rowHeatColor} hover:border-blue-300` 
                                      : 'border-gray-200 bg-white hover:border-blue-300'
                              }`}
                            >
                              {/* Row Header - Always Visible */}
                              <div 
                                className="p-3 cursor-pointer"
                                onClick={() => {
                                  setSelectedRow(row.id);
                                  setNewProduct({ ...newProduct, sectionId: section.id, rowId: row.id });
                                }}
                              >
                                <div className="flex justify-between items-start mb-2">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      {editingRow === row.id ? (
                                        <input
                                          type="text"
                                          defaultValue={row.name}
                                          autoFocus
                                          onBlur={(e) => {
                                            updateRowName(section.id, row.id, e.target.value);
                                            setEditingRow(null);
                                          }}
                                          onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                              updateRowName(section.id, row.id, e.target.value);
                                              setEditingRow(null);
                                            }
                                          }}
                                          className="font-semibold text-base px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          onClick={(e) => e.stopPropagation()}
                                        />
                                      ) : (
                                        <>
                                          <span 
                                            className="font-semibold text-base cursor-pointer hover:text-blue-600"
                                            onDoubleClick={(e) => {
                                              e.stopPropagation();
                                              setEditingRow(row.id);
                                            }}
                                            title="Double-click to rename"
                                          >
                                            {row.name}
                                          </span>
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingRow(row.id);
                                            }}
                                            className="text-gray-400 hover:text-blue-600 text-xs p-1 rounded hover:bg-blue-50"
                                            title="Rename row"
                                          >
                                            ‚úèÔ∏è
                                          </button>
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              toggleRowDeadSpace(section.id, row.id);
                                            }}
                                            className={`text-xs p-1 rounded transition-colors ${
                                              row.isDeadSpace 
                                                ? 'bg-gray-500 text-white hover:bg-gray-600' 
                                                : 'text-gray-400 hover:text-gray-600 hover:bg-gray-100'
                                            }`}
                                            title={row.isDeadSpace ? "Mark as active row" : "Mark as dead space"}
                                          >
                                            {row.isDeadSpace ? '‚ùå' : '‚¨ú'}
                                          </button>
                                        </>
                                      )}
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          const newExpanded = new Set(expandedRows);
                                          if (newExpanded.has(row.id)) {
                                            newExpanded.delete(row.id);
                                          } else {
                                            newExpanded.add(row.id);
                                          }
                                          setExpandedRows(newExpanded);
                                        }}
                                        className="text-gray-500 hover:text-gray-700 text-xs p-1 rounded hover:bg-gray-100"
                                        title={isExpanded ? "Collapse" : "Expand"}
                                      >
                                        {isExpanded ? '‚ñº' : '‚ñ∂'}
                                      </button>
                                    </div>
                                  </div>
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      deleteRow(section.id, row.id);
                                    }}
                                    className="text-red-500 hover:text-red-700 text-xs p-1"
                                    title="Delete row"
                                  >
                                    <Icons.Trash2 />
                                  </button>
                                </div>
                                
                                {/* Summary Stats - Compact when collapsed, full grid when expanded */}
                                {row.isDeadSpace ? (
                                  <div className="text-center py-2">
                                    <span className="text-gray-600 font-semibold text-sm">üö´ Dead Space Row (Empty)</span>
                                  </div>
                                ) : isExpanded ? (
                                  <div className="grid grid-cols-4 gap-2 text-xs">
                                    <div className="bg-gray-50 p-2 rounded">
                                      <div className="text-gray-600 text-xs">Products</div>
                                      <div className="font-bold text-gray-800">{rowProducts.length}</div>
                                    </div>
                                    
                                    <div className={`p-2 rounded ${rowTotalSales > 0 ? 'bg-green-50' : 'bg-red-50'}`}>
                                      <div className="text-gray-600 text-xs">Sales</div>
                                      <div className={`font-bold ${rowTotalSales > 0 ? 'text-green-700' : 'text-red-600'}`}>
                                        {rowTotalSales}
                                      </div>
                                    </div>
                                    
                                    <div className="bg-blue-50 p-2 rounded">
                                      <div className="text-gray-600 text-xs">Profit</div>
                                      <div className="font-bold text-blue-700">${rowProfit.toFixed(2)}</div>
                                    </div>
                                    
                                    <div className={`p-2 rounded ${rowDeadStockCount > 0 ? 'bg-orange-50' : 'bg-gray-50'}`}>
                                      <div className="text-gray-600 text-xs">Stock</div>
                                      <div className={`font-bold ${rowDeadStockCount > 0 ? 'text-orange-700' : 'text-gray-700'}`}>
                                        {rowTotalStock}
                                        {rowDeadStockCount > 0 && <span className="text-xs ml-1">‚ö†Ô∏è{rowDeadStockCount}</span>}
                                      </div>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="text-xs text-gray-600">
                                    {rowProducts.length} products ‚Ä¢ ${rowProfit.toFixed(0)} profit ‚Ä¢ {rowTotalSales} sales
                                  </div>
                                )}
                              </div>
                              
                              {/* Expanded Product Details */}
                              {isExpanded && rowProducts.length > 0 && (
                                <div className="mt-2 space-y-2">
                                  {row.products.map((product, pIdx) => {
                                    // Calculate sales based on current time period
                                    let sales = 0;
                                    switch(timePeriod) {
                                      case 'day': sales = product.dailySales || 0; break;
                                      case 'week': sales = product.weeklySales || 0; break;
                                      case 'month': sales = product.monthlySales || 0; break;
                                      case 'quarter': sales = product.quarterlySales || 0; break;
                                      case 'year': sales = product.yearlySales || 0; break;
                                      case 'all': sales = product.allTimeSales || 0; break;
                                      default: sales = product.monthlySales || 0;
                                    }
                                    
                                    // Calculate metrics - handle negative stock properly
                                    const stock = product.inventoryQuantity !== null && product.inventoryQuantity !== undefined 
                                      ? product.inventoryQuantity 
                                      : 0;
                                    const margin = product.price > 0 ? ((product.price - product.cost) / product.price * 100) : 0;
                                    const daysRemaining = sales > 0 ? Math.floor(stock / (sales / 30)) : Infinity;
                                    const isDeadStock = stock > 0 && sales === 0;
                                    const turnoverRate = stock > 0 ? (sales / stock).toFixed(2) : 0;
                                    
                                    // Stock status - handle negative inventory
                                    const stockStatus = stock < 0 ? 'NEGATIVE' : stock === 0 ? 'OUT' : stock < 10 ? 'LOW' : 'OK';
                                    const stockColor = stock < 0 ? 'text-red-600 bg-red-50 font-bold' :
                                                      stock === 0 ? 'text-red-600 bg-red-50' : 
                                                      stock < 10 ? 'text-orange-600 bg-orange-50' : 
                                                      'text-green-600 bg-green-50';
                                    
                                    return (
                                      <div key={pIdx} className="bg-white border-2 border-gray-200 p-3 rounded-lg group hover:border-blue-300 transition-all">
                                        {/* Product Name & Controls */}
                                        <div className="flex items-start justify-between mb-2">
                                          <div className="flex-1">
                                            <div className="font-semibold text-sm text-gray-800">{product.name}</div>
                                            {product.sku && (
                                              <div className="text-xs text-gray-500">SKU: {product.sku}</div>
                                            )}
                                            {product.vendor && (
                                              <div className="text-xs text-gray-500">by {product.vendor}</div>
                                            )}
                                            {product.source === 'placeholder' && (
                                              <div className="mt-2">
                                                <input
                                                  type="text"
                                                  placeholder="Enter product name..."
                                                  value={(() => {
                                                    const found = unknownProducts.find(u => u.upc === product.upc);
                                                    console.log('Looking for UPC:', product.upc, 'Found:', found);
                                                    return found?.note || '';
                                                  })()}
                                                  onChange={(e) => {
                                                    console.log('Typing in note field, UPC:', product.upc, 'Value:', e.target.value);
                                                    const existing = unknownProducts.find(u => u.upc === product.upc);
                                                    console.log('Found unknown product:', existing);
                                                    if (existing) {
                                                      updateUnknownProductNote(existing.id, e.target.value);
                                                    } else {
                                                      console.error('Unknown product not found in array!');
                                                      // Create it if it doesn't exist
                                                      setUnknownProducts(prev => [...prev, {
                                                        id: Date.now(),
                                                        upc: product.upc,
                                                        note: e.target.value,
                                                        addedAt: new Date().toISOString(),
                                                        resolved: false
                                                      }]);
                                                    }
                                                  }}
                                                  onKeyPress={(e) => {
                                                    if (e.key === 'Enter') {
                                                      e.preventDefault();
                                                      console.log('Enter pressed - saving immediately!');
                                                      saveToFirebase(sections);
                                                      setFeedback('üíæ Saved!');
                                                      setTimeout(() => setFeedback(''), 2000);
                                                    }
                                                  }}
                                                  onClick={(e) => e.stopPropagation()}
                                                  className="w-full px-2 py-1 text-xs border border-yellow-400 rounded bg-yellow-50 focus:outline-none focus:ring-1 focus:ring-yellow-500"
                                                />
                                              </div>
                                            )}
                                          </div>
                                          
                                          {/* Action Buttons */}
                                          <div className="flex gap-1 ml-2">
                                            {/* Move Up */}
                                            {pIdx > 0 && (
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  const updatedSections = sections.map(s => {
                                                    if (s.id === section.id) {
                                                      const updatedRows = s.rows.map(r => {
                                                        if (r.id === row.id) {
                                                          const newProducts = [...r.products];
                                                          [newProducts[pIdx - 1], newProducts[pIdx]] = [newProducts[pIdx], newProducts[pIdx - 1]];
                                                          return { ...r, products: newProducts };
                                                        }
                                                        return r;
                                                      });
                                                      return { ...s, rows: updatedRows };
                                                    }
                                                    return s;
                                                  });
                                                  setSections(updatedSections);
                                                  autoSave(updatedSections, 'Reordered product');
                                                  setFeedback('‚Üë Moved up');
                                                  setTimeout(() => setFeedback(''), 1000);
                                                }}
                                                className="opacity-0 group-hover:opacity-100 text-blue-500 hover:text-blue-700 p-1"
                                                title="Move up"
                                              >
                                                ‚Üë
                                              </button>
                                            )}
                                            
                                            {/* Move Down */}
                                            {pIdx < row.products.length - 1 && (
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  const updatedSections = sections.map(s => {
                                                    if (s.id === section.id) {
                                                      const updatedRows = s.rows.map(r => {
                                                        if (r.id === row.id) {
                                                          const newProducts = [...r.products];
                                                          [newProducts[pIdx], newProducts[pIdx + 1]] = [newProducts[pIdx + 1], newProducts[pIdx]];
                                                          return { ...r, products: newProducts };
                                                        }
                                                        return r;
                                                      });
                                                      return { ...s, rows: updatedRows };
                                                    }
                                                    return s;
                                                  });
                                                  setSections(updatedSections);
                                                  autoSave(updatedSections, 'Reordered product');
                                                  setFeedback('‚Üì Moved down');
                                                  setTimeout(() => setFeedback(''), 1000);
                                                }}
                                                className="opacity-0 group-hover:opacity-100 text-blue-500 hover:text-blue-700 p-1"
                                                title="Move down"
                                              >
                                                ‚Üì
                                              </button>
                                            )}
                                            
                                            {/* Delete */}
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                const updatedSections = sections.map(s => {
                                                  if (s.id === section.id) {
                                                    const updatedRows = s.rows.map(r => {
                                                      if (r.id === row.id) {
                                                        return {
                                                          ...r,
                                                          products: r.products.filter((_, idx) => idx !== pIdx)
                                                        };
                                                      }
                                                      return r;
                                                    });
                                                    return { ...s, rows: updatedRows };
                                                  }
                                                  return s;
                                                });
                                                setSections(updatedSections);
                                                autoSave(updatedSections, 'Deleted product');
                                                setFeedback('üóëÔ∏è Product removed');
                                                setTimeout(() => setFeedback(''), 2000);
                                              }}
                                              className="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 p-1"
                                              title="Delete product"
                                            >
                                              <Icons.X />
                                            </button>
                                          </div>
                                        </div>

                                        {/* Key Metrics Grid */}
                                        <div className="grid grid-cols-3 gap-2 text-xs mb-2">
                                          {/* Sales */}
                                          <div className={`p-2 rounded ${sales > 0 ? 'bg-green-50' : 'bg-red-50'}`}>
                                            <div className="text-gray-600 text-xs">Sales</div>
                                            <div className={`font-bold ${sales > 0 ? 'text-green-700' : 'text-red-600'}`}>
                                              {sales} sold
                                            </div>
                                          </div>

                                          {/* Stock */}
                                          <div className={`p-2 rounded ${stockColor}`}>
                                            <div className="text-gray-600 text-xs">Stock</div>
                                            <div className="font-bold">
                                              {stock} {stockStatus}
                                            </div>
                                            {daysRemaining !== Infinity && daysRemaining < 30 && (
                                              <div className="text-xs">{daysRemaining}d left</div>
                                            )}
                                          </div>

                                          {/* Margin */}
                                          <div className="p-2 rounded bg-blue-50">
                                            <div className="text-gray-600 text-xs">Margin</div>
                                            <div className="font-bold text-blue-700">
                                              {margin.toFixed(0)}%
                                            </div>
                                            <div className="text-xs text-gray-600">${((product.price - product.cost) * sales).toFixed(2)}</div>
                                          </div>
                                        </div>

                                        {/* Warnings & Alerts */}
                                        {isDeadStock && (
                                          <div className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded mb-1 font-semibold">
                                            ‚ö†Ô∏è DEAD STOCK: {stock} units, 0 sales!
                                          </div>
                                        )}
                                        {!isDeadStock && stock > 0 && daysRemaining < 7 && (
                                          <div className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mb-1">
                                            ‚è∞ Running low: {daysRemaining} days left
                                          </div>
                                        )}

                                        {/* Price & Turnover */}
                                        <div className="flex justify-between text-xs text-gray-600 mt-2 pt-2 border-t">
                                          <span>${product.price.toFixed(2)}</span>
                                          {stock > 0 && (
                                            <span title="Inventory turnover rate">Turnover: {turnoverRate}√ó</span>
                                          )}
                                        </div>

                                        {/* Tags */}
                                        {product.tags && (
                                          <div className="mt-2 flex flex-wrap gap-1">
                                            {product.tags.split(',').slice(0, 3).map((tag, idx) => (
                                              <span key={idx} className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">
                                                {tag.trim()}
                                              </span>
                                            ))}
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      )}
                    </div>

                    <div className="space-y-2 mb-3 border-t pt-3">
                      {/* üî• STICKY ROW MODE CONTROLS */}
                      <div className="space-y-2 mb-3">
                        {/* Sticky Mode Toggle */}
                        <div className="flex items-center justify-between p-2 bg-gradient-to-r from-blue-50 to-purple-50 rounded border border-blue-200">
                          <div className="flex items-center gap-2">
                            <span className="text-sm font-semibold">üîí Sticky Row Mode</span>
                            <button
                              onClick={() => setStickyRowMode(!stickyRowMode)}
                              className={`px-3 py-1 rounded text-xs font-bold transition-all ${
                                stickyRowMode 
                                  ? 'bg-green-500 text-white' 
                                  : 'bg-gray-300 text-gray-600'
                              }`}
                            >
                              {stickyRowMode ? 'ON' : 'OFF'}
                            </button>
                          </div>
                          {stickyRowMode && newProduct.rowId && selectedSection === section.id && (
                            <span className="text-xs text-green-600 font-semibold">
                              ‚úì Row locked
                            </span>
                          )}
                        </div>

                        {/* Current Row Indicator */}
                        {newProduct.rowId && selectedSection === section.id && (
                          <div className="p-3 bg-yellow-50 border-2 border-yellow-300 rounded">
                            <div className="text-xs text-gray-600 mb-1">Scanning into:</div>
                            <div className="text-lg font-bold text-yellow-800">
                              {(() => {
                                const row = section.rows?.find(r => r.id === newProduct.rowId);
                                return row ? `${section.name} - ${row.name}` : 'Unknown Row';
                              })()}
                            </div>
                            {stickyRowMode && (
                              <div className="text-xs text-yellow-600 mt-1">
                                Keep scanning! Row stays selected. Use Ctrl+‚Üë/‚Üì to switch rows.
                              </div>
                            )}
                          </div>
                        )}
                      </div>

                      <input
                        ref={selectedSection === section.id ? upcInputRef : null}
                        type="text"
                        placeholder="Scan or enter UPC (select a row first)"
                        value={selectedSection === section.id ? newProduct.upc : ''}
                        onChange={(e) => {
                          setSelectedSection(section.id);
                          setNewProduct({ ...newProduct, upc: e.target.value, sectionId: section.id });
                        }}
                        className="w-full px-3 py-2 border rounded text-sm"
                        onKeyPress={(e) => {
                          console.log('üîç Key pressed:', e.key);
                          console.log('üîç newProduct.upc:', newProduct.upc);
                          console.log('üîç newProduct.rowId:', newProduct.rowId);
                          console.log('üîç newProduct.sectionId:', newProduct.sectionId);
                          console.log('üîç selectedSection:', selectedSection);
                          console.log('üîç section.id:', section.id);
                          
                          if (e.key === 'Enter') {
                            console.log('üîç ENTER PRESSED!');
                            if (newProduct.upc && newProduct.rowId) {
                              console.log('üîç Calling addProductToSection()');
                              addProductToSection();
                            } else {
                              console.log('‚ùå Missing UPC or rowId - UPC:', newProduct.upc, 'rowId:', newProduct.rowId);
                            }
                          }
                        }}
                      />
                      {(!newProduct.rowId || !stickyRowMode) && (
                        <button
                          onClick={() => {
                            if (!newProduct.rowId) {
                              setFeedback('‚ö†Ô∏è Select a row first');
                              setTimeout(() => setFeedback(''), 2000);
                              return;
                            }
                            addProductToSection();
                          }}
                          disabled={scanning || !newProduct.upc || !newProduct.rowId}
                          className="w-full px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 text-sm"
                        >
                          {scanning ? 'Adding...' : newProduct.rowId ? 'Add Product to Row' : 'Select Row First'}
                        </button>
                      )}
                    </div>

                    <div className="space-y-2">
                      {section.products.map((product, idx) => (
                        <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                          <div className="flex-1">
                            <div className="font-medium">{product.name}</div>
                            <div className="text-xs text-gray-600">
                              ${product.price} | Qty: {product.quantity}
                            </div>
                          </div>
                          
                          <div className="flex gap-1">
                            <button
                              onClick={() => updateProductQuantity(section.id, idx, -1)}
                              className="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300"
                            >
                              -
                            </button>
                            <button
                              onClick={() => updateProductQuantity(section.id, idx, 1)}
                              className="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300"
                            >
                              +
                            </button>
                            
                            <button
                              onClick={() => deleteProduct(section.id, idx)}
                              className="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                              title="Delete"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                      </>
                    )}
                  </div>
                );
              })}
          </div>
        </div>
      )}

      {showSettings && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h2 className="text-2xl font-bold mb-4">üõçÔ∏è Shopify Connection</h2>

            {shopifyConfig.connected && (
              <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm">
                <div className="font-semibold mb-2">üí° Two Refresh Options:</div>
                <div className="space-y-2 text-xs text-gray-700">
                  <div className="p-2 bg-white rounded border border-blue-200">
                    <div className="font-semibold text-blue-700">üîÑ Refresh Product Cache</div>
                    <div>‚Ä¢ Updates the backend database with ALL products from Shopify</div>
                    <div>‚Ä¢ Takes 3-5 minutes for large catalogs</div>
                    <div>‚Ä¢ Run this FIRST if you just deployed backend updates</div>
                    <div>‚Ä¢ Watch progress in Render logs</div>
                  </div>
                  <div className="p-2 bg-white rounded border border-green-200">
                    <div className="font-semibold text-green-700">üîÑ Update My Products</div>
                    <div>‚Ä¢ Updates products in YOUR planogram with latest data</div>
                    <div>‚Ä¢ Adds vendor/brand info to existing products</div>
                    <div>‚Ä¢ Takes ~1 minute (only updates what's in your fixtures)</div>
                    <div>‚Ä¢ <strong>Keeps all your layout work!</strong></div>
                  </div>
                </div>
              </div>
            )}

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Store Name</label>
                <input
                  type="text"
                  value={shopifyConfig.storeName}
                  onChange={(e) => setShopifyConfig({ ...shopifyConfig, storeName: e.target.value })}
                  placeholder="your-store.myshopify.com"
                  className="w-full px-3 py-2 border rounded"
                  disabled={shopifyConfig.connected}
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Admin API Access Token</label>
                <input
                  type="password"
                  value={shopifyConfig.accessToken}
                  onChange={(e) => setShopifyConfig({ ...shopifyConfig, accessToken: e.target.value })}
                  placeholder="shpat_xxxxx..."
                  className="w-full px-3 py-2 border rounded"
                  disabled={shopifyConfig.connected}
                />
              </div>

              <div className="flex gap-2">
                {!shopifyConfig.connected ? (
                  <button
                    onClick={testShopifyConnection}
                    className="flex-1 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                  >
                    Test Connection
                  </button>
                ) : (
                  <>
                    <button
                      onClick={refreshProductCache}
                      disabled={isRefreshing}
                      className={`flex-1 px-4 py-2 rounded flex items-center justify-center gap-2 ${
                        isRefreshing 
                          ? 'bg-gray-400 cursor-not-allowed' 
                          : 'bg-blue-500 hover:bg-blue-600'
                      } text-white`}
                    >
                      <Icons.RefreshCw />
                      {isRefreshing ? 'Refreshing... (Check Render Logs)' : 'Refresh Product Cache'}
                    </button>
                    <button
                      onClick={refreshAllProductData}
                      disabled={isRefreshing}
                      className={`flex-1 px-4 py-2 rounded flex items-center justify-center gap-2 ${
                        isRefreshing 
                          ? 'bg-gray-400 cursor-not-allowed' 
                          : 'bg-green-500 hover:bg-green-600'
                      } text-white`}
                    >
                      <Icons.RefreshCw />
                      {isRefreshing ? 'Updating...' : 'Update My Products'}
                    </button>
                    <button
                      onClick={disconnectShopify}
                      disabled={isRefreshing}
                      className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Disconnect
                    </button>
                  </>
                )}
              </div>

              {shopifyConfig.connected && (
                <div className="p-3 bg-green-100 text-green-800 rounded">
                  ‚úÖ Connected
                </div>
              )}
            </div>

            <button
              onClick={() => setShowSettings(false)}
              className="mt-4 w-full px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Save Layout Modal */}
      {showSaveModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowSaveModal(false)}>
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onClick={(e) => e.stopPropagation()}>
            <h2 className="text-2xl font-bold mb-4">üíæ Save Current Layout</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2">Layout Name</label>
                <input
                  id="modal-layout-name"
                  type="text"
                  placeholder="e.g., 'Holiday 2025', 'Summer Refresh'"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                  autoFocus
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      const name = e.target.value.trim();
                      const desc = document.getElementById('modal-layout-desc')?.value?.trim() || '';
                      if (name) {
                        saveCurrentLayout(name, desc);
                        setShowSaveModal(false);
                      }
                    }
                  }}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2">Description (optional)</label>
                <textarea
                  id="modal-layout-desc"
                  placeholder="Add notes about this layout..."
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                  rows="3"
                ></textarea>
              </div>
              <div className="bg-blue-50 p-4 rounded-lg">
                <div className="text-sm font-semibold mb-2">Current Layout Stats:</div>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <span className="text-gray-600">Products:</span>
                    <span className="font-bold ml-2">
                      {sections.reduce((sum, s) => sum + (s.rows?.reduce((rs, r) => rs + (r.products?.reduce((ps, p) => ps + (p.quantity || 1), 0) || 0), 0) || 0), 0)}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-600">Revenue:</span>
                    <span className="font-bold ml-2 text-green-600">
                      ${sections.reduce((sum, s) => sum + (s.rows?.reduce((rs, r) => rs + (r.products?.reduce((ps, p) => ps + ((p.quantity || 1) * (p.price || 0)), 0) || 0), 0) || 0), 0).toFixed(2)}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-600">Area:</span>
                    <span className="font-bold ml-2">
                      {(sections.reduce((sum, s) => sum + ((s.dimensions?.width || 0) * (s.dimensions?.depth || 0)), 0) / 144).toFixed(1)} sq ft
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-600">$/Sq Ft:</span>
                    <span className="font-bold ml-2 text-purple-600">
                      ${(() => {
                        const totalArea = sections.reduce((sum, s) => sum + ((s.dimensions?.width || 0) * (s.dimensions?.depth || 0)), 0) / 144;
                        const totalRevenue = sections.reduce((sum, s) => sum + (s.rows?.reduce((rs, r) => rs + (r.products?.reduce((ps, p) => ps + ((p.quantity || 1) * (p.price || 0)), 0) || 0), 0) || 0), 0);
                        return totalArea > 0 ? (totalRevenue / totalArea).toFixed(2) : '0.00';
                      })()}
                    </span>
                  </div>
                </div>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    const name = document.getElementById('modal-layout-name')?.value?.trim() || '';
                    const desc = document.getElementById('modal-layout-desc')?.value?.trim() || '';
                    if (name) {
                      saveCurrentLayout(name, desc);
                      setShowSaveModal(false);
                    } else {
                      setFeedback('‚ö†Ô∏è Please enter a layout name');
                      setTimeout(() => setFeedback(''), 2000);
                    }
                  }}
                  className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
                >
                  üíæ Save Layout
                </button>
                <button
                  onClick={() => setShowSaveModal(false)}
                  className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
    </>
    )}

      {/* üìä DASHBOARD PAGE */}
      {currentPage === 'dashboard' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-3xl font-bold">üìä Store Analytics Dashboard</h1>
              <p className="text-gray-600 mt-1">Real-time insights from your planogram data</p>
            </div>
            
            {/* Time Period Filter */}
            <div className="bg-white rounded-lg shadow-lg px-4 py-3 flex items-center gap-3">
              <span className="text-sm font-semibold text-gray-700">üìÖ Period:</span>
              <select
                value={timePeriod}
                onChange={(e) => setTimePeriod(e.target.value)}
                className="px-3 py-2 bg-white border-2 border-blue-300 rounded text-sm font-medium hover:border-blue-500 focus:outline-none focus:border-blue-600 cursor-pointer"
              >
                <option value="day">üìÖ Daily</option>
                <option value="week">üìÖ Weekly</option>
                <option value="month">üìÖ Monthly</option>
                <option value="quarter">üìÖ Quarterly</option>
                <option value="year">üìÖ Yearly</option>
                <option value="all">üìÖ All Time</option>
                <option value="custom">üìÖ Custom Range</option>
              </select>
              
              {/* Custom Date Range Picker */}
              {timePeriod === 'custom' && (
                <div className="flex items-center gap-2 ml-2">
                  <input
                    type="date"
                    value={customStartDate}
                    onChange={(e) => setCustomStartDate(e.target.value)}
                    className="px-3 py-2 border-2 border-blue-300 rounded text-sm focus:outline-none focus:border-blue-600"
                  />
                  <span className="text-gray-600">to</span>
                  <input
                    type="date"
                    value={customEndDate}
                    onChange={(e) => setCustomEndDate(e.target.value)}
                    className="px-3 py-2 border-2 border-blue-300 rounded text-sm focus:outline-none focus:border-blue-600"
                  />
                </div>
              )}
            </div>
          </div>
          
          {/* Quick Stats Row */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">üí∞ Total Revenue</div>
              <div className="text-3xl font-bold">
                ${sections.reduce((sum, s) => {
                  const metrics = calculateMetrics(s, timePeriod);
                  return sum + metrics.totalRevenue;
                }, 0).toFixed(2)}
              </div>
              <div className="text-xs opacity-75 mt-2">
                {timePeriod === 'day' ? 'Today' : 
                 timePeriod === 'week' ? 'This Week' :
                 timePeriod === 'month' ? 'This Month' :
                 timePeriod === 'quarter' ? 'This Quarter' :
                 timePeriod === 'year' ? 'This Year' : 'All Time'}
              </div>
            </div>
            
            <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">üì¶ Units Sold</div>
              <div className="text-3xl font-bold">
                {sections.reduce((sum, s) => {
                  const metrics = calculateMetrics(s, timePeriod);
                  return sum + metrics.totalVolume;
                }, 0).toFixed(0)}
              </div>
              <div className="text-xs opacity-75 mt-2">Total items</div>
            </div>
            
            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">üíé Profit</div>
              <div className="text-3xl font-bold">
                ${sections.reduce((sum, s) => {
                  const metrics = calculateMetrics(s, timePeriod);
                  return sum + metrics.totalProfit;
                }, 0).toFixed(2)}
              </div>
              <div className="text-xs opacity-75 mt-2">Total margin</div>
            </div>
            
            <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white">
              <div className="text-sm opacity-90 mb-1">üèÜ Best Product</div>
              <div className="text-base font-bold truncate">
                {(() => {
                  let bestProduct = null;
                  let maxRevenue = 0;
                  sections.forEach(s => {
                    const metrics = calculateMetrics(s, timePeriod);
                    metrics.productMetrics.forEach(p => {
                      if (p.periodRevenue > maxRevenue) {
                        maxRevenue = p.periodRevenue;
                        bestProduct = p;
                      }
                    });
                  });
                  return bestProduct ? (
                    <>
                      <div className="truncate">{bestProduct.name.substring(0, 25)}{bestProduct.name.length > 25 ? '...' : ''}</div>
                      <div className="text-xs opacity-75 font-normal mt-1">
                        {bestProduct.sku ? `SKU: ${bestProduct.sku}` : bestProduct.upc ? `UPC: ${bestProduct.upc}` : 'No SKU/UPC'}
                      </div>
                    </>
                  ) : 'N/A';
                })()}
              </div>
              <div className="text-xs opacity-75 mt-2">Top revenue generator</div>
            </div>
          </div>

          {/* Main Analytics Grid */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            {/* üìä Space Utilization */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                üìä Space Utilization
                <span className="text-sm font-normal text-gray-500">(fixture efficiency)</span>
              </h2>
              <div className="space-y-3">
                {(fixtures || []).map(fixture => {
                  const fixtureSections = sections.filter(s => s.fixtureId === fixture.id);
                  const fixtureArea = (fixture.width * fixture.height) / 144; // Convert to sq ft
                  const usedArea = fixtureSections.reduce((sum, s) => {
                    return sum + ((s.length || 48) * (s.depth || 12)) / 144;
                  }, 0);
                  const utilization = fixtureArea > 0 ? (usedArea / fixtureArea) * 100 : 0;
                  const deadSpaceCount = fixtureSections.filter(s => s.type === 'deadspace').length;
                  const regularCount = fixtureSections.filter(s => s.type !== 'deadspace').length;
                  
                  return (
                    <div key={fixture.id} className="p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                        <div className="font-semibold">{fixture.name}</div>
                        <div className={`font-bold text-lg ${utilization > 80 ? 'text-green-600' : utilization > 50 ? 'text-yellow-600' : 'text-red-600'}`}>
                          {utilization.toFixed(1)}%
                        </div>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                        <div 
                          className={`h-3 rounded-full ${utilization > 80 ? 'bg-green-500' : utilization > 50 ? 'bg-yellow-500' : 'bg-red-500'}`}
                          style={{ width: `${Math.min(100, utilization)}%` }}
                        ></div>
                      </div>
                      <div className="text-xs text-gray-600 flex justify-between">
                        <span>{regularCount} sections ‚Ä¢ {deadSpaceCount} dead space</span>
                        <span>{usedArea.toFixed(1)} / {fixtureArea.toFixed(1)} sq ft</span>
                      </div>
                      {/* Row Utilization for this fixture */}
                      {(() => {
                        const totalRows = fixtureSections.reduce((sum, s) => sum + (s.rows?.length || 0), 0);
                        const deadRows = fixtureSections.reduce((sum, s) => {
                          return sum + (s.rows?.filter(r => r.isDeadSpace).length || 0);
                        }, 0);
                        const activeRows = totalRows - deadRows;
                        const rowUtilization = totalRows > 0 ? (activeRows / totalRows) * 100 : 100;
                        
                        if (totalRows > 0) {
                          return (
                            <div className="mt-2 pt-2 border-t border-gray-300">
                              <div className="flex items-center justify-between text-xs">
                                <span className="text-gray-600">Row Utilization:</span>
                                <span className={`font-semibold ${rowUtilization > 80 ? 'text-green-600' : rowUtilization > 50 ? 'text-yellow-600' : 'text-red-600'}`}>
                                  {rowUtilization.toFixed(0)}%
                                </span>
                              </div>
                              <div className="text-xs text-gray-500 mt-1">
                                {activeRows} active ‚Ä¢ {deadRows} dead ({totalRows} total rows)
                              </div>
                            </div>
                          );
                        }
                        return null;
                      })()}
                    </div>
                  );
                })}
                {fixtures.length === 0 && (
                  <div className="text-gray-400 text-center py-8">No fixtures added yet</div>
                )}
              </div>
            </div>

            {/* üèÜ Fixture Performance Ranking */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                üèÜ Fixture Performance
                <span className="text-sm font-normal text-gray-500">(by profit)</span>
              </h2>
              <div className="space-y-3">
                {(fixtures || []).map(fixture => {
                  const fixtureSections = sections.filter(s => s.fixtureId === fixture.id);
                  const totalProfit = fixtureSections.reduce((sum, s) => {
                    const metrics = calculateMetrics(s, timePeriod);
                    return sum + metrics.totalProfit;
                  }, 0);
                  const totalRevenue = fixtureSections.reduce((sum, s) => {
                    const metrics = calculateMetrics(s, timePeriod);
                    return sum + metrics.totalRevenue;
                  }, 0);
                  return { fixture, totalProfit, totalRevenue };
                }).sort((a, b) => b.totalProfit - a.totalProfit).map(({ fixture, totalProfit, totalRevenue }, idx) => (
                  <div key={fixture.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div className="flex items-center gap-3">
                      <div className={`text-2xl ${idx === 0 ? '' : idx === 1 ? '' : idx === 2 ? '' : ''}`}>
                        {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`}
                      </div>
                      <div>
                        <div className="font-semibold">{fixture.name}</div>
                        <div className="text-xs text-gray-500">Revenue: ${totalRevenue.toFixed(2)}</div>
                      </div>
                    </div>
                    <div className={`font-bold text-lg ${totalProfit > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                      ${totalProfit.toFixed(2)}
                    </div>
                  </div>
                ))}
                {fixtures.length === 0 && (
                  <div className="text-gray-400 text-center py-8">No fixtures added yet</div>
                )}
              </div>
            </div>

            {/* üî• Section Performance */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                üî• Top Sections
                <span className="text-sm font-normal text-gray-500">(by revenue)</span>
              </h2>
              <div className="space-y-3">
                {(sections || []).map(section => {
                  const metrics = calculateMetrics(section, timePeriod);
                  return { section, metrics };
                }).sort((a, b) => b.metrics.totalRevenue - a.metrics.totalRevenue).slice(0, 10).map(({ section, metrics }, idx) => (
                  <div key={section.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div className="flex items-center gap-3">
                      <div className="text-lg font-bold text-gray-400">#{idx + 1}</div>
                      <div>
                        <div className="font-semibold">{section.name}</div>
                        <div className="text-xs text-gray-500">
                          {section.rows ? section.rows.reduce((sum, row) => sum + (row.products?.length || 0), 0) : section.products?.length || 0} products ‚Ä¢ ${metrics.profitPerSqFt.toFixed(2)}/sq ft
                        </div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold text-green-600">${metrics.totalRevenue.toFixed(2)}</div>
                      <div className="text-xs text-gray-500">{metrics.totalVolume} units</div>
                    </div>
                  </div>
                ))}
                {sections.length === 0 && (
                  <div className="text-gray-400 text-center py-8">No sections added yet</div>
                )}
              </div>
            </div>

            {/* üö® Out of Stock Hot Products - RESTOCK ASAP */}
            <div className="bg-gradient-to-br from-red-50 to-orange-50 rounded-lg shadow-lg p-6 border-2 border-red-300">
              <h2 className="text-xl font-bold mb-2 flex items-center gap-2 text-red-700">
                üö® Out of Stock Hot Products
                <span className="text-sm font-normal text-gray-600">(restock ASAP!)</span>
              </h2>
              <p className="text-sm text-gray-600 mb-4">
                Products with <strong>low/zero stock</strong> that have strong sales history - prioritize restocking!
              </p>
              
              {(() => {
                // Use same data source as Forecasting tab - allDatabaseProducts with velocity
                if (!allDatabaseProducts || allDatabaseProducts.length === 0) {
                  return (
                    <div className="text-center py-8 bg-white rounded-lg">
                      <div className="text-4xl mb-3">üìä</div>
                      <div className="font-bold text-lg text-gray-700 mb-2">Load Product Data First</div>
                      <div className="text-sm text-gray-600 mb-4">
                        Click the button below to load all products from Shopify and see hot products analysis.
                      </div>
                      <button
                        onClick={loadAllProductsFromDatabase}
                        disabled={loadingAllProducts || !shopifyConfig.connected}
                        className="px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg hover:from-red-700 hover:to-red-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 mx-auto text-base font-semibold shadow-lg"
                      >
                        {loadingAllProducts ? (
                          <>
                            <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                            Loading...
                          </>
                        ) : (
                          <>
                            <Icons.Download />
                            Load All Products ({allDatabaseProducts.length > 0 ? `${allDatabaseProducts.length} loaded` : 'from Shopify'})
                          </>
                        )}
                      </button>
                    </div>
                  );
                }
                
                // Calculate velocity and filter for critical products (same logic as Forecasting)
                const criticalProducts = allDatabaseProducts
                  .map(p => {
                    const currentStock = p.stock !== null && p.stock !== undefined ? p.stock : 0;
                    
                    // Calculate daily velocity - prefer longer periods for low stock items
                    let salesVolume = 0;
                    let daysInPeriod = 30;
                    
                    if (currentStock <= 5) {
                      // Low stock - use all-time for better accuracy
                      if (p.allTimeSales && p.allTimeSales > 0) {
                        salesVolume = p.allTimeSales;
                        daysInPeriod = 180; // Assume 6 months history
                      } else if (p.monthlySales && p.monthlySales > 0) {
                        salesVolume = p.monthlySales;
                        daysInPeriod = 30;
                      }
                    } else {
                      // Normal stock - use monthly
                      salesVolume = p.monthlySales || 0;
                      daysInPeriod = 30;
                    }
                    
                    const dailyVelocity = daysInPeriod > 0 ? salesVolume / daysInPeriod : 0;
                    const daysUntilOut = dailyVelocity > 0 ? currentStock / dailyVelocity : (currentStock > 0 ? 999 : 0);
                    
                    return {
                      name: p.variantTitle ? `${p.title} - ${p.variantTitle}` : p.title,
                      upc: p.barcode,
                      vendor: p.vendor,
                      stock: currentStock,
                      dailyVelocity: dailyVelocity,
                      daysUntilOut: daysUntilOut,
                      monthlySales: p.monthlySales || 0,
                      allTimeSales: p.allTimeSales || 0,
                      revenuePerDay: dailyVelocity * (p.price || 0)
                    };
                  })
                  // Filter: must have velocity AND (out of stock OR critically low)
                  .filter(p => p.dailyVelocity > 0 && (p.stock === 0 || p.daysUntilOut < 7))
                  // Sort by velocity (highest sellers first)
                  .sort((a, b) => b.dailyVelocity - a.dailyVelocity)
                  .slice(0, 20); // Top 20
                
                if (criticalProducts.length === 0) {
                  return (
                    <div className="text-center py-8 bg-white rounded-lg">
                      <div className="text-4xl mb-3">‚úÖ</div>
                      <div className="font-bold text-lg text-green-700 mb-2">All Hot Products In Stock!</div>
                      <div className="text-sm text-gray-600">
                        Your best-selling products are all stocked. Keep it up! üéâ
                      </div>
                    </div>
                  );
                }
                
                return (
                  <div className="space-y-3 max-h-[800px] overflow-y-auto pr-2">
                    {criticalProducts.map((product, idx) => {
                      const isOutOfStock = product.stock === 0;
                      const urgency = idx < 5 ? 'CRITICAL' : idx < 10 ? 'HIGH' : 'MEDIUM';
                      const urgencyColor = urgency === 'CRITICAL' ? 'from-red-600 to-red-700' : 
                                          urgency === 'HIGH' ? 'from-orange-500 to-orange-600' : 
                                          'from-yellow-500 to-yellow-600';
                      const urgencyBg = urgency === 'CRITICAL' ? 'bg-red-100 border-red-300' : 
                                       urgency === 'HIGH' ? 'bg-orange-100 border-orange-300' : 
                                       'bg-yellow-100 border-yellow-300';
                      
                      return (
                        <div key={idx} 
                             className={`p-4 ${urgencyBg} rounded-lg border-2 hover:shadow-lg transition-all`}>
                          <div className="flex items-start gap-3">
                            {/* Urgency Badge */}
                            <div className={`px-3 py-1 bg-gradient-to-r ${urgencyColor} text-white rounded-full text-xs font-bold shrink-0`}>
                              #{idx + 1} {urgency}
                            </div>
                            
                            {/* Product Info */}
                            <div className="flex-1 min-w-0">
                              <div className="font-bold text-gray-900">{product.name}</div>
                              <div className="text-xs text-gray-500 mt-1">
                                {product.upc && <span className="mr-3">UPC: {product.upc}</span>}
                                {product.vendor && <span className="mr-2">‚Ä¢ {product.vendor}</span>}
                              </div>
                              
                              {/* Stock Status */}
                              <div className="mt-2 flex items-center gap-2">
                                {isOutOfStock ? (
                                  <span className="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">
                                    ‚ö†Ô∏è OUT OF STOCK
                                  </span>
                                ) : (
                                  <span className="px-2 py-1 bg-orange-600 text-white text-xs font-bold rounded">
                                    ‚ö° LOW STOCK: {product.stock} units
                                  </span>
                                )}
                                {product.daysUntilOut < 7 && product.daysUntilOut > 0 && (
                                  <span className="px-2 py-1 bg-yellow-600 text-white text-xs font-bold rounded">
                                    üìÖ {Math.round(product.daysUntilOut)} days left
                                  </span>
                                )}
                              </div>
                              
                              {/* Sales Performance */}
                              <div className="mt-2 grid grid-cols-4 gap-2">
                                <div className="bg-white/80 rounded px-2 py-1">
                                  <div className="text-xs text-gray-500">Velocity</div>
                                  <div className="font-bold text-blue-600">{product.dailyVelocity.toFixed(1)}/day</div>
                                </div>
                                <div className="bg-white/80 rounded px-2 py-1">
                                  <div className="text-xs text-gray-500">Monthly</div>
                                  <div className="font-bold text-green-600">{product.monthlySales}</div>
                                </div>
                                <div className="bg-white/80 rounded px-2 py-1">
                                  <div className="text-xs text-gray-500">All-Time</div>
                                  <div className="font-bold text-purple-600">{product.allTimeSales}</div>
                                </div>
                                <div className="bg-white/80 rounded px-2 py-1">
                                  <div className="text-xs text-gray-500">$/Day</div>
                                  <div className="font-bold text-red-600">${product.revenuePerDay.toFixed(0)}</div>
                                </div>
                              </div>
                              
                              {/* Action Item */}
                              <div className="mt-2 p-2 bg-white rounded flex items-center gap-2">
                                <span className="text-lg">üí°</span>
                                <span className="text-xs font-semibold text-gray-700">
                                  {isOutOfStock 
                                    ? `Losing ~$${product.revenuePerDay.toFixed(0)}/day while out of stock!`
                                    : `Restock ASAP - only ${Math.round(product.daysUntilOut)} days of inventory left!`
                                  }
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                );
              })()}
              
              {/* Summary Stats */}
              {(() => {
                const allProducts = [];
                sections.forEach(section => {
                  const metrics = calculateMetrics(section, timePeriod);
                  if (section.rows) {
                    section.rows.forEach(row => {
                      if (row.products) {
                        row.products.forEach(product => {
                          const productMetric = metrics.productMetrics.find(pm => pm.upc === product.upc || pm.sku === product.sku);
                          if (productMetric) {
                            allProducts.push({ ...product, periodRevenue: productMetric.periodRevenue, periodProfit: productMetric.periodProfit });
                          }
                        });
                      }
                    });
                  }
                  if (section.products) {
                    section.products.forEach(product => {
                      const productMetric = metrics.productMetrics.find(pm => pm.upc === product.upc || pm.sku === product.sku);
                      if (productMetric) {
                        allProducts.push({ ...product, periodRevenue: productMetric.periodRevenue, periodProfit: productMetric.periodProfit });
                      }
                    });
                  }
                });
                
                const outOfStockProducts = allProducts.filter(p => (p.quantity || 0) === 0 && (p.periodRevenue || 0) > 0);
                const totalLostRevenue = outOfStockProducts.reduce((sum, p) => sum + (p.periodRevenue || 0), 0);
                const totalLostProfit = outOfStockProducts.reduce((sum, p) => sum + (p.periodProfit || 0), 0);
                
                if (outOfStockProducts.length > 0) {
                  return (
                    <div className="mt-4 pt-4 border-t-2 border-red-300 grid grid-cols-3 gap-3">
                      <div className="bg-white rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-red-600">{outOfStockProducts.length}</div>
                        <div className="text-xs text-gray-600 mt-1">Products Out of Stock</div>
                      </div>
                      <div className="bg-white rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-orange-600">${totalLostRevenue.toFixed(2)}</div>
                        <div className="text-xs text-gray-600 mt-1">Revenue at Risk</div>
                      </div>
                      <div className="bg-white rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-green-600">${totalLostProfit.toFixed(2)}</div>
                        <div className="text-xs text-gray-600 mt-1">Profit at Risk</div>
                      </div>
                    </div>
                  );
                }
                return null;
              })()}
            </div>

            {/* ü§ù Best Upsell Combinations */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-2">ü§ù Best Upsell Combinations</h2>
              <p className="text-sm text-gray-500 mb-4">Products actually bought together (from order data)</p>
              
              {(() => {
                // Get all unique fixtures from planogram - with safety check
                const allFixtures = fixtures && Array.isArray(fixtures) 
                  ? Array.from(new Set(
                      fixtures.flatMap(f => f.shelves ? f.shelves.map(s => s.name) : [])
                    )).sort()
                  : [];
                
                // Calculate combo activity per fixture
                const fixtureStats = {};
                allFixtures.forEach(fixtureName => {
                  const productsInFixture = new Set();
                  fixtures.forEach(fixture => {
                    if (fixture.shelves) {
                      fixture.shelves.forEach(shelf => {
                        if (shelf.name === fixtureName && shelf.products) {
                          shelf.products.forEach(p => {
                            if (p.upc) productsInFixture.add(p.upc);
                          });
                        }
                      });
                    }
                  });
                  
                  // Count correlations involving this fixture
                  const fixtureCorrelations = productCorrelations.filter(corr => 
                    productsInFixture.has(corr.productA.upc) || 
                    productsInFixture.has(corr.productB.upc)
                  );
                  
                  const totalComboSales = fixtureCorrelations.reduce((sum, corr) => sum + corr.timesBoughtTogether, 0);
                  
                  fixtureStats[fixtureName] = {
                    comboPairs: fixtureCorrelations.length,
                    totalComboSales,
                    avgPerPair: fixtureCorrelations.length > 0 ? (totalComboSales / fixtureCorrelations.length).toFixed(1) : 0
                  };
                });
                
                // Sort fixtures by combo activity
                const topFixtures = Object.entries(fixtureStats)
                  .sort((a, b) => b[1].totalComboSales - a[1].totalComboSales)
                  .slice(0, 5);
                
                // Filter correlations by fixture
                let filteredCorrelations = productCorrelations;
                if (correlationFixtureFilter !== 'all' && fixtures && Array.isArray(fixtures)) {
                  // Get all products in the selected fixture
                  const productsInFixture = new Set();
                  fixtures.forEach(fixture => {
                    if (fixture.shelves) {
                      fixture.shelves.forEach(shelf => {
                        if (shelf.name === correlationFixtureFilter && shelf.products) {
                          shelf.products.forEach(p => {
                            if (p.upc) productsInFixture.add(p.upc);
                          });
                        }
                      });
                    }
                  });
                  
                  // Filter correlations where at least one product is in the fixture
                  filteredCorrelations = productCorrelations.filter(corr => 
                    productsInFixture.has(corr.productA.upc) || 
                    productsInFixture.has(corr.productB.upc)
                  );
                }
                
                // Apply sorting
                filteredCorrelations = [...filteredCorrelations].sort((a, b) => {
                  const bundlePriceA = a.productA.price + a.productB.price;
                  const bundlePriceB = b.productA.price + b.productB.price;
                  
                  switch(correlationSortBy) {
                    case 'count_desc':
                      return b.timesBoughtTogether - a.timesBoughtTogether;
                    case 'count_asc':
                      return a.timesBoughtTogether - b.timesBoughtTogether;
                    case 'price_desc':
                      return bundlePriceB - bundlePriceA;
                    case 'price_asc':
                      return bundlePriceA - bundlePriceB;
                    default:
                      return b.timesBoughtTogether - a.timesBoughtTogether;
                  }
                });
                
                return (
                  <>
                    {/* Hotspots - Fixtures OR Top Products */}
                    {productCorrelations.length > 0 && (
                      <div className="mb-4 p-4 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg border border-orange-200">
                        {topFixtures.length > 0 ? (
                          <>
                            <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                              üî• Top Products in Combos
                              <span className="text-xs font-normal text-gray-600">(Most frequently bundled items)</span>
                            </h3>
                            <div className="grid grid-cols-5 gap-3">
                              {(() => {
                                // Count how many combos each product appears in
                                const productComboCount = {};
                                productCorrelations.forEach(corr => {
                                  const nameA = corr.productA.name;
                                  const nameB = corr.productB.name;
                                  productComboCount[nameA] = (productComboCount[nameA] || 0) + corr.timesBoughtTogether;
                                  productComboCount[nameB] = (productComboCount[nameB] || 0) + corr.timesBoughtTogether;
                                });
                                
                                const topProducts = Object.entries(productComboCount)
                                  .sort((a, b) => b[1] - a[1])
                                  .slice(0, 5);
                                
                                return topProducts.map(([productName, count], idx) => (
                                  <div
                                    key={productName}
                                    className="p-3 rounded-lg bg-white border border-orange-200"
                                  >
                                    <div className="text-lg font-bold text-orange-600">#{idx + 1}</div>
                                    <div className="text-xs font-semibold min-h-[40px] leading-tight break-words" title={productName}>
                                      {productName}
                                    </div>
                                    <div className="text-xs mt-1 text-gray-600 font-bold">
                                      {count} combo sales
                                    </div>
                                  </div>
                                ));
                              })()}
                            </div>
                          </>
                        ) : (
                          <>
                            <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                              üî• Top Products in Combos
                              <span className="text-xs font-normal text-gray-600">(Most frequently bundled items)</span>
                            </h3>
                            <div className="grid grid-cols-5 gap-3">
                              {(() => {
                                // Count how many combos each product appears in
                                const productComboCount = {};
                                productCorrelations.forEach(corr => {
                                  const nameA = corr.productA.name;
                                  const nameB = corr.productB.name;
                                  productComboCount[nameA] = (productComboCount[nameA] || 0) + corr.timesBoughtTogether;
                                  productComboCount[nameB] = (productComboCount[nameB] || 0) + corr.timesBoughtTogether;
                                });
                                
                                const topProducts = Object.entries(productComboCount)
                                  .sort((a, b) => b[1] - a[1])
                                  .slice(0, 5);
                                
                                return topProducts.map(([productName, count], idx) => (
                                  <div
                                    key={productName}
                                    className="p-3 rounded-lg bg-white border border-orange-200"
                                  >
                                    <div className="text-lg font-bold text-orange-600">#{idx + 1}</div>
                                    <div className="text-xs font-semibold min-h-[40px] leading-tight break-words" title={productName}>
                                      {productName}
                                    </div>
                                    <div className="text-xs mt-1 text-gray-600 font-bold">
                                      {count} combo sales
                                    </div>
                                  </div>
                                ));
                              })()}
                            </div>
                          </>
                        )}
                      </div>
                    )}
                    
                    {/* üí∞ COMBO BUSINESS INTELLIGENCE */}
                    {productCorrelations.length > 0 && (() => {
                      // Calculate business metrics
                      const totalComboSales = productCorrelations.reduce((sum, corr) => sum + corr.timesBoughtTogether, 0);
                      const totalComboRevenue = productCorrelations.reduce((sum, corr) => 
                        sum + (corr.timesBoughtTogether * (corr.productA.price + corr.productB.price)), 0
                      );
                      const avgBundleValue = totalComboRevenue / totalComboSales;
                      
                      // Find strongest combo pairs (most frequently bought together)
                      const strongestCombos = [...productCorrelations]
                        .sort((a, b) => b.timesBoughtTogether - a.timesBoughtTogether)
                        .slice(0, 5);
                      
                      // Find highest revenue combos
                      const highestRevenueCombos = [...productCorrelations]
                        .map(corr => ({
                          ...corr,
                          revenue: corr.timesBoughtTogether * (corr.productA.price + corr.productB.price)
                        }))
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 5);
                      
                      // Find highest AOV combos (premium bundles)
                      const premiumCombos = [...productCorrelations]
                        .map(corr => ({
                          ...corr,
                          bundlePrice: corr.productA.price + corr.productB.price
                        }))
                        .sort((a, b) => b.bundlePrice - a.bundlePrice)
                        .slice(0, 5);
                      
                      return (
                        <div className="mb-4 p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border border-green-200">
                          <h3 className="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
                            üí∞ Combo Business Intelligence
                            <span className="text-xs font-normal text-gray-600">(Turn combos into revenue)</span>
                          </h3>
                          
                          {/* Key Metrics Row */}
                          <div className="grid grid-cols-3 gap-4 mb-4">
                            <div className="bg-white rounded-lg p-4 border border-green-200">
                              <div className="text-xs text-gray-600 mb-1">Total Combo Sales</div>
                              <div className="text-2xl font-bold text-green-600">{totalComboSales.toLocaleString()}</div>
                              <div className="text-xs text-gray-500 mt-1">Times products bought together</div>
                            </div>
                            <div className="bg-white rounded-lg p-4 border border-green-200">
                              <div className="text-xs text-gray-600 mb-1">Combo Revenue</div>
                              <div className="text-2xl font-bold text-green-600">${totalComboRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                              <div className="text-xs text-gray-500 mt-1">From bundled purchases</div>
                            </div>
                            <div className="bg-white rounded-lg p-4 border border-green-200">
                              <div className="text-xs text-gray-600 mb-1">Avg Bundle Value</div>
                              <div className="text-2xl font-bold text-green-600">${avgBundleValue.toFixed(2)}</div>
                              <div className="text-xs text-gray-500 mt-1">Per combo transaction</div>
                            </div>
                          </div>
                          
                          {/* Three columns of insights */}
                          <div className="grid grid-cols-3 gap-4">
                            {/* Strongest Combos */}
                            <div className="bg-white rounded-lg p-4 border border-green-200">
                              <h4 className="font-bold text-sm text-gray-800 mb-3">üî• Most Frequent Combos</h4>
                              <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                                {strongestCombos.slice(0, 10).map((combo, idx) => (
                                  <div key={idx} className="text-xs border-b border-gray-100 pb-2 last:border-0">
                                    <div className="font-semibold text-gray-700 mb-1">
                                      {combo.productA.name}
                                    </div>
                                    <div className="font-semibold text-gray-700 mb-1">
                                      + {combo.productB.name}
                                    </div>
                                    <div className="text-gray-600 mt-1">
                                      <span className="font-bold text-green-600">{combo.timesBoughtTogether}x</span> bought together
                                    </div>
                                  </div>
                                ))}
                              </div>
                              <div className="mt-3 text-xs text-gray-500 italic">
                                üí° Create bundle deals for these pairs
                              </div>
                            </div>
                            
                            {/* Highest Revenue Combos */}
                            <div className="bg-white rounded-lg p-4 border border-green-200">
                              <h4 className="font-bold text-sm text-gray-800 mb-3">üíµ Top Revenue Combos</h4>
                              <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                                {highestRevenueCombos.slice(0, 10).map((combo, idx) => (
                                  <div key={idx} className="text-xs border-b border-gray-100 pb-2 last:border-0">
                                    <div className="font-semibold text-gray-700 mb-1">
                                      {combo.productA.name}
                                    </div>
                                    <div className="font-semibold text-gray-700 mb-1">
                                      + {combo.productB.name}
                                    </div>
                                    <div className="text-gray-600 mt-1">
                                      <span className="font-bold text-green-600">${combo.revenue.toFixed(2)}</span> total revenue
                                      <span className="text-gray-500 ml-2">({combo.timesBoughtTogether}x)</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              <div className="mt-3 text-xs text-gray-500 italic">
                                üí° Prioritize these for placement & promotion
                              </div>
                            </div>
                            
                            {/* Premium Bundle Opportunities */}
                            <div className="bg-white rounded-lg p-4 border border-green-200">
                              <h4 className="font-bold text-sm text-gray-800 mb-3">üëë Premium Bundles</h4>
                              <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                                {premiumCombos.slice(0, 10).map((combo, idx) => (
                                  <div key={idx} className="text-xs border-b border-gray-100 pb-2 last:border-0">
                                    <div className="font-semibold text-gray-700 mb-1">
                                      {combo.productA.name}
                                    </div>
                                    <div className="font-semibold text-gray-700 mb-1">
                                      + {combo.productB.name}
                                    </div>
                                    <div className="text-gray-600 mt-1">
                                      <span className="font-bold text-green-600">${combo.bundlePrice.toFixed(2)}</span> bundle price
                                      <span className="text-gray-500 ml-2">({combo.timesBoughtTogether}x)</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              <div className="mt-3 text-xs text-gray-500 italic">
                                üí° High-value customers buy these together
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                    
                    {/* üó∫Ô∏è CUSTOMER MOVEMENT HEAT MAP */}
                    {productCorrelations.length > 0 && (() => {
                      // Extract product categories from names - IMPROVED
                      const categorizeProduct = (name) => {
                        const lower = name.toLowerCase();
                        
                        // Hair Color & Lightening
                        if (lower.includes('developer') || lower.includes('peroxide') || lower.includes('creme')) return 'Developer';
                        if (lower.includes('bw2') || lower.includes('powder') || lower.includes('bleach') || lower.includes('lightener')) return 'Bleach/Lightener';
                        if (lower.includes('color') || lower.includes('dye') || lower.includes('tint')) return 'Hair Color';
                        
                        // Hair Extensions & Braiding
                        if (lower.includes('braid') || lower.includes('xpression') || lower.includes('kanekalon')) return 'Braiding Hair';
                        if (lower.includes('weave') || lower.includes('bundle') || lower.includes('closure') || lower.includes('frontal')) return 'Weaves';
                        if (lower.includes('wig')) return 'Wigs';
                        
                        // Lashes & Eyes
                        if (lower.includes('lash') || lower.includes('lashes') || lower.includes('mink')) return 'Lashes';
                        
                        // Styling & Care
                        if (lower.includes('gel') || lower.includes('mousse') || lower.includes('spray') || lower.includes('styling')) return 'Styling Products';
                        if (lower.includes('shampoo') || lower.includes('conditioner') || lower.includes('treatment')) return 'Hair Care';
                        if (lower.includes('edge') || lower.includes('control')) return 'Edge Control';
                        
                        // Accessories & Tools
                        if (lower.includes('rubber band') || lower.includes('elastic') || lower.includes('clip') || lower.includes('pin')) return 'Accessories';
                        if (lower.includes('glue') || lower.includes('bond') || lower.includes('adhesive')) return 'Adhesives';
                        if (lower.includes('brush') || lower.includes('comb') || lower.includes('applicator')) return 'Tools';
                        if (lower.includes('cap') || lower.includes('net') || lower.includes('wrap')) return 'Accessories';
                        
                        // Beauty & Makeup
                        if (lower.includes('makeup') || lower.includes('foundation') || lower.includes('lipstick')) return 'Makeup';
                        if (lower.includes('nail') || lower.includes('polish')) return 'Nails';
                        
                        return null; // Will be filtered out instead of "Other"
                      };
                      
                      // Build category flow matrix
                      const categoryFlows = {};
                      const categories = new Set();
                      
                      productCorrelations.forEach(corr => {
                        const catA = categorizeProduct(corr.productA.name);
                        const catB = categorizeProduct(corr.productB.name);
                        
                        // Skip if either product doesn't have a category
                        if (!catA || !catB) return;
                        
                        categories.add(catA);
                        categories.add(catB);
                        
                        const key = catA < catB ? `${catA}‚Üí${catB}` : `${catB}‚Üí${catA}`;
                        categoryFlows[key] = (categoryFlows[key] || 0) + corr.timesBoughtTogether;
                      });
                      
                      const categoryList = Array.from(categories).sort();
                      const maxFlow = Math.max(...Object.values(categoryFlows));
                      
                      // State for toggled categories (using React state wouldn't work here, so we'll use a simple approach)
                      return (
                        <div className="mb-4 p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-sm font-bold text-gray-800 flex items-center gap-2">
                              üó∫Ô∏è Customer Movement Heat Map
                              <span className="text-xs font-normal text-gray-600">
                                {heatMapView === 'category' 
                                  ? '(Product categories customers combine)' 
                                  : '(Store layout with customer flows)'}
                              </span>
                            </h3>
                            
                            {/* Toggle Button */}
                            <div className="flex gap-2">
                              <button
                                onClick={() => setHeatMapView('category')}
                                className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${
                                  heatMapView === 'category'
                                    ? 'bg-blue-500 text-white shadow-lg'
                                    : 'bg-white text-gray-600 hover:bg-blue-100 border border-blue-200'
                                }`}
                              >
                                üìä Category Matrix
                              </button>
                              <button
                                onClick={() => setHeatMapView('planogram')}
                                className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${
                                  heatMapView === 'planogram'
                                    ? 'bg-blue-500 text-white shadow-lg'
                                    : 'bg-white text-gray-600 hover:bg-blue-100 border border-blue-200'
                                }`}
                              >
                                üè™ Store Flow Map
                              </button>
                            </div>
                          </div>
                          
                          {heatMapView === 'category' ? (
                            /* CATEGORY HEAT MAP */
                            <div className="bg-white rounded-lg p-4 border border-blue-200">
                            {/* Heat Map Grid */}
                            <div className="overflow-x-auto">
                              <table className="w-full text-xs">
                                <thead>
                                  <tr>
                                    <th className="p-2 text-left font-bold text-gray-700 border-b border-r border-gray-200">Category</th>
                                    {categoryList.map(cat => (
                                      <th key={cat} className="p-2 text-center font-semibold text-gray-700 border-b border-gray-200" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>
                                        {cat}
                                      </th>
                                    ))}
                                  </tr>
                                </thead>
                                <tbody>
                                  {categoryList.map((rowCat, rowIdx) => (
                                    <tr key={rowCat}>
                                      <td className="p-2 font-semibold text-gray-700 border-r border-gray-200">{rowCat}</td>
                                      {categoryList.map((colCat, colIdx) => {
                                        if (rowIdx >= colIdx) {
                                          // Lower triangle - show data
                                          const key = rowCat < colCat ? `${rowCat}‚Üí${colCat}` : `${colCat}‚Üí${rowCat}`;
                                          const flow = categoryFlows[key] || 0;
                                          const intensity = flow / maxFlow;
                                          
                                          let bgColor = '#f9fafb'; // gray-50
                                          let textColor = '#6b7280'; // gray-500
                                          
                                          if (intensity > 0) {
                                            if (intensity > 0.7) {
                                              bgColor = '#dc2626'; // red-600
                                              textColor = '#fff';
                                            } else if (intensity > 0.4) {
                                              bgColor = '#f97316'; // orange-500
                                              textColor = '#fff';
                                            } else if (intensity > 0.2) {
                                              bgColor = '#fbbf24'; // yellow-400
                                              textColor = '#000';
                                            } else if (intensity > 0.1) {
                                              bgColor = '#60a5fa'; // blue-400
                                              textColor = '#fff';
                                            } else {
                                              bgColor = '#bfdbfe'; // blue-200
                                              textColor = '#000';
                                            }
                                          }
                                          
                                          return (
                                            <td 
                                              key={colCat} 
                                              className="p-2 text-center border border-gray-200 cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all"
                                              style={{ backgroundColor: bgColor, color: textColor }}
                                              title={`${rowCat} + ${colCat}: ${flow} combo sales`}
                                            >
                                              {flow > 0 ? flow : '-'}
                                            </td>
                                          );
                                        } else {
                                          // Upper triangle - empty
                                          return <td key={colCat} className="p-2 bg-gray-100 border border-gray-200"></td>;
                                        }
                                      })}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                            
                            {/* Legend */}
                            <div className="mt-4 flex items-center justify-center gap-4 text-xs">
                              <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: '#dc2626' }}></div>
                                <span>Hot (70%+)</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: '#f97316' }}></div>
                                <span>Very Active (40-70%)</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: '#fbbf24' }}></div>
                                <span>Active (20-40%)</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: '#60a5fa' }}></div>
                                <span>Moderate (10-20%)</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: '#bfdbfe' }}></div>
                                <span>Light (&lt;10%)</span>
                              </div>
                            </div>
                            
                            <div className="mt-3 text-xs text-gray-600 text-center italic">
                              üí° Hover over cells to see exact combo counts ‚Ä¢ Darker colors = stronger customer flows
                            </div>
                          </div>
                          ) : (
                            /* PLANOGRAM FLOW MAP */
                            <div className="bg-white rounded-lg p-4 border border-blue-200">
                              {sections && sections.length > 0 ? (
                                (() => {
                                  // Calculate fixture-to-fixture flows
                                  const fixtureFlows = {};
                                  const fixtureNames = new Set();
                                  
                                  // Map products to their fixtures from sections
                                  const productToFixture = {};
                                  
                                  // Normalize UPC function (remove dashes, spaces, leading zeros)
                                  const normalizeUPC = (upc) => {
                                    if (!upc) return '';
                                    return upc.toString().replace(/[-\s]/g, '').replace(/^0+/, '');
                                  };
                                  
                                  // Normalize name function (lowercase, trim)
                                  const normalizeName = (name) => {
                                    if (!name) return '';
                                    return name.toLowerCase().trim();
                                  };
                                  
                                  sections.forEach(section => {
                                    fixtureNames.add(section.name);
                                    
                                    // Products are in ROWS, not products array!
                                    if (section.rows && Array.isArray(section.rows)) {
                                      section.rows.forEach(row => {
                                        if (row.products && Array.isArray(row.products)) {
                                          row.products.forEach(p => {
                                            // Map by normalized UPC
                                            if (p.upc) {
                                              const normalizedUPC = normalizeUPC(p.upc);
                                              productToFixture[normalizedUPC] = section.name;
                                              // Also keep original UPC
                                              productToFixture[p.upc] = section.name;
                                            }
                                            // Map by normalized name
                                            if (p.name) {
                                              const normalizedName = normalizeName(p.name);
                                              productToFixture[normalizedName] = section.name;
                                              // Also keep original name
                                              productToFixture[p.name] = section.name;
                                            }
                                          });
                                        }
                                      });
                                    }
                                    
                                    // ALSO check products array as fallback
                                    if (section.products && Array.isArray(section.products)) {
                                      section.products.forEach(p => {
                                        if (p.upc) {
                                          const normalizedUPC = normalizeUPC(p.upc);
                                          productToFixture[normalizedUPC] = section.name;
                                          productToFixture[p.upc] = section.name;
                                        }
                                        if (p.name) {
                                          const normalizedName = normalizeName(p.name);
                                          productToFixture[normalizedName] = section.name;
                                          productToFixture[p.name] = section.name;
                                        }
                                      });
                                    }
                                  });
                                  
                                  // Calculate flows between fixtures
                                  productCorrelations.forEach(corr => {
                                    // Try multiple matching strategies
                                    let fixtureA = null;
                                    let fixtureB = null;
                                    
                                    // Try UPC (original)
                                    fixtureA = productToFixture[corr.productA.upc];
                                    fixtureB = productToFixture[corr.productB.upc];
                                    
                                    // Try UPC (normalized)
                                    if (!fixtureA && corr.productA.upc) {
                                      fixtureA = productToFixture[normalizeUPC(corr.productA.upc)];
                                    }
                                    if (!fixtureB && corr.productB.upc) {
                                      fixtureB = productToFixture[normalizeUPC(corr.productB.upc)];
                                    }
                                    
                                    // Try name (original)
                                    if (!fixtureA && corr.productA.name) {
                                      fixtureA = productToFixture[corr.productA.name];
                                    }
                                    if (!fixtureB && corr.productB.name) {
                                      fixtureB = productToFixture[corr.productB.name];
                                    }
                                    
                                    // Try name (normalized)
                                    if (!fixtureA && corr.productA.name) {
                                      fixtureA = productToFixture[normalizeName(corr.productA.name)];
                                    }
                                    if (!fixtureB && corr.productB.name) {
                                      fixtureB = productToFixture[normalizeName(corr.productB.name)];
                                    }
                                    
                                    if (fixtureA && fixtureB && fixtureA !== fixtureB) {
                                      const key = fixtureA < fixtureB ? `${fixtureA}‚Üí${fixtureB}` : `${fixtureB}‚Üí${fixtureA}`;
                                      fixtureFlows[key] = (fixtureFlows[key] || 0) + corr.timesBoughtTogether;
                                    }
                                  });
                                  
                                  const fixtureList = Array.from(fixtureNames).sort();
                                  const maxFlow = Math.max(...Object.values(fixtureFlows), 1);
                                  const totalMappedProducts = Object.keys(productToFixture).length;
                                  const totalFlows = Object.keys(fixtureFlows).length;
                                  
                                  // Count how many correlations were successfully mapped
                                  let matchedCorrelations = 0;
                                  const unmatchedProducts = [];
                                  
                                  productCorrelations.forEach(corr => {
                                    const fixtureA = productToFixture[corr.productA.upc] || productToFixture[normalizeUPC(corr.productA.upc)] || 
                                                     productToFixture[corr.productA.name] || productToFixture[normalizeName(corr.productA.name)];
                                    const fixtureB = productToFixture[corr.productB.upc] || productToFixture[normalizeUPC(corr.productB.upc)] || 
                                                     productToFixture[corr.productB.name] || productToFixture[normalizeName(corr.productB.name)];
                                    
                                    if (fixtureA && fixtureB) {
                                      matchedCorrelations++;
                                    } else {
                                      // Track unmatched for debugging
                                      if (!fixtureA) {
                                        unmatchedProducts.push({
                                          name: corr.productA.name,
                                          upc: corr.productA.upc,
                                          normalizedUPC: normalizeUPC(corr.productA.upc),
                                          normalizedName: normalizeName(corr.productA.name)
                                        });
                                      }
                                      if (!fixtureB) {
                                        unmatchedProducts.push({
                                          name: corr.productB.name,
                                          upc: corr.productB.upc,
                                          normalizedUPC: normalizeUPC(corr.productB.upc),
                                          normalizedName: normalizeName(corr.productB.name)
                                        });
                                      }
                                    }
                                  });
                                  
                                  // Debug unmatched products
                                  console.log('‚ùå UNMATCHED PRODUCTS (first 10):', unmatchedProducts.slice(0, 10));
                                  console.log('‚úÖ AVAILABLE UPCs IN PLANOGRAM (first 20):', Object.keys(productToFixture).slice(0, 20));
                                  
                                  if (fixtureList.length === 0) {
                                    return (
                                      <div className="py-12 text-center">
                                        <div className="text-4xl mb-3">üè™</div>
                                        <div className="font-bold text-lg text-gray-700 mb-2">No Fixtures Found</div>
                                        <div className="text-sm text-gray-600">
                                          Add products to your planogram sections to see customer flows!
                                        </div>
                                      </div>
                                    );
                                  }
                                  
                                  if (totalFlows === 0) {
                                    return (
                                      <div className="py-12 px-6 text-center">
                                        <div className="text-4xl mb-3">üìã‚û°Ô∏èüè™</div>
                                        <div className="font-bold text-lg text-gray-700 mb-2">Add Products to Your Planogram!</div>
                                        <div className="text-sm text-gray-600 mb-4 max-w-md mx-auto">
                                          You have {fixtureList.length} fixtures and {productCorrelations.length} combo pairs, 
                                          but no products are placed in sections yet.
                                        </div>
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-lg mx-auto text-left">
                                          <div className="font-semibold text-sm text-blue-800 mb-2">üìç To see customer flows:</div>
                                          <ol className="text-xs text-gray-700 space-y-1 list-decimal list-inside">
                                            <li>Go to the main planogram view</li>
                                            <li>Click on a section/fixture</li>
                                            <li>Use the UPC scanner to add products</li>
                                            <li>Return here to see the heat map!</li>
                                          </ol>
                                        </div>
                                        <div className="text-xs text-gray-400 mt-4">
                                          Debug: {totalMappedProducts} products mapped ‚Ä¢ {fixtureList.length} fixtures ‚Ä¢ {matchedCorrelations}/{productCorrelations.length} correlations matched
                                        </div>
                                      </div>
                                    );
                                  }
                                  
                                  return (
                                    <div className="space-y-4">
                                      {/* Success Summary */}
                                      <div className="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                        <div className="text-sm font-bold text-green-800">
                                          ‚úÖ Found {totalFlows} cross-fixture customer flows!
                                        </div>
                                        <div className="text-xs text-green-600 mt-1">
                                          Matched {matchedCorrelations}/{productCorrelations.length} product pairs across {fixtureList.length} fixtures
                                        </div>
                                      </div>
                                      
                                      {/* Simplified Fixture Flow Visualization */}
                                      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[500px] overflow-y-auto">
                                        {fixtureList.map(fixtureName => {
                                          // Calculate total flow for this fixture
                                          const totalFlow = Object.entries(fixtureFlows)
                                            .filter(([key]) => key.includes(fixtureName))
                                            .reduce((sum, [_, val]) => sum + val, 0);
                                          
                                          const intensity = totalFlow / maxFlow;
                                          let bgColor = '#f3f4f6';
                                          let borderColor = '#d1d5db';
                                          
                                          if (intensity > 0.7) {
                                            bgColor = '#fee2e2';
                                            borderColor = '#dc2626';
                                          } else if (intensity > 0.4) {
                                            bgColor = '#fed7aa';
                                            borderColor = '#f97316';
                                          } else if (intensity > 0.2) {
                                            bgColor = '#fef3c7';
                                            borderColor = '#fbbf24';
                                          } else if (intensity > 0) {
                                            bgColor = '#dbeafe';
                                            borderColor = '#60a5fa';
                                          }
                                          
                                          return (
                                            <div
                                              key={fixtureName}
                                              className="p-3 rounded-lg border-2 transition-all hover:scale-105 cursor-pointer"
                                              style={{ backgroundColor: bgColor, borderColor }}
                                            >
                                              <div className="font-bold text-xs text-gray-800 mb-1">{fixtureName}</div>
                                              <div className="text-xs text-gray-600">
                                                {totalFlow} cross-fixture combos
                                              </div>
                                              
                                              {/* Top connections */}
                                              <div className="mt-2 space-y-1">
                                                {Object.entries(fixtureFlows)
                                                  .filter(([key]) => key.includes(fixtureName))
                                                  .sort((a, b) => b[1] - a[1])
                                                  .slice(0, 3)
                                                  .map(([key, count]) => {
                                                    const otherFixture = key.replace(fixtureName, '').replace('‚Üí', '');
                                                    return (
                                                      <div key={key} className="text-xs text-gray-500">
                                                        ‚Üí {otherFixture}: <span className="font-semibold">{count}</span>
                                                      </div>
                                                    );
                                                  })}
                                              </div>
                                            </div>
                                          );
                                        })}
                                      </div>
                                      
                                      <div className="text-xs text-gray-600 text-center italic mt-4">
                                        üí° Click fixtures to filter combos ‚Ä¢ Redder = hotter customer flow path
                                      </div>
                                    </div>
                                  );
                                })()
                              ) : (
                                <div className="py-12 text-center">
                                  <div className="text-4xl mb-3">üè™</div>
                                  <div className="font-bold text-lg text-gray-700 mb-2">Load Your Planogram</div>
                                  <div className="text-sm text-gray-600">
                                    Upload your store layout to see customer movement between fixtures!
                                  </div>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                    
                    {/* Filters Row */}
                    <div className="mb-4 space-y-3">
                      {/* Top Row: Fixture Filter & Sort */}
                      <div className="flex items-center gap-4 flex-wrap">
                        {allFixtures.length > 0 && (
                          <div className="flex items-center gap-2">
                            <label className="text-sm font-semibold text-gray-700">Fixture:</label>
                            <select
                              value={correlationFixtureFilter}
                              onChange={(e) => setCorrelationFixtureFilter(e.target.value)}
                              className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                              <option value="all">All Fixtures</option>
                              {allFixtures.map(fixtureName => (
                                <option key={fixtureName} value={fixtureName}>
                                  {fixtureName}
                                </option>
                              ))}
                            </select>
                          </div>
                        )}
                        
                        <div className="flex items-center gap-2">
                          <label className="text-sm font-semibold text-gray-700">Sort By:</label>
                          <select
                            value={correlationSortBy}
                            onChange={(e) => setCorrelationSortBy(e.target.value)}
                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          >
                            <option value="count_desc">Times Bought (High ‚Üí Low)</option>
                            <option value="count_asc">Times Bought (Low ‚Üí High)</option>
                            <option value="price_desc">Bundle Price (High ‚Üí Low)</option>
                            <option value="price_asc">Bundle Price (Low ‚Üí High)</option>
                          </select>
                        </div>
                        
                        <span className="text-xs text-gray-500 ml-auto">
                          Showing {filteredCorrelations.length} combination{filteredCorrelations.length === 1 ? '' : 's'}
                          {filteredCorrelations.length > 0 && (
                            <span className="ml-2 text-blue-600 font-semibold">
                              (Range: {Math.min(...filteredCorrelations.map(c => c.timesBoughtTogether))}‚Äì{Math.max(...filteredCorrelations.map(c => c.timesBoughtTogether))} times)
                            </span>
                          )}
                        </span>
                      </div>
                    </div>
                    
                    {/* Scrollable Container - fills all white space */}
                    <div className="space-y-4 max-h-[1200px] overflow-y-auto pr-2">
                      {filteredCorrelations.length > 0 ? (
                        filteredCorrelations.map((corr, idx) => (
                          <div key={idx} className="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                            <div className="flex items-center gap-2 mb-2">
                              <div className="flex-1 min-w-0">
                                <div className="font-semibold text-sm truncate">{corr.productA.name}</div>
                                <div className="text-xs text-gray-500">{corr.productA.upc || 'No UPC'}</div>
                              </div>
                              <span className="text-blue-600 font-bold">+</span>
                              <div className="flex-1 min-w-0">
                                <div className="font-semibold text-sm truncate">{corr.productB.name}</div>
                                <div className="text-xs text-gray-500">{corr.productB.upc || 'No UPC'}</div>
                              </div>
                            </div>
                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-blue-200">
                              <div className="text-xs text-gray-600">
                                Bought together <strong>{corr.timesBoughtTogether}</strong> times
                              </div>
                              <div className="text-sm font-bold text-green-600">
                                ${(corr.productA.price + corr.productB.price).toFixed(2)} bundle price
                              </div>
                            </div>
                            <div className="mt-2 p-2 bg-blue-100 rounded text-xs text-blue-800">
                              üí° <strong>Action:</strong> Place these products near each other ‚Ä¢ Create a bundle deal
                            </div>
                          </div>
                        ))
                      ) : (
                        <div className="p-8 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200 text-center">
                          <div className="text-4xl mb-3">ü§ù</div>
                          <div className="font-bold text-lg mb-2">
                            {correlationFixtureFilter === 'all' ? 'No Correlation Data Yet' : `No Combinations Found in ${correlationFixtureFilter}`}
                          </div>
                          <div className="text-sm text-gray-600">
                            {correlationFixtureFilter === 'all' 
                              ? 'Click üî• Orders button to analyze which products are bought together'
                              : 'Try selecting a different fixture or "All Fixtures"'
                            }
                          </div>
                        </div>
                      )}
                    </div>
                  </>
                );
              })()}
            </div>

            {/* üí∞ Revenue by Time Period */}
            {/* ‚è∞ When Do People Buy? */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-2">‚è∞ When Do People Buy?</h2>
              <p className="text-sm text-gray-500 mb-4">
                Sales patterns by time of day and day of month
                {orderAnalyticsData.allOrders && orderAnalyticsData.allOrders.length > 0 && (
                  <span className="ml-2 text-blue-600 font-semibold">
                    (analyzing {orderAnalyticsData.allOrders.length.toLocaleString()} orders)
                  </span>
                )}
              </p>
              
              {(() => {
                // Calculate from ALL orders for accurate patterns
                const ordersToAnalyze = orderAnalyticsData.allOrders || orderAnalyticsData.recentOrders || [];
                
                if (ordersToAnalyze.length === 0) {
                  return (
                    <div className="p-8 bg-gradient-to-br from-orange-50 to-red-50 rounded-lg border-2 border-orange-200 text-center">
                      <div className="text-4xl mb-3">üî•</div>
                      <div className="font-bold text-lg mb-2">Import Order Data to Unlock</div>
                      <div className="text-sm text-gray-600 mb-4">
                        Click the <strong>üî• Refresh Orders</strong> button above to analyze:
                      </div>
                      <div className="space-y-2 text-left max-w-md mx-auto">
                        <div className="flex items-center gap-2 text-sm">
                          <span className="text-green-500">‚úì</span>
                          <span><strong>Peak Shopping Hours</strong> - Best times for staffing</span>
                        </div>
                        <div className="flex items-center gap-2 text-sm">
                          <span className="text-green-500">‚úì</span>
                          <span><strong>Popular Days of Month</strong> - When customers have money</span>
                        </div>
                        <div className="flex items-center gap-2 text-sm">
                          <span className="text-green-500">‚úì</span>
                          <span><strong>Weekend vs Weekday</strong> - Traffic patterns</span>
                        </div>
                      </div>
                    </div>
                  );
                }
                
                // Calculate hourly distribution
                const hourCounts = Array(24).fill(0);
                const dayOfMonthCounts = {
                  '1-5': 0,
                  '6-10': 0,
                  '11-15': 0,
                  '16-20': 0,
                  '21-25': 0,
                  '26-31': 0
                };
                
                ordersToAnalyze.forEach(order => {
                  const orderDate = new Date(order.created_at);
                  const hour = orderDate.getHours();
                  const dayOfMonth = orderDate.getDate();
                  
                  hourCounts[hour]++;
                  
                  if (dayOfMonth >= 1 && dayOfMonth <= 5) dayOfMonthCounts['1-5']++;
                  else if (dayOfMonth >= 6 && dayOfMonth <= 10) dayOfMonthCounts['6-10']++;
                  else if (dayOfMonth >= 11 && dayOfMonth <= 15) dayOfMonthCounts['11-15']++;
                  else if (dayOfMonth >= 16 && dayOfMonth <= 20) dayOfMonthCounts['16-20']++;
                  else if (dayOfMonth >= 21 && dayOfMonth <= 25) dayOfMonthCounts['21-25']++;
                  else if (dayOfMonth >= 26 && dayOfMonth <= 31) dayOfMonthCounts['26-31']++;
                });
                
                const maxHourly = Math.max(...hourCounts);
                const maxDaily = Math.max(...Object.values(dayOfMonthCounts));
                
                // Find peak hour
                const peakHourIndex = hourCounts.indexOf(maxHourly);
                const peakHour = `${peakHourIndex}:00-${peakHourIndex + 1}:00`;
                
                // Find peak day range
                const peakDayRange = Object.entries(dayOfMonthCounts)
                  .reduce((max, [range, count]) => count > dayOfMonthCounts[max] ? range : max, '1-5');
                
                // Format hour labels
                const formatHour = (h) => {
                  const start = h === 0 ? '12am' : h < 12 ? `${h}am` : h === 12 ? '12pm' : `${h - 12}pm`;
                  const end = h === 23 ? '12am' : h + 1 < 12 ? `${h + 1}am` : h + 1 === 12 ? '12pm' : `${h + 1 - 12}pm`;
                  return `${start}-${end}`;
                };
                
                return (
                  <div className="space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <div className="text-sm font-semibold mb-2">üìä Sales by Hour</div>
                        <div className="space-y-1">
                          {hourCounts.map((count, hour) => (
                            <div key={hour} className="flex items-center gap-2">
                              <span className="text-xs w-20">{formatHour(hour)}</span>
                              <div className="flex-1 bg-gray-200 rounded h-4">
                                <div 
                                  className={`h-full rounded transition-all ${
                                    count === maxHourly && maxHourly > 0 ? 'bg-blue-600' : 'bg-blue-500'
                                  }`}
                                  style={{ width: maxHourly > 0 ? `${(count / maxHourly * 100)}%` : '0%' }}
                                />
                              </div>
                              <span className="text-xs w-12 text-right text-gray-600">{count}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      <div>
                        <div className="text-sm font-semibold mb-2">üìÖ Sales by Day of Month</div>
                        <div className="space-y-1">
                          {Object.entries(dayOfMonthCounts).map(([range, count]) => (
                            <div key={range} className="flex items-center gap-2">
                              <span className="text-xs w-12">{range}</span>
                              <div className="flex-1 bg-gray-200 rounded h-4">
                                <div 
                                  className={`h-full rounded transition-all ${
                                    count === maxDaily && maxDaily > 0 ? 'bg-green-600' : 'bg-green-500'
                                  }`}
                                  style={{ width: maxDaily > 0 ? `${(count / maxDaily * 100)}%` : '0%' }}
                                />
                              </div>
                              <span className="text-xs w-12 text-right text-gray-600">{count}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 pt-4 border-t">
                      <div className="text-center p-4 bg-blue-50 rounded-lg">
                        <div className="text-2xl font-bold text-blue-600">{peakHour}</div>
                        <div className="text-sm text-gray-600">Peak Shopping Hour</div>
                        <div className="text-xs text-gray-500 mt-1">{maxHourly} orders</div>
                      </div>
                      <div className="text-center p-4 bg-green-50 rounded-lg">
                        <div className="text-2xl font-bold text-green-600">{peakDayRange}</div>
                        <div className="text-sm text-gray-600">Peak Days of Month</div>
                        <div className="text-xs text-gray-500 mt-1">{dayOfMonthCounts[peakDayRange]} orders</div>
                      </div>
                    </div>
                  </div>
                );
              })()}
              
              {/* üìä INTERACTIVE SALES EXPLORER - Inside same card */}
              <div className="mt-8 pt-8 border-t-2 border-gray-200">
                {(() => {
                  const ordersToAnalyze = orderAnalyticsData.allOrders || orderAnalyticsData.recentOrders || [];
                  
                  if (ordersToAnalyze.length === 0) {
                    return null;
                  }
                  
                  const allDates = ordersToAnalyze.map(o => new Date(o.created_at).getTime()).filter(Boolean);
                  const minDate = new Date(Math.min(...allDates));
                  const maxDate = new Date(Math.max(...allDates));
                  
                  if (!salesExplorerDateRange.start) {
                    setSalesExplorerDateRange({ start: minDate, end: maxDate });
                    return <div className="text-center text-gray-500">Loading interactive explorer...</div>;
                  }
                  
                  const filteredOrders = ordersToAnalyze.filter(order => {
                    const orderDate = new Date(order.created_at);
                    return orderDate >= salesExplorerDateRange.start && orderDate <= salesExplorerDateRange.end;
                  });
                  
                  const hourlyData = Array(24).fill(0).map((_, hour) => {
                    const count = filteredOrders.filter(order => {
                      const orderHour = new Date(order.created_at).getHours();
                      return orderHour === hour;
                    }).length;
                    
                    const sales = filteredOrders
                      .filter(order => new Date(order.created_at).getHours() === hour)
                      .reduce((sum, order) => sum + parseFloat(order.total_price || 0), 0);
                    
                    return {
                      hour: hour === 0 ? '12am' : hour < 12 ? `${hour}am` : hour === 12 ? '12pm' : `${hour - 12}pm`,
                      orders: count,
                      sales: sales
                    };
                  });
                  
                  const dailyData = {};
                  filteredOrders.forEach(order => {
                    const date = new Date(order.created_at).toLocaleDateString();
                    if (!dailyData[date]) {
                      dailyData[date] = { date, orders: 0, sales: 0 };
                    }
                    dailyData[date].orders++;
                    dailyData[date].sales += parseFloat(order.total_price || 0);
                  });
                  const dailyChartData = Object.values(dailyData).sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                  );
                  
                  const chartData = salesExplorerView === 'hourly' ? hourlyData : dailyChartData;
                  
                  return (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">üìä Interactive Sales Explorer</h3>
                        <p className="text-sm text-gray-600">Filter and analyze your sales data dynamically</p>
                      </div>
                      
                      <div className="bg-gray-50 rounded-xl p-6 mb-6">
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h4 className="font-semibold text-gray-800">Date Range Filter</h4>
                            <p className="text-xs text-gray-500">
                              Analyzing {filteredOrders.length.toLocaleString()} orders from{' '}
                              {salesExplorerDateRange.start.toLocaleDateString()} to {salesExplorerDateRange.end.toLocaleDateString()}
                            </p>
                          </div>
                          <button
                            onClick={() => setSalesExplorerDateRange({ start: minDate, end: maxDate })}
                            className="text-xs px-3 py-1 bg-white hover:bg-gray-100 rounded-lg transition-colors border border-gray-300"
                          >
                            Reset
                          </button>
                        </div>
                        
                        <div className="flex gap-2 mb-4 flex-wrap">
                          <button
                            onClick={() => {
                              const end = new Date();
                              const start = new Date();
                              start.setDate(start.getDate() - 7);
                              setSalesExplorerDateRange({ start, end });
                            }}
                            className="text-xs px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg transition-colors"
                          >
                            Last 7 Days
                          </button>
                          <button
                            onClick={() => {
                              const end = new Date();
                              const start = new Date();
                              start.setMonth(start.getMonth() - 1);
                              setSalesExplorerDateRange({ start, end });
                            }}
                            className="text-xs px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-800 rounded-lg transition-colors"
                          >
                            Last Month
                          </button>
                          <button
                            onClick={() => {
                              const end = new Date();
                              const start = new Date();
                              start.setMonth(start.getMonth() - 3);
                              setSalesExplorerDateRange({ start, end });
                            }}
                            className="text-xs px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-colors"
                          >
                            Last 3 Months
                          </button>
                          <button
                            onClick={() => {
                              const end = new Date();
                              const start = new Date();
                              start.setFullYear(start.getFullYear() - 1);
                              setSalesExplorerDateRange({ start, end });
                            }}
                            className="text-xs px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded-lg transition-colors"
                          >
                            Last Year
                          </button>
                        </div>
                        
                        <div className="flex gap-2 pt-4 border-t border-gray-300">
                          <button
                            onClick={() => setSalesExplorerView('hourly')}
                            className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                              salesExplorerView === 'hourly'
                                ? 'bg-blue-500 text-white shadow-lg'
                                : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-300'
                            }`}
                          >
                            üìä Hourly
                          </button>
                          <button
                            onClick={() => setSalesExplorerView('daily')}
                            className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                              salesExplorerView === 'daily'
                                ? 'bg-blue-500 text-white shadow-lg'
                                : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-300'
                            }`}
                          >
                            üìÖ Daily
                          </button>
                        </div>
                      </div>
                      
                      <div className="bg-gray-50 rounded-xl p-6">
                        <div className="mb-4">
                          <h4 className="font-semibold text-gray-800">
                            {salesExplorerView === 'hourly' ? '‚è∞ Orders by Hour' : 'üìÜ Orders by Date'}
                          </h4>
                          <p className="text-xs text-gray-500">Hover for details</p>
                        </div>
                        
                        <div className="relative bg-white rounded-lg p-4" style={{ height: '300px' }}>
                          <div className="absolute left-0 top-0 bottom-8 flex flex-col justify-between text-xs text-gray-500 pr-2">
                            <span>{Math.max(...chartData.map(d => Math.max(d.orders, d.sales / 100))).toFixed(0)}</span>
                            <span>{(Math.max(...chartData.map(d => Math.max(d.orders, d.sales / 100))) * 0.75).toFixed(0)}</span>
                            <span>{(Math.max(...chartData.map(d => Math.max(d.orders, d.sales / 100))) * 0.5).toFixed(0)}</span>
                            <span>{(Math.max(...chartData.map(d => Math.max(d.orders, d.sales / 100))) * 0.25).toFixed(0)}</span>
                            <span>0</span>
                          </div>
                          
                          <div className="absolute left-12 right-0 top-0 bottom-8 flex items-end gap-1 border-l border-b border-gray-300">
                            {chartData.map((item, idx) => {
                              const maxValue = Math.max(...chartData.map(d => Math.max(d.orders, d.sales / 100)));
                              const ordersHeight = maxValue > 0 ? (item.orders / maxValue) * 100 : 0;
                              const salesHeight = maxValue > 0 ? ((item.sales / 100) / maxValue) * 100 : 0;
                              
                              return (
                                <div key={idx} className="flex-1 flex items-end gap-0.5 group relative" style={{ height: '100%' }}>
                                  <div className="absolute bottom-full mb-2 hidden group-hover:block bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl z-10 whitespace-nowrap">
                                    <div className="font-semibold mb-1">{salesExplorerView === 'hourly' ? item.hour : item.date}</div>
                                    <div className="text-blue-300">Orders: {item.orders}</div>
                                    <div className="text-green-300">Sales: ${item.sales.toFixed(2)}</div>
                                  </div>
                                  
                                  <div 
                                    className="flex-1 bg-blue-500 hover:bg-blue-600 transition-all rounded-t cursor-pointer"
                                    style={{ height: `${ordersHeight}%`, minHeight: ordersHeight > 0 ? '2px' : '0' }}
                                  />
                                  
                                  <div 
                                    className="flex-1 bg-green-500 hover:bg-green-600 transition-all rounded-t cursor-pointer"
                                    style={{ height: `${salesHeight}%`, minHeight: salesHeight > 0 ? '2px' : '0' }}
                                  />
                                </div>
                              );
                            })}
                          </div>
                          
                          <div className="absolute left-12 right-0 bottom-0 flex gap-1 mt-2">
                            {chartData.map((item, idx) => (
                              <div 
                                key={idx} 
                                className="flex-1 text-center text-xs text-gray-600 truncate"
                                style={{ 
                                  fontSize: salesExplorerView === 'daily' ? '9px' : '11px',
                                  transform: salesExplorerView === 'daily' ? 'rotate(-45deg)' : 'none'
                                }}
                                title={salesExplorerView === 'hourly' ? item.hour : item.date}
                              >
                                {salesExplorerView === 'hourly' ? item.hour : item.date.split('/')[1] + '/' + item.date.split('/')[0]}
                              </div>
                            ))}
                          </div>
                        </div>
                        
                        <div className="flex justify-center gap-6 mt-6 pt-4 border-t border-gray-300">
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-blue-500 rounded"></div>
                            <span className="text-sm">Orders</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-green-500 rounded"></div>
                            <span className="text-sm">Sales ($)</span>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-4 mt-6 pt-6 border-t border-gray-300">
                          <div className="text-center">
                            <div className="text-2xl font-bold text-blue-600">
                              {filteredOrders.length.toLocaleString()}
                            </div>
                            <div className="text-xs text-gray-600">Total Orders</div>
                          </div>
                          <div className="text-center">
                            <div className="text-2xl font-bold text-green-600">
                              ${filteredOrders.reduce((sum, o) => sum + parseFloat(o.total_price || 0), 0).toLocaleString(undefined, {maximumFractionDigits: 0})}
                            </div>
                            <div className="text-xs text-gray-600">Total Sales</div>
                          </div>
                          <div className="text-center">
                            <div className="text-2xl font-bold text-purple-600">
                              ${(filteredOrders.reduce((sum, o) => sum + parseFloat(o.total_price || 0), 0) / filteredOrders.length).toFixed(2)}
                            </div>
                            <div className="text-xs text-gray-600">Avg Order Value</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>

            {/* üî• ORDER ANALYTICS */}
            <div className="mt-8 -mx-8 px-8 py-8 bg-white">
              <div className="mb-6 flex justify-between items-center">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">üî• Order Analytics</h2>
                  <p className="text-gray-600 mt-1">Real-time order data from Shopify</p>
                </div>
                
                {/* Refresh Button */}
                <button
                  onClick={refreshOrders}
                  disabled={feedback.includes('Order Blitz') || feedback.includes('Importing')}
                  className={`px-4 py-2 ${
                    feedback.includes('Order Blitz') || feedback.includes('Importing')
                      ? 'bg-gray-400 cursor-not-allowed'
                      : 'bg-orange-500 hover:bg-orange-600'
                  } text-white rounded-lg font-semibold flex items-center gap-2 transition-all`}
                  title="Import latest orders from Shopify"
                >
                  {feedback.includes('Order Blitz') || feedback.includes('Importing') ? (
                    <>
                      <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Processing...
                    </>
                  ) : (
                    <>
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      Refresh Orders
                    </>
                  )}
                </button>
              </div>

              {/* Loading Banner */}
              {(feedback.includes('Order Blitz') || feedback.includes('Importing') || feedback.includes('Processing')) && (
                <div className="mb-6 bg-gradient-to-r from-orange-50 to-yellow-50 border-l-4 border-orange-500 rounded-lg p-6 shadow-lg">
                  <div className="flex items-center gap-4">
                    <div className="flex-shrink-0">
                      <svg className="animate-spin h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                    <div className="flex-1">
                      <div className="font-bold text-orange-800 text-lg mb-2">
                        {feedback}
                      </div>
                      <div className="w-full bg-orange-200 rounded-full h-2.5 overflow-hidden">
                        <div className="bg-orange-500 h-2.5 rounded-full animate-pulse" style={{ width: '100%' }}></div>
                      </div>
                      <div className="text-xs text-orange-700 mt-2">
                        {feedback.includes('background') 
                          ? 'Processing 9,646 orders... This takes 2-3 minutes. Feel free to browse other pages.'
                          : 'Fetching latest orders from Shopify...'}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Success Banner */}
              {feedback.includes('‚úÖ') && feedback.includes('Order Blitz') && (
                <div className="mb-6 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg p-6 shadow-lg">
                  <div className="flex items-center gap-4">
                    <div className="flex-shrink-0">
                      <svg className="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div className="flex-1">
                      <div className="font-bold text-green-800 text-lg">
                        {feedback}
                      </div>
                      <div className="text-sm text-green-700 mt-1">
                        Order data has been refreshed successfully!
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Sales by Time Period */}
              <div className="bg-gray-50 rounded-xl shadow-lg p-6 mb-6">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Sales by Time Period</h3>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                    <div className="text-sm font-semibold text-gray-600 mb-1">Today</div>
                    <div className="text-2xl font-bold text-blue-600">
                      ${(orderAnalyticsData.salesByPeriod?.today?.sales || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      {orderAnalyticsData.salesByPeriod?.today?.orders || 0} orders
                    </div>
                  </div>

                  <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                    <div className="text-sm font-semibold text-gray-600 mb-1">This Week</div>
                    <div className="text-2xl font-bold text-green-600">
                      ${(orderAnalyticsData.salesByPeriod?.week?.sales || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      {orderAnalyticsData.salesByPeriod?.week?.orders || 0} orders
                    </div>
                  </div>

                  <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4">
                    <div className="text-sm font-semibold text-gray-600 mb-1">This Month</div>
                    <div className="text-2xl font-bold text-purple-600">
                      ${(orderAnalyticsData.salesByPeriod?.month?.sales || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      {orderAnalyticsData.salesByPeriod?.month?.orders || 0} orders
                    </div>
                  </div>

                  <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4">
                    <div className="text-sm font-semibold text-gray-600 mb-1">This Year</div>
                    <div className="text-2xl font-bold text-orange-600">
                      ${(orderAnalyticsData.salesByPeriod?.year?.sales || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      {orderAnalyticsData.salesByPeriod?.year?.orders || 0} orders
                    </div>
                  </div>
                </div>
              </div>

              {/* Recent Orders Table */}
              <div className="bg-gray-50 rounded-xl shadow-lg overflow-hidden">
                <div className="p-6 bg-white border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800">Recent Orders</h3>
                  <p className="text-sm text-gray-600 mt-1">Last 50 orders processed</p>
                </div>
                <div className="overflow-x-auto" style={{ maxHeight: '600px', overflowY: 'auto' }}>
                  <table className="min-w-full w-full table-auto">
                    <thead className="bg-gray-100 sticky top-0 z-10">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" style={{ width: '20%' }}>Date</th>
                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" style={{ width: '12%' }}>Order #</th>
                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" style={{ width: '20%' }}>Customer</th>
                        <th className="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider" style={{ width: '15%' }}>Total</th>
                        <th className="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider" style={{ width: '10%' }}>Items</th>
                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider" style={{ width: '13%' }}>Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200 bg-white">
                      {orderAnalyticsData.recentOrders && orderAnalyticsData.recentOrders.length > 0 ? (
                        orderAnalyticsData.recentOrders.slice(0, 50).map((order, idx) => {
                          const orderId = order.order_number || order.id;
                          const isExpanded = expandedOrderId === orderId;
                          
                          return (
                            <React.Fragment key={idx}>
                              <tr 
                                className="hover:bg-blue-50 transition-colors cursor-pointer"
                                onClick={() => setExpandedOrderId(isExpanded ? null : orderId)}
                              >
                                <td className="px-6 py-4 text-sm text-gray-700 whitespace-nowrap">
                                  <div className="flex items-center gap-2">
                                    <span className={`transform transition-transform ${isExpanded ? 'rotate-90' : ''}`}>
                                      ‚ñ∂
                                    </span>
                                    {order.created_at ? new Date(order.created_at).toLocaleString() : 'N/A'}
                                  </div>
                                </td>
                                <td className="px-6 py-4 text-sm font-mono font-semibold text-blue-600 whitespace-nowrap">
                                  #{order.order_number || order.id || 'N/A'}
                                </td>
                                <td className="px-6 py-4 text-sm text-gray-800 whitespace-nowrap">
                                  {order.customer?.first_name || order.customer?.last_name 
                                    ? `${order.customer.first_name || ''} ${order.customer.last_name || ''}`.trim()
                                    : 'Guest'}
                                </td>
                                <td className="px-6 py-4 text-sm font-semibold text-right text-green-600 whitespace-nowrap">
                                  ${parseFloat(order.total_price || 0).toFixed(2)}
                                </td>
                                <td className="px-6 py-4 text-sm text-center text-gray-700 font-medium whitespace-nowrap">
                                  {order.line_items?.length || '‚Äî'}
                                </td>
                                <td className="px-6 py-4 text-sm whitespace-nowrap">
                                  <span className={`px-3 py-1.5 rounded-full text-xs font-semibold ${
                                    order.financial_status === 'paid' 
                                      ? 'bg-green-100 text-green-800'
                                      : 'bg-yellow-100 text-yellow-800'
                                  }`}>
                                    {order.financial_status || 'pending'}
                                  </span>
                                </td>
                              </tr>
                              
                              {/* Expanded Row - Line Items */}
                              {isExpanded && (
                                <tr>
                                  <td colSpan="6" className="px-6 py-4 bg-gray-50">
                                    <div className="border-l-4 border-blue-500 pl-4">
                                      <h4 className="font-semibold text-gray-800 mb-3">üì¶ Order Items:</h4>
                                      {order.line_items && order.line_items.length > 0 ? (
                                        <div className="space-y-2">
                                          {order.line_items.map((item, itemIdx) => (
                                            <div key={itemIdx} className="flex items-start justify-between p-3 bg-white rounded-lg border border-gray-200">
                                              <div className="flex-1">
                                                <div className="font-medium text-gray-900">
                                                  {item.title || item.name || 'Unknown Item'}
                                                </div>
                                                {item.variant_title && (
                                                  <div className="text-sm text-gray-600">
                                                    Variant: {item.variant_title}
                                                  </div>
                                                )}
                                                {item.sku && (
                                                  <div className="text-xs text-gray-500 font-mono">
                                                    SKU: {item.sku}
                                                  </div>
                                                )}
                                              </div>
                                              <div className="text-right ml-4">
                                                <div className="text-sm font-semibold text-gray-900">
                                                  Qty: {item.quantity || 1}
                                                </div>
                                                <div className="text-sm text-green-600">
                                                  ${parseFloat(item.price || 0).toFixed(2)} each
                                                </div>
                                                <div className="text-xs text-gray-500">
                                                  Total: ${(parseFloat(item.price || 0) * (item.quantity || 1)).toFixed(2)}
                                                </div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="text-gray-500 text-sm italic">
                                          No line items data available for this order
                                        </div>
                                      )}
                                    </div>
                                  </td>
                                </tr>
                              )}
                            </React.Fragment>
                          );
                        })
                      ) : (
                        <tr>
                          <td colSpan="6" className="px-6 py-12 text-center text-gray-500">
                            <div className="text-4xl mb-3">üì¶</div>
                            <div className="text-lg font-semibold mb-2">No Orders Yet</div>
                            <div className="text-sm">Order data will appear here once synced</div>
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* üìà FORECASTING PAGE */}
      {currentPage === 'forecasting' && (
        <div className="flex-1 overflow-auto p-8">
          <div className="mb-6 flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold mb-2">üìà Demand Forecasting & Inventory Intelligence</h1>
              <p className="text-gray-600">AI-powered predictions to prevent stockouts and optimize inventory</p>
              {(() => {
                const lastLoad = localStorage.getItem('lastInventoryLoadTime');
                if (lastLoad) {
                  const loadDate = new Date(parseInt(lastLoad));
                  const now = new Date();
                  const hoursSince = Math.floor((now - loadDate) / (1000 * 60 * 60));
                  return (
                    <p className="text-xs text-gray-500 mt-1">
                      üî¥ Live Shopify data ‚Ä¢ Last updated: {loadDate.toLocaleString()} ({hoursSince}h ago) ‚Ä¢ Auto-refreshes daily
                    </p>
                  );
                }
                return null;
              })()}
            </div>
            <button
              onClick={loadAllProductsFromDatabase}
              disabled={loadingAllProducts || !shopifyConfig.connected}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
            >
              {loadingAllProducts ? (
                <>
                  <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                  Loading...
                </>
              ) : (
                <>
                  <Icons.Download />
                  Load All Products ({allDatabaseProducts.length > 0 ? `${allDatabaseProducts.length} loaded` : 'from Shopify'})
                </>
              )}
            </button>
          </div>

          {/* Filters */}
          <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div className="flex gap-4 flex-wrap items-center">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Group By</label>
                <select
                  value={forecastGroupBy}
                  onChange={(e) => setForecastGroupBy(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                >
                  <option value="all">All Products</option>
                  <option value="fixture">By Fixture</option>
                  <option value="brand">By Brand</option>
                </select>
              </div>

              {/* Specific Fixture Filter */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Fixture</label>
                <select
                  value={forecastFilterFixture}
                  onChange={(e) => setForecastFilterFixture(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Fixtures</option>
                  {(fixtures || []).map(fixture => (
                    <option key={fixture.id} value={fixture.id}>{fixture.name}</option>
                  ))}
                </select>
              </div>

              {/* Specific Brand Filter */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Brand</label>
                <select
                  value={forecastFilterBrand}
                  onChange={(e) => setForecastFilterBrand(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Brands</option>
                  {(() => {
                    // Build brand list from API data, not planogram
                    const brands = [...new Set(allDatabaseProducts.map(p => {
                      const vendor = p.vendor?.trim();
                      return vendor && vendor !== '' ? vendor : 'Unknown Brand';
                    }))].sort();
                    return brands.map(brand => (
                      <option key={brand} value={brand}>{brand}</option>
                    ));
                  })()}
                </select>
              </div>

              {/* Specific Distributor Filter */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Distributor</label>
                <select
                  value={forecastFilterDistributor}
                  onChange={(e) => setForecastFilterDistributor(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Distributors</option>
                  {(() => {
                    // Build distributor list from API data, not planogram
                    const distributors = [...new Set(allDatabaseProducts.map(p => {
                      const dist = p.distributor?.trim();
                      return dist && dist !== '' ? dist : 'Unknown Distributor';
                    }))].sort();
                    return distributors.map(dist => (
                      <option key={dist} value={dist}>{dist}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Time Period</label>
                <select
                  value={timePeriod}
                  onChange={(e) => {
                    setTimePeriod(e.target.value);
                    if (e.target.value !== 'dateRange') {
                      setUseCustomDateRange(false);
                      setDateRangeSalesData(null);
                    }
                  }}
                  className="px-3 py-2 border rounded text-sm"
                >
                  <option value="day">Last Day</option>
                  <option value="week">Last Week</option>
                  <option value="month">Last Month</option>
                  <option value="quarter">Last Quarter</option>
                  <option value="year">Last Year</option>
                  <option value="dateRange">üìÖ Custom Date Range</option>
                </select>
              </div>

              {/* Date Range Picker */}
              {timePeriod === 'dateRange' && (
                <>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Start Date</label>
                    <input
                      type="date"
                      value={dateRangeStart}
                      onChange={(e) => setDateRangeStart(e.target.value)}
                      className="px-3 py-2 border rounded text-sm"
                    />
                  </div>

                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">End Date</label>
                    <input
                      type="date"
                      value={dateRangeEnd}
                      onChange={(e) => setDateRangeEnd(e.target.value)}
                      className="px-3 py-2 border rounded text-sm"
                    />
                  </div>

                  <div className="pt-5">
                    <button
                      onClick={fetchDateRangeSales}
                      disabled={loadingDateRangeSales || !dateRangeStart || !dateRangeEnd}
                      className={`px-3 py-2 rounded text-sm flex items-center gap-1 whitespace-nowrap ${
                        loadingDateRangeSales || !dateRangeStart || !dateRangeEnd
                          ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                          : 'bg-purple-600 text-white hover:bg-purple-700'
                      }`}
                    >
                      {loadingDateRangeSales ? (
                        <>
                          <Icons.RefreshCw className="animate-spin" />
                          Loading...
                        </>
                      ) : (
                        <>
                          <Icons.BarChart3 />
                          Load Range
                        </>
                      )}
                    </button>
                  </div>
                </>
              )}

              {/* Search Filter */}
              <div className="min-w-[200px]">
                <label className="block text-xs font-medium text-gray-700 mb-1">Search Products</label>
                <input
                  type="text"
                  value={forecastSearchQuery}
                  onChange={(e) => setForecastSearchQuery(e.target.value)}
                  placeholder="UPC, SKU, or name..."
                  className="w-full px-3 py-2 border rounded text-sm"
                />
              </div>

              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Sort By</label>
                <select
                  value={forecastSortBy}
                  onChange={(e) => setForecastSortBy(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                >
                  <option value="stockoutRisk">Stockout Risk</option>
                  <option value="velocity">Sales Velocity</option>
                  <option value="daysUntilOut">Days Until Out</option>
                  <option value="reorderQty">Reorder Quantity</option>
                </select>
              </div>

              {/* Clear Filters Button */}
              {(forecastFilterFixture !== 'all' || forecastFilterBrand !== 'all' || forecastFilterDistributor !== 'all' || forecastSearchQuery !== '') && (
                <div className="pt-5">
                  <button
                    onClick={() => {
                      setForecastFilterFixture('all');
                      setForecastFilterBrand('all');
                      setForecastFilterDistributor('all');
                      setForecastSearchQuery('');
                    }}
                    className="px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 flex items-center gap-1"
                  >
                    <Icons.X />
                    Clear Filters
                  </button>
                </div>
              )}

              {/* Refresh Inventory Button */}
              <div className="pt-5">
                <button
                  onClick={refreshAllProductData}
                  disabled={isRefreshing}
                  className={`px-3 py-2 rounded text-sm flex items-center gap-1 ${
                    isRefreshing 
                      ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                      : 'bg-blue-500 text-white hover:bg-blue-600'
                  }`}
                >
                  {isRefreshing ? (
                    <>
                      <Icons.RefreshCw className="animate-spin" />
                      Refreshing...
                    </>
                  ) : (
                    <>
                      <Icons.RefreshCw />
                      Refresh Inventory
                    </>
                  )}
                </button>
              </div>

              {/* Download PO Button */}
              <div className="pt-5 flex gap-2 flex-wrap">
                <button
                  onClick={generatePurchaseOrders}
                  disabled={allDatabaseProducts.length === 0}
                  className={`px-3 py-2 rounded text-sm flex items-center gap-1 ${
                    allDatabaseProducts.length === 0
                      ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                      : 'bg-green-600 text-white hover:bg-green-700'
                  }`}
                >
                  <Icons.Download />
                  Download PO
                </button>
                
                {/* Download CSV Button */}
                <button
                  onClick={generateCSV}
                  className={`px-3 py-2 rounded text-sm flex items-center gap-1 ${
                    allDatabaseProducts.length === 0
                      ? 'bg-gray-300 text-gray-600 cursor-not-allowed'
                      : 'bg-green-600 text-white hover:bg-green-700'
                  }`}
                  disabled={allDatabaseProducts.length === 0}
                >
                  <Icons.FileText />
                  Download CSV
                </button>
              </div>
            </div>
          </div>

          {/* Forecasting Content */}
          {(() => {
            // Always use database (API) products - no planogram fallback
            let allProducts = allDatabaseProducts.map(p => ({
              upc: p.barcode,
              name: p.variantTitle ? `${p.title} - ${p.variantTitle}` : p.title,
              price: p.price,
              cost: p.cost,
              distributor: p.distributor,
              inventoryQuantity: p.stock,
              dailySales: p.dailySales,
              weeklySales: p.weeklySales,
              monthlySales: p.monthlySales,
              quarterlySales: 0,
              yearlySales: 0,
              allTimeSales: p.allTimeSales,
              sku: p.sku,
              vendor: p.vendor,
              tags: p.tags,
              sectionName: 'Database',
              fixtureName: 'All Products',
              source: 'database'
            }));

            // Apply filters BEFORE calculating forecasts
            if (forecastFilterFixture !== 'all') {
              allProducts = allProducts.filter(p => p.fixtureId === forecastFilterFixture);
            }
            
            if (forecastFilterBrand !== 'all') {
              allProducts = allProducts.filter(p => {
                const vendor = p.vendor?.trim();
                const brand = vendor && vendor !== '' ? vendor : 'Unknown Brand';
                return brand === forecastFilterBrand;
              });
            }

            if (forecastFilterDistributor !== 'all') {
              allProducts = allProducts.filter(p => {
                const dist = p.distributor?.trim();
                const distributor = dist && dist !== '' ? dist : 'Unknown Distributor';
                return distributor === forecastFilterDistributor;
              });
            }

            // Apply search filter
            if (forecastSearchQuery.trim() !== '') {
              const query = forecastSearchQuery.toLowerCase().trim();
              allProducts = allProducts.filter(p => {
                const upc = (p.upc || '').toLowerCase();
                const sku = (p.sku || '').toLowerCase();
                const name = (p.name || '').toLowerCase();
                return upc.includes(query) || sku.includes(query) || name.includes(query);
              });
            }

            // Calculate forecasting metrics for each product
            const productsWithForecasts = allProducts.map(product => {
              // Debug: Log first few products with zero stock to see sales data
              if (product.inventoryQuantity === 0 && Math.random() < 0.1) {
                console.log(`üìä Zero-stock product: ${product.name} (${product.sku})`, {
                  daily: product.dailySales,
                  weekly: product.weeklySales,
                  monthly: product.monthlySales,
                  quarterly: product.quarterlySales,
                  yearly: product.yearlySales,
                  allTime: product.allTimeSales
                });
              }
              
              // Get sales velocity based on time period
              let salesVolume = 0;
              let daysInPeriod = 30;
              
              if (timePeriod === 'dateRange' && dateRangeSalesData) {
                // Use custom date range sales data
                const variantSales = dateRangeSalesData.salesData.find(
                  s => s.variantId.toString() === product.variantId?.toString()
                );
                salesVolume = variantSales ? variantSales.totalSales : 0;
                daysInPeriod = dateRangeSalesData.daysInPeriod;
              } else {
                // For products with low/zero stock, use longer periods to capture true velocity
                const currentStock = product.inventoryQuantity !== null && product.inventoryQuantity !== undefined 
                  ? product.inventoryQuantity 
                  : 0;
                
                // If stock is very low (‚â§5), look at longer history for more accurate velocity
                if (currentStock <= 5) {
                  // Try quarterly first, then yearly, then allTime
                  if (product.quarterlySales && product.quarterlySales > 0) {
                    salesVolume = product.quarterlySales;
                    daysInPeriod = 90;
                  } else if (product.yearlySales && product.yearlySales > 0) {
                    salesVolume = product.yearlySales;
                    daysInPeriod = 365;
                  } else if (product.allTimeSales && product.allTimeSales > 0) {
                    // Use all-time sales but cap at 1 year for realistic velocity
                    salesVolume = product.allTimeSales;
                    daysInPeriod = Math.min(365, 180); // Assume at least 6 months of history
                  } else {
                    // Fallback to monthly
                    salesVolume = product.monthlySales || 0;
                    daysInPeriod = 30;
                  }
                } else {
                  // Normal stock levels - use selected time period
                  switch(timePeriod) {
                    case 'day':
                      salesVolume = product.dailySales || 0;
                      daysInPeriod = 1;
                      break;
                    case 'week':
                      salesVolume = product.weeklySales || 0;
                      daysInPeriod = 7;
                      break;
                    case 'month':
                      salesVolume = product.monthlySales || 0;
                      daysInPeriod = 30;
                      break;
                    case 'quarter':
                      salesVolume = product.quarterlySales || 0;
                      daysInPeriod = 90;
                      break;
                    case 'year':
                      salesVolume = product.yearlySales || 0;
                      daysInPeriod = 365;
                      break;
                    default:
                      salesVolume = product.monthlySales || 0;
                      daysInPeriod = 30;
                  }
                }
              }

              const dailyVelocity = daysInPeriod > 0 ? salesVolume / daysInPeriod : 0;
              const currentStock = product.inventoryQuantity !== null && product.inventoryQuantity !== undefined 
                ? product.inventoryQuantity 
                : (product.quantity || 0);
              
              // Calculate days until out of stock (handle negative inventory properly)
              let daysUntilOut;
              if (dailyVelocity > 0) {
                // Has sales velocity - calculate days of supply
                daysUntilOut = currentStock / dailyVelocity;
              } else {
                // No sales velocity
                if (currentStock > 0) {
                  daysUntilOut = 999; // Infinite supply (no sales)
                } else if (currentStock < 0) {
                  daysUntilOut = currentStock; // Show negative as-is (oversold)
                } else {
                  daysUntilOut = 0; // Zero stock, zero sales
                }
              }
              
              // Stock out risk (high risk if < 7 days OR negative stock)
              let stockoutRisk = 'Low';
              let riskColor = 'green';
              if (currentStock < 0 || daysUntilOut < 3) {
                stockoutRisk = 'CRITICAL';
                riskColor = 'red';
              } else if (daysUntilOut < 7) {
                stockoutRisk = 'High';
                riskColor = 'orange';
              } else if (daysUntilOut < 14) {
                stockoutRisk = 'Medium';
                riskColor = 'yellow';
              }

              // Recommended reorder quantity for 30 days of supply + 25% safety stock
              // Formula: (30 days √ó daily velocity + safety stock) - current stock
              const targetSupply = dailyVelocity * 30;
              const safetyStock = targetSupply * 0.25;
              const reorderQty = Math.max(0, Math.ceil(targetSupply + safetyStock - currentStock));

              // Seasonal pattern (simplified - compare to average)
              const avgSales = (product.monthlySales || 0);
              const seasonalTrend = salesVolume > avgSales * 1.2 ? 'üìà Trending Up' : 
                                   salesVolume < avgSales * 0.8 ? 'üìâ Trending Down' : 
                                   '‚û°Ô∏è Stable';

              return {
                ...product,
                currentStock, // Add this so it's available in the table
                dailyVelocity,
                daysUntilOut,
                stockoutRisk,
                riskColor,
                reorderQty,
                seasonalTrend,
                salesVolume
              };
            });

            // Group products based on filter
            let groupedData = {};
            
            if (forecastGroupBy === 'fixture') {
              productsWithForecasts.forEach(p => {
                if (!groupedData[p.fixtureName]) {
                  groupedData[p.fixtureName] = [];
                }
                groupedData[p.fixtureName].push(p);
              });
            } else if (forecastGroupBy === 'brand') {
              productsWithForecasts.forEach(p => {
                const vendor = p.vendor?.trim();
                const brand = vendor && vendor !== '' ? vendor : 'Unknown Brand';
                if (!groupedData[brand]) {
                  groupedData[brand] = [];
                }
                groupedData[brand].push(p);
              });
            } else {
              groupedData['All Products'] = productsWithForecasts;
            }

            // Sort products within each group
            Object.keys(groupedData).forEach(groupName => {
              groupedData[groupName].sort((a, b) => {
                switch(forecastSortBy) {
                  case 'stockoutRisk':
                    return a.daysUntilOut - b.daysUntilOut;
                  case 'velocity':
                    return b.dailyVelocity - a.dailyVelocity;
                  case 'daysUntilOut':
                    return a.daysUntilOut - b.daysUntilOut;
                  case 'reorderQty':
                    return b.reorderQty - a.reorderQty;
                  default:
                    return 0;
                }
              });
            });

            // Calculate summary stats
            const totalProducts = productsWithForecasts.length;
            const criticalStock = productsWithForecasts.filter(p => p.stockoutRisk === 'CRITICAL').length;
            const highRisk = productsWithForecasts.filter(p => p.stockoutRisk === 'High').length;
            const avgVelocity = productsWithForecasts.length > 0 
              ? productsWithForecasts.reduce((sum, p) => sum + p.dailyVelocity, 0) / productsWithForecasts.length 
              : 0;

            return (
              <>
                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow-lg p-4 border-2 border-red-300">
                    <div className="text-red-600 font-bold text-sm mb-1">üö® CRITICAL ALERTS</div>
                    <div className="text-3xl font-bold text-red-700">{criticalStock}</div>
                    <div className="text-xs text-red-600 mt-1">Out in &lt;3 days</div>
                  </div>

                  <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow-lg p-4 border-2 border-orange-300">
                    <div className="text-orange-600 font-bold text-sm mb-1">‚ö†Ô∏è HIGH RISK</div>
                    <div className="text-3xl font-bold text-orange-700">{highRisk}</div>
                    <div className="text-xs text-orange-600 mt-1">Out in &lt;7 days</div>
                  </div>

                  <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-4 border-2 border-blue-300">
                    <div className="text-blue-600 font-bold text-sm mb-1">üì¶ TOTAL PRODUCTS</div>
                    <div className="text-3xl font-bold text-blue-700">{totalProducts}</div>
                    <div className="text-xs text-blue-600 mt-1">Being tracked</div>
                  </div>

                  <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-4 border-2 border-green-300">
                    <div className="text-green-600 font-bold text-sm mb-1">‚ö° AVG VELOCITY</div>
                    <div className="text-3xl font-bold text-green-700">{avgVelocity.toFixed(1)}</div>
                    <div className="text-xs text-green-600 mt-1">units/day</div>
                  </div>
                </div>

                {/* Grouped Product Tables */}
                <div className="space-y-6">
                  {Object.keys(groupedData).sort().map(groupName => {
                    const products = groupedData[groupName];
                    if (products.length === 0) return null;

                    return (
                      <div key={groupName} className="apple-card rounded-2xl overflow-hidden">
                        <div className="bg-white/70 backdrop-blur-sm p-5 border-b border-gray-200/50">
                          <h2 className="text-2xl font-semibold" style={{ 
                            color: '#1d1d1f',
                            letterSpacing: '-0.02em'
                          }}>{groupName}</h2>
                          <div className="text-sm mt-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>{products.length} products</div>
                        </div>

                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead className="bg-gray-100 border-b-2 border-gray-300">
                              <tr>
                                <th className="text-left p-3 text-xs font-bold text-gray-700">PRODUCT</th>
                                <th className="text-left p-3 text-xs font-bold text-gray-700">DISTRIBUTOR</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">STOCK</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">VELOCITY</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">DAYS LEFT</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">RISK</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">REORDER QTY</th>
                                <th className="text-center p-3 text-xs font-bold text-gray-700">TREND</th>
                                <th className="text-left p-3 text-xs font-bold text-gray-700">LOCATION</th>
                              </tr>
                            </thead>
                            <tbody>
                              {products.map((product, idx) => (
                                <tr 
                                  key={idx} 
                                  className={`border-b hover:bg-gray-50 ${
                                    product.riskColor === 'red' ? 'bg-red-50' :
                                    product.riskColor === 'orange' ? 'bg-orange-50' :
                                    product.riskColor === 'yellow' ? 'bg-yellow-50' : ''
                                  }`}
                                >
                                  <td className="p-3">
                                    <div className="font-semibold text-sm">{product.name}</div>
                                    <div className="text-xs text-gray-500">{product.sku || product.upc || 'No SKU'}</div>
                                    <div className="text-xs text-gray-400">{product.vendor || ''}</div>
                                  </td>
                                  <td className="p-3">
                                    <div className="text-sm text-gray-700">{product.distributor || 'Not set'}</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className={`font-bold ${
                                      product.currentStock < 0 ? 'text-red-600' :
                                      product.currentStock < 10 ? 'text-orange-600' : 
                                      'text-gray-700'
                                    }`}>
                                      {product.currentStock}
                                    </div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className="font-semibold text-blue-600">
                                      {product.dailyVelocity.toFixed(1)}
                                    </div>
                                    <div className="text-xs text-gray-500">per day</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className={`font-bold ${
                                      product.daysUntilOut < 3 ? 'text-red-600' :
                                      product.daysUntilOut < 7 ? 'text-orange-600' :
                                      product.daysUntilOut < 14 ? 'text-yellow-600' :
                                      'text-green-600'
                                    }`}>
                                      {product.daysUntilOut >= 999 ? '‚àû' : Math.floor(product.daysUntilOut)}
                                    </div>
                                    <div className="text-xs text-gray-500">days</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                                      product.riskColor === 'red' ? 'bg-red-200 text-red-800' :
                                      product.riskColor === 'orange' ? 'bg-orange-200 text-orange-800' :
                                      product.riskColor === 'yellow' ? 'bg-yellow-200 text-yellow-800' :
                                      'bg-green-200 text-green-800'
                                    }`}>
                                      {product.stockoutRisk}
                                    </span>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className="font-bold text-purple-600">
                                      {product.reorderQty}
                                    </div>
                                    <div className="text-xs text-gray-500">units</div>
                                  </td>
                                  <td className="text-center p-3">
                                    <div className="text-sm">{product.seasonalTrend}</div>
                                  </td>
                                  <td className="p-3">
                                    <div className="text-xs text-gray-600">{product.fixtureName}</div>
                                    <div className="text-xs text-gray-400">{product.sectionName}</div>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {totalProducts === 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                    <div className="text-6xl mb-4">üì¶</div>
                    <h3 className="text-2xl font-bold text-gray-700 mb-2">No Products to Forecast</h3>
                    <p className="text-gray-500">Add products to your planogram to see demand forecasting!</p>
                  </div>
                )}
              </>
            );
          })()}
        </div>
      )}

      {/* ‚öôÔ∏è SETTINGS PAGE */}
      {currentPage === 'rowAnalytics' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">üìä Row Analytics - Shelf Performance</h1>
            <p className="text-gray-600">Analyze performance by shelf with detailed metrics</p>
          </div>
          
          {/* Filters */}
          <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div className="flex flex-wrap items-center gap-4">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Fixture</label>
                <select
                  value={rowFilterFixture}
                  onChange={(e) => setRowFilterFixture(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Fixtures</option>
                  {(sections || []).map(section => (
                    <option key={section.id} value={section.id}>{section.name}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Brand</label>
                <select
                  value={rowFilterBrand}
                  onChange={(e) => setRowFilterBrand(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Brands</option>
                  {(() => {
                    const allProducts = sections.flatMap(section => 
                      (section.rows || []).flatMap(row => row.products || [])
                    );
                    const brands = [...new Set(allProducts.map(p => p.vendor?.trim() || 'Unknown Brand'))].sort();
                    return brands.map(brand => (
                      <option key={brand} value={brand}>{brand}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Filter Distributor</label>
                <select
                  value={rowFilterDistributor}
                  onChange={(e) => setRowFilterDistributor(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="all">All Distributors</option>
                  {(() => {
                    const allProducts = sections.flatMap(section => 
                      (section.rows || []).flatMap(row => row.products || [])
                    );
                    const distributors = [...new Set(allProducts.map(p => p.distributor?.trim() || 'Unknown Distributor'))].sort();
                    return distributors.map(dist => (
                      <option key={dist} value={dist}>{dist}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Sort By</label>
                <select
                  value={rowSortBy}
                  onChange={(e) => setRowSortBy(e.target.value)}
                  className="px-3 py-2 border rounded text-sm min-w-[150px]"
                >
                  <option value="profit">Highest Profit</option>
                  <option value="sales">Most Sales</option>
                  <option value="products">Most Products</option>
                  <option value="stock">Most Stock</option>
                </select>
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Start Date</label>
                <input
                  type="date"
                  value={rowDateRangeStart}
                  onChange={(e) => setRowDateRangeStart(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                />
              </div>
              
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">End Date</label>
                <input
                  type="date"
                  value={rowDateRangeEnd}
                  onChange={(e) => setRowDateRangeEnd(e.target.value)}
                  className="px-3 py-2 border rounded text-sm"
                />
              </div>
              
              {(rowDateRangeStart || rowDateRangeEnd) && (
                <button
                  onClick={() => {
                    setRowDateRangeStart('');
                    setRowDateRangeEnd('');
                  }}
                  className="px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 mt-5"
                >
                  Clear Dates
                </button>
              )}
              
              {(rowFilterFixture !== 'all' || rowFilterBrand !== 'all' || rowFilterDistributor !== 'all') && (
                <div className="pt-5">
                  <button
                    onClick={() => {
                      setRowFilterFixture('all');
                      setRowFilterBrand('all');
                      setRowFilterDistributor('all');
                    }}
                    className="px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 flex items-center gap-1"
                  >
                    <span>√ó</span> Clear Filters
                  </button>
                </div>
              )}
            </div>
          </div>
          
          {sections.length === 0 ? (
            <div className="bg-white rounded-lg shadow-lg p-8 text-center">
              <p className="text-gray-500 text-lg">No fixtures created yet. Go to Store Planner to create your first fixture!</p>
            </div>
          ) : (
            <div className="space-y-6">
              {sections
                .filter(section => rowFilterFixture === 'all' || section.id === rowFilterFixture)
                .map((section) => {
                  if (!section.rows || section.rows.length === 0) return null;
                  
                  // Filter and sort rows
                  const filteredRows = section.rows.map((row, rowIndex) => {
                    let products = row.products || [];
                    
                    // Apply brand filter
                    if (rowFilterBrand !== 'all') {
                      products = products.filter(p => (p.vendor?.trim() || 'Unknown Brand') === rowFilterBrand);
                    }
                    
                    // Apply distributor filter
                    if (rowFilterDistributor !== 'all') {
                      products = products.filter(p => (p.distributor?.trim() || 'Unknown Distributor') === rowFilterDistributor);
                    }
                    
                    // Calculate sales based on date range if specified
                    let salesMultiplier = 1; // Default to monthlySales
                    let salesLabel = 'Monthly';
                    
                    if (rowDateRangeStart && rowDateRangeEnd) {
                      const start = new Date(rowDateRangeStart);
                      const end = new Date(rowDateRangeEnd);
                      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                      
                      // Estimate sales for custom date range based on monthly average
                      salesMultiplier = daysDiff / 30;
                      salesLabel = `${daysDiff} Days`;
                    } else if (rowDateRangeStart) {
                      const start = new Date(rowDateRangeStart);
                      const now = new Date();
                      const daysDiff = Math.ceil((now - start) / (1000 * 60 * 60 * 24));
                      salesMultiplier = daysDiff / 30;
                      salesLabel = `Since ${rowDateRangeStart}`;
                    } else if (rowDateRangeEnd) {
                      const end = new Date(rowDateRangeEnd);
                      const monthAgo = new Date(end);
                      monthAgo.setDate(monthAgo.getDate() - 30);
                      const daysDiff = 30;
                      salesMultiplier = daysDiff / 30;
                      salesLabel = `Until ${rowDateRangeEnd}`;
                    }
                    
                    const totalProducts = products.length;
                    const totalSales = products.reduce((sum, p) => sum + ((p.monthlySales || 0) * salesMultiplier), 0);
                    const totalProfit = products.reduce((sum, p) => {
                      const profit = (p.price || 0) - (p.cost || 0);
                      return sum + (profit * ((p.monthlySales || 0) * salesMultiplier));
                    }, 0);
                    const totalStock = products.reduce((sum, p) => sum + (p.inventoryQuantity || 0), 0);
                    
                    return {
                      rowIndex,
                      products,
                      totalProducts,
                      totalSales,
                      totalProfit,
                      totalStock,
                      salesLabel
                    };
                  })
                  .filter(row => row.totalProducts > 0) // Only show rows with products after filtering
                  .sort((a, b) => {
                    switch(rowSortBy) {
                      case 'profit': return b.totalProfit - a.totalProfit;
                      case 'sales': return b.totalSales - a.totalSales;
                      case 'products': return b.totalProducts - a.totalProducts;
                      case 'stock': return b.totalStock - a.totalStock;
                      default: return 0;
                    }
                  });
                  
                  if (filteredRows.length === 0) return null;
                  
                  return (
                  <div key={section.id} className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4">{section.name}</h2>
                    
                    <div className="space-y-4">
                      {filteredRows.map((rowData) => {
                        const { rowIndex, products, totalProducts, totalSales, totalProfit, totalStock, salesLabel } = rowData;
                        const lowStockCount = products.filter(p => (p.inventoryQuantity || 0) < 10).length;
                        
                        // Determine row color based on performance
                        const bgColor = rowIndex % 2 === 0 
                          ? 'bg-yellow-50 border-yellow-300' 
                          : 'bg-green-50 border-green-300';
                        
                        return (
                          <div key={rowIndex} className={`${bgColor} border-2 rounded-lg p-4`}>
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-xl font-bold">Row {rowIndex + 1}</h3>
                              {lowStockCount > 0 && (
                                <span className="px-3 py-1 bg-red-500 text-white rounded-full text-sm font-bold">
                                  ‚ö†Ô∏è {lowStockCount} Low Stock
                                </span>
                              )}
                            </div>
                            
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Products</div>
                                <div className="text-2xl font-bold">{totalProducts}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">{salesLabel} Sales</div>
                                <div className="text-2xl font-bold text-green-600">{Math.round(totalSales)}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">{salesLabel} Profit</div>
                                <div className="text-2xl font-bold text-blue-600">${totalProfit.toFixed(2)}</div>
                              </div>
                              
                              <div className="bg-white rounded-lg p-3 shadow">
                                <div className="text-sm text-gray-600 mb-1">Total Stock</div>
                                <div className="text-2xl font-bold">{totalStock} {lowStockCount > 0 && <span className="text-red-500">‚ö†Ô∏è{lowStockCount}</span>}</div>
                              </div>
                            </div>
                            
                            {/* Top 5 Products in Row */}
                            {products.length > 0 && (
                              <div>
                                <h4 className="font-semibold mb-2 text-gray-700">Top 5 Products by Sales:</h4>
                                <div className="space-y-2">
                                  {products
                                    .sort((a, b) => (b.monthlySales || 0) - (a.monthlySales || 0))
                                    .slice(0, 5)
                                    .map((product, idx) => {
                                      const profit = (product.price || 0) - (product.cost || 0);
                                      const monthlyProfit = profit * (product.monthlySales || 0);
                                      
                                      return (
                                        <div key={idx} className="bg-white rounded p-3 shadow-sm flex items-center justify-between">
                                          <div className="flex-1">
                                            <div className="font-semibold text-sm">{product.name}</div>
                                            <div className="text-xs text-gray-500 flex items-center gap-2">
                                              <span>{product.vendor || 'Unknown Brand'} ‚Ä¢ UPC: {product.upc || 'N/A'}</span>
                                              {product.barcodes && product.barcodes.length > 1 && (
                                                <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-semibold">
                                                  +{product.barcodes.length - 1} more
                                                </span>
                                              )}
                                            </div>
                                          </div>
                                          <div className="flex items-center gap-4 text-sm">
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Sales</div>
                                              <div className="font-bold text-green-600">{product.monthlySales || 0}</div>
                                            </div>
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Profit</div>
                                              <div className="font-bold text-blue-600">${monthlyProfit.toFixed(2)}</div>
                                            </div>
                                            <div className="text-center">
                                              <div className="text-xs text-gray-500">Stock</div>
                                              <div className={`font-bold ${(product.inventoryQuantity || 0) < 10 ? 'text-red-500' : 'text-gray-700'}`}>
                                                {product.inventoryQuantity || 0}
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* üì¶ BAD STOCK PAGE */}
      {currentPage === 'badStock' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">üì¶ Bad Stock</h1>
            <p className="text-gray-600">Products with negative inventory that need stock verification and updates</p>
          </div>

          {/* Analytics Cards */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Bad Stock</div>
              <div className="text-3xl font-bold text-red-600">
                {badStockProducts.filter(b => !b.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Resolved</div>
              <div className="text-3xl font-bold text-green-600">
                {badStockProducts.filter(b => b.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Avg. Negative Stock</div>
              <div className="text-3xl font-bold text-orange-600">
                {badStockProducts.filter(b => !b.resolved).length > 0 
                  ? Math.round(badStockProducts.filter(b => !b.resolved).reduce((sum, b) => sum + (b.inventoryQuantity || 0), 0) / badStockProducts.filter(b => !b.resolved).length)
                  : 0}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Negative Units</div>
              <div className="text-3xl font-bold text-gray-800">
                {badStockProducts.filter(b => !b.resolved).reduce((sum, b) => sum + Math.abs(b.inventoryQuantity || 0), 0)}
              </div>
            </div>
          </div>

          {/* Action Info */}
          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <p className="text-blue-800">
              <strong>üí° Workflow:</strong> These products have negative inventory counts in Shopify. Review each item, verify physical stock, and update Shopify inventory accordingly. Mark as resolved when fixed.
            </p>
          </div>

          {/* Bad Stock List */}
          <div className="space-y-4">
            {badStockProducts.filter(b => !b.resolved).length === 0 ? (
              <div className="bg-white rounded-lg shadow p-8 text-center">
                <div className="text-4xl mb-4">‚úÖ</div>
                <div className="text-xl font-semibold text-gray-800">All stock verified!</div>
                <div className="text-gray-600 mt-2">No negative stock issues found.</div>
              </div>
            ) : (
              badStockProducts.filter(b => !b.resolved).map(badStock => {
                // Find which section and row this product is in
                let location = null;
                sections.forEach(section => {
                  section.rows?.forEach(row => {
                    const product = row.products?.find(p => p.upc === badStock.upc);
                    if (product) {
                      location = { sectionName: section.name, rowName: row.name };
                    }
                  });
                });

                return (
                  <div key={badStock.id} className="bg-red-50 border-2 border-red-300 rounded-lg shadow p-6">
                    <div className="flex items-start gap-6">
                      {/* UPC & Location */}
                      <div className="flex-shrink-0">
                        <div className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded mb-2">
                          ‚ö†Ô∏è NEGATIVE STOCK: {badStock.inventoryQuantity}
                        </div>
                        <div className="text-sm text-gray-600 mb-1">UPC</div>
                        <div className="font-mono text-lg font-bold">{badStock.upc}</div>
                        {location && (
                          <div className="mt-2 text-xs text-gray-600">
                            üìç {location.sectionName} ‚Üí {location.rowName}
                          </div>
                        )}
                        <div className="text-xs text-gray-500 mt-1">
                          Detected {new Date(badStock.addedAt).toLocaleDateString()}
                        </div>
                      </div>

                      {/* Note Field */}
                      <div className="flex-1">
                        <div className="text-sm text-gray-600 mb-1">Product Info / Notes</div>
                        <input
                          type="text"
                          value={badStock.note || ''}
                          onChange={(e) => updateBadStockNote(badStock.id, e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              e.preventDefault();
                              console.log('Enter pressed - saving immediately!');
                              saveToFirebase(sections);
                              setFeedback('üíæ Saved!');
                              setTimeout(() => setFeedback(''), 2000);
                            }
                          }}
                          placeholder="Add notes about stock verification..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"
                        />
                        
                        {/* Shopify Stock Update */}
                        <div className="flex items-center gap-2">
                          <div className="text-sm text-gray-600">Update Shopify Stock:</div>
                          <input
                            type="number"
                            min="0"
                            placeholder="New qty"
                            className="w-24 px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                            id={`stock-input-${badStock.id}`}
                          />
                          <button
                            onClick={async () => {
                              const input = document.getElementById(`stock-input-${badStock.id}`);
                              const newStock = parseInt(input.value);
                              
                              if (isNaN(newStock) || newStock < 0) {
                                setFeedback('‚ö†Ô∏è Please enter a valid quantity');
                                setTimeout(() => setFeedback(''), 2000);
                                return;
                              }
                              
                              try {
                                setFeedback('‚è≥ Updating Shopify...');
                                const response = await fetch(`${BACKEND_URL}/api/shopify/update-inventory`, {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({
                                    upc: badStock.upc,
                                    quantity: newStock,
                                    storeName: shopifyConfig.storeName,
                                    accessToken: shopifyConfig.accessToken
                                  })
                                });
                                
                                if (response.ok) {
                                  setFeedback(`‚úÖ Updated Shopify inventory to ${newStock} units`);
                                  // Update local product data
                                  const updatedSections = sections.map(section => ({
                                    ...section,
                                    rows: section.rows?.map(row => ({
                                      ...row,
                                      products: row.products?.map(p => 
                                        p.upc === badStock.upc ? { ...p, inventoryQuantity: newStock } : p
                                      )
                                    }))
                                  }));
                                  setSections(updatedSections);
                                  autoSave(updatedSections, 'Updated after Shopify sync');
                                  input.value = '';
                                } else {
                                  const error = await response.text();
                                  setFeedback(`‚ùå Failed to update: ${error}`);
                                }
                              } catch (error) {
                                console.error('Error updating Shopify:', error);
                                setFeedback('‚ùå Error updating Shopify inventory');
                              }
                              setTimeout(() => setFeedback(''), 3000);
                            }}
                            className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm font-semibold"
                            title="Push corrected stock to Shopify"
                          >
                            üì§ Update Shopify
                          </button>
                        </div>
                      </div>

                      {/* Actions */}
                      <div className="flex-shrink-0 flex gap-2">
                        <button
                          onClick={() => resolveBadStock(badStock.id)}
                          className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center gap-1"
                          title="Mark as Resolved"
                        >
                          ‚úì Resolved
                        </button>
                        <button
                          onClick={() => deleteBadStockProduct(badStock.id)}
                          className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                          title="Delete"
                        >
                          <Icons.Trash2 />
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* Resolved Bad Stock */}
          {badStockProducts.filter(b => b.resolved).length > 0 && (
            <div className="mt-8">
              <h2 className="text-2xl font-bold mb-4">‚úÖ Recently Resolved</h2>
              <div className="space-y-2">
                {badStockProducts.filter(b => b.resolved).map(badStock => (
                  <div key={badStock.id} className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between">
                    <div className="flex-1">
                      <div className="font-semibold text-green-800">{badStock.note || `UPC: ${badStock.upc}`}</div>
                      <div className="text-sm text-gray-600">
                        Previous Stock: {badStock.inventoryQuantity}
                      </div>
                    </div>
                    <button
                      onClick={() => deleteBadStockProduct(badStock.id)}
                      className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                    >
                      Remove
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {currentPage === 'settings' && (
        <div className="flex-1 overflow-auto p-8">
          <h1 className="text-3xl font-bold mb-6">‚öôÔ∏è Settings</h1>
          
          <div className="max-w-2xl space-y-6">
            {/* Data Management - Master Sync Controls */}
            <div className="apple-card rounded-2xl p-6">
              <h2 className="text-2xl font-semibold mb-2" style={{ 
                color: '#1d1d1f',
                letterSpacing: '-0.02em'
              }}>üìä Data Management</h2>
              <p className="text-sm mb-6" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>
                Master controls for syncing data from Shopify
              </p>
              
              {!shopifyConfig.connected ? (
                <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-sm" style={{ color: '#86868b' }}>
                  ‚ö†Ô∏è Connect Shopify below to enable data syncing
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Sync All Button */}
                  <button
                    onClick={async () => {
                      setFeedback('üîÑ Syncing all data...');
                      try {
                        await refreshProductCache(false);
                        await refreshSalesOnly();
                        await refreshOrders();
                        setFeedback('‚úÖ All data synced successfully!');
                        setTimeout(() => setFeedback(''), 3000);
                      } catch (error) {
                        setFeedback('‚ùå Sync failed: ' + error.message);
                      }
                    }}
                    className="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl hover:from-blue-600 hover:to-purple-600 font-semibold text-lg shadow-lg transition-all"
                  >
                    üîÑ Sync All Data
                  </button>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    {/* Products Button */}
                    <button
                      onClick={async () => {
                        setFeedback('üì¶ Syncing products...');
                        try {
                          await refreshProductCache(false);
                          setFeedback('‚úÖ Products synced!');
                          setTimeout(() => setFeedback(''), 3000);
                        } catch (error) {
                          setFeedback('‚ùå Failed: ' + error.message);
                        }
                      }}
                      className="px-4 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-medium transition-all shadow-md"
                      title="Refresh product catalog and inventory levels"
                    >
                      üì¶ Products
                    </button>

                    {/* Sales Button */}
                    <button
                      onClick={async () => {
                        setFeedback('üí∞ Syncing sales...');
                        try {
                          await refreshSalesOnly();
                          setFeedback('‚úÖ Sales synced!');
                          setTimeout(() => setFeedback(''), 3000);
                        } catch (error) {
                          setFeedback('‚ùå Failed: ' + error.message);
                        }
                      }}
                      className="px-4 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 font-medium transition-all shadow-md"
                      title="Refresh sales data and velocity metrics"
                    >
                      üí∞ Sales
                    </button>

                    {/* Orders Button */}
                    <button
                      onClick={async () => {
                        setFeedback('üìä Syncing orders...');
                        try {
                          await refreshOrders();
                          setFeedback('‚úÖ Orders synced!');
                          setTimeout(() => setFeedback(''), 3000);
                        } catch (error) {
                          setFeedback('‚ùå Failed: ' + error.message);
                        }
                      }}
                      className="px-4 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 font-medium transition-all shadow-md"
                      title="Import full order data for analytics"
                    >
                      üìä Orders
                    </button>
                  </div>

                  {/* Status Display */}
                  <div className="grid grid-cols-3 gap-3 pt-4 border-t border-gray-200">
                    <div className="text-center">
                      <div className="text-xs font-medium" style={{ color: '#86868b' }}>Products</div>
                      <div className={`text-sm font-semibold ${productsStatus.isStale ? 'text-yellow-600' : 'text-green-600'}`}>
                        {productsStatus.message}
                      </div>
                    </div>
                    <div className="text-center">
                      <div className="text-xs font-medium" style={{ color: '#86868b' }}>Sales</div>
                      <div className={`text-sm font-semibold ${salesStatus.isStale ? 'text-yellow-600' : 'text-green-600'}`}>
                        {salesStatus.message}
                      </div>
                    </div>
                    <div className="text-center">
                      <div className="text-xs font-medium" style={{ color: '#86868b' }}>Orders</div>
                      <div className={`text-sm font-semibold ${ordersStatus.isStale ? 'text-red-600' : 'text-green-600'}`}>
                        {ordersStatus.message}
                      </div>
                    </div>
                  </div>

                  {/* Auto-sync toggle */}
                  <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                    <div>
                      <div className="font-medium" style={{ color: '#1d1d1f' }}>Auto-sync</div>
                      <div className="text-xs" style={{ color: '#86868b' }}>Automatically refresh data every 5 minutes</div>
                    </div>
                    <button
                      onClick={() => setAutoRefreshEnabled(!autoRefreshEnabled)}
                      className={`px-4 py-2 rounded-lg font-medium transition-all ${
                        autoRefreshEnabled 
                          ? 'bg-green-500 text-white' 
                          : 'bg-gray-300 text-gray-700'
                      }`}
                    >
                      {autoRefreshEnabled ? '‚úì ON' : 'OFF'}
                    </button>
                  </div>
                </div>
              )}
            </div>
            
            {/* Shopify Connection */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-2xl font-bold mb-4">üõçÔ∏è Shopify Connection</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Store Name</label>
                  <input
                    type="text"
                    value={shopifyConfig.storeName}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, storeName: e.target.value})}
                    placeholder="your-store.myshopify.com"
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Admin API Access Token</label>
                  <input
                    type="password"
                    value={shopifyConfig.accessToken}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, accessToken: e.target.value})}
                    placeholder="shpat_..."
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                <button
                  onClick={testShopifyConnection}
                  className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-semibold"
                >
                  Test Connection
                </button>
                
                {shopifyConfig.connected && (
                  <div className="p-3 bg-green-100 text-green-800 rounded">
                    ‚úÖ Connected
                  </div>
                )}
              </div>
            </div>
            
            {/* Additional Settings Placeholder */}
            <div className="apple-card rounded-2xl p-6">
              <h2 className="text-2xl font-semibold mb-4" style={{ 
                color: '#1d1d1f',
                letterSpacing: '-0.02em'
              }}>üé® Display Settings</h2>
              <p className="text-sm" style={{ color: '#86868b' }}>More settings coming soon...</p>
            </div>
          </div>
        </div>
      )}

      {/* üîç FIND PRODUCT PAGE */}
      {currentPage === 'findProduct' && (
        <div className="flex-1 overflow-auto p-8" style={{ background: '#f5f5f7' }}>
          <div className="max-w-3xl mx-auto">
            <div className="mb-8 text-center">
              <h1 className="text-5xl font-semibold mb-3" style={{ 
                color: '#1d1d1f',
                letterSpacing: '-0.03em',
                fontWeight: '600'
              }}>üîç Find Product Location</h1>
              <p className="text-gray-600 text-lg" style={{ letterSpacing: '-0.01em' }}>Scan or enter a UPC to see which section and row it's in</p>
            </div>

            {/* Bulk UPC Update Button */}
            <div className="apple-card rounded-2xl p-4 mb-6">
              <div className="flex items-center justify-between">
                <div>
                  <div className="font-medium" style={{ color: '#1d1d1f', letterSpacing: '-0.01em' }}>üîÑ Sync UPCs from Shopify</div>
                  <div className="text-sm mt-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>Fill in missing UPCs by matching products with your Shopify inventory</div>
                </div>
                <button
                  onClick={async () => {
                    if (!confirm('This will update UPCs for all products in your planogram by matching them with Shopify. Continue?')) return;
                    
                    try {
                      setLoadingMessage('Loading products from Shopify...');
                      
                      // Use the existing backend endpoint
                      const response = await fetch(`${BACKEND_URL}/api/products/all`);
                      if (!response.ok) throw new Error('Failed to load Shopify products');
                      
                      const shopifyProducts = await response.json();
                      setLoadingMessage(`Loaded ${shopifyProducts.length} products. Matching with planogram...`);
                      
                      let updatedCount = 0;
                      let updatedSections = [...sections];
                      
                      // Update products in rows
                      for (const section of updatedSections) {
                        if (section.rows) {
                          for (const row of section.rows) {
                            if (row.products) {
                              row.products = row.products.map(product => {
                                // Skip if product already has a UPC
                                if (product.upc) return product;
                                
                                // Find matching Shopify product by name
                                const match = shopifyProducts.find(sp => 
                                  sp.title?.toLowerCase() === product.name?.toLowerCase() ||
                                  sp.title?.toLowerCase() === product.title?.toLowerCase()
                                );
                                
                                if (match && match.barcode) {
                                  updatedCount++;
                                  return { ...product, upc: match.barcode };
                                }
                                return product;
                              });
                            }
                          }
                        }
                        
                        // Also update products directly in sections
                        if (section.products) {
                          section.products = section.products.map(product => {
                            if (product.upc) return product;
                            
                            const match = shopifyProducts.find(sp => 
                              sp.title?.toLowerCase() === product.name?.toLowerCase() ||
                              sp.title?.toLowerCase() === product.title?.toLowerCase()
                            );
                            
                            if (match && match.barcode) {
                              updatedCount++;
                              return { ...product, upc: match.barcode };
                            }
                            return product;
                          });
                        }
                      }
                      
                      setSections(updatedSections);
                      autoSave(updatedSections, `Auto-saved after syncing ${updatedCount} UPCs from Shopify`);
                      setLoadingMessage('');
                      alert(`‚úÖ Successfully updated ${updatedCount} products with UPCs from Shopify!`);
                      
                    } catch (error) {
                      console.error('Error syncing UPCs:', error);
                      alert('‚ùå Error syncing UPCs: ' + error.message);
                      setLoadingMessage('');
                    }
                  }}
                  className="apple-button px-4 py-2 text-white rounded-lg text-sm whitespace-nowrap"
                  disabled={!!loadingMessage}
                >
                  {loadingMessage ? 'Syncing...' : 'Sync Now'}
                </button>
              </div>
            </div>

            <div className="apple-card rounded-2xl p-8 mb-6">
              <input
                type="text"
                placeholder="Scan or enter UPC..."
                value={searchUPC}
                onChange={(e) => setSearchUPC(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && searchUPC.trim()) {
                    // Search for product in all sections and rows
                    const searchTerm = searchUPC.trim().toLowerCase();
                    let found = null;
                    let matchType = null;
                    
                    for (const section of sections) {
                      // First check in rows (if section has rows)
                      if (section.rows) {
                        for (const row of section.rows) {
                          // Try UPC match first
                          let product = row.products?.find(p => p.upc === searchUPC.trim());
                          if (product) {
                            matchType = 'upc';
                          } else {
                            // Fallback: search by product name
                            product = row.products?.find(p => 
                              p.name?.toLowerCase().includes(searchTerm) ||
                              p.title?.toLowerCase().includes(searchTerm)
                            );
                            if (product) matchType = 'name';
                          }
                          
                          if (product) {
                            const fixture = fixtures.find(f => f.id === section.fixtureId);
                            found = {
                              product,
                              section,
                              row,
                              fixture,
                              matchType
                            };
                            break;
                          }
                        }
                      }
                      
                      // Also check in section.products directly (for sections without rows)
                      if (!found && section.products) {
                        // Try UPC match first
                        let product = section.products.find(p => p.upc === searchUPC.trim());
                        if (product) {
                          matchType = 'upc';
                        } else {
                          // Fallback: search by product name
                          product = section.products.find(p => 
                            p.name?.toLowerCase().includes(searchTerm) ||
                            p.title?.toLowerCase().includes(searchTerm)
                          );
                          if (product) matchType = 'name';
                        }
                        
                        if (product) {
                          const fixture = fixtures.find(f => f.id === section.fixtureId);
                          found = {
                            product,
                            section,
                            row: null,
                            fixture,
                            matchType
                          };
                        }
                      }
                      
                      if (found) break;
                    }
                    setSearchResults(found);
                  }
                }}
                className="apple-input w-full px-6 py-5 text-2xl rounded-xl text-center"
                style={{
                  fontFamily: '-apple-system, BlinkMacSystemFont, monospace',
                  fontSize: '28px',
                  letterSpacing: '0.02em'
                }}
                autoFocus
              />
              <div className="text-center text-sm mt-3" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>
                Press Enter to search
              </div>
            </div>

            {/* Results */}
            {searchResults && (
              <div className="apple-card rounded-2xl p-8 border-2" style={{ 
                borderColor: '#34c759',
                background: 'rgba(52, 199, 89, 0.05)'
              }}>
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">‚úÖ</div>
                  <h2 className="text-3xl font-semibold mb-2" style={{ 
                    color: '#1d1d1f',
                    letterSpacing: '-0.02em'
                  }}>Product Found!</h2>
                  {searchResults.matchType === 'name' && (
                    <div className="inline-block px-3 py-1 rounded-full text-sm" style={{
                      background: 'rgba(255, 149, 0, 0.1)',
                      color: '#ff9500',
                      letterSpacing: '-0.01em'
                    }}>
                      ‚ö†Ô∏è Matched by name (UPC missing in planogram)
                    </div>
                  )}
                </div>
                
                <div className="space-y-4">
                  <div className="bg-white/70 rounded-xl p-5 backdrop-blur-sm">
                    <div className="text-sm mb-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>Product</div>
                    <div className="text-2xl font-semibold" style={{ 
                      color: '#1d1d1f',
                      letterSpacing: '-0.02em'
                    }}>{searchResults.product.name}</div>
                    <div className="mt-2" style={{ color: '#86868b', fontSize: '15px', letterSpacing: '-0.01em' }}>UPC: {searchResults.product.upc}</div>
                  </div>

                  <div className="bg-white/70 rounded-xl p-5 backdrop-blur-sm">
                    <div className="text-sm mb-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>Location</div>
                    <div className="text-xl font-medium" style={{ color: '#007aff', letterSpacing: '-0.01em' }}>
                      üìç {searchResults.fixture?.name || 'Unknown Fixture'} ‚Üí {searchResults.section.name}{searchResults.row ? ` ‚Üí ${searchResults.row.name}` : ''}
                    </div>
                  </div>

                  <div className="grid grid-cols-3 gap-3">
                    <div className="bg-white/70 rounded-xl p-4 backdrop-blur-sm">
                      <div className="text-xs mb-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>Price</div>
                      <div className="text-xl font-semibold" style={{ color: '#34c759', letterSpacing: '-0.01em' }}>${searchResults.product.price?.toFixed(2) || '0.00'}</div>
                    </div>
                    <div className="bg-white/70 rounded-xl p-4 backdrop-blur-sm">
                      <div className="text-xs mb-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>Stock</div>
                      <div className="text-xl font-semibold" style={{ color: '#1d1d1f', letterSpacing: '-0.01em' }}>{searchResults.product.inventoryQuantity || 0}</div>
                    </div>
                    <div className="bg-white/70 rounded-xl p-4 backdrop-blur-sm">
                      <div className="text-xs mb-1" style={{ color: '#86868b', letterSpacing: '-0.01em' }}>Monthly Sales</div>
                      <div className="text-xl font-semibold" style={{ color: '#007aff', letterSpacing: '-0.01em' }}>{searchResults.product.monthlySales || 0}</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {searchResults === null && searchUPC && (
              <div className="apple-card rounded-2xl p-8 text-center border-2" style={{ 
                borderColor: '#ff3b30',
                background: 'rgba(255, 59, 48, 0.05)'
              }}>
                <div className="text-6xl mb-4">‚ùå</div>
                <h2 className="text-3xl font-semibold mb-2" style={{ 
                  color: '#1d1d1f',
                  letterSpacing: '-0.02em'
                }}>Product Not Found</h2>
                <p style={{ color: '#86868b', letterSpacing: '-0.01em' }}>UPC "{searchUPC}" is not in any section or row</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* üíæ SAVED LAYOUTS PAGE */}
      {currentPage === 'discounts' && (
        <div className="flex-1 overflow-auto p-6">
          <div className="max-w-7xl mx-auto">
            <h1 className="text-4xl font-bold mb-6 text-gray-800">üí∞ Discount Impact Analyzer</h1>
            
            {/* Discount Configuration Card */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="text-2xl font-bold mb-4">Discount Settings</h2>
              
              <div className="grid md:grid-cols-2 gap-6">
                {/* Discount Method */}
                <div className="md:col-span-2">
                  <label className="block text-sm font-semibold mb-2">Discount Method</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setDiscountConfig({...discountConfig, method: 'compare_at_price'})}
                      className={`px-4 py-3 rounded-lg border-2 font-semibold transition-all ${
                        discountConfig.method === 'compare_at_price'
                          ? 'border-emerald-500 bg-emerald-50 text-emerald-700'
                          : 'border-gray-300 hover:border-gray-400'
                      }`}
                    >
                      <div className="text-left">
                        <div className="font-bold">Compare At Price</div>
                        <div className="text-xs mt-1 opacity-75">Shows strikethrough on product pages</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setDiscountConfig({...discountConfig, method: 'discount_code'})}
                      className={`px-4 py-3 rounded-lg border-2 font-semibold transition-all ${
                        discountConfig.method === 'discount_code'
                          ? 'border-blue-500 bg-blue-50 text-blue-700'
                          : 'border-gray-300 hover:border-gray-400'
                      }`}
                    >
                      <div className="text-left">
                        <div className="font-bold">Discount Code</div>
                        <div className="text-xs mt-1 opacity-75">Customer enters code at checkout</div>
                      </div>
                    </button>
                  </div>
                </div>

                {/* Discount Type */}
                <div>
                  <label className="block text-sm font-semibold mb-2">Discount Type</label>
                  <select
                    className="w-full px-4 py-2 border rounded-lg"
                    value={discountConfig.type}
                    onChange={(e) => setDiscountConfig({...discountConfig, type: e.target.value})}
                  >
                    <option value="percentage">Percentage Off</option>
                    <option value="fixed">Fixed Amount Off</option>
                  </select>
                </div>

                {/* Discount Value */}
                <div>
                  <label className="block text-sm font-semibold mb-2">
                    {discountConfig.type === 'percentage' ? 'Percentage (%)' : 'Amount ($)'}
                  </label>
                  <input
                    type="number"
                    className="w-full px-4 py-2 border rounded-lg"
                    value={discountConfig.value}
                    onChange={(e) => setDiscountConfig({...discountConfig, value: Number(e.target.value)})}
                    min="0"
                    max={discountConfig.type === 'percentage' ? 100 : undefined}
                  />
                </div>

                {/* Target Selection */}
                <div>
                  <label className="block text-sm font-semibold mb-2">Apply To</label>
                  <select
                    className="w-full px-4 py-2 border rounded-lg"
                    value={discountConfig.target}
                    onChange={(e) => {
                      setDiscountConfig({...discountConfig, target: e.target.value, targetId: '', selectedProducts: [], selectedSections: []});
                      if (e.target.value === 'selected_products') {
                        setShowProductSelector(true);
                      }
                    }}
                  >
                    <option value="all">All Products</option>
                    <option value="sections">Specific Sections (Multi-Select)</option>
                    <option value="fixture">Specific Fixture</option>
                    <option value="selected_products">Select Specific Products</option>
                  </select>
                </div>

                {/* Multi-Select Sections - Grouped by Fixture */}
                {discountConfig.target === 'sections' && (
                  <div className="md:col-span-2">
                    <div className="flex items-center justify-between mb-2">
                      <label className="block text-sm font-semibold">
                        Select Sections ({discountConfig.selectedSections.length} selected)
                      </label>
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            const allSectionIds = sections.map(s => s.id);
                            setDiscountConfig({
                              ...discountConfig,
                              selectedSections: allSectionIds
                            });
                          }}
                          className="text-xs text-blue-600 hover:text-blue-800 font-semibold"
                        >
                          Select All
                        </button>
                        <button
                          onClick={() => {
                            setDiscountConfig({
                              ...discountConfig,
                              selectedSections: []
                            });
                          }}
                          className="text-xs text-red-600 hover:text-red-800 font-semibold"
                        >
                          Clear All
                        </button>
                      </div>
                    </div>
                    <div className="border rounded-lg p-4 max-h-64 overflow-y-auto bg-gray-50">
                      {sections.length === 0 ? (
                        <p className="text-sm text-gray-500">No sections available. Add sections to your planogram first.</p>
                      ) : (
                        fixtures.map(fixture => {
                          const fixtureSections = sections.filter(s => s.fixtureId === fixture.id);
                          if (fixtureSections.length === 0) return null;
                          
                          return (
                            <div key={fixture.id} className="mb-4 last:mb-0">
                              <div className="font-semibold text-sm text-gray-700 mb-2 flex items-center gap-2">
                                <span>{fixture.name}</span>
                                <button
                                  onClick={() => {
                                    const fixtureSectionIds = fixtureSections.map(s => s.id);
                                    const allSelected = fixtureSectionIds.every(id => 
                                      discountConfig.selectedSections.includes(id)
                                    );
                                    
                                    if (allSelected) {
                                      // Deselect all from this fixture
                                      setDiscountConfig({
                                        ...discountConfig,
                                        selectedSections: discountConfig.selectedSections.filter(
                                          id => !fixtureSectionIds.includes(id)
                                        )
                                      });
                                    } else {
                                      // Select all from this fixture
                                      const newSelection = [...new Set([
                                        ...discountConfig.selectedSections,
                                        ...fixtureSectionIds
                                      ])];
                                      setDiscountConfig({
                                        ...discountConfig,
                                        selectedSections: newSelection
                                      });
                                    }
                                  }}
                                  className="text-xs text-blue-600 hover:text-blue-800"
                                >
                                  {fixtureSections.every(s => discountConfig.selectedSections.includes(s.id))
                                    ? 'Deselect All'
                                    : 'Select All'}
                                </button>
                              </div>
                              <div className="space-y-1 ml-4">
                                {fixtureSections.map(section => {
                                  const productCount = section.rows?.reduce((sum, row) => 
                                    sum + (row.products?.length || 0), 0
                                  ) || 0;
                                  
                                  return (
                                    <label
                                      key={section.id}
                                      className="flex items-center gap-2 cursor-pointer hover:bg-white p-2 rounded"
                                    >
                                      <input
                                        type="checkbox"
                                        checked={discountConfig.selectedSections.includes(section.id)}
                                        onChange={(e) => {
                                          if (e.target.checked) {
                                            setDiscountConfig({
                                              ...discountConfig,
                                              selectedSections: [...discountConfig.selectedSections, section.id]
                                            });
                                          } else {
                                            setDiscountConfig({
                                              ...discountConfig,
                                              selectedSections: discountConfig.selectedSections.filter(id => id !== section.id)
                                            });
                                          }
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm">{section.name}</span>
                                      <span className="text-xs text-gray-500 ml-auto">
                                        {productCount} products
                                      </span>
                                    </label>
                                  );
                                })}
                              </div>
                            </div>
                          );
                        })
                      )}
                    </div>
                    {discountConfig.selectedSections.length === 0 && (
                      <p className="text-sm text-orange-600 mt-2">‚ö†Ô∏è Select at least one section</p>
                    )}
                  </div>
                )}

                {discountConfig.target === 'fixture' && (
                  <div>
                    <label className="block text-sm font-semibold mb-2">Select Fixture</label>
                    <select
                      className="w-full px-4 py-2 border rounded-lg"
                      value={discountConfig.targetId}
                      onChange={(e) => setDiscountConfig({...discountConfig, targetId: e.target.value})}
                    >
                      <option value="">Choose Fixture...</option>
                      {fixtures.map(f => (
                        <option key={f.id} value={f.id}>{f.name}</option>
                      ))}
                    </select>
                  </div>
                )}

                {/* Selected Products Display */}
                {discountConfig.target === 'selected_products' && (
                  <div className="md:col-span-2">
                    <div className="flex items-center justify-between">
                      <div>
                        <label className="block text-sm font-semibold mb-2">Selected Products</label>
                        <p className="text-sm text-gray-600">
                          {discountConfig.selectedProducts.length} products selected
                        </p>
                      </div>
                      <button
                        onClick={() => setShowProductSelector(true)}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                      >
                        {discountConfig.selectedProducts.length > 0 ? 'Edit Selection' : 'Select Products'}
                      </button>
                    </div>
                  </div>
                )}

                {/* Auto-Apply Toggle - Only for discount code method */}
                {discountConfig.method === 'discount_code' && (
                  <div className="md:col-span-2">
                    <label className="block text-sm font-semibold mb-2">Discount Application</label>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={() => setDiscountConfig({...discountConfig, autoApply: true})}
                        className={`px-4 py-3 rounded-lg border-2 font-semibold transition-all ${
                          discountConfig.autoApply
                            ? 'border-emerald-500 bg-emerald-50 text-emerald-700'
                            : 'border-gray-300 hover:border-gray-400'
                        }`}
                      >
                        <div className="text-left">
                          <div className="font-bold">‚ú® Auto-Apply</div>
                          <div className="text-xs mt-1 opacity-75">Applies automatically at cart (no code needed)</div>
                        </div>
                      </button>
                      <button
                        onClick={() => setDiscountConfig({...discountConfig, autoApply: false})}
                        className={`px-4 py-3 rounded-lg border-2 font-semibold transition-all ${
                          !discountConfig.autoApply
                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                            : 'border-gray-300 hover:border-gray-400'
                        }`}
                      >
                        <div className="text-left">
                          <div className="font-bold">üé´ Requires Code</div>
                          <div className="text-xs mt-1 opacity-75">Customer enters code at checkout</div>
                        </div>
                      </button>
                    </div>
                  </div>
                )}

                {/* Discount Code Name - Only for discount code method with manual entry */}
                {discountConfig.method === 'discount_code' && !discountConfig.autoApply && (
                  <div className="md:col-span-2">
                    <label className="block text-sm font-semibold mb-2">Discount Code Name</label>
                    <input
                      type="text"
                      className="w-full px-4 py-2 border rounded-lg"
                      value={discountConfig.codeName}
                      onChange={(e) => setDiscountConfig({...discountConfig, codeName: e.target.value.toUpperCase()})}
                      placeholder="e.g., SAVE20, BLACKFRIDAY"
                    />
                  </div>
                )}

                {/* Discount Title - Only for auto-apply */}
                {discountConfig.method === 'discount_code' && discountConfig.autoApply && (
                  <div className="md:col-span-2">
                    <label className="block text-sm font-semibold mb-2">Discount Title (shown to customers)</label>
                    <input
                      type="text"
                      className="w-full px-4 py-2 border rounded-lg"
                      value={discountConfig.codeName}
                      onChange={(e) => setDiscountConfig({...discountConfig, codeName: e.target.value})}
                      placeholder="e.g., Black Friday Sale, Holiday Special"
                    />
                  </div>
                )}

                {/* Date Range - Only for discount code method */}
                {discountConfig.method === 'discount_code' && (
                  <>
                    <div>
                      <label className="block text-sm font-semibold mb-2">Start Date</label>
                      <input
                        type="date"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={discountConfig.startDate}
                        onChange={(e) => setDiscountConfig({...discountConfig, startDate: e.target.value})}
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold mb-2">End Date</label>
                      <input
                        type="date"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={discountConfig.endDate}
                        onChange={(e) => setDiscountConfig({...discountConfig, endDate: e.target.value})}
                      />
                    </div>
                  </>
                )}
              </div>

              {/* Calculate Impact Button */}
              <div className="mt-6 flex gap-3">
                <button
                  onClick={calculateDiscountImpact}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
                >
                  üìä Calculate Impact
                </button>
                
                {discountImpact && (
                  <button
                    onClick={pushDiscountToShopify}
                    disabled={!shopifyConfig.connected}
                    className={`px-6 py-3 rounded-lg font-semibold ${
                      shopifyConfig.connected
                        ? 'bg-emerald-600 text-white hover:bg-emerald-700'
                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    }`}
                  >
                    {discountConfig.method === 'compare_at_price' 
                      ? 'üöÄ Update Prices in Shopify' 
                      : 'üöÄ Create Discount Code'}
                  </button>
                )}
              </div>

              {!shopifyConfig.connected && (
                <p className="mt-2 text-sm text-orange-600">
                  ‚ö†Ô∏è Connect to Shopify in Settings to {discountConfig.method === 'compare_at_price' ? 'update prices' : 'create discount codes'}
                </p>
              )}

              {/* Method Explanation */}
              <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                <p className="text-sm text-gray-700">
                  {discountConfig.method === 'compare_at_price' ? (
                    <>
                      <strong>Compare At Price:</strong> Sets the original price as "compare at price" and updates the actual price. 
                      Shopify will automatically show the savings with strikethrough pricing on product pages. 
                      No discount code needed!
                    </>
                  ) : discountConfig.autoApply ? (
                    <>
                      <strong>Auto-Apply Discount:</strong> Creates an automatic discount that applies to the cart without any code. 
                      Customers see the discount automatically applied at checkout - perfect for store-wide promotions! 
                      No code to remember or enter.
                    </>
                  ) : (
                    <>
                      <strong>Manual Discount Code:</strong> Creates a discount code that customers enter at checkout. 
                      Product prices stay the same on product pages - discount is applied only when code is used. 
                      Great for exclusive offers and tracking campaigns.
                    </>
                  )}
                </p>
              </div>
            </div>

            {/* Product Selector Modal */}
            {showProductSelector && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col">
                  {/* Modal Header */}
                  <div className="flex items-center justify-between p-6 border-b">
                    <h3 className="text-2xl font-bold">Select Products for Discount</h3>
                    <button
                      onClick={() => setShowProductSelector(false)}
                      className="text-gray-400 hover:text-gray-600"
                    >
                      <Icons.X />
                    </button>
                  </div>

                  {/* Modal Content */}
                  <div className="flex-1 overflow-auto p-6">
                    {fixtures.length === 0 ? (
                      <p className="text-gray-500 text-center py-8">No products found. Add products to your planogram first.</p>
                    ) : (
                      <>
                        {/* Select All / Deselect All */}
                        <div className="mb-4 flex gap-3">
                          <button
                            onClick={() => {
                              const allProductUPCs = [];
                              fixtures.forEach(fixture => {
                                fixture.sections?.forEach(section => {
                                  section.rows?.forEach(row => {
                                    row.products?.forEach(product => {
                                      if (product.upc && !allProductUPCs.includes(product.upc)) {
                                        allProductUPCs.push(product.upc);
                                      }
                                    });
                                  });
                                });
                              });
                              setDiscountConfig({...discountConfig, selectedProducts: allProductUPCs});
                            }}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                          >
                            Select All
                          </button>
                          <button
                            onClick={() => setDiscountConfig({...discountConfig, selectedProducts: []})}
                            className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold"
                          >
                            Deselect All
                          </button>
                          <div className="ml-auto text-sm font-semibold text-gray-600 flex items-center">
                            {discountConfig.selectedProducts.length} selected
                          </div>
                        </div>

                        {/* Products by Fixture and Section */}
                        {fixtures.map(fixture => {
                          const fixtureHasProducts = fixture.sections?.some(section => 
                            section.rows?.some(row => row.products?.length > 0)
                          );

                          if (!fixtureHasProducts) return null;

                          return (
                            <div key={fixture.id} className="mb-6">
                              <h4 className="text-lg font-bold text-gray-800 mb-3">
                                {fixture.name}
                              </h4>

                              {fixture.sections?.map(section => {
                                const sectionProducts = [];
                                section.rows?.forEach(row => {
                                  row.products?.forEach(product => {
                                    if (product.upc && !sectionProducts.find(p => p.upc === product.upc)) {
                                      sectionProducts.push(product);
                                    }
                                  });
                                });

                                if (sectionProducts.length === 0) return null;

                                return (
                                  <div key={section.id} className="mb-4 border rounded-lg p-4 bg-gray-50">
                                    <div className="flex items-center justify-between mb-3">
                                      <h5 className="font-semibold text-gray-700">{section.name}</h5>
                                      <div className="flex gap-2">
                                        <button
                                          onClick={() => {
                                            const sectionUPCs = sectionProducts.map(p => p.upc);
                                            const newSelected = [...discountConfig.selectedProducts];
                                            sectionUPCs.forEach(upc => {
                                              if (!newSelected.includes(upc)) {
                                                newSelected.push(upc);
                                              }
                                            });
                                            setDiscountConfig({...discountConfig, selectedProducts: newSelected});
                                          }}
                                          className="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                                        >
                                          Select All
                                        </button>
                                        <button
                                          onClick={() => {
                                            const sectionUPCs = sectionProducts.map(p => p.upc);
                                            const newSelected = discountConfig.selectedProducts.filter(
                                              upc => !sectionUPCs.includes(upc)
                                            );
                                            setDiscountConfig({...discountConfig, selectedProducts: newSelected});
                                          }}
                                          className="text-sm px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600"
                                        >
                                          Deselect All
                                        </button>
                                      </div>
                                    </div>

                                    <div className="space-y-2">
                                      {sectionProducts.map((product, idx) => {
                                        const isSelected = discountConfig.selectedProducts.includes(product.upc);
                                        return (
                                          <div
                                            key={idx}
                                            onClick={() => {
                                              const newSelected = isSelected
                                                ? discountConfig.selectedProducts.filter(upc => upc !== product.upc)
                                                : [...discountConfig.selectedProducts, product.upc];
                                              setDiscountConfig({...discountConfig, selectedProducts: newSelected});
                                            }}
                                            className={`flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all ${
                                              isSelected
                                                ? 'bg-blue-100 border-2 border-blue-500'
                                                : 'bg-white border border-gray-200 hover:bg-gray-50'
                                            }`}
                                          >
                                            <div className="flex items-center gap-3 flex-1">
                                              <input
                                                type="checkbox"
                                                checked={isSelected}
                                                onChange={() => {}}
                                                className="w-5 h-5"
                                              />
                                              <div className="flex-1">
                                                <div className="font-medium text-gray-800">{product.name}</div>
                                                <div className="text-sm text-gray-500">
                                                  {product.vendor} ‚Ä¢ UPC: {product.upc}
                                                </div>
                                              </div>
                                              <div className="text-right">
                                                <div className="font-bold text-gray-800">${product.price?.toFixed(2)}</div>
                                                <div className="text-xs text-gray-500">
                                                  {product.monthlySales || 0} sales/mo
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          );
                        })}
                      </>
                    )}
                  </div>

                  {/* Modal Footer */}
                  <div className="flex items-center justify-between p-6 border-t bg-gray-50">
                    <div className="text-sm text-gray-600">
                      <strong>{discountConfig.selectedProducts.length}</strong> products selected
                    </div>
                    <div className="flex gap-3">
                      <button
                        onClick={() => setShowProductSelector(false)}
                        className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          setShowProductSelector(false);
                          setFeedback(`‚úÖ ${discountConfig.selectedProducts.length} products selected`);
                          setTimeout(() => setFeedback(''), 3000);
                        }}
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                      >
                        Done
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Impact Analysis Results */}
            {discountImpact && (
              <>
                {/* Summary Cards */}
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6">
                    <div className="text-sm opacity-90 mb-1">Products Affected</div>
                    <div className="text-3xl font-bold">{discountImpact.productsAffected}</div>
                    <div className="text-xs opacity-80 mt-1">
                      {discountImpact.totalUnitsSold} units/month sold
                    </div>
                  </div>

                  <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6">
                    <div className="text-sm opacity-90 mb-1">Current Revenue</div>
                    <div className="text-3xl font-bold">${discountImpact.currentRevenue.toFixed(0)}</div>
                    <div className="text-xs opacity-80 mt-1">
                      {discountImpact.hasCostData ? (
                        <>Profit: ${discountImpact.currentProfit.toFixed(0)} ({discountImpact.currentMargin.toFixed(1)}%)</>
                      ) : (
                        <>Per month (revenue only)</>
                      )}
                    </div>
                  </div>

                  <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl p-6">
                    <div className="text-sm opacity-90 mb-1">Projected Revenue</div>
                    <div className="text-3xl font-bold">${discountImpact.projectedRevenue.toFixed(0)}</div>
                    <div className="text-xs opacity-80 mt-1">
                      {discountImpact.hasCostData ? (
                        <>Profit: ${discountImpact.projectedProfit.toFixed(0)} ({discountImpact.newMargin.toFixed(1)}%)</>
                      ) : (
                        <>With +{discountImpact.assumedUplift}% sales lift</>
                      )}
                    </div>
                  </div>

                  <div className={`bg-gradient-to-br ${
                    discountImpact.hasCostData && discountImpact.profitChange >= 0 ? 'from-emerald-500 to-emerald-600' : 
                    discountImpact.hasCostData && discountImpact.profitChange < 0 ? 'from-red-500 to-red-600' :
                    discountImpact.revenueChange >= 0 ? 'from-emerald-500 to-emerald-600' : 'from-red-500 to-red-600'
                  } text-white rounded-xl p-6`}>
                    <div className="text-sm opacity-90 mb-1">{discountImpact.hasCostData ? 'Profit Impact' : 'Revenue Impact'}</div>
                    <div className="text-3xl font-bold">
                      {discountImpact.hasCostData ? (
                        <>{discountImpact.profitChange >= 0 ? '+' : ''}{discountImpact.profitChange.toFixed(1)}%</>
                      ) : (
                        <>{discountImpact.revenueChange >= 0 ? '+' : ''}{discountImpact.revenueChange.toFixed(1)}%</>
                      )}
                    </div>
                    <div className="text-xs opacity-80 mt-1">
                      {discountImpact.hasCostData ? (
                        <>
                          {discountImpact.profitChange >= 0 ? 'üìà ' : 'üìâ '}
                          ${Math.abs(discountImpact.projectedProfit - discountImpact.currentProfit).toFixed(0)}
                        </>
                      ) : (
                        <>
                          {discountImpact.revenueChange >= 0 ? 'üìà ' : 'üìâ '}
                          ${Math.abs(discountImpact.projectedRevenue - discountImpact.currentRevenue).toFixed(0)}
                        </>
                      )}
                    </div>
                  </div>
                </div>

                {/* Sales Volume Card */}
                <div className="bg-gradient-to-br from-cyan-500 to-blue-500 text-white rounded-xl p-6 mb-6">
                  <div className="grid md:grid-cols-3 gap-6">
                    <div>
                      <div className="text-sm opacity-90 mb-1">Current Sales Volume</div>
                      <div className="text-3xl font-bold">{discountImpact.totalUnitsSold}</div>
                      <div className="text-xs opacity-80 mt-1">units per month</div>
                    </div>
                    <div>
                      <div className="text-sm opacity-90 mb-1">Projected Sales Volume</div>
                      <div className="text-3xl font-bold">{discountImpact.projectedUnitsSold}</div>
                      <div className="text-xs opacity-80 mt-1">
                        +{(discountImpact.projectedUnitsSold - discountImpact.totalUnitsSold)} units (+{discountImpact.assumedUplift}%)
                      </div>
                    </div>
                    <div>
                      <div className="text-sm opacity-90 mb-1">Revenue Change</div>
                      <div className="text-3xl font-bold">
                        {discountImpact.revenueChange >= 0 ? '+' : ''}{discountImpact.revenueChange.toFixed(1)}%
                      </div>
                      <div className="text-xs opacity-80 mt-1">
                        ${Math.abs(discountImpact.projectedRevenue - discountImpact.currentRevenue).toFixed(0)} change
                      </div>
                    </div>
                  </div>
                </div>

                {/* Warning for products without prices */}
                {discountImpact.productsWithoutPrices > 0 && (
                  <div className="bg-orange-50 border-l-4 border-orange-400 p-4 mb-6">
                    <div className="flex">
                      <div className="flex-shrink-0">
                        <svg className="h-5 w-5 text-orange-400" viewBox="0 0 20 20" fill="currentColor">
                          <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                      </div>
                      <div className="ml-3">
                        <p className="text-sm text-orange-700">
                          <strong>Note:</strong> {discountImpact.productsWithoutPrices} product{discountImpact.productsWithoutPrices > 1 ? 's' : ''} excluded from analysis because {discountImpact.productsWithoutPrices > 1 ? 'they have' : 'it has'} no price set. 
                          Add prices to these products in Shopify to include them in discount calculations.
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Warning for missing cost data */}
                {!discountImpact.hasCostData && (
                  <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div className="flex">
                      <div className="flex-shrink-0">
                        <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                          <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                      </div>
                      <div className="ml-3">
                        <p className="text-sm text-yellow-700">
                          <strong>Revenue-Only Forecast:</strong> No cost data available for these products. 
                          Showing revenue impact only. Add product costs to your system to see profit margins, 
                          profit impact, and break-even analysis.
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Profit Analysis (only shown when cost data exists) */}
                {discountImpact.hasCostData && (
                  <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 className="text-xl font-bold mb-4">üí∞ Detailed Profit Analysis</h3>
                    
                    <div className="grid md:grid-cols-4 gap-6 mb-6">
                      <div className="border-l-4 border-blue-500 pl-4">
                        <div className="text-sm text-gray-600 mb-1">Current Monthly Profit</div>
                        <div className="text-2xl font-bold text-blue-600">
                          ${discountImpact.currentProfit.toFixed(0)}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          Margin: {discountImpact.currentMargin.toFixed(1)}%
                        </div>
                      </div>

                      <div className="border-l-4 border-purple-500 pl-4">
                        <div className="text-sm text-gray-600 mb-1">Projected Monthly Profit</div>
                        <div className="text-2xl font-bold text-purple-600">
                          ${discountImpact.projectedProfit.toFixed(0)}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          Margin: {discountImpact.newMargin.toFixed(1)}%
                        </div>
                      </div>

                      <div className={`border-l-4 ${
                        discountImpact.profitChange >= 0 ? 'border-emerald-500' : 'border-red-500'
                      } pl-4`}>
                        <div className="text-sm text-gray-600 mb-1">Profit Change</div>
                        <div className={`text-2xl font-bold ${
                          discountImpact.profitChange >= 0 ? 'text-emerald-600' : 'text-red-600'
                        }`}>
                          {discountImpact.profitChange >= 0 ? '+' : ''}{discountImpact.profitChange.toFixed(1)}%
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          ${discountImpact.profitChange >= 0 ? '+' : '-'}
                          {Math.abs(discountImpact.projectedProfit - discountImpact.currentProfit).toFixed(0)}
                        </div>
                      </div>

                      <div className="border-l-4 border-emerald-500 pl-4">
                        <div className="text-sm text-gray-600 mb-1">Break-Even Units</div>
                        <div className="text-2xl font-bold text-emerald-600">
                          {discountImpact.breakEvenUnits}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">Additional sales needed</div>
                      </div>
                    </div>

                    {/* Yearly Projections */}
                    <div className="border-t pt-4">
                      <h4 className="font-semibold mb-3 text-gray-700">üìä Annual Projections</h4>
                      <div className="grid md:grid-cols-3 gap-4">
                        <div className="bg-blue-50 p-4 rounded-lg">
                          <div className="text-sm text-gray-600 mb-1">Current Annual Revenue</div>
                          <div className="text-xl font-bold text-blue-700">
                            ${(discountImpact.currentRevenue * 12).toFixed(0)}
                          </div>
                        </div>
                        <div className="bg-purple-50 p-4 rounded-lg">
                          <div className="text-sm text-gray-600 mb-1">Projected Annual Revenue</div>
                          <div className="text-xl font-bold text-purple-700">
                            ${(discountImpact.projectedRevenue * 12).toFixed(0)}
                          </div>
                        </div>
                        <div className={`${
                          discountImpact.profitChange >= 0 ? 'bg-emerald-50' : 'bg-red-50'
                        } p-4 rounded-lg`}>
                          <div className="text-sm text-gray-600 mb-1">Annual Profit Impact</div>
                          <div className={`text-xl font-bold ${
                            discountImpact.profitChange >= 0 ? 'text-emerald-700' : 'text-red-700'
                          }`}>
                            {discountImpact.profitChange >= 0 ? '+' : ''}
                            ${((discountImpact.projectedProfit - discountImpact.currentProfit) * 12).toFixed(0)}
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Assumptions Note */}
                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                      <p className="text-sm text-gray-700">
                        <strong>Assumptions:</strong> Projected revenue assumes a {discountImpact.assumedUplift}% increase in 
                        sales volume due to the discount. Actual results may vary based on market conditions and promotion effectiveness.
                      </p>
                    </div>
                  </div>
                )}

                {/* Affected Products List */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-xl font-bold mb-4">Affected Products ({discountImpact.affectedProducts.length})</h3>
                  
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-2 text-left text-sm font-semibold">Product</th>
                          <th className="px-4 py-2 text-left text-sm font-semibold">Current Price</th>
                          <th className="px-4 py-2 text-left text-sm font-semibold">New Price</th>
                          <th className="px-4 py-2 text-left text-sm font-semibold">Savings</th>
                          <th className="px-4 py-2 text-left text-sm font-semibold">Monthly Sales</th>
                          <th className="px-4 py-2 text-left text-sm font-semibold">Current Revenue</th>
                          {discountImpact.hasCostData && (
                            <th className="px-4 py-2 text-left text-sm font-semibold">Current Profit</th>
                          )}
                        </tr>
                      </thead>
                      <tbody className="divide-y">
                        {discountImpact.affectedProducts.slice(0, 20).map((product, idx) => {
                          const currentRevenue = product.currentPrice * product.monthlySales;
                          const currentProfit = product.cost !== null ? (product.currentPrice - product.cost) * product.monthlySales : null;
                          const currentMargin = product.cost !== null && product.currentPrice > 0 
                            ? ((product.currentPrice - product.cost) / product.currentPrice * 100) 
                            : null;
                          
                          return (
                            <tr key={idx} className="hover:bg-gray-50">
                              <td className="px-4 py-3">
                                <div className="font-medium">{product.name}</div>
                                <div className="text-sm text-gray-500">{product.vendor}</div>
                                <div className="text-xs text-gray-400">{product.sectionName}</div>
                              </td>
                              <td className="px-4 py-3 font-semibold">${product.currentPrice.toFixed(2)}</td>
                              <td className="px-4 py-3 text-emerald-600 font-semibold">
                                ${product.newPrice.toFixed(2)}
                              </td>
                              <td className="px-4 py-3 text-red-600 font-semibold">
                                -${product.savings.toFixed(2)}
                                <div className="text-xs text-gray-500">
                                  ({((product.savings / product.currentPrice) * 100).toFixed(0)}% off)
                                </div>
                              </td>
                              <td className="px-4 py-3">
                                <div className="font-semibold">{product.monthlySales || 0} units</div>
                                <div className="text-xs text-gray-500">per month</div>
                              </td>
                              <td className="px-4 py-3">
                                <div className="font-semibold">${currentRevenue.toFixed(0)}</div>
                                <div className="text-xs text-gray-500">monthly</div>
                              </td>
                              {discountImpact.hasCostData && currentProfit !== null && (
                                <td className="px-4 py-3">
                                  <div className="font-semibold text-blue-600">${currentProfit.toFixed(0)}</div>
                                  <div className="text-xs text-gray-500">{currentMargin.toFixed(1)}% margin</div>
                                </td>
                              )}
                              {discountImpact.hasCostData && currentProfit === null && (
                                <td className="px-4 py-3">
                                  <div className="text-xs text-gray-400">No cost data</div>
                                </td>
                              )}
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                    {discountImpact.affectedProducts.length > 20 && (
                      <p className="text-sm text-gray-500 mt-4 text-center">
                        Showing 20 of {discountImpact.affectedProducts.length} products
                      </p>
                    )}
                  </div>
                </div>
              </>
            )}

            {/* Feedback Message */}
            {feedback && (
              <div className="fixed bottom-6 right-6 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl">
                {feedback}
              </div>
            )}
          </div>
        </div>
      )}

      {/* ‚ö†Ô∏è UNKNOWN PRODUCTS PAGE */}
      {currentPage === 'unknownProducts' && (
        <div className="flex-1 overflow-auto p-8 bg-gray-50">
          <div className="mb-6">
            <h1 className="text-3xl font-bold mb-2">‚ö†Ô∏è Unknown Products</h1>
            <p className="text-gray-600">Products that need to be synced with Shopify</p>
          </div>

          {/* Analytics Cards */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Unknown</div>
              <div className="text-3xl font-bold text-orange-600">
                {unknownProducts.filter(u => !u.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Resolved</div>
              <div className="text-3xl font-bold text-green-600">
                {unknownProducts.filter(u => u.resolved).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">With Notes</div>
              <div className="text-3xl font-bold text-blue-600">
                {unknownProducts.filter(u => !u.resolved && u.note).length}
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow p-6">
              <div className="text-sm text-gray-600 mb-1">Total Store Products</div>
              <div className="text-3xl font-bold text-gray-800">
                {sections.reduce((total, section) => {
                  return total + (section.rows?.reduce((rowTotal, row) => {
                    return rowTotal + (row.products?.length || 0);
                  }, 0) || 0);
                }, 0)}
              </div>
              <div className="text-xs text-gray-500 mt-1">
                {((unknownProducts.filter(u => !u.resolved).length / Math.max(1, sections.reduce((total, section) => {
                  return total + (section.rows?.reduce((rowTotal, row) => {
                    return rowTotal + (row.products?.length || 0);
                  }, 0) || 0);
                }, 0))) * 100).toFixed(1)}% unsynced
              </div>
            </div>
          </div>

          {/* Actions Bar */}
          <div className="flex gap-2 mb-6">
            <button
              onClick={checkUnknownAgainstShopify}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-2"
            >
              <Icons.RefreshCw />
              Check All Against Shopify
            </button>
          </div>

          {/* Unknown Products List */}
          <div className="space-y-4">
            {unknownProducts.filter(u => !u.resolved).length === 0 ? (
              <div className="bg-white rounded-lg shadow p-8 text-center">
                <div className="text-4xl mb-4">üéâ</div>
                <div className="text-xl font-semibold text-gray-800">All products synced!</div>
                <div className="text-gray-600 mt-2">No unknown products found.</div>
              </div>
            ) : (
              unknownProducts.filter(u => !u.resolved).map(unknown => {
                // Find which section and row this product is in
                let location = null;
                sections.forEach(section => {
                  section.rows?.forEach(row => {
                    const product = row.products?.find(p => p.upc === unknown.upc);
                    if (product) {
                      location = { sectionName: section.name, rowName: row.name };
                    }
                  });
                });

                return (
                  <div key={unknown.id} className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-start gap-6">
                      {/* UPC & Location */}
                      <div className="flex-shrink-0">
                        <div className="text-sm text-gray-600 mb-1">UPC</div>
                        <div className="font-mono text-lg font-bold">{unknown.upc}</div>
                        {location && (
                          <div className="mt-2 text-xs text-gray-600">
                            üìç {location.sectionName} ‚Üí {location.rowName}
                          </div>
                        )}
                        <div className="text-xs text-gray-500 mt-1">
                          Added {new Date(unknown.addedAt).toLocaleDateString()}
                        </div>
                      </div>

                      {/* Note Field */}
                      <div className="flex-1">
                        <div className="text-sm text-gray-600 mb-1">Product Name / Notes</div>
                        <input
                          type="text"
                          value={unknown.note || ''}
                          onChange={(e) => updateUnknownProductNote(unknown.id, e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              e.preventDefault();
                              console.log('Enter pressed - saving immediately!');
                              saveToFirebase(sections);
                              setFeedback('üíæ Saved!');
                              setTimeout(() => setFeedback(''), 2000);
                            }
                          }}
                          placeholder="Enter product name or description..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      {/* Actions */}
                      <div className="flex-shrink-0 flex gap-2">
                        <button
                          onClick={checkUnknownAgainstShopify}
                          className="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-1"
                          title="Check if now in Shopify"
                        >
                          <Icons.RefreshCw />
                          Check
                        </button>
                        <button
                          onClick={() => deleteUnknownProduct(unknown.id)}
                          className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                          title="Delete"
                        >
                          <Icons.Trash2 />
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* Resolved Products */}
          {unknownProducts.filter(u => u.resolved).length > 0 && (
            <div className="mt-8">
              <h2 className="text-2xl font-bold mb-4">‚úÖ Recently Resolved</h2>
              <div className="space-y-2">
                {unknownProducts.filter(u => u.resolved).map(unknown => (
                  <div key={unknown.id} className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between">
                    <div className="flex-1">
                      <div className="font-semibold text-green-800">{unknown.matchedProduct?.name}</div>
                      <div className="text-sm text-gray-600">
                        UPC: {unknown.upc} ‚Ä¢ {unknown.matchedProduct?.vendor} ‚Ä¢ ${unknown.matchedProduct?.price}
                      </div>
                    </div>
                    <button
                      onClick={() => deleteUnknownProduct(unknown.id)}
                      className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                    >
                      Remove
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

    try {
      console.log('üöÄ Initializing Store Planner Pro...');
      const root = createRoot(document.getElementById('root'));
      console.log('‚úÖ React root created');
      root.render(<PlanogramProfitTracker />);
      console.log('‚úÖ App rendered successfully');
    } catch (error) {
      console.error('‚ùå FATAL ERROR:', error);
      console.error('Stack:', error.stack);
      document.getElementById('root').innerHTML = `
        <div style="padding: 40px; font-family: sans-serif; max-width: 800px; margin: 0 auto;">
          <h1 style="color: #ef4444; margin-bottom: 20px;">‚ö†Ô∏è Application Error</h1>
          <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 16px; margin-bottom: 20px;">
            <p style="margin: 0; color: #991b1b;"><strong>Error:</strong> ${error.message}</p>
          </div>
          <details style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
            <summary style="cursor: pointer; font-weight: bold; margin-bottom: 10px;">Stack Trace</summary>
            <pre style="overflow: auto; font-size: 12px; line-height: 1.5;">${error.stack}</pre>
          </details>
          <p style="margin-top: 20px; color: #6b7280;">Open the browser console (F12) for more details.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
