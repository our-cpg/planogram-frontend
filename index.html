<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Planogram Profit Tracker - Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

// Custom Icons
const Icons = {
  Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
  Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
  Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
  Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
  Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
  Package: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
  BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
  DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
  Maximize2: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
  Grid3x3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
  Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>,
  Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
  AlignVertical: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="16" width="14" height="6" rx="2"></rect><rect x="7" y="2" width="10" height="6" rx="2"></rect><path d="M2 12h20"></path></svg>,
  Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
  Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
  Flame: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>
};

// Fixture type definitions
const FIXTURE_TYPES = {
  GRID_WALL: {
    id: 'grid_wall',
    name: 'Grid Wall',
    icon: 'Grid3x3',
    color: '#64748b',
    defaultWidth: 120,
    defaultHeight: 200
  },
  JEWELRY_CASE: {
    id: 'jewelry_case',
    name: 'Jewelry Case',
    icon: 'Box',
    color: '#8b5cf6',
    defaultWidth: 80,
    defaultHeight: 60
  },
  GONDOLA: {
    id: 'gondola',
    name: 'Gondola',
    icon: 'Layers',
    color: '#f59e0b',
    defaultWidth: 160,
    defaultHeight: 120
  },
  SLAT_WALL: {
    id: 'slat_wall',
    name: 'Slat Wall',
    icon: 'AlignVertical',
    color: '#10b981',
    defaultWidth: 140,
    defaultHeight: 200
  },
  ENDCAP: {
    id: 'endcap',
    name: 'End Cap',
    icon: 'Package',
    color: '#ef4444',
    defaultWidth: 80,
    defaultHeight: 120
  }
};

const PlanogramProfitTracker = () => {
  const [sections, setSections] = useState([]);
  const [selectedSection, setSelectedSection] = useState(null);
  const [scale, setScale] = useState(20);
  const [storeName, setStoreName] = useState('My Store Layout');
  const [newProduct, setNewProduct] = useState({ upc: '' });
  const [savedLayouts, setSavedLayouts] = useState([]);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [showLoadModal, setShowLoadModal] = useState(false);
  const [feedback, setFeedback] = useState('');
  const [timeFilter, setTimeFilter] = useState('monthly');
  const [sortBy, setSortBy] = useState('profit');
  const [showSettings, setShowSettings] = useState(false);
  const [shopifyConfig, setShopifyConfig] = useState({
    storeName: '1m3tfh-xt.myshopify.com',
    accessToken: '',
    connected: false
  });
  
  // NEW FEATURES STATE
  const [showLibrary, setShowLibrary] = useState(true);
  const [heatMapMode, setHeatMapMode] = useState(false);
  const [backgroundImage, setBackgroundImage] = useState(null);
  const fileInputRef = useRef(null);
  const [zoom, setZoom] = useState(1);
  const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
  const canvasRef = useRef(null);
  
  const BACKEND_URL = 'https://planogram-backend-gx85.onrender.com';
  
  const productDatabase = {
    '123456789012': { name: 'Premium Coffee Beans', price: 24.99, cost: 12.50, monthlySales: 145 },
    '234567890123': { name: 'Organic Tea Set', price: 18.99, cost: 9.00, monthlySales: 89 },
    '345678901234': { name: 'Artisan Chocolate', price: 12.99, cost: 6.50, monthlySales: 234 },
    '456789012345': { name: 'Gourmet Cookies', price: 8.99, cost: 4.00, monthlySales: 312 },
    '567890123456': { name: 'Specialty Honey', price: 15.99, cost: 7.50, monthlySales: 67 },
  };

  useEffect(() => {
    const layouts = JSON.parse(localStorage.getItem('planogramLayouts') || '[]');
    setSavedLayouts(layouts);
    
    const savedToken = localStorage.getItem('shopifyAccessToken');
    if (savedToken) {
      setShopifyConfig({
        storeName: '1m3tfh-xt.myshopify.com',
        accessToken: savedToken,
        connected: false
      });
    }
    
    const lastLayout = localStorage.getItem('currentLayout');
    if (lastLayout) {
      const parsed = JSON.parse(lastLayout);
      setSections(parsed.sections || []);
      setStoreName(parsed.name || 'My Store Layout');
    }
  }, []);

  useEffect(() => {
    const autoSave = setInterval(() => {
      if (sections.length > 0) {
        const layout = { name: storeName, sections, savedAt: new Date().toISOString() };
        localStorage.setItem('currentLayout', JSON.stringify(layout));
      }
    }, 30000);

    return () => clearInterval(autoSave);
  }, [sections, storeName]);

  // NEW: Zoom and pan functionality
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const handleWheel = (e) => {
      e.preventDefault();
      
      // Check if it's a pinch gesture (ctrlKey is set for trackpad pinch)
      if (e.ctrlKey) {
        // Pinch to zoom
        const delta = -e.deltaY;
        const zoomFactor = delta > 0 ? 1.1 : 0.9;
        const newZoom = Math.min(Math.max(0.1, zoom * zoomFactor), 3);
        setZoom(newZoom);
      } else {
        // Pan with two-finger scroll
        setPanOffset({
          x: panOffset.x - e.deltaX,
          y: panOffset.y - e.deltaY
        });
      }
    };

    canvas.addEventListener('wheel', handleWheel, { passive: false });

    return () => {
      canvas.removeEventListener('wheel', handleWheel);
    };
  }, [zoom, panOffset]);

  const saveLayout = () => {
    const layout = {
      id: Date.now(),
      name: storeName,
      sections: sections,
      savedAt: new Date().toISOString()
    };
    
    const layouts = [...savedLayouts, layout];
    setSavedLayouts(layouts);
    localStorage.setItem('planogramLayouts', JSON.stringify(layouts));
    localStorage.setItem('currentLayout', JSON.stringify(layout));
    setShowSaveModal(false);
    setFeedback('✅ Layout saved successfully!');
    setTimeout(() => setFeedback(''), 3000);
  };

  const loadLayout = (layout) => {
    setSections(layout.sections);
    setStoreName(layout.name);
    setShowLoadModal(false);
    localStorage.setItem('currentLayout', JSON.stringify(layout));
  };

  const deleteLayout = (id) => {
    const layouts = savedLayouts.filter(l => l.id !== id);
    setSavedLayouts(layouts);
    localStorage.setItem('planogramLayouts', JSON.stringify(layouts));
  };

  const exportLayout = () => {
    const layout = { name: storeName, sections, exportedAt: new Date().toISOString() };
    const dataStr = JSON.stringify(layout, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${storeName.replace(/\s+/g, '_')}_layout.json`;
    link.click();
  };

  const importLayout = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const layout = JSON.parse(e.target.result);
          setSections(layout.sections || []);
          setStoreName(layout.name || 'Imported Layout');
        } catch (error) {
          setFeedback('⚠️ Error importing layout');
          setTimeout(() => setFeedback(''), 3000);
        }
      };
      reader.readAsText(file);
    }
  };

  // NEW: Add fixture from library
  const addFixtureFromLibrary = (fixtureType) => {
    const type = FIXTURE_TYPES[fixtureType];
    const newSection = {
      id: Date.now(),
      x: 50,
      y: 50,
      width: type.defaultWidth,
      height: type.defaultHeight,
      name: `${type.name} ${sections.length + 1}`,
      fixtureType: fixtureType,
      products: [],
      salesData: Math.floor(Math.random() * 5000) + 1000
    };
    setSections([...sections, newSection]);
    setFeedback(`✅ Added ${type.name}!`);
    setTimeout(() => setFeedback(''), 2000);
  };

  const addSection = () => {
    const newSection = {
      id: Date.now(),
      x: 50,
      y: 50,
      width: 100,
      height: 100,
      name: `Section ${sections.length + 1}`,
      products: [],
      salesData: Math.floor(Math.random() * 5000) + 1000
    };
    setSections([...sections, newSection]);
  };

  // NEW: Handle background image upload
  const handleBackgroundUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        setBackgroundImage(e.target.result);
        setFeedback('✅ Background uploaded!');
        setTimeout(() => setFeedback(''), 2000);
      };
      reader.readAsDataURL(file);
    }
  };

  const deleteSection = (id) => {
    setSections(sections.filter(s => s.id !== id));
    if (selectedSection?.id === id) setSelectedSection(null);
  };

  const updateSection = (id, updates) => {
    setSections(sections.map(s => s.id === id ? { ...s, ...updates } : s));
    if (selectedSection?.id === id) {
      setSelectedSection({ ...selectedSection, ...updates });
    }
  };

  const handleUPCChange = (value) => {
    setNewProduct({ upc: value });
  };

  // KEEP EXACT WORKING API CALLS
  const testShopifyConnection = async () => {
    if (!shopifyConfig.accessToken) {
      setFeedback('⚠️ Please enter access token');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('🔄 Testing connection...');
    console.log('Testing Shopify connection...', { storeName: shopifyConfig.storeName });

    try {
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'test'
        })
      });

      console.log('Test response status:', response.status);
      const data = await response.json();
      console.log('Test response data:', data);

      if (response.ok && data.success) {
        localStorage.setItem('shopifyAccessToken', shopifyConfig.accessToken);
        
        setShopifyConfig({ ...shopifyConfig, connected: true });
        setFeedback(`✅ Connected to ${data.shopName}!`);
        setTimeout(() => setFeedback(''), 3000);
        setShowSettings(false);
      } else {
        throw new Error(data.error || 'Invalid credentials');
      }
    } catch (error) {
      console.error('Connection error:', error);
      setFeedback(`❌ ${error.message}`);
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  // NEW: Refresh product cache on backend
  const refreshProductCache = async () => {
    if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
      setFeedback('⚠️ Connect to Shopify first');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('🔄 Refreshing product cache...');
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/shopify`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          storeName: shopifyConfig.storeName,
          accessToken: shopifyConfig.accessToken,
          action: 'refreshCache'
        })
      });

      const data = await response.json();
      console.log('Cache refresh response:', data);

      if (response.ok && data.success) {
        setFeedback(`✅ Cache refreshed! ${data.productsLoaded || 1000} products loaded`);
        setTimeout(() => setFeedback(''), 5000);
      } else {
        throw new Error(data.error || 'Failed to refresh cache');
      }
    } catch (error) {
      console.error('Cache refresh error:', error);
      setFeedback(`❌ ${error.message}`);
      setTimeout(() => setFeedback(''), 5000);
    }
  };

  const addProductToSection = async () => {
    if (!selectedSection) {
      setFeedback('⚠️ Please select a section first!');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }
    
    if (!newProduct.upc || newProduct.upc.trim() === '') {
      setFeedback('⚠️ Please enter a UPC code');
      setTimeout(() => setFeedback(''), 3000);
      return;
    }

    setFeedback('🔄 Looking up product...');
    console.log('Starting product lookup for UPC:', newProduct.upc);
    
    let product = null;
    
    if (shopifyConfig.connected) {
      console.log('Shopify is connected, attempting fetch...');
      try {
        const response = await fetch(`${BACKEND_URL}/api/shopify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            storeName: shopifyConfig.storeName,
            accessToken: shopifyConfig.accessToken,
            action: 'getProduct',
            upc: newProduct.upc
          })
        });

        console.log('Shopify API response status:', response.status);
        const data = await response.json();
        console.log('Shopify API response data:', data);

        if (response.ok && data.success && data.product) {
          product = {
            upc: newProduct.upc,
            name: data.product.name,
            price: data.product.price,
            cost: data.product.cost,
            monthlySales: data.product.monthlySales || 0,
            quantity: 1,
            source: 'shopify'
          };
          console.log('Product found in Shopify:', product);
          setFeedback(`✅ Added from Shopify: ${product.name}`);
        } else {
          console.log('Product not found in Shopify, trying local database');
        }
      } catch (error) {
        console.error('Error fetching from Shopify:', error);
        setFeedback('⚠️ Shopify lookup failed, trying local data...');
        setTimeout(() => setFeedback(''), 3000);
      }
    } else {
      console.log('Shopify not connected, skipping Shopify lookup');
    }
    
    if (!product && productDatabase[newProduct.upc]) {
      product = { 
        upc: newProduct.upc, 
        ...productDatabase[newProduct.upc],
        quantity: 1,
        source: 'sample'
      };
      console.log('Product found in local database:', product);
      setFeedback(`✅ Added: ${product.name} (Sample Data)`);
    }
    
    if (!product) {
      product = {
        upc: newProduct.upc,
        name: `Product ${newProduct.upc.slice(-4)}`,
        price: 0,
        cost: 0,
        monthlySales: 0,
        quantity: 1,
        placeholder: true,
        source: 'placeholder'
      };
      console.log('Created placeholder product:', product);
      setFeedback(`✅ Added UPC ${newProduct.upc} (Connect Shopify for details)`);
    }

    const updatedProducts = [...(selectedSection.products || []), product];
    updateSection(selectedSection.id, { products: updatedProducts });
    setNewProduct({ upc: '' });
    
    setTimeout(() => setFeedback(''), 3000);
  };

  const calculateMetrics = (section) => {
    const area = (section.width * section.height) / (scale * scale);
    
    const timeMultipliers = {
      daily: 1 / 30,
      weekly: 7 / 30,
      monthly: 1,
      quarterly: 3,
      yearly: 12
    };
    
    const multiplier = timeMultipliers[timeFilter];
    
    let productMetrics = section.products.map(p => {
      const unitProfit = p.price - p.cost;
      const periodVolume = (p.monthlySales || 0) * multiplier;
      const periodRevenue = p.price * periodVolume;
      const periodProfit = unitProfit * periodVolume;
      
      return {
        ...p,
        unitProfit,
        periodVolume,
        periodRevenue,
        periodProfit,
        velocity: p.monthlySales || 0
      };
    });
    
    productMetrics.sort((a, b) => {
      switch(sortBy) {
        case 'profit':
          return b.periodProfit - a.periodProfit;
        case 'sales':
          return b.periodRevenue - a.periodRevenue;
        case 'velocity':
          return b.velocity - a.velocity;
        case 'volume':
          return b.periodVolume - a.periodVolume;
        case 'name':
          return a.name.localeCompare(b.name);
        default:
          return 0;
      }
    });
    
    const totalRevenue = productMetrics.reduce((sum, p) => sum + p.periodRevenue, 0);
    const totalCost = productMetrics.reduce((sum, p) => sum + (p.cost * p.periodVolume), 0);
    const totalProfit = productMetrics.reduce((sum, p) => sum + p.periodProfit, 0);
    const totalVolume = productMetrics.reduce((sum, p) => sum + p.periodVolume, 0);
    const totalVelocity = productMetrics.reduce((sum, p) => sum + p.velocity, 0);
    const profitPerSqFt = area > 0 ? totalProfit / area : 0;

    return { 
      area, 
      totalRevenue, 
      totalCost, 
      totalProfit, 
      profitPerSqFt,
      totalVelocity,
      totalVolume,
      productMetrics
    };
  };

  // NEW: Heat map color calculation
  const getHeatMapColor = (profitPerSqFt) => {
    if (!heatMapMode) return null;
    const profit = profitPerSqFt || 0;
    if (profit > 200) return 'rgba(16, 185, 129, 0.7)'; // Green
    if (profit > 100) return 'rgba(132, 204, 22, 0.7)'; // Lime
    if (profit > 50) return 'rgba(251, 191, 36, 0.7)'; // Yellow
    if (profit > 25) return 'rgba(249, 115, 22, 0.7)'; // Orange
    return 'rgba(239, 68, 68, 0.7)'; // Red
  };

  // NEW: Render fixture with unique visuals
  const renderFixtureVisual = (section) => {
    const fixtureType = section.fixtureType;
    if (!fixtureType) return null;

    const style = {
      position: 'absolute',
      inset: 0,
      pointerEvents: 'none',
      opacity: 0.3
    };

    switch(fixtureType) {
      case 'GRID_WALL':
        return (
          <div style={style}>
            <svg width="100%" height="100%" style={{position: 'absolute'}}>
              {Array.from({length: 5}).map((_, i) => (
                <line key={`h${i}`} x1="0" y1={`${(i+1)*20}%`} x2="100%" y2={`${(i+1)*20}%`} stroke="#64748b" strokeWidth="1"/>
              ))}
              {Array.from({length: 5}).map((_, i) => (
                <line key={`v${i}`} x1={`${(i+1)*20}%`} y1="0" x2={`${(i+1)*20}%`} y2="100%" stroke="#64748b" strokeWidth="1"/>
              ))}
            </svg>
          </div>
        );
      case 'GONDOLA':
        return (
          <div style={style}>
            {Array.from({length: 4}).map((_, i) => (
              <div key={i} style={{
                position: 'absolute',
                left: '10%',
                right: '10%',
                top: `${(i+1)*20}%`,
                height: '2px',
                backgroundColor: '#f59e0b'
              }}/>
            ))}
          </div>
        );
      case 'SLAT_WALL':
        return (
          <div style={style}>
            {Array.from({length: 8}).map((_, i) => (
              <div key={i} style={{
                position: 'absolute',
                left: 0,
                right: 0,
                top: `${(i+1)*10}%`,
                height: '3px',
                backgroundColor: '#10b981'
              }}/>
            ))}
          </div>
        );
      case 'JEWELRY_CASE':
        return (
          <div style={{...style, opacity: 0.2}}>
            <div style={{
              position: 'absolute',
              inset: '10%',
              border: '2px solid #8b5cf6',
              borderRadius: '4px',
              background: 'linear-gradient(135deg, transparent 25%, rgba(139, 92, 246, 0.1) 25%, rgba(139, 92, 246, 0.1) 50%, transparent 50%, transparent 75%, rgba(139, 92, 246, 0.1) 75%)',
              backgroundSize: '20px 20px'
            }}/>
          </div>
        );
      case 'ENDCAP':
        return (
          <div style={style}>
            {Array.from({length: 3}).map((_, i) => (
              <div key={i} style={{
                position: 'absolute',
                left: '15%',
                right: '15%',
                top: `${(i+1)*25}%`,
                height: '2px',
                backgroundColor: '#ef4444'
              }}/>
            ))}
          </div>
        );
      default:
        return null;
    }
  };

  const DraggableSection = ({ section }) => {
    const [dragging, setDragging] = useState(false);
    const [resizing, setResizing] = useState(false);
    const [offset, setOffset] = useState({ x: 0, y: 0 });
    
    const metrics = calculateMetrics(section);
    const isSelected = selectedSection?.id === section.id;
    const fixtureType = section.fixtureType ? FIXTURE_TYPES[section.fixtureType] : null;

    const handleMouseDown = (e) => {
      if (e.target.classList.contains('resize-handle')) {
        setResizing(true);
      } else {
        setDragging(true);
        setOffset({
          x: e.clientX - section.x,
          y: e.clientY - section.y
        });
      }
      setSelectedSection(section);
    };

    useEffect(() => {
      const handleMouseMove = (e) => {
        if (dragging) {
          updateSection(section.id, {
            x: Math.max(0, e.clientX - offset.x),
            y: Math.max(0, e.clientY - offset.y)
          });
        } else if (resizing) {
          updateSection(section.id, {
            width: Math.max(50, e.clientX - section.x),
            height: Math.max(50, e.clientY - section.y)
          });
        }
      };

      const handleMouseUp = () => {
        setDragging(false);
        setResizing(false);
      };

      if (dragging || resizing) {
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      }

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }, [dragging, resizing, offset]);

    const heatColor = getHeatMapColor(metrics.profitPerSqFt);
    const defaultBgColor = metrics.profitPerSqFt > 100 ? '#dcfce7' : 
                          metrics.profitPerSqFt > 50 ? '#fef9c3' : '#fee2e2';

    return (
      <div
        style={{
          position: 'absolute',
          left: section.x,
          top: section.y,
          width: section.width,
          height: section.height,
          border: isSelected ? `3px solid ${fixtureType?.color || '#3b82f6'}` : '2px solid #94a3b8',
          backgroundColor: heatColor || defaultBgColor,
          cursor: dragging ? 'grabbing' : 'grab',
          borderRadius: '8px',
          padding: '8px',
          boxShadow: isSelected ? `0 4px 12px ${fixtureType?.color || '#3b82f6'}40` : '0 2px 4px rgba(0,0,0,0.1)',
          transition: 'all 0.2s'
        }}
        onMouseDown={handleMouseDown}
      >
        {renderFixtureVisual(section)}
        
        <div className="text-xs font-bold text-gray-700 mb-1 relative z-10">
          {section.name}
        </div>
        <div className="text-xs text-gray-600 relative z-10">
          {metrics.area.toFixed(0)} sq ft
        </div>
        <div className="text-xs font-semibold text-green-700 mt-1 relative z-10">
          ${metrics.profitPerSqFt.toFixed(0)}/sq ft
        </div>
        <div
          className="resize-handle"
          style={{
            position: 'absolute',
            right: 0,
            bottom: 0,
            width: '20px',
            height: '20px',
            cursor: 'nwse-resize',
            backgroundColor: fixtureType?.color || '#3b82f6',
            borderRadius: '0 0 8px 0',
            zIndex: 10
          }}
        />
      </div>
    );
  };

  return (
    <div className="flex h-screen bg-gray-50">
      {showSettings && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-96">
            <h2 className="text-xl font-bold mb-4">🛍️ Shopify Connection</h2>
            
            {shopifyConfig.connected ? (
              <div className="space-y-4">
                <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                  <div className="text-green-800 font-semibold mb-2">✅ Connected!</div>
                  <div className="text-sm text-green-700">Store: {shopifyConfig.storeName}</div>
                </div>
                <button
                  onClick={() => {
                    localStorage.removeItem('shopifyAccessToken');
                    setShopifyConfig({ storeName: '1m3tfh-xt.myshopify.com', accessToken: '', connected: false });
                    setFeedback('Disconnected from Shopify');
                    setTimeout(() => setFeedback(''), 3000);
                  }}
                  className="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                >
                  Disconnect
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-800">
                  <strong>Note:</strong> Just enter your Admin API Access Token below.
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Admin API Access Token
                  </label>
                  <input
                    type="password"
                    value={shopifyConfig.accessToken}
                    onChange={(e) => setShopifyConfig({...shopifyConfig, accessToken: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm font-mono"
                    placeholder="shpat_..."
                  />
                </div>
                
                <button
                  onClick={testShopifyConnection}
                  className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
                >
                  Test Connection
                </button>
              </div>
            )}
            
            <button
              onClick={() => setShowSettings(false)}
              className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 mt-4"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {showSaveModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-96">
            <h2 className="text-xl font-bold mb-4">Save Layout</h2>
            <input
              type="text"
              value={storeName}
              onChange={(e) => setStoreName(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg mb-4"
              placeholder="Layout name"
            />
            <div className="flex gap-2">
              <button
                onClick={saveLayout}
                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
              >
                Save
              </button>
              <button
                onClick={() => setShowSaveModal(false)}
                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {showLoadModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-96 max-h-96 overflow-y-auto">
            <h2 className="text-xl font-bold mb-4">Load Layout</h2>
            {savedLayouts.length === 0 ? (
              <p className="text-gray-600 text-center py-4">No saved layouts yet</p>
            ) : (
              <div className="space-y-2">
                {savedLayouts.map(layout => (
                  <div key={layout.id} className="border rounded-lg p-3 flex justify-between items-center">
                    <div>
                      <div className="font-semibold">{layout.name}</div>
                      <div className="text-xs text-gray-600">
                        {new Date(layout.savedAt).toLocaleString()}
                      </div>
                      <div className="text-xs text-gray-500">
                        {layout.sections.length} sections
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => loadLayout(layout)}
                        className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                      >
                        Load
                      </button>
                      <button
                        onClick={() => deleteLayout(layout.id)}
                        className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
            <button
              onClick={() => setShowLoadModal(false)}
              className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 mt-4"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* NEW: Fixture Library Sidebar */}
      {showLibrary && (
        <div className="w-64 bg-white shadow-lg p-4 overflow-y-auto border-r-2 border-gray-200">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-bold text-gray-800">Fixture Library</h2>
            <button
              onClick={() => setShowLibrary(false)}
              className="text-gray-500 hover:text-gray-700"
            >
              ✕
            </button>
          </div>

          <div className="space-y-2 mb-6">
            {Object.entries(FIXTURE_TYPES).map(([key, type]) => {
              const IconComponent = Icons[type.icon];
              return (
                <button
                  key={key}
                  onClick={() => addFixtureFromLibrary(key)}
                  className="w-full flex items-center gap-3 p-3 rounded-lg border-2 hover:shadow-md transition-all"
                  style={{ 
                    borderColor: type.color + '40',
                    backgroundColor: type.color + '10'
                  }}
                >
                  <div style={{ color: type.color }}>
                    <IconComponent />
                  </div>
                  <span className="font-medium text-gray-700 text-sm">{type.name}</span>
                </button>
              );
            })}
          </div>

          <div className="border-t pt-4">
            <h3 className="text-sm font-semibold text-gray-700 mb-2">Quick Add</h3>
            <button
              onClick={addSection}
              className="w-full bg-gray-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-700 text-sm"
            >
              <Icons.Plus />
              Basic Section
            </button>
          </div>
        </div>
      )}

      <div className={`${showLibrary ? 'w-80' : 'w-96'} bg-white shadow-lg p-6 overflow-y-auto transition-all`}>
        <h1 className="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
          <Icons.BarChart3 />
          Store Planner Pro
          {shopifyConfig.connected && (
            <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
              Shopify ✓
            </span>
          )}
        </h1>
        
        {feedback && (
          <div className="bg-blue-100 border-2 border-blue-400 text-blue-800 px-3 py-2 rounded-lg text-sm font-semibold mb-3 animate-pulse">
            {feedback}
          </div>
        )}
        
        <input
          type="text"
          value={storeName}
          onChange={(e) => setStoreName(e.target.value)}
          className="w-full px-3 py-2 border rounded-lg mb-4 text-sm"
          placeholder="Store layout name"
        />

        {/* NEW: View Controls */}
        <div className="grid grid-cols-2 gap-2 mb-4">
          <button
            onClick={() => setShowLibrary(!showLibrary)}
            className="bg-purple-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-purple-700 text-sm"
          >
            <Icons.Grid3x3 />
            {showLibrary ? 'Hide' : 'Show'} Library
          </button>
          <button
            onClick={() => setHeatMapMode(!heatMapMode)}
            className={`${heatMapMode ? 'bg-orange-600' : 'bg-gray-600'} text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 text-sm`}
          >
            <Icons.Flame />
            Heat Map
          </button>
        </div>

        {/* NEW: Zoom Controls */}
        <div className="bg-gray-100 rounded-lg p-3 mb-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-xs font-semibold text-gray-700">Zoom: {(zoom * 100).toFixed(0)}%</span>
            <button
              onClick={() => {
                setZoom(1);
                setPanOffset({ x: 0, y: 0 });
              }}
              className="text-xs bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-700"
            >
              Reset
            </button>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setZoom(Math.max(0.1, zoom - 0.1))}
              className="flex-1 bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700"
            >
              −
            </button>
            <button
              onClick={() => setZoom(Math.min(3, zoom + 0.1))}
              className="flex-1 bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700"
            >
              +
            </button>
          </div>
          <div className="text-xs text-gray-500 mt-2 text-center">
            Pinch trackpad to zoom
          </div>
        </div>

        <div className="grid grid-cols-2 gap-2 mb-4">
          <button
            onClick={() => setShowSaveModal(true)}
            className="bg-green-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-green-700 text-sm"
          >
            <Icons.Save />
            Save
          </button>
          <button
            onClick={() => setShowLoadModal(true)}
            className="bg-purple-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-purple-700 text-sm"
          >
            <Icons.Upload />
            Load
          </button>
        </div>

        <button
          onClick={() => setShowSettings(true)}
          className={`w-full ${shopifyConfig.connected ? 'bg-green-600' : 'bg-blue-600'} text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 text-sm mb-4`}
        >
          🛍️ {shopifyConfig.connected ? 'Shopify Connected' : 'Connect Shopify'}
        </button>

        <div className="grid grid-cols-2 gap-2 mb-4">
          <button
            onClick={exportLayout}
            className="bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 text-sm"
          >
            <Icons.Download />
            Export
          </button>
          <label className="bg-orange-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-orange-700 text-sm cursor-pointer">
            <Icons.Upload />
            Import
            <input
              type="file"
              accept=".json"
              onChange={importLayout}
              className="hidden"
            />
          </label>
        </div>

        {/* NEW: Background Image Upload */}
        <div className="mb-6">
          <label className="w-full bg-indigo-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-indigo-700 text-sm cursor-pointer">
            <Icons.Camera />
            {backgroundImage ? 'Change Background' : 'Add Background Photo'}
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handleBackgroundUpload}
              className="hidden"
            />
          </label>
          {backgroundImage && (
            <button
              onClick={() => {
                setBackgroundImage(null);
                setFeedback('Background removed');
                setTimeout(() => setFeedback(''), 2000);
              }}
              className="w-full mt-2 bg-gray-400 text-white px-3 py-2 rounded-lg text-xs hover:bg-gray-500"
            >
              Remove Background
            </button>
          )}
        </div>

        {selectedSection ? (
          <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-gray-800">
                ✓ Selected: {selectedSection.name}
              </h2>
              <button
                onClick={() => deleteSection(selectedSection.id)}
                className="text-red-600 hover:text-red-800"
              >
                <Icons.Trash2 />
              </button>
            </div>

            <input
              type="text"
              value={selectedSection.name}
              onChange={(e) => updateSection(selectedSection.id, { name: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg mb-4"
              placeholder="Section name"
            />

            <div className="space-y-3 mb-4 bg-white p-3 rounded-lg">
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">
                  Square Footage
                </label>
                <input
                  type="number"
                  value={calculateMetrics(selectedSection).area.toFixed(1)}
                  onChange={(e) => {
                    const newArea = parseFloat(e.target.value) || 0;
                    const currentAspectRatio = selectedSection.width / selectedSection.height;
                    const newWidth = Math.sqrt(newArea * scale * scale * currentAspectRatio);
                    const newHeight = newWidth / currentAspectRatio;
                    updateSection(selectedSection.id, {
                      width: Math.round(newWidth),
                      height: Math.round(newHeight)
                    });
                  }}
                  className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-semibold"
                  placeholder="Square feet"
                  step="0.1"
                  min="0"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="text-xs font-semibold text-gray-700 block mb-1">
                    Width (px)
                  </label>
                  <input
                    type="number"
                    value={selectedSection.width}
                    onChange={(e) => updateSection(selectedSection.id, { 
                      width: Math.max(50, parseInt(e.target.value) || 50)
                    })}
                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    min="50"
                  />
                </div>
                <div>
                  <label className="text-xs font-semibold text-gray-700 block mb-1">
                    Height (px)
                  </label>
                  <input
                    type="number"
                    value={selectedSection.height}
                    onChange={(e) => updateSection(selectedSection.id, { 
                      height: Math.max(50, parseInt(e.target.value) || 50)
                    })}
                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    min="50"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="text-xs font-semibold text-gray-700 block mb-1">
                    X Position
                  </label>
                  <input
                    type="number"
                    value={selectedSection.x}
                    onChange={(e) => updateSection(selectedSection.id, { 
                      x: Math.max(0, parseInt(e.target.value) || 0)
                    })}
                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    min="0"
                  />
                </div>
                <div>
                  <label className="text-xs font-semibold text-gray-700 block mb-1">
                    Y Position
                  </label>
                  <input
                    type="number"
                    value={selectedSection.y}
                    onChange={(e) => updateSection(selectedSection.id, { 
                      y: Math.max(0, parseInt(e.target.value) || 0)
                    })}
                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    min="0"
                  />
                </div>
              </div>
            </div>

            <h3 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <Icons.Package />
              Scan Product UPC
            </h3>

            <div className="space-y-2">
              <input
                type="text"
                value={newProduct.upc}
                onChange={(e) => handleUPCChange(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    addProductToSection();
                  }
                }}
                className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm font-mono"
                placeholder="Scan UPC here..."
              />
              <button
                onClick={addProductToSection}
                className="w-full bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700"
              >
                Add to Section
              </button>
              <div className="text-xs text-gray-500 italic">
                {shopifyConfig.connected ? 'Will fetch from Shopify' : 'Connect Shopify for live data'}
              </div>
            </div>

            {selectedSection.products && selectedSection.products.length > 0 && (
              <div className="mt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-semibold text-gray-700">Products in Section</h4>
                </div>
                
                <div className="mb-3 p-3 bg-gray-50 rounded-lg space-y-2">
                  <div>
                    <label className="text-xs font-semibold text-gray-700 block mb-1">
                      Time Period
                    </label>
                    <select
                      value={timeFilter}
                      onChange={(e) => setTimeFilter(e.target.value)}
                      className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    >
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                      <option value="quarterly">Quarterly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="text-xs font-semibold text-gray-700 block mb-1">
                      Sort By
                    </label>
                    <select
                      value={sortBy}
                      onChange={(e) => setSortBy(e.target.value)}
                      className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    >
                      <option value="profit">Highest Profit</option>
                      <option value="sales">Highest Sales</option>
                      <option value="volume">Highest Volume</option>
                      <option value="velocity">Fastest Moving</option>
                      <option value="name">Product Name</option>
                    </select>
                  </div>
                </div>
                
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {(() => {
                    const metrics = calculateMetrics(selectedSection);
                    return metrics.productMetrics.map((product, idx) => (
                      <div key={idx} className="text-xs bg-white p-3 rounded border">
                        <div className="font-medium flex items-center gap-2 mb-1">
                          {product.name}
                          {product.source === 'shopify' && (
                            <span className="text-green-600 text-xs">🛍️ Shopify</span>
                          )}
                          {product.source === 'sample' && (
                            <span className="text-blue-600 text-xs">📦 Sample</span>
                          )}
                          {product.placeholder && (
                            <span className="text-orange-600 text-xs">⚠ Placeholder</span>
                          )}
                        </div>
                        <div className="text-gray-600 font-mono text-xs mb-2">
                          UPC: {product.upc}
                        </div>
                        {!product.placeholder && (
                          <div className="grid grid-cols-2 gap-1 text-xs">
                            <div className="text-gray-700">
                              <span className="font-semibold">Price:</span> ${product.price.toFixed(2)}
                            </div>
                            <div className="text-gray-700">
                              <span className="font-semibold">Cost:</span> ${product.cost.toFixed(2)}
                            </div>
                            <div className="text-green-700">
                              <span className="font-semibold">Profit/Unit:</span> ${product.unitProfit.toFixed(2)}
                            </div>
                            <div className="text-orange-700 font-bold">
                              <span className="font-semibold">Volume:</span> {Math.round(product.periodVolume)} units
                            </div>
                            <div className="text-blue-700">
                              <span className="font-semibold">Velocity:</span> {product.velocity} /mo
                            </div>
                            <div className="text-purple-700">
                              <span className="font-semibold">Sales:</span> ${product.periodRevenue.toFixed(0)}
                            </div>
                            <div className="text-green-700 font-bold col-span-2">
                              <span className="font-semibold">Profit ({timeFilter}):</span> ${product.periodProfit.toFixed(0)}
                            </div>
                          </div>
                        )}
                      </div>
                    ));
                  })()}
                </div>
                
                <div className="mt-3 p-3 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border-2 border-blue-200">
                  <h4 className="font-bold text-gray-800 mb-2 text-sm">Section Totals ({timeFilter.charAt(0).toUpperCase() + timeFilter.slice(1)})</h4>
                  <div className="grid grid-cols-2 gap-2 text-xs">
                    <div className="text-orange-700 font-bold">
                      <span className="font-semibold">Volume:</span> {Math.round(calculateMetrics(selectedSection).totalVolume)} units
                    </div>
                    <div className="text-blue-700">
                      <span className="font-semibold">Velocity:</span> {calculateMetrics(selectedSection).totalVelocity} /mo
                    </div>
                    <div className="text-gray-700">
                      <span className="font-semibold">Sales:</span> ${calculateMetrics(selectedSection).totalRevenue.toFixed(0)}
                    </div>
                    <div className="text-green-700 font-bold">
                      <span className="font-semibold">Profit:</span> ${calculateMetrics(selectedSection).totalProfit.toFixed(0)}
                    </div>
                    <div className="text-purple-700 font-bold col-span-2">
                      <span className="font-semibold">Profit/Sq Ft:</span> ${calculateMetrics(selectedSection).profitPerSqFt.toFixed(2)}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        ) : (
          <div className="bg-gray-100 rounded-lg p-4 text-center text-gray-600">
            <p className="text-sm">Click on a section to select it</p>
          </div>
        )}

        <div className="bg-gray-100 rounded-lg p-4">
          <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <Icons.DollarSign />
            Sample UPCs (Try These!)
          </h3>
          <div className="space-y-1 text-xs text-gray-600">
            {Object.entries(productDatabase).map(([upc, product]) => (
              <div key={upc} className="bg-white p-2 rounded">
                <div className="font-medium">{product.name}</div>
                <div className="font-mono">{upc}</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <div className="flex-1 relative overflow-hidden">
        <div className="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-4 z-10 max-w-sm">
          <div className="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">
            📊 Store Performance ({timeFilter.charAt(0).toUpperCase() + timeFilter.slice(1)})
          </div>
          {sections.length === 0 ? (
            <div className="text-xs text-gray-500 italic">Add sections to see metrics</div>
          ) : (
            <>
              {sections.map(section => {
                const metrics = calculateMetrics(section);
                return (
                  <div key={section.id} className="text-xs mb-3 pb-3 border-b last:border-b-0">
                    <div className="font-bold text-gray-800 mb-1">{section.name}</div>
                    <div className="grid grid-cols-2 gap-1">
                      <div className="text-gray-600">
                        <span className="font-semibold">Area:</span> {metrics.area.toFixed(0)} sq ft
                      </div>
                      <div className="text-purple-700 font-bold">
                        <span className="font-semibold">$/sq ft:</span> ${metrics.profitPerSqFt.toFixed(0)}
                      </div>
                      <div className="text-orange-700 font-bold">
                        <span className="font-semibold">Volume:</span> {Math.round(metrics.totalVolume)} units
                      </div>
                      <div className="text-blue-700">
                        <span className="font-semibold">Velocity:</span> {metrics.totalVelocity} /mo
                      </div>
                      <div className="text-gray-700">
                        <span className="font-semibold">Sales:</span> ${metrics.totalRevenue.toFixed(0)}
                      </div>
                      <div className="text-green-700 font-bold">
                        <span className="font-semibold">Profit:</span> ${metrics.totalProfit.toFixed(0)}
                      </div>
                    </div>
                  </div>
                );
              })}
              
              {sections.length > 1 && (
                <div className="mt-3 pt-3 border-t-2 border-gray-300">
                  <div className="font-bold text-gray-800 mb-2">🏪 Store Totals</div>
                  <div className="grid grid-cols-2 gap-1 text-xs">
                    <div className="text-orange-700 font-bold">
                      Volume: {Math.round(sections.reduce((sum, s) => sum + calculateMetrics(s).totalVolume, 0))} units
                    </div>
                    <div className="text-blue-700">
                      Sales: ${sections.reduce((sum, s) => sum + calculateMetrics(s).totalRevenue, 0).toFixed(0)}
                    </div>
                    <div className="text-green-700 font-bold col-span-2">
                      Profit: ${sections.reduce((sum, s) => sum + calculateMetrics(s).totalProfit, 0).toFixed(0)}
                    </div>
                  </div>
                </div>
              )}
            </>
          )}
        </div>

        {/* Heat Map Legend */}
        {heatMapMode && (
          <div className="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-3 z-10">
            <h3 className="text-xs font-bold text-gray-800 mb-2">Heat Map Legend</h3>
            <div className="space-y-1 text-xs">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{backgroundColor: 'rgba(239, 68, 68, 0.7)'}}></div>
                <span>&lt;$25/sq ft</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{backgroundColor: 'rgba(249, 115, 22, 0.7)'}}></div>
                <span>$25-$50/sq ft</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{backgroundColor: 'rgba(251, 191, 36, 0.7)'}}></div>
                <span>$50-$100/sq ft</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{backgroundColor: 'rgba(132, 204, 22, 0.7)'}}></div>
                <span>$100-$200/sq ft</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded" style={{backgroundColor: 'rgba(16, 185, 129, 0.7)'}}></div>
                <span>&gt;$200/sq ft</span>
              </div>
            </div>
          </div>
        )}

        <div 
          ref={canvasRef}
          className="w-full h-full bg-white relative overflow-hidden" 
          style={{ 
            backgroundImage: backgroundImage ? `url(${backgroundImage})` : 'radial-gradient(circle, #e5e7eb 1px, transparent 1px)',
            backgroundSize: backgroundImage ? 'cover' : '20px 20px',
            backgroundPosition: 'center',
            backgroundRepeat: backgroundImage ? 'no-repeat' : 'repeat',
            cursor: 'grab'
          }}
        >
          <div style={{
            transform: `translate(${panOffset.x}px, ${panOffset.y}px) scale(${zoom})`,
            transformOrigin: '0 0',
            width: '100%',
            height: '100%',
            position: 'relative'
          }}>
            {sections.map(section => (
              <DraggableSection key={section.id} section={section} />
            ))}
            
            {sections.length === 0 && (
              <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                <div className="text-center">
                  <Icons.Maximize2 />
                  <div className="mt-4 text-lg">
                    {showLibrary ? 'Select a fixture from the library' : 'Click "Show Library" to get started'}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const root = createRoot(document.getElementById('root'));
root.render(<PlanogramProfitTracker />);
  </script>
</body>
</html>
