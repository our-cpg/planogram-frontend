<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Planner Pro v3 - Visual Product Mapping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

    // Backend URL
    const BACKEND_URL = 'https://planogram-backend-v83z.onrender.com';

    // Custom Icons
    const Icons = {
      Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
      Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
      Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
      Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
      Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
      BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
      Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>,
      Flame: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>,
      ZoomIn: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>,
      ZoomOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>,
      Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
      Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
      Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
      X: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
      Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>
    };

    // Fixture Library with dimensions
    const FIXTURE_LIBRARY = {
      'Grid Wall': { width: 120, height: 200, sections: 6, sectionType: 'zones', color: '#3B82F6' },
      'Jewelry Case': { width: 150, height: 100, sections: 4, sectionType: 'compartments', color: '#8B5CF6' },
      'Gondola': { width: 180, height: 150, sections: 5, sectionType: 'shelves', color: '#10B981' },
      'Slat Wall': { width: 100, height: 180, sections: 4, sectionType: 'zones', color: '#F59E0B' },
      'End Cap': { width: 80, height: 120, sections: 3, sectionType: 'shelves', color: '#EF4444' }
    };

    function StorePlannerPro() {
      const [fixtures, setFixtures] = useState([]);
      const [selectedFixture, setSelectedFixture] = useState(null);
      const [storeName, setStoreName] = useState('My Store Layout');
      const [feedback, setFeedback] = useState('');
      const [draggedFixture, setDraggedFixture] = useState(null);
      const [draggedProduct, setDraggedProduct] = useState(null);
      const [showSaveModal, setShowSaveModal] = useState(false);
      const [showLoadModal, setShowLoadModal] = useState(false);
      const [savedLayouts, setSavedLayouts] = useState([]);
      const [upcInput, setUpcInput] = useState('');
      const [quantityInput, setQuantityInput] = useState(1);
      const [searchResults, setSearchResults] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [heatMapMode, setHeatMapMode] = useState(false);
      const [timePeriod, setTimePeriod] = useState('month');
      const [zoom, setZoom] = useState(1);
      const [pan, setPan] = useState({ x: 0, y: 0 });
      const [isPanning, setIsPanning] = useState(false);
      const [panStart, setPanStart] = useState({ x: 0, y: 0 });
      const [backgroundImage, setBackgroundImage] = useState(null);
      const [editingSectionId, setEditingSectionId] = useState(null);
      const [editingSectionName, setEditingSectionName] = useState('');
      
      const canvasRef = useRef(null);
      const fileInputRef = useRef(null);
      const importInputRef = useRef(null);

      // Shopify Configuration
      const [shopifyConfig, setShopifyConfig] = useState({
        storeName: '',
        accessToken: '',
        connected: false
      });

      // Load saved layouts and Shopify config on mount
      useEffect(() => {
        const saved = localStorage.getItem('storePlannerLayouts');
        if (saved) {
          setSavedLayouts(JSON.parse(saved));
        }
        
        const shopifyData = localStorage.getItem('shopifyConfig');
        if (shopifyData) {
          const config = JSON.parse(shopifyData);
          setShopifyConfig(config);
        }
      }, []);

      // Save Shopify config to localStorage
      const saveShopifyConfig = (config) => {
        localStorage.setItem('shopifyConfig', JSON.stringify(config));
        setShopifyConfig(config);
      };

      // Connect to Shopify
      const connectToShopify = async () => {
        if (!shopifyConfig.storeName || !shopifyConfig.accessToken) {
          setFeedback('⚠️ Please enter store name and access token');
          setTimeout(() => setFeedback(''), 3000);
          return;
        }

        setFeedback('🔄 Connecting to Shopify...');
        
        try {
          const response = await fetch(`${BACKEND_URL}/api/shopify`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              storeName: shopifyConfig.storeName,
              accessToken: shopifyConfig.accessToken,
              action: 'connect'
            })
          });

          const data = await response.json();
          
          if (data.success) {
            saveShopifyConfig({
              ...shopifyConfig,
              connected: true
            });
            setFeedback('✅ Connected to Shopify!');
            setTimeout(() => {
              setFeedback('');
              setShowSettings(false);
            }, 2000);
          } else {
            setFeedback(`❌ ${data.message}`);
            setTimeout(() => setFeedback(''), 4000);
          }
        } catch (error) {
          setFeedback('❌ Connection failed');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      // Disconnect from Shopify
      const disconnectFromShopify = () => {
        saveShopifyConfig({
          storeName: '',
          accessToken: '',
          connected: false
        });
        setFeedback('✅ Disconnected from Shopify');
        setTimeout(() => {
          setFeedback('');
          setShowSettings(false);
        }, 2000);
      };

      // Refresh product cache
      const refreshProductCache = async () => {
        if (!shopifyConfig.connected || !shopifyConfig.accessToken) {
          setFeedback('⚠️ Connect to Shopify first');
          setTimeout(() => setFeedback(''), 3000);
          return;
        }

        setFeedback('🔄 Refreshing product cache...');
        
        try {
          const response = await fetch(`${BACKEND_URL}/api/shopify`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              storeName: shopifyConfig.storeName,
              accessToken: shopifyConfig.accessToken,
              action: 'refreshCache'
            })
          });

          const data = await response.json();
          
          if (data.success) {
            setFeedback(`✅ Cache refreshed! ${data.count} products`);
            setTimeout(() => setFeedback(''), 3000);
          } else {
            setFeedback(`❌ ${data.message}`);
            setTimeout(() => setFeedback(''), 4000);
          }
        } catch (error) {
          setFeedback('❌ Refresh failed');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      // Search products by UPC
      const searchByUPC = async () => {
        if (!upcInput.trim()) return;
        
        setFeedback('🔍 Searching...');
        
        try {
          const response = await fetch(`${BACKEND_URL}/api/products/search?upc=${upcInput}`);
          const data = await response.json();
          
          if (data.success && data.products.length > 0) {
            setSearchResults(data.products);
            setFeedback('');
          } else {
            setFeedback('❌ No products found');
            setSearchResults([]);
            setTimeout(() => setFeedback(''), 3000);
          }
        } catch (error) {
          setFeedback('❌ Search failed');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      // Add fixture to canvas
      const addFixture = (type) => {
        const config = FIXTURE_LIBRARY[type];
        const sections = Array.from({ length: config.sections }, (_, i) => ({
          id: `${type}-section-${Date.now()}-${i}`,
          name: `${config.sectionType.slice(0, -1)} ${i + 1}`,
          products: []
        }));

        const newFixture = {
          id: `fixture-${Date.now()}`,
          type,
          x: 100,
          y: 100,
          width: config.width,
          height: config.height,
          sections,
          color: config.color
        };

        setFixtures([...fixtures, newFixture]);
        setFeedback(`✅ Added ${type}`);
        setTimeout(() => setFeedback(''), 2000);
      };

      // Start section name editing
      const startEditingSection = (fixtureId, sectionId, currentName) => {
        setEditingSectionId(sectionId);
        setEditingSectionName(currentName);
      };

      // Save section name
      const saveSectionName = (fixtureId, sectionId) => {
        setFixtures(fixtures.map(f => {
          if (f.id === fixtureId) {
            return {
              ...f,
              sections: f.sections.map(s => 
                s.id === sectionId ? { ...s, name: editingSectionName } : s
              )
            };
          }
          return f;
        }));
        setEditingSectionId(null);
        setEditingSectionName('');
      };

      // Cancel section name editing
      const cancelEditingSection = () => {
        setEditingSectionId(null);
        setEditingSectionName('');
      };

      // Add product to section
      const addProduct = (fixtureId, sectionId, product) => {
        const newProduct = {
          id: `product-${Date.now()}`,
          ...product,
          quantity: parseInt(quantityInput) || 1,
          x: 10, // Default position
          y: 10,
          addedDate: new Date().toISOString()
        };

        setFixtures(fixtures.map(f => {
          if (f.id === fixtureId) {
            return {
              ...f,
              sections: f.sections.map(s => {
                if (s.id === sectionId) {
                  return {
                    ...s,
                    products: [...s.products, newProduct]
                  };
                }
                return s;
              })
            };
          }
          return f;
        }));

        setSearchResults([]);
        setUpcInput('');
        setQuantityInput(1);
        setFeedback(`✅ Added ${product.title}`);
        setTimeout(() => setFeedback(''), 2000);
      };

      // Update product position
      const updateProductPosition = (fixtureId, sectionId, productId, x, y) => {
        setFixtures(fixtures.map(f => {
          if (f.id === fixtureId) {
            return {
              ...f,
              sections: f.sections.map(s => {
                if (s.id === sectionId) {
                  return {
                    ...s,
                    products: s.products.map(p => 
                      p.id === productId ? { ...p, x, y } : p
                    )
                  };
                }
                return s;
              })
            };
          }
          return f;
        }));
      };

      // Remove product
      const removeProduct = (fixtureId, sectionId, productId) => {
        setFixtures(fixtures.map(f => {
          if (f.id === fixtureId) {
            return {
              ...f,
              sections: f.sections.map(s => {
                if (s.id === sectionId) {
                  return {
                    ...s,
                    products: s.products.filter(p => p.id !== productId)
                  };
                }
                return s;
              })
            };
          }
          return f;
        }));
      };

      // Calculate profit per sqft
      const calculateProfitPerSqFt = (fixture) => {
        const totalProducts = fixture.sections.reduce((sum, section) => 
          sum + section.products.reduce((pSum, p) => pSum + (p.quantity || 1), 0), 0
        );
        
        const totalProfit = fixture.sections.reduce((sum, section) => 
          sum + section.products.reduce((pSum, p) => {
            const cost = parseFloat(p.cost) || 0;
            const price = parseFloat(p.price) || 0;
            return pSum + ((price - cost) * (p.quantity || 1));
          }, 0), 0
        );
        
        const sqft = (fixture.width * fixture.height) / 144; // convert to sq ft
        return totalProfit / sqft;
      };

      // Get heat map color
      const getHeatMapColor = (profitPerSqFt) => {
        if (profitPerSqFt > 100) return 'rgba(34, 197, 94, 0.7)'; // green
        if (profitPerSqFt > 50) return 'rgba(234, 179, 8, 0.7)'; // yellow
        if (profitPerSqFt > 0) return 'rgba(249, 115, 22, 0.7)'; // orange
        return 'rgba(239, 68, 68, 0.7)'; // red
      };

      // Get product color by profitability
      const getProductColor = (product) => {
        const cost = parseFloat(product.cost) || 0;
        const price = parseFloat(product.price) || 0;
        const profit = price - cost;
        
        if (profit > 5) return '#10B981'; // green
        if (profit > 2) return '#F59E0B'; // yellow
        if (profit > 0) return '#EF4444'; // orange
        return '#991B1B'; // dark red
      };

      // Export layout
      const exportLayout = () => {
        const exportData = {
          version: 3,
          storeName,
          fixtures,
          backgroundImage,
          exportDate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${storeName.replace(/\s+/g, '-')}-${Date.now()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        setFeedback('✅ Layout exported!');
        setTimeout(() => setFeedback(''), 2000);
      };

      // Import layout
      const importLayout = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.version && data.fixtures) {
              setStoreName(data.storeName || 'Imported Layout');
              setFixtures(data.fixtures);
              setBackgroundImage(data.backgroundImage || null);
              setFeedback('✅ Layout imported!');
              setTimeout(() => setFeedback(''), 2000);
            } else {
              setFeedback('❌ Invalid layout file');
              setTimeout(() => setFeedback(''), 3000);
            }
          } catch (error) {
            setFeedback('❌ Import failed');
            setTimeout(() => setFeedback(''), 3000);
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      // Save layout
      const saveLayout = () => {
        const layout = {
          name: storeName,
          fixtures,
          backgroundImage,
          savedAt: new Date().toISOString()
        };
        
        const updated = [...savedLayouts.filter(l => l.name !== storeName), layout];
        setSavedLayouts(updated);
        localStorage.setItem('storePlannerLayouts', JSON.stringify(updated));
        
        setFeedback('✅ Layout saved!');
        setTimeout(() => {
          setFeedback('');
          setShowSaveModal(false);
        }, 1500);
      };

      // Load layout
      const loadLayout = (layout) => {
        setStoreName(layout.name);
        setFixtures(layout.fixtures);
        setBackgroundImage(layout.backgroundImage || null);
        setShowLoadModal(false);
        setFeedback('✅ Layout loaded!');
        setTimeout(() => setFeedback(''), 2000);
      };

      // Delete saved layout
      const deleteLayout = (layoutName) => {
        const updated = savedLayouts.filter(l => l.name !== layoutName);
        setSavedLayouts(updated);
        localStorage.setItem('storePlannerLayouts', JSON.stringify(updated));
        setFeedback('✅ Layout deleted');
        setTimeout(() => setFeedback(''), 2000);
      };

      // Handle fixture drag
      const handleFixtureDragStart = (e, fixture) => {
        const rect = canvasRef.current.getBoundingClientRect();
        setDraggedFixture({
          ...fixture,
          offsetX: (e.clientX - rect.left) / zoom - fixture.x - pan.x / zoom,
          offsetY: (e.clientY - rect.top) / zoom - fixture.y - pan.y / zoom
        });
      };

      const handleFixtureDrag = (e) => {
        if (!draggedFixture) return;
        
        const rect = canvasRef.current.getBoundingClientRect();
        const newX = (e.clientX - rect.left) / zoom - draggedFixture.offsetX - pan.x / zoom;
        const newY = (e.clientY - rect.top) / zoom - draggedFixture.offsetY - pan.y / zoom;
        
        setFixtures(fixtures.map(f => 
          f.id === draggedFixture.id ? { ...f, x: newX, y: newY } : f
        ));
      };

      const handleFixtureDragEnd = () => {
        setDraggedFixture(null);
      };

      // Handle product drag
      const handleProductDragStart = (e, fixtureId, sectionId, product) => {
        e.stopPropagation();
        setDraggedProduct({
          fixtureId,
          sectionId,
          productId: product.id,
          offsetX: e.nativeEvent.offsetX,
          offsetY: e.nativeEvent.offsetY
        });
      };

      const handleProductDrag = (e, fixtureId, sectionId) => {
        if (!draggedProduct || draggedProduct.fixtureId !== fixtureId || draggedProduct.sectionId !== sectionId) return;
        
        const newX = e.nativeEvent.offsetX - draggedProduct.offsetX;
        const newY = e.nativeEvent.offsetY - draggedProduct.offsetY;
        
        updateProductPosition(fixtureId, sectionId, draggedProduct.productId, newX, newY);
      };

      const handleProductDragEnd = () => {
        setDraggedProduct(null);
      };

      // Handle canvas pan
      const handleCanvasMouseDown = (e) => {
        if (e.button === 0 && !e.target.closest('.fixture')) {
          setIsPanning(true);
          setPanStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
        }
      };

      const handleCanvasMouseMove = (e) => {
        if (isPanning) {
          setPan({
            x: e.clientX - panStart.x,
            y: e.clientY - panStart.y
          });
        } else if (draggedFixture) {
          handleFixtureDrag(e);
        }
      };

      const handleCanvasMouseUp = () => {
        setIsPanning(false);
        handleFixtureDragEnd();
      };

      // Background image upload
      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setBackgroundImage(event.target.result);
            setFeedback('✅ Background added!');
            setTimeout(() => setFeedback(''), 2000);
          };
          reader.readAsDataURL(file);
        }
      };

      // Calculate total metrics
      const totalMetrics = {
        fixtures: fixtures.length,
        products: fixtures.reduce((sum, f) => 
          sum + f.sections.reduce((s, sec) => s + sec.products.length, 0), 0),
        totalProfit: fixtures.reduce((sum, f) => 
          sum + f.sections.reduce((s, sec) => 
            s + sec.products.reduce((p, prod) => {
              const cost = parseFloat(prod.cost) || 0;
              const price = parseFloat(prod.price) || 0;
              return p + ((price - cost) * (prod.quantity || 1));
            }, 0), 0), 0).toFixed(2)
      };

      return (
        <div className="flex h-screen bg-gray-100">
          {/* Settings Modal */}
          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-96 max-h-[90vh] overflow-y-auto">
                <h2 className="text-xl font-bold mb-4">Shopify Settings</h2>
                
                {!shopifyConfig.connected ? (
                  <>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-2">Store Name</label>
                      <input
                        type="text"
                        value={shopifyConfig.storeName}
                        onChange={(e) => setShopifyConfig({...shopifyConfig, storeName: e.target.value})}
                        placeholder="your-store.myshopify.com"
                        className="w-full px-3 py-2 border rounded-lg"
                      />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-2">Access Token</label>
                      <input
                        type="password"
                        value={shopifyConfig.accessToken}
                        onChange={(e) => setShopifyConfig({...shopifyConfig, accessToken: e.target.value})}
                        placeholder="shpat_xxxxxxxxxxxxx"
                        className="w-full px-3 py-2 border rounded-lg"
                      />
                    </div>
                    <button
                      onClick={connectToShopify}
                      className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mb-2"
                    >
                      Connect to Shopify
                    </button>
                  </>
                ) : (
                  <>
                    <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                      <p className="text-sm font-medium text-green-800">✅ Connected to:</p>
                      <p className="text-sm text-green-700">{shopifyConfig.storeName}</p>
                    </div>
                    <button
                      onClick={refreshProductCache}
                      className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-2"
                    >
                      Refresh Product Cache
                    </button>
                    <button
                      onClick={disconnectFromShopify}
                      className="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 mb-2"
                    >
                      Disconnect
                    </button>
                  </>
                )}
                
                <button
                  onClick={() => setShowSettings(false)}
                  className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                >
                  Close
                </button>
              </div>
            </div>
          )}

          {/* Save Modal */}
          {showSaveModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-96">
                <h2 className="text-xl font-bold mb-4">Save Layout</h2>
                <p className="text-sm text-gray-600 mb-4">
                  Save as: <strong>{storeName}</strong>
                </p>
                <div className="flex gap-2">
                  <button
                    onClick={saveLayout}
                    className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
                  >
                    Save
                  </button>
                  <button
                    onClick={() => setShowSaveModal(false)}
                    className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Load Modal */}
          {showLoadModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-96 max-h-[80vh] overflow-y-auto">
                <h2 className="text-xl font-bold mb-4">Load Layout</h2>
                {savedLayouts.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No saved layouts</p>
                ) : (
                  <div className="space-y-2">
                    {savedLayouts.map((layout, idx) => (
                      <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1">
                          <p className="font-medium">{layout.name}</p>
                          <p className="text-xs text-gray-500">
                            {new Date(layout.savedAt).toLocaleString()}
                          </p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => loadLayout(layout)}
                            className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                          >
                            Load
                          </button>
                          <button
                            onClick={() => deleteLayout(layout.name)}
                            className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                <button
                  onClick={() => setShowLoadModal(false)}
                  className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 mt-4"
                >
                  Close
                </button>
              </div>
            </div>
          )}

          {/* Sidebar */}
          <div className="w-80 bg-white shadow-lg p-6 overflow-y-auto">
            <h1 className="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <Icons.BarChart3 />
              Store Planner v3
              {shopifyConfig.connected && (
                <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                  Shopify ✓
                </span>
              )}
            </h1>
            
            {feedback && (
              <div className="bg-blue-100 border-2 border-blue-400 text-blue-800 px-3 py-2 rounded-lg text-sm font-semibold mb-3">
                {feedback}
              </div>
            )}
            
            <input
              type="text"
              value={storeName}
              onChange={(e) => setStoreName(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg mb-4 text-sm"
              placeholder="Store layout name"
            />

            {/* Action Buttons */}
            <div className="grid grid-cols-2 gap-2 mb-4">
              <button
                onClick={() => setShowSaveModal(true)}
                className="bg-green-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-green-700 text-sm"
              >
                <Icons.Save />
                Save
              </button>
              <button
                onClick={() => setShowLoadModal(true)}
                className="bg-purple-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-purple-700 text-sm"
              >
                <Icons.Upload />
                Load
              </button>
              <button
                onClick={exportLayout}
                className="bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 text-sm"
              >
                <Icons.Download />
                Export
              </button>
              <button
                onClick={() => importInputRef.current.click()}
                className="bg-indigo-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-indigo-700 text-sm"
              >
                <Icons.Upload />
                Import
              </button>
            </div>

            <input
              ref={importInputRef}
              type="file"
              accept=".json"
              onChange={importLayout}
              className="hidden"
            />

            <button
              onClick={() => setShowSettings(true)}
              className={`w-full ${shopifyConfig.connected ? 'bg-green-600' : 'bg-blue-600'} text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 text-sm mb-4`}
            >
              🛍️ {shopifyConfig.connected ? 'Shopify Connected' : 'Connect Shopify'}
            </button>

            {/* Metrics */}
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg mb-4">
              <h3 className="font-semibold text-gray-700 mb-2">Store Metrics</h3>
              <div className="space-y-1 text-sm">
                <div className="flex justify-between">
                  <span>Fixtures:</span>
                  <span className="font-semibold">{totalMetrics.fixtures}</span>
                </div>
                <div className="flex justify-between">
                  <span>Products:</span>
                  <span className="font-semibold">{totalMetrics.products}</span>
                </div>
                <div className="flex justify-between">
                  <span>Total Profit:</span>
                  <span className="font-semibold text-green-600">${totalMetrics.totalProfit}</span>
                </div>
              </div>
            </div>

            {/* Fixture Library */}
            <div className="mb-4">
              <h3 className="font-semibold text-gray-700 mb-2">Fixture Library</h3>
              <div className="space-y-2">
                {Object.keys(FIXTURE_LIBRARY).map(type => (
                  <button
                    key={type}
                    onClick={() => addFixture(type)}
                    className="w-full bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-between text-sm"
                    style={{ backgroundColor: FIXTURE_LIBRARY[type].color }}
                  >
                    <span>{type}</span>
                    <Icons.Plus />
                  </button>
                ))}
              </div>
            </div>

            {/* Controls */}
            <div className="space-y-2 mb-4">
              <button
                onClick={() => setHeatMapMode(!heatMapMode)}
                className={`w-full ${heatMapMode ? 'bg-orange-600' : 'bg-gray-600'} text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 text-sm`}
              >
                <Icons.Flame />
                {heatMapMode ? 'Heat Map ON' : 'Heat Map OFF'}
              </button>
              
              <button
                onClick={() => fileInputRef.current.click()}
                className="w-full bg-purple-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-purple-700 text-sm"
              >
                <Icons.Image />
                Add Background
              </button>
              
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handleImageUpload}
                className="hidden"
              />

              <div className="flex gap-2">
                <button
                  onClick={() => setZoom(Math.min(zoom + 0.1, 2))}
                  className="flex-1 bg-gray-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-1 hover:bg-gray-700 text-sm"
                >
                  <Icons.ZoomIn />
                </button>
                <button
                  onClick={() => setZoom(Math.max(zoom - 0.1, 0.5))}
                  className="flex-1 bg-gray-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-1 hover:bg-gray-700 text-sm"
                >
                  <Icons.ZoomOut />
                </button>
                <button
                  onClick={() => { setZoom(1); setPan({ x: 0, y: 0 }); }}
                  className="flex-1 bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 text-sm"
                >
                  Reset
                </button>
              </div>
            </div>

            {/* Product Search */}
            {selectedFixture && (
              <div className="border-t pt-4">
                <h3 className="font-semibold text-gray-700 mb-2">Add Product</h3>
                <div className="flex gap-2 mb-2">
                  <input
                    type="text"
                    value={upcInput}
                    onChange={(e) => setUpcInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && searchByUPC()}
                    placeholder="Enter UPC"
                    className="flex-1 px-3 py-2 border rounded-lg text-sm"
                  />
                  <button
                    onClick={searchByUPC}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                  >
                    <Icons.Search />
                  </button>
                </div>
                
                <input
                  type="number"
                  value={quantityInput}
                  onChange={(e) => setQuantityInput(e.target.value)}
                  min="1"
                  placeholder="Quantity"
                  className="w-full px-3 py-2 border rounded-lg text-sm mb-2"
                />

                {searchResults.length > 0 && (
                  <div className="space-y-2 max-h-60 overflow-y-auto">
                    {searchResults.map(product => (
                      <div key={product.id} className="bg-gray-50 p-2 rounded">
                        <p className="font-medium text-sm">{product.title}</p>
                        <p className="text-xs text-gray-600">{product.upc}</p>
                        <p className="text-xs">Price: ${product.price} | Cost: ${product.cost}</p>
                        <select
                          onChange={(e) => addProduct(selectedFixture.id, e.target.value, product)}
                          className="w-full mt-2 px-2 py-1 border rounded text-xs"
                        >
                          <option value="">Select section...</option>
                          {selectedFixture.sections.map(section => (
                            <option key={section.id} value={section.id}>
                              {section.name}
                            </option>
                          ))}
                        </select>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Selected Fixture Info */}
            {selectedFixture && (
              <div className="border-t pt-4 mt-4">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="font-semibold text-gray-700">
                    {selectedFixture.type}
                  </h3>
                  <button
                    onClick={() => {
                      setFixtures(fixtures.filter(f => f.id !== selectedFixture.id));
                      setSelectedFixture(null);
                    }}
                    className="text-red-600 hover:text-red-800"
                  >
                    <Icons.Trash2 />
                  </button>
                </div>
                
                <div className="space-y-2">
                  {selectedFixture.sections.map(section => (
                    <div key={section.id} className="bg-gray-50 p-2 rounded">
                      <div className="flex items-center gap-2 mb-1">
                        {editingSectionId === section.id ? (
                          <>
                            <input
                              type="text"
                              value={editingSectionName}
                              onChange={(e) => setEditingSectionName(e.target.value)}
                              className="flex-1 px-2 py-1 border rounded text-sm"
                              autoFocus
                            />
                            <button
                              onClick={() => saveSectionName(selectedFixture.id, section.id)}
                              className="text-green-600 hover:text-green-800"
                            >
                              <Icons.Check />
                            </button>
                            <button
                              onClick={cancelEditingSection}
                              className="text-red-600 hover:text-red-800"
                            >
                              <Icons.X />
                            </button>
                          </>
                        ) : (
                          <>
                            <span className="flex-1 font-medium text-sm">{section.name}</span>
                            <button
                              onClick={() => startEditingSection(selectedFixture.id, section.id, section.name)}
                              className="text-blue-600 hover:text-blue-800"
                            >
                              <Icons.Edit />
                            </button>
                          </>
                        )}
                      </div>
                      <p className="text-xs text-gray-600">
                        {section.products.length} products
                      </p>
                      {section.products.length > 0 && (
                        <div className="mt-2 space-y-1">
                          {section.products.map(product => (
                            <div key={product.id} className="flex justify-between items-center text-xs bg-white p-1 rounded">
                              <span className="truncate flex-1">{product.title}</span>
                              <button
                                onClick={() => removeProduct(selectedFixture.id, section.id, product.id)}
                                className="text-red-600 hover:text-red-800 ml-2"
                              >
                                <Icons.Trash2 />
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Canvas */}
          <div 
            ref={canvasRef}
            className="flex-1 relative overflow-hidden cursor-move"
            onMouseDown={handleCanvasMouseDown}
            onMouseMove={handleCanvasMouseMove}
            onMouseUp={handleCanvasMouseUp}
            onMouseLeave={handleCanvasMouseUp}
          >
            {/* Background Image */}
            {backgroundImage && (
              <div 
                className="absolute inset-0"
                style={{
                  transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
                  transformOrigin: '0 0'
                }}
              >
                <img 
                  src={backgroundImage} 
                  alt="Store background"
                  className="w-full h-full object-contain opacity-30"
                  draggable="false"
                />
              </div>
            )}

            {/* Fixtures */}
            <div 
              className="absolute inset-0"
              style={{
                transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
                transformOrigin: '0 0'
              }}
            >
              {fixtures.map(fixture => {
                const profitPerSqFt = calculateProfitPerSqFt(fixture);
                const isSelected = selectedFixture?.id === fixture.id;
                
                return (
                  <div
                    key={fixture.id}
                    className="fixture absolute cursor-move"
                    style={{
                      left: fixture.x,
                      top: fixture.y,
                      width: fixture.width,
                      height: fixture.height,
                      backgroundColor: heatMapMode ? getHeatMapColor(profitPerSqFt) : 'white',
                      border: isSelected ? '3px solid #3B82F6' : '2px solid #9CA3AF',
                      borderRadius: '8px',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                    }}
                    onMouseDown={(e) => {
                      e.stopPropagation();
                      setSelectedFixture(fixture);
                      handleFixtureDragStart(e, fixture);
                    }}
                  >
                    {/* Fixture Header */}
                    <div 
                      className="px-2 py-1 text-white text-xs font-semibold flex justify-between items-center"
                      style={{ backgroundColor: fixture.color }}
                    >
                      <span>{fixture.type}</span>
                      {heatMapMode && (
                        <span className="bg-white bg-opacity-20 px-2 py-0.5 rounded">
                          ${profitPerSqFt.toFixed(0)}/sqft
                        </span>
                      )}
                    </div>

                    {/* Sections with Products */}
                    <div className="p-2 h-full overflow-hidden">
                      <div className="grid gap-1" style={{
                        gridTemplateColumns: fixture.type === 'Jewelry Case' ? 'repeat(2, 1fr)' : '1fr',
                        height: 'calc(100% - 8px)'
                      }}>
                        {fixture.sections.map((section, idx) => (
                          <div
                            key={section.id}
                            className="relative border border-gray-300 rounded p-1 bg-white bg-opacity-50"
                            style={{ minHeight: '40px' }}
                            onMouseMove={(e) => handleProductDrag(e, fixture.id, section.id)}
                            onMouseUp={handleProductDragEnd}
                          >
                            <div className="text-xs font-medium text-gray-700 mb-1 truncate">
                              {section.name}
                            </div>
                            
                            {/* Visual Product Boxes */}
                            {section.products.map(product => {
                              const productColor = getProductColor(product);
                              const size = Math.max(20, Math.min(40, product.quantity * 5));
                              
                              return (
                                <div
                                  key={product.id}
                                  className="absolute cursor-move group"
                                  style={{
                                    left: product.x || 10,
                                    top: product.y || 10,
                                    width: size,
                                    height: size,
                                    backgroundColor: productColor,
                                    borderRadius: '4px',
                                    border: '2px solid rgba(0,0,0,0.2)',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                                  }}
                                  onMouseDown={(e) => handleProductDragStart(e, fixture.id, section.id, product)}
                                  title={`${product.title} (${product.quantity})`}
                                >
                                  {/* Product Info Tooltip */}
                                  <div className="hidden group-hover:block absolute z-10 bg-black text-white text-xs rounded p-2 whitespace-nowrap"
                                    style={{ 
                                      bottom: '100%', 
                                      left: '50%', 
                                      transform: 'translateX(-50%)',
                                      marginBottom: '4px',
                                      maxWidth: '200px'
                                    }}
                                  >
                                    <div className="font-semibold truncate">{product.title}</div>
                                    <div>Qty: {product.quantity}</div>
                                    <div>Price: ${product.price}</div>
                                    <div>Profit: ${(parseFloat(product.price) - parseFloat(product.cost)).toFixed(2)}</div>
                                  </div>
                                  
                                  {/* Quantity Badge */}
                                  <div className="absolute -top-1 -right-1 bg-black text-white rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">
                                    {product.quantity}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Instructions */}
            {fixtures.length === 0 && !backgroundImage && (
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="text-center text-gray-400">
                  <p className="text-xl mb-2">👈 Add fixtures to get started</p>
                  <p className="text-sm">Click fixture types in the sidebar</p>
                </div>
              </div>
            )}

            {/* Legend */}
            {heatMapMode && (
              <div className="absolute bottom-4 right-4 bg-white p-3 rounded-lg shadow-lg">
                <h4 className="text-xs font-semibold mb-2">Profit Heat Map</h4>
                <div className="space-y-1 text-xs">
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: 'rgba(34, 197, 94, 0.7)' }}></div>
                    <span>&gt;$100/sqft</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: 'rgba(234, 179, 8, 0.7)' }}></div>
                    <span>$50-100/sqft</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: 'rgba(249, 115, 22, 0.7)' }}></div>
                    <span>$0-50/sqft</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: 'rgba(239, 68, 68, 0.7)' }}></div>
                    <span>Negative</span>
                  </div>
                </div>
              </div>
            )}

            {/* Product Color Legend */}
            <div className="absolute top-4 right-4 bg-white p-3 rounded-lg shadow-lg">
              <h4 className="text-xs font-semibold mb-2">Product Profitability</h4>
              <div className="space-y-1 text-xs">
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{ backgroundColor: '#10B981' }}></div>
                  <span>&gt;$5 profit</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{ backgroundColor: '#F59E0B' }}></div>
                  <span>$2-5 profit</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{ backgroundColor: '#EF4444' }}></div>
                  <span>$0-2 profit</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{ backgroundColor: '#991B1B' }}></div>
                  <span>Negative</span>
                </div>
              </div>
              <div className="mt-2 pt-2 border-t text-xs text-gray-600">
                <div className="flex items-center gap-1">
                  <Icons.Move />
                  <span>Drag products to reposition</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    const root = createRoot(document.getElementById('root'));
    root.render(<StorePlannerPro />);
  </script>
</body>
</html>
